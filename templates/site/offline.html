{% extends "base.html" %}
{% load static %}

{% block title %}Monpec - Modo Offline{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-wifi-slash me-2"></i>
                        Modo Offline
                    </h3>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-signal-alt-slash fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Sem conex√£o com a internet</h4>
                        <p class="text-muted">
                            Voc√™ est√° visualizando uma vers√£o em cache do Monpec.
                            Algumas funcionalidades podem estar limitadas.
                        </p>
                    </div>

                    <!-- Status da conex√£o -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Status:</strong> Trabalhando offline
                        <br>
                        <small class="text-muted">
                            Os dados foram carregados da √∫ltima sess√£o online
                        </small>
                    </div>

                    <!-- Funcionalidades offline dispon√≠veis -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h5 class="text-start mb-3">üì± Funcionalidades Offline Dispon√≠veis:</h5>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-start">
                                    <h6 class="card-title text-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Consulta de Animais
                                    </h6>
                                    <p class="card-text small mb-2">
                                        Visualize informa√ß√µes b√°sicas dos animais
                                        que foram carregados anteriormente.
                                    </p>
                                    <a href="{% url 'animais_offline' %}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-search me-1"></i>
                                        Consultar Animais
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-start">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-list me-2"></i>
                                        Dados em Cache
                                    </h6>
                                    <p class="card-text small mb-2">
                                        Visualize quais dados est√£o dispon√≠veis
                                        para consulta offline.
                                    </p>
                                    <button class="btn btn-sm btn-outline-info" onclick="showCacheStatus()">
                                        <i class="fas fa-database me-1"></i>
                                        Ver Cache
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-body text-start">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-edit me-2"></i>
                                        Registros Pendentes
                                    </h6>
                                    <p class="card-text small mb-2">
                                        Visualizar altera√ß√µes feitas offline
                                        que aguardam sincroniza√ß√£o.
                                    </p>
                                    <button class="btn btn-sm btn-outline-warning" onclick="showPendingChanges()">
                                        <i class="fas fa-clock me-1"></i>
                                        Ver Pend√™ncias
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-start">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-sync me-2"></i>
                                        For√ßar Sincroniza√ß√£o
                                    </h6>
                                    <p class="card-text small mb-2">
                                        Tentar reconectar e sincronizar dados
                                        pendentes.
                                    </p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="forceSync()">
                                        <i class="fas fa-refresh me-1"></i>
                                        Sincronizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status da rede -->
                    <div class="mb-4">
                        <h6>üåê Status da Conex√£o:</h6>
                        <div id="network-status" class="text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Verificando conex√£o...
                        </div>
                    </div>

                    <!-- Bot√£o para tentar reconectar -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="checkConnection()">
                            <i class="fas fa-wifi me-2"></i>
                            Verificar Conex√£o
                        </button>

                        <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                            <i class="fas fa-refresh me-2"></i>
                            Recarregar P√°gina
                        </button>
                    </div>
                </div>

                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Dados offline s√£o automaticamente sincronizados quando a conex√£o retornar.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para status do cache -->
<div class="modal fade" id="cacheModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Status do Cache Offline</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cache-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Verificando cache...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mudan√ßas pendentes -->
<div class="modal fade" id="pendingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Altera√ß√µes Pendentes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pending-content">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhuma altera√ß√£o pendente para sincroniza√ß√£o.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Verificar status da rede
function checkConnection() {
    const statusEl = document.getElementById('network-status');

    if (navigator.onLine) {
        statusEl.innerHTML = '<i class="fas fa-wifi text-success me-2"></i>Conectado √† internet';
        statusEl.className = 'text-success';
    } else {
        statusEl.innerHTML = '<i class="fas fa-wifi-slash text-danger me-2"></i>Sem conex√£o';
        statusEl.className = 'text-danger';
    }
}

// Mostrar status do cache
function showCacheStatus() {
    const modal = new bootstrap.Modal(document.getElementById('cacheModal'));
    modal.show();

    // Comunicar com Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.controller?.postMessage({
            type: 'GET_CACHE_STATUS'
        });
    }
}

// Mostrar mudan√ßas pendentes
function showPendingChanges() {
    const modal = new bootstrap.Modal(document.getElementById('pendingModal'));
    modal.show();

    // Aqui voc√™ implementaria busca no IndexedDB
    const content = document.getElementById('pending-content');
    content.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Funcionalidade em desenvolvimento.
            <br>
            <small>As altera√ß√µes offline ser√£o implementadas em breve.</small>
        </div>
    `;
}

// For√ßar sincroniza√ß√£o
function forceSync() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            registration.sync.register('sync-pending-data')
                .then(() => {
                    alert('Sincroniza√ß√£o solicitada! Os dados ser√£o enviados quando houver conex√£o.');
                })
                .catch(err => {
                    console.log('Erro na sync:', err);
                    alert('Erro ao solicitar sincroniza√ß√£o.');
                });
        });
    }
}

// Escutar mudan√ßas no status da rede
window.addEventListener('online', checkConnection);
window.addEventListener('offline', checkConnection);

// Verificar conex√£o inicial
document.addEventListener('DOMContentLoaded', checkConnection);

// Escutar mensagens do Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data.type === 'CACHE_STATUS') {
            const content = document.getElementById('cache-content');
            content.innerHTML = `
                <div class="mb-3">
                    <h6>Cache Ativo: ${event.data.currentCache}</h6>
                    <p class="text-muted small">Total de caches: ${event.data.cacheNames.length}</p>
                </div>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Cache funcionando corretamente!
                </div>
            `;
        }
    });
}
</script>
{% endblock %}