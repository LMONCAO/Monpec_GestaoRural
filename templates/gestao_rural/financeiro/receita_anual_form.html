{% extends 'base_modulos_unificado.html' %}
{% load static %}
{% load formatacao_br %}

{% block title %}
    {% if receita %}Editar{% else %}Nova{% endif %} Receita Anual - {{ propriedade.nome_propriedade }}
{% endblock %}

{% block breadcrumb_extra %}
    <li class="breadcrumb-item"><a href="{% url 'financeiro_dashboard' propriedade.id %}">Financeiro</a></li>
    <li class="breadcrumb-item"><a href="{% url 'financeiro_receitas_anuais' propriedade.id %}">Receitas Anuais</a></li>
    <li class="breadcrumb-item active">{% if receita %}Editar{% else %}Nova{% endif %}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="bi bi-cash-stack me-2"></i>
                        {% if receita %}Editar{% else %}Nova{% endif %} Receita Anual
                    </h2>
                    <p class="text-muted mb-0">Preencha os dados para o DRE completo (Demonstração do Resultado do Exercício)</p>
                </div>
                {% if receita %}
                <div>
                    <a href="?preencher_automatico=1" class="btn btn-success" 
                       onclick="return confirm('Isso irá preencher automaticamente os campos zerados com base nos lançamentos financeiros do ano {{ receita.ano }}. Deseja continuar?');">
                        <i class="bi bi-magic me-2"></i>
                        Preencher Automaticamente
                    </a>
                    <small class="d-block text-muted mt-1">
                        <i class="bi bi-info-circle me-1"></i>
                        Preenche campos zerados com base nos lançamentos financeiros
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados da Receita Anual</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.ano.id_for_label }}" class="form-label">Ano *</label>
                                    {{ form.ano }}
                                    {% if form.ano.errors %}
                                        <div class="text-danger">{{ form.ano.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.valor_receita.id_for_label }}" class="form-label">Receita Bruta (R$) *</label>
                                    {{ form.valor_receita }}
                                    {% if form.valor_receita.errors %}
                                        <div class="text-danger">{{ form.valor_receita.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Valor total da receita antes de deduções.</small>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-primary">Deduções da Receita</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.icms_vendas.id_for_label }}" class="form-label">ICMS sobre Vendas (R$)</label>
                                    {{ form.icms_vendas }}
                                    {% if form.icms_vendas.errors %}
                                        <div class="text-danger">{{ form.icms_vendas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.funviral_vendas.id_for_label }}" class="form-label">Funviral sobre Vendas (R$)</label>
                                    {{ form.funviral_vendas }}
                                    {% if form.funviral_vendas.errors %}
                                        <div class="text-danger">{{ form.funviral_vendas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.outros_impostos_vendas.id_for_label }}" class="form-label">Outros Impostos (R$)</label>
                                    {{ form.outros_impostos_vendas }}
                                    {% if form.outros_impostos_vendas.errors %}
                                        <div class="text-danger">{{ form.outros_impostos_vendas.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">PIS, COFINS, etc.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.devolucoes_vendas.id_for_label }}" class="form-label">Devoluções de Vendas (R$)</label>
                                    {{ form.devolucoes_vendas }}
                                    {% if form.devolucoes_vendas.errors %}
                                        <div class="text-danger">{{ form.devolucoes_vendas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.abatimentos_vendas.id_for_label }}" class="form-label">Abatimentos sobre Vendas (R$)</label>
                                    {{ form.abatimentos_vendas }}
                                    {% if form.abatimentos_vendas.errors %}
                                        <div class="text-danger">{{ form.abatimentos_vendas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-primary">Custos</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.custo_produtos_vendidos.id_for_label }}" class="form-label">Custo dos Produtos Vendidos - CPV (R$)</label>
                                    {{ form.custo_produtos_vendidos }}
                                    {% if form.custo_produtos_vendidos.errors %}
                                        <div class="text-danger">{{ form.custo_produtos_vendidos.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Custo direto dos produtos/mercadorias vendidas.</small>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-primary">Despesas Operacionais Detalhadas</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.retirada_labore.id_for_label }}" class="form-label">Retirada Labore (R$)</label>
                                    {{ form.retirada_labore }}
                                    {% if form.retirada_labore.errors %}
                                        <div class="text-danger">{{ form.retirada_labore.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.assistencia_contabil.id_for_label }}" class="form-label">Assistência Contábil (R$)</label>
                                    {{ form.assistencia_contabil }}
                                    {% if form.assistencia_contabil.errors %}
                                        <div class="text-danger">{{ form.assistencia_contabil.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.encargos_inss.id_for_label }}" class="form-label">Encargos INSS (R$)</label>
                                    {{ form.encargos_inss }}
                                    {% if form.encargos_inss.errors %}
                                        <div class="text-danger">{{ form.encargos_inss.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.taxas_diversas.id_for_label }}" class="form-label">Taxas Diversas (R$)</label>
                                    {{ form.taxas_diversas }}
                                    {% if form.taxas_diversas.errors %}
                                        <div class="text-danger">{{ form.taxas_diversas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_administrativas.id_for_label }}" class="form-label">Despesas Administrativas (R$)</label>
                                    {{ form.despesas_administrativas }}
                                    {% if form.despesas_administrativas.errors %}
                                        <div class="text-danger">{{ form.despesas_administrativas.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.material_uso_consumo.id_for_label }}" class="form-label">Material de Uso e Consumo (R$)</label>
                                    {{ form.material_uso_consumo }}
                                    {% if form.material_uso_consumo.errors %}
                                        <div class="text-danger">{{ form.material_uso_consumo.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_comunicacao.id_for_label }}" class="form-label">Despesas Comunicação (R$)</label>
                                    {{ form.despesas_comunicacao }}
                                    {% if form.despesas_comunicacao.errors %}
                                        <div class="text-danger">{{ form.despesas_comunicacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_viagens.id_for_label }}" class="form-label">Despesas Viagens (R$)</label>
                                    {{ form.despesas_viagens }}
                                    {% if form.despesas_viagens.errors %}
                                        <div class="text-danger">{{ form.despesas_viagens.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_energia_eletrica.id_for_label }}" class="form-label">Despesas Energia Elétrica (R$)</label>
                                    {{ form.despesas_energia_eletrica }}
                                    {% if form.despesas_energia_eletrica.errors %}
                                        <div class="text-danger">{{ form.despesas_energia_eletrica.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_transportes.id_for_label }}" class="form-label">Despesas Transportes (R$)</label>
                                    {{ form.despesas_transportes }}
                                    {% if form.despesas_transportes.errors %}
                                        <div class="text-danger">{{ form.despesas_transportes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_combustivel.id_for_label }}" class="form-label">Despesas Combustível (R$)</label>
                                    {{ form.despesas_combustivel }}
                                    {% if form.despesas_combustivel.errors %}
                                        <div class="text-danger">{{ form.despesas_combustivel.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_manutencao.id_for_label }}" class="form-label">Despesas Manutenção (R$)</label>
                                    {{ form.despesas_manutencao }}
                                    {% if form.despesas_manutencao.errors %}
                                        <div class="text-danger">{{ form.despesas_manutencao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.depreciacao_amortizacao.id_for_label }}" class="form-label">Depreciação e Amortização (R$)</label>
                                    {{ form.depreciacao_amortizacao }}
                                    {% if form.depreciacao_amortizacao.errors %}
                                        <div class="text-danger">{{ form.depreciacao_amortizacao.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-primary">Resultado Financeiro</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.despesas_financeiras.id_for_label }}" class="form-label">Despesas Financeiras (R$)</label>
                                    {{ form.despesas_financeiras }}
                                    {% if form.despesas_financeiras.errors %}
                                        <div class="text-danger">{{ form.despesas_financeiras.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Juros, taxas bancárias, etc.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.receitas_financeiras.id_for_label }}" class="form-label">Receitas Financeiras (R$)</label>
                                    {{ form.receitas_financeiras }}
                                    {% if form.receitas_financeiras.errors %}
                                        <div class="text-danger">{{ form.receitas_financeiras.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Aplicações financeiras, rendimentos, etc.</small>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 class="text-primary">Provisão de Impostos</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.csll.id_for_label }}" class="form-label">Contribuição Social sobre Lucro Líquido - CSLL (R$)</label>
                                    {{ form.csll }}
                                    {% if form.csll.errors %}
                                        <div class="text-danger">{{ form.csll.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.irpj.id_for_label }}" class="form-label">Imposto de Renda Pessoa Jurídica - IRPJ (R$)</label>
                                    {{ form.irpj }}
                                    {% if form.irpj.errors %}
                                        <div class="text-danger">{{ form.irpj.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>
                        <div class="mb-3">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label">Descrição/Observações</label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                                <div class="text-danger">{{ form.descricao.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>
                                Salvar
                            </button>
                            <a href="{% url 'financeiro_receitas_anuais' propriedade.id %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
