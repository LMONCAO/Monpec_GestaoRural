{% extends 'base_modulos_unificado.html' %}
{% load static %}

{% block title %}IA de Planejamento - {{ propriedade.nome_propriedade }}{% endblock %}

{% block breadcrumb_extra %}
    <li class="breadcrumb-item active">
        <i class="bi bi-robot"></i>
        IA de Planejamento
    </li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="submenu-page-header">
        <div class="d-flex align-items-start gap-4">
            <div class="submenu-page-icon" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.25) 100%);">
                <i class="bi bi-robot" style="color: #667eea;"></i>
            </div>
            <div class="flex-grow-1">
                <h1 class="submenu-page-title">Assistente de IA para Planejamento</h1>
                <p class="submenu-page-description">
                    Nossa IA vai te guiar passo a passo na criação do seu planejamento anual. 
                    Responda as perguntas e deixe que eu crio tudo para você!
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                <!-- Header do Chat -->
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar-ia" style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-robot fs-3"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Assistente de Planejamento</h5>
                                <small class="opacity-75">IA do MONPEC</small>
                            </div>
                        </div>
                        <button id="btn-cancelar" class="btn btn-light btn-sm">
                            <i class="bi bi-x-lg"></i> Cancelar
                        </button>
                    </div>
                </div>

                <!-- Área de Mensagens -->
                <div class="card-body" style="height: 500px; overflow-y: auto; padding: 1.5rem; background: #f8f9fa;" id="chat-messages">
                    <div class="text-center text-muted py-5" id="loading-inicial">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p>Iniciando conversa...</p>
                    </div>
                </div>

                <!-- Barra de Progresso -->
                <div class="px-3 py-2 bg-light border-top">
                    <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">Progresso:</small>
                        <div class="progress flex-grow-1" style="height: 8px;">
                            <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="progress-text">0%</small>
                    </div>
                </div>

                <!-- Input de Resposta -->
                <div class="card-footer bg-white border-top" id="chat-input-area" style="display: none;">
                    <form id="chat-form">
                        <div class="input-group">
                            <input 
                                type="text" 
                                class="form-control" 
                                id="resposta-input" 
                                placeholder="Digite sua resposta..."
                                autocomplete="off"
                            >
                            <button class="btn btn-primary" type="submit" id="btn-enviar">
                                <i class="bi bi-send-fill"></i> Enviar
                            </button>
                        </div>
                        <div id="opcoes-resposta" class="mt-2" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .mensagem-ia {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-left: 4px solid #667eea;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease;
    }

    .mensagem-usuario {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        margin-left: auto;
        max-width: 80%;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .opcao-botao {
        display: inline-block;
        margin: 0.25rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 2px solid #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .opcao-botao:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }

    #chat-messages {
        scroll-behavior: smooth;
    }

    #chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #chat-messages::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const propriedadeId = {{ propriedade.id }};
    const ano = {{ ano }};
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const respostaInput = document.getElementById('resposta-input');
    const btnEnviar = document.getElementById('btn-enviar');
    const opcoesResposta = document.getElementById('opcoes-resposta');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const loadingInicial = document.getElementById('loading-inicial');
    const chatInputArea = document.getElementById('chat-input-area');

    let etapaAtual = 0;
    let totalEtapas = 0;

    // Iniciar chat
    iniciarChat();

    function iniciarChat() {
        fetch(`/propriedade/${propriedadeId}/planejamento/ia/api/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                acao: 'iniciar',
                ano: ano,
            }),
        })
        .then(response => response.json())
        .then(data => {
            loadingInicial.style.display = 'none';
            chatInputArea.style.display = 'block';
            
            if (data.erro) {
                adicionarMensagem('erro', data.erro);
            } else {
                etapaAtual = data.etapa || 1;
                totalEtapas = data.total || 1;
                atualizarProgresso();
                adicionarMensagem('ia', data.pergunta, data.tipo_resposta, data.opcoes);
                respostaInput.focus();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            loadingInicial.style.display = 'none';
            adicionarMensagem('erro', 'Erro ao iniciar chat. Por favor, recarregue a página.');
        });
    }

    function adicionarMensagem(tipo, texto, tipoResposta = null, opcoes = []) {
        const mensagemDiv = document.createElement('div');
        
        if (tipo === 'ia') {
            mensagemDiv.className = 'mensagem-ia';
            mensagemDiv.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-robot text-primary"></i>
                    <div class="flex-grow-1">
                        <strong>Assistente:</strong>
                        <p class="mb-0 mt-1">${texto}</p>
                    </div>
                </div>
            `;
        } else if (tipo === 'usuario') {
            mensagemDiv.className = 'mensagem-usuario';
            mensagemDiv.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-person-fill text-primary"></i>
                    <div class="flex-grow-1">
                        <strong>Você:</strong>
                        <p class="mb-0 mt-1">${texto}</p>
                    </div>
                </div>
            `;
        } else if (tipo === 'erro_validacao') {
            mensagemDiv.className = 'alert alert-warning border-warning';
            mensagemDiv.style.borderLeft = '4px solid #ffc107';
            mensagemDiv.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    <div class="flex-grow-1">
                        <strong>⚠️ Formato incorreto:</strong>
                        <p class="mb-0 mt-1">${texto}</p>
                    </div>
                </div>
            `;
        } else {
            mensagemDiv.className = 'alert alert-danger';
            mensagemDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${texto}`;
        }
        
        chatMessages.appendChild(mensagemDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Mostrar opções se houver
        if (opcoes && opcoes.length > 0) {
            mostrarOpcoes(opcoes);
        } else if (tipoResposta === 'sim_nao') {
            mostrarOpcoes(['Sim', 'Não']);
        } else {
            opcoesResposta.style.display = 'none';
            opcoesResposta.innerHTML = '';
        }
    }

    function mostrarOpcoes(opcoes) {
        opcoesResposta.innerHTML = '';
        opcoes.forEach(opcao => {
            const botao = document.createElement('button');
            botao.type = 'button';
            botao.className = 'opcao-botao';
            botao.textContent = opcao;
            botao.onclick = () => {
                respostaInput.value = opcao;
                enviarResposta();
            };
            opcoesResposta.appendChild(botao);
        });
        opcoesResposta.style.display = 'block';
    }

    function enviarResposta() {
        const resposta = respostaInput.value.trim();
        if (!resposta) return;

        // Mostrar resposta do usuário
        adicionarMensagem('usuario', resposta);
        respostaInput.value = '';
        btnEnviar.disabled = true;

        // Enviar para API
        fetch(`/propriedade/${propriedadeId}/planejamento/ia/api/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                acao: 'responder',
                resposta: resposta,
            }),
        })
        .then(response => response.json())
        .then(data => {
            btnEnviar.disabled = false;
            
            if (data.erro) {
                adicionarMensagem('erro', data.erro);
            } else if (data.tipo === 'erro_validacao') {
                // Mostrar mensagem de erro de validação
                adicionarMensagem('erro_validacao', data.mensagem_erro);
                // Manter a mesma pergunta para o usuário responder novamente
                etapaAtual = data.etapa || etapaAtual;
                totalEtapas = data.total || totalEtapas;
                atualizarProgresso();
                // Mostrar novamente a pergunta com instruções
                adicionarMensagem('ia', data.pergunta, data.tipo_resposta, data.opcoes);
                respostaInput.focus();
            } else if (data.tipo === 'pergunta') {
                etapaAtual = data.etapa || etapaAtual + 1;
                totalEtapas = data.total || totalEtapas;
                atualizarProgresso();
                adicionarMensagem('ia', data.pergunta, data.tipo_resposta, data.opcoes);
                respostaInput.focus();
            } else if (data.tipo === 'finalizar') {
                etapaAtual = totalEtapas;
                atualizarProgresso();
                adicionarMensagem('ia', data.mensagem || 'Deseja criar o planejamento agora?', 'sim_nao');
                respostaInput.focus();
            } else if (data.tipo === 'finalizado') {
                etapaAtual = totalEtapas;
                atualizarProgresso();
                adicionarMensagem('ia', 'Planejamento concluído! Deseja criar agora? (sim/não)', 'sim_nao');
                respostaInput.focus();
            }
            
            // Verificar se a resposta foi "sim" para finalizar
            const respostaLower = resposta.toLowerCase();
            if (data.tipo === 'finalizar' && (respostaLower === 'sim' || respostaLower === 's' || respostaLower === 'yes' || respostaLower === 'y')) {
                criarPlanejamento();
                return;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            btnEnviar.disabled = false;
            adicionarMensagem('erro', 'Erro ao enviar resposta. Tente novamente.');
        });
    }

    function atualizarProgresso() {
        const percentual = totalEtapas > 0 ? Math.round((etapaAtual / totalEtapas) * 100) : 0;
        progressBar.style.width = percentual + '%';
        progressText.textContent = percentual + '%';
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        enviarResposta();
    });

    // Botão cancelar
    document.getElementById('btn-cancelar').addEventListener('click', function() {
        if (confirm('Deseja realmente cancelar? Todo o progresso será perdido.')) {
            fetch(`/propriedade/${propriedadeId}/planejamento/ia/api/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    acao: 'cancelar',
                }),
            })
            .then(() => {
                window.location.href = `/propriedade/${propriedadeId}/pecuaria/planejamento/`;
            });
        }
    });

    // Detectar Enter no input
    respostaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            enviarResposta();
        }
    });

    // Função para criar planejamento
    function criarPlanejamento() {
        btnEnviar.disabled = true;
        adicionarMensagem('ia', 'Criando seu planejamento... Por favor, aguarde.');
        
        fetch(`/propriedade/${propriedadeId}/planejamento/ia/api/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                acao: 'criar',
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.erro) {
                adicionarMensagem('erro', data.erro);
                btnEnviar.disabled = false;
            } else if (data.sucesso) {
                adicionarMensagem('ia', '✅ ' + data.mensagem);
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            adicionarMensagem('erro', 'Erro ao criar planejamento. Tente novamente.');
            btnEnviar.disabled = false;
        });
    }

    // Função para obter CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

