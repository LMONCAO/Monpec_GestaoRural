{% extends 'base_modulos_unificado.html' %}
{% load static %}
{% load formatacao_br %}

{% block title %}Projeções - {{ propriedade.nome_propriedade }}{% endblock %}

{% block breadcrumb_extra %}
    <li class="breadcrumb-item">
        <a href="{% url 'pecuaria_dashboard' propriedade.id %}">
            <i class="bi bi-cow"></i> Pecuária
        </a>
    </li>
    <li class="breadcrumb-item active">
        <i class="bi bi-graph-up-arrow"></i> Projeções
    </li>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 fw-bold">
                <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                Projeções do Rebanho
            </h1>
            <p class="text-muted mb-0">
                Análise e projeção de crescimento do rebanho ao longo dos anos
            </p>
        </div>
        <div class="text-end">
            {% if estatisticas.tem_projecao %}
            <span class="badge bg-success fs-6 px-3 py-2">
                <i class="bi bi-check-circle me-1"></i>
                Projeção Ativa
            </span>
            {% else %}
            <span class="badge bg-warning fs-6 px-3 py-2">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Sem Projeção
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Alertas de validação -->
    {% if not inventario %}
    <div class="alert alert-warning border-0 shadow-sm mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <strong>Inventário não cadastrado</strong>
                <p class="mb-0">É necessário cadastrar o inventário inicial antes de gerar projeções.</p>
                <!-- Inventário removido -->
            </div>
        </div>
    </div>
    {% elif not parametros %}
    <div class="alert alert-warning border-0 shadow-sm mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <strong>Parâmetros não configurados</strong>
                <p class="mb-0">Configure os parâmetros de projeção antes de gerar projeções.</p>
                <a href="{% url 'pecuaria_parametros' propriedade.id %}" class="btn btn-sm btn-warning mt-2">
                    Configurar Parâmetros
                </a>
            </div>
        </div>
    </div>
    {% else %}
    
    <!-- Cards de Resumo -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="text-muted small">Rebanho Atual</span>
                        <i class="bi bi-people-fill text-primary fs-4"></i>
                    </div>
                    <h2 class="h4 mb-0 fw-bold text-primary">{{ total_geral|numero_br:0 }}</h2>
                    <small class="text-muted">cabezas</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="text-muted small">Fêmeas</span>
                        <i class="bi bi-gender-female text-danger fs-4"></i>
                    </div>
                    <h2 class="h4 mb-0 fw-bold text-danger">{{ total_femeas|numero_br:0 }}</h2>
                    <small class="text-muted">cabezas</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="text-muted small">Machos</span>
                        <i class="bi bi-gender-male text-info fs-4"></i>
                    </div>
                    <h2 class="h4 mb-0 fw-bold text-info">{{ total_machos|numero_br:0 }}</h2>
                    <small class="text-muted">cabezas</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="text-muted small">Anos Projetados</span>
                        <i class="bi bi-calendar-range text-success fs-4"></i>
                    </div>
                    <h2 class="h4 mb-0 fw-bold text-success">{{ estatisticas.total_anos }}</h2>
                    <small class="text-muted">anos</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">
                        <i class="bi bi-gear-fill text-primary me-2"></i>
                        Gerar Nova Projeção
                    </h5>
                    <p class="text-muted small mb-0">
                        Configure o período de projeção e gere uma nova análise do crescimento do rebanho
                    </p>
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2 mb-0" role="alert">
                                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if planejamento_atual and planejamento_atual.codigo %}
                    <div class="alert alert-info border-start border-info border-4 d-flex align-items-center mt-3 mb-0" role="alert">
                        <div class="flex-shrink-0 me-3">
                            <i class="bi bi-hash fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <strong>ID da Projeção Atual:</strong>
                            <span class="badge bg-primary fs-6 ms-2">{{ planejamento_atual.codigo }}</span>
                            <a href="{% url 'analise_cenarios' propriedade.id %}?codigo={{ planejamento_atual.codigo }}" 
                               class="btn btn-sm btn-outline-primary ms-2">
                                <i class="bi bi-arrow-right me-1"></i>Ir para Cenários
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <form method="post" id="form-gerar-projecao" class="d-flex gap-2" action="{% url 'pecuaria_projecao' propriedade.id %}">
                        {% csrf_token %}
                        <select name="anos_projecao" id="anos-projecao" class="form-select form-select-sm" required>
                            <option value="1">1 ano</option>
                            <option value="2">2 anos</option>
                            <option value="3">3 anos</option>
                            <option value="4">4 anos</option>
                            <option value="5" selected>5 anos</option>
                            <option value="10">10 anos</option>
                            <option value="15">15 anos</option>
                            <option value="20">20 anos</option>
                        </select>
                        <button type="submit" id="btn-gerar-projecao" class="btn btn-primary btn-sm">
                            <i class="bi bi-play-circle me-1"></i>
                            <span class="btn-text">Gerar</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Evolução do Rebanho -->
    {% if evolucao_rebanho %}
    {{ evolucao_rebanho|json_script:"evolucao-data" }}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Evolução do Rebanho
            </h5>
        </div>
        <div class="card-body">
            <canvas id="graficoEvolucao" height="80"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Tabelas de Projeção por Ano -->
    {% if resumo_projecao_por_ano %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-table text-primary me-2"></i>
                Resumo da Projeção por Ano
            </h5>
            <div class="btn-group">
                <a href="{% url 'exportar_projecao_pdf' propriedade.id %}" class="btn btn-danger btn-sm" title="Gerar relatório PDF paginado ano por ano">
                    <i class="bi bi-file-pdf me-1"></i>
                    Exportar PDF
                </a>
                <a href="{% url 'exportar_projecao_excel' propriedade.id %}" class="btn btn-success btn-sm" title="Exportar para Excel">
                    <i class="bi bi-file-excel me-1"></i>
                    Exportar Excel
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                {% for ano, dados in resumo_projecao_por_ano.items %}
                {% if dados.categorias and dados.categorias|length > 0 %}
                <!-- Página do Ano {{ ano }} -->
                <div class="projecao-ano-page" style="page-break-after: always; margin-bottom: 3rem; padding: 2rem 0;">
                    <!-- Cabeçalho do Ano -->
                    <div class="bg-primary text-white px-4 py-3 mb-3 rounded-top">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1 fw-bold">
                                    <i class="bi bi-calendar-year me-2"></i>
                                    {% if propriedade.produtor %}
                                        <span>{{ propriedade.produtor.nome }} - {{ propriedade.nome_propriedade }}</span>
                                        {% if propriedade.inscricao_estadual %}
                                            <span class="badge bg-light text-dark ms-2">IE: {{ propriedade.inscricao_estadual }}</span>
                                        {% elif propriedade.produtor.cpf_cnpj %}
                                            <span class="badge bg-light text-dark ms-2">CPF/CNPJ: {{ propriedade.produtor.cpf_cnpj }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span>{{ propriedade.nome_propriedade }}</span>
                                    {% endif %}
                                    <span class="ms-2">- Projeção do Ano {{ ano }}</span>
                                </h4>
                                <p class="mb-0 small">
                                    <i class="bi bi-info-circle me-1"></i>
                                    {% if forloop.first %}
                                        <strong>Saldo Inicial:</strong> Baseado no inventário cadastrado ({{ dados.totais.saldo_inicial_total|numero_br:0 }} cabeças)
                                    {% else %}
                                        <strong>Saldo Inicial:</strong> Baseado no saldo final do ano {{ dados.ano_anterior }} ({{ dados.saldo_final_ano_anterior|numero_br:0 }} cabeças)
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                {% if dados.totais %}
                                <div class="small">
                                    <div class="mb-1">
                                        <strong>Saldo Inicial Total:</strong> {{ dados.totais.saldo_inicial_total|numero_br:0 }} cabeças
                                    </div>
                                    <div>
                                        <strong>Saldo Final Total:</strong> {{ dados.totais.saldo_final_total|numero_br:0 }} cabeças
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if dados.categorias and dados.categorias|length > 0 %}
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Categoria</th>
                                <th class="text-center">Saldo Inicial</th>
                                <th class="text-center">Nascimentos</th>
                                <th class="text-center">Compras</th>
                                <th class="text-center">Vendas</th>
                                <th class="text-center">Mortes</th>
                                <th class="text-center">Transferências</th>
                                <th class="text-center">Evolução</th>
                                <th class="text-center">Saldo Final</th>
                                <th class="text-end">Valor Unitário (R$)</th>
                                <th class="text-end">Valor Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria, info in dados.categorias.items %}
                            <tr>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        {{ categoria }}
                                    </span>
                                </td>
                                <td class="text-center">{{ info.saldo_inicial|numero_br:0 }}</td>
                                <td class="text-center text-success">
                                    {% if info.nascimentos > 0 %}+{{ info.nascimentos|numero_br:0 }}{% else %}-{% endif %}
                                </td>
                                <td class="text-center text-info">
                                    {% if info.compras > 0 %}+{{ info.compras|numero_br:0 }}{% else %}-{% endif %}
                                </td>
                                <td class="text-center text-danger">
                                    {% if info.vendas > 0 %}-{{ info.vendas|numero_br:0 }}{% else %}-{% endif %}
                                </td>
                                <td class="text-center text-muted">
                                    {% if info.mortes > 0 %}-{{ info.mortes|numero_br:0 }}{% else %}-{% endif %}
                                </td>
                                <td class="text-center text-secondary">
                                    {% if info.transferencias_entrada > 0 or info.transferencias_saida > 0 %}
                                        <span class="d-block">
                                            {% if info.transferencias_entrada > 0 %}
                                                <span class="text-success">+{{ info.transferencias_entrada|numero_br:0 }}</span>
                                            {% endif %}
                                            {% if info.transferencias_saida > 0 %}
                                                <span class="text-danger">-{{ info.transferencias_saida|numero_br:0 }}</span>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center text-warning">
                                    {% if info.evolucao_categoria and info.evolucao_categoria != "-" %}
                                        {{ info.evolucao_categoria }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center fw-bold">{{ info.saldo_final|numero_br:0 }}</td>
                                <td class="text-end">
                                    <span class="valor-unitario-editavel" 
                                          data-categoria="{{ categoria }}" 
                                          data-ano="{{ ano }}"
                                          data-propriedade-id="{{ propriedade.id }}"
                                          data-valor-atual="{{ info.valor_unitario|floatformat:2 }}"
                                          data-saldo-final="{{ info.saldo_final }}"
                                          style="cursor: pointer; padding: 4px 8px; border-radius: 4px; display: inline-block; min-width: 100px;"
                                          onmouseover="this.style.backgroundColor='#f0f0f0'"
                                          onmouseout="this.style.backgroundColor='transparent'"
                                          onclick="editarValorUnitario(this)">
                                        <strong>{{ info.valor_unitario|moeda_br }}</strong>
                                        <i class="bi bi-pencil-square ms-1 text-muted" style="font-size: 0.8em;"></i>
                                    </span>
                                </td>
                                <td class="text-end">
                                    <strong class="valor-total-calculado" data-categoria="{{ categoria }}" data-ano="{{ ano }}">
                                        {{ info.valor_total|moeda_br }}
                                    </strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% if dados.totais %}
                        <tfoot class="table-light">
                            <tr>
                                <th>TOTAL</th>
                                <th class="text-center">{{ dados.totais.saldo_inicial_total|numero_br:0 }}</th>
                                <th class="text-center text-success">{{ dados.totais.nascimentos_total|numero_br:0 }}</th>
                                <th class="text-center text-info">{{ dados.totais.compras_total|numero_br:0 }}</th>
                                <th class="text-center text-danger">{{ dados.totais.vendas_total|numero_br:0 }}</th>
                                <th class="text-center text-muted">{{ dados.totais.mortes_total|numero_br:0 }}</th>
                                <th class="text-center text-secondary">
                                    {% if dados.totais.transferencias_entrada_total > 0 or dados.totais.transferencias_saida_total > 0 %}
                                        <span class="d-block">
                                            {% if dados.totais.transferencias_entrada_total > 0 %}
                                                <span class="text-success">+{{ dados.totais.transferencias_entrada_total|numero_br:0 }}</span>
                                            {% endif %}
                                            {% if dados.totais.transferencias_saida_total > 0 %}
                                                <span class="text-danger">-{{ dados.totais.transferencias_saida_total|numero_br:0 }}</span>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </th>
                                <th class="text-center">-</th>
                                <th class="text-center">{{ dados.totais.saldo_final_total|numero_br:0 }}</th>
                                <th class="text-end">-</th>
                                <th class="text-end">
                                    <strong id="valor-total-geral-{{ ano }}">{{ dados.totais.valor_total_geral|moeda_br }}</strong>
                                </th>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                    {% endif %}
                    
                    <!-- Rodapé do Ano -->
                    {% if dados.totais %}
                    <div class="bg-light px-4 py-3 mt-3 rounded-bottom border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="bi bi-calculator me-1"></i>
                                    <strong>Resumo Financeiro:</strong>
                                    Receitas: {{ dados.totais.receitas_total|moeda_br }} | 
                                    Custos: {{ dados.totais.custos_total|moeda_br }} | 
                                    Lucro: {{ dados.totais.lucro_total|moeda_br }}
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right-circle me-1"></i>
                                    <strong>Próximo Ano:</strong> Saldo Final deste ano será o Saldo Inicial do ano {{ ano|add:"1" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <!-- Fim da Página do Ano {{ ano }} -->
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info border-0 shadow-sm">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
            <div>
                <strong>Nenhuma projeção encontrada</strong>
                <p class="mb-0">Gere uma nova projeção usando o formulário acima para visualizar os dados.</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if evolucao_rebanho %}
    // Gráfico de Evolução do Rebanho
    const ctx = document.getElementById('graficoEvolucao');
    if (ctx) {
        try {
            const evolucaoDataElement = document.getElementById('evolucao-data');
            
            if (evolucaoDataElement && evolucaoDataElement.textContent) {
                const evolucaoData = JSON.parse(evolucaoDataElement.textContent);
                
                if (evolucaoData && Array.isArray(evolucaoData) && evolucaoData.length > 0) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: evolucaoData.map(e => e.ano),
                            datasets: [
                                {
                                    label: 'Saldo Inicial',
                                    data: evolucaoData.map(e => e.saldo_inicial || 0),
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Saldo Final',
                                    data: evolucaoData.map(e => e.saldo_final || 0),
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString('pt-BR');
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.warn('[PROJEÇÃO] Dados de evolução vazios ou inválidos');
                }
            } else {
                console.warn('[PROJEÇÃO] Elemento evolucao-data não encontrado');
            }
        } catch (error) {
            console.error('[PROJEÇÃO] Erro ao criar gráfico de evolução:', error);
        }
    }
    {% endif %}
});
</script>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.table th {
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table td {
    font-size: 0.9rem;
    vertical-align: middle;
}

.badge {
    font-weight: 500;
}

/* Estilos para planilha paginada */
.projecao-ano-page {
    margin-bottom: 4rem;
    padding: 2rem 0;
    border-top: 3px solid #e9ecef;
}

.projecao-ano-page:first-child {
    border-top: none;
    padding-top: 0;
}

.projecao-ano-page:last-child {
    margin-bottom: 0;
}

@media print {
    .projecao-ano-page {
        page-break-after: always;
        page-break-inside: avoid;
    }
    
    .projecao-ano-page:last-child {
        page-break-after: auto;
    }
}

.table-bordered {
    border: 1px solid #dee2e6;
}

.table-bordered th,
.table-bordered td {
    border: 1px solid #dee2e6;
}

.table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-gerar-projecao');
    const btnGerar = document.getElementById('btn-gerar-projecao');
    
    if (form && btnGerar) {
        form.addEventListener('submit', function(e) {
            const anos = document.getElementById('anos-projecao').value;
            console.log(`[PROJEÇÃO] Iniciando geração para ${anos} anos...`);
            
            // Validações
            if (!anos || anos < 1 || anos > 20) {
                e.preventDefault();
                alert('Por favor, selecione um número válido de anos (1 a 20).');
                return false;
            }
            
            // Mostrar feedback visual
            btnGerar.disabled = true;
            const btnText = btnGerar.querySelector('.btn-text');
            if (btnText) {
                btnText.textContent = 'Gerando...';
            }
            const spinner = btnGerar.querySelector('.spinner-border');
            if (spinner) {
                spinner.classList.remove('d-none');
            }
            btnGerar.classList.add('disabled');
            
            // Remover alertas anteriores
            const alertasAnteriores = form.parentElement.querySelectorAll('.alert');
            alertasAnteriores.forEach(alert => {
                if (alert.id !== 'alert-gerando') {
                    alert.remove();
                }
            });
            
            // Mostrar mensagem de processamento
            let alertDiv = document.getElementById('alert-gerando');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = 'alert-gerando';
                alertDiv.className = 'alert alert-info alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="bi bi-hourglass-split me-2"></i>
                    <strong>Gerando projeção para ${anos} anos...</strong> Isso pode levar alguns minutos. Por favor, aguarde e não feche esta página.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                form.parentElement.appendChild(alertDiv);
            }
            
            console.log(`[PROJEÇÃO] Submetendo formulário...`);
            // Permitir que o formulário seja submetido normalmente
            return true;
        });
    } else {
        console.error('[PROJEÇÃO] Formulário ou botão não encontrado!');
    }
});

// Função para editar valor unitário inline
function editarValorUnitario(element) {
    const valorAtual = parseFloat(element.getAttribute('data-valor-atual')) || 0;
    const categoria = element.getAttribute('data-categoria');
    const ano = element.getAttribute('data-ano');
    const propriedadeId = element.getAttribute('data-propriedade-id');
    
    // Criar input para edição
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.01';
    input.min = '0';
    input.value = valorAtual.toFixed(2);
    input.className = 'form-control form-control-sm';
    input.style.width = '120px';
    input.style.display = 'inline-block';
    
    // Substituir o conteúdo
    const valorOriginal = element.innerHTML;
    element.innerHTML = '';
    element.appendChild(input);
    input.focus();
    input.select();
    
    // Função para salvar
    const salvar = () => {
        const novoValor = parseFloat(input.value) || 0;
        if (novoValor < 0) {
            alert('O valor não pode ser negativo!');
            input.focus();
            return;
        }
        
        // Atualizar o valor unitário exibido
        element.setAttribute('data-valor-atual', novoValor);
        element.innerHTML = `<strong>${formatarMoeda(novoValor)}</strong> <i class="bi bi-pencil-square ms-1 text-muted" style="font-size: 0.8em;"></i>`;
        
        // Recalcular valor total
        recalcularValorTotal(categoria, ano, novoValor, propriedadeId);
    };
    
    // Salvar ao pressionar Enter ou perder foco
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            salvar();
        }
    });
    
    input.addEventListener('blur', salvar);
    
    // Cancelar com Escape
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            element.innerHTML = valorOriginal;
        }
    });
}

// Função para recalcular valor total
function recalcularValorTotal(categoria, ano, valorUnitario, propriedadeId) {
    // Encontrar a linha da categoria
    const elemento = document.querySelector(`[data-categoria="${categoria}"][data-ano="${ano}"]`);
    if (!elemento) return;
    
    const linha = elemento.closest('tr');
    if (!linha) return;
    
    // Usar saldo final do data attribute (mais confiável)
    const saldoFinal = parseInt(elemento.getAttribute('data-saldo-final')) || 0;
    const valorTotalElement = linha.querySelector('.valor-total-calculado');
    
    if (!valorTotalElement) return;
    
    // Calcular novo valor total
    const novoValorTotal = saldoFinal * valorUnitario;
    
    // Atualizar exibição
    valorTotalElement.textContent = formatarMoeda(novoValorTotal);
    
    // Recalcular total geral do ano
    recalcularTotalGeralAno(ano);
}

// Função para recalcular total geral do ano
function recalcularTotalGeralAno(ano) {
    const linhas = document.querySelectorAll(`[data-ano="${ano}"]`);
    let totalGeral = 0;
    
    linhas.forEach(linha => {
        const tr = linha.closest('tr');
        if (tr && !tr.classList.contains('table-light')) { // Ignorar linha de totais
            const valorTotalElement = tr.querySelector('.valor-total-calculado');
            if (valorTotalElement) {
                const valorTexto = valorTotalElement.textContent.trim();
                // Extrair número (remover R$, pontos e vírgula)
                const valor = parseFloat(valorTexto.replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.')) || 0;
                totalGeral += valor;
            }
        }
    });
    
    // Atualizar total geral
    const totalGeralElement = document.getElementById(`valor-total-geral-${ano}`);
    if (totalGeralElement) {
        totalGeralElement.textContent = formatarMoeda(totalGeral);
    }
}

// Função auxiliar para formatar moeda
function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}
</script>
{% endblock %}