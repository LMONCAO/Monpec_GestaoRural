{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Curral Master Pro | Inteligência e Rastreabilidade</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --bg: #05070a; --card: #11141a; --border: #30363d;
            --blue: #2f81f7; --green: #2ea043; --yellow: #d29922; --red: #f85149;
            --cyan-block: #00f2ff; --text: #e6edf3; --text-dim: #8b949e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        header { height: 50px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-size: 12px; }

        .badge-blockchain { 
            background: rgba(0, 242, 255, 0.1); color: var(--cyan-block); 
            border: 1px solid var(--cyan-block); padding: 4px 10px; border-radius: 20px; 
            font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }

        main { display: grid; grid-template-columns: 300px 1fr 340px; gap: 10px; padding: 10px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: rgba(255,255,255,0.03); padding: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: var(--blue); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        /* ESTAÇÃO DE CAPTURA */
        .estacao-captura {
            background: #000; border: 2px solid var(--blue); border-radius: 12px; padding: 15px;
            display: grid; grid-template-columns: 1fr 1fr auto 140px; gap: 15px; align-items: center; margin-bottom: 10px;
            box-shadow: 0 0 25px rgba(47, 129, 247, 0.2);
        }
        .input-master label { font-size: 9px; color: var(--blue); font-weight: 800; margin-bottom: 6px; text-transform: uppercase; display: block; }
        .input-master input { background: #161b22; border: 1px solid var(--border); color: white; padding: 10px; font-size: 16px; font-weight: bold; border-radius: 6px; width: 100%; outline: none; font-family: 'Courier New', monospace; }

        .peso-estacao { text-align: right; border-left: 1px solid var(--border); padding-left: 15px; }
        .peso-estacao span { font-size: 28px; font-weight: 900; color: var(--green); display: block; line-height: 1; }

        /* SEMÁFORO */
        .semaforo { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .indicador { background: #1c2128; border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; font-size: 9px; font-weight: bold; }
        .indicador i { display: block; font-size: 18px; margin-bottom: 5px; }
        .conforme { color: var(--green); border-color: var(--green); }
        .divergente { color: var(--yellow); border-color: var(--yellow); animation: blink 2s infinite; }
        .critico { color: var(--red); border-color: var(--red); }

        /* IDENTIDADE E ORIGEM (LAYOUT ATUALIZADO) */
        .header-identidade {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 1px;
            background: var(--border);
            border-bottom: 1px solid var(--border);
        }
        .id-box-master { background: #1c2128; padding: 12px; }
        .id-box-master label { font-size: 8px; color: var(--blue); text-transform: uppercase; display: block; margin-bottom: 4px; font-weight: bold;}
        .id-box-master b { font-size: 16px; color: white; display: block; letter-spacing: 1px; }

        .dossie-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); flex-grow: 1; }
        .field { background: var(--card); padding: 8px 12px; }
        .field label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 2px; }
        .field span { font-size: 13px; font-weight: 600; color: white; display: block; }

        /* PERFORMANCE E MEMÓRIA */
        .performance-box { grid-column: span 3; background: #0d1117; display: flex; flex-direction: column; border-top: 1px solid var(--border); }
        .ganhos-row { display: flex; justify-content: space-around; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .memoria-row { padding: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: rgba(47, 129, 247, 0.05); }

        /* FILA LATERAL */
        .fila-scroll { overflow-y: auto; flex-grow: 1; }
        .animal-row { padding: 12px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto; font-size: 11px; align-items: center; }

        footer { height: 70px; background: var(--card); border-top: 1px solid var(--border); padding: 10px 20px; display: flex; gap: 15px; }
        .btn-main { flex: 1; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px; border: none; }
        .btn-confirm { background: var(--green); color: white; font-size: 16px; }
        .btn-ficha { background: var(--blue); color: white; }
        .btn-secondary { background: #1c2128; color: white; border: 1px solid var(--border); }

        /* Sistema de Apartação */
        .apartacao-opcao.selecionado {
            background: rgba(47, 129, 247, 0.2) !important;
            border-color: var(--blue) !important;
            box-shadow: 0 0 10px rgba(47, 129, 247, 0.3);
        }

        .apartacao-opcao {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apartacao-opcao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

    </style>

    <script>
        // Estado global da aplicação
        let estadoCurral = {
            animalAtual: null,
            sessaoAtiva: null,
            pesoBalanca: 0,
            identificacaoAtiva: false
        };

        // URLs das APIs
        const urls = {
            identificar: '{% url "curral_identificar_animal_v4" propriedade.id %}',
            registrar: '{% url "curral_registrar_manejo_v4" propriedade.id %}',
            stats: '{{ stats_url }}',
            criarSessao: '{{ criar_sessao_url }}',
            encerrarSessao: '{{ encerrar_sessao_url }}',
            statsSessao: '{{ stats_sessao_url }}'
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            inicializarCurral();
            configurarEventos();
            iniciarMonitoramentoBalanca();
            inicializarSistemaApartacao();
        });

        function inicializarCurral() {
            // Carregar estatísticas iniciais
            carregarEstatisticas();

            // Verificar sessão ativa
            verificarSessaoAtiva();

            // Configurar foco no campo de identificação
            const campoRFID = document.querySelector('input[value*="982.000012345678"]');
            if (campoRFID) {
                campoRFID.focus();
                campoRFID.select();
            }
        }

        function configurarEventos() {
            // Campo RFID - identificação automática
            const campoRFID = document.querySelector('input[value*="982.000012345678"]');
            if (campoRFID) {
                campoRFID.addEventListener('input', function(e) {
                    identificarAnimalAutomatico(e.target.value);
                });
                campoRFID.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        identificarAnimal(e.target.value);
                    }
                });
            }

            // Campo identificação de manejo
            const campoManejo = document.querySelector('input[value*="MN-880"]');
            if (campoManejo) {
                campoManejo.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        identificarAnimalPorManejo(e.target.value);
                    }
                });
            }

            // Botão sincronizar
            const btnSync = document.querySelector('.btn-secondary[style*="margin-top:15px"]');
            if (btnSync) {
                btnSync.addEventListener('click', sincronizarDados);
            }

            // Botão salvar e liberar (ENTER)
            const btnSalvar = document.querySelector('.btn-confirm');
            if (btnSalvar) {
                btnSalvar.addEventListener('click', salvarELiberar);
            }

            // Botão ficha completa
            const btnFicha = document.querySelector('.btn-ficha');
            if (btnFicha) {
                btnFicha.addEventListener('click', abrirFichaCompleta);
            }

            // Botão trocar brinco
            const btnTrocarBrinco = document.querySelector('.btn-secondary[style*="flex: 0.3"]');
            if (btnTrocarBrinco) {
                btnTrocarBrinco.addEventListener('click', trocarBrinco);
            }

            // Atalho ENTER global
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.target.matches('input, textarea, select')) {
                    salvarELiberar();
                }
            });
        }

        // Sistema de identificação automática
        function identificarAnimalAutomatico(codigo) {
            if (codigo.length < 3) return;

            // Debounce para evitar múltiplas requisições
            clearTimeout(estadoCurral.timerIdentificacao);
            estadoCurral.timerIdentificacao = setTimeout(() => {
                identificarAnimal(codigo);
            }, 500);
        }

        async function identificarAnimal(codigo) {
            if (!codigo || codigo.trim() === '') return;

            try {
                estadoCurral.identificacaoAtiva = true;
                mostrarCarregamento(true);

                const response = await fetch(urls.identificar, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        codigo: codigo.trim(),
                        tipo_identificacao: detectarTipoIdentificacao(codigo)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    estadoCurral.animalAtual = data.animal;
                    atualizarInterfaceAnimal(data.animal);
                    atualizarSemaforos(data.animal);
                    tocarSomSucesso();
                } else {
                    mostrarErro(data.message || 'Animal não encontrado');
                    tocarSomErro();
                }

            } catch (error) {
                console.error('Erro na identificação:', error);
                mostrarErro('Erro de comunicação com o servidor');
                tocarSomErro();
            } finally {
                estadoCurral.identificacaoAtiva = false;
                mostrarCarregamento(false);
            }
        }

        function identificarAnimalPorManejo(codigoManejo) {
            if (!codigoManejo || codigoManejo.trim() === '') return;

            identificarAnimal(codigoManejo);
        }

        function detectarTipoIdentificacao(codigo) {
            // Remove caracteres não numéricos
            const codigoLimpo = codigo.replace(/\D/g, '');

            if (codigoLimpo.length === 15) {
                return 'SISBOV';
            } else if (codigoLimpo.length >= 10) {
                return 'RFID';
            } else if (codigo.includes('MN-') || codigo.includes('BR-')) {
                return 'MANEJO';
            }

            return 'DESCONHECIDO';
        }

        function atualizarInterfaceAnimal(animal) {
            // Atualizar nome do animal
            const nomeAnimal = document.querySelector('.id-box-master b');
            if (nomeAnimal) {
                nomeAnimal.textContent = animal.nome || `ANIMAL ${animal.numero_brinco || animal.numero_manejo}`;
            }

            // Atualizar SISBOV
            const sisbovElement = document.querySelector('.id-box-master:nth-child(2) b');
            if (sisbovElement) {
                sisbovElement.textContent = animal.codigo_sisbov || 'N/A';
            }

            // Atualizar número de manejo
            const manejoElement = document.querySelector('.id-box-master:nth-child(3) b');
            if (manejoElement) {
                manejoElement.textContent = animal.numero_manejo || 'N/A';
            }

            // Atualizar dados da grade
            atualizarGradeDados(animal);

            // Atualizar performance
            atualizarPerformance(animal);
        }

        function atualizarGradeDados(animal) {
            // Sexo
            const campoSexo = document.querySelector('.field:nth-child(1) span');
            if (campoSexo) campoSexo.textContent = animal.sexo || 'N/A';

            // Raça
            const campoRaca = document.querySelector('.field:nth-child(2) span');
            if (campoRaca) campoRaca.textContent = animal.raca || 'N/A';

            // Categoria
            const campoCategoria = document.querySelector('.field:nth-child(3) span');
            if (campoCategoria) campoCategoria.textContent = animal.categoria || 'N/A';

            // Mãe
            const campoMae = document.querySelector('.field:nth-child(4) span');
            if (campoMae) campoMae.textContent = animal.mae || 'N/A';

            // Pai
            const campoPai = document.querySelector('.field:nth-child(5) span');
            if (campoPai) campoPai.textContent = animal.pai || 'N/A';

            // Origem
            const campoOrigem = document.querySelector('.field:nth-child(6) span');
            if (campoOrigem) campoOrigem.textContent = animal.origem || 'N/A';

            // Data nascimento
            const campoNascimento = document.querySelector('.field:nth-child(7) span');
            if (campoNascimento) campoNascimento.textContent = animal.data_nascimento ? formatarData(animal.data_nascimento) : 'N/A';

            // Idade calculada
            const campoIdade = document.querySelector('.field:nth-child(8) span');
            if (campoIdade) campoIdade.textContent = animal.idade_calculada || 'N/A';

            // Cadastro BND
            const campoBND = document.querySelector('.field:nth-child(9) span');
            if (campoBND) campoBND.textContent = animal.data_cadastro_bnd ? formatarData(animal.data_cadastro_bnd) : 'N/A';
        }

        function atualizarPerformance(animal) {
            // GMD Diário
            const gmdElement = document.querySelector('.ganhos-row div:nth-child(1) b');
            if (gmdElement) gmdElement.textContent = animal.gmd_diario ? `${animal.gmd_diario} kg` : '+0.00 kg';

            // Ganho período
            const ganhoPeriodoElement = document.querySelector('.ganhos-row div:nth-child(2) b');
            if (ganhoPeriodoElement) ganhoPeriodoElement.textContent = animal.ganho_periodo ? `+${animal.ganho_periodo} kg` : '+0.0 kg';

            // Ganho total
            const ganhoTotalElement = document.querySelector('.ganhos-row div:nth-child(3) b');
            if (ganhoTotalElement) ganhoTotalElement.textContent = animal.ganho_total ? `+${animal.ganho_total} kg` : '+0.0 kg';

            // Última passagem
            const ultimaPassagem = document.querySelector('.memoria-row div:nth-child(1) b');
            if (ultimaPassagem) ultimaPassagem.textContent = animal.ultima_passagem ? formatarData(animal.ultima_passagem) : 'Nunca';

            // Serviços realizados
            const servicos = document.querySelector('.memoria-row div:nth-child(2) span');
            if (servicos) servicos.textContent = animal.servicos_realizados || 'Nenhum';

            // Status reprodutivo
            const statusReprodutivo = document.querySelector('.memoria-row div:nth-child(3) b');
            if (statusReprodutivo) statusReprodutivo.textContent = animal.status_reprodutivo || 'N/A';
        }

        function atualizarSemaforos(animal) {
            // BND/MAPA
            atualizarSemaforo('BND / MAPA', animal.conformidade_bnd || false);

            // Carência
            atualizarSemaforo('CARÊNCIA', animal.status_carencia === 'APTO');

            // Cota Hilton
            atualizarSemaforo('COTA HILTON', animal.conformidade_hilton || false);

            // Conformidade geral
            atualizarSemaforo('CONFORMIDADE', animal.status_conformidade === 'CONFORME');
        }

        function atualizarSemaforo(tipo, conforme) {
            const semaforos = document.querySelectorAll('.semaforo .indicador');
            let indicador = null;

            semaforos.forEach(ind => {
                if (ind.textContent.includes(tipo) || ind.textContent.includes(tipo.split(' ')[0])) {
                    indicador = ind;
                }
            });

            if (indicador) {
                indicador.classList.remove('conforme', 'divergente', 'critico');

                if (conforme) {
                    indicador.classList.add('conforme');
                    indicador.querySelector('i').className = 'fas fa-check-double';
                } else {
                    indicador.classList.add('divergente');
                    indicador.querySelector('i').className = 'fas fa-exclamation-triangle';
                }
            }
        }

        async function salvarELiberar() {
            if (!estadoCurral.animalAtual) {
                mostrarErro('Nenhum animal identificado');
                return;
            }

            try {
                mostrarCarregamento(true);

                const dadosManejo = {
                    animal_id: estadoCurral.animalAtual.id,
                    peso: estadoCurral.pesoBalanca,
                    manejos: coletarManejosSelecionados(),
                    observacoes: ''
                };

                const response = await fetch(urls.registrar, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(dadosManejo)
                });

                const data = await response.json();

                if (data.success) {
                    mostrarSucesso('Animal processado com sucesso!');
                    tocarSomSucesso();
                    limparInterface();
                    focarCampoIdentificacao();
                } else {
                    mostrarErro(data.message || 'Erro ao salvar');
                    tocarSomErro();
                }

            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarErro('Erro de comunicação');
                tocarSomErro();
            } finally {
                mostrarCarregamento(false);
            }
        }

        function coletarManejosSelecionados() {
            // Coletar manejos selecionados da interface
            const manejos = [];

            // Verificar vacinações pendentes
            const vacinasPendentes = document.querySelector('.badge-danger');
            if (vacinasPendentes && vacinasPendentes.textContent.includes('Pendente')) {
                manejos.push({
                    tipo: 'VACINACAO',
                    descricao: 'Vacinação Aftosa',
                    prioridade: 'ALTA'
                });
            }

            // Verificar apartação sugerida
            const opcaoEngorda = document.querySelector('.border-blue');
            const opcaoVenda = document.querySelector('.border-gray');

            if (opcaoEngorda && opcaoEngorda.classList.contains('selecionado')) {
                manejos.push({
                    tipo: 'APARTACAO',
                    descricao: 'Apartação para ENGORDA',
                    destino: 'ENGORDA'
                });
            }

            if (opcaoVenda && opcaoVenda.classList.contains('selecionado')) {
                manejos.push({
                    tipo: 'APARTACAO',
                    descricao: 'Apartação para VENDA',
                    destino: 'VENDA'
                });
            }

            return manejos;
        }

        // Sistema de seleção de apartação
        function inicializarSistemaApartacao() {
            const opcoesApartacao = document.querySelectorAll('.border-blue, .border-gray');

            opcoesApartacao.forEach(opcao => {
                opcao.addEventListener('click', function() {
                    // Remover seleção anterior
                    opcoesApartacao.forEach(opt => opt.classList.remove('selecionado'));

                    // Adicionar seleção atual
                    this.classList.add('selecionado');

                    // Feedback visual
                    mostrarFeedbackApartacao(this.textContent.trim());
                });
            });
        }

        function mostrarFeedbackApartacao(destino) {
            // Implementar feedback visual da seleção
            console.log(`Apartação selecionada: ${destino}`);
        }

        function limparInterface() {
            estadoCurral.animalAtual = null;

            // Limpar campos de identificação
            const campoRFID = document.querySelector('input[value*="982.000012345678"]');
            if (campoRFID) {
                campoRFID.value = '';
            }

            const campoManejo = document.querySelector('input[value*="MN-880"]');
            if (campoManejo) {
                campoManejo.value = '';
            }

            // Resetar peso
            atualizarPesoBalanca(0);

            // Limpar dados do animal
            atualizarInterfaceAnimal({
                nome: 'BARÃO 4591',
                codigo_sisbov: 'BR 00.112-99',
                numero_manejo: 'MN-880'
            });

            // Resetar semáforos
            resetarSemaforos();
        }

        function resetarSemaforos() {
            const semaforos = document.querySelectorAll('.semaforo .indicador');
            semaforos.forEach(ind => {
                ind.classList.remove('conforme', 'divergente', 'critico');
                ind.classList.add('conforme'); // Estado padrão
                ind.querySelector('i').className = 'fas fa-check-double';
            });
        }

        function focarCampoIdentificacao() {
            const campoRFID = document.querySelector('input[value*="982.000012345678"]');
            if (campoRFID) {
                campoRFID.focus();
            }
        }

        // Sistema de pesagem
        function iniciarMonitoramentoBalanca() {
            // Simulação de balança com comunicação API
            setInterval(async () => {
                if (!estadoCurral.identificacaoAtiva) {
                    try {
                        // Simular leitura da balança (em produção seria hardware real)
                        const pesoSimulado = gerarPesoRealista();

                        // Enviar para API (opcional - para registro)
                        await enviarPesoParaAPI(pesoSimulado);

                        // Atualizar interface
                        atualizarPesoBalanca(pesoSimulado);

                        // Feedback visual de balança ativa
                        indicarBalancaAtiva();

                    } catch (error) {
                        console.error('Erro na leitura da balança:', error);
                        // Continuar com simulação local se API falhar
                        const pesoSimulado = gerarPesoRealista();
                        atualizarPesoBalanca(pesoSimulado);
                    }
                }
            }, 2000);
        }

        function gerarPesoRealista() {
            // Simular pesos realistas de bovinos
            const pesosBase = [450, 480, 512, 540, 580, 620, 680];
            const pesoBase = pesosBase[Math.floor(Math.random() * pesosBase.length)];

            // Variação natural ±2kg
            const variacao = (Math.random() - 0.5) * 4;
            return Math.max(100, Math.min(1200, pesoBase + variacao));
        }

        async function enviarPesoParaAPI(peso) {
            // Enviar peso para API (útil para auditoria e histórico)
            const response = await fetch(`{% url "curral_receber_peso_balanca_v4" propriedade.id %}?peso=${peso}`, {
                method: 'GET', // Usando GET para simplicidade
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Falha ao enviar peso para API');
            }

            return await response.json();
        }

        function indicarBalancaAtiva() {
            // Feedback visual de balança funcionando
            const elementoPeso = document.querySelector('.peso-estacao span');
            if (elementoPeso) {
                elementoPeso.style.color = 'var(--green)';
                setTimeout(() => {
                    elementoPeso.style.color = ''; // Voltar à cor padrão
                }, 500);
            }
        }

        function atualizarPesoBalanca(peso) {
            estadoCurral.pesoBalanca = peso;
            const elementoPeso = document.querySelector('.peso-estacao span');
            if (elementoPeso) {
                elementoPeso.textContent = peso.toFixed(2);
            }
        }

        // Utilitários
        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function mostrarCarregamento(mostrar) {
            // Implementar indicador de carregamento visual
            const body = document.body;
            if (mostrar) {
                body.style.cursor = 'wait';
            } else {
                body.style.cursor = 'default';
            }
        }

        function mostrarSucesso(mensagem) {
            // Implementar notificação de sucesso
            console.log('✅', mensagem);
        }

        function mostrarErro(mensagem) {
            // Implementar notificação de erro
            console.error('❌', mensagem);
            alert(mensagem); // Temporário
        }

        function tocarSomSucesso() {
            // Implementar som de sucesso
        }

        function tocarSomErro() {
            // Implementar som de erro
        }

        async function carregarEstatisticas() {
            try {
                const response = await fetch(urls.stats);
                const data = await response.json();

                if (data.success) {
                    atualizarEstatisticasInterface(data.stats);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        function atualizarEstatisticasInterface(stats) {
            // Atualizar contador de animais
            const contadorAnimais = document.querySelector('header div:last-child');
            if (contadorAnimais && stats.total_animais) {
                contadorAnimais.innerHTML = `ANIMAIS HOJE: <b>${stats.total_animais}</b>`;
            }
        }

        async function verificarSessaoAtiva() {
            try {
                const response = await fetch(urls.statsSessao);
                const data = await response.json();

                if (data.success && data.sessao) {
                    estadoCurral.sessaoAtiva = data.sessao;
                    atualizarInterfaceSessao(data.sessao);
                }
            } catch (error) {
                console.error('Erro ao verificar sessão:', error);
            }
        }

        function atualizarInterfaceSessao(sessao) {
            // Implementar atualização visual da sessão ativa
        }

        // Funções de manejos (temporariamente vazias)
        function sincronizarDados() {
            console.log('Sincronizando dados...');
        }

        function abrirFichaCompleta() {
            if (estadoCurral.animalAtual) {
                window.open(`/propriedade/{{ propriedade.id }}/rastreabilidade/animal/${estadoCurral.animalAtual.id}/`, '_blank');
            }
        }

        function trocarBrinco() {
            console.log('Função trocar brinco - implementar');
        }
    </script>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <h2 style="font-size: 16px;">CURRAL<span style="color:var(--blue)">MASTER</span></h2>
        <div class="badge-blockchain"><i class="fas fa-link"></i> REGISTRO CRIPTOGRÁFICO ATIVO</div>
    </div>
    <div style="font-size: 11px;">FAZENDA: <b>{{ propriedade.nome_propriedade|default:"DEMONSTRAÇÃO" }}</b> | ANIMAIS HOJE: <b>142</b></div>
</header>

<main>
    <aside class="panel">
        <div class="panel-header">Fila do Dia</div>
        <div class="fila-scroll">
            <div class="animal-row">
                <div><b>BR-4591</b><br><small>NELORE · MACHO</small></div>
                <div style="text-align:right"><b style="color:var(--green)">512kg</b></div>
            </div>
            <div class="animal-row">
                <div><b>BR-4590</b><br><small>NELORE · MACHO</small></div>
                <div style="text-align:right"><b style="color:var(--green)">542kg</b></div>
            </div>
        </div>
    </aside>

    <div style="display: flex; flex-direction: column; overflow-y: auto;">
        
        <section class="estacao-captura">
            <div class="input-master">
                <label>RFID / Bastão Eletrônico</label>
                <input type="text" value="982.000012345678">
            </div>
            <div class="input-master">
                <label>Identificação de Manejo</label>
                <input type="text" value="MN-880">
            </div>
            <button class="btn-main btn-secondary" style="height:40px; margin-top:15px;"><i class="fas fa-sync"></i></button>
            <div class="peso-estacao">
                <label style="font-size: 9px; color: var(--green);">BALANÇA</label>
                <span>512.45</span>
            </div>
        </section>

        <section class="semaforo">
            <div class="indicador conforme"><i class="fas fa-check-double"></i>BND / MAPA</div>
            <div class="indicador critico"><i class="fas fa-biohazard"></i>CARÊNCIA</div>
            <div class="indicador conforme"><i class="fas fa-award"></i>COTA HILTON</div>
            <div class="indicador divergente"><i class="fas fa-sync"></i>CONFORMIDADE</div>
        </section>

        <section class="panel">
            <div class="panel-header">Identidade e Origem</div>
            
            <div class="header-identidade">
                <div class="id-box-master">
                    <label>Nome do Animal</label>
                    <b>BARÃO 4591</b>
                </div>
                <div class="id-box-master">
                    <label>Número Sisbov</label>
                    <b>BR 00.112-99</b>
                </div>
                <div class="id-box-master">
                    <label>Número Manejo</label>
                    <b>MN-880</b>
                </div>
            </div>

            <div class="dossie-grid">
                <div class="field"><label>Sexo</label><span>MACHO</span></div>
                <div class="field"><label>Raça</label><span>NELORE</span></div>
                <div class="field"><label>Categoria</label><span>BOI GORDO</span></div>
                
                <div class="field"><label>Mãe</label><span>VACA 8890</span></div>
                <div class="field"><label>Pai</label><span>TOURO PO 440</span></div>
                <div class="field"><label>Origem</label><span>NASC. NA PROPRIEDADE</span></div>

                <div class="field"><label>Data Nascimento</label><span>15/05/2021</span></div>
                <div class="field"><label>Idade Calculada</label><span style="color: var(--blue);">31 MESES</span></div>
                <div class="field"><label>Cadastro BND</label><span>12/06/2021</span></div>

                <div class="performance-box">
                    <div class="ganhos-row">
                        <div style="text-align:center;"><label>GMD Diário</label><b style="color:var(--green)">+1.25 kg</b></div>
                        <div style="text-align:center;"><label>Ganho Período</label><b style="color:var(--green)">+38.5 kg</b></div>
                        <div style="text-align:center;"><label>Ganho Total</label><b style="color:var(--blue)">+142.0 kg</b></div>
                    </div>
                    <div class="memoria-row">
                        <div><label>Última Passagem</label><b>15/11/2023</b></div>
                        <div><label>Serviços Realizados</label><span style="font-size: 11px;">Vac. Aftosa, Pesagem</span></div>
                        <div style="text-align: right;"><label>Status Reprodutivo</label><b>N/A (MACHO)</b></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <aside class="panel">
        <div class="panel-header">Manejos e Aparte</div>
        <div style="padding: 15px;">
            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 6px; border-left: 4px solid var(--blue); margin-bottom: 10px;">
                <b style="font-size: 13px;">VACINAÇÃO AFTOSA</b><br><small style="color:var(--text-dim)">Pendente p/ Lote</small>
            </div>
            <div style="margin-top: 25px;">
                <label style="font-size: 9px; color: var(--text-dim); text-transform: uppercase;">Aparte Sugerido</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                    <div class="apartacao-opcao" style="background: rgba(47, 129, 247, 0.1); border: 2px solid var(--blue); padding: 12px; border-radius: 6px; text-align: center;"><b>ENGORDA</b></div>
                    <div class="apartacao-opcao" style="background: #1c2128; border: 1px solid var(--border); padding: 12px; border-radius: 6px; text-align: center;"><b>VENDA</b></div>
                </div>
            </div>
        </div>
    </aside>
</main>

<footer>
    <button class="btn-main btn-secondary" style="flex: 0.3;"><i class="fas fa-sync"></i> TROCAR BRINCO</button>
    <button class="btn-main btn-confirm"><i class="fas fa-check-double"></i> SALVAR E LIBERAR (ENTER)</button>
    <button class="btn-main btn-ficha" style="flex: 0.5;"><i class="fas fa-file-invoice"></i> FICHA COMPLETA DO ANIMAL</button>
</footer>

</body>
</html>
                    const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
                    const temIdadeOuData = idadeMeses || dataNasc;
                    
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disab