{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Financiamento - {{ propriedade.nome_propriedade }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-plus-circle"></i> Novo Financiamento</h2>
                    <p class="text-muted mb-0">Propriedade: {{ propriedade.nome_propriedade }}</p>
                </div>
                <div>
                    <a href="{% url 'endividamento_dashboard' propriedade.id %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-credit-card"></i> Dados do Financiamento
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="financiamentoForm">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                            <i class="bi bi-tag"></i> Tipo de Financiamento
                                        </label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.tipo.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.nome.id_for_label }}" class="form-label">
                                            <i class="bi bi-credit-card"></i> Nome do Financiamento
                                        </label>
                                        {{ form.nome }}
                                        {% if form.nome.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.nome.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                            <i class="bi bi-text-paragraph"></i> Descrição
                                        </label>
                                        {{ form.descricao }}
                                        {% if form.descricao.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.descricao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.valor_principal.id_for_label }}" class="form-label">
                                            <i class="bi bi-cash-stack"></i> Valor Principal (R$)
                                        </label>
                                        {{ form.valor_principal }}
                                        {% if form.valor_principal.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.valor_principal.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.taxa_juros_anual.id_for_label }}" class="form-label">
                                            <i class="bi bi-percent"></i> Taxa de Juros Anual (%)
                                        </label>
                                        {{ form.taxa_juros_anual }}
                                        {% if form.taxa_juros_anual.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.taxa_juros_anual.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tipo_taxa.id_for_label }}" class="form-label">
                                            <i class="bi bi-graph-up"></i> Tipo de Taxa
                                        </label>
                                        {{ form.tipo_taxa }}
                                        {% if form.tipo_taxa.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.tipo_taxa.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.numero_parcelas.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar3"></i> Número de Parcelas
                                        </label>
                                        {{ form.numero_parcelas }}
                                        {% if form.numero_parcelas.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.numero_parcelas.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_contratacao.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-check"></i> Data de Contratação
                                        </label>
                                        {{ form.data_contratacao }}
                                        {% if form.data_contratacao.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.data_contratacao.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_primeiro_vencimento.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-date"></i> Primeiro Vencimento
                                        </label>
                                        {{ form.data_primeiro_vencimento }}
                                        {% if form.data_primeiro_vencimento.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.data_primeiro_vencimento.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.data_ultimo_vencimento.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar-event"></i> Último Vencimento
                                        </label>
                                        {{ form.data_ultimo_vencimento }}
                                        {% if form.data_ultimo_vencimento.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.data_ultimo_vencimento.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.valor_parcela.id_for_label }}" class="form-label">
                                            <i class="bi bi-calculator"></i> Valor da Parcela (R$)
                                        </label>
                                        {{ form.valor_parcela }}
                                        {% if form.valor_parcela.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.valor_parcela.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="text-muted">Este valor será calculado automaticamente baseado nos dados acima</small>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'endividamento_dashboard' propriedade.id %}" class="btn btn-secondary">
                                        <i class="bi bi-x"></i> Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check"></i> Salvar Financiamento
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> Informações
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6>Como Preencher:</h6>
                            <ul class="small">
                                <li><strong>Valor Principal:</strong> Valor total do financiamento</li>
                                <li><strong>Taxa de Juros:</strong> Taxa anual (ex: 12.5 para 12,5%)</li>
                                <li><strong>Parcelas:</strong> Número total de parcelas</li>
                                <li><strong>Valor da Parcela:</strong> Calculado automaticamente</li>
                            </ul>
                            
                            <h6 class="mt-3">Tipos de Taxa:</h6>
                            <ul class="small">
                                <li><strong>Fixa:</strong> Taxa constante durante todo o período</li>
                                <li><strong>Variável:</strong> Taxa que pode variar</li>
                                <li><strong>Mista:</strong> Combinação de taxas</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-calculator"></i> Cálculo Automático
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="small">
                                <p><strong>Valor da Parcela:</strong></p>
                                <p>Será calculado automaticamente baseado no valor principal, taxa de juros e número de parcelas.</p>
                                
                                <p><strong>Último Vencimento:</strong></p>
                                <p>Será calculado baseado no primeiro vencimento e número de parcelas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function calcularParcelas() {
    const valorPrincipal = parseFloat(document.getElementById('{{ form.valor_principal.id_for_label }}').value) || 0;
    const taxaJuros = parseFloat(document.getElementById('{{ form.taxa_juros_anual.id_for_label }}').value) || 0;
    const numeroParcelas = parseInt(document.getElementById('{{ form.numero_parcelas.id_for_label }}').value) || 0;
    
    if (valorPrincipal > 0 && numeroParcelas > 0) {
        // Cálculo simplificado usando fórmula de juros compostos
        const taxaMensal = taxaJuros / 100 / 12;
        let valorParcela;
        
        if (taxaMensal > 0) {
            valorParcela = valorPrincipal * (taxaMensal * Math.pow(1 + taxaMensal, numeroParcelas)) / 
                          (Math.pow(1 + taxaMensal, numeroParcelas) - 1);
        } else {
            valorParcela = valorPrincipal / numeroParcelas;
        }
        
        document.getElementById('{{ form.valor_parcela.id_for_label }}').value = valorParcela.toFixed(2);
    }
}

function calcularDataFinal() {
    const dataPrimeiro = document.getElementById('{{ form.data_primeiro_vencimento.id_for_label }}').value;
    const numeroParcelas = parseInt(document.getElementById('{{ form.numero_parcelas.id_for_label }}').value) || 0;
    
    if (dataPrimeiro && numeroParcelas > 0) {
        const data = new Date(dataPrimeiro);
        data.setMonth(data.getMonth() + numeroParcelas - 1);
        
        const dataFinal = data.toISOString().split('T')[0];
        document.getElementById('{{ form.data_ultimo_vencimento.id_for_label }}').value = dataFinal;
    }
}

// Configurar data padrão de contratação para hoje
document.addEventListener('DOMContentLoaded', function() {
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('{{ form.data_contratacao.id_for_label }}').value = hoje;
});
</script>
{% endblock %}

