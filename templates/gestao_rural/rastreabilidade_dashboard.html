{% extends 'base_modulos_unificado.html' %}
{% load static %}
{% load formatacao_br %}

{% block title %}Dashboard - {{ propriedade.nome_propriedade }}{% endblock %}

{% block breadcrumb_extra %}
    <li class="breadcrumb-item active">
        <i class="bi bi-speedometer2"></i>
        Dashboard
    </li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<style>
    .dashboard-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        text-decoration: none;
        color: inherit;
    }
    
    .dashboard-card-body {
        padding: 24px;
        text-align: center;
    }
    
    .dashboard-card-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 2rem;
    }
    
    .dashboard-card-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #455a64;
        margin-bottom: 8px;
    }
    
    .dashboard-card-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .dashboard-card-primary .dashboard-card-icon {
        background: rgba(30, 136, 229, 0.1);
        color: #1e88e5;
    }
    
    .dashboard-card-primary .dashboard-card-value {
        color: #1e88e5;
    }
    
    .dashboard-card-success .dashboard-card-icon {
        background: rgba(76, 175, 80, 0.1);
        color: #4caf50;
    }
    
    .dashboard-card-success .dashboard-card-value {
        color: #4caf50;
    }
    
    .dashboard-card-info .dashboard-card-icon {
        background: rgba(3, 169, 244, 0.1);
        color: #03a9f4;
    }
    
    .dashboard-card-info .dashboard-card-value {
        color: #03a9f4;
    }
    
    .dashboard-card-warning .dashboard-card-icon {
        background: rgba(255, 152, 0, 0.1);
        color: #ff9800;
    }
    
    .dashboard-card-warning .dashboard-card-value {
        color: #ff9800;
    }
    
    /* Cards de Ações Rápidas */
    .acao-card {
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        height: 100%;
    }
    
    .acao-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        text-decoration: none;
        color: inherit;
        border-color: #1e88e5;
    }
    
    .acao-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 1.75rem;
    }
    
    .acao-card-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #37474f;
        margin: 0;
    }
    
    .acao-card-primary .acao-card-icon {
        background: rgba(30, 136, 229, 0.1);
        color: #1e88e5;
    }
    
    .acao-card-success .acao-card-icon {
        background: rgba(76, 175, 80, 0.1);
        color: #4caf50;
    }
    
    .acao-card-info .acao-card-icon {
        background: rgba(3, 169, 244, 0.1);
        color: #03a9f4;
    }
    
    .acao-card-secondary .acao-card-icon {
        background: rgba(158, 158, 158, 0.1);
        color: #9e9e9e;
    }
    
    .acao-card-dark .acao-card-icon {
        background: rgba(66, 66, 66, 0.1);
        color: #424242;
    }
    
    /* Tabelas melhoradas */
    .table-modern {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-modern thead th {
        background: #f5f5f5;
        color: #37474f;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 12px 16px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .table-modern tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }
    
    .table-modern tbody tr:hover {
        background: #f9f9f9;
    }
    
    .table-modern tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* Gráficos */
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header da Página -->
    <div class="submenu-page-header">
        <div class="d-flex align-items-start gap-4">
            <div class="submenu-page-icon">
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="flex-grow-1">
                <h1 class="submenu-page-title">Dashboard</h1>
                <p class="submenu-page-description">
                    Visão geral do sistema de rastreabilidade bovina - PNIB
                </p>
            </div>
        </div>
    </div>

    <!-- Cards de Estatísticas Principais (Clicáveis) -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <a href="{% url 'animais_individuais_lista' propriedade.id %}" class="dashboard-card dashboard-card-primary">
                <div class="dashboard-card-body">
                    <div class="dashboard-card-icon">
                        <i class="bi bi-cow"></i>
                    </div>
                    <div class="dashboard-card-title">Animais Ativos</div>
                    <h2 class="dashboard-card-value">{{ total_animais|numero_br:0 }}</h2>
                </div>
            </a>
        </div>
        
        <div class="col-md-3 mb-3">
            <a href="{% url 'brincos_lista' propriedade.id %}?status=DISPONIVEL" class="dashboard-card dashboard-card-success">
                <div class="dashboard-card-body">
                    <div class="dashboard-card-icon">
                        <i class="bi bi-tag"></i>
                    </div>
                    <div class="dashboard-card-title">Brincos Disponíveis</div>
                    <h2 class="dashboard-card-value">{{ brincos_disponiveis|numero_br:0 }}</h2>
                </div>
            </a>
        </div>
        
        <div class="col-md-3 mb-3">
            <a href="{% url 'brincos_lista' propriedade.id %}?status=EM_USO" class="dashboard-card dashboard-card-info">
                <div class="dashboard-card-body">
                    <div class="dashboard-card-icon">
                        <i class="bi bi-tag-fill"></i>
                    </div>
                    <div class="dashboard-card-title">Brincos em Uso</div>
                    <h2 class="dashboard-card-value">{{ brincos_em_uso|numero_br:0 }}</h2>
                </div>
            </a>
        </div>
        
        <div class="col-md-3 mb-3">
            <a href="{% url 'relatorio_rastreabilidade' propriedade.id %}" class="dashboard-card dashboard-card-warning">
                <div class="dashboard-card-body">
                    <div class="dashboard-card-icon">
                        <i class="bi bi-arrow-left-right"></i>
                    </div>
                    <div class="dashboard-card-title">Movimentações</div>
                    <h2 class="dashboard-card-value">{{ movimentacoes_recentes|length }}</h2>
                </div>
            </a>
        </div>
    </div>

    <!-- Ações Rápidas - Cards Organizados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-moderno">
                <div class="card-header-moderno">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning-charge"></i> Ações Rápidas
                    </h5>
                </div>
                <div class="card-body-moderno">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <a href="{% url 'animal_individual_novo' propriedade.id %}" class="acao-card acao-card-primary">
                                <div class="acao-card-icon">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <h6 class="acao-card-title">Novo Animal</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% url 'animais_individuais_lista' propriedade.id %}" class="acao-card acao-card-primary">
                                <div class="acao-card-icon">
                                    <i class="bi bi-list-ul"></i>
                                </div>
                                <h6 class="acao-card-title">Listar Animais</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% url 'brinco_cadastrar_lote' propriedade.id %}" class="acao-card acao-card-success">
                                <div class="acao-card-icon">
                                    <i class="bi bi-tags"></i>
                                </div>
                                <h6 class="acao-card-title">Cadastrar Brincos em Lote</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% url 'brincos_lista' propriedade.id %}" class="acao-card acao-card-info">
                                <div class="acao-card-icon">
                                    <i class="bi bi-tag"></i>
                                </div>
                                <h6 class="acao-card-title">Gerenciar Brincos</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% url 'relatorio_rastreabilidade' propriedade.id %}" class="acao-card acao-card-secondary">
                                <div class="acao-card-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <h6 class="acao-card-title">Relatório Completo</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% static 'checklists/checklist_in36.md' %}" class="acao-card acao-card-dark" download>
                                <div class="acao-card-icon">
                                    <i class="bi bi-clipboard-check"></i>
                                </div>
                                <h6 class="acao-card-title">Checklist IN 36/2006</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% static 'checklists/checklist_pncebt.md' %}" class="acao-card acao-card-dark" download>
                                <div class="acao-card-icon">
                                    <i class="bi bi-clipboard-pulse"></i>
                                </div>
                                <h6 class="acao-card-title">Checklist PNCEBT</h6>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="{% static 'checklists/checklist_bemestar_in17.md' %}" class="acao-card acao-card-dark" download>
                                <div class="acao-card-icon">
                                    <i class="bi bi-clipboard-heart"></i>
                                </div>
                                <h6 class="acao-card-title">Checklist Bem-Estar (IN 17)</h6>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Detalhadas com Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card-moderno">
                <div class="card-header-moderno">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart"></i> Animais por Categoria
                    </h5>
                </div>
                <div class="card-body-moderno">
                    {% if animais_por_categoria %}
                        <div class="table-responsive">
                            <table class="table table-modern">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th class="text-end">Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in animais_por_categoria %}
                                    <tr>
                                        <td>
                                            <i class="bi bi-circle-fill" style="color: #1e88e5; font-size: 0.5rem; margin-right: 8px;"></i>
                                            {{ item.categoria__nome }}
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-primary rounded-pill px-3 py-2">{{ item.total|numero_br:0 }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartCategoria"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0">Nenhum animal cadastrado ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Animais por Status -->
        <div class="col-md-6">
            <div class="card-moderno">
                <div class="card-header-moderno">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Animais por Status
                    </h5>
                </div>
                <div class="card-body-moderno">
                    {% if animais_por_status %}
                        <div class="table-responsive">
                            <table class="table table-modern">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th class="text-end">Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in animais_por_status %}
                                    <tr>
                                        <td>
                                            {% if item.status == 'ATIVO' %}
                                                <span class="badge bg-success rounded-pill px-3 py-2">{{ status_labels|dict_get:item.status }}</span>
                                            {% elif item.status == 'VENDIDO' %}
                                                <span class="badge bg-warning rounded-pill px-3 py-2">{{ status_labels|dict_get:item.status }}</span>
                                            {% elif item.status == 'MORTO' %}
                                                <span class="badge bg-danger rounded-pill px-3 py-2">{{ status_labels|dict_get:item.status }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary rounded-pill px-3 py-2">{{ status_labels|dict_get:item.status|default:item.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <strong>{{ item.total|numero_br:0 }}</strong>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartStatus"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0">Nenhum animal cadastrado ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Movimentações Recentes -->
    <div class="row">
        <div class="col-12">
            <div class="card-moderno">
                <div class="card-header-moderno">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Movimentações Recentes
                    </h5>
                </div>
                <div class="card-body-moderno">
                    {% if movimentacoes_recentes %}
                        <div class="table-responsive">
                            <table class="table table-modern table-hover">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Brinco</th>
                                        <th>Tipo</th>
                                        <th>Categoria</th>
                                        <th>Observações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mov in movimentacoes_recentes %}
                                    <tr>
                                        <td>
                                            <i class="bi bi-calendar3 me-2 text-muted"></i>
                                            <strong>{{ mov.data_movimentacao|date:"d/m/Y" }}</strong>
                                        </td>
                                        <td>
                                            <a href="{% url 'animal_individual_detalhes' propriedade.id mov.animal.id %}" class="text-decoration-none fw-bold text-primary">
                                                <i class="bi bi-tag me-1"></i>{{ mov.animal.numero_brinco }}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge bg-info rounded-pill px-3 py-2">
                                                <i class="bi bi-arrow-left-right me-1"></i>{{ mov.get_tipo_movimentacao_display }}
                                            </span>
                                            {% if mov.numero_documento or mov.data_documento %}
                                                <div class="text-muted small mt-1">
                                                    <i class="bi bi-file-earmark me-1"></i>
                                                    {{ mov.numero_documento|default:"Sem documento" }}
                                                    {% if mov.data_documento %}- {{ mov.data_documento|date:"d/m/Y" }}{% endif %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                {{ mov.animal.categoria.nome }}
                                            </span>
                                        </td>
                                        <td class="text-muted small">
                                            <i class="bi bi-chat-left-text me-1"></i>
                                            {{ mov.observacoes|truncatewords:10|default:"-" }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'relatorio_rastreabilidade' propriedade.id %}" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-right-circle me-2"></i>Ver Todas as Movimentações
                            </a>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0 py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            Nenhuma movimentação registrada ainda.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Animais por Categoria
    {% if animais_por_categoria %}
    const ctxCategoria = document.getElementById('chartCategoria');
    if (ctxCategoria) {
        const categorias = [
            {% for item in animais_por_categoria %}
            '{{ item.categoria__nome }}',
            {% endfor %}
        ];
        const quantidades = [
            {% for item in animais_por_categoria %}
            {{ item.total }},
            {% endfor %}
        ];
        
        new Chart(ctxCategoria, {
            type: 'doughnut',
            data: {
                labels: categorias,
                datasets: [{
                    data: quantidades,
                    backgroundColor: [
                        '#1e88e5',
                        '#4caf50',
                        '#ff9800',
                        '#9c27b0',
                        '#f44336',
                        '#00bcd4',
                        '#ffeb3b',
                        '#795548'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Gráfico de Animais por Status
    {% if animais_por_status %}
    const ctxStatus = document.getElementById('chartStatus');
    if (ctxStatus) {
        const status = [
            {% for item in animais_por_status %}
            '{{ status_labels|dict_get:item.status|default:item.status }}',
            {% endfor %}
        ];
        const quantidades = [
            {% for item in animais_por_status %}
            {{ item.total }},
            {% endfor %}
        ];
        const cores = [
            {% for item in animais_por_status %}
            {% if item.status == 'ATIVO' %}'#4caf50'
            {% elif item.status == 'VENDIDO' %}'#ff9800'
            {% elif item.status == 'MORTO' %}'#f44336'
            {% else %}'#9e9e9e'
            {% endif %}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        new Chart(ctxStatus, {
            type: 'bar',
            data: {
                labels: status,
                datasets: [{
                    label: 'Quantidade',
                    data: quantidades,
                    backgroundColor: cores,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
