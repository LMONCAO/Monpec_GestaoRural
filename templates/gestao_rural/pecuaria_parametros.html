{% extends 'base.html' %}

{% block title %}Parâmetros - {{ propriedade.nome_propriedade }}{% endblock %}

{% block page_title %}Parâmetros de Projeção{% endblock %}

{% block content %}
<div class="container-fluid py-4">
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                    <h2 class="text-primary mb-2">
                        <i class="bi bi-gear-fill"></i> Parâmetros de Projeção
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="bi bi-house"></i> Propriedade: <strong>{{ propriedade.nome_propriedade }}</strong>
                    </p>
            </div>
                <a href="{% url 'pecuaria_dashboard' propriedade.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>
        
        <!-- Informações do Tipo de Ciclo -->
        {% if propriedade.tipo_ciclo_pecuario %}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i> Tipo de Ciclo Pecuário: {{ propriedade.get_tipo_ciclo_pecuario_display }}
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info border-0">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>Parâmetros específicos para {{ propriedade.get_tipo_ciclo_pecuario_display }}:</strong>
                    {% if propriedade.tipo_ciclo_pecuario == 'CRIA' %}
                        Foco na reprodução e criação de bezerros. Taxa de natalidade alta, baixa mortalidade, sem vendas.
                    {% elif propriedade.tipo_ciclo_pecuario == 'RECRIA' %}
                        Foco no desenvolvimento de animais jovens. Sem reprodução, baixa mortalidade, sem vendas.
                    {% elif propriedade.tipo_ciclo_pecuario == 'ENGORDA' %}
                        Foco na terminação e venda de animais. Sem reprodução, baixa mortalidade, alta taxa de vendas.
                    {% elif propriedade.tipo_ciclo_pecuario == 'CICLO_COMPLETO' %}
                        Sistema completo: cria, recria e engorda. Taxa de natalidade alta, vendas moderadas.
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="alert alert-info border-0 shadow-sm">
            <i class="bi bi-info-circle-fill"></i>
            <strong>Instruções:</strong> Configure as taxas anuais que serão utilizadas para calcular as projeções do rebanho. 
            Os valores devem ser inseridos em percentual (ex: 15.5 para 15,5%).
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-sliders"></i> Configurar Parâmetros Básicos
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row g-4">
                        <!-- Taxa de Natalidade -->
                        <div class="col-lg-6">
                            <label for="{{ form.taxa_natalidade_anual.id_for_label }}" class="form-label">
                                <i class="bi bi-heart-pulse"></i> {{ form.taxa_natalidade_anual.label }}
                            </label>
                            <div class="input-group input-group-lg">
                                    {{ form.taxa_natalidade_anual }}
                                <span class="input-group-text bg-secondary text-white fw-bold">%</span>
                            </div>
                            {% if form.taxa_natalidade_anual.errors %}
                                <div class="text-danger mt-1">{{ form.taxa_natalidade_anual.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Taxa de natalidade anual do rebanho
                            </small>
                        </div>
                        
                        <!-- Taxa de Mortalidade de Bezerros -->
                        <div class="col-lg-6">
                            <label for="{{ form.taxa_mortalidade_bezerros_anual.id_for_label }}" class="form-label">
                                <i class="bi bi-exclamation-triangle"></i> {{ form.taxa_mortalidade_bezerros_anual.label }}
                            </label>
                            <div class="input-group input-group-lg">
                                    {{ form.taxa_mortalidade_bezerros_anual }}
                                <span class="input-group-text bg-secondary text-white fw-bold">%</span>
                            </div>
                            {% if form.taxa_mortalidade_bezerros_anual.errors %}
                                <div class="text-danger mt-1">{{ form.taxa_mortalidade_bezerros_anual.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Taxa de mortalidade anual de bezerros
                            </small>
                        </div>
                    </div>
                    
                    <div class="row g-4 mt-2">
                        <!-- Taxa de Mortalidade de Adultos -->
                        <div class="col-lg-6">
                            <label for="{{ form.taxa_mortalidade_adultos_anual.id_for_label }}" class="form-label">
                                <i class="bi bi-exclamation-triangle-fill"></i> {{ form.taxa_mortalidade_adultos_anual.label }}
                            </label>
                            <div class="input-group input-group-lg">
                                    {{ form.taxa_mortalidade_adultos_anual }}
                                <span class="input-group-text bg-secondary text-white fw-bold">%</span>
                            </div>
                            {% if form.taxa_mortalidade_adultos_anual.errors %}
                                <div class="text-danger mt-1">{{ form.taxa_mortalidade_adultos_anual.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Taxa de mortalidade anual de animais adultos
                            </small>
                        </div>
                        
                        <!-- Periodicidade -->
                        <div class="col-lg-6">
                            <label for="{{ form.periodicidade.id_for_label }}" class="form-label">
                                <i class="bi bi-clock"></i> {{ form.periodicidade.label }}
                                </label>
                            {{ form.periodicidade }}
                            {% if form.periodicidade.errors %}
                                <div class="text-danger mt-1">{{ form.periodicidade.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Frequência de cálculo das projeções
                            </small>
                        </div>
                    </div>
                    
                    
                    
                    <!-- Vendas por Categoria -->
                    <div class="row mb-4 mt-5">
                        <div class="col-12">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-secondary text-white rounded-circle p-2 me-3">
                                    <i class="bi bi-percent"></i>
                                </div>
                                <h5 class="text-secondary mb-0">Vendas por Categoria</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-0">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Vendas por Categoria:</strong> Configure vendas específicas para cada categoria de animal. 
                        Isso permite um controle mais detalhado do que os percentuais gerais por sexo.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label for="categoria_venda_especifica" class="form-label fw-bold">
                                <i class="bi bi-tag"></i> Categoria para Venda
                            </label>
                            <select class="form-select form-select-lg" id="categoria_venda_especifica" name="categoria_venda_especifica">
                                <option value="">Selecione a categoria</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="percentual_venda_categoria" class="form-label fw-bold">
                                <i class="bi bi-percent"></i> Percentual Anual
                            </label>
                            <div class="input-group input-group-lg">
                                <input type="number" class="form-control" id="percentual_venda_categoria" name="percentual_venda_categoria" 
                                       min="0" max="100" step="0.01" placeholder="Ex: 15.5">
                                <span class="input-group-text bg-primary text-white fw-bold">%</span>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="frequencia_venda_categoria" class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Frequência
                            </label>
                            <select class="form-select form-select-lg" id="frequencia_venda_categoria" name="frequencia_venda_categoria">
                                <option value="">Selecione a frequência</option>
                                <option value="MENSAL">Mensal</option>
                                <option value="BIMESTRAL">Bimestral</option>
                                <option value="TRIMESTRAL">Trimestral</option>
                                <option value="SEMESTRAL">Semestral</option>
                                <option value="ANUAL">Anual</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="quantidade_venda_categoria" class="form-label fw-bold">
                                <i class="bi bi-hash"></i> Quantidade
                            </label>
                            <input type="number" class="form-control form-control-lg" id="quantidade_venda_categoria" name="quantidade_venda_categoria" 
                                   min="1" step="1" placeholder="Ex: 50" onchange="calcularVenda()">
                        </div>
                    </div>
                    
                    <!-- Card com informações do inventário e cálculo -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-sm border-0" id="card-inventario" style="display: none;">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-calculator-fill"></i> Cálculo de Venda Anual
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-lg-3 col-md-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <h4 class="text-secondary mb-2" id="saldo-inventario">0</h4>
                                                <small class="text-muted fw-bold">
                                                    <i class="bi bi-box"></i> Inventário
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <h4 class="text-secondary mb-2" id="percentual-venda">0%</h4>
                                                <small class="text-muted fw-bold">
                                                    <i class="bi bi-percent"></i> Percentual Anual
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <h4 class="text-secondary mb-2" id="frequencia-venda">-</h4>
                                                <small class="text-muted fw-bold">
                                                    <i class="bi bi-calendar"></i> Frequência
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="text-center p-3 bg-light rounded">
                                                <h4 class="text-secondary mb-2" id="resultado-anual">0</h4>
                                                <small class="text-muted fw-bold">
                                                    <i class="bi bi-hash"></i> Quantidade por Venda
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-4">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-info border-0 mb-0" id="mensagem-calculo">
                                                <i class="bi bi-info-circle-fill"></i>
                                                <strong>Selecione uma categoria</strong> para ver o cálculo de venda anual.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botão Gravar -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn btn-secondary btn-lg px-4" onclick="gravarVendaCategoria()">
                                    <i class="bi bi-check-circle-fill"></i> Gravar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Vendas por Categoria -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i> Vendas Configuradas por Categoria
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="tabelaVendasCategoria">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th class="fw-bold">
                                                        <i class="bi bi-tag"></i> Categoria
                                                    </th>
                                                    <th class="fw-bold">
                                                        <i class="bi bi-percent"></i> Percentual
                                                    </th>
                                                    <th class="fw-bold">
                                                        <i class="bi bi-calendar"></i> Frequência
                                                    </th>
                                                    <th class="fw-bold">
                                                        <i class="bi bi-hash"></i> Quantidade
                                                    </th>
                                                    <th class="fw-bold text-center">
                                                        <i class="bi bi-gear"></i> Ações
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dados serão carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transferências entre Propriedades -->
                    <div class="row mb-4 mt-5">
                        <div class="col-12">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-secondary text-white rounded-circle p-2 me-3">
                                    <i class="bi bi-arrow-left-right"></i>
                                </div>
                                <h5 class="text-secondary mb-0">Transferências entre Propriedades</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning border-0">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Transferências:</strong> Configure transferências de animais entre propriedades. 
                        Isso permite reposição de estoque e otimização do rebanho.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label for="categoria_transferencia" class="form-label fw-bold">
                                <i class="bi bi-tag"></i> Categoria
                            </label>
                            <select class="form-select form-select-lg" id="categoria_transferencia" name="categoria_transferencia">
                                <option value="">Selecione a categoria</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="fazenda_origem_transferencia" class="form-label fw-bold">
                                <i class="bi bi-house"></i> Fazenda de Origem
                            </label>
                            <select class="form-select form-select-lg" id="fazenda_origem_transferencia" name="fazenda_origem_transferencia">
                                <option value="">Selecione a fazenda</option>
                                {% for fazenda in outras_fazendas %}
                                <option value="{{ fazenda.id }}">{{ fazenda.nome_propriedade }}</option>
                                {% empty %}
                                <option value="">Nenhuma fazenda encontrada</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="frequencia_transferencia" class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Frequência
                            </label>
                            <select class="form-select form-select-lg" id="frequencia_transferencia" name="frequencia_transferencia">
                                <option value="">Selecione a frequência</option>
                                <option value="MENSAL">Mensal</option>
                                <option value="BIMESTRAL">Bimestral</option>
                                <option value="TRIMESTRAL">Trimestral</option>
                                <option value="SEMESTRAL">Semestral</option>
                                <option value="ANUAL">Anual</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="quantidade_transferencia" class="form-label fw-bold">
                                <i class="bi bi-hash"></i> Quantidade
                            </label>
                            <input type="number" class="form-control form-control-lg" id="quantidade_transferencia" name="quantidade_transferencia" 
                                   min="1" step="1" placeholder="Ex: 50" onchange="calcularTransferencia()">
                        </div>
                    </div>
                    
                    <!-- Card com informações da transferência e cálculo -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card" id="card-transferencia" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-calculator"></i> Cálculo de Transferência
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-primary" id="saldo-origem">0</h5>
                                                <small class="text-muted">Saldo Origem</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-warning" id="fazenda-origem-nome">-</h5>
                                                <small class="text-muted">Fazenda Origem</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-info" id="frequencia-transferencia">-</h5>
                                                <small class="text-muted">Frequência</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-success" id="quantidade-transferencia">0</h5>
                                                <small class="text-muted">Quantidade</small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-info mb-0" id="mensagem-transferencia">
                                                <i class="bi bi-info-circle"></i>
                                                <strong>Selecione uma categoria e fazenda</strong> para ver o cálculo de transferência.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botão Gravar Transferência -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-secondary" onclick="gravarTransferencia()">
                                    <i class="bi bi-check-circle"></i> Gravar Transferência
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Transferências -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i> Transferências Configuradas
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0" id="tabelaTransferencias">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Fazenda Origem</th>
                                                    <th>Frequência</th>
                                                    <th>Quantidade</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dados serão carregados via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compras de Animais -->
                    <div class="row mb-4 mt-5">
                        <div class="col-12">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-secondary text-white rounded-circle p-2 me-3">
                                    <i class="bi bi-cart-plus"></i>
                                </div>
                                <h5 class="text-secondary mb-0">Compras de Animais</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success border-0">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Compras:</strong> Configure compras de animais para reposição do rebanho. 
                        Isso permite planejamento de investimentos e controle de custos.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label for="categoria_compra" class="form-label fw-bold">
                                <i class="bi bi-tag"></i> Categoria
                            </label>
                            <select class="form-select form-select-lg" id="categoria_compra" name="categoria_compra">
                                <option value="">Selecione a categoria</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="frequencia_compra" class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Frequência
                            </label>
                            <select class="form-select form-select-lg" id="frequencia_compra" name="frequencia_compra">
                                <option value="">Selecione a frequência</option>
                                <option value="MENSAL">Mensal</option>
                                <option value="BIMESTRAL">Bimestral</option>
                                <option value="TRIMESTRAL">Trimestral</option>
                                <option value="SEMESTRAL">Semestral</option>
                                <option value="ANUAL">Anual</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="quantidade_compra" class="form-label fw-bold">
                                <i class="bi bi-hash"></i> Quantidade
                            </label>
                            <input type="number" class="form-control form-control-lg" id="quantidade_compra" name="quantidade_compra" 
                                   min="1" step="1" placeholder="Ex: 50" onchange="calcularCompra()">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="valor_unitario_compra" class="form-label fw-bold">
                                <i class="bi bi-currency-dollar"></i> Valor Unitário
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-success text-white fw-bold">R$</span>
                            <input type="number" class="form-control" id="valor_unitario_compra" name="valor_unitario_compra" 
                                   min="0" step="0.01" placeholder="Ex: 5000.00" onchange="calcularCompra()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card com informações da compra e cálculo -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card" id="card-compra" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-calculator"></i> Cálculo de Compra
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-primary" id="quantidade-compra">0</h5>
                                                <small class="text-muted">Quantidade</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-warning" id="frequencia-compra">-</h5>
                                                <small class="text-muted">Frequência</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-info" id="valor-unitario-compra">R$ 0,00</h5>
                                                <small class="text-muted">Valor Unitário</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h5 class="text-success" id="valor-total-compra">R$ 0,00</h5>
                                                <small class="text-muted">Valor Total</small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-info mb-0" id="mensagem-compra">
                                                <i class="bi bi-info-circle"></i>
                                                <strong>Selecione uma categoria</strong> para ver o cálculo de compra.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botão Gravar Compra -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-secondary" onclick="gravarCompra()">
                                    <i class="bi bi-check-circle"></i> Gravar Compra
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Compras -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i> Compras Configuradas
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0" id="tabelaCompras">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Frequência</th>
                                                    <th>Quantidade</th>
                                                    <th>Valor Unitário</th>
                                                    <th>Valor Total</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Debug: {{ compras_configuradas|length }} compras encontradas -->
                                                {% for compra in compras_configuradas %}
                                                <tr>
                                                    <td>{{ compra.categoria_compra.nome }}</td>
                                                    <td>{{ compra.get_frequencia_venda_display }}</td>
                                                    <td>{{ compra.quantidade_compra }}</td>
                                                    <td>R$ {{ compra.valor_animal_compra|floatformat:2 }}</td>
                                                    <td>R$ <span class="valor-total-calculado" data-valor="{{ compra.valor_animal_compra }}" data-quantidade="{{ compra.quantidade_compra }}">0,00</span></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary me-1" onclick="editarCompraTabela(this)">
                                                            <i class="bi bi-pencil"></i> Editar
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="removerCompraTabela(this)">
                                                            <i class="bi bi-trash"></i> Remover
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">
                                                        Nenhuma compra configurada
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção de Vendas -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-cart-dash"></i> Vendas de Animais
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Vendas:</strong> Configure vendas de animais para planejamento de receitas. Isso permite controle de fluxo de caixa e projeção de vendas.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-diamond"></i> Categoria
                                                </label>
                                                <select class="form-select" id="categoria_venda" name="categoria_venda">
                                                    <option value="">Selecione a categoria</option>
                                                    {% for categoria in categorias %}
                                                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-calendar"></i> Frequência
                                                </label>
                                                <select class="form-select" id="frequencia_venda" name="frequencia_venda">
                                                    <option value="">Selecione a frequência</option>
                                                    <option value="MENSAL">Mensal</option>
                                                    <option value="BIMESTRAL">Bimestral</option>
                                                    <option value="TRIMESTRAL">Trimestral</option>
                                                    <option value="SEMESTRAL">Semestral</option>
                                                    <option value="ANUAL">Anual</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-hash"></i> Quantidade
                                                </label>
                                                <input type="number" class="form-control" id="quantidade_venda" name="quantidade_venda" placeholder="Ex: 10">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-currency-dollar"></i> Valor Unitário
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="number" class="form-control" id="valor_unitario_venda" name="valor_unitario_venda" step="0.01" placeholder="Ex: 4500.00">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="bi bi-calculator"></i> Cálculo de Venda
                                                    </h6>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <small class="text-muted">Quantidade:</small>
                                                            <div class="fw-bold" id="calc_quantidade_venda">0</div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <small class="text-muted">Valor Unitário:</small>
                                                            <div class="fw-bold" id="calc_valor_unitario_venda">R$ 0,00</div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <small class="text-muted">Valor Total:</small>
                                                            <div class="fw-bold text-success" id="calc_valor_total_venda">R$ 0,00</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-warning" onclick="gravarVenda()">
                                            <i class="bi bi-check-circle"></i> Gravar Venda
                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Vendas Configuradas -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i> Vendas Configuradas
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0" id="tabelaVendas">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Frequência</th>
                                                    <th>Quantidade</th>
                                                    <th>Valor Unitário</th>
                                                    <th>Valor Total</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for venda in vendas_configuradas %}
                                                <tr>
                                                    <td>{{ venda.categoria_venda.nome }}</td>
                                                    <td>{{ venda.get_frequencia_venda_display }}</td>
                                                    <td>{{ venda.quantidade_venda }}</td>
                                                    <td>R$ {{ venda.valor_animal_venda|floatformat:2 }}</td>
                                                    <td>R$ <span class="valor-total-calculado" data-valor="{{ venda.valor_animal_venda }}" data-quantidade="{{ venda.quantidade_venda }}">0,00</span></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary me-1" onclick="editarVendaTabela(this)">
                                                            <i class="bi bi-pencil"></i> Editar
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="removerVendaTabela(this)">
                                                            <i class="bi bi-trash"></i> Remover
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">
                                                        Nenhuma venda configurada
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção de Transferências -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-arrow-left-right"></i> Transferências de Animais
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Transferências:</strong> Configure transferências entre fazendas para planejamento de movimentação do rebanho. Isso permite controle de estoque entre propriedades.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-diamond"></i> Categoria
                                                </label>
                                                <select class="form-select" id="categoria_transferencia" name="categoria_transferencia">
                                                    <option value="">Selecione a categoria</option>
                                                    {% for categoria in categorias %}
                                                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-calendar"></i> Frequência
                                                </label>
                                                <select class="form-select" id="frequencia_transferencia" name="frequencia_transferencia">
                                                    <option value="">Selecione a frequência</option>
                                                    <option value="MENSAL">Mensal</option>
                                                    <option value="BIMESTRAL">Bimestral</option>
                                                    <option value="TRIMESTRAL">Trimestral</option>
                                                    <option value="SEMESTRAL">Semestral</option>
                                                    <option value="ANUAL">Anual</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-hash"></i> Quantidade
                                                </label>
                                                <input type="number" class="form-control" id="quantidade_transferencia" name="quantidade_transferencia" placeholder="Ex: 5">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-building"></i> Fazenda Destino
                                                </label>
                                                <select class="form-select" id="fazenda_destino" name="fazenda_destino">
                                                    <option value="">Selecione a fazenda</option>
                                                    {% for fazenda in outras_fazendas %}
                                                    <option value="{{ fazenda.id }}">{{ fazenda.nome_propriedade }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-info" onclick="gravarTransferencia()">
                                            <i class="bi bi-check-circle"></i> Gravar Transferência
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Transferências Configuradas -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i> Transferências Configuradas
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0" id="tabelaTransferencias">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Frequência</th>
                                                    <th>Quantidade</th>
                                                    <th>Fazenda Destino</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for transferencia in transferencias_configuradas %}
                                                <tr>
                                                    <td>{{ transferencia.categoria_venda.nome }}</td>
                                                    <td>{{ transferencia.get_frequencia_venda_display }}</td>
                                                    <td>{{ transferencia.quantidade_venda }}</td>
                                                    <td>{{ transferencia.fazenda_destino.nome_propriedade }}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary me-1" onclick="editarTransferenciaTabela(this)">
                                                            <i class="bi bi-pencil"></i> Editar
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="removerTransferenciaTabela(this)">
                                                            <i class="bi bi-trash"></i> Remover
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">
                                                        Nenhuma transferência configurada
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Assistente de Configuração Automática -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-robot"></i> Assistente de Configuração Inteligente
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-lightbulb"></i>
                                        <strong>IA Adaptativa:</strong> O sistema detecta automaticamente o perfil da sua propriedade e configura os parâmetros ideais para maximizar seus resultados.
                                    </div>
                                    
                                    <!-- Questionário de Perfil Inteligente -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card border-primary">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-robot"></i> Questionário de Perfil Inteligente
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-graph-up-arrow"></i> Qual é sua prioridade principal?
                                                                </label>
                                                                <select class="form-select" id="prioridade_principal">
                                                                    <option value="crescimento">Crescimento do rebanho</option>
                                                                    <option value="receita">Receita máxima</option>
                                                                    <option value="equilibrio">Equilíbrio entre crescimento e receita</option>
                                                                    <option value="qualidade">Qualidade dos animais</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-currency-dollar"></i> Qual sua meta de receita anual?
                                                                </label>
                                                                <select class="form-select" id="meta_receita">
                                                                    <option value="baixa">Até R$ 500.000</option>
                                                                    <option value="media">R$ 500.000 - R$ 2.000.000</option>
                                                                    <option value="alta">R$ 2.000.000 - R$ 10.000.000</option>
                                                                    <option value="muito_alta">Acima de R$ 10.000.000</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-shield-check"></i> Qual seu perfil de risco?
                                                                </label>
                                                                <select class="form-select" id="perfil_risco">
                                                                    <option value="conservador">Conservador (baixo risco)</option>
                                                                    <option value="moderado">Moderado (risco médio)</option>
                                                                    <option value="agressivo">Agressivo (alto risco, alta recompensa)</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-calendar-range"></i> Horizonte de planejamento
                                                                </label>
                                                                <select class="form-select" id="horizonte_planejamento">
                                                                    <option value="curto">1-2 anos (curto prazo)</option>
                                                                    <option value="medio">3-5 anos (médio prazo)</option>
                                                                    <option value="longo">5+ anos (longo prazo)</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-geo-alt"></i> Tipo de propriedade
                                                                </label>
                                                                <select class="form-select" id="tipo_propriedade">
                                                                    <option value="familiar">Propriedade familiar (até 500 animais)</option>
                                                                    <option value="comercial">Propriedade comercial (500-2000 animais)</option>
                                                                    <option value="industrial">Propriedade industrial (2000+ animais)</option>
                                                                    <option value="premium">Propriedade premium (foco em qualidade)</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-center">
                                                        <button type="button" class="btn btn-primary btn-lg" onclick="detectarPerfilEConfigurar()">
                                                            <i class="bi bi-magic"></i> Detectar Perfil e Configurar Automaticamente
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-graph-up"></i> Taxa de Crescimento Geral
                                                </label>
                                                <select class="form-select" id="taxa_crescimento">
                                                    <option value="10">10% ao ano (Conservador)</option>
                                                    <option value="15" selected>15% ao ano (Moderado)</option>
                                                    <option value="20">20% ao ano (Agressivo)</option>
                                                    <option value="25">25% ao ano (Muito Agressivo)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-gender-female text-pink"></i> Crescimento de Vacas
                                                </label>
                                                <select class="form-select" id="crescimento_vacas">
                                                    <option value="5">5% ao ano (Conservador)</option>
                                                    <option value="10" selected>10% ao ano (Moderado)</option>
                                                    <option value="15">15% ao ano (Agressivo)</option>
                                                    <option value="20">20% ao ano (Muito Agressivo)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-currency-dollar"></i> Receita Mensal Mínima
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="number" class="form-control" id="receita_minima" value="50000" step="1000">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-calendar"></i> Período de Análise
                                                </label>
                                                <select class="form-select" id="periodo_analise">
                                                    <option value="12">12 meses</option>
                                                    <option value="24" selected>24 meses</option>
                                                    <option value="36">36 meses</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Configurações Específicas para Vacas -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="card bg-light">
                                                <div class="card-header bg-pink text-white">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-gender-female"></i> Estratégia de Crescimento de Vacas
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-arrow-up-circle"></i> Novas Vacas por Mês
                                                                </label>
                                                                <input type="number" class="form-control" id="novas_vacas_mes" value="2" min="1" max="20">
                                                                <small class="text-muted">Quantidade de vacas para comprar/transferir mensalmente</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-arrow-down-circle"></i> Vendas de Vacas por Mês
                                                                </label>
                                                                <input type="number" class="form-control" id="vendas_vacas_mes" value="1" min="0" max="10">
                                                                <small class="text-muted">Quantidade de vacas para vender mensalmente</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label class="form-label fw-bold">
                                                                    <i class="bi bi-currency-dollar"></i> Preço Médio da Vaca
                                                                </label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text">R$</span>
                                                                    <input type="number" class="form-control" id="preco_vaca" value="3500" step="100">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="alert alert-info">
                                                        <i class="bi bi-lightbulb"></i>
                                                        <strong>Dica:</strong> Para crescimento sustentável, mantenha mais compras que vendas de vacas. 
                                                        O sistema calculará automaticamente o equilíbrio ideal.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-center gap-3">
                                                <button type="button" class="btn btn-success btn-lg" onclick="configurarAutomaticamente()">
                                                    <i class="bi bi-magic"></i> Configurar Automaticamente
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-lg" onclick="mostrarCalculos()">
                                                    <i class="bi bi-calculator"></i> Ver Cálculos
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Resultado da Configuração Automática -->
                                    <div id="resultado-configuracao" class="mt-4" style="display: none;">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="bi bi-check-circle text-success"></i> Configuração Calculada
                                                </h6>
                                                <div id="detalhes-configuracao"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3 mt-5">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-check-circle-fill"></i> Salvar Parâmetros
                        </button>
                        <a href="{% url 'pecuaria_dashboard' propriedade.id %}" class="btn btn-outline-secondary btn-lg px-4">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Parâmetros Atuais -->
        {% if parametros %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Parâmetros Configurados</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Taxa de Natalidade:</strong> {{ parametros.taxa_natalidade_anual }}%</p>
                        <p><strong>Mortalidade Bezerros:</strong> {{ parametros.taxa_mortalidade_bezerros_anual }}%</p>
                        <p><strong>Mortalidade Adultos:</strong> {{ parametros.taxa_mortalidade_adultos_anual }}%</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Venda Machos:</strong> {{ parametros.percentual_venda_machos_anual }}%</p>
                        <p><strong>Venda Fêmeas:</strong> {{ parametros.percentual_venda_femeas_anual }}%</p>
                        <p><strong>Periodicidade:</strong> {{ parametros.get_periodicidade_display }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>


<script>

// Gravar venda por categoria
function gravarVendaCategoria() {
    const categoria = document.getElementById('categoria_venda_especifica');
    const percentual = document.getElementById('percentual_venda_categoria');
    const frequencia = document.getElementById('frequencia_venda_categoria');
    const quantidade = document.getElementById('quantidade_venda_categoria');
    
    if (!categoria.value) {
        alert('Selecione uma categoria para venda');
        return;
    }
    
    if (!percentual.value || percentual.value <= 0) {
        alert('Informe um percentual válido para venda');
        return;
    }
    
    if (!frequencia.value) {
        alert('Selecione uma frequência para venda');
        return;
    }
    
    if (!quantidade.value || quantidade.value <= 0) {
        alert('Informe uma quantidade válida para venda');
        return;
    }
    
    // Criar form data
    const formData = new FormData();
    formData.append('categoria', categoria.value);
    formData.append('percentual_venda_anual', percentual.value);
    formData.append('frequencia_venda', frequencia.value);
    formData.append('quantidade_venda', quantidade.value);
    formData.append('gravar_venda_categoria', 'true');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Enviar via fetch
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Venda por categoria salva com sucesso!');
            
            // Adicionar à tabela
            adicionarVendaTabela(
                categoria.options[categoria.selectedIndex].text, 
                percentual.value,
                frequencia.options[frequencia.selectedIndex].text,
                quantidade.value
            );
            
            // Limpar campos
            categoria.value = '';
            percentual.value = '';
            frequencia.value = '';
            quantidade.value = '';
        } else {
            alert('Erro ao salvar venda por categoria');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar venda por categoria');
    });
}

// Adicionar venda à tabela
function adicionarVendaTabela(categoriaNome, percentual, frequenciaNome, quantidade) {
    const tabela = document.getElementById('tabelaVendasCategoria');
    const tbody = tabela.querySelector('tbody');
    
    // Criar nova linha
    const novaLinha = document.createElement('tr');
    novaLinha.innerHTML = `
        <td>${categoriaNome}</td>
        <td>${percentual}%</td>
        <td>${frequenciaNome}</td>
        <td>${quantidade}</td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="removerVendaTabela(this)">
                <i class="bi bi-trash"></i> Remover
            </button>
        </td>
    `;
    
    // Adicionar à tabela
    tbody.appendChild(novaLinha);
}

// Remover venda da tabela
function removerVendaTabela(botao) {
    if (confirm('Deseja realmente remover esta venda por categoria?')) {
        const linha = botao.closest('tr');
        linha.remove();
    }
}

// Variáveis globais para armazenar dados
let saldoInventario = 0;
let categoriaSelecionada = '';

// Carregar saldo do inventário
function carregarSaldoInventario() {
    const categoria = document.getElementById('categoria_venda_especifica');
    const cardInventario = document.getElementById('card-inventario');
    
    if (!categoria.value) {
        cardInventario.style.display = 'none';
        return;
    }
    
    categoriaSelecionada = categoria.options[categoria.selectedIndex].text;
    
    // Mostrar card
    cardInventario.style.display = 'block';
    
    // Mostrar loading
    document.getElementById('mensagem-calculo').innerHTML = `
        <i class="bi bi-hourglass-split"></i>
        <strong>Carregando saldo...</strong> Buscando informações do inventário.
    `;
    
    // Buscar saldo via AJAX
    fetch(`/propriedade/{{ propriedade.id }}/inventario/saldo/${categoria.value}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            saldoInventario = data.quantidade;
            
            // Atualizar card com dados
            document.getElementById('saldo-inventario').textContent = saldoInventario;
            document.getElementById('percentual-venda').textContent = '0%';
            document.getElementById('frequencia-venda').textContent = '-';
            document.getElementById('resultado-anual').textContent = '0';
            
            // Atualizar mensagem
            document.getElementById('mensagem-calculo').innerHTML = `
                <i class="bi bi-check-circle text-success"></i>
                <strong>Inventário carregado:</strong> ${saldoInventario} animais disponíveis. 
                <strong>Preencha o percentual e frequência</strong> para calcular a venda anual.
            `;
            
            // Calcular se já tem percentual e frequência
            calcularVenda();
        } else {
            document.getElementById('mensagem-calculo').innerHTML = `
                <i class="bi bi-exclamation-triangle text-warning"></i>
                <strong>Erro:</strong> ${data.message || 'Não foi possível carregar o saldo do inventário'}
            `;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        document.getElementById('mensagem-calculo').innerHTML = `
            <i class="bi bi-x-circle text-danger"></i>
            <strong>Erro:</strong> Não foi possível conectar ao servidor
        `;
    });
}

// Calcular venda anual
function calcularVenda() {
    const percentual = document.getElementById('percentual_venda_categoria').value;
    const frequencia = document.getElementById('frequencia_venda_categoria').value;
    const percentualNum = parseFloat(percentual) || 0;
    
    if (saldoInventario > 0 && percentualNum > 0 && frequencia) {
        // Calcular quantas vezes por ano baseado na frequência
        let vezesPorAno = 1;
        let frequenciaTexto = '';
        
        switch(frequencia) {
            case 'MENSAL':
                vezesPorAno = 12;
                frequenciaTexto = 'Mensal (12x/ano)';
                break;
            case 'BIMESTRAL':
                vezesPorAno = 6;
                frequenciaTexto = 'Bimestral (6x/ano)';
                break;
            case 'TRIMESTRAL':
                vezesPorAno = 4;
                frequenciaTexto = 'Trimestral (4x/ano)';
                break;
            case 'SEMESTRAL':
                vezesPorAno = 2;
                frequenciaTexto = 'Semestral (2x/ano)';
                break;
            case 'ANUAL':
                vezesPorAno = 1;
                frequenciaTexto = 'Anual (1x/ano)';
                break;
        }
        
        // Calcular quantidade por venda (não por ano)
        const quantidadePorVenda = Math.round((saldoInventario * percentualNum / 100));
        const resultadoAnual = quantidadePorVenda * vezesPorAno;
        
        // Atualizar valores no card
        document.getElementById('saldo-inventario').textContent = saldoInventario;
        document.getElementById('percentual-venda').textContent = percentualNum + '%';
        document.getElementById('frequencia-venda').textContent = frequenciaTexto;
        document.getElementById('resultado-anual').textContent = quantidadePorVenda;
        
        // Atualizar mensagem
        document.getElementById('mensagem-calculo').innerHTML = `
            <i class="bi bi-calculator text-info"></i>
            <strong>Cálculo:</strong> ${saldoInventario} animais × ${percentualNum}% = 
            <strong>${quantidadePorVenda} animais por venda</strong><br>
            <small class="text-muted">
                ${frequenciaTexto}: ${quantidadePorVenda} animais × ${vezesPorAno} vendas = 
                <strong>${resultadoAnual} animais por ano</strong>
            </small>
        `;
        
        // Preencher quantidade automaticamente (quantidade por venda)
        document.getElementById('quantidade_venda_categoria').value = quantidadePorVenda;
    } else {
        // Mostrar mensagem de preenchimento
        document.getElementById('mensagem-calculo').innerHTML = `
            <i class="bi bi-info-circle text-info"></i>
            <strong>Preencha todos os campos</strong> para ver o cálculo de venda.
        `;
    }
}


// Carregar saldo automaticamente quando categoria for selecionada
document.addEventListener('DOMContentLoaded', function() {
    const categoria = document.getElementById('categoria_venda_especifica');
    const percentual = document.getElementById('percentual_venda_categoria');
    const frequencia = document.getElementById('frequencia_venda_categoria');
    
    if (categoria) {
        categoria.addEventListener('change', function() {
            if (this.value) {
                carregarSaldoInventario();
            } else {
                document.getElementById('card-inventario').style.display = 'none';
                document.getElementById('quantidade_venda_categoria').value = '';
                saldoInventario = 0;
            }
        });
    }
    
    if (percentual) {
        percentual.addEventListener('input', calcularVenda);
        percentual.addEventListener('change', calcularVenda);
    }
    
    if (frequencia) {
        frequencia.addEventListener('change', calcularVenda);
    }
    
    // Event listeners para transferências
    const categoriaTransferencia = document.getElementById('categoria_transferencia');
    const fazendaOrigem = document.getElementById('fazenda_origem_transferencia');
    const frequenciaTransferencia = document.getElementById('frequencia_transferencia');
    const quantidadeTransferencia = document.getElementById('quantidade_transferencia');
    
    if (categoriaTransferencia) {
        categoriaTransferencia.addEventListener('change', carregarSaldoOrigem);
    }
    
    if (fazendaOrigem) {
        fazendaOrigem.addEventListener('change', carregarSaldoOrigem);
    }
    
    if (frequenciaTransferencia) {
        frequenciaTransferencia.addEventListener('change', calcularTransferencia);
    }
    
    if (quantidadeTransferencia) {
        quantidadeTransferencia.addEventListener('input', calcularTransferencia);
        quantidadeTransferencia.addEventListener('change', calcularTransferencia);
    }
    
    // Event listeners para compras
    const categoriaCompra = document.getElementById('categoria_compra');
    const frequenciaCompra = document.getElementById('frequencia_compra');
    const quantidadeCompra = document.getElementById('quantidade_compra');
    const valorUnitarioCompra = document.getElementById('valor_unitario_compra');
    
    if (categoriaCompra) {
        categoriaCompra.addEventListener('change', calcularCompra);
    }
    
    if (frequenciaCompra) {
        frequenciaCompra.addEventListener('change', calcularCompra);
    }
    
    if (quantidadeCompra) {
        quantidadeCompra.addEventListener('input', calcularCompra);
        quantidadeCompra.addEventListener('change', calcularCompra);
    }
    
    if (valorUnitarioCompra) {
        valorUnitarioCompra.addEventListener('input', calcularCompra);
        valorUnitarioCompra.addEventListener('change', calcularCompra);
    }
});

// Variáveis globais para transferências
let saldoOrigem = 0;
let fazendaOrigemSelecionada = '';

// Carregar saldo da fazenda de origem
function carregarSaldoOrigem() {
    const categoria = document.getElementById('categoria_transferencia');
    const fazendaOrigem = document.getElementById('fazenda_origem_transferencia');
    const cardTransferencia = document.getElementById('card-transferencia');
    
    if (!categoria.value || !fazendaOrigem.value) {
        cardTransferencia.style.display = 'none';
        return;
    }
    
    fazendaOrigemSelecionada = fazendaOrigem.options[fazendaOrigem.selectedIndex].text;
    
    // Mostrar card
    cardTransferencia.style.display = 'block';
    
    // Mostrar loading
    document.getElementById('mensagem-transferencia').innerHTML = `
        <i class="bi bi-hourglass-split"></i>
        <strong>Carregando saldo...</strong> Buscando informações da fazenda de origem.
    `;
    
    // Buscar saldo via AJAX
    fetch(`/propriedade/${fazendaOrigem.value}/inventario/saldo/${categoria.value}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            saldoOrigem = data.quantidade;
            
            // Atualizar card com dados
            document.getElementById('saldo-origem').textContent = saldoOrigem;
            document.getElementById('fazenda-origem-nome').textContent = fazendaOrigemSelecionada;
            document.getElementById('frequencia-transferencia').textContent = '-';
            document.getElementById('quantidade-transferencia').textContent = '0';
            
            // Atualizar mensagem
            document.getElementById('mensagem-transferencia').innerHTML = `
                <i class="bi bi-check-circle text-success"></i>
                <strong>Saldo carregado:</strong> ${saldoOrigem} animais disponíveis em ${fazendaOrigemSelecionada}. 
                <strong>Selecione a frequência e quantidade</strong> para calcular a transferência.
            `;
            
            // Calcular se já tem frequência e quantidade
            calcularTransferencia();
        } else {
            document.getElementById('mensagem-transferencia').innerHTML = `
                <i class="bi bi-exclamation-triangle text-warning"></i>
                <strong>Erro:</strong> ${data.message || 'Não foi possível carregar o saldo da fazenda de origem'}
            `;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        document.getElementById('mensagem-transferencia').innerHTML = `
            <i class="bi bi-x-circle text-danger"></i>
            <strong>Erro:</strong> Não foi possível conectar ao servidor
        `;
    });
}

// Calcular transferência
function calcularTransferencia() {
    const frequencia = document.getElementById('frequencia_transferencia').value;
    const quantidade = document.getElementById('quantidade_transferencia').value;
    const quantidadeNum = parseInt(quantidade) || 0;
    
    if (saldoOrigem > 0 && frequencia && quantidadeNum > 0) {
        // Calcular quantas vezes por ano baseado na frequência
        let vezesPorAno = 1;
        let frequenciaTexto = '';
        
        switch(frequencia) {
            case 'MENSAL':
                vezesPorAno = 12;
                frequenciaTexto = 'Mensal (12x/ano)';
                break;
            case 'BIMESTRAL':
                vezesPorAno = 6;
                frequenciaTexto = 'Bimestral (6x/ano)';
                break;
            case 'TRIMESTRAL':
                vezesPorAno = 4;
                frequenciaTexto = 'Trimestral (4x/ano)';
                break;
            case 'SEMESTRAL':
                vezesPorAno = 2;
                frequenciaTexto = 'Semestral (2x/ano)';
                break;
            case 'ANUAL':
                vezesPorAno = 1;
                frequenciaTexto = 'Anual (1x/ano)';
                break;
        }
        
        // Atualizar valores no card
        document.getElementById('saldo-origem').textContent = saldoOrigem;
        document.getElementById('fazenda-origem-nome').textContent = fazendaOrigemSelecionada;
        document.getElementById('frequencia-transferencia').textContent = frequenciaTexto;
        document.getElementById('quantidade-transferencia').textContent = quantidadeNum;
        
        // Atualizar mensagem
        document.getElementById('mensagem-transferencia').innerHTML = `
            <i class="bi bi-calculator text-info"></i>
            <strong>Transferência:</strong> ${quantidadeNum} animais de ${fazendaOrigemSelecionada}<br>
            <small class="text-muted">
                ${frequenciaTexto}: ${quantidadeNum} animais × ${vezesPorAno} transferências = 
                <strong>${quantidadeNum * vezesPorAno} animais por ano</strong>
            </small>
        `;
        
        // Validar se não está transferindo mais que tem
        if (quantidadeNum > saldoOrigem) {
            document.getElementById('mensagem-transferencia').innerHTML = `
                <i class="bi bi-exclamation-triangle text-warning"></i>
                <strong>Atenção:</strong> Você está tentando transferir ${quantidadeNum} animais, mas ${fazendaOrigemSelecionada} só tem ${saldoOrigem} disponíveis!
            `;
        }
    } else {
        // Mostrar mensagem de preenchimento
        document.getElementById('mensagem-transferencia').innerHTML = `
            <i class="bi bi-info-circle text-info"></i>
            <strong>Preencha todos os campos</strong> para ver o cálculo de transferência.
        `;
    }
}

// Gravar transferência
function gravarTransferencia() {
    const categoria = document.getElementById('categoria_transferencia');
    const fazendaOrigem = document.getElementById('fazenda_origem_transferencia');
    const frequencia = document.getElementById('frequencia_transferencia');
    const quantidade = document.getElementById('quantidade_transferencia');
    
    if (!categoria.value) {
        alert('Selecione uma categoria para transferência');
        return;
    }
    
    if (!fazendaOrigem.value) {
        alert('Selecione uma fazenda de origem');
        return;
    }
    
    if (!frequencia.value) {
        alert('Selecione uma frequência para transferência');
        return;
    }
    
    if (!quantidade.value || quantidade.value <= 0) {
        alert('Informe uma quantidade válida para transferência');
        return;
    }
    
    // Criar form data
    const formData = new FormData();
    formData.append('categoria', categoria.value);
    formData.append('fazenda_origem', fazendaOrigem.value);
    formData.append('frequencia_transferencia', frequencia.value);
    formData.append('quantidade_transferencia', quantidade.value);
    formData.append('gravar_transferencia', 'true');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Enviar via fetch
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Transferência salva com sucesso!');
            
            // Adicionar à tabela
            adicionarTransferenciaTabela(
                categoria.options[categoria.selectedIndex].text,
                fazendaOrigem.options[fazendaOrigem.selectedIndex].text,
                frequencia.options[frequencia.selectedIndex].text,
                quantidade.value
            );
            
            // Limpar campos
            categoria.value = '';
            fazendaOrigem.value = '';
            frequencia.value = '';
            quantidade.value = '';
            document.getElementById('card-transferencia').style.display = 'none';
        } else {
            alert('Erro ao salvar transferência');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar transferência');
    });
}

// Adicionar transferência à tabela
function adicionarTransferenciaTabela(categoriaNome, fazendaOrigemNome, frequenciaNome, quantidade) {
    const tabela = document.getElementById('tabelaTransferencias');
    const tbody = tabela.querySelector('tbody');
    
    // Criar nova linha
    const novaLinha = document.createElement('tr');
    novaLinha.innerHTML = `
        <td>${categoriaNome}</td>
        <td>${fazendaOrigemNome}</td>
        <td>${frequenciaNome}</td>
        <td>${quantidade}</td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="removerTransferenciaTabela(this)">
                <i class="bi bi-trash"></i> Remover
            </button>
        </td>
    `;
    
    // Adicionar à tabela
    tbody.appendChild(novaLinha);
}

// Remover transferência da tabela
function removerTransferenciaTabela(botao) {
    if (confirm('Deseja realmente remover esta transferência?')) {
        const linha = botao.closest('tr');
        linha.remove();
    }
}

// Calcular compra
function calcularCompra() {
    const categoria = document.getElementById('categoria_compra').value;
    const frequencia = document.getElementById('frequencia_compra').value;
    const quantidade = document.getElementById('quantidade_compra').value;
    const valorUnitario = document.getElementById('valor_unitario_compra').value;
    const cardCompra = document.getElementById('card-compra');
    
    if (!categoria) {
        cardCompra.style.display = 'none';
        return;
    }
    
    // Mostrar card
    cardCompra.style.display = 'block';
    
    const quantidadeNum = parseInt(quantidade) || 0;
    const valorUnitarioNum = parseFloat(valorUnitario) || 0;
    
    if (quantidadeNum > 0 && frequencia && valorUnitarioNum > 0) {
        // Calcular quantas vezes por ano baseado na frequência
        let vezesPorAno = 1;
        let frequenciaTexto = '';
        
        switch(frequencia) {
            case 'MENSAL':
                vezesPorAno = 12;
                frequenciaTexto = 'Mensal (12x/ano)';
                break;
            case 'BIMESTRAL':
                vezesPorAno = 6;
                frequenciaTexto = 'Bimestral (6x/ano)';
                break;
            case 'TRIMESTRAL':
                vezesPorAno = 4;
                frequenciaTexto = 'Trimestral (4x/ano)';
                break;
            case 'SEMESTRAL':
                vezesPorAno = 2;
                frequenciaTexto = 'Semestral (2x/ano)';
                break;
            case 'ANUAL':
                vezesPorAno = 1;
                frequenciaTexto = 'Anual (1x/ano)';
                break;
        }
        
        const valorTotalAnual = quantidadeNum * valorUnitarioNum * vezesPorAno;
        
        // Atualizar valores no card
        document.getElementById('quantidade-compra').textContent = quantidadeNum;
        document.getElementById('frequencia-compra').textContent = frequenciaTexto;
        document.getElementById('valor-unitario-compra').textContent = `R$ ${valorUnitarioNum.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('valor-total-compra').textContent = `R$ ${valorTotalAnual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
        // Atualizar mensagem
        document.getElementById('mensagem-compra').innerHTML = `
            <i class="bi bi-calculator text-info"></i>
            <strong>Compra:</strong> ${quantidadeNum} animais × R$ ${valorUnitarioNum.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
            <small class="text-muted">
                ${frequenciaTexto}: ${quantidadeNum} animais × ${vezesPorAno} compras = 
                <strong>${quantidadeNum * vezesPorAno} animais por ano</strong><br>
                <strong>Investimento anual: R$ ${valorTotalAnual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
            </small>
        `;
    } else {
        // Mostrar mensagem de preenchimento
        document.getElementById('mensagem-compra').innerHTML = `
            <i class="bi bi-info-circle text-info"></i>
            <strong>Preencha todos os campos</strong> para ver o cálculo de compra.
        `;
    }
}

// Gravar compra
function gravarCompra() {
    const categoria = document.getElementById('categoria_compra');
    const frequencia = document.getElementById('frequencia_compra');
    const quantidade = document.getElementById('quantidade_compra');
    const valorUnitario = document.getElementById('valor_unitario_compra');
    
    if (!categoria.value) {
        alert('Selecione uma categoria para compra');
        return;
    }
    
    if (!frequencia.value) {
        alert('Selecione uma frequência para compra');
        return;
    }
    
    if (!quantidade.value || quantidade.value <= 0) {
        alert('Informe uma quantidade válida para compra');
        return;
    }
    
    if (!valorUnitario.value || valorUnitario.value <= 0) {
        alert('Informe um valor unitário válido para compra');
        return;
    }
    
    // Criar form data
    const formData = new FormData();
    formData.append('categoria_compra', categoria.value);
    formData.append('frequencia_compra', frequencia.value);
    formData.append('quantidade_compra', quantidade.value);
    formData.append('valor_unitario_compra', valorUnitario.value);
    formData.append('gravar_compra', 'true');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Enviar via fetch
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            return response.text().then(html => {
                // Verificar se há mensagem de sucesso na resposta
                if (html.includes('Compra de') && html.includes('configurada com sucesso')) {
            alert('Compra salva com sucesso!');
            
                    // Verificar se é edição
                    const linhaEditando = document.querySelector('tr[data-editando="true"]');
                    if (linhaEditando) {
                        // Atualizar linha existente
                        atualizarLinhaCompra(linhaEditando, categoria, frequencia, quantidade, valorUnitario);
                        linhaEditando.removeAttribute('data-editando');
                    } else {
                        // Adicionar nova linha
            adicionarCompraTabela(
                categoria.options[categoria.selectedIndex].text,
                frequencia.options[frequencia.selectedIndex].text,
                quantidade.value,
                valorUnitario.value
            );
                    }
            
            // Limpar campos
            categoria.value = '';
            frequencia.value = '';
            quantidade.value = '';
            valorUnitario.value = '';
            document.getElementById('card-compra').style.display = 'none';
        } else {
                    alert('Erro ao salvar compra - resposta inesperada');
                }
            });
        } else {
            alert('Erro ao salvar compra - status: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar compra: ' + error.message);
    });
}

// Adicionar compra à tabela
function adicionarCompraTabela(categoriaNome, frequenciaNome, quantidade, valorUnitario) {
    const tabela = document.getElementById('tabelaCompras');
    const tbody = tabela.querySelector('tbody');
    
    const valorTotal = parseFloat(quantidade) * parseFloat(valorUnitario);
    
    // Criar nova linha
    const novaLinha = document.createElement('tr');
    novaLinha.innerHTML = `
        <td>${categoriaNome}</td>
        <td>${frequenciaNome}</td>
        <td>${quantidade}</td>
        <td>R$ ${parseFloat(valorUnitario).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>
            <button class="btn btn-sm btn-primary me-1" onclick="editarCompraTabela(this)">
                <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger" onclick="removerCompraTabela(this)">
                <i class="bi bi-trash"></i> Remover
            </button>
        </td>
    `;
    
    // Adicionar à tabela
    tbody.appendChild(novaLinha);
}

// Atualizar linha de compra existente
function atualizarLinhaCompra(linha, categoria, frequencia, quantidade, valorUnitario) {
    const celulas = linha.querySelectorAll('td');
    const valorTotal = parseFloat(quantidade.value) * parseFloat(valorUnitario.value);
    
    // Atualizar dados da linha
    celulas[0].textContent = categoria.options[categoria.selectedIndex].text;
    celulas[1].textContent = frequencia.options[frequencia.selectedIndex].text;
    celulas[2].textContent = quantidade.value;
    celulas[3].textContent = `R$ ${parseFloat(valorUnitario.value).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    celulas[4].textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
}

// Editar compra da tabela
function editarCompraTabela(botao) {
    const linha = botao.closest('tr');
    const celulas = linha.querySelectorAll('td');
    
    // Obter dados atuais
    const categoriaAtual = celulas[0].textContent;
    const frequenciaAtual = celulas[1].textContent;
    const quantidadeAtual = celulas[2].textContent;
    const valorAtual = celulas[3].textContent.replace('R$ ', '').replace('.', '').replace(',', '.');
    
    // Preencher os campos de compra
    document.getElementById('categoria_compra').value = obterIdCategoriaPorNome(categoriaAtual);
    document.getElementById('frequencia_compra').value = obterValorFrequencia(frequenciaAtual);
    document.getElementById('quantidade_compra').value = quantidadeAtual;
    document.getElementById('valor_unitario_compra').value = valorAtual;
    
    // Mostrar o card de compra
    document.getElementById('card-compra').style.display = 'block';
    
    // Calcular compra
    calcularCompra();
    
    // Marcar como edição
    linha.setAttribute('data-editando', 'true');
    
    // Rolar para o formulário
    document.getElementById('categoria_compra').scrollIntoView({ behavior: 'smooth' });
}

// Obter ID da categoria por nome
function obterIdCategoriaPorNome(nome) {
    const select = document.getElementById('categoria_compra');
    for (let option of select.options) {
        if (option.textContent === nome) {
            return option.value;
        }
    }
    return '';
}

// Obter valor da frequência
function obterValorFrequencia(nome) {
    const frequencias = {
        'Mensal': 'MENSAL',
        'Bimestral': 'BIMESTRAL',
        'Trimestral': 'TRIMESTRAL',
        'Semestral': 'SEMESTRAL',
        'Anual': 'ANUAL'
    };
    return frequencias[nome] || 'MENSAL';
}

// Remover compra da tabela
function removerCompraTabela(botao) {
    if (confirm('Deseja realmente remover esta compra?')) {
        const linha = botao.closest('tr');
        linha.remove();
    }
}

// Função para adicionar compras via JavaScript (quando necessário)
function adicionarCompraViaJS(categoria, frequencia, quantidade, valor) {
    const tbody = document.querySelector('#tabelaCompras tbody');
    if (tbody) {
        const novaLinha = document.createElement('tr');
        const valorTotal = parseFloat(quantidade) * parseFloat(valor);
        
        novaLinha.innerHTML = `
            <td>${categoria}</td>
            <td>${frequencia}</td>
            <td>${quantidade}</td>
            <td>R$ ${parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            <td>R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editarCompraTabela(this)">
                    <i class="bi bi-pencil"></i> Editar
                </button>
                <button class="btn btn-sm btn-danger" onclick="removerCompraTabela(this)">
                    <i class="bi bi-trash"></i> Remover
                </button>
            </td>
        `;
        
        tbody.appendChild(novaLinha);
    }
}
</script>

<style>
body {
    background-color: #f8f9fa;
    min-height: 100vh;
}

.container-fluid {
    background: transparent;
    min-height: 100vh;
    padding: 20px 0;
}

.card {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.card-header {
    background-color: #6c757d !important;
    color: white !important;
    border-radius: 8px 8px 0 0 !important;
    border: none;
    padding: 1rem 1.5rem;
}

.card-header h5,
.card-header h6 {
    color: white !important;
    font-weight: 700 !important;
}

.bg-gradient-primary {
    background-color: #6c757d !important;
}

.bg-gradient-info {
    background-color: #6c757d !important;
}

.bg-gradient-success {
    background-color: #6c757d !important;
}

.bg-gradient-warning {
    background-color: #6c757d !important;
}

.form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    font-size: 1.1rem;
    font-weight: 500;
    color: #212529;
    padding: 0.75rem 1rem;
}

.form-control:focus {
    border-color: #6c757d;
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    font-weight: 600;
}

.form-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    font-size: 1.1rem;
    font-weight: 500;
    color: #212529;
    padding: 0.75rem 1rem;
}

.form-select:focus {
    border-color: #6c757d;
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    font-weight: 600;
}

/* Melhorar labels normais */
.form-label {
    color: #343a40;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    display: block;
}

/* Melhorar texto de ajuda */
.form-text {
    color: #6c757d;
    font-size: 0.85rem;
    font-weight: 400;
    margin-top: 0.25rem;
}

.input-group-text {
    border-radius: 0 6px 6px 0;
    border: 1px solid #ced4da;
    border-left: none;
    background-color: #6c757d;
    color: white !important;
    font-weight: 700 !important;
}

.input-group .form-control {
    border-radius: 6px 0 0 6px;
    border-right: none;
}

.btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary,
.btn-success,
.btn-warning,
.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-primary:hover,
.btn-success:hover,
.btn-warning:hover,
.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
    color: white;
}

.alert {
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.alert-info {
    background-color: #e2e3e5;
    border-color: #d6d8db;
    color: #383d41;
}

.alert-warning {
    background-color: #e2e3e5;
    border-color: #d6d8db;
    color: #383d41;
}

.alert-success {
    background-color: #e2e3e5;
    border-color: #d6d8db;
    color: #383d41;
}

.table {
    border-radius: 6px;
    overflow: hidden;
}

.table thead th {
    background-color: #6c757d;
    color: white !important;
    border: none;
    font-weight: 700 !important;
    font-size: 0.9rem;
}

.table tbody tr {
    transition: background-color 0.3s ease;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

.table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* Responsividade aprimorada */
@media (max-width: 768px) {
    .container-fluid {
        padding: 10px 0;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .btn-lg {
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
    }
    
    .form-control-lg,
    .form-select-lg {
        font-size: 1rem;
        padding: 0.75rem 1rem;
    }
    
    .input-group-lg > .form-control,
    .input-group-lg > .form-select {
        font-size: 1rem;
        padding: 0.75rem 1rem;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-3 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-lg {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .card-header h5,
    .card-header h6 {
        font-size: 1rem;
    }
    
    .bg-light.rounded {
        padding: 1rem !important;
    }
    
    .bg-light.rounded h4 {
        font-size: 1.5rem;
    }
}

/* Melhorias visuais para os ícones circulares */
.rounded-circle {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    background-color: #6c757d !important;
    color: white !important;
    font-weight: 700 !important;
}

/* Melhorar ícones nos labels */
.form-label i {
    margin-right: 0.5rem;
    font-size: 1rem;
    color: #6c757d;
    font-weight: 600;
}

/* Melhorar ícones nos títulos */
h2 i,
h5 i,
h6 i {
    margin-right: 0.75rem;
    font-size: 1.1em;
    color: #6c757d;
}

/* Melhorar ícones nos botões */
.btn i {
    margin-right: 0.5rem;
    font-size: 1em;
}

/* Estilo para os cards de cálculo */
#card-inventario,
#card-transferencia,
#card-compra {
    border-left: 4px solid #6c757d;
}

/* Melhorias nos badges de percentual - todos em cinza escuro */
.input-group-text.bg-success,
.input-group-text.bg-warning,
.input-group-text.bg-danger,
.input-group-text.bg-primary,
.input-group-text.bg-secondary {
    background-color: #6c757d !important;
    color: white !important;
    font-weight: 700 !important;
    font-size: 1rem;
}

/* Estilo para as tabelas responsivas */
.table-responsive {
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Cores de texto simplificadas - todas em cinza escuro */
.text-primary,
.text-warning,
.text-success,
.text-info,
.text-secondary {
    color: #495057 !important;
    font-weight: 600;
}

/* Melhorar títulos das seções */
h2 {
    color: #343a40;
    font-weight: 700;
    font-size: 2rem;
}

h5 {
    color: #495057;
    font-weight: 600;
    font-size: 1.25rem;
}

h6 {
    color: #495057;
    font-weight: 600;
    font-size: 1.1rem;
}

/* Melhorar texto dos cards de cálculo */
.bg-light.rounded h4 {
    color: #495057;
    font-weight: 700;
    font-size: 1.5rem;
}

.bg-light.rounded small {
    color: #6c757d;
    font-weight: 500;
    font-size: 0.85rem;
}

/* Melhorar texto dos alertas */
.alert {
    font-weight: 500;
}

.alert strong {
    font-weight: 700;
    color: #343a40;
}

/* Melhorar texto dos botões */
.btn {
    font-weight: 600;
    font-size: 0.95rem;
}

.btn-lg {
    font-size: 1.1rem;
    font-weight: 700;
}

/* Estilo para os cards de informações */
.bg-light.rounded {
    background-color: #f8f9fa !important;
    border: 1px solid #dee2e6;
}

/* Botões de ação nas tabelas */
.btn-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

/* Garantir que todos os textos em fundo cinza escuro sejam brancos e em negrito */
.bg-secondary,
.bg-dark,
.bg-gray,
[style*="background-color: #6c757d"],
[style*="background: #6c757d"] {
    color: white !important;
}

.bg-secondary *,
.bg-dark *,
.bg-gray *,
[style*="background-color: #6c757d"] *,
[style*="background: #6c757d"] * {
    color: white !important;
    font-weight: 700 !important;
}

/* Específico para cabeçalhos de cards */
.card-header * {
    color: white !important;
    font-weight: 700 !important;
}

/* Específico para cabeçalhos de tabelas */
.table-dark th,
.table-dark td {
    color: white !important;
    font-weight: 700 !important;
}
</style>

<script>
// Calcular valores totais das compras existentes
function calcularValoresTotais() {
    const elementos = document.querySelectorAll('.valor-total-calculado');
    elementos.forEach(function(elemento) {
        const valor = parseFloat(elemento.getAttribute('data-valor'));
        const quantidade = parseInt(elemento.getAttribute('data-quantidade'));
        const total = valor * quantidade;
        elemento.textContent = total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    });
}

// Funções para Vendas
function gravarVenda() {
    const categoria = document.getElementById('categoria_venda').value;
    const frequencia = document.getElementById('frequencia_venda').value;
    const quantidade = document.getElementById('quantidade_venda').value;
    const valorUnitario = document.getElementById('valor_unitario_venda').value;
    
    if (!categoria || !frequencia || !quantidade || !valorUnitario) {
        alert('Por favor, preencha todos os campos da venda');
        return;
    }
    
    const formData = new FormData();
    formData.append('gravar_venda', 'true');
    formData.append('categoria_venda', categoria);
    formData.append('frequencia_venda', frequencia);
    formData.append('quantidade_venda', quantidade);
    formData.append('valor_unitario_venda', valorUnitario);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            return response.text().then(html => {
                if (html.includes('Venda de') && html.includes('configurada com sucesso')) {
                    alert('Venda salva com sucesso!');
                    window.location.reload();
                } else {
                    alert('Erro ao salvar venda - resposta inesperada');
                }
            });
        } else {
            alert('Erro ao salvar venda - status: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar venda: ' + error.message);
    });
}

function editarVendaTabela(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    
    // Preencher formulário com dados da linha
    document.getElementById('categoria_venda').value = obterIdCategoriaPorNome(cells[0].textContent.trim());
    document.getElementById('frequencia_venda').value = obterValorFrequencia(cells[1].textContent.trim());
    document.getElementById('quantidade_venda').value = cells[2].textContent.trim();
    document.getElementById('valor_unitario_venda').value = cells[3].textContent.replace('R$ ', '').replace(',', '.');
    
    // Marcar linha como sendo editada
    row.setAttribute('data-editando', 'true');
    
    // Atualizar cálculo
    atualizarCalculoVenda();
}

function removerVendaTabela(button) {
    if (confirm('Tem certeza que deseja remover esta venda?')) {
        const row = button.closest('tr');
        row.remove();
    }
}

// Funções para Transferências
function gravarTransferencia() {
    const categoria = document.getElementById('categoria_transferencia').value;
    const frequencia = document.getElementById('frequencia_transferencia').value;
    const quantidade = document.getElementById('quantidade_transferencia').value;
    const fazendaDestino = document.getElementById('fazenda_destino').value;
    
    if (!categoria || !frequencia || !quantidade || !fazendaDestino) {
        alert('Por favor, preencha todos os campos da transferência');
        return;
    }
    
    const formData = new FormData();
    formData.append('gravar_transferencia', 'true');
    formData.append('categoria_transferencia', categoria);
    formData.append('frequencia_transferencia', frequencia);
    formData.append('quantidade_transferencia', quantidade);
    formData.append('fazenda_destino', fazendaDestino);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            return response.text().then(html => {
                if (html.includes('Transferência de') && html.includes('configurada com sucesso')) {
                    alert('Transferência salva com sucesso!');
                    window.location.reload();
                } else {
                    alert('Erro ao salvar transferência - resposta inesperada');
                }
            });
        } else {
            alert('Erro ao salvar transferência - status: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar transferência: ' + error.message);
    });
}

function editarTransferenciaTabela(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    
    // Preencher formulário com dados da linha
    document.getElementById('categoria_transferencia').value = obterIdCategoriaPorNome(cells[0].textContent.trim());
    document.getElementById('frequencia_transferencia').value = obterValorFrequencia(cells[1].textContent.trim());
    document.getElementById('quantidade_transferencia').value = cells[2].textContent.trim();
    document.getElementById('fazenda_destino').value = obterIdFazendaPorNome(cells[3].textContent.trim());
    
    // Marcar linha como sendo editada
    row.setAttribute('data-editando', 'true');
}

function removerTransferenciaTabela(button) {
    if (confirm('Tem certeza que deseja remover esta transferência?')) {
        const row = button.closest('tr');
        row.remove();
    }
}

// Funções auxiliares
function obterIdCategoriaPorNome(nome) {
    const select = document.getElementById('categoria_venda') || document.getElementById('categoria_transferencia');
    for (let option of select.options) {
        if (option.textContent.trim() === nome) {
            return option.value;
        }
    }
    return '';
}

function obterValorFrequencia(display) {
    const frequencias = {
        'Mensal': 'MENSAL',
        'Bimestral': 'BIMESTRAL',
        'Trimestral': 'TRIMESTRAL',
        'Semestral': 'SEMESTRAL',
        'Anual': 'ANUAL'
    };
    return frequencias[display] || '';
}

function obterIdFazendaPorNome(nome) {
    const select = document.getElementById('fazenda_destino');
    for (let option of select.options) {
        if (option.textContent.trim() === nome) {
            return option.value;
        }
    }
    return '';
}

function atualizarCalculoVenda() {
    const quantidade = document.getElementById('quantidade_venda').value || 0;
    const valorUnitario = document.getElementById('valor_unitario_venda').value || 0;
    const total = quantidade * valorUnitario;
    
    document.getElementById('calc_quantidade_venda').textContent = quantidade;
    document.getElementById('calc_valor_unitario_venda').textContent = 'R$ ' + parseFloat(valorUnitario).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('calc_valor_total_venda').textContent = 'R$ ' + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
}

// Assistente de Configuração Inteligente
async function configurarAutomaticamente() {
    const taxaCrescimento = parseInt(document.getElementById('taxa_crescimento').value);
    const crescimentoVacas = parseInt(document.getElementById('crescimento_vacas').value);
    const receitaMinima = parseFloat(document.getElementById('receita_minima').value);
    const periodoAnalise = parseInt(document.getElementById('periodo_analise').value);
    const novasVacasMes = parseInt(document.getElementById('novas_vacas_mes').value);
    const vendasVacasMes = parseInt(document.getElementById('vendas_vacas_mes').value);
    const precoVaca = parseFloat(document.getElementById('preco_vaca').value);
    
    // Mostrar loading
    document.getElementById('resultado-configuracao').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Analisando inventário atual...</p>
        </div>
    `;
    document.getElementById('resultado-configuracao').style.display = 'block';
    
    try {
        // Obter inventário atual
        const inventario = await obterInventarioAtual();
        
        // Calcular configurações
        const configuracao = calcularConfiguracaoInteligente(
            inventario, 
            taxaCrescimento, 
            crescimentoVacas,
            receitaMinima, 
            periodoAnalise,
            novasVacasMes,
            vendasVacasMes,
            precoVaca
        );
        
        // Aplicar configurações
        aplicarConfiguracaoAutomatica(configuracao);
        
        // Mostrar resultado
        mostrarResultadoConfiguracao(configuracao);
    } catch (error) {
        console.error('Erro na configuração automática:', error);
        document.getElementById('resultado-configuracao').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro:</strong> Não foi possível carregar o inventário. Tente novamente.
            </div>
        `;
    }
}

// Função para detectar perfil e configurar automaticamente
async function detectarPerfilEConfigurar() {
    try {
        // Mostrar loading
        const loadingDiv = document.getElementById('resultado-configuracao');
        loadingDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Analisando...</span>
                </div>
                <p class="mt-2">🤖 IA analisando perfil da propriedade...</p>
            </div>
        `;
        loadingDiv.style.display = 'block';
        
        // Obter inventário atual
        const inventario = await obterInventarioAtual();
        
        // Obter respostas do questionário
        const perfil = obterRespostasQuestionario();
        
        // Detectar perfil inteligente
        const perfilDetectado = detectarPerfilPropriedade(inventario, perfil);
        
        // Calcular configuração baseada no perfil
        const configuracao = calcularConfiguracaoPorPerfil(inventario, perfilDetectado);
        
        // Aplicar configuração aos campos do formulário
        aplicarConfiguracaoAutomatica(configuracao);
        
        // Mostrar resultado com perfil detectado
        mostrarResultadoPerfilDetectado(perfilDetectado, configuracao);
        
    } catch (error) {
        console.error('Erro ao detectar perfil:', error);
        document.getElementById('resultado-configuracao').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro:</strong> Não foi possível detectar o perfil. ${error.message}
            </div>
        `;
    }
}

// Função para obter respostas do questionário
function obterRespostasQuestionario() {
    return {
        prioridade: document.getElementById('prioridade_principal').value,
        metaReceita: document.getElementById('meta_receita').value,
        perfilRisco: document.getElementById('perfil_risco').value,
        horizonte: document.getElementById('horizonte_planejamento').value,
        tipoPropriedade: document.getElementById('tipo_propriedade').value
    };
}

// Função para detectar perfil da propriedade
function detectarPerfilPropriedade(inventario, perfil) {
    const totalAnimais = Object.values(inventario).reduce((sum, qtd) => sum + qtd, 0);
    const vacas = (inventario['Multíparas (>36m)'] || 0) + (inventario['Primíparas (24-36m)'] || 0);
    const bois = (inventario['Bois (24-36m)'] || 0) + (inventario['Bois Magros (24-36m)'] || 0);
    const proporcaoVacas = vacas / (vacas + bois);
    
    // Calcular score de perfil
    let score = {
        crescimento: 0,
        receita: 0,
        qualidade: 0,
        equilibrio: 0
    };
    
    // Análise baseada no inventário
    if (totalAnimais > 5000) score.crescimento += 3;
    else if (totalAnimais > 1000) score.crescimento += 2;
    else score.crescimento += 1;
    
    if (proporcaoVacas > 0.6) score.crescimento += 2;
    if (bois > 1000) score.receita += 3;
    
    // Análise baseada nas respostas
    switch(perfil.prioridade) {
        case 'crescimento': score.crescimento += 5; break;
        case 'receita': score.receita += 5; break;
        case 'qualidade': score.qualidade += 5; break;
        case 'equilibrio': score.equilibrio += 5; break;
    }
    
    switch(perfil.metaReceita) {
        case 'muito_alta': score.receita += 3; break;
        case 'alta': score.receita += 2; break;
        case 'media': score.equilibrio += 2; break;
        case 'baixa': score.qualidade += 2; break;
    }
    
    switch(perfil.perfilRisco) {
        case 'agressivo': score.crescimento += 3; break;
        case 'moderado': score.equilibrio += 3; break;
        case 'conservador': score.qualidade += 3; break;
    }
    
    // Determinar perfil final
    const maxScore = Math.max(...Object.values(score));
    const perfilDetectado = Object.keys(score).find(key => score[key] === maxScore);
    
    return {
        tipo: perfilDetectado,
        score: score,
        totalAnimais: totalAnimais,
        proporcaoVacas: proporcaoVacas,
        caracteristicas: {
            tamanho: totalAnimais > 5000 ? 'GRANDE' : totalAnimais > 1000 ? 'MEDIO' : 'PEQUENO',
            foco: perfilDetectado,
            risco: perfil.perfilRisco,
            horizonte: perfil.horizonte
        }
    };
}

// Função para calcular configuração baseada no perfil
function calcularConfiguracaoPorPerfil(inventario, perfilDetectado) {
    const estrategias = {
        crescimento: {
            nome: "CRESCIMENTO AGRESSIVO",
            descricao: "Foco máximo no crescimento do rebanho",
            vendaBois: 100,
            vendaBezerras: 30,
            descartePrimiparas: 15,
            taxaCrescimento: 25,
            focoCompras: "femeas",
            cor: "success"
        },
        receita: {
            nome: "RECEITA MÁXIMA",
            descricao: "Foco na maximização da receita",
            vendaBois: 100,
            vendaBezerras: 60,
            descartePrimiparas: 25,
            taxaCrescimento: 10,
            focoCompras: "equilibrado",
            cor: "warning"
        },
        qualidade: {
            nome: "QUALIDADE PREMIUM",
            descricao: "Foco na qualidade dos animais",
            vendaBois: 80,
            vendaBezerras: 20,
            descartePrimiparas: 10,
            taxaCrescimento: 15,
            focoCompras: "qualidade",
            cor: "info"
        },
        equilibrio: {
            nome: "EQUILÍBRIO SUSTENTÁVEL",
            descricao: "Equilíbrio entre crescimento e receita",
            vendaBois: 90,
            vendaBezerras: 40,
            descartePrimiparas: 20,
            taxaCrescimento: 18,
            focoCompras: "equilibrado",
            cor: "primary"
        }
    };
    
    const estrategia = estrategias[perfilDetectado.tipo];
    
    // Calcular configuração baseada na estratégia
    const vacas = (inventario['Multíparas (>36m)'] || 0) + (inventario['Primíparas (24-36m)'] || 0);
    const bois = (inventario['Bois (24-36m)'] || 0) + (inventario['Bois Magros (24-36m)'] || 0);
    const bezerras = inventario['Bezerras (0-12m)'] || 0;
    
    // Calcular vendas baseadas na estratégia
    const boisParaVender = Math.ceil(bois * estrategia.vendaBois / 100);
    const bezerrasParaVender = Math.ceil(bezerras * estrategia.vendaBezerras / 100);
    const descarteVacas = Math.ceil(vacas * estrategia.descartePrimiparas / 100);
    
    // Calcular compras baseadas no foco
    let comprasVacas = 0;
    if (estrategia.focoCompras === 'femeas') {
        comprasVacas = Math.ceil(vacas * estrategia.taxaCrescimento / 100 / 12);
    } else if (estrategia.focoCompras === 'equilibrado') {
        comprasVacas = Math.ceil(vacas * estrategia.taxaCrescimento / 100 / 12 * 0.7);
    } else {
        comprasVacas = Math.ceil(vacas * estrategia.taxaCrescimento / 100 / 12 * 0.5);
    }
    
    return {
        perfil: perfilDetectado,
        estrategia: estrategia,
        configuracao: {
            taxa_natalidade_anual: 80,
            taxa_mortalidade_bezerros_anual: 5,
            taxa_mortalidade_adultos_anual: 2,
            percentual_venda_machos_anual: estrategia.vendaBois,
            percentual_venda_femeas_anual: estrategia.vendaBezerras,
            percentual_descarte_primiparas_anual: estrategia.descartePrimiparas,
            taxa_crescimento_anual: estrategia.taxaCrescimento
        },
        vendas: {
            bois: boisParaVender,
            bezerras: bezerrasParaVender,
            descarte: descarteVacas
        },
        compras: {
            vacas: comprasVacas
        }
    };
}

// Função para mostrar resultado do perfil detectado
function mostrarResultadoPerfilDetectado(perfil, configuracao) {
    const detalhes = `
        <div class="row">
            <div class="col-12">
                <div class="alert alert-${configuracao.estrategia.cor}">
                    <h5 class="alert-heading">
                        <i class="bi bi-robot"></i> Perfil Detectado: ${configuracao.estrategia.nome}
                    </h5>
                    <p class="mb-2">${configuracao.estrategia.descricao}</p>
                    <hr>
                    <div class="row">
                        <div class="col-md-3">
                            <h6>📊 Análise da Propriedade</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total de animais:</strong> ${perfil.totalAnimais.toLocaleString()}</li>
                                <li><strong>Tamanho:</strong> ${perfil.caracteristicas.tamanho}</li>
                                <li><strong>Proporção de vacas:</strong> ${(perfil.proporcaoVacas * 100).toFixed(1)}%</li>
                                <li><strong>Foco detectado:</strong> ${perfil.caracteristicas.foco}</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>🎯 Estratégia Aplicada</h6>
                            <ul class="list-unstyled">
                                <li><strong>Venda de bois:</strong> ${configuracao.estrategia.vendaBois}%</li>
                                <li><strong>Venda de bezerras:</strong> ${configuracao.estrategia.vendaBezerras}%</li>
                                <li><strong>Descarte primíparas:</strong> ${configuracao.estrategia.descartePrimiparas}%</li>
                                <li><strong>Taxa crescimento:</strong> ${configuracao.estrategia.taxaCrescimento}%/ano</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>💰 Projeção de Vendas</h6>
                            <ul class="list-unstyled">
                                <li><strong>Bois para vender:</strong> ${configuracao.vendas.bois}</li>
                                <li><strong>Bezerras para vender:</strong> ${configuracao.vendas.bezerras}</li>
                                <li><strong>Descarte de vacas:</strong> ${configuracao.vendas.descarte}</li>
                                <li><strong>Compras de vacas:</strong> ${configuracao.compras.vacas}/mês</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6>📈 Score de Perfil</h6>
                            <ul class="list-unstyled">
                                <li><strong>Crescimento:</strong> ${perfil.score.crescimento}/10</li>
                                <li><strong>Receita:</strong> ${perfil.score.receita}/10</li>
                                <li><strong>Qualidade:</strong> ${perfil.score.qualidade}/10</li>
                                <li><strong>Equilíbrio:</strong> ${perfil.score.equilibrio}/10</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i>
                    <strong>Configuração aplicada!</strong> O sistema detectou automaticamente que sua propriedade se encaixa no perfil 
                    <strong>${configuracao.estrategia.nome}</strong> e aplicou a estratégia ideal para maximizar seus resultados.
                    Revise os parâmetros e clique em "Salvar Parâmetros" para confirmar.
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('detalhes-configuracao').innerHTML = detalhes;
    document.getElementById('resultado-configuracao').style.display = 'block';
}

function obterInventarioAtual() {
    // Buscar inventário real via AJAX
    return new Promise((resolve, reject) => {
        fetch('/propriedade/1/pecuaria/inventario/dados/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            const inventario = {};
            if (data.inventario) {
                data.inventario.forEach(item => {
                    inventario[item.categoria] = item.quantidade;
                });
            }
            resolve(inventario);
        })
        .catch(error => {
            console.error('Erro ao buscar inventário:', error);
            // Fallback para dados simulados
            const inventario = {
                'Bezerros (0-12m)': 15,
                'Bezerras (0-12m)': 12,
                'Novilhos (12-24m)': 8,
                'Novilhas (12-24m)': 10,
                'Bois (24-36m)': 6,
                'Vacas (24+ meses)': 20,
                'Touros': 2
            };
            resolve(inventario);
        });
    });
}

function calcularConfiguracaoInteligente(inventario, taxaCrescimento, crescimentoVacas, receitaMinima, periodoAnalise, novasVacasMes, vendasVacasMes, precoVaca) {
    const totalAnimais = Object.values(inventario).reduce((sum, qtd) => sum + qtd, 0);
    
    // Extrair quantidades reais do inventário (usando nomes corretos das categorias)
    const multíparasAtuais = inventario['Multíparas (>36m)'] || 0;
    const primíparasAtuais = inventario['Primíparas (24-36m)'] || 0;
    const novilhasAtuais = inventario['Novilhas (12-24m)'] || 0;
    const bezerrasAtuais = inventario['Bezerras (0-12m)'] || 0;
    const boisAtuais = inventario['Bois (24-36m)'] || 0;
    const boisMagrosAtuais = inventario['Bois Magros (24-36m)'] || 0;
    const garrotesAtuais = inventario['Garrotes (12-24m)'] || 0;
    const bezerrosAtuais = inventario['Bezerros (0-12m)'] || 0;
    const vacasDescarteAtuais = inventario['Vacas de Descarte'] || 0;
    
    // Calcular total de vacas (multíparas + primíparas)
    const vacasAtuais = multíparasAtuais + primíparasAtuais;
    
    // ESTRATÉGIA REAL DO REBANHO:
    
    // 1. BOIS ADULTOS: 100% vendidos
    const boisParaVender = boisAtuais + boisMagrosAtuais; // Todos os bois são vendidos
    
    // 2. VENDAS DE BEZERRAS: 40% dos nascimentos de fêmeas
    const taxaNatalidade = 80; // 80% ao ano
    const nascimentosMensais = Math.ceil(vacasAtuais * (taxaNatalidade / 12) / 100);
    const nascimentosFemeas = Math.ceil(nascimentosMensais * 0.5); // 50% são fêmeas
    const bezerrasParaVender = Math.ceil(nascimentosFemeas * 0.4); // 40% vendidas
    
    // 3. DESCARTE DE VACAS: 20% quando emprenham pela primeira vez e ficam vazias
    const descarteVacasMensal = Math.ceil(primíparasAtuais * 0.2); // 20% das primíparas
    
    // 4. EVOLUÇÃO NATURAL
    const novilhasParaVacas = Math.ceil(novilhasAtuais * 0.083); // 1/12 por mês
    const bezerrasParaNovilhas = Math.ceil(bezerrasAtuais * 0.083); // 1/12 por mês
    const garrotesParaBois = Math.ceil(garrotesAtuais * 0.083); // 1/12 por mês
    const bezerrosParaGarrotes = Math.ceil(bezerrosAtuais * 0.083); // 1/12 por mês
    
    // 5. CALCULAR NECESSIDADE DE COMPRAS
    const crescimentoVacasMensal = crescimentoVacas / 12;
    const vacasParaCrescer = Math.ceil(vacasAtuais * crescimentoVacasMensal / 100);
    
    // Necessidade = Crescimento + Descarte - Evolução Natural
    const necessidadeVacas = Math.max(0, vacasParaCrescer + descarteVacasMensal - novilhasParaVacas);
    const comprasVacasMes = Math.max(novasVacasMes, necessidadeVacas);
    
    // 6. CALCULAR RECEITA
    const precoMedioBoi = 6500; // Preço real dos bois
    const precoBezerra = 1800; // Preço real das bezerras
    const receitaBois = boisParaVender * precoMedioBoi;
    const receitaBezerras = bezerrasParaVender * precoBezerra;
    const receitaTotalVendas = receitaBois + receitaBezerras;
    
    // 7. CALCULAR COMPRAS NECESSÁRIAS
    const bezerrosQuantidade = Math.ceil(comprasVacasMes * 0.3); // Poucos machos
    const bezerrasQuantidade = Math.ceil(comprasVacasMes * 0.7); // Muitas fêmeas
    const novilhasQuantidade = Math.ceil(comprasVacasMes * 0.4); // Fêmeas jovens
    const vacasQuantidade = Math.ceil(comprasVacasMes * 0.2); // Vacas adultas
    
    // 8. CALCULAR CUSTOS
    const custoBezerros = bezerrosQuantidade * 2000;
    const custoBezerras = bezerrasQuantidade * 1800;
    const custoNovilhas = novilhasQuantidade * 3500;
    const custoVacas = vacasQuantidade * precoVaca;
    const custoTotalCompras = custoBezerros + custoBezerras + custoNovilhas + custoVacas;
    
    // 9. CALCULAR LUCRO
    const lucroLiquido = receitaTotalVendas - custoTotalCompras;
    
    // 10. CALCULAR CRESCIMENTO LÍQUIDO
    const crescimentoLiquidoVacas = comprasVacasMes + novilhasParaVacas - descarteVacasMensal;
    
    return {
        taxaCrescimento,
        crescimentoVacas,
        receitaMinima,
        totalAnimais,
        vacasAtuais,
        novilhasAtuais,
        bezerrasAtuais,
        boisAtuais,
        descarteVacasMensal,
        novilhasParaVacas,
        bezerrasParaNovilhas,
        bezerrasParaVender,
        boisParaVender,
        comprasVacasMes,
        crescimentoLiquidoVacas,
        custoTotalCompras,
        receitaTotalVendas,
        lucroLiquido,
        configuracao: {
            // Parâmetros básicos
            taxa_natalidade_anual: 80,
            taxa_mortalidade_bezerros_anual: 5,
            taxa_mortalidade_adultos_anual: 2,
            percentual_venda_machos_anual: 100, // 100% dos bois são vendidos
            percentual_venda_femeas_anual: 40, // 40% das bezerras são vendidas
            
            // Compras mensais (foco em fêmeas)
            compras: [
                { categoria: 'Bezerros (0-12m)', quantidade: bezerrosQuantidade, valor: 2000, frequencia: 'MENSAL' },
                { categoria: 'Bezerras (0-12m)', quantidade: bezerrasQuantidade, valor: 1800, frequencia: 'MENSAL' },
                { categoria: 'Novilhas (12-24m)', quantidade: novilhasQuantidade, valor: 3500, frequencia: 'MENSAL' },
                { categoria: 'Multíparas (>36m)', quantidade: vacasQuantidade, valor: precoVaca, frequencia: 'MENSAL' }
            ],
            
            // Vendas mensais (estratégia real)
            vendas: [
                { categoria: 'Bois (24-36m)', quantidade: boisParaVender, valor: precoMedioBoi, frequencia: 'MENSAL' },
                { categoria: 'Bezerras (0-12m)', quantidade: bezerrasParaVender, valor: precoBezerra, frequencia: 'MENSAL' }
            ]
        }
    };
}

function aplicarConfiguracaoAutomatica(configuracao) {
    // Aplicar parâmetros básicos
    document.getElementById('id_taxa_natalidade_anual').value = configuracao.configuracao.taxa_natalidade_anual;
    document.getElementById('id_taxa_mortalidade_bezerros_anual').value = configuracao.configuracao.taxa_mortalidade_bezerros_anual;
    document.getElementById('id_taxa_mortalidade_adultos_anual').value = configuracao.configuracao.taxa_mortalidade_adultos_anual;
    document.getElementById('id_percentual_venda_machos_anual').value = configuracao.configuracao.percentual_venda_machos_anual;
    document.getElementById('id_percentual_venda_femeas_anual').value = configuracao.configuracao.percentual_venda_femeas_anual;
    
    // Aplicar compras
    configuracao.configuracao.compras.forEach((compra, index) => {
        if (index === 0) {
            document.getElementById('categoria_compra').value = obterIdCategoriaPorNome(compra.categoria);
            document.getElementById('frequencia_compra').value = compra.frequencia;
            document.getElementById('quantidade_compra').value = compra.quantidade;
            document.getElementById('valor_unitario_compra').value = compra.valor;
        }
    });
    
    // Aplicar vendas
    configuracao.configuracao.vendas.forEach((venda, index) => {
        if (index === 0) {
            document.getElementById('categoria_venda').value = obterIdCategoriaPorNome(venda.categoria);
            document.getElementById('frequencia_venda').value = venda.frequencia;
            document.getElementById('quantidade_venda').value = venda.quantidade;
            document.getElementById('valor_unitario_venda').value = venda.valor;
        }
    });
}

function mostrarResultadoConfiguracao(configuracao) {
    const detalhes = `
        <div class="row">
            <div class="col-md-3">
                <h6 class="text-success">📊 Inventário Atual</h6>
                <ul class="list-unstyled">
                    <li><strong>Total de animais:</strong> ${configuracao.totalAnimais}</li>
                    <li><strong>Vacas (Multíparas + Primíparas):</strong> ${configuracao.vacasAtuais}</li>
                    <li><strong>Novilhas atuais:</strong> ${configuracao.novilhasAtuais}</li>
                    <li><strong>Bezerras atuais:</strong> ${configuracao.bezerrasAtuais}</li>
                    <li><strong>Bois atuais:</strong> ${configuracao.boisAtuais}</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-pink">🐄 Estratégia Real</h6>
                <ul class="list-unstyled">
                    <li><strong>Bois vendidos:</strong> ${configuracao.boisParaVender} (100%)</li>
                    <li><strong>Bezerras vendidas:</strong> ${configuracao.bezerrasParaVender} (40% dos nascimentos)</li>
                    <li><strong>Descarte primíparas:</strong> ${configuracao.descarteVacasMensal} (20% vazias)</li>
                    <li><strong>Novilhas → Vacas:</strong> +${configuracao.novilhasParaVacas}/mês</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-info">📈 Crescimento</h6>
                <ul class="list-unstyled">
                    <li><strong>Compras/mês:</strong> ${configuracao.comprasVacasMes} vacas</li>
                    <li><strong>Crescimento líquido:</strong> +${configuracao.crescimentoLiquidoVacas} vacas/mês</li>
                    <li><strong>Crescimento anual:</strong> +${configuracao.crescimentoLiquidoVacas * 12} vacas/ano</li>
                    <li><strong>Taxa crescimento:</strong> ${configuracao.crescimentoVacas}% ao ano</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">💰 Resultado Financeiro</h6>
                <ul class="list-unstyled">
                    <li><strong>Receita bois:</strong> R$ ${(configuracao.boisParaVender * 6500).toLocaleString('pt-BR')}</li>
                    <li><strong>Receita bezerras:</strong> R$ ${(configuracao.bezerrasParaVender * 1800).toLocaleString('pt-BR')}</li>
                    <li><strong>Receita total:</strong> R$ ${configuracao.receitaTotalVendas.toLocaleString('pt-BR')}</li>
                    <li class="border-top pt-2"><strong>Lucro líquido:</strong> R$ ${configuracao.lucroLiquido.toLocaleString('pt-BR')}</li>
                </ul>
            </div>
        </div>
        
        <!-- Estratégia de Vendas -->
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-warning">💰 Estratégia de Vendas</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-warning text-dark">
                            <div class="card-body p-3">
                                <h6 class="card-title">
                                    <i class="bi bi-gender-male"></i> Bois (100% vendidos)
                                </h6>
                                <p class="mb-1"><strong>${configuracao.boisParaVender}</strong> bois</p>
                                <p class="mb-1">Preço: R$ 6.500/boi</p>
                                <p class="mb-0"><strong>Receita: R$ ${(configuracao.boisParaVender * 6500).toLocaleString('pt-BR')}</strong></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-info text-white">
                            <div class="card-body p-3">
                                <h6 class="card-title">
                                    <i class="bi bi-gender-female"></i> Bezerras (40% dos nascimentos)
                                </h6>
                                <p class="mb-1"><strong>${configuracao.bezerrasParaVender}</strong> bezerras</p>
                                <p class="mb-1">Preço: R$ 1.800/bezerra</p>
                                <p class="mb-0"><strong>Receita: R$ ${(configuracao.bezerrasParaVender * 1800).toLocaleString('pt-BR')}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detalhamento das Compras -->
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-danger">💸 Compras para Reposição</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body p-2">
                                <h6 class="card-title">Bezerros</h6>
                                <p class="mb-1"><strong>${configuracao.configuracao.compras[0].quantidade}</strong> animais</p>
                                <p class="mb-0">R$ ${(configuracao.configuracao.compras[0].quantidade * configuracao.configuracao.compras[0].valor).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body p-2">
                                <h6 class="card-title">Bezerras</h6>
                                <p class="mb-1"><strong>${configuracao.configuracao.compras[1].quantidade}</strong> animais</p>
                                <p class="mb-0">R$ ${(configuracao.configuracao.compras[1].quantidade * configuracao.configuracao.compras[1].valor).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body p-2">
                                <h6 class="card-title">Novilhas</h6>
                                <p class="mb-1"><strong>${configuracao.configuracao.compras[2].quantidade}</strong> animais</p>
                                <p class="mb-0">R$ ${(configuracao.configuracao.compras[2].quantidade * configuracao.configuracao.compras[2].valor).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body p-2">
                                <h6 class="card-title">Multíparas</h6>
                                <p class="mb-1"><strong>${configuracao.configuracao.compras[3].quantidade}</strong> animais</p>
                                <p class="mb-0">R$ ${(configuracao.configuracao.compras[3].quantidade * configuracao.configuracao.compras[3].valor).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert ${configuracao.lucroLiquido > 0 ? 'alert-success' : 'alert-warning'}">
                    <i class="bi bi-${configuracao.lucroLiquido > 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                    <strong>${configuracao.lucroLiquido > 0 ? 'Estratégia viável!' : 'Atenção: Lucro baixo'}</strong> 
                    ${configuracao.lucroLiquido > 0 ? 
                        `Lucro líquido de R$ ${configuracao.lucroLiquido.toLocaleString('pt-BR')}/mês com crescimento de ${configuracao.crescimentoLiquidoVacas} vacas/mês (${configuracao.crescimentoVacas}% ao ano).` : 
                        `Lucro de apenas R$ ${configuracao.lucroLiquido.toLocaleString('pt-BR')}/mês. Considere ajustar os valores.`
                    }
                </div>
            </div>
        </div>
        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle"></i>
            <strong>Estratégia aplicada!</strong> Configuração baseada na estratégia real: 100% dos bois vendidos, 
            40% das bezerras vendidas, 20% de descarte de primíparas vazias. 
            Revise os valores e clique em "Salvar Parâmetros" para confirmar.
        </div>
    `;
    
    document.getElementById('detalhes-configuracao').innerHTML = detalhes;
    document.getElementById('resultado-configuracao').style.display = 'block';
}

function obterIdCategoriaPorNome(nomeCategoria) {
    const select = document.getElementById('categoria_compra');
    for (let option of select.options) {
        if (option.text.includes(nomeCategoria.split(' ')[0])) {
            return option.value;
        }
    }
    return select.options[1].value; // Fallback para primeira categoria
}

function mostrarCalculos() {
    const inventario = obterInventarioAtual();
    const taxaCrescimento = parseInt(document.getElementById('taxa_crescimento').value);
    const receitaMinima = parseFloat(document.getElementById('receita_minima').value);
    
    alert(`Cálculos Detalhados:\n\n` +
          `Inventário atual: ${Object.values(inventario).reduce((sum, qtd) => sum + qtd, 0)} animais\n` +
          `Taxa de crescimento: ${taxaCrescimento}% ao ano\n` +
          `Receita desejada: R$ ${receitaMinima.toLocaleString('pt-BR')}/mês\n\n` +
          `Clique em "Configurar Automaticamente" para aplicar os cálculos.`);
}

// Event listeners para cálculo automático
document.addEventListener('DOMContentLoaded', function() {
    calcularValoresTotais();
    
    // Event listeners para vendas
    document.getElementById('quantidade_venda').addEventListener('input', atualizarCalculoVenda);
    document.getElementById('valor_unitario_venda').addEventListener('input', atualizarCalculoVenda);
});
</script>
{% endblock %}
