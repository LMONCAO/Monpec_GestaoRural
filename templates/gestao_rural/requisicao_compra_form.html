{% extends "base_modulos_unificado.html" %}

{% block title %}Nova Requisição de Compra - {{ propriedade.nome_propriedade }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="breadcrumb-inteligente mb-3">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'propriedade_modulos' propriedade.id %}">Módulos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'compras_dashboard' propriedade.id %}">Compras</a></li>
            <li class="breadcrumb-item"><a href="{% url 'requisicoes_compra_lista' propriedade.id %}">Requisições</a></li>
            <li class="breadcrumb-item active">Nova Requisição</li>
        </ol>
    </nav>

    <form method="post" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
                <span class="badge text-bg-primary"><i class="bi bi-hash me-1"></i>{{ numero_preview }}</span>
            </div>
            <div class="col-auto">
                <span class="badge text-bg-light border"><i class="bi bi-calendar me-1"></i>{{ data_requisicao|date:"d/m/Y" }}</span>
            </div>
            <div class="col-auto">
                <span class="badge text-bg-light border"><i class="bi bi-geo-alt me-1"></i>{{ propriedade.nome_propriedade }}</span>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h5 mb-0"><i class="bi bi-clipboard-check text-primary me-2"></i>Informações principais</h2>
                        <p class="text-muted small mb-0">Preencha dados essenciais para quem irá aprovar e cotar a solicitação.</p>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Labels na primeira linha -->
                            <div class="col-md-4">
                                <label class="form-label mb-0">{{ form.titulo.label }} *</label>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label mb-0">{{ form.prioridade.label }} *</label>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label mb-0">{{ form.data_necessidade.label }}</label>
                            </div>
                        </div>
                        <div class="row g-3 mt-0">
                            <!-- Campos na segunda linha -->
                            <div class="col-md-4">
                                {{ form.titulo }}
                                {% for error in form.titulo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="col-md-4">
                                {{ form.prioridade }}
                                {% for error in form.prioridade.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="col-md-4">
                                {{ form.data_necessidade }}
                                {% for error in form.data_necessidade.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                        </div>
                            <div class="col-12">
                                <label class="form-label d-flex justify-content-between">{{ form.justificativa.label }} * <small class="text-muted" id="justificativa-contagem">0/600</small></label>
                                {{ form.justificativa }}
                                {% for error in form.justificativa.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h5 mb-0"><i class="bi bi-diagram-3 text-primary me-2"></i>Responsáveis e centros</h2>
                            <p class="text-muted small mb-0">Direciona a aprovação e análise contábil.</p>
                        </div>
                        <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#responsaveis-opcionais" aria-expanded="true">
                            Ajustes adicionais
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.setor.label }}</label>
                                <span class="ms-1 text-muted" data-bs-toggle="tooltip" title="Quem receberá a notificação de aprovação inicial."><i class="bi bi-question-circle"></i></span>
                                <div class="input-group">
                                    {{ form.setor }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCadastroSetor" title="Cadastrar novo setor">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                {% for error in form.setor.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.equipamento.label }}</label>
                                <div class="input-group">
                                    {{ form.equipamento }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCadastroEquipamento" title="Cadastrar novo equipamento">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                {% for error in form.equipamento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.centro_custo.label }}</label>
                                <div class="input-group">
                                    {{ form.centro_custo }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCadastroCentroCusto" title="Cadastrar novo centro de custo">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                {% for error in form.centro_custo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.plano_conta.label }}</label>
                                <div class="input-group">
                                    {{ form.plano_conta }}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCadastroPlanoConta" title="Cadastrar novo plano de contas">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                {% for error in form.plano_conta.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                        </div>
                        <div id="responsaveis-opcionais" class="collapse mt-3">
                            <label class="form-label">{{ form.centro_custo_descricao.label }}</label>
                            {{ form.centro_custo_descricao }}
                            {% for error in form.centro_custo_descricao.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h5 mb-0"><i class="bi bi-list-check text-primary me-2"></i>Itens solicitados</h2>
                            <p class="text-muted small mb-0">Preencha os itens necessários. Adicione quantos forem preciso.</p>
                        </div>
                        <button type="button" id="add-item-btn" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>Adicionar item</button>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        <div class="table-responsive">
                            <table class="table align-middle" id="itens-table">
                                <thead>
                                    <tr class="small text-muted">
                                        <th style="width: 26%">Descrição</th>
                                        <th style="width: 10%">Unidade</th>
                                        <th style="width: 10%" class="text-end">Qtd</th>
                                        <th style="width: 14%" class="text-end">Valor estimado</th>
                                        <th style="width: 18%">Fornecedor sugerido</th>
                                        <th>Observações</th>
                                        <th style="width: 52px"></th>
                                    </tr>
                                </thead>
                                <tbody id="itens-tbody">
                                    {% for form_item in formset %}
                                    <tr class="item-row" data-index="{{ forloop.counter0 }}">
                                        {% for hidden in form_item.hidden_fields %}{{ hidden }}{% endfor %}
                                        <td>{{ form_item.descricao }}{% for error in form_item.descricao.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td>{{ form_item.unidade_medida }}{% for error in form_item.unidade_medida.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td>{{ form_item.quantidade }}{% for error in form_item.quantidade.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td>{{ form_item.valor_estimado_unitario }}{% for error in form_item.valor_estimado_unitario.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td>{{ form_item.fornecedor_preferencial }}{% for error in form_item.fornecedor_preferencial.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td>{{ form_item.observacoes }}{% for error in form_item.observacoes.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}</td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-item" title="Remover item"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-light border mt-3 mb-0">
                            <strong>Dica:</strong> use o botão "Adicionar item" quantas vezes precisar. Você pode salvar como rascunho e completar depois.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-3">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h6 mb-0"><i class="bi bi-chat-text text-primary me-2"></i>Observações</h2>
                        <p class="text-muted small mb-0">Instruções adicionais (visíveis para aprovadores e comprador).</p>
                    </div>
                    <div class="card-body">
                        {{ form.observacoes }}
                        {% for error in form.observacoes.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        <p class="small text-muted mt-2">Campos opcionais, use para complementar descrição de itens ou condições.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h2 class="h6 mb-3"><i class="bi bi-info-circle text-primary me-2"></i>Resumo rápido</h2>
                        <div class="row g-3">
                            <div class="col-md-2 col-sm-4 col-6">
                                <small class="text-muted d-block mb-1">Número</small>
                                <strong class="d-block">{{ numero_preview }}</strong>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <small class="text-muted d-block mb-1">Data da requisição</small>
                                <strong class="d-block">{{ data_requisicao|date:"d/m/Y" }}</strong>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <small class="text-muted d-block mb-1">Prioridade atual</small>
                                <strong class="d-block"><span id="prioridade-preview" data-inicial="{{ form.prioridade.value|default:'' }}">--</span></strong>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <small class="text-muted d-block mb-1">Necessidade</small>
                                <strong class="d-block"><span id="data-preview">{{ form.data_necessidade.value|default:'a definir' }}</span></strong>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <small class="text-muted d-block mb-1">Total estimado</small>
                                <strong class="d-block text-primary" id="total-estimado-preview">R$ 0,00</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-body d-flex flex-wrap gap-2 justify-content-between align-items-center">
                <div class="small text-muted d-flex align-items-center gap-2">
                    <i class="bi bi-exclamation-circle text-primary"></i>
                    <span>Campos marcados com * são obrigatórios. Revise os itens antes de enviar.</span>
                </div>
                <div class="btn-group">
                    <a href="{% url 'requisicoes_compra_lista' propriedade.id %}" class="btn btn-light">Cancelar</a>
                    <button type="submit" name="acao" value="rascunho" class="btn btn-outline-secondary">Salvar como rascunho</button>
                    <button type="submit" name="acao" value="enviar" class="btn btn-primary">Enviar para aprovação</button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modais de Cadastro Rápido -->
<!-- Modal Cadastro Setor -->
<div class="modal fade" id="modalCadastroSetor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Setor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCadastroSetor">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Setor *</label>
                        <input type="text" class="form-control" id="setor-nome" name="nome" required placeholder="Ex.: Oficina, Suprimentos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código (opcional)</label>
                        <input type="text" class="form-control" id="setor-codigo" name="codigo" placeholder="Código curto">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição (opcional)</label>
                        <textarea class="form-control" id="setor-descricao" name="descricao" rows="3" placeholder="Resumo das responsabilidades"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cadastro Equipamento -->
<div class="modal fade" id="modalCadastroEquipamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Equipamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCadastroEquipamento">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Equipamento *</label>
                        <input type="text" class="form-control" id="equipamento-nome" name="nome" required placeholder="Ex.: Trator, Pulverizador">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição (opcional)</label>
                        <textarea class="form-control" id="equipamento-descricao" name="descricao" rows="3" placeholder="Informações adicionais"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cadastro Centro de Custo -->
<div class="modal fade" id="modalCadastroCentroCusto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Centro de Custo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCadastroCentroCusto">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Centro de Custo *</label>
                        <input type="text" class="form-control" id="centro-custo-nome" name="nome" required placeholder="Ex.: Pecuária, Agricultura">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo *</label>
                        <select class="form-select" id="centro-custo-tipo" name="tipo" required>
                            <option value="OPERACIONAL">Operacional</option>
                            <option value="ADMINISTRATIVO">Administrativo</option>
                            <option value="INVESTIMENTO">Investimento</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição (opcional)</label>
                        <textarea class="form-control" id="centro-custo-descricao" name="descricao" rows="3" placeholder="Informações adicionais"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cadastro Plano de Conta -->
<div class="modal fade" id="modalCadastroPlanoConta" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Cadastrar Novo Plano de Conta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCadastroPlanoConta">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Código *</label>
                        <input type="text" class="form-control" id="plano-conta-codigo" name="codigo" required placeholder="Ex.: 1.1.01">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="plano-conta-nome" name="nome" required placeholder="Ex.: Compras de Insumos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo *</label>
                        <select class="form-select" id="plano-conta-tipo" name="tipo" required>
                            <option value="DESPESA">Despesa</option>
                            <option value="RECEITA">Receita</option>
                            <option value="TRANSFERENCIA">Transferência</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição (opcional)</label>
                        <textarea class="form-control" id="plano-conta-descricao" name="descricao" rows="3" placeholder="Informações adicionais"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<template id="item-empty-row">
<tr class="item-row" data-index="__prefix__">
    {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
    <td>{{ formset.empty_form.descricao }}</td>
    <td>{{ formset.empty_form.unidade_medida }}</td>
    <td>{{ formset.empty_form.quantidade }}</td>
    <td>{{ formset.empty_form.valor_estimado_unitario }}</td>
    <td>{{ formset.empty_form.fornecedor_preferencial }}</td>
    <td>{{ formset.empty_form.observacoes }}</td>
    <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-item" title="Remover item"><i class="bi bi-trash"></i></button></td>
</tr>
</template>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    const totalFormsInput = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    const tbody = document.getElementById('itens-tbody');
    const addItemBtn = document.getElementById('add-item-btn');
    const emptyTemplate = document.getElementById('item-empty-row');

    function reindexRows() {
        const rows = Array.from(tbody.querySelectorAll('.item-row'));
        rows.forEach((row, index) => {
            row.dataset.index = index;
            row.querySelectorAll('[name]').forEach((el) => {
                el.name = el.name.replace(/-(\d+)-/, `-${index}-`);
            });
            row.querySelectorAll('[id]').forEach((el) => {
                el.id = el.id.replace(/-(\d+)-/, `-${index}-`);
            });
        });
        totalFormsInput.value = rows.length;
    }

    function recalcResumo() {
        const valorCampos = tbody.querySelectorAll('input[name$="-valor_estimado_unitario"]');
        let total = 0;
        valorCampos.forEach((input) => {
            const qtdInput = input.closest('tr').querySelector('input[name$="-quantidade"]');
            const valor = parseFloat((input.value || '').replace(',', '.')) || 0;
            const quantidade = parseFloat((qtdInput.value || '').replace(',', '.')) || 0;
            total += valor * quantidade;
        });
        document.getElementById('total-estimado-preview').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
    }

    function bindRowEvents(row) {
        row.querySelectorAll('input').forEach((input) => {
            input.addEventListener('input', recalcResumo);
        });
        const removeBtn = row.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const hiddenDelete = row.querySelector('input[name$="-DELETE"]');
                if (hiddenDelete) {
                    hiddenDelete.value = 'on';
                    row.style.display = 'none';
                } else {
                    row.remove();
                    reindexRows();
                }
                recalcResumo();
            });
        }
    }

    addItemBtn.addEventListener('click', function() {
        const newIndex = parseInt(totalFormsInput.value, 10);
        const temp = document.createElement('tbody');
        temp.innerHTML = emptyTemplate.innerHTML.replace(/__prefix__/g, newIndex);
        const newRow = temp.querySelector('tr');
        tbody.appendChild(newRow);
        bindRowEvents(newRow);
        reindexRows();
        recalcResumo();
    });

    tbody.querySelectorAll('.item-row').forEach(bindRowEvents);
    reindexRows();
    recalcResumo();

    const prioridadeInput = document.getElementById('{{ form.prioridade.id_for_label }}');
    if (prioridadeInput) {
        const prioridadePreview = document.getElementById('prioridade-preview');
        const updatePrioridade = () => {
            prioridadePreview.innerText = prioridadeInput.value ? prioridadeInput.options[prioridadeInput.selectedIndex].text : 'Não definida';
        };
        prioridadeInput.addEventListener('change', updatePrioridade);
        if (prioridadePreview.dataset.inicial) {
            prioridadeInput.value = prioridadePreview.dataset.inicial;
        }
        updatePrioridade();
    }

    const dataInput = document.getElementById('{{ form.data_necessidade.id_for_label }}');
    if (dataInput) dataInput.addEventListener('change', () => {
        document.getElementById('data-preview').innerText = dataInput.value || 'a definir';
    });

    const justificativaField = document.getElementById('{{ form.justificativa.id_for_label }}');
    if (justificativaField) {
        justificativaField.setAttribute('maxlength', '600');
        const contador = document.getElementById('justificativa-contagem');
        const updateContagem = () => {
            contador.innerText = `${justificativaField.value.length}/600`;
        };
        justificativaField.addEventListener('input', updateContagem);
        updateContagem();
    }

    // Função para atualizar um select após cadastro
    function atualizarSelect(selectId, novoItem) {
        const select = document.getElementById(selectId);
        if (select && novoItem) {
            // Verificar se já existe
            const existingOption = Array.from(select.options).find(opt => opt.value == novoItem.id);
            if (existingOption) {
                existingOption.selected = true;
            } else {
                // Adicionar nova opção
                const option = document.createElement('option');
                option.value = novoItem.id;
                option.text = novoItem.nome || novoItem.text;
                option.selected = true;
                select.appendChild(option);
            }
            select.dispatchEvent(new Event('change'));
        }
    }

    // Cadastro Rápido - Setor
    document.getElementById('formCadastroSetor')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('propriedade_id', {{ propriedade.id }});

        try {
            const response = await fetch('{% url "cadastro_rapido_setor" propriedade.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            const data = await response.json();
            
            if (data.success) {
                atualizarSelect('id_setor', {id: data.id, nome: data.nome});
                bootstrap.Modal.getInstance(document.getElementById('modalCadastroSetor')).hide();
                this.reset();
            } else {
                alert('Erro ao cadastrar: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao cadastrar setor: ' + error.message);
        }
    });

    // Cadastro Rápido - Equipamento
    document.getElementById('formCadastroEquipamento')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('propriedade_id', {{ propriedade.id }});

        try {
            const response = await fetch('{% url "cadastro_rapido_equipamento" propriedade.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            const data = await response.json();
            
            if (data.success) {
                atualizarSelect('id_equipamento', {id: data.id, nome: data.nome});
                bootstrap.Modal.getInstance(document.getElementById('modalCadastroEquipamento')).hide();
                this.reset();
            } else {
                alert('Erro ao cadastrar: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao cadastrar equipamento: ' + error.message);
        }
    });

    // Cadastro Rápido - Centro de Custo
    document.getElementById('formCadastroCentroCusto')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('propriedade_id', {{ propriedade.id }});

        try {
            const response = await fetch('{% url "cadastro_rapido_centro_custo" propriedade.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            const data = await response.json();
            
            if (data.success) {
                atualizarSelect('id_centro_custo', {id: data.id, nome: data.nome});
                bootstrap.Modal.getInstance(document.getElementById('modalCadastroCentroCusto')).hide();
                this.reset();
            } else {
                alert('Erro ao cadastrar: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao cadastrar centro de custo: ' + error.message);
        }
    });

    // Cadastro Rápido - Plano de Conta
    document.getElementById('formCadastroPlanoConta')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('propriedade_id', {{ propriedade.id }});

        try {
            const response = await fetch('{% url "cadastro_rapido_plano_conta" propriedade.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            const data = await response.json();
            
            if (data.success) {
                atualizarSelect('id_plano_conta', {id: data.id, nome: data.codigo + ' - ' + data.nome});
                bootstrap.Modal.getInstance(document.getElementById('modalCadastroPlanoConta')).hide();
                this.reset();
            } else {
                alert('Erro ao cadastrar: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao cadastrar plano de conta: ' + error.message);
        }
    });
})();
</script>
<style>
    .action-bar {
        position: sticky;
        bottom: 0;
        z-index: 1020;
    }
    #itens-table .form-control {
        min-width: 0;
    }
    #itens-table .item-row td {
        vertical-align: middle;
    }
</style>
{% endblock %}

