{% extends "base_modulos_unificado.html" %}
<!-- Curral Inteligente 3.0 - Design Premium Baseado na Referência -->
<!-- Criado em {{ "now"|date:"Y-m-d H:i:s" }} -->

{% block title %}Curral Inteligente 3.0 · {{ propriedade.nome_propriedade }}{% endblock %}

{% block extra_css %}
<style>
  /* ========== ESCONDER MENU LATERAL E OCUPAR TELA INTEIRA ========== */
  /* Regras com máxima especificidade para garantir que funcionem */
  html body.curral-v3,
  body.curral-v3 {
    overflow-x: hidden !important;
    max-width: 100vw;
  }
  
  .curral-v3-content {
    max-width: 100%;
    overflow-x: hidden;
  }
  
  /* Esconder sidebar completamente */
  html body.curral-v3 nav.sidebar,
  body.curral-v3 nav.sidebar,
  html body.curral-v3 .sidebar,
  body.curral-v3 .sidebar,
  nav.sidebar {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    opacity: 0 !important;
    position: absolute !important;
    left: -9999px !important;
  }
  
  /* Main content ocupar toda a largura */
  html body.curral-v3 main.main-content,
  body.curral-v3 main.main-content,
  html body.curral-v3 .main-content,
  body.curral-v3 .main-content,
  main.main-content {
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  /* Esconder botão menu mobile */
  html body.curral-v3 .btn-menu-mobile,
  body.curral-v3 .btn-menu-mobile,
  .btn-menu-mobile {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
  
  /* Header fixo ocupar toda a largura */
  html body.curral-v3 .header-fixo,
  body.curral-v3 .header-fixo,
  .header-fixo {
    margin-left: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Esconder overlay do sidebar */
  html body.curral-v3 .sidebar-overlay,
  body.curral-v3 .sidebar-overlay,
  .sidebar-overlay {
    display: none !important;
    visibility: hidden !important;
  }
  
  /* Garantir que o wrapper ocupe toda a tela */
  html body.curral-v3 .curral-v3-wrapper,
  body.curral-v3 .curral-v3-wrapper {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  /* ========== DESIGN PREMIUM CURRAL 3.0 - BASEADO NA REFERÊNCIA ========== */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
  
  :root {
    --primary: #1e88e5;
    --primary-dark: #1565c0;
    --primary-light: #42a5f5;
    --secondary: #8b5cf6;
    --accent: #ec4899;
    --success: #43a047;
    --warning: #fb8c00;
    --danger: #e53935;
    --info: #3b82f6;
    
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #ffffff;
    --bg-light: #f5f7fa;
    --bg-header: #1976d2;
    
    --text-primary: #212121;
    --text-secondary: #757575;
    --text-light: #94a3b8;
    --text-white: #ffffff;
    
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    
    --radius: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body.curral-v3 {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  .curral-v3-wrapper {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  /* ========== HEADER SUPERIOR ========== */
  .curral-v3-header {
    background: var(--bg-header);
    color: var(--text-white);
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-md);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 10000;
    backdrop-filter: blur(10px);
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  }

  .curral-v3-header-left {
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }

  .curral-v3-header-title {
    font-size: 2.75rem;
    font-weight: 900;
    margin: 0;
    line-height: 1.2;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    color: var(--text-white);
  }

  .curral-v3-header-fazenda {
    font-size: 1.25rem;
    opacity: 1;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    color: var(--text-white);
    letter-spacing: 0.5px;
  }

  .curral-v3-header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .status-conexao {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius);
    font-size: 0.875rem;
  }

  .status-conexao-badge {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .sessao-ativa-box {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 12px 16px;
    border-radius: var(--radius);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .sessao-ativa-linha1 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: nowrap;
  }

  .sessao-ativa-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 0;
  }

  .sessao-ativa-titulo {
    font-size: 0.7rem;
    opacity: 0.95;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .sessao-ativa-nome {
    font-size: 0.8rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sessao-ativa-stats {
    display: flex;
    gap: 12px;
    font-size: 0.7rem;
    margin: 0;
    flex-shrink: 0;
  }

  .sessao-stat-item {
    text-align: center;
    min-width: 45px;
  }

  .sessao-stat-valor {
    font-size: 0.95rem;
    font-weight: 700;
    display: block;
    line-height: 1.2;
  }

  .sessao-stat-label {
    font-size: 0.65rem;
    opacity: 0.85;
    margin-top: 2px;
  }

  .sessao-ativa-linha2 {
    display: flex;
    justify-content: flex-end;
    width: 100%;
  }

  .btn-relatorios {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: var(--primary);
    border: 3px solid rgba(255, 255, 255, 0.8);
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 1.125rem;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    min-width: 180px;
    justify-content: center;
  }

  .btn-relatorios:hover {
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 0.8);
  }
  
  .btn-relatorios:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }

  .btn-encerrar {
    background: var(--danger);
    border: none;
    color: var(--text-white);
    padding: 6px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-encerrar:hover {
    background: #c62828;
    transform: translateY(-1px);
  }

  .btn-criar-sessao {
    background: #4caf50;
    border: none;
    color: var(--text-white);
    padding: 6px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-criar-sessao:hover {
    background: #43a047;
    transform: translateY(-1px);
  }

  /* ========== CONTEÚDO PRINCIPAL ========== */
  .curral-v3-content {
    padding: 16px;
    padding-top: 60px; /* Espaço para o header fixo reduzido */
    display: grid;
    grid-template-columns: 1.6fr 1.2fr 0.8fr;
    gap: 24px;
  }

  /* ========== RESPONSIVIDADE ========== */
  @media (max-width: 1400px) {
    .curral-v3-content {
      grid-template-columns: 1.4fr 1fr 0.7fr;
      gap: 20px;
      padding: 20px;
      padding-top: 60px;
    }
  }

  @media (max-width: 1200px) {
    .curral-v3-content {
      grid-template-columns: 1fr 0.9fr;
      grid-template-rows: auto auto auto 1fr;
      padding-top: 60px;
    }
    
    .card-pesagem {
      grid-column: 1 / -1;
      max-width: 100%;
    }
  }

  @media (max-width: 992px) {
    .curral-v3-content {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      padding-top: 60px;
    }
    
    .scanner-animal-resumo {
      padding: 16px;
    }
    
    .card-pesagem {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .curral-v3-content {
      padding: 12px;
      padding-top: 60px;
      gap: 12px;
    }
    
    .scanner-animal-resumo {
      padding: 12px;
      margin-top: 12px;
    }
    
    .resumo-label {
      font-size: 0.875rem;
      width: 35%;
    }
    
    .resumo-value {
      font-size: 0.9375rem;
    }
    
    .resumo-value.resumo-sisbov,
    td.resumo-value.resumo-sisbov,
    #scannerSisbovV3.resumo-sisbov {
      font-size: 1.1rem !important;
    }
    
    .resumo-value.resumo-numero-manejo,
    td.resumo-value.resumo-numero-manejo,
    #scannerNumeroManejoV3.resumo-numero-manejo {
      font-size: 1.5rem !important;
    }
    
    .resumo-value.resumo-codigo-eletronico,
    td.resumo-value.resumo-codigo-eletronico,
    #scannerCodigoEletronicoV3.resumo-codigo-eletronico {
      font-size: 1.25rem !important;
      font-weight: 700 !important;
      color: var(--text-primary) !important;
    }
  }

  @media (max-width: 576px) {
    .curral-v3-content {
      padding: 8px;
      padding-top: 60px;
      gap: 8px;
    }
    
    .scanner-animal-resumo {
      padding: 10px;
    }
    
    .resumo-label {
      font-size: 0.75rem;
      padding-right: 8px;
    }
    
    .resumo-value {
      font-size: 0.875rem;
    }
    
    .resumo-input {
      font-size: 0.875rem;
      padding: 6px 10px;
    }
  }

  /* ========== CARD IDENTIFICAÇÃO E PESAGEM ========== */
  .card-curral {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 2px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.2s;
  }
  
  .card-curral:hover {
    box-shadow: var(--shadow-xl);
    border-color: rgba(30, 136, 229, 0.2);
    transform: translateY(-2px);
  }

  .card-pesagem {
    max-width: 90%;
    margin: 0 auto;
  }

  .card-curral-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    padding: 12px 16px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-curral-header h2 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-curral-body {
    padding: 16px;
  }

  .scanner-brinco-input {
    margin-bottom: 14px;
  }

  .scanner-brinco-input label {
    display: block;
    font-size: 0.875rem;
    font-weight: 800;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 10px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .scanner-brinco-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .scanner-brinco-input input {
    flex: 1;
    padding: 14px 18px;
    border: 3px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius);
    font-size: 1.125rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    transition: all 0.2s;
    background: #ffffff;
    color: var(--text-primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .scanner-brinco-input input:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    transform: translateY(-2px);
  }
  
  .scanner-brinco-input input:hover {
    border-color: rgba(30, 136, 229, 0.5);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  }

  .btn-buscar {
    background: var(--primary);
    color: var(--text-white);
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-buscar:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .scanner-animal-resumo {
    margin-top: 14px;
    padding: 16px;
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(76, 175, 80, 0.3);
  }

  .scanner-animal-resumo table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
  }

  .scanner-animal-resumo table tr {
    border-bottom: 1px solid rgba(44, 62, 45, 0.2); /* Linha mais visível com verde escuro */
  }

  .scanner-animal-resumo table tr:last-child {
    border-bottom: none;
  }

  .scanner-animal-resumo table td {
    padding: 8px 8px;
    vertical-align: middle;
  }

  .resumo-item {
    display: table-row;
  }

  .resumo-label {
    font-size: 1.0625rem;
    color: #1a1a1a; /* Preto forte para máxima visibilidade */
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: 40%;
    padding-right: 16px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .resumo-value {
    font-size: 1rem;
    color: #1a1a1a; /* Preto forte para máxima visibilidade */
    font-weight: 700;
    text-align: right;
  }

  .resumo-value.resumo-sisbov,
  td.resumo-value.resumo-sisbov,
  #scannerSisbovV3.resumo-sisbov {
    font-size: 1.25rem !important;
    color: #2196F3 !important;
    font-weight: 700 !important;
  }

  .resumo-value.resumo-numero-manejo,
  td.resumo-value.resumo-numero-manejo,
  #scannerNumeroManejoV3.resumo-numero-manejo {
    font-size: 1.75rem !important;
    color: #4CAF50 !important;
    font-weight: 700 !important;
  }

  .resumo-input {
    width: 100%;
    background: #ffffff;
    border: 3px solid rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    padding: 10px 14px;
    color: #1a1a1a;
    font-size: 1rem;
    font-weight: 700;
    text-align: right;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .resumo-input:focus {
    outline: none;
    background: #ffffff;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }
  
  .resumo-input:hover {
    border-color: rgba(30, 136, 229, 0.4);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
  }

  .resumo-input::placeholder {
    color: rgba(26, 26, 26, 0.5); /* Placeholder mais escuro */
  }

  .resumo-input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0); /* Ícone preto no fundo claro */
    cursor: pointer;
    opacity: 0.7;
  }

  .resumo-input[type="date"]::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
  }

  /* ========== CARD PESAGEM ========== */
  .peso-display-v2 {
    text-align: center;
  }

  .peso-display-v2-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
  }

  .peso-display-v2-input-wrapper {
    position: relative;
    margin-bottom: 20px;
  }

  .peso-display-v2-input {
    width: 100%;
    padding: 16px 20px;
    font-size: 2.5rem;
    font-weight: 900;
    text-align: center;
    border: 4px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    transition: all 0.3s;
    letter-spacing: 0.05em;
    height: auto;
    min-height: 80px;
    color: var(--text-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .peso-display-v2-input:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 5px;
    box-shadow: 0 0 0 8px rgba(30, 136, 229, 0.25), 0 6px 20px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    color: var(--primary);
    transform: translateY(-3px);
    text-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
  }
  
  .peso-display-v2-input:hover {
    border-color: rgba(30, 136, 229, 0.5);
    box-shadow: 0 5px 16px rgba(0, 0, 0, 0.15);
  }

  .peso-display-v2-unit {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .peso-display-v2-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .btn-gravar {
    flex: 1;
    background: var(--success);
    color: var(--text-white);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-gravar:hover {
    background: #388e3c;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-limpar {
    background: var(--danger);
    color: var(--text-white);
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-limpar:hover {
    background: #c62828;
  }

  .btn-finalizar {
    width: 100%;
    background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
    color: var(--text-white);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-finalizar:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .peso-display-v2-info {
    text-align: left;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .peso-info-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    font-size: 1.125rem;
  }

  .peso-info-label {
    color: var(--text-secondary);
    font-weight: 700;
    font-size: 1.125rem;
  }

  .peso-info-value {
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1.25rem;
  }
  
  /* Estilo especial para Ganho Total */
  #pesoGanhoTotalV3 {
    font-weight: 900;
    font-size: 1.35rem;
  }
  
  #pesoGanhoTotalV3.ganho-positivo {
    color: #4CAF50;
  }
  
  #pesoGanhoTotalV3.ganho-negativo {
    color: #F44336;
  }

  /* ========== CARDS DE ESTATÍSTICAS ========== */
  .stats-grid-v3 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* Tabela de Estatísticas */
  .stats-table-v3 {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .stats-table-v3 table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
  }

  .stats-table-v3 thead {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }

  .stats-table-v3 th {
    padding: 18px 24px;
    text-align: left;
    font-size: 1rem;
    font-weight: 900;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-right: 1px solid rgba(0, 0, 0, 0.05);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .stats-table-v3 th:last-child {
    border-right: none;
  }

  .stats-table-v3 tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background-color 0.2s;
  }

  .stats-table-v3 tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .stats-table-v3 tbody tr:last-child {
    border-bottom: none;
  }

  .stats-table-v3 td {
    padding: 16px 24px;
    vertical-align: middle;
    border-bottom: 2px solid rgba(0, 0, 0, 0.08);
  }
  
  .stats-table-v3 tbody tr:last-child td {
    border-bottom: none;
  }

  .stat-cell-label {
    font-size: 1.125rem;
    font-weight: 800;
    color: var(--text-primary);
    padding: 14px 20px;
    vertical-align: middle;
    letter-spacing: 0.3px;
  }

  .stat-cell-value {
    font-size: 1.75rem;
    font-weight: 900;
    text-align: center;
    min-width: 120px;
    padding: 14px 20px;
    vertical-align: middle;
    letter-spacing: 0.5px;
  }

  .stat-cell-value.purple { color: #8b5cf6; }
  .stat-cell-value.pink { color: #ec4899; }
  .stat-cell-value.blue { color: #3b82f6; }
  .stat-cell-value.green { color: #43a047; }

  /* ========== CARD MANEJOS ========== */
  .manejos-selecionados {
    min-height: 200px;
  }
  
  .manejos-lista {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  
  .manejo-item-card {
    background: var(--bg-light);
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
    position: relative;
  }
  
  .manejo-item-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  
  .manejo-item-card.pesagem { border-left: 4px solid #43a047; }
  .manejo-item-card.vacinacao { border-left: 4px solid #3b82f6; }
  .manejo-item-card.tratamento { border-left: 4px solid #f59e0b; }
  .manejo-item-card.reproducao { border-left: 4px solid #ec4899; }
  .manejo-item-card.diagnostico { border-left: 4px solid #8b5cf6; }
  
  .manejo-item-info {
    flex: 1;
  }
  
  .manejo-item-titulo {
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
    font-size: 0.9375rem;
  }
  
  .manejo-item-desc {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  .manejo-item-remove {
    background: var(--danger);
    color: var(--text-white);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .manejo-item-remove:hover {
    background: #c62828;
    transform: scale(1.1);
  }
  
  .manejos-acoes {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  
  .btn-manejo-tipo {
    padding: 10px 20px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    background: var(--bg-card);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }
  
  .btn-manejo-tipo:hover {
    border-color: var(--primary);
    background: rgba(30, 136, 229, 0.05);
    transform: translateY(-2px);
  }
  
  .btn-manejo-tipo.pesagem { border-color: #43a047; color: #43a047; }
  .btn-manejo-tipo.vacinacao { border-color: #3b82f6; color: #3b82f6; }
  .btn-manejo-tipo.tratamento { border-color: #f59e0b; color: #f59e0b; }
  .btn-manejo-tipo.reproducao { border-color: #ec4899; color: #ec4899; }
  .btn-manejo-tipo.diagnostico { border-color: #8b5cf6; color: #8b5cf6; }
  .btn-manejo-tipo.movimentacao { border-color: #06b6d4; color: #06b6d4; }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state-text {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .empty-state-hint {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* ========== TABELA ESTATÍSTICAS DE LOTES ========== */
  .estatisticas-lotes {
    grid-column: 1 / -1;
    margin-top: 24px;
  }

  .table-wrapper-estatisticas-lotes {
    max-height: calc(4 * 54px + 60px); /* 4 linhas (18px padding * 2 + 18px conteúdo) + cabeçalho */
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-track {
    background: var(--bg-light);
    border-radius: 4px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-thumb {
    background: var(--text-secondary);
    border-radius: 4px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-thumb:hover {
    background: var(--text-primary);
  }

  .table-estatisticas-lotes {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    background: var(--bg-card);
  }

  .table-estatisticas-lotes thead {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .table-estatisticas-lotes thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--text-white);
    border-bottom: 3px solid rgba(0, 0, 0, 0.1);
  }

  .table-estatisticas-lotes th {
    padding: 18px 16px;
    text-align: left;
    font-weight: 700;
    color: var(--text-white);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    border-right: 1px solid rgba(255, 255, 255, 0.25);
    white-space: nowrap;
  }

  .table-estatisticas-lotes th:last-child {
    border-right: none;
  }

  .table-estatisticas-lotes tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    background: var(--bg-card);
  }

  .table-estatisticas-lotes tbody tr:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    transform: translateX(3px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .table-estatisticas-lotes tbody tr:last-child {
    border-bottom: none;
  }

  .table-estatisticas-lotes td {
    padding: 18px 16px;
    vertical-align: middle;
    border-right: 1px solid rgba(0, 0, 0, 0.05);
  }

  .table-estatisticas-lotes td:last-child {
    border-right: none;
  }

  .table-estatisticas-lotes tbody tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.015);
  }

  .table-estatisticas-lotes tbody tr:nth-child(even):hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
  }

  .table-estatisticas-lotes .empty-state {
    padding: 60px 20px;
  }

  /* ========== TABELA ANIMAIS ========== */
  .animais-registrados {
    grid-column: 1 / -1;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .table-animais {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .table-animais thead {
    background: var(--bg-light);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }

  .table-animais th {
    padding: 12px;
    text-align: left;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .table-animais td {
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .table-animais tbody tr:hover {
    background: var(--bg-light);
  }
  
  /* Linhas ocultas da tabela de animais */
  .table-animais tbody tr.animal-oculto {
    display: none;
  }
  
  .table-animais.expandida tbody tr.animal-oculto {
    display: table-row;
  }

  /* ========== MODAL ========== */
  .modal-v3-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 10000;
    display: none;
    align-items: flex-start;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    overflow-y: auto;
    padding: 20px;
    padding-top: 20px;
    box-sizing: border-box;
  }

  .modal-v3-overlay.show {
    display: flex;
    opacity: 1;
  }
  
  .modal-v3-overlay.show .modal-v3 {
    transform: scale(1);
    margin-top: 5px;
  }

  /* Modal de Configuração de Pesagem */
  .modal-config-pesagem {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .modal-config-pesagem.show {
    display: flex;
    opacity: 1;
  }
  
  .modal-config-pesagem-content {
    background: white;
    border-radius: 16px;
    max-width: 1000px;
    width: 95%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
  }
  
  .modal-config-pesagem.show .modal-config-pesagem-content {
    transform: scale(1);
  }
  
  .modal-config-pesagem-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
  }
  
  .modal-config-pesagem-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .modal-config-pesagem-body {
    padding: 32px;
    display: flex;
    flex-direction: column;
    gap: 28px;
    max-height: calc(90vh - 200px);
    overflow-y: auto;
  }
  
  .modal-config-pesagem-body::-webkit-scrollbar {
    width: 8px;
  }
  
  .modal-config-pesagem-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .modal-config-pesagem-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }
  
  .modal-config-pesagem-body::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  .modal-config-pesagem-footer {
    padding: 20px 32px;
    border-top: 2px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(to bottom, #f9f9f9, #f5f5f5);
    border-radius: 0 0 12px 12px;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .config-pesagem-section {
    background: #ffffff;
    border: 2px solid #e8e8e8;
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
  }
  
  .config-pesagem-section:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
  }
  
  .config-pesagem-section-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1.25rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .config-pesagem-section-title i {
    margin-right: 10px;
    color: #667eea;
    font-size: 1.5rem;
  }
  
  .config-pesagem-select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    background: white;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }
  
  .config-pesagem-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .config-pesagem-select:hover {
    border-color: #667eea;
  }
  
  .config-pesagem-desc {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.6;
    margin: 0;
  }
  
  .config-pesagem-option {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .config-pesagem-checkbox {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 12px;
    border-radius: 8px;
    transition: background 0.2s;
  }
  
  .config-pesagem-checkbox:hover {
    background: #f5f5f5;
  }
  
  .config-pesagem-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
  }
  
  .config-pesagem-checkbox-label {
    font-weight: 600;
    color: #333;
    font-size: 1rem;
  }
  
  .btn-add-aparte {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
  }
  
  .btn-add-aparte:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
  }
  
  .btn-add-aparte:active {
    transform: translateY(0);
  }
  
  .lista-apartacoes {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }
  
  .linha-apartacao {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 16px;
    background: #f9f9f9;
    border: 2px solid #e8e8e8;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  
  .linha-apartacao:hover {
    border-color: #667eea;
    background: #f5f5ff;
  }
  
  .linha-apartacao input,
  .linha-apartacao select {
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .linha-apartacao input:focus,
  .linha-apartacao select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .btn-remover-aparte {
    background: #f44336;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
  }
  
  .btn-remover-aparte:hover {
    background: #d32f2f;
    transform: scale(1.1);
  }
  
  .btn-cancelar {
    background: #f5f5f5;
    color: #666;
    border: 2px solid #e0e0e0;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-cancelar:hover {
    background: #e8e8e8;
    border-color: #ccc;
  }
  
  .btn-salvar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-salvar:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
  }
  
  .btn-salvar:active {
    transform: translateY(0);
  }
  
  .config-pesagem-info-box {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 4px solid #2196F3;
    padding: 16px;
    border-radius: 8px;
    margin-top: 16px;
  }
  
  .config-pesagem-info-box strong {
    color: #1565c0;
    display: block;
    margin-bottom: 8px;
    font-size: 0.95rem;
  }
  
  .config-pesagem-info-box p {
    color: #1976d2;
    font-size: 0.875rem;
    margin: 0;
    line-height: 1.6;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: white;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
  }
  
  .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  /* ========== POPUP DE APARTAÇÃO ========== */
  .popup-apartacao {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    z-index: 10001;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .popup-apartacao.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }
  
  .popup-apartacao-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
    min-width: 400px;
    max-width: 500px;
  }
  
  .popup-apartacao-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
  }
  
  .popup-apartacao-header i {
    font-size: 2rem;
    opacity: 0.9;
  }
  
  .popup-apartacao-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .popup-apartacao-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .popup-apartacao-info {
    display: flex;
    gap: 24px;
    margin-bottom: 16px;
  }
  
  .popup-apartacao-animal,
  .popup-apartacao-peso {
    flex: 1;
  }
  
  .popup-label {
    display: block;
    font-size: 0.875rem;
    opacity: 0.8;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .popup-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
  }
  
  .popup-apartacao-resultado {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    backdrop-filter: blur(10px);
  }
  
  .popup-apartacao-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  .popup-apartacao-badge i {
    font-size: 2.5rem;
  }
  
  .popup-apartacao-faixa {
    font-size: 1rem;
    opacity: 0.9;
  }
  
  .popup-apartacao-footer {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 2px solid rgba(255, 255, 255, 0.3);
    text-align: center;
  }
  
  .popup-apartacao-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.875rem;
    opacity: 0.8;
  }
  
  .popup-apartacao-timer i {
    font-size: 1rem;
  }

  .modal-v3 {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s;
    margin: 0 auto;
    margin-top: 5px;
  }
  
  /* ========== ESTILOS ESPECÍFICOS DOS MODAIS ========== */
  
  /* Modal de Criar Sessão */
  #modalCriarSessao .modal-v3 {
    max-width: 600px;
  }
  
  /* Modal de Encerrar Sessão */
  #modalEncerrarSessao .modal-v3 {
    max-width: 500px;
  }
  
  #modalEncerrarSessao .modal-v3-header {
    background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
    color: white;
  }
  
  #modalEncerrarSessao .modal-v3-title {
    color: white;
  }
  
  #modalEncerrarSessao .modal-v3-close {
    color: white;
    opacity: 0.9;
  }
  
  #modalEncerrarSessao .modal-v3-close:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.2);
  }
  
  .btn-v3-danger {
    background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-v3-danger:hover {
    background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }
  
  /* Modal específico de cadastro em paisagem */
  #modalCadastroEstoque .modal-v3 {
    max-width: 850px;
    width: 85%;
    max-height: 92vh;
    margin-top: 5px;
  }

  .cadastro-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }

  .cadastro-data-full {
    grid-column: 1 / -1;
  }
  
  /* Header do brinco em layout horizontal */
  .cadastro-header-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 12px 14px;
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
    border: 2px solid var(--primary);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    align-items: center;
  }
  
  .cadastro-header-item {
    text-align: center;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .cadastro-header-label {
    font-size: 0.7rem;
    color: var(--primary-dark);
    margin-bottom: 6px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .cadastro-header-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-dark);
    letter-spacing: 1px;
    word-break: break-all;
    line-height: 1.2;
  }
  
  .cadastro-header-item:first-child .cadastro-header-value {
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: 2px;
  }
  
  .cadastro-header-item small {
    margin-top: 3px !important;
    font-size: 0.6rem !important;
    line-height: 1.2;
  }

  @media (max-width: 1400px) {
    .modal-v3 {
      max-width: 90%;
      width: 90%;
    }
  }

  @media (max-width: 992px) {
    .modal-v3-overlay {
      padding: 10px;
    }
    
    #modalCadastroEstoque .modal-v3 {
      max-width: 95%;
      width: 95%;
      margin: 10px;
    }
    
    .modal-v3-header {
      padding: 16px 20px;
    }
    
    .modal-v3-title {
      font-size: 1.1rem;
    }
    
    .cadastro-form-grid {
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .cadastro-header-info {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .cadastro-header-value {
      font-size: 1.3rem;
    }
    
    .cadastro-header-item:first-child .cadastro-header-value {
      font-size: 1.8rem;
    }
  }

  @media (max-width: 768px) {
    .modal-v3-overlay {
      padding: 0;
    }
    
    .modal-v3 {
      max-width: 100%;
      width: 100%;
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
    }
    
    .modal-v3-header {
      padding: 14px 16px;
    }
    
    .modal-v3-title {
      font-size: 1rem;
    }
    
    .modal-v3-body {
      padding: 16px !important;
    }
    
    .cadastro-form-grid {
      grid-template-columns: 1fr !important;
      gap: 12px !important;
    }
    
    .cadastro-data-full {
      grid-column: 1;
    }
    
    /* Manter Idade e Data Nascimento na mesma linha mesmo em mobile */
    .cadastro-form-grid .form-group-v3[style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr 1fr !important;
      display: grid !important;
    }
    
    .modal-v3-footer {
      padding: 12px 16px !important;
      flex-direction: column;
      gap: 8px;
    }
    
    .modal-v3-footer .btn-v3 {
      width: 100%;
    }
  }

  .modal-v3-header {
    padding: 16px 20px;
    background: var(--primary);
    color: var(--text-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  #modalCadastroEstoque .modal-v3-header {
    padding: 12px 16px;
  }

  .modal-v3-title {
    font-size: 1.15rem;
    font-weight: 700;
    margin: 0;
  }
  
  #modalCadastroEstoque .modal-v3-title {
    font-size: 1rem;
  }

  .modal-v3-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: var(--text-white);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .modal-v3-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-v3-body {
    padding: 20px;
  }
  
  #modalCadastroEstoque .modal-v3-body {
    padding: 14px 16px;
  }

  .modal-v3-footer {
    padding: 14px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  #modalCadastroEstoque .modal-v3-footer {
    padding: 10px 16px;
  }

  .form-group-v3 {
    margin-bottom: 16px;
  }
  
  #modalCadastroEstoque .form-group-v3 {
    margin-bottom: 12px;
  }

  .form-label-v3 {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 0.875rem;
  }

  .form-input-v3 {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 500;
    background: #ffffff;
    color: var(--text-primary);
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  #modalCadastroEstoque .form-input-v3 {
    padding: 11px 14px;
    font-size: 0.95rem;
  }

  .form-input-v3:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    transform: translateY(-1px);
  }
  
  .form-input-v3:hover {
    border-color: rgba(30, 136, 229, 0.4);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
  }

  .btn-v3 {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-v3-primary {
    background: var(--primary);
    color: var(--text-white);
  }

  .btn-v3-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-v3-secondary {
    background: var(--bg-light);
    color: var(--text-primary);
    border: 2px solid rgba(0, 0, 0, 0.1);
  }

  .btn-v3-secondary:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  /* ========== TOAST ========== */
  .toast-v3 {
    position: fixed;
    top: 24px;
    right: 24px;
    background: var(--bg-card);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    min-width: 300px;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(400px);
    transition: transform 0.3s;
    border-left: 4px solid var(--primary);
  }

  .toast-v3.show {
    transform: translateX(0);
  }

  .toast-v3-success { border-left-color: var(--success); }
  .toast-v3-error { border-left-color: var(--danger); }
  .toast-v3-warning { border-left-color: var(--warning); }

  /* ========== LOADING ========== */
  .loading-v3 {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10002;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .loading-v3.show {
    display: flex;
  }

  .spinner-v3 {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========== RESPONSIVO ========== */
  @media (max-width: 1400px) {
    .curral-v3-content {
      grid-template-columns: 1fr 1fr;
    }
    
    .animais-registrados {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 768px) {
    .curral-v3-content {
      grid-template-columns: 1fr;
      padding: 16px;
      padding-top: 60px;
    }
    
    .curral-v3-header {
      flex-direction: column;
      gap: 12px;
      align-items: flex-start;
      padding: 16px;
    }
    
    .curral-v3-header-right {
      width: 100%;
      flex-wrap: wrap;
    }
  }
</style>
{% endblock %}

{% block body_attrs %} class="curral-v3"{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-v3" id="loadingV3">
  <div class="spinner-v3"></div>
  <div style="color: white; font-weight: 600;">Processando...</div>
</div>

<!-- Toast Container -->
<div id="toastContainerV3"></div>

<div class="curral-v3-wrapper">
  <!-- Header Superior -->
  <div class="curral-v3-header">
    <div class="curral-v3-header-left">
      <h1 class="curral-v3-header-title">Super Tela</h1>
      <div class="curral-v3-header-fazenda">Monpec - Curral</div>
    </div>
    <div class="curral-v3-header-right">
      <button class="btn-relatorios" id="btnSimulador" style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
        <i class="fas fa-play-circle"></i> Iniciar Simulador
      </button>
      <button class="btn-relatorios" id="btnPararSimulador" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
        <i class="fas fa-stop-circle"></i> Parar Simulador
      </button>
      <button class="btn-relatorios">
        <i class="fas fa-file-alt"></i> Relatórios
      </button>
      <div class="status-conexao">
        <span class="status-conexao-badge"></span>
        <span id="statusConexaoTextoV3">Online</span>
      </div>
      <div class="sessao-ativa-box">
        <!-- Linha 1: Título + Nome + Estatísticas -->
        <div class="sessao-ativa-linha1">
          <div class="sessao-ativa-info">
            <div class="sessao-ativa-titulo">
              <i class="fas fa-circle" style="font-size: 0.4rem; color: #4caf50;"></i>
              Sessão Ativa
            </div>
            <div class="sessao-ativa-nome" id="sessaoAtivaNomeV3">
              {% if sessao_ativa %}{{ sessao_ativa.nome }} {{ super_tela.sessao_data|default:"" }}{% else %}Nenhuma sessão ativa{% endif %}
            </div>
          </div>
          <div class="sessao-ativa-stats" id="sessaoAtivaStatsV3" style="display: {% if sessao_ativa %}flex{% else %}none{% endif %};">
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatEventosV3">{{ stats_sessao.total_eventos|default:0 }}</span>
              <span class="sessao-stat-label">Eventos</span>
            </div>
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatAnimaisV3">{{ stats_sessao.animais_processados|default:0 }}</span>
              <span class="sessao-stat-label">Animais</span>
            </div>
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatPesagensV3">{{ stats_sessao.pesagens|default:0 }}</span>
              <span class="sessao-stat-label">Pesagens</span>
            </div>
          </div>
        </div>
        <!-- Linha 2: Botão Encerrar ou Criar Sessão -->
        {% if sessao_ativa %}
        <div class="sessao-ativa-linha2">
          <button class="btn-encerrar" onclick="encerrarSessaoV3()">
            <i class="fas fa-stop"></i> Encerrar
          </button>
        </div>
        {% else %}
        <div class="sessao-ativa-linha2">
          <button class="btn-criar-sessao" onclick="abrirModalCriarSessao()">
            <i class="fas fa-plus-circle"></i> Criar Nova Sessão
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Conteúdo Principal -->
  <div class="curral-v3-content">
    <!-- Card Identificação e Pesagem -->
    <div class="card-curral">
      <div class="card-curral-header">
        <h2><i class="fas fa-qrcode"></i> Identificação e Pesagem</h2>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
          <span style="font-size: 0.875rem; color: var(--text-primary); font-weight: 600;">Consultar/Cadastrar Bovinos</span>
          <span style="font-size: 0.75rem; color: var(--text-secondary);">Balança conectada</span>
        </div>
      </div>
      <div class="card-curral-body">
        <div class="scanner-brinco-input">
          <label>IDENTIFICAÇÃO DO ANIMAL</label>
          <div style="margin-bottom: 8px; padding: 8px 12px; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; border-radius: 4px;">
            <span style="font-size: 0.875rem; color: var(--text-primary); font-weight: 700;">
              <i class="fas fa-barcode" style="margin-right: 6px;"></i>Leitura de Elemento Identificador
            </span>
          </div>
          <div class="scanner-brinco-input-wrapper">
            <input type="text" id="brincoInputV3" 
                   placeholder="SISBOV, Número de Manejo ou Brinco/Botton RFID - CHIP"
                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); buscarBrincoV3(); }">
            <button class="btn-buscar" id="btnBuscarBrincoV3" onclick="buscarBrincoV3()">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <small style="display: block; margin-top: 8px; color: var(--text-secondary); font-size: 0.75rem;">
            Busque por: <strong>SISBOV</strong> (ID principal), <strong>Número de Manejo</strong> ou <strong>Brinco/Botton RFID - CHIP</strong>
          </small>
        </div>
        
        <div class="scanner-animal-resumo" id="scannerAnimalResumoV3">
          <table>
            <tr class="resumo-item">
              <td class="resumo-label">Número de Manejo:</td>
              <td class="resumo-value resumo-numero-manejo" id="scannerNumeroManejoV3">—</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">SISBOV:</td>
              <td class="resumo-value resumo-sisbov" id="scannerSisbovV3">—</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Brinco/Botton RFID - CHIP:</td>
              <td class="resumo-value resumo-codigo-eletronico" id="scannerCodigoEletronicoV3">—</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Raça / Sexo:</td>
              <td class="resumo-value">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="text" class="resumo-input" id="scannerRacaV3" placeholder="Raça" style="flex: 1;">
                  <select class="resumo-input" id="scannerSexoV3" style="width: 100px;">
                    <option value="">Sexo</option>
                    <option value="F">Fêmea</option>
                    <option value="M">Macho</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Nascimento:</td>
              <td class="resumo-value">
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                  <input type="date" class="resumo-input" id="scannerDataNascV3" style="width: 100%;">
                  <span id="scannerIdadeV3" style="font-size: 0.75rem; color: #2c3e2d; font-weight: 700;">—</span>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Último peso:</td>
              <td class="resumo-value">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" class="resumo-input" id="scannerUltimoPesoV3" placeholder="Peso" step="0.1" min="0" style="flex: 1;">
                  <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">kg</span>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Categoria:</td>
              <td class="resumo-value">
                <input type="text" class="resumo-input" id="scannerCategoriaV3" placeholder="Categoria">
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Pasto/Lote:</td>
              <td class="resumo-value">
                <input type="text" class="resumo-input" id="scannerPastoLoteV3" placeholder="Pasto/Lote">
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Conforme BND:</td>
              <td class="resumo-value">
                <span id="scannerConformeBndV3" class="conforme-bnd-badge" style="
                  display: inline-block;
                  padding: 6px 12px;
                  border-radius: 6px;
                  font-weight: 700;
                  font-size: 0.875rem;
                  text-align: center;
                  min-width: 100px;
                ">—</span>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Card Registro de Pesagem -->
    <div class="card-curral card-pesagem" style="cursor: pointer;">
      <div class="card-curral-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h2><i class="fas fa-weight"></i> Registro de Pesagem</h2>
          <span id="badgeConfigPesagem" class="badge-config-pesagem" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="textoConfigPesagem"></span>
          </span>
        </div>
        <button class="btn-config-pesagem" title="Configurar Pesagem">
          <i class="fas fa-cog"></i>
        </button>
      </div>
      <div class="card-curral-body" onclick="event.stopPropagation();">
        <div class="peso-display-v2">
          <div class="peso-display-v2-label">REGISTRO DE PESAGEM</div>
          <div class="peso-display-v2-input-wrapper">
            <input type="text" id="pesoValorV3" 
                   class="peso-display-v2-input" 
                   placeholder="0,0"
                   inputmode="decimal"
                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); const btn = document.getElementById('pesoGravarBtnV3'); if(btn && !btn.disabled) gravarPesagemV3(); }"
                   disabled>
            <span class="peso-display-v2-unit">kg</span>
          </div>
          <div class="peso-display-v2-buttons">
            <button class="btn-gravar" id="pesoGravarBtnV3" onclick="event.stopPropagation(); gravarPesagemV3()" disabled>
              <i class="fas fa-save"></i> Gravar
            </button>
            <button class="btn-limpar" onclick="event.stopPropagation(); limparPesoV3()">
              <i class="fas fa-eraser"></i> Limpar
            </button>
          </div>
          <button class="btn-finalizar" id="btnFinalizarGravarV3" onclick="event.stopPropagation(); finalizarEGravarV3()" disabled>
            <i class="fas fa-check-double"></i> Finalizar e Gravar
          </button>
          <div class="peso-display-v2-info">
            <div class="peso-info-item">
              <span class="peso-info-label">Peso Registrado:</span>
              <span class="peso-info-value" id="pesoRegistradoV3">—</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Data última pesagem:</span>
              <span class="peso-info-value" id="pesoUltimoDataV3">—</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Dias desde a última:</span>
              <span class="peso-info-value" id="pesoDiasV3">—</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Ganho total:</span>
              <span class="peso-info-value" id="pesoGanhoTotalV3">—</span>
            </div>
            <div class="peso-info-item" style="margin-bottom: 0;">
              <span class="peso-info-label">Ganho diário médio:</span>
              <span class="peso-info-value" id="pesoGanhoDiaV3">—</span>
            </div>
          </div>
          
          <!-- Gráfico de Barras Horizontais - Eficiência de Ganho de Peso -->
          <div class="gauge-container" style="margin-top: 4px; padding-top: 12px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
            <div class="gauge-header" style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: #FFFFFF !important; font-size: 1.3rem !important; font-weight: 600; margin: 0;">
                <i class="fas fa-chart-bar" style="margin-right: 8px;"></i>
                Eficiência de Ganho de Peso
              </h3>
        </div>
            <div class="gauge-wrapper" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
              <!-- Gráfico de Barras Horizontais -->
              <div class="bar-chart-container" id="gaugeChartV3" style="
                position: relative;
                width: 100%;
                max-width: 500px;
                height: 180px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
              ">
                <!-- Barra de progresso horizontal -->
                <div style="position: relative; width: 100%; height: 50px; margin: 40px 0;">
                  <!-- Fundo da barra -->
                  <div style="
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.1);
                    border-radius: 25px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
                  ">
                    <!-- Seção Ruim (vermelho) -->
                    <div style="
                      position: absolute;
                      left: 0;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #FF6B6B 0%, #FF5722 100%);
                      border-radius: 25px 0 0 25px;
                    "></div>
                    
                    <!-- Seção Regular (amarelo) -->
                    <div style="
                      position: absolute;
                      left: 25%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #FFD93D 0%, #FFC107 100%);
                    "></div>
                    
                    <!-- Seção Bom (azul) -->
                    <div style="
                      position: absolute;
                      left: 50%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #4DABF7 0%, #2196F3 100%);
                    "></div>
                    
                    <!-- Seção Ótimo (verde) -->
                    <div style="
                      position: absolute;
                      left: 75%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #69DB7C 0%, #4CAF50 100%);
                      border-radius: 0 25px 25px 0;
                    "></div>
                  </div>
                  
                  <!-- Indicador (marcador) -->
                  <div id="gaugeNeedleV3" style="
                    position: absolute;
                    top: -10px;
                    left: 0%;
                    width: 4px;
                    height: 70px;
                    background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
                    border-radius: 2px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(255, 255, 255, 0.3);
                    transform: translateX(-50%);
                    transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
                    z-index: 10;
                  ">
                    <!-- Seta no topo -->
                    <div style="
                      position: absolute;
                      top: -8px;
                      left: 50%;
                      transform: translateX(-50%);
                      width: 0;
                      height: 0;
                      border-left: 8px solid transparent;
                      border-right: 8px solid transparent;
                      border-top: 12px solid #1a1a1a;
                      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
                    "></div>
                  </div>
                  
                  <!-- Labels nas seções -->
                  <div style="position: absolute; top: 60px; left: 0; width: 100%; display: flex; justify-content: space-between;">
                    <span style="color: #FFFFFF !important; font-size: 18px !important; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Ruim</span>
                    <span style="color: #FFFFFF !important; font-size: 18px !important; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Regular</span>
                    <span style="color: #FFFFFF !important; font-size: 18px !important; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Bom</span>
                    <span style="color: #FFFFFF !important; font-size: 18px !important; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Ótimo</span>
                  </div>
                </div>
                
                <!-- Valor exibido -->
                <div class="gauge-value" id="gaugeValueV3" style="
                  text-align: center;
                  margin-top: 20px;
                  background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
                  color: #FFFFFF;
                  padding: 14px 28px;
                  border-radius: 8px;
                  font-size: 1.5rem;
                  font-weight: 900;
                  min-width: 180px;
                  margin-left: auto;
                  margin-right: auto;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
                  border: 2px solid rgba(255, 255, 255, 0.2);
                  letter-spacing: 1px;
                  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 255, 255, 0.3);
                ">—</div>
              </div>
              
              <!-- Legenda -->
              <div class="gauge-legenda" style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                width: 100%;
                max-width: 400px;
              ">
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #FF6B6B 0%, #FF5722 100%);"></div>
                  <span style="color: #FFFFFF !important; font-size: 1.1rem !important;">Ruim: &lt; 0.4 kg/dia</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #FFD93D 0%, #FFC107 100%);"></div>
                  <span style="color: #FFFFFF !important; font-size: 1.1rem !important;">Regular: 0.4 - 0.7</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #4DABF7 0%, #2196F3 100%);"></div>
                  <span style="color: #FFFFFF !important; font-size: 1.1rem !important;">Bom: 0.7 - 1.0</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #69DB7C 0%, #4CAF50 100%);"></div>
                  <span style="color: #FFFFFF !important; font-size: 1.1rem !important;">Ótimo: &gt; 1.0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de Estatísticas -->
    <div class="stats-table-v3">
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th style="text-align: center; width: 120px;">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; letter-spacing: 0.5px;">Total de Animais</td>
            <td class="stat-cell-value purple" id="statTotalAnimais" style="font-weight: 900; font-size: 2.25rem; letter-spacing: 1px;">0</td>
          </tr>
          <tr style="border-top: 3px solid rgba(0, 0, 0, 0.15);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-tasks" style="margin-right: 10px;"></i> Trabalhados
            </td>
            <td class="stat-cell-value" id="statTrabalhados" style="font-weight: 900; font-size: 2.25rem; letter-spacing: 1px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-mars" style="margin-right: 10px; color: #2196F3;"></i> Machos
            </td>
            <td class="stat-cell-value" id="statMachos" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-venus" style="margin-right: 10px; color: #E91E63;"></i> Fêmeas
            </td>
            <td class="stat-cell-value" id="statFemeas" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-tags" style="margin-right: 10px;"></i> Por Categoria
            </td>
            <td class="stat-cell-value" id="statCategorias" style="font-weight: 800; font-size: 1.5rem; text-align: left; padding-left: 24px; letter-spacing: 0.3px;">—</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-weight" style="margin-right: 10px;"></i> Média de Peso
            </td>
            <td class="stat-cell-value" id="statMediaPeso" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">—</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-balance-scale" style="margin-right: 10px;"></i> Total de Pesagens
            </td>
            <td class="stat-cell-value" id="statTotalPesagens" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-chart-line" style="margin-right: 10px;"></i> Ganho Médio Diário
            </td>
            <td class="stat-cell-value" id="statGanhoMedioDia" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">—</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-arrow-up" style="margin-right: 10px; color: #4CAF50;"></i> Com Ganho Positivo
            </td>
            <td class="stat-cell-value" id="statGanhoPositivo" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px; color: #4CAF50;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-arrow-down" style="margin-right: 10px; color: #F44336;"></i> Com Ganho Negativo
            </td>
            <td class="stat-cell-value" id="statGanhoNegativo" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px; color: #F44336;">0</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-clipboard-list" style="margin-right: 10px;"></i> Total de Manejos
            </td>
            <td class="stat-cell-value" id="statTotalManejos" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr id="statDiagnosticoRow" style="display: none; border-top: 3px solid rgba(0, 0, 0, 0.15);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.25rem; color: rgba(255, 255, 255, 0.95);">
              <i class="fas fa-stethoscope" style="margin-right: 10px;"></i> Diagnóstico Reprodutivo
            </td>
            <td class="stat-cell-value" id="statDiagnostico" style="font-weight: 900; font-size: 1.875rem;">—</td>
          </tr>
          <tr id="statPrenhasRow" style="display: none;">
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.125rem;">
              <i class="fas fa-baby" style="margin-right: 10px; color: #4CAF50;"></i> Prenhas
            </td>
            <td class="stat-cell-value" id="statPrenhas" style="font-weight: 900; font-size: 1.625rem;">0</td>
          </tr>
          <tr id="statVaziasRow" style="display: none;">
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.125rem;">
              <i class="fas fa-circle" style="margin-right: 10px; color: #FF9800;"></i> Vazias
            </td>
            <td class="stat-cell-value" id="statVazias" style="font-weight: 900; font-size: 1.625rem;">0</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Card Manejos Selecionados -->
    <div class="card-curral manejos-selecionados" style="grid-column: 1 / -1;">
      <div class="card-curral-header">
        <h2><i class="fas fa-list"></i> Manejos Selecionados</h2>
        <button onclick="limparTodosManejosV3()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.125rem;" title="Limpar todos os manejos">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="card-curral-body">
        <div id="emptyStateManejosV3" class="empty-state">
          <div class="empty-state-icon">📋</div>
          <div class="empty-state-text">Nenhum manejo selecionado</div>
          <div class="empty-state-hint">Selecione os manejos abaixo para aplicar ao animal</div>
        </div>
        <div id="listaManejosV3" class="manejos-lista" style="display: none;"></div>
        <div class="manejos-acoes">
          <button class="btn-manejo-tipo pesagem" onclick="abrirConfigPesagemEManejo()">
            Pesagem
          </button>
          <button class="btn-manejo-tipo vacinacao" onclick="adicionarManejoV3('VACINACAO', 'Vacinação', 'Aplicar vacina no animal')">
            Vacinação
          </button>
          <button class="btn-manejo-tipo tratamento" onclick="adicionarManejoV3('TRATAMENTO', 'Tratamento', 'Tratamento sanitário')">
            Tratamento
          </button>
          <button class="btn-manejo-tipo reproducao" onclick="adicionarManejoV3('REPRODUCAO', 'Reprodução', 'Protocolo reprodutivo/IATF')">
            Reprodução
          </button>
          <button class="btn-manejo-tipo diagnostico" onclick="adicionarManejoV3('DIAGNOSTICO', 'Diagnóstico', 'Diagnóstico de prenhez')">
            Diagnóstico
          </button>
          <button class="btn-manejo-tipo movimentacao" onclick="adicionarManejoV3('MOVIMENTACAO', 'Movimentação', 'Registrar movimentação do animal')">
            Movimentação
          </button>
        </div>
      </div>
    </div>

    <!-- Popup de Apartação -->
    <div id="popupApartacao" class="popup-apartacao" style="display: none;">
      <div class="popup-apartacao-content">
        <div class="popup-apartacao-header">
          <i class="fas fa-layer-group"></i>
          <h3>Apartação do Animal</h3>
        </div>
        <div class="popup-apartacao-body">
          <div class="popup-apartacao-info">
            <div class="popup-apartacao-animal">
              <span class="popup-label">Animal:</span>
              <span id="popupApartacaoAnimal" class="popup-value">—</span>
            </div>
            <div class="popup-apartacao-peso">
              <span class="popup-label">Peso:</span>
              <span id="popupApartacaoPeso" class="popup-value">—</span>
            </div>
          </div>
          <div class="popup-apartacao-resultado">
            <div class="popup-apartacao-badge" id="popupApartacaoBadge">
              <i class="fas fa-check-circle"></i>
              <span id="popupApartacaoNome">—</span>
            </div>
            <div class="popup-apartacao-faixa" id="popupApartacaoFaixa">
              Faixa: — kg a — kg
            </div>
          </div>
        </div>
        <div class="popup-apartacao-footer">
          <div class="popup-apartacao-timer">
            <i class="fas fa-clock"></i>
            <span id="popupApartacaoTimer">5</span> segundos
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Configuração de Pesagem -->
    <div id="modalConfigPesagem" class="modal-config-pesagem" style="display: none;" onclick="if(event.target === this) fecharModalConfigPesagem();">
      <div class="modal-config-pesagem-content" onclick="event.stopPropagation();">
        <div class="modal-config-pesagem-header">
          <h2><i class="fas fa-weight"></i> Configuração de Pesagem</h2>
          <button type="button" class="modal-close" onclick="fecharModalConfigPesagem()">&times;</button>
        </div>
        <div class="modal-config-pesagem-body">
          <!-- Seleção de Tipo de Pesagem -->
            <div class="config-pesagem-section">
              <div class="config-pesagem-section-title">
              <i class="fas fa-tasks"></i> Tipo de Pesagem
              </div>
            <select id="selectManejoPesagem" class="config-pesagem-select" onchange="atualizarConfigPesagem()">
              <option value="">Selecione um tipo de pesagem...</option>
                <option value="PESAGEM_ROTINA">Pesagem de Rotina</option>
                <option value="PESAGEM_APARTE">Pesagem para Apartação</option>
              </select>
            <div class="config-pesagem-info-box" style="margin-top: 16px;">
              <strong><i class="fas fa-info-circle"></i> Informação</strong>
              <p>
                <strong>Pesagem de Rotina:</strong> Registra todas as pesagens no histórico do animal para acompanhamento de ganho de peso e geração de relatórios.<br>
                <strong>Pesagem para Apartação:</strong> Classifica automaticamente os animais por faixas de peso após a pesagem, facilitando a organização em lotes.
              </p>
            </div>
            </div>

          <!-- Configuração de Pesagem de Rotina -->
            <div id="configPesagemRotina" class="config-pesagem-section" style="display: none;">
              <div class="config-pesagem-section-title">
              <i class="fas fa-history"></i> Configurações de Pesagem de Rotina
              </div>
              <div class="config-pesagem-option">
                <label class="config-pesagem-checkbox">
                  <input type="checkbox" id="checkPesagemRotina" checked>
                  <span class="config-pesagem-checkbox-label">Ativar pesagem de rotina</span>
                </label>
              <p class="config-pesagem-desc">
                Quando ativada, todas as pesagens serão registradas no histórico do animal, permitindo:
              </p>
              <ul style="margin: 12px 0; padding-left: 24px; color: #666; line-height: 1.8;">
                <li>Acompanhamento de ganho de peso ao longo do tempo</li>
                <li>Geração de relatórios de desempenho</li>
                <li>Cálculo automático de ganho diário médio</li>
                <li>Histórico completo de pesagens do animal</li>
              </ul>
            </div>
          </div>

          <!-- Configuração de Pesagem para Apartação -->
          <div id="configPesagemAparte" class="config-pesagem-section" style="display: none;">
              <div class="config-pesagem-section-title">
              <i class="fas fa-layer-group"></i> Configuração de Faixas de Apartação
              <button type="button" class="btn-add-aparte" onclick="adicionarLinhaAparte()" title="Adicionar nova faixa de pesagem">
                <i class="fas fa-plus"></i> Adicionar Faixa
                </button>
              </div>
            <p class="config-pesagem-desc" style="margin-bottom: 20px;">
              Configure as faixas de peso para apartação automática dos animais. Após a pesagem, os animais serão automaticamente classificados nas categorias definidas abaixo. Você pode adicionar múltiplas faixas personalizadas.
            </p>
            
            <!-- Faixas Padrão (pré-configuradas) -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <strong style="color: #333; font-size: 0.95rem;">
                  <i class="fas fa-star" style="color: #ffc107; margin-right: 6px;"></i>
                  Faixas Padrão (Recomendadas)
                </strong>
                <button type="button" onclick="carregarFaixasPadrao()" style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                  <i class="fas fa-magic"></i> Usar Padrão
                </button>
              </div>
            </div>
            
            <div id="listaApartacoes" class="lista-apartacoes">
                <!-- Linhas de apartação serão adicionadas aqui dinamicamente -->
              <div style="text-align: center; padding: 40px 20px; color: #999; font-style: italic;">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.5;"></i>
                <p style="margin: 0;">Nenhuma faixa configurada. Clique em "Adicionar Faixa" para começar.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-config-pesagem-footer">
          <button type="button" class="btn-cancelar" onclick="fecharModalConfigPesagem()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="button" class="btn-salvar" onclick="salvarConfigPesagem()">
            <i class="fas fa-save"></i> Salvar Configuração
          </button>
        </div>
      </div>
    </div>

    <!-- Tabela Animais Registrados -->
    <div class="card-curral animais-registrados">
      <div class="card-curral-header">
        <h2><i class="fas fa-table"></i> Animais Registrados</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="btnExpandirAnimaisV3" onclick="toggleExpandirAnimaisV3()" style="display: none; align-items: center; gap: 6px; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); color: var(--primary); cursor: pointer; font-size: 0.875rem; padding: 6px 12px; border-radius: 4px; font-weight: 600;">
            <i class="fas fa-chevron-down" id="iconExpandirAnimaisV3"></i> <span id="textoExpandirAnimaisV3">Ver todos</span>
          </button>
        <button style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.125rem;">
          <i class="fas fa-trash"></i>
        </button>
        </div>
      </div>
      <div class="card-curral-body">
        <div class="table-wrapper">
          <table class="table-animais">
            <thead>
              <tr>
                <th>Brinco/Botton RFID - CHIP</th>
                <th>SISBOV</th>
                <th>Número de Manejo</th>
                <th>Raça/Sexo</th>
                <th>Nascimento</th>
                <th>Categoria</th>
                <th>Pasto/Lote</th>
                <th>Status BND Sisbov</th>
              </tr>
            </thead>
            <tbody id="tabelaAnimaisV3">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                  <div class="empty-state">
                    <div class="empty-state-icon">🐄</div>
                    <div class="empty-state-text">Nenhum animal registrado ainda</div>
                    <div class="empty-state-hint">Os animais processados aparecerão aqui</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL DE DUPLICIDADE ========== -->
<div class="modal-v3-overlay" id="modalDuplicidade">
  <div class="modal-v3" style="max-width: 700px;">
    <div class="modal-v3-header">
      <h2 class="modal-v3-title">⚠️ Múltiplos Animais Encontrados</h2>
      <button class="modal-v3-close" onclick="fecharModal('modalDuplicidade')">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div style="background: #fff3e0; padding: 16px; border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin-bottom: 20px;">
        <div style="font-size: 0.875rem; color: #e65100; font-weight: 600;">
          <strong>⚠️ Atenção:</strong> Foram encontrados múltiplos animais com o mesmo número de manejo ou código RFID. Selecione o animal correto pelo <strong>SISBOV completo</strong>:
        </div>
      </div>
      
      <div id="listaDuplicidadeAnimais" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: var(--radius);">
        <!-- Lista será preenchida dinamicamente -->
      </div>
      
      <div style="background: #e3f2fd; padding: 12px; border-radius: var(--radius-lg); margin-top: 16px; font-size: 0.875rem; color: #1565c0;">
        <strong>💡 Importante:</strong> O sistema sempre busca pelo SISBOV (ID principal do animal). O número de manejo e o código RFID são identificações auxiliares.
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalDuplicidade')">Cancelar</button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE CRIAR SESSÃO ========== -->
<div class="modal-v3-overlay" id="modalCriarSessao">
  <div class="modal-v3" style="max-width: 600px;">
    <div class="modal-v3-header">
      <h2 class="modal-v3-title"><i class="fas fa-plus-circle"></i> Criar Nova Sessão</h2>
      <button class="modal-v3-close" onclick="fecharModal('modalCriarSessao')">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div style="background: #e3f2fd; padding: 16px; border-radius: var(--radius-lg); border-left: 4px solid var(--primary); margin-bottom: 20px;">
        <div style="font-size: 0.875rem; color: #1565c0; font-weight: 600;">
          <strong>ℹ️ Informação:</strong> Uma sessão permite organizar e agrupar todas as atividades de manejo realizadas em um período específico.
        </div>
      </div>
      
      <div class="form-group-v3">
        <label class="form-label-v3" style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
          Nome da Sessão <span style="color: var(--danger);">*</span>
        </label>
        <input type="text" id="criarSessaoNomeV3" class="form-input-v3" 
               placeholder="Ex.: Pesagem - Desmama" 
               style="font-size: 1rem; padding: 12px 16px;"
               oninput="validarFormularioCriarSessao()">
        <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem;">
          Um nome descritivo ajuda a identificar a sessão posteriormente
        </small>
      </div>

      <div class="form-group-v3">
        <label class="form-label-v3" style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
          Tipo de Trabalho <span style="color: var(--danger);">*</span>
        </label>
        <select id="criarSessaoTipoV3" class="form-input-v3" 
                style="font-size: 1rem; padding: 12px 16px;"
                onchange="validarFormularioCriarSessao()">
          <option value="">Selecione o tipo de trabalho</option>
          <option value="PESAGEM">Pesagem</option>
          <option value="DESMAMA">Desmama</option>
          <option value="VACINACAO">Vacinação</option>
          <option value="TRATAMENTO">Tratamento Sanitário</option>
          <option value="REPRODUCAO">Reprodução</option>
          <option value="APARTACAO">Apartação/Loteamento</option>
          <option value="COLETA_DADOS">Coleta de Dados</option>
          <option value="OUTRO">Outro</option>
        </select>
      </div>

      <div class="form-group-v3">
        <label class="form-label-v3" style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
          Pasto/Lote (Opcional)
        </label>
        <input type="text" id="criarSessaoPastoLoteV3" class="form-input-v3" 
               placeholder="Ex.: Pasto 01 - Lote A" 
               style="font-size: 1rem; padding: 12px 16px;">
      </div>

      <div class="form-group-v3">
        <label class="form-label-v3" style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
          Observações (Opcional)
        </label>
        <textarea id="criarSessaoObservacoesV3" class="form-input-v3" 
                  rows="3" 
                  placeholder="Informações adicionais sobre a sessão..."
                  style="font-size: 1rem; padding: 12px 16px; resize: vertical;"></textarea>
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalCriarSessao')">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button class="btn-v3 btn-v3-primary" id="btnConfirmarCriarSessaoV3" 
              onclick="confirmarCriarSessaoV3()" disabled>
        <i class="fas fa-check"></i> Criar Sessão
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE ENCERRAR SESSÃO ========== -->
<div class="modal-v3-overlay" id="modalEncerrarSessao">
  <div class="modal-v3" style="max-width: 500px;">
    <div class="modal-v3-header" style="background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);">
      <h2 class="modal-v3-title" style="color: white;">
        <i class="fas fa-stop-circle"></i> Encerrar Sessão
      </h2>
      <button class="modal-v3-close" onclick="fecharModal('modalEncerrarSessao')" style="color: white;">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div style="background: #fff3e0; padding: 16px; border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin-bottom: 20px;">
        <div style="font-size: 0.875rem; color: #e65100; font-weight: 600;">
          <strong>⚠️ Atenção:</strong> Ao encerrar a sessão, você não poderá mais adicionar novos registros. Todos os dados já registrados serão preservados.
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
          Resumo da Sessão
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
          <div style="background: #f5f5f5; padding: 16px; border-radius: var(--radius); text-align: center;">
            <div style="font-size: 2rem; font-weight: 900; color: var(--primary);" id="encerrarSessaoEventosV3">0</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px;">Eventos</div>
          </div>
          <div style="background: #f5f5f5; padding: 16px; border-radius: var(--radius); text-align: center;">
            <div style="font-size: 2rem; font-weight: 900; color: var(--success);" id="encerrarSessaoAnimaisV3">0</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px;">Animais</div>
          </div>
          <div style="background: #f5f5f5; padding: 16px; border-radius: var(--radius); text-align: center;">
            <div style="font-size: 2rem; font-weight: 900; color: var(--info);" id="encerrarSessaoPesagensV3">0</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px;">Pesagens</div>
          </div>
        </div>

        <div style="background: #e8f5e9; padding: 12px; border-radius: var(--radius); border-left: 4px solid var(--success);">
          <div style="font-size: 0.875rem; color: #2e7d32; font-weight: 600;">
            <strong>Nome:</strong> <span id="encerrarSessaoNomeV3">—</span>
          </div>
          <div style="font-size: 0.875rem; color: #2e7d32; margin-top: 4px;">
            <strong>Iniciada em:</strong> <span id="encerrarSessaoDataV3">—</span>
          </div>
        </div>
      </div>

      <div style="background: #e3f2fd; padding: 12px; border-radius: var(--radius-lg); margin-bottom: 16px;">
        <div style="font-size: 0.875rem; color: #1565c0; line-height: 1.5;">
          <strong>💡 Dica:</strong> Após encerrar, você poderá visualizar relatórios completos da sessão e iniciar uma nova sessão quando necessário.
        </div>
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalEncerrarSessao')">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button class="btn-v3 btn-v3-danger" onclick="confirmarEncerrarSessaoV3()">
        <i class="fas fa-stop"></i> Sim, Encerrar Sessão
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE CADASTRO DE ESTOQUE ========== -->
<div class="modal-v3-overlay" id="modalCadastroEstoque">
  <div class="modal-v3">
    <div class="modal-v3-header">
      <h2 class="modal-v3-title">➕ Cadastrar Animal do Estoque</h2>
      <button class="modal-v3-close" onclick="fecharModal('modalCadastroEstoque')">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div class="cadastro-header-info">
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">BRINCO NO ESTOQUE</div>
          <div id="cadastroBrincoV3" class="cadastro-header-value">—</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">Número do brinco físico</small>
        </div>
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">SISBOV</div>
          <div id="cadastroSisbovV3" class="cadastro-header-value">—</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">Código completo (15 dígitos)</small>
        </div>
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">NÚMERO DE MANEJO</div>
          <div id="cadastroNumeroManejoV3" class="cadastro-header-value">—</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">6 dígitos (extraído do SISBOV)</small>
        </div>
      </div>
      
      <div class="cadastro-form-grid">
        <!-- Código Eletrônico (RFID) (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">
            <i class="fas fa-microchip" style="margin-right: 6px; color: var(--primary); font-size: 0.9rem;"></i>
            Código Eletrônico (Brinco/Botton RFID - CHIP)
          </label>
          <input type="text" id="cadastroRfidV3" class="form-input-v3" placeholder="Ex.: 900123456789012" autofocus style="font-size: 1rem; font-weight: 600; padding: 12px 16px;">
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; line-height: 1.3;">
            <strong>Opcional:</strong> Código eletrônico do chip RFID do brinco/botton.
            <span style="display: block; margin-top: 2px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.85;">
              SISBOV (15 dígitos) | Manejo (6 dígitos) | RFID (ex: 900123456789012)
            </span>
          </small>
        </div>
        
        <!-- Raça e Sexo (juntos em uma linha) -->
        <div class="form-group-v3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start;">
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0;">Raça *</label>
            <select id="cadastroRacaV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
              <option value="">Selecione</option>
              <option value="NE">NE - Nelore</option>
              <option value="XX">XX - Composto</option>
              <option value="AN">AN - Angus</option>
              <option value="BR">BR - Brahman</option>
              <option value="CA">CA - Canchim</option>
              <option value="GU">GU - Guzerá</option>
              <option value="GI">GI - Gir</option>
              <option value="GN">GN - Girolando</option>
              <option value="HO">HO - Holandês</option>
              <option value="IN">IN - Indubrasil</option>
              <option value="MA">MA - Marchigiana</option>
              <option value="MO">MO - Montana</option>
              <option value="PO">PO - Polled Hereford</option>
              <option value="PR">PR - Pardo Suíço</option>
              <option value="RA">RA - Raça Santa Gertrudis</option>
              <option value="SI">SI - Simental</option>
              <option value="TA">TA - Tabapuã</option>
              <option value="TR">TR - Tricross</option>
              <option value="ZE">ZE - Zebu</option>
              <option value="OT">OT - Outra</option>
            </select>
        </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0;">Sexo *</label>
            <select id="cadastroSexoV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
            <option value="">Selecione</option>
            <option value="F">Fêmea</option>
            <option value="M">Macho</option>
          </select>
        </div>
        </div>
        
        <!-- Idade e Data Nascimento (juntos em uma linha) -->
        <div class="form-group-v3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; grid-column: 1 / -1;">
          <div style="display: flex; flex-direction: column; gap: 6px; min-width: 0;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0; white-space: nowrap;">Idade (meses)</label>
            <input type="number" id="cadastroIdadeV3" class="form-input-v3" placeholder="Ex.: 8" min="0" step="1" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; min-width: 0;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0; white-space: nowrap;">Data Nascimento</label>
            <input type="date" id="cadastroDataNascV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
          </div>
        </div>
        
        <!-- Mãe (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">
            <i class="fas fa-female" style="margin-right: 6px; color: var(--primary); font-size: 0.9rem;"></i>
            Mãe (SISBOV, Manejo ou RFID)
          </label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
            <input type="text" id="cadastroMaeV3" class="form-input-v3" placeholder="Digite o código da mãe e pressione Enter" style="font-size: 1rem; font-weight: 600; padding: 12px 16px; flex: 1;" onkeypress="if(event.key === 'Enter') buscarMaeV3()">
            <button class="btn-buscar" onclick="buscarMaeV3()" style="padding: 12px 20px; white-space: nowrap;">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; line-height: 1.3;">
            <strong>Opcional:</strong> Informe o código da mãe para verificar se há registro de IATF e informações do touro.
          </small>
          <!-- Informações da Mãe e IATF -->
          <div id="infoMaeIATFV3" style="display: none; margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: var(--radius); border-left: 4px solid #4caf50;">
            <div style="font-size: 0.875rem; font-weight: 700; color: #2e7d32; margin-bottom: 8px;">
              <i class="fas fa-check-circle" style="margin-right: 6px;"></i>Informações da Mãe e IATF
            </div>
            <div id="detalhesMaeIATFV3" style="font-size: 0.8rem; color: #1b5e20; line-height: 1.5;">
              <!-- Informações serão preenchidas aqui -->
            </div>
          </div>
        </div>
        
        <!-- Tipo de Registro (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">Tipo de Registro *</label>
          <select id="cadastroTipoRegistroV3" class="form-input-v3" required style="font-size: 1rem; font-weight: 600; padding: 12px 16px;">
            <option value="">Selecione</option>
            <option value="NASCIMENTO">Nascimento</option>
            <option value="DESMAMA">Desmama</option>
          </select>
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;">
            Selecione se o animal está sendo cadastrado por nascimento ou desmama
          </small>
        </div>
      </div>
      
      <div style="background: #fff3e0; padding: 12px 14px; border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin-top: 12px;">
        <div style="font-size: 0.8rem; color: #e65100; font-weight: 600; line-height: 1.4;">
          <strong>💡 Dica:</strong> Informe a idade em meses OU a data de nascimento. O sistema calcula automaticamente o campo que faltar.
        </div>
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalCadastroEstoque')">Cancelar</button>
      <button class="btn-v3 btn-v3-primary" id="btnConfirmarCadastroV3" disabled>Confirmar Cadastro</button>
    </div>
  </div>
</div>

<script>
// ========== CURRAL INTELIGENTE 3.0 - SCRIPT COMPLETO ==========

// Definir função do simulador globalmente ANTES do IIFE para garantir disponibilidade
// Definir stub inicial do executarSimulador para evitar erro de "não carregado"
window.executarSimulador = async function() {
  console.warn('⚠️ executarSimulador ainda não foi completamente carregado. Aguarde...');
  alert('Simulador ainda está carregando. Aguarde alguns segundos e tente novamente.');
  return false;
};

// Definir stub inicial do pararSimulador
window.pararSimulador = function() {
  console.warn('⚠️ pararSimulador ainda não foi completamente carregado.');
  // simuladorAtivo será definido mais tarde dentro do IIFE
  // Por enquanto, apenas retornar false
  return false;
};

// Variável global para controlar estado do simulador (definida antes do IIFE)
window.simuladorAtivo = false;

window.iniciarSimulador = function() {
  console.log('🔵 window.iniciarSimulador chamado');
  console.log('🔍 window.executarSimulador disponível?', typeof window.executarSimulador);
  console.log('🔍 window.executarSimulador.toString().includes("stub")?', window.executarSimulador.toString().includes('Aguarde'));
  
  // Verificar se ainda é a versão stub
  const isStub = window.executarSimulador.toString().includes('Aguarde') || 
                 window.executarSimulador.toString().includes('não foi completamente carregado');
  
  if (isStub) {
    console.warn('⚠️ executarSimulador ainda é stub, aguardando versão completa...');
    let tentativas = 0;
    const maxTentativas = 30; // 15 segundos (30 * 500ms)
    
    const verificar = setInterval(function() {
      tentativas++;
      const aindaStub = window.executarSimulador.toString().includes('Aguarde') || 
                       window.executarSimulador.toString().includes('não foi completamente carregado');
      
      if (!aindaStub && typeof window.executarSimulador === 'function') {
        clearInterval(verificar);
        console.log('✅ executarSimulador agora está completamente carregado!');
        window.iniciarSimulador(); // Chamar novamente agora que está disponível
      } else if (tentativas >= maxTentativas) {
        clearInterval(verificar);
        console.error('❌ executarSimulador não carregou completamente após ' + maxTentativas + ' tentativas');
        alert('Simulador ainda não carregou completamente após ' + (maxTentativas * 0.5) + ' segundos.\n\n' +
              'Recarregue a página (F5) e tente novamente.\n\n' +
              'Se o problema persistir, verifique o console do navegador para erros.');
      } else if (tentativas % 5 === 0) {
        console.log(`⏳ Tentativa ${tentativas}/${maxTentativas} - ainda aguardando executarSimulador completo...`);
      }
    }, 500); // Verificar a cada 500ms
    
    return; // Sair da função e aguardar
  }
  
  // Se chegou aqui, a função completa está disponível
  const mensagem = 'Deseja iniciar o simulador de pesagem e identificação?\n\n' +
    'O simulador irá:\n' +
    '• Aguardar 5 segundos antes de começar\n' +
    '• FASE 1: Cadastrar todos os brincos disponíveis do estoque (proporcionalmente por categoria)\n' +
    '• FASE 2: Processar todos os animais cadastrados com pesagem e manejo\n' +
    '• Criar uma sessão de pesagem visualmente\n' +
    '• Gerar um log detalhado de todas as operações\n' +
    '• Relatório completo com erros e status OK';
  
  if (confirm(mensagem)) {
    console.log('🔵 Confirmado! Chamando window.executarSimulador()...');
    window.executarSimulador();
  } else {
    console.log('🔵 Usuário cancelou');
  }
};

(function() {
  'use strict';

  const csrfToken = '{{ csrf_token }}';
  const propriedadeId = {{ propriedade.id }};
  const identificarUrl = '{{ identificar_url }}';
  const registrarUrl = '{{ registrar_url }}';
  const statsUrl = '{{ stats_url }}';
  const criarSessaoUrl = '{{ criar_sessao_url|default:"" }}';
  const encerrarSessaoUrl = '{{ encerrar_sessao_url|default:"" }}';
  const statsSessaoUrl = '{{ stats_sessao_url|default:"" }}';
  const dadosSimulacaoUrl = `/propriedade/${propriedadeId}/curral/api/dados-simulacao/`;
  const registrarManejoUrl = `/propriedade/${propriedadeId}/curral/api/registrar/`;
  
  // Verificar se as URLs estão definidas
  if (!criarSessaoUrl || criarSessaoUrl === '') {
    console.error('⚠️ criarSessaoUrl não está definida no template');
  }
  if (!encerrarSessaoUrl || encerrarSessaoUrl === '') {
    console.error('⚠️ encerrarSessaoUrl não está definida no template');
  }
  if (!statsSessaoUrl || statsSessaoUrl === '') {
    console.error('⚠️ statsSessaoUrl não está definida no template');
  }
  
  // Sistema de diagnóstico e tratamento de erros global
  window.diagnosticoSistema = {
    erros: [],
    avisos: [],
    inicializado: false,
    adicionarErro: function(erro, contexto) {
      const erroObj = {
        timestamp: new Date().toISOString(),
        erro: erro,
        contexto: contexto,
        stack: erro.stack || 'N/A'
      };
      this.erros.push(erroObj);
      console.error('❌ ERRO CAPTURADO:', erroObj);
      
      // Se houver muitos erros, mostrar alerta
      if (this.erros.length > 10) {
        console.error('⚠️ Muitos erros detectados! Verifique o console.');
      }
    },
    adicionarAviso: function(aviso, contexto) {
      const avisoObj = {
        timestamp: new Date().toISOString(),
        aviso: aviso,
        contexto: contexto
      };
      this.avisos.push(avisoObj);
      console.warn('⚠️ AVISO:', avisoObj);
    },
    verificarSistema: function() {
      console.log('🔍 DIAGNÓSTICO DO SISTEMA:');
      console.log('  ✅ Inicializado:', this.inicializado);
      console.log('  ❌ Erros:', this.erros.length);
      console.log('  ⚠️ Avisos:', this.avisos.length);
      console.log('  🔗 URLs:', {
        identificarUrl: identificarUrl,
        registrarUrl: registrarUrl,
        statsUrl: statsUrl,
        criarSessaoUrl: criarSessaoUrl,
        encerrarSessaoUrl: encerrarSessaoUrl,
        statsSessaoUrl: statsSessaoUrl,
        dadosSimulacaoUrl: dadosSimulacaoUrl
      });
      console.log('  🔧 Funções disponíveis:', {
        iniciarSimulador: typeof window.iniciarSimulador,
        executarSimulador: typeof window.executarSimulador,
        buscarBrincoV3: typeof window.buscarBrincoV3
      });
      return {
        inicializado: this.inicializado,
        erros: this.erros,
        avisos: this.avisos
      };
    }
  };
  
  // Capturar erros não tratados
  window.addEventListener('error', function(event) {
    window.diagnosticoSistema.adicionarErro(event.error || event.message, {
      arquivo: event.filename,
      linha: event.lineno,
      coluna: event.colno
    });
  });
  
  // Capturar promessas rejeitadas não tratadas
  window.addEventListener('unhandledrejection', function(event) {
    window.diagnosticoSistema.adicionarErro(event.reason, {
      tipo: 'Promise Rejection',
      promessa: event.promise
    });
  });
  
  let animalAtualV3 = null;
  let brincoAtualV3 = null;
  let animaisRegistrados = [];
  let manejosSelecionadosV3 = [];
  let ultimoCadastroEstoqueV3 = null; // Armazenar dados do último cadastro

  // Aplicar cores do SISBOV e Número de Manejo quando a página carregar
  document.addEventListener('DOMContentLoaded', function() {
    // Atualizar estatísticas ao carregar a página
    if (typeof window.atualizarEstatisticasV3 === 'function') {
      window.atualizarEstatisticasV3();
    }
    
    // Configurar botão do simulador
    const btnSimulador = document.getElementById('btnSimulador');
    if (btnSimulador) {
      console.log('✅ Botão do simulador encontrado no DOMContentLoaded');
      console.log('🔍 window.iniciarSimulador disponível?', typeof window.iniciarSimulador);
      console.log('🔍 window.executarSimulador disponível?', typeof window.executarSimulador);
      
      // Remover qualquer onclick inline que possa ter sido adicionado dinamicamente
      if (btnSimulador.hasAttribute('onclick')) {
        btnSimulador.removeAttribute('onclick');
        console.log('🧹 Removido onclick inline do botão');
      }
      
      // Remover event listeners anteriores para evitar duplicação
      const novoBtnSimulador = btnSimulador.cloneNode(true);
      btnSimulador.parentNode.replaceChild(novoBtnSimulador, btnSimulador);
      const btnSimuladorAtual = document.getElementById('btnSimulador');
      
      // Adicionar apenas um event listener
      btnSimuladorAtual.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation(); // Prevenir outros listeners
        
        // Verificar se já está em execução antes de iniciar
        if (window.simuladorAtivo) {
          console.warn('⚠️ Simulador já está em execução, ignorando clique');
          return;
        }
        
        console.log('🖱️ Botão clicado via event listener!');
        console.log('🔍 window.iniciarSimulador disponível?', typeof window.iniciarSimulador);
        console.log('🔍 window.executarSimulador disponível?', typeof window.executarSimulador);
        
        if (typeof window.iniciarSimulador === 'function') {
          console.log('✅ Chamando window.iniciarSimulador() via event listener');
          window.iniciarSimulador();
        } else {
          console.error('❌ window.iniciarSimulador não está disponível no event listener');
              alert('Simulador ainda não carregado. Recarregue a página (F5).');
            }
      }, { once: false, passive: false });
      
      console.log('✅ Event listener adicionado ao botão do simulador');
      
      // Adicionar event listener ao botão de parar
      const btnParar = document.getElementById('btnPararSimulador');
      if (btnParar) {
        btnParar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (typeof window.pararSimulador === 'function') {
            window.pararSimulador();
          } else {
            alert('Função de parar não disponível');
          }
        });
        console.log('✅ Event listener adicionado ao botão de parar simulador');
      }
    } else {
      console.error('❌ Botão btnSimulador não encontrado no DOMContentLoaded!');
    }
    
    const sisbovEl = document.getElementById('scannerSisbovV3');
    const numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
    
    if (sisbovEl) {
      sisbovEl.className = 'resumo-value resumo-sisbov';
      sisbovEl.style.color = '#2196F3';
      sisbovEl.style.fontSize = '1.25rem';
      sisbovEl.style.fontWeight = '700';
    }
    
    if (numeroManejoEl) {
      numeroManejoEl.className = 'resumo-value resumo-numero-manejo';
      numeroManejoEl.style.color = '#4CAF50';
      numeroManejoEl.style.fontSize = '1.75rem';
      numeroManejoEl.style.fontWeight = '700';
    }
    
    // Atualizar estatísticas ao carregar a página
    if (typeof window.atualizarEstatisticasV3 === 'function') {
      window.atualizarEstatisticasV3();
    }
    
    // ========== ATUALIZAÇÃO EM TEMPO REAL DO PESO ==========
    const pesoInput = document.getElementById('pesoValorV3');
    if (pesoInput) {
      // Adicionar event listener para atualização em tempo real
      pesoInput.addEventListener('input', function() {
        atualizarPesoEmTempoReal();
      });
      
      // Também atualizar quando o campo perder o foco (caso o usuário digite e saia)
      pesoInput.addEventListener('blur', function() {
        atualizarPesoEmTempoReal();
      });
      
      console.log('✅ Event listener de atualização em tempo real adicionado ao campo de peso');
    }
  });

  // ========== FUNÇÕES DE UTILIDADE ==========
  function mostrarToast(mensagem, tipo = 'info') {
    const container = document.getElementById('toastContainerV3');
    const toast = document.createElement('div');
    toast.className = `toast-v3 toast-v3-${tipo}`;
    
    const icon = {
      success: '✅',
      error: '❌',
      warning: '⚠️',
      info: 'ℹ️'
    }[tipo] || 'ℹ️';
    
    toast.innerHTML = `<span style="font-size: 1.5rem;">${icon}</span><span>${mensagem}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => container.removeChild(toast), 300);
    }, 4000);
  }

  function mostrarLoading(mostrar) {
    const loading = document.getElementById('loadingV3');
    if (mostrar) {
      loading.classList.add('show');
    } else {
      loading.classList.remove('show');
    }
  }

  // ========== FUNÇÃO PARA ATUALIZAR GRÁFICO DE BARRAS DE EFICIÊNCIA ==========
  function atualizarGaugeEficiencia(ganhoDiario) {
    const gaugeNeedle = document.getElementById('gaugeNeedleV3');
    const gaugeValue = document.getElementById('gaugeValueV3');
    
    if (!gaugeNeedle || !gaugeValue) {
      return;
    }
    
    // Se não há ganho diário, resetar gráfico (marcador na posição inicial - esquerda)
    if (!ganhoDiario || isNaN(ganhoDiario) || ganhoDiario === 0) {
      gaugeNeedle.style.left = '0%';
      gaugeValue.textContent = '—';
      return;
    }
    
    // Definir faixas de eficiência e posições na barra horizontal
    // A barra vai de 0% (esquerda) a 100% (direita)
    // Ruim: < 0.4 kg/dia (0% a 25%)
    // Regular: 0.4 - 0.7 kg/dia (25% a 50%)
    // Bom: 0.7 - 1.0 kg/dia (50% a 75%)
    // Ótimo: > 1.0 kg/dia (75% a 100%)
    
    let posicaoPercentual = 0;
    let textoValor = `${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
    
    if (ganhoDiario >= 1.0) {
      // Ótimo: 75% a 100%
      // 1.0 = 75%, 1.5+ = 100%
      const progresso = Math.min(1, (ganhoDiario - 1.0) / 0.5);
      posicaoPercentual = 75 + (progresso * 25);
    } else if (ganhoDiario >= 0.7) {
      // Bom: 50% a 75%
      // 0.7 = 50%, 1.0 = 75%
      const progresso = (ganhoDiario - 0.7) / 0.3;
      posicaoPercentual = 50 + (progresso * 25);
    } else if (ganhoDiario >= 0.4) {
      // Regular: 25% a 50%
      // 0.4 = 25%, 0.7 = 50%
      const progresso = (ganhoDiario - 0.4) / 0.3;
      posicaoPercentual = 25 + (progresso * 25);
    } else {
      // Ruim: 0% a 25%
      // 0 = 0%, 0.4 = 25%
      const progresso = ganhoDiario / 0.4;
      posicaoPercentual = progresso * 25;
    }
    
    // Limitar posição entre 0% e 100%
    posicaoPercentual = Math.max(0, Math.min(100, posicaoPercentual));
    
    // Atualizar posição do marcador
    gaugeNeedle.style.left = `${posicaoPercentual}%`;
    
    // Atualizar valor exibido
    gaugeValue.textContent = textoValor;
    
    console.log('📊 Gráfico de barras atualizado:', {
      ganhoDiario: ganhoDiario,
      posicaoPercentual: posicaoPercentual,
      textoValor: textoValor
    });
  }
  
  // ========== FUNÇÃO PARA ATUALIZAR CARD DE PESAGEM EM TEMPO REAL ==========
  function atualizarCardPesagemEmTempoReal() {
    const pesoInput = document.getElementById('pesoValorV3');
    if (!pesoInput || !animalAtualV3) {
      // Limpar campos se não houver animal
      limparCamposPesagem();
      atualizarGaugeEficiencia(0);
      return;
    }
    
    const pesoDigitado = pesoInput.value.replace(',', '.').trim();
    const pesoNumero = parseFloat(pesoDigitado);
    
    if (!pesoNumero || isNaN(pesoNumero) || pesoNumero <= 0) {
      // Limpar campos se peso inválido
      limparCamposPesagem();
      atualizarGaugeEficiencia(0);
      return;
    }
    
    // Atualizar "Peso Registrado"
    const pesoRegistrado = document.getElementById('pesoRegistradoV3');
    if (pesoRegistrado) {
      pesoRegistrado.textContent = `${pesoNumero.toFixed(1).replace('.', ',')} kg`;
    }
    
    // Atualizar "Data última pesagem" com a data atual
    const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
    if (pesoUltimoData) {
      const hoje = new Date();
      pesoUltimoData.textContent = hoje.toLocaleDateString('pt-BR');
    }
    
    // Calcular ganho total baseado no peso digitado e peso anterior
    const pesoAnterior = parseFloat(animalAtualV3.peso_atual || animalAtualV3.peso_anterior || 0);
    
    if (!pesoAnterior || pesoAnterior <= 0) {
      // Se não há peso anterior, limpar campos de ganho
      const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
      const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
      if (pesoGanhoTotal) {
        pesoGanhoTotal.textContent = '—';
        pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
      }
      if (pesoGanhoDia) {
        pesoGanhoDia.textContent = '—';
      }
      atualizarGaugeEficiencia(0);
      return;
    }
    
    const ganhoTotal = pesoNumero - pesoAnterior;
    
    // Atualizar "Ganho total" com cores dinâmicas
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
    if (pesoGanhoTotal) {
      pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
      pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
      if (ganhoTotal > 0) {
        pesoGanhoTotal.classList.add('ganho-positivo');
      } else if (ganhoTotal < 0) {
        pesoGanhoTotal.classList.add('ganho-negativo');
      }
    }
    
    // Calcular dias desde última pesagem
    let dias = 30; // Padrão: 30 dias se não houver data
    if (animalAtualV3.data_peso_atual || animalAtualV3.data_peso_anterior) {
      try {
        const dataAnterior = animalAtualV3.data_peso_anterior 
          ? new Date(animalAtualV3.data_peso_anterior) 
          : (animalAtualV3.data_peso_atual ? new Date(animalAtualV3.data_peso_atual) : new Date());
        const dataAtual = new Date();
        const diffTime = Math.abs(dataAtual - dataAnterior);
        dias = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
      } catch (e) {
        console.warn('Erro ao calcular dias:', e);
      }
    }
    
    // Atualizar "Dias desde a última"
    const pesoDias = document.getElementById('pesoDiasV3');
    if (pesoDias) {
      pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
    }
    
    // Calcular e atualizar "Ganho diário médio"
    const ganhoDiario = ganhoTotal / dias;
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
    if (pesoGanhoDia) {
      pesoGanhoDia.textContent = `${ganhoDiario > 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
    }
    
    // Atualizar gauge
    atualizarGaugeEficiencia(ganhoDiario);
  }
  
  // Função auxiliar para limpar campos de pesagem
  function limparCamposPesagem() {
    const pesoRegistrado = document.getElementById('pesoRegistradoV3');
    const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
    const pesoDias = document.getElementById('pesoDiasV3');
    
    if (pesoRegistrado) pesoRegistrado.textContent = '—';
    if (pesoUltimoData) pesoUltimoData.textContent = '—';
    if (pesoGanhoTotal) {
      pesoGanhoTotal.textContent = '—';
      pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
    }
    if (pesoGanhoDia) pesoGanhoDia.textContent = '—';
    if (pesoDias) pesoDias.textContent = '—';
  }
  
  // ========== FUNÇÃO PARA CALCULAR E ATUALIZAR GAUGE EM TEMPO REAL ==========
  function calcularEficienciaEmTempoReal() {
    atualizarCardPesagemEmTempoReal();
  }
  
  // ========== FUNÇÃO PARA ATUALIZAR PESO EM TEMPO REAL ==========
  // Esta função é chamada quando o usuário digita o peso, antes de gravar
  function atualizarPesoEmTempoReal() {
    const pesoInput = document.getElementById('pesoValorV3');
    if (!pesoInput) return;
    
    // Obter valor do peso digitado (substituir vírgula por ponto)
    const pesoStr = pesoInput.value.replace(',', '.').trim();
    const pesoNovo = parseFloat(pesoStr);
    
    // Se não há peso válido, limpar campos
    if (!pesoStr || isNaN(pesoNovo) || pesoNovo <= 0) {
      limparCamposPesagem();
      // Resetar gráfico
      if (typeof atualizarGaugeEficiencia === 'function') {
        atualizarGaugeEficiencia(0);
      }
      return;
    }
    
    console.log('⚡ Atualizando em tempo real - Peso digitado:', pesoNovo);
    
    // Obter dados do animal atual (se houver)
    const pesoAnteriorEl = document.getElementById('scannerPesoAnteriorV3');
    const pesoAtualEl = document.getElementById('scannerPesoAtualV3');
    const dataPesoAnteriorEl = document.getElementById('pesoUltimoDataV3');
    
    let pesoAnterior = null;
    let dataPesoAnterior = null;
    
    // Tentar obter peso anterior do campo de resumo
    if (pesoAnteriorEl && pesoAnteriorEl.textContent && pesoAnteriorEl.textContent !== '—') {
      const pesoAnteriorStr = pesoAnteriorEl.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
      pesoAnterior = parseFloat(pesoAnteriorStr);
    } else if (pesoAtualEl && pesoAtualEl.textContent && pesoAtualEl.textContent !== '—') {
      // Se não tem peso anterior, usar peso atual como anterior
      const pesoAtualStr = pesoAtualEl.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
      pesoAnterior = parseFloat(pesoAtualStr);
    }
    
    // Obter data da última pesagem
    if (dataPesoAnteriorEl && dataPesoAnteriorEl.textContent && dataPesoAnteriorEl.textContent !== '—') {
      dataPesoAnterior = dataPesoAnteriorEl.textContent;
    }
    
    // Atualizar campo "Peso Registrado" em tempo real
    const pesoRegistradoEl = document.getElementById('pesoRegistradoV3');
    if (pesoRegistradoEl) {
      pesoRegistradoEl.textContent = pesoNovo.toFixed(1).replace('.', ',') + ' kg';
    }
    
    // Calcular ganho total
    let ganhoTotal = 0;
    if (pesoAnterior && !isNaN(pesoAnterior)) {
      ganhoTotal = pesoNovo - pesoAnterior;
    }
    
    // Atualizar campo de ganho total
    const ganhoTotalEl = document.getElementById('pesoGanhoTotalV3');
    if (ganhoTotalEl) {
      if (pesoAnterior && !isNaN(pesoAnterior)) {
        ganhoTotalEl.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
        ganhoTotalEl.classList.remove('ganho-positivo', 'ganho-negativo');
        if (ganhoTotal > 0) {
          ganhoTotalEl.classList.add('ganho-positivo');
        } else if (ganhoTotal < 0) {
          ganhoTotalEl.classList.add('ganho-negativo');
        }
      } else {
        ganhoTotalEl.textContent = '—';
        ganhoTotalEl.classList.remove('ganho-positivo', 'ganho-negativo');
      }
    }
    
    // Calcular ganho diário
    let ganhoDiario = 0;
    if (pesoAnterior && !isNaN(pesoAnterior) && dataPesoAnterior) {
      try {
        // Tentar parsear data (formato DD/MM/YYYY)
        const partesData = dataPesoAnterior.split('/');
        if (partesData.length === 3) {
          const dataAnterior = new Date(parseInt(partesData[2]), parseInt(partesData[1]) - 1, parseInt(partesData[0]));
          const dataAtual = new Date();
          const diffTime = Math.abs(dataAtual - dataAnterior);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays > 0) {
            ganhoDiario = ganhoTotal / diffDays;
          }
        }
      } catch (e) {
        console.warn('Erro ao calcular ganho diário:', e);
      }
    }
    
    // Atualizar campo de ganho diário
    const ganhoDiaEl = document.getElementById('pesoGanhoDiaV3');
    if (ganhoDiaEl) {
      if (ganhoDiario !== 0 && !isNaN(ganhoDiario)) {
        ganhoDiaEl.textContent = `${ganhoDiario > 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
      } else {
        ganhoDiaEl.textContent = '—';
      }
    }
    
    // Atualizar gráfico de eficiência em tempo real
    if (typeof atualizarGaugeEficiencia === 'function') {
      atualizarGaugeEficiencia(ganhoDiario);
    }
    
    // Determinar apartação em tempo real e mostrar visualmente
    const apartacaoBadge = document.getElementById('apartacaoTempoRealV3');
    if (typeof determinarApartacao === 'function') {
      const apartacao = determinarApartacao(pesoNovo);
      if (apartacao) {
        console.log('📊 Apartação em tempo real:', apartacao.nome, apartacao.faixa);
        
        // Mostrar apartação em um elemento visual (se existir)
        // Pode ser um badge ou indicador próximo ao campo de peso
        if (apartacaoBadge) {
          apartacaoBadge.textContent = `${apartacao.nome} (${apartacao.faixa})`;
          apartacaoBadge.style.display = 'block';
        }
        
        // Se a função mostrarPopupApartacao existir, podemos mostrar um preview
        // Mas não vamos mostrar o popup completo até gravar
        const codigo = document.getElementById('scannerNumeroManejoV3')?.textContent || 
                      document.getElementById('scannerSisbovV3')?.textContent || '';
        if (codigo && typeof mostrarPopupApartacao === 'function') {
          // Não mostrar popup completo, mas podemos atualizar um indicador
          console.log('ℹ️ Apartação calculada:', apartacao.nome);
        }
      } else if (apartacaoBadge) {
        apartacaoBadge.style.display = 'none';
      }
    }
    
    console.log('✅ Atualização em tempo real concluída:', {
      pesoNovo,
      pesoAnterior,
      ganhoTotal,
      ganhoDiario
    });
  }
  
  // Tornar função global
  window.atualizarPesoEmTempoReal = atualizarPesoEmTempoReal;
  
  // Tornar funções globais
  window.atualizarTermometroEficiencia = atualizarGaugeEficiencia;
  window.atualizarGaugeEficiencia = atualizarGaugeEficiencia;
  window.calcularEficienciaEmTempoReal = calcularEficienciaEmTempoReal;

  function fecharModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('show');
      modal.style.display = 'none';
    }
  }

  // ========== FUNÇÕES DE MODAL ==========
  // Abrir modal de criar sessão
  window.abrirModalCriarSessao = function() {
    const modal = document.getElementById('modalCriarSessao');
    if (modal) {
      modal.style.display = 'flex';
      modal.classList.add('show');
      // Limpar campos
      document.getElementById('criarSessaoNomeV3').value = '';
      document.getElementById('criarSessaoTipoV3').value = '';
      document.getElementById('criarSessaoPastoLoteV3').value = '';
      document.getElementById('criarSessaoObservacoesV3').value = '';
      validarFormularioCriarSessao();
    }
  };

  // Fechar modal de configuração de pesagem
  window.fecharModalConfigPesagem = function() {
    const modal = document.getElementById('modalConfigPesagem');
    if (modal) {
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
  };
  
  // ========== FUNÇÕES DE ENCERRAR SESSÃO ==========
  // Abrir modal de encerrar sessão
  window.encerrarSessaoV3 = async function() {
    const modal = document.getElementById('modalEncerrarSessao');
    if (!modal) {
      console.error('Modal de encerrar sessão não encontrado');
      return;
    }
    
    // Buscar estatísticas da sessão atual para exibir no modal
    try {
      if (statsSessaoUrl) {
        const response = await fetch(statsSessaoUrl, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.status === 'ok' && data.stats) {
            const stats = data.stats;
            
            // Preencher dados no modal
            const eventosEl = document.getElementById('encerrarSessaoEventosV3');
            const animaisEl = document.getElementById('encerrarSessaoAnimaisV3');
            const pesagensEl = document.getElementById('encerrarSessaoPesagensV3');
            const nomeEl = document.getElementById('encerrarSessaoNomeV3');
            const dataEl = document.getElementById('encerrarSessaoDataV3');
            
            if (eventosEl) eventosEl.textContent = stats.total_eventos || 0;
            if (animaisEl) animaisEl.textContent = stats.animais_trabalhados || 0;
            if (pesagensEl) pesagensEl.textContent = stats.total_pesagens || 0;
            if (nomeEl) nomeEl.textContent = stats.sessao_nome || '—';
            if (dataEl) dataEl.textContent = stats.sessao_data || '—';
          }
        }
      }
    } catch (error) {
      console.warn('Erro ao buscar estatísticas da sessão:', error);
    }
    
    // Mostrar modal
    modal.style.display = 'flex';
    modal.classList.add('show');
  };
  
  // Confirmar encerrar sessão
  window.confirmarEncerrarSessaoV3 = async function() {
    if (!encerrarSessaoUrl) {
      mostrarToast('URL de encerrar sessão não configurada', 'error');
      return;
    }
    
    const btnEncerrar = document.querySelector('.btn-v3-danger');
    if (btnEncerrar) {
      btnEncerrar.disabled = true;
      btnEncerrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Encerrando...';
    }
    
    try {
      const response = await fetch(encerrarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      
      if (data.status === 'ok') {
        mostrarToast('Sessão encerrada com sucesso!', 'success');
        
        // Fechar modal
        fecharModal('modalEncerrarSessao');
        
        // Limpar todos os cards de estatísticas
        limparCardsEstatisticas();
        
        // Recarregar página após um breve delay para atualizar UI
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        mostrarToast(data.mensagem || 'Erro ao encerrar sessão', 'error');
        if (btnEncerrar) {
          btnEncerrar.disabled = false;
          btnEncerrar.innerHTML = '<i class="fas fa-stop"></i> Sim, Encerrar Sessão';
        }
      }
    } catch (error) {
      console.error('Erro ao encerrar sessão:', error);
      mostrarToast('Erro ao comunicar com o servidor', 'error');
      if (btnEncerrar) {
        btnEncerrar.disabled = false;
        btnEncerrar.innerHTML = '<i class="fas fa-stop"></i> Sim, Encerrar Sessão';
      }
    }
  };
  
  // Função para limpar todos os cards de estatísticas
  function limparCardsEstatisticas() {
    console.log('🧹 Limpando cards de estatísticas...');
    
    // Limpar todos os elementos de estatísticas
    const elementos = {
      statTotalAnimais: '0',
      statTrabalhados: '0',
      statMachos: '0',
      statFemeas: '0',
      statCategorias: '—',
      statMediaPeso: '—',
      statTotalPesagens: '0',
      statGanhoMedioDia: '—',
      statGanhoPositivo: '0',
      statGanhoNegativo: '0',
      statTotalManejos: '0'
    };
    
    Object.keys(elementos).forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = elementos[id];
        console.log(`✅ ${id} limpo: ${elementos[id]}`);
      }
    });
    
    // Limpar campos de animal identificado
    const camposAnimal = [
      'scannerSisbovV3',
      'scannerNumeroManejoV3',
      'scannerRacaV3',
      'scannerSexoV3',
      'scannerIdadeV3',
      'scannerDataNascV3',
      'scannerCategoriaV3',
      'scannerPesoAtualV3',
      'scannerPesoAnteriorV3',
      'scannerGanhoDiaV3',
      'scannerGanhoTotalV3'
    ];
    
    camposAnimal.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.textContent = '—';
        }
      }
    });
    
    // Limpar campo de peso
    const pesoInput = document.getElementById('pesoValorV3');
    if (pesoInput) {
      pesoInput.value = '';
      pesoInput.disabled = true;
    }
    
    // Limpar campo de busca
    const brincoInput = document.getElementById('brincoInputV3');
    if (brincoInput) {
      brincoInput.value = '';
    }
    
    // Resetar gráfico de eficiência
    const gaugeNeedle = document.getElementById('gaugeNeedleV3');
    const gaugeValue = document.getElementById('gaugeValueV3');
    if (gaugeNeedle) {
      gaugeNeedle.style.left = '0%';
    }
    if (gaugeValue) {
      gaugeValue.textContent = '—';
    }
    
    console.log('✅ Todos os cards foram limpos!');
  };

  // Abrir modal de configuração de pesagem
  window.mostrarModalConfigPesagem = function() {
    const modal = document.getElementById('modalConfigPesagem');
    if (modal) {
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
    }
  };

  // Abrir configuração de pesagem e manejo (usado pelo botão)
  window.abrirConfigPesagemEManejo = function() {
    window.mostrarModalConfigPesagem();
  };

  // Validar formulário de criar sessão
  window.validarFormularioCriarSessao = function() {
    const nome = document.getElementById('criarSessaoNomeV3')?.value.trim() || '';
    const tipo = document.getElementById('criarSessaoTipoV3')?.value || '';
    const btnConfirmar = document.getElementById('btnConfirmarCriarSessaoV3');
    
    if (btnConfirmar) {
      btnConfirmar.disabled = !(nome && tipo);
    }
  };

  // Confirmar criar sessão
  window.confirmarCriarSessaoV3 = async function() {
    const nome = document.getElementById('criarSessaoNomeV3')?.value.trim() || '';
    const tipo = document.getElementById('criarSessaoTipoV3')?.value || '';
    const pastoLote = document.getElementById('criarSessaoPastoLoteV3')?.value.trim() || '';
    const observacoes = document.getElementById('criarSessaoObservacoesV3')?.value.trim() || '';

    if (!nome || !tipo) {
      mostrarToast('Preencha o nome e o tipo da sessão', 'warning');
      return;
    }

    try {
      const response = await fetch(criarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          nome: nome,
          tipo_trabalho: tipo,
          pasto_lote: pastoLote,
          observacoes: observacoes
        })
      });

      if (response.ok) {
        const data = await response.json();
        mostrarToast('Sessão criada com sucesso!', 'success');
        fecharModal('modalCriarSessao');
        
        // Limpar todos os cards de estatísticas IMEDIATAMENTE (nova sessão = dados zerados)
        limparCardsEstatisticas();
        
        // Recarregar página para atualizar sessão ativa e garantir que tudo está sincronizado
        setTimeout(() => {
          window.location.reload();
        }, 800);
      } else {
        const error = await response.json();
        mostrarToast(error.mensagem || 'Erro ao criar sessão', 'error');
      }
    } catch (error) {
      console.error('Erro ao criar sessão:', error);
      mostrarToast('Erro ao criar sessão', 'error');
    }
  };

  // Abrir modal de cadastro de estoque
  window.abrirCadastroEstoqueV3 = function(dadosBrinco, codigo) {
    console.log('🔵 abrirCadastroEstoqueV3 chamado');
    console.log('🔵 dadosBrinco:', dadosBrinco);
    console.log('🔵 codigo:', codigo);
    
    const modal = document.getElementById('modalCadastroEstoque');
    if (!modal) {
      console.error('❌ Modal de cadastro de estoque não encontrado!');
      mostrarToast('Erro: Modal de cadastro não encontrado. Recarregue a página.', 'error');
      return;
    }
    
    console.log('✅ Modal encontrado:', modal);
    
    // Preencher dados do brinco
    if (dadosBrinco) {
      console.log('📝 Preenchendo dados do brinco:', dadosBrinco);
      
      const brincoEl = document.getElementById('cadastroBrincoV3');
      const sisbovEl = document.getElementById('cadastroSisbovV3');
      const numeroManejoEl = document.getElementById('cadastroNumeroManejoV3');
      
      if (brincoEl) {
        brincoEl.textContent = dadosBrinco.numero_brinco || codigo || '—';
        console.log('✅ Brinco preenchido:', brincoEl.textContent);
      }
      
      if (sisbovEl) {
        sisbovEl.textContent = dadosBrinco.codigo_sisbov || dadosBrinco.numero_brinco || codigo || '—';
        console.log('✅ SISBOV preenchido:', sisbovEl.textContent);
      }
      
      if (numeroManejoEl) {
        numeroManejoEl.textContent = dadosBrinco.numero_manejo || '—';
        console.log('✅ Número de manejo preenchido:', numeroManejoEl.textContent);
      }
      
      // Preencher RFID se houver
      const rfidEl = document.getElementById('cadastroRfidV3');
      if (rfidEl && dadosBrinco.codigo_rfid) {
        rfidEl.value = dadosBrinco.codigo_rfid;
        console.log('✅ RFID preenchido:', dadosBrinco.codigo_rfid);
      }
    } else if (codigo) {
      console.log('📝 Usando apenas código (sem dados do brinco):', codigo);
      const brincoEl = document.getElementById('cadastroBrincoV3');
      const sisbovEl = document.getElementById('cadastroSisbovV3');
      if (brincoEl) brincoEl.textContent = codigo;
      if (sisbovEl) sisbovEl.textContent = codigo;
    }
    
    // Limpar outros campos
    const campos = ['cadastroRacaV3', 'cadastroSexoV3', 'cadastroIdadeV3', 'cadastroDataNascV3', 'cadastroMaeV3', 'cadastroTipoRegistroV3'];
    campos.forEach(campoId => {
      const campo = document.getElementById(campoId);
      if (campo) {
        campo.value = '';
      }
    });
    
    // Mostrar modal - garantir que está visível
    console.log('🎯 Exibindo modal...');
    console.log('🎯 Display antes:', modal.style.display);
    console.log('🎯 Classes antes:', modal.className);
    
    // Forçar display e z-index
    modal.style.display = 'flex';
    modal.style.zIndex = '10001';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    
    // Adicionar classe show após pequeno delay para animação
    setTimeout(() => {
      modal.classList.add('show');
      console.log('✅ Classe "show" adicionada');
      console.log('🎯 Display depois:', modal.style.display);
      console.log('🎯 Classes depois:', modal.className);
      
      // Verificar se modal está visível
      const rect = modal.getBoundingClientRect();
      console.log('📐 Posição do modal:', {
        top: rect.top,
        left: rect.left,
        width: rect.width,
        height: rect.height,
        visible: rect.width > 0 && rect.height > 0
      });
      
      if (rect.width === 0 || rect.height === 0) {
        console.error('❌ Modal não está visível! Tentando forçar...');
        modal.style.display = 'flex';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
      }
    }, 50);
    
    // Focar no campo de raça
    setTimeout(() => {
      const racaEl = document.getElementById('cadastroRacaV3');
      if (racaEl) {
        racaEl.focus();
        console.log('✅ Campo de raça focado');
      }
    }, 400);
    
    console.log('✅ Modal de cadastro aberto com sucesso!');
  };

  // ========== FUNÇÕES DE CONFIGURAÇÃO DE PESAGEM ==========
  
  // Atualizar configuração baseado na seleção
  window.atualizarConfigPesagem = function() {
    const select = document.getElementById('selectManejoPesagem');
    const configRotina = document.getElementById('configPesagemRotina');
    const configAparte = document.getElementById('configPesagemAparte');
    
    if (!select) return;
    
    const valor = select.value;
    
    // Esconder todas as seções
    if (configRotina) configRotina.style.display = 'none';
    if (configAparte) configAparte.style.display = 'none';
    
    // Mostrar seção correspondente
    if (valor === 'PESAGEM_ROTINA' && configRotina) {
      configRotina.style.display = 'block';
    } else if (valor === 'PESAGEM_APARTE' && configAparte) {
      configAparte.style.display = 'block';
      // Carregar faixas padrão se lista estiver vazia
      const lista = document.getElementById('listaApartacoes');
      if (lista && lista.children.length === 1) {
        carregarFaixasPadrao();
      }
    }
  };
  
  // Adicionar linha de apartação
  window.adicionarLinhaAparte = function() {
    const lista = document.getElementById('listaApartacoes');
    if (!lista) return;
    
    // Remover mensagem de lista vazia
    const emptyMsg = lista.querySelector('div[style*="text-align: center"]');
    if (emptyMsg) {
      emptyMsg.remove();
    }
    
    const index = lista.children.length;
    const linha = document.createElement('div');
    linha.className = 'linha-apartacao';
    linha.dataset.index = index;
    
    const cores = ['#f44336', '#ff9800', '#4caf50', '#2196f3', '#9c27b0'];
    const cor = cores[index % cores.length];
    
    linha.innerHTML = `
      <input type="text" 
             placeholder="Nome da categoria (ex: Refugo)" 
             class="apartacao-nome"
             style="border-left: 4px solid ${cor};"
             required>
      <input type="number" 
             placeholder="Peso mínimo (kg)" 
             class="apartacao-min"
             min="0" 
             step="0.1"
             required>
      <input type="number" 
             placeholder="Peso máximo (kg)" 
             class="apartacao-max"
             min="0" 
             step="0.1"
             required>
      <select class="apartacao-cor">
        <option value="#f44336">Vermelho</option>
        <option value="#ff9800">Laranja</option>
        <option value="#ffc107">Amarelo</option>
        <option value="#4caf50">Verde</option>
        <option value="#2196f3">Azul</option>
        <option value="#9c27b0">Roxo</option>
      </select>
      <button type="button" class="btn-remover-aparte" onclick="removerLinhaAparte(this)" title="Remover faixa">
        <i class="fas fa-trash"></i>
      </button>
    `;
    
    lista.appendChild(linha);
    
    // Focar no primeiro campo
    const primeiroInput = linha.querySelector('.apartacao-nome');
    if (primeiroInput) {
      setTimeout(() => primeiroInput.focus(), 100);
    }
  };
  
  // Remover linha de apartação
  window.removerLinhaAparte = function(btn) {
    const linha = btn.closest('.linha-apartacao');
    if (linha) {
      linha.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => {
        linha.remove();
        
        // Se lista ficar vazia, mostrar mensagem
        const lista = document.getElementById('listaApartacoes');
        if (lista && lista.children.length === 0) {
          lista.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #999; font-style: italic;">
              <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.5;"></i>
              <p style="margin: 0;">Nenhuma faixa configurada. Clique em "Adicionar Faixa" para começar.</p>
            </div>
          `;
        }
      }, 300);
    }
  };
  
  // Carregar faixas padrão
  window.carregarFaixasPadrao = function() {
    const lista = document.getElementById('listaApartacoes');
    if (!lista) return;
    
    // Limpar lista
    lista.innerHTML = '';
    
    const faixasPadrao = [
      { nome: 'Refugo', min: 1, max: 200, cor: '#f44336' },
      { nome: 'Meio', min: 201, max: 250, cor: '#ff9800' },
      { nome: 'Cabeceira', min: 251, max: 300, cor: '#4caf50' },
      { nome: 'Boiada', min: 301, max: 380, cor: '#2196f3' }
    ];
    
    faixasPadrao.forEach((faixa, index) => {
      const linha = document.createElement('div');
      linha.className = 'linha-apartacao';
      linha.dataset.index = index;
      
      linha.innerHTML = `
        <input type="text" 
               value="${faixa.nome}" 
               class="apartacao-nome"
               style="border-left: 4px solid ${faixa.cor};"
               required>
        <input type="number" 
               value="${faixa.min}" 
               class="apartacao-min"
               min="0" 
               step="0.1"
               required>
        <input type="number" 
               value="${faixa.max}" 
               class="apartacao-max"
               min="0" 
               step="0.1"
               required>
        <select class="apartacao-cor">
          <option value="#f44336" ${faixa.cor === '#f44336' ? 'selected' : ''}>Vermelho</option>
          <option value="#ff9800" ${faixa.cor === '#ff9800' ? 'selected' : ''}>Laranja</option>
          <option value="#ffc107" ${faixa.cor === '#ffc107' ? 'selected' : ''}>Amarelo</option>
          <option value="#4caf50" ${faixa.cor === '#4caf50' ? 'selected' : ''}>Verde</option>
          <option value="#2196f3" ${faixa.cor === '#2196f3' ? 'selected' : ''}>Azul</option>
          <option value="#9c27b0" ${faixa.cor === '#9c27b0' ? 'selected' : ''}>Roxo</option>
        </select>
        <button type="button" class="btn-remover-aparte" onclick="removerLinhaAparte(this)" title="Remover faixa">
          <i class="fas fa-trash"></i>
        </button>
      `;
      
      lista.appendChild(linha);
    });
    
    mostrarToast('Faixas padrão carregadas com sucesso!', 'success');
  };
  
  // Salvar configuração de pesagem
  window.salvarConfigPesagem = function() {
    const select = document.getElementById('selectManejoPesagem');
    if (!select || !select.value) {
      mostrarToast('Selecione um tipo de pesagem primeiro', 'warning');
      return;
    }
    
    const config = {
      tipo: select.value,
      pesagem_rotina: {
        ativa: document.getElementById('checkPesagemRotina')?.checked || false
      },
      pesagem_aparte: {
        faixas: []
      }
    };
    
    // Se for apartação, coletar faixas
    if (select.value === 'PESAGEM_APARTE') {
      const linhas = document.querySelectorAll('.linha-apartacao');
      linhas.forEach(linha => {
        const nome = linha.querySelector('.apartacao-nome')?.value.trim();
        const min = parseFloat(linha.querySelector('.apartacao-min')?.value);
        const max = parseFloat(linha.querySelector('.apartacao-max')?.value);
        const cor = linha.querySelector('.apartacao-cor')?.value;
        
        if (nome && !isNaN(min) && !isNaN(max) && min < max) {
          config.pesagem_aparte.faixas.push({
            nome: nome,
            min: min,
            max: max,
            cor: cor
          });
        }
      });
      
      if (config.pesagem_aparte.faixas.length === 0) {
        mostrarToast('Adicione pelo menos uma faixa de apartação', 'warning');
        return;
      }
    }
    
    // Salvar no localStorage (ou enviar para servidor)
    try {
      localStorage.setItem('configPesagemV3', JSON.stringify(config));
      console.log('✅ Configuração salva:', config);
      mostrarToast('Configuração salva com sucesso!', 'success');
      
      // Atualizar badge de configuração
      const badge = document.getElementById('badgeConfigPesagem');
      const texto = document.getElementById('textoConfigPesagem');
      if (badge && texto) {
        badge.style.display = 'inline-flex';
        texto.textContent = select.value === 'PESAGEM_ROTINA' ? 'Rotina' : 'Apartação';
      }
      
      // Fechar modal após 1 segundo
      setTimeout(() => {
        fecharModalConfigPesagem();
      }, 1000);
    } catch (error) {
      console.error('Erro ao salvar configuração:', error);
      mostrarToast('Erro ao salvar configuração', 'error');
    }
  };
  
  // Carregar configuração salva
  function carregarConfigPesagem() {
    try {
      const configStr = localStorage.getItem('configPesagemV3');
      if (configStr) {
        const config = JSON.parse(configStr);
        const select = document.getElementById('selectManejoPesagem');
        if (select) {
          select.value = config.tipo || '';
          atualizarConfigPesagem();
          
          if (config.tipo === 'PESAGEM_ROTINA') {
            const check = document.getElementById('checkPesagemRotina');
            if (check) check.checked = config.pesagem_rotina?.ativa || false;
          } else if (config.tipo === 'PESAGEM_APARTE' && config.pesagem_aparte?.faixas) {
            const lista = document.getElementById('listaApartacoes');
            if (lista) {
              lista.innerHTML = '';
              config.pesagem_aparte.faixas.forEach((faixa, index) => {
                const linha = document.createElement('div');
                linha.className = 'linha-apartacao';
                linha.dataset.index = index;
                
                linha.innerHTML = `
                  <input type="text" 
                         value="${faixa.nome}" 
                         class="apartacao-nome"
                         style="border-left: 4px solid ${faixa.cor};"
                         required>
                  <input type="number" 
                         value="${faixa.min}" 
                         class="apartacao-min"
                         min="0" 
                         step="0.1"
                         required>
                  <input type="number" 
                         value="${faixa.max}" 
                         class="apartacao-max"
                         min="0" 
                         step="0.1"
                         required>
                  <select class="apartacao-cor">
                    <option value="#f44336" ${faixa.cor === '#f44336' ? 'selected' : ''}>Vermelho</option>
                    <option value="#ff9800" ${faixa.cor === '#ff9800' ? 'selected' : ''}>Laranja</option>
                    <option value="#ffc107" ${faixa.cor === '#ffc107' ? 'selected' : ''}>Amarelo</option>
                    <option value="#4caf50" ${faixa.cor === '#4caf50' ? 'selected' : ''}>Verde</option>
                    <option value="#2196f3" ${faixa.cor === '#2196f3' ? 'selected' : ''}>Azul</option>
                    <option value="#9c27b0" ${faixa.cor === '#9c27b0' ? 'selected' : ''}>Roxo</option>
                  </select>
                  <button type="button" class="btn-remover-aparte" onclick="removerLinhaAparte(this)" title="Remover faixa">
                    <i class="fas fa-trash"></i>
                  </button>
                `;
                
                lista.appendChild(linha);
              });
            }
          }
        }
      }
    } catch (error) {
      console.error('Erro ao carregar configuração:', error);
    }
  }
  
  // Adicionar animação fadeOut
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-20px);
      }
    }
  `;
  document.head.appendChild(style);
  
  // Adicionar event listener ao botão de configurar pesagem
  document.addEventListener('DOMContentLoaded', function() {
    const btnConfigPesagem = document.querySelector('.btn-config-pesagem');
    if (btnConfigPesagem) {
      btnConfigPesagem.addEventListener('click', function(e) {
        e.stopPropagation();
        window.mostrarModalConfigPesagem();
        // Carregar configuração salva ao abrir
        setTimeout(() => {
          carregarConfigPesagem();
        }, 100);
      });
    }
    
    // Adicionar event listener ao botão de confirmar cadastro
    const btnConfirmarCadastro = document.getElementById('btnConfirmarCadastroV3');
    if (btnConfirmarCadastro) {
      btnConfirmarCadastro.addEventListener('click', async function() {
        await confirmarCadastroEstoqueV3();
      });
    }
  });
  
  // Confirmar cadastro de estoque
  async function confirmarCadastroEstoqueV3() {
    const raca = document.getElementById('cadastroRacaV3')?.value || '';
    const sexo = document.getElementById('cadastroSexoV3')?.value || '';
    const idade = document.getElementById('cadastroIdadeV3')?.value || '';
    const dataNasc = document.getElementById('cadastroDataNascV3')?.value || '';
    const tipoRegistro = document.getElementById('cadastroTipoRegistroV3')?.value || '';
    const brinco = document.getElementById('cadastroBrincoV3')?.textContent || '';
    
    if (!raca || !sexo || !tipoRegistro) {
      mostrarToast('Preencha raça, sexo e tipo de registro', 'warning');
      return;
    }
    
    try {
      const payload = {
        codigo: brinco,
        tipo_fluxo: 'estoque',
        manejo: 'CADASTRO_INICIAL',
        raca: raca,
        sexo: sexo,
        tipo_registro: tipoRegistro
      };
      
      if (idade) payload.idade_meses = parseInt(idade);
      if (dataNasc) payload.data_nascimento = dataNasc;
      
      const response = await fetch(registrarManejoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        const data = await response.json();
        mostrarToast('Animal cadastrado com sucesso!', 'success');
        fecharModal('modalCadastroEstoque');
        // Buscar animal novamente para carregar dados completos
        if (brinco) {
          setTimeout(() => {
            window.buscarBrincoV3(brinco);
          }, 500);
        }
      } else {
        const error = await response.json();
        mostrarToast(error.mensagem || 'Erro ao cadastrar animal', 'error');
      }
    } catch (error) {
      console.error('Erro ao cadastrar animal:', error);
      mostrarToast('Erro ao cadastrar animal', 'error');
    }
  }

  // ========== BUSCAR BRINCO ==========
  // Tornar função disponível globalmente ANTES de ser usada
  window.buscarBrincoV3 = async function(brincoParam) {
    // Se receber brinco como parâmetro, usar ele; senão, pegar do input
    let brinco = brincoParam;
    if (!brinco) {
      brinco = document.getElementById('brincoInputV3')?.value.trim() || '';
    }
    
    if (!brinco) {
      mostrarToast('Digite o número de manejo, SISBOV ou RFID', 'warning');
      return;
    }
    
    // Limpar o código: remover espaços, traços e outros caracteres especiais
    // Manter apenas números e letras
    brinco = String(brinco).trim().replace(/[\s\-\.]/g, '');
    
    // Validar se o código não está vazio após limpeza
    if (!brinco || brinco.length === 0) {
      mostrarToast('Código inválido. Digite o número de manejo, SISBOV ou RFID', 'warning');
      return;
    }
    
    console.log('🔍 Buscando animal com código:', brinco, '(tamanho:', brinco.length, 'dígitos)');
    
    // Atualizar o input se foi passado como parâmetro
    const brincoInput = document.getElementById('brincoInputV3');
    if (brincoInput && brincoParam) {
      brincoInput.value = brinco;
    }

    mostrarLoading(true);
    
    try {
      // Tentar primeiro com GET (método padrão da API)
      let response;
      let data;
      
      try {
        // Método GET com parâmetro na URL
        const urlComParametro = identificarUrl + (identificarUrl.includes('?') ? '&' : '?') + 'codigo=' + encodeURIComponent(brinco);
        console.log('🔍 Tentando buscar com GET:', urlComParametro);
        
        response = await fetch(urlComParametro, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}`);
        }
        
        data = await response.json();
        console.log('📡 ========== RESPOSTA DA API (GET) ==========');
        console.log('📡 Resposta completa:', data);
        console.log('📡 Status:', data.status);
        console.log('📡 Código buscado:', brinco);
        
        if (data.status === 'estoque' || data.status === 'estoque_multiplos') {
          console.log('📦 ========== BRINCO EM ESTOQUE DETECTADO (GET) ==========');
          console.log('📦 Dados do brinco:', data.dados || data);
        }
      } catch (getError) {
        console.warn('⚠️ Erro com GET, tentando POST:', getError);
        
        // Se GET falhar, tentar POST
        response = await fetch(identificarUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ codigo: brinco })
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}`);
        }
        
        data = await response.json();
        console.log('📡 ========== RESPOSTA DA API (POST) ==========');
        console.log('📡 Resposta completa:', data);
        console.log('📡 Status:', data.status);
        console.log('📡 Código buscado:', brinco);
        
        if (data.status === 'estoque' || data.status === 'estoque_multiplos') {
          console.log('📦 ========== BRINCO EM ESTOQUE DETECTADO (POST) ==========');
          console.log('📦 Dados do brinco:', data.dados || data);
        }
      }
      
      // Verificar se a resposta é válida
      if (!data) {
        throw new Error('Resposta vazia da API');
      }

      mostrarLoading(false);
      
      console.log('📥 Resposta da API:', data);
      console.log('📊 Status:', data.status);
      console.log('📋 Dados:', data.dados);
      console.log('🔍 Código buscado:', brinco);
      
      // Verificar se houve erro na resposta
      if (!data || data.status === 'erro') {
        console.error('❌ Erro na resposta da API:', data);
        mostrarLoading(false);
        mostrarToast(data?.mensagem || data?.erro || 'Erro ao buscar animal. Tente novamente.', 'error');
        return;
      }
      
      // Se não encontrou, mostrar mensagem mais específica
      if (data.status !== 'animal' && data.status !== 'estoque' && data.status !== 'duplicidade') {
        console.warn('⚠️ Animal não encontrado. Status:', data.status);
        console.warn('⚠️ Mensagem:', data.mensagem || data.erro || 'Animal não encontrado');
        console.warn('⚠️ Código buscado:', brinco, 'Tamanho:', brinco.length);
        
        // Verificar se é um SISBOV completo (15 dígitos)
        if (brinco.length === 15 && /^\d+$/.test(brinco)) {
          console.log('ℹ️ Código parece ser um SISBOV completo (15 dígitos)');
          mostrarToast(`SISBOV ${brinco} não encontrado. Verifique se o código está correto.`, 'error');
        } else if (brinco.length === 6 && /^\d+$/.test(brinco)) {
          console.log('ℹ️ Código parece ser um número de manejo (6 dígitos)');
          mostrarToast(`Número de manejo ${brinco} não encontrado. Verifique se o código está correto.`, 'error');
        } else {
          mostrarToast(data.mensagem || data.erro || 'Animal não encontrado. Verifique o código digitado.', 'error');
        }
        return;
      }

      // Tratar duplicidade (múltiplos animais encontrados)
      if (data.status === 'duplicidade' && data.animais) {
        abrirModalDuplicidade(data.animais, data.codigo_lido, data.mensagem);
        mostrarToast(data.mensagem || 'Múltiplos animais encontrados. Selecione o correto.', 'warning');
        return;
      }
      
      // A view retorna status: 'animal' com dados em 'dados'
      if (data.status === 'animal' && data.dados) {
        try {
          animalAtualV3 = data.dados;
          brincoAtualV3 = brinco;
          
          console.log('Animal encontrado:', data.dados);
          
          // Atualizar o campo de busca com o número de manejo (mais legível)
          const brincoInput = document.getElementById('brincoInputV3');
          if (brincoInput && data.dados.numero_manejo) {
            brincoInput.value = data.dados.numero_manejo;
            console.log('📝 Campo de busca atualizado com número de manejo:', data.dados.numero_manejo);
          }
          
          // Preencher resumo - tabela sempre visível
          const codigoEletronico = document.getElementById('scannerCodigoEletronicoV3');
          const sisbov = document.getElementById('scannerSisbovV3');
          const numeroManejo = document.getElementById('scannerNumeroManejoV3');
          const racaInput = document.getElementById('scannerRacaV3');
          const sexoSelect = document.getElementById('scannerSexoV3');
          const dataNasc = document.getElementById('scannerDataNascV3');
          const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
          const categoria = document.getElementById('scannerCategoriaV3');
          const pastoLote = document.getElementById('scannerPastoLoteV3');
          
          // Preencher código eletrônico (Brinco/Botton RFID - CHIP)
          if (codigoEletronico) {
            const codigoEletronicoValor = data.dados.codigo_eletronico || data.dados.numero_brinco || '';
            // Verificar se o valor não é vazio, null, undefined ou 'None'
            if (codigoEletronicoValor && codigoEletronicoValor !== 'None' && codigoEletronicoValor !== 'null' && String(codigoEletronicoValor).trim() !== '') {
              codigoEletronico.textContent = String(codigoEletronicoValor).trim();
              codigoEletronico.style.fontWeight = '700';
              codigoEletronico.style.fontSize = '1.25rem';
              codigoEletronico.style.color = 'var(--text-primary)';
            } else {
              codigoEletronico.textContent = '—';
            }
          }
          if (sisbov) {
            sisbov.textContent = data.dados.codigo_sisbov || '—';
            sisbov.className = 'resumo-value resumo-sisbov';
            // Aplicar estilos inline para garantir que a cor azul seja aplicada
            sisbov.style.color = '#2196F3';
            sisbov.style.fontSize = '1.25rem';
            sisbov.style.fontWeight = '700';
          }
          if (numeroManejo) {
            numeroManejo.textContent = data.dados.numero_manejo || '—';
            numeroManejo.className = 'resumo-value resumo-numero-manejo';
            // Aplicar estilos inline para garantir que a cor verde seja aplicada
            numeroManejo.style.color = '#4CAF50';
            numeroManejo.style.fontSize = '1.75rem';
            numeroManejo.style.fontWeight = '700';
          }
          
          // Preencher campos editáveis
          if (racaInput) racaInput.value = data.dados.raca || '';
          
          // Converter sexo de display (Fêmea/Macho) para código (F/M)
          if (sexoSelect && data.dados.sexo) {
            const sexoStr = String(data.dados.sexo).toUpperCase();
            if (sexoStr.includes('FÊMEA') || sexoStr.includes('FEMEA') || sexoStr === 'F') {
              sexoSelect.value = 'F';
            } else if (sexoStr.includes('MACHO') || sexoStr === 'M') {
              sexoSelect.value = 'M';
            } else {
              sexoSelect.value = '';
            }
          }
          
          // Formatar data de nascimento para input type="date" (formato YYYY-MM-DD)
          const idadeSpan = document.getElementById('scannerIdadeV3');
          if (dataNasc && data.dados.data_nascimento) {
            let dataNascObj = null;
            const dataNascStr = String(data.dados.data_nascimento).trim();
            
            // Tentar diferentes formatos de data
            if (dataNascStr.includes('/')) {
              // Formato DD/MM/YYYY
              const partes = dataNascStr.split('/');
              if (partes.length === 3) {
                dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
              }
            } else if (dataNascStr.includes('-')) {
              // Formato YYYY-MM-DD ou DD-MM-YYYY
              const partes = dataNascStr.split('-');
              if (partes.length === 3) {
                if (partes[0].length === 4) {
                  // YYYY-MM-DD
                  dataNascObj = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
                } else {
                  // DD-MM-YYYY
                  dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
                }
              }
            } else {
              // Tentar como Date ISO
              dataNascObj = new Date(data.dados.data_nascimento);
            }
            
            if (dataNascObj && !isNaN(dataNascObj.getTime())) {
              const year = dataNascObj.getFullYear();
              const month = String(dataNascObj.getMonth() + 1).padStart(2, '0');
              const day = String(dataNascObj.getDate()).padStart(2, '0');
              dataNasc.value = `${year}-${month}-${day}`;
              // Calcular e exibir idade
              if (idadeSpan) {
                if (typeof calcularIdade === 'function') {
                const idade = calcularIdade(dataNasc.value);
                idadeSpan.textContent = idade ? `Idade: ${idade}` : '—';
                } else {
                  // Calcular idade manualmente se a função não existir
                  const hoje = new Date();
                  const nasc = dataNascObj;
                  const diffTime = hoje - nasc;
                  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                  const anos = Math.floor(diffDays / 365);
                  const meses = Math.floor((diffDays % 365) / 30);
                  if (anos > 0) {
                    idadeSpan.textContent = `Idade: ${anos} ano${anos > 1 ? 's' : ''}${meses > 0 ? ` e ${meses} mês${meses > 1 ? 'es' : ''}` : ''}`;
                  } else if (meses > 0) {
                    idadeSpan.textContent = `Idade: ${meses} mês${meses > 1 ? 'es' : ''}`;
                  } else {
                    idadeSpan.textContent = `Idade: ${diffDays} dia${diffDays > 1 ? 's' : ''}`;
                  }
                }
              }
            } else {
              dataNasc.value = '';
              if (idadeSpan) idadeSpan.textContent = '—';
            }
          } else if (dataNasc) {
            dataNasc.value = '';
            if (idadeSpan) idadeSpan.textContent = '—';
          }
          
          if (ultimoPeso) {
            ultimoPeso.value = data.dados.peso_atual ? parseFloat(data.dados.peso_atual).toFixed(1) : '';
          }
          
          if (categoria) categoria.value = data.dados.categoria_nome || data.dados.categoria || '';
          if (pastoLote) pastoLote.value = data.dados.pasto_nome || data.dados.lote_nome || '';
          
          // Atualizar campo CONFORME BND (animal já cadastrado = verde)
          if (typeof atualizarConformeBnd === 'function') {
          atualizarConformeBnd(data.dados, false);
          } else {
            console.warn('⚠️ Função atualizarConformeBnd não está definida');
          }
          
          // Configurar event listeners para salvar automaticamente quando editar
          if (typeof configurarCamposEditaveis === 'function') {
          configurarCamposEditaveis();
          } else {
            console.warn('⚠️ Função configurarCamposEditaveis não está definida');
          }
          
          // Tabela sempre visível, não precisa mudar display
          
          // Habilitar campo de peso - CRÍTICO: sempre habilitar quando animal é encontrado
          const pesoInput = document.getElementById('pesoValorV3');
          const pesoBtn = document.getElementById('pesoGravarBtnV3');
          const finalizarBtn = document.getElementById('btnFinalizarGravarV3');
          
          console.log('Habilitando campos de peso...');
          console.log('pesoInput encontrado:', !!pesoInput);
          console.log('pesoBtn encontrado:', !!pesoBtn);
          console.log('finalizarBtn encontrado:', !!finalizarBtn);
          
          if (pesoInput) {
            pesoInput.disabled = false;
            pesoInput.removeAttribute('disabled');
            pesoInput.focus();
            console.log('Campo de peso habilitado');
          } else {
            console.error('Campo pesoValorV3 não encontrado!');
          }
          
          if (pesoBtn) {
            pesoBtn.disabled = false;
            pesoBtn.removeAttribute('disabled');
            console.log('Botão gravar habilitado');
          } else {
            console.error('Botão pesoGravarBtnV3 não encontrado!');
          }
          
          // Habilitar botão finalizar se houver manejos ou peso
          if (finalizarBtn) {
            // Sempre habilitar quando animal é encontrado (pode adicionar peso ou manejos)
            finalizarBtn.disabled = false;
            finalizarBtn.removeAttribute('disabled');
            console.log('Botão finalizar habilitado');
          } else {
            console.error('Botão btnFinalizarGravarV3 não encontrado!');
          }
          
          // Atualizar resumo de pesagem e termômetro se houver dados
          if (data.dados.peso_atual) {
            const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
            const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
            let ganhoDiario = 0;
            let ganhoTotal = 0;
            
            // Tentar obter ganho diário do backend
            if (data.dados.ganho_diario_medio) {
              ganhoDiario = parseFloat(data.dados.ganho_diario_medio);
            } else if (data.dados.peso_anterior && data.dados.data_peso_anterior) {
              // Calcular ganho diário se não vier do backend
              const pesoAtual = parseFloat(data.dados.peso_atual) || 0;
              const pesoAnterior = parseFloat(data.dados.peso_anterior) || 0;
              ganhoTotal = pesoAtual - pesoAnterior;
              
              // Atualizar ganho total com cores dinâmicas
              if (pesoGanhoTotal) {
                pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
                pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
                if (ganhoTotal > 0) {
                  pesoGanhoTotal.classList.add('ganho-positivo');
                } else if (ganhoTotal < 0) {
                  pesoGanhoTotal.classList.add('ganho-negativo');
                }
              }
              
              try {
                const dataAnterior = new Date(data.dados.data_peso_anterior);
                const dataAtual = data.dados.data_peso_atual ? new Date(data.dados.data_peso_atual) : new Date();
                const diffTime = Math.abs(dataAtual - dataAnterior);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                  ganhoDiario = ganhoTotal / diffDays;
                }
              } catch (e) {
                console.warn('Erro ao calcular ganho diário:', e);
              }
            }
            
            // Atualizar termômetro de eficiência
            if (ganhoDiario > 0) {
              if (typeof atualizarGaugeEficiencia === 'function') {
                atualizarGaugeEficiencia(ganhoDiario);
              } else if (typeof window.atualizarGaugeEficiencia === 'function') {
                window.atualizarGaugeEficiencia(ganhoDiario);
              } else {
                console.warn('⚠️ Função atualizarGaugeEficiencia não está definida');
              }
            }
          }
          
          // Focar no campo de peso após carregar animal (reutilizando variável já declarada)
          if (pesoInput) {
            setTimeout(() => {
              pesoInput.focus();
            }, 300);
          }
          
        } catch (error) {
          console.error('❌ Erro ao processar dados do animal:', error);
          console.error('❌ Stack trace:', error.stack);
          console.error('❌ Dados do animal que causaram o erro:', data.dados);
          const mensagemErro = error.message || 'Erro desconhecido ao processar dados do animal';
          mostrarToast(`Erro ao processar dados do animal: ${mensagemErro}`, 'error');
          
          // Tentar preencher pelo menos os campos básicos mesmo com erro
          try {
            const sisbov = document.getElementById('scannerSisbovV3');
            const numeroManejo = document.getElementById('scannerNumeroManejoV3');
            if (sisbov && data.dados.codigo_sisbov) {
              sisbov.textContent = data.dados.codigo_sisbov;
            }
            if (numeroManejo && data.dados.numero_manejo) {
              numeroManejo.textContent = data.dados.numero_manejo;
            }
            
            // Habilitar campo de peso mesmo com erro
            const pesoInput = document.getElementById('pesoValorV3');
            if (pesoInput) {
              pesoInput.disabled = false;
              pesoInput.removeAttribute('disabled');
            }
          } catch (fallbackError) {
            console.error('❌ Erro no fallback:', fallbackError);
          }
        }
      } else if (data.status === 'estoque' || data.status === 'estoque_multiplos') {
        // Brinco está no estoque - abrir modal de cadastro
        console.log('📦 Brinco encontrado no estoque!');
        console.log('📦 Status:', data.status);
        console.log('📦 Dados recebidos:', data.dados || data);
        console.log('📦 Código:', brinco);
        
        mostrarLoading(false);
        
        // Se houver múltiplos brincos, usar o primeiro ou permitir seleção
        let dadosBrinco = data.dados;
        if (data.status === 'estoque_multiplos' && data.brincos && data.brincos.length > 0) {
          console.log('📦 Múltiplos brincos encontrados, usando o primeiro:', data.brincos[0]);
          dadosBrinco = data.brincos[0];
        }
        
        if (typeof window.abrirCadastroEstoqueV3 === 'function') {
          console.log('✅ Chamando abrirCadastroEstoqueV3...');
          window.abrirCadastroEstoqueV3(dadosBrinco || {}, brinco);
          mostrarToast('Brinco encontrado no estoque. Preencha os dados para cadastrar o animal.', 'info');
        } else {
          console.error('❌ Função abrirCadastroEstoqueV3 não está disponível!');
          mostrarToast('Brinco encontrado no estoque. Use a opção de cadastro.', 'info');
        }
      } else {
        // Animal não encontrado
        console.warn('Animal não encontrado para código:', brinco);
        mostrarToast(data.mensagem || data.erro || 'Animal não encontrado', 'error');
      }
    } catch (error) {
      console.error('Erro ao buscar brinco:', error);
      mostrarLoading(false);
      mostrarToast('Erro ao buscar animal: ' + (error.message || 'Erro desconhecido'), 'error');
    }
  };
  
  // ========== FUNÇÃO PARA GRAVAR PESAGEM ==========
  window.gravarPesagemV3 = async function() {
    if (!animalAtualV3 || !animalAtualV3.id) {
      mostrarToast('Nenhum animal identificado. Busque um animal primeiro.', 'warning');
      return false;
    }
    
    const pesoInput = document.getElementById('pesoValorV3');
    if (!pesoInput) {
      mostrarToast('Campo de peso não encontrado.', 'error');
      return false;
    }
    
    const pesoStr = pesoInput.value.trim().replace(',', '.');
    if (!pesoStr || pesoStr === '') {
      mostrarToast('Digite o peso do animal.', 'warning');
      pesoInput.focus();
      return false;
    }
    
    const pesoNumero = parseFloat(pesoStr);
    if (isNaN(pesoNumero) || pesoNumero <= 0) {
      mostrarToast('Peso inválido. Digite um valor maior que zero.', 'error');
      pesoInput.focus();
      return false;
    }
    
    mostrarLoading(true);
    
    try {
      const response = await fetch(registrarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          tipo_fluxo: 'animal',
          codigo: brincoAtualV3 || animalAtualV3.codigo_sisbov || animalAtualV3.numero_brinco || animalAtualV3.numero_manejo,
          animal_id: animalAtualV3.id,
          manejo: 'PESAGEM',
          dados: {
            peso_kg: pesoNumero
          }
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ mensagem: `Erro ${response.status}` }));
        throw new Error(errorData.mensagem || `Erro ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.status === 'ok' || data.status === 'sucesso') {
        console.log('✅ Pesagem gravada com sucesso!', data);
        mostrarToast('Pesagem gravada com sucesso!', 'success');
        
        // Atualizar campo "Peso Registrado"
        const pesoRegistrado = document.getElementById('pesoRegistradoV3');
        if (pesoRegistrado) {
          pesoRegistrado.textContent = `${pesoNumero.toFixed(1).replace('.', ',')} kg`;
        }
        
        // Atualizar "Último Peso" no card de identificação
        const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
        if (ultimoPeso) {
          ultimoPeso.value = pesoNumero.toFixed(1);
        }
        
        // Atualizar data da última pesagem
        const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
        if (pesoUltimoData) {
          const agora = new Date();
          pesoUltimoData.textContent = agora.toLocaleDateString('pt-BR');
        }
        
        // Atualizar animal atual com novo peso
        if (animalAtualV3) {
          animalAtualV3.peso_atual = pesoNumero;
          animalAtualV3.data_peso_atual = new Date().toISOString();
        }
        
        // Recalcular ganhos
        if (animalAtualV3 && animalAtualV3.peso_anterior) {
          const ganhoTotal = pesoNumero - parseFloat(animalAtualV3.peso_anterior);
          const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
          if (pesoGanhoTotal) {
            pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
            pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
            if (ganhoTotal > 0) {
              pesoGanhoTotal.classList.add('ganho-positivo');
            } else if (ganhoTotal < 0) {
              pesoGanhoTotal.classList.add('ganho-negativo');
            }
          }
        }
        
        // Atualizar estatísticas da sessão e indicadores (com await para garantir atualização)
        if (typeof window.atualizarEstatisticasV3 === 'function') {
          await window.atualizarEstatisticasV3();
        }
        
        // FLUXO PERFEITO: Limpar apenas o campo de peso (mantém animal identificado)
        // Conforme documentação: "Campo de Peso: É limpo após gravar pesagem"
        // "Campo de Busca: Nunca é limpo automaticamente após gravar pesagem"
        pesoInput.value = '';
        pesoInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        // FLUXO PERFEITO: Focar no campo de busca para facilitar próxima entrada
        // Conforme documentação: "Foca no campo de busca para facilitar próxima entrada"
        const brincoInput = document.getElementById('brincoInputV3');
        if (brincoInput) {
          setTimeout(() => {
            brincoInput.focus();
          }, 200);
        }
        
        return true;
      } else {
        throw new Error(data.mensagem || 'Erro ao gravar pesagem');
      }
    } catch (error) {
      console.error('❌ Erro ao gravar pesagem:', error);
      mostrarToast('Erro ao gravar pesagem: ' + (error.message || 'Erro desconhecido'), 'error');
      return false;
    } finally {
      mostrarLoading(false);
    }
  };
  
  // ========== FUNÇÃO PARA FINALIZAR E GRAVAR MANEJOS ==========
  window.finalizarEGravarV3 = async function() {
    if (!animalAtualV3 || !animalAtualV3.id) {
      mostrarToast('Nenhum animal identificado. Busque um animal primeiro.', 'warning');
      return false;
    }
    
    const pesoInput = document.getElementById('pesoValorV3');
    const pesoStr = pesoInput ? pesoInput.value.trim().replace(',', '.') : '';
    const temPeso = pesoStr && !isNaN(parseFloat(pesoStr)) && parseFloat(pesoStr) > 0;
    
    // Se houver peso, gravar pesagem primeiro
    if (temPeso && typeof window.gravarPesagemV3 === 'function') {
      console.log('💾 Gravando pesagem antes dos manejos...');
      const pesagemGravada = await window.gravarPesagemV3();
      if (!pesagemGravada) {
        console.warn('⚠️ Erro ao gravar pesagem, mas continuando com manejos...');
      }
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Verificar se há manejos selecionados
    const temManejos = manejosSelecionadosV3 && manejosSelecionadosV3.length > 0;
    
    if (!temManejos) {
      if (temPeso) {
        mostrarToast('Pesagem gravada com sucesso!', 'success');
        return true;
      } else {
        mostrarToast('Nenhum peso ou manejo para gravar.', 'warning');
        return false;
      }
    }
    
    // Registrar manejos
    try {
      const manejosUrl = `/propriedade/${propriedadeId}/curral/api/manejos/registrar/`;
      const response = await fetch(manejosUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          tipo_fluxo: 'animal',
          codigo: brincoAtualV3 || animalAtualV3.codigo_sisbov || animalAtualV3.numero_brinco || animalAtualV3.numero_manejo,
          animal_id: animalAtualV3.id,
          manejos: manejosSelecionadosV3
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ mensagem: `Erro ${response.status}` }));
        throw new Error(errorData.mensagem || `Erro ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.status === 'ok' || data.status === 'sucesso') {
        console.log('✅ Manejos gravados com sucesso!', data);
        mostrarToast('Manejos gravados com sucesso!', 'success');
        
        // Limpar manejos selecionados
        manejosSelecionadosV3 = [];
        
        // Atualizar estatísticas
        if (typeof window.atualizarEstatisticasV3 === 'function') {
          await window.atualizarEstatisticasV3();
        }
        
        return true;
      } else {
        throw new Error(data.mensagem || 'Erro ao gravar manejos');
      }
    } catch (error) {
      console.error('❌ Erro ao gravar manejos:', error);
      mostrarToast('Erro ao gravar manejos: ' + (error.message || 'Erro desconhecido'), 'error');
      return false;
    }
  };
  
  // ========== FUNÇÃO PARA ATUALIZAR ESTATÍSTICAS ==========
  window.atualizarEstatisticasV3 = async function() {
    try {
      // Atualizar estatísticas da sessão
      if (statsSessaoUrl) {
        const response = await fetch(statsSessaoUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('📊 Estatísticas da sessão recebidas:', data);
          
          // A API retorna os dados dentro de 'stats'
          const stats = data.stats || data;
          
          // Atualizar contadores da sessão
          const sessaoStatEventos = document.getElementById('sessaoStatEventosV3');
          const sessaoStatAnimais = document.getElementById('sessaoStatAnimaisV3');
          const sessaoStatPesagens = document.getElementById('sessaoStatPesagensV3');
          
          if (sessaoStatEventos && stats.total_eventos !== undefined) {
            sessaoStatEventos.textContent = stats.total_eventos || 0;
          }
          if (sessaoStatAnimais && stats.animais_processados !== undefined) {
            sessaoStatAnimais.textContent = stats.animais_processados || 0;
          }
          if (sessaoStatPesagens && stats.pesagens !== undefined) {
            sessaoStatPesagens.textContent = stats.pesagens || 0;
          }
        }
      }
      
      // Atualizar estatísticas gerais
      if (statsUrl) {
        const response = await fetch(statsUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('📊 Estatísticas gerais recebidas:', data);
          
          // Atualizar indicadores do card direito
          const statTotalAnimais = document.getElementById('statTotalAnimais');
          const statTrabalhados = document.getElementById('statTrabalhados');
          const statMachos = document.getElementById('statMachos');
          const statFemeas = document.getElementById('statFemeas');
          const statMediaPeso = document.getElementById('statMediaPeso');
          const statCategorias = document.getElementById('statCategorias');
          const statTotalPesagens = document.getElementById('statTotalPesagens');
          const statGanhoMedioDia = document.getElementById('statGanhoMedioDia');
          const statGanhoPositivo = document.getElementById('statGanhoPositivo');
          const statGanhoNegativo = document.getElementById('statGanhoNegativo');
          
          // Atualizar todos os campos retornados pela API
          if (statTotalAnimais && data.total_animais !== undefined) {
            statTotalAnimais.textContent = data.total_animais || 0;
          }
          
          if (statTrabalhados && data.animais_trabalhados !== undefined) {
            statTrabalhados.textContent = data.animais_trabalhados || 0;
          }
          
          if (statMachos && data.machos !== undefined) {
            statMachos.textContent = data.machos || 0;
          }
          
          if (statFemeas && data.femeas !== undefined) {
            statFemeas.textContent = data.femeas || 0;
          }
          
          if (statMediaPeso) {
            if (data.media_peso !== undefined && data.media_peso !== null) {
              statMediaPeso.textContent = `${data.media_peso} kg`;
            } else {
              statMediaPeso.textContent = '—';
            }
          }
          
          if (statCategorias && data.por_categoria !== undefined) {
            statCategorias.textContent = data.por_categoria || '—';
          }
          
          if (statTotalPesagens && data.pesagens_hoje !== undefined) {
            statTotalPesagens.textContent = data.pesagens_hoje || 0;
          }
          
          if (statGanhoMedioDia) {
            if (data.ganho_medio_diario !== undefined && data.ganho_medio_diario !== null) {
              statGanhoMedioDia.textContent = `${data.ganho_medio_diario > 0 ? '+' : ''}${data.ganho_medio_diario} kg/dia`;
            } else {
              statGanhoMedioDia.textContent = '—';
            }
          }
          
          if (statGanhoPositivo && data.ganho_positivo !== undefined) {
            statGanhoPositivo.textContent = data.ganho_positivo || 0;
          }
          
          if (statGanhoNegativo && data.ganho_negativo !== undefined) {
            statGanhoNegativo.textContent = data.ganho_negativo || 0;
          }
          
          // Usar estatísticas da sessão para "Total de Pesagens" se não vier da API geral
          if (statTotalPesagens && (!data.pesagens_hoje || data.pesagens_hoje === 0)) {
            if (statsSessaoUrl) {
              const sessaoResponse = await fetch(statsSessaoUrl, {
                method: 'GET',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest',
                  'Accept': 'application/json'
                }
              });
              
              if (sessaoResponse.ok) {
                const sessaoData = await sessaoResponse.json();
                const sessaoStats = sessaoData.stats || sessaoData;
                
                if (statTotalPesagens && sessaoStats.pesagens !== undefined) {
                  statTotalPesagens.textContent = sessaoStats.pesagens || 0;
                }
              }
            }
          }
        }
      }
    } catch (error) {
      console.error('❌ Erro ao atualizar estatísticas:', error);
    }
  }
  
  // ========== FUNÇÕES AUXILIARES PARA SIMULADOR ==========
  
  // Mostrar popup de apartação
  function mostrarPopupApartacao(codigo, peso, apartacao) {
    const popup = document.getElementById('popupApartacao');
    if (!popup) {
      console.warn('⚠️ Popup de apartação não encontrado');
      return;
    }
    
    // Preencher dados do popup
    const animalEl = document.getElementById('popupApartacaoAnimal');
    const pesoEl = document.getElementById('popupApartacaoPeso');
    const nomeEl = document.getElementById('popupApartacaoNome');
    const faixaEl = document.getElementById('popupApartacaoFaixa');
    const badgeEl = document.getElementById('popupApartacaoBadge');
    
    if (animalEl) animalEl.textContent = codigo || '—';
    if (pesoEl) pesoEl.textContent = `${peso} kg`;
    if (nomeEl) nomeEl.textContent = apartacao.nome;
    if (faixaEl) faixaEl.textContent = `Faixa: ${apartacao.faixa}`;
    
    // Aplicar cor baseada na apartação
    if (badgeEl) {
      badgeEl.className = 'popup-apartacao-badge';
      const cores = {
        'Refugo': 'refugo',
        'Meio': 'meio',
        'Cabeceira': 'cabeca',
        'Boiada': 'boiada',
        'Boiada (Acima)': 'boiada'
      };
      const cor = cores[apartacao.nome] || '';
      if (cor) {
        badgeEl.classList.add(`apartacao-${cor}`);
      }
    }
    
    // Mostrar popup
    popup.style.display = 'block';
    setTimeout(() => {
      popup.classList.add('show');
    }, 10);
    
    // Timer de fechamento automático
    let tempoRestante = 5;
    const timerEl = document.getElementById('popupApartacaoTimer');
    
    const interval = setInterval(() => {
      tempoRestante--;
      if (timerEl) {
        timerEl.textContent = tempoRestante;
      }
      
      if (tempoRestante <= 0) {
        clearInterval(interval);
        fecharPopupApartacao();
      }
    }, 1000);
    
    // Armazenar interval para poder cancelar se necessário
    popup._apartacaoInterval = interval;
  }
  
  // Fechar popup de apartação
  function fecharPopupApartacao() {
    const popup = document.getElementById('popupApartacao');
    if (popup) {
      if (popup._apartacaoInterval) {
        clearInterval(popup._apartacaoInterval);
        popup._apartacaoInterval = null;
      }
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    }
  }
  
  // Determinar apartação baseada no peso
  function determinarApartacao(peso) {
    const pesoNum = parseFloat(peso);
    if (!pesoNum || pesoNum <= 0) return null;
    
    // Faixas padrão de apartação (podem ser configuradas)
    const faixas = {
      refugo: { min: 1, max: 200, nome: 'Refugo' },
      meio: { min: 201, max: 250, nome: 'Meio' },
      cabeca: { min: 251, max: 300, nome: 'Cabeceira' },
      boiada: { min: 301, max: 380, nome: 'Boiada' }
    };
    
    if (pesoNum >= faixas.refugo.min && pesoNum <= faixas.refugo.max) {
      return {
        nome: faixas.refugo.nome,
        faixa: `${faixas.refugo.min} a ${faixas.refugo.max} kg`,
        min: faixas.refugo.min,
        max: faixas.refugo.max
      };
    } else if (pesoNum >= faixas.meio.min && pesoNum <= faixas.meio.max) {
      return {
        nome: faixas.meio.nome,
        faixa: `${faixas.meio.min} a ${faixas.meio.max} kg`,
        min: faixas.meio.min,
        max: faixas.meio.max
      };
    } else if (pesoNum >= faixas.cabeca.min && pesoNum <= faixas.cabeca.max) {
      return {
        nome: faixas.cabeca.nome,
        faixa: `${faixas.cabeca.min} a ${faixas.cabeca.max} kg`,
        min: faixas.cabeca.min,
        max: faixas.cabeca.max
      };
    } else if (pesoNum >= faixas.boiada.min && pesoNum <= faixas.boiada.max) {
      return {
        nome: faixas.boiada.nome,
        faixa: `${faixas.boiada.min} a ${faixas.boiada.max} kg`,
        min: faixas.boiada.min,
        max: faixas.boiada.max
      };
    } else if (pesoNum > faixas.boiada.max) {
      return {
        nome: 'Boiada (Acima)',
        faixa: `Acima de ${faixas.boiada.max} kg`,
        min: faixas.boiada.max + 1,
        max: null
      };
    }
    
    return null;
  }
  
  // Registrar apartação como manejo
  async function registrarApartacaoSimulador(codigo, peso, apartacao) {
    try {
      if (!registrarManejoUrl) {
        console.warn('⚠️ URL de registrar manejo não está definida');
        return false;
      }
      
      const response = await fetch(registrarManejoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          codigo: codigo,
          tipo_fluxo: 'animal',
          manejo: 'APARTACAO',
          observacoes: `Apartação automática: ${apartacao.nome} (${apartacao.faixa}) - Peso: ${peso} kg`,
          metadados: {
            peso: peso,
            apartacao: apartacao.nome,
            faixa: apartacao.faixa,
            origem: 'simulador'
          }
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('✅ Apartação registrada:', data);
        return true;
      } else {
        const error = await response.json();
        console.warn('⚠️ Erro ao registrar apartação:', error);
        return false;
      }
    } catch (error) {
      console.error('❌ Erro ao registrar apartação:', error);
      return false;
    }
  }
  
  // Preencher e cadastrar animal em estoque via modal
  async function preencherECadastrarEstoqueSimulador(animal, codigo) {
    try {
      // Gerar dados aleatórios realistas para o animal
      const racas = ['NE', 'XX', 'AN', 'BR', 'CA', 'GU', 'GI', 'GN', 'HO', 'IN', 'MA', 'MO', 'PO', 'PR', 'RA', 'SI', 'TA', 'TR', 'ZE'];
      const sexos = ['M', 'F'];
      const raca = racas[Math.floor(Math.random() * racas.length)];
      const sexo = sexos[Math.floor(Math.random() * sexos.length)];
      
      // Idade entre 6 e 24 meses
      const idadeMeses = Math.floor(Math.random() * 18) + 6;
      const dataNascimento = new Date();
      dataNascimento.setMonth(dataNascimento.getMonth() - idadeMeses);
      const dataNascStr = dataNascimento.toISOString().split('T')[0];
      
      // Preencher campos do modal
      const racaEl = document.getElementById('cadastroRacaV3');
      const sexoEl = document.getElementById('cadastroSexoV3');
      const idadeEl = document.getElementById('cadastroIdadeV3');
      const dataNascEl = document.getElementById('cadastroDataNascV3');
      const tipoRegistroEl = document.getElementById('cadastroTipoRegistroV3');
      
      if (racaEl) {
        racaEl.value = raca;
        racaEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (sexoEl) {
        sexoEl.value = sexo;
        sexoEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (idadeEl) {
        idadeEl.value = idadeMeses;
        idadeEl.dispatchEvent(new Event('input', { bubbles: true }));
      }
      if (dataNascEl) {
        dataNascEl.value = dataNascStr;
        dataNascEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (tipoRegistroEl) {
        tipoRegistroEl.value = idadeMeses <= 12 ? 'NASCIMENTO' : 'DESMAMA';
        tipoRegistroEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      
      // Aguardar um pouco para campos serem processados
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Habilitar botão de confirmar
      const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
      if (btnConfirmar) {
        btnConfirmar.disabled = false;
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Clicar no botão de confirmar
        console.log('📝 Confirmando cadastro via botão...');
        btnConfirmar.click();
        
        // Aguardar cadastro ser processado
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
      
      return true;
    } catch (error) {
      console.error('❌ Erro ao preencher e cadastrar animal:', error);
      return false;
    }
  }
  
  // Cadastrar animal em estoque (função antiga mantida para compatibilidade)
  async function cadastrarAnimalEstoqueSimulador(animal, codigo) {
    try {
      if (!registrarManejoUrl) {
        console.warn('⚠️ URL de registrar manejo não está definida');
        return false;
      }
      
      // Gerar dados aleatórios realistas para o animal
      const racas = ['NE', 'XX', 'AN', 'BR', 'CA', 'GU', 'GI', 'GN', 'HO', 'IN', 'MA', 'MO', 'PO', 'PR', 'RA', 'SI', 'TA', 'TR', 'ZE'];
      const sexos = ['M', 'F'];
      const raca = racas[Math.floor(Math.random() * racas.length)];
      const sexo = sexos[Math.floor(Math.random() * sexos.length)];
      
      // Idade entre 6 e 24 meses
      const idadeMeses = Math.floor(Math.random() * 18) + 6;
      const dataNascimento = new Date();
      dataNascimento.setMonth(dataNascimento.getMonth() - idadeMeses);
      const dataNascStr = dataNascimento.toISOString().split('T')[0];
      
      const payload = {
        codigo: codigo,
        tipo_fluxo: 'estoque',
        manejo: 'CADASTRO_INICIAL',
        raca: raca,
        sexo: sexo,
        idade_meses: idadeMeses,
        data_nascimento: dataNascStr,
        tipo_registro: idadeMeses <= 12 ? 'NASCIMENTO' : 'DESMAMA',
        observacoes: `Cadastro automático via simulador - ${new Date().toLocaleString('pt-BR')}`
      };
      
      console.log('📝 Cadastrando animal em estoque:', payload);
      
      const response = await fetch(registrarManejoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('✅ Animal cadastrado com sucesso:', data);
        return true;
      } else {
        const error = await response.json();
        console.warn('⚠️ Erro ao cadastrar animal:', error);
        return false;
      }
    } catch (error) {
      console.error('❌ Erro ao cadastrar animal em estoque:', error);
      return false;
    }
  }
  
  // ========== IMPLEMENTAÇÃO COMPLETA DO SIMULADOR ==========
  // Variáveis do simulador (usar variável global)
  let simuladorPausado = false;
  
  // Sobrescrever o stub com a implementação completa
  window.executarSimulador = async function() {
    if (window.simuladorAtivo) {
      console.warn('⚠️ Simulador já está em execução!');
      mostrarToast('Simulador já está em execução!', 'warning');
      return;
    }
    
    window.simuladorAtivo = true;
    simuladorPausado = false;
    
    const btnSimulador = document.getElementById('btnSimulador');
    const btnParar = document.getElementById('btnPararSimulador');
    
    if (btnSimulador) {
      btnSimulador.style.display = 'none';
    }
    if (btnParar) {
      btnParar.style.display = 'inline-block';
    }
    
    console.log('🚀 ========== SIMULADOR INICIADO ==========');
    console.log('🔗 URL da API:', dadosSimulacaoUrl);
    console.log('📝 MODO: GRAVAÇÃO REAL NO BANCO DE DADOS');
    console.log('📋 FLUXO: PERFEITO (conforme documentação)');
    console.log('⚠️ ATENÇÃO: Todos os dados serão gravados permanentemente!');
    mostrarToast('🚀 Simulador iniciado! Gravando dados reais no banco...', 'success');
    
    try {
      // ========== PASSO 1: VERIFICAR/CRIAR SESSÃO ATIVA ==========
      console.log('📋 [FLUXO PERFEITO] Passo 1: Verificando sessão ativa...');
      
      // Verificar se há sessão ativa
      let sessaoAtiva = false;
      if (statsSessaoUrl) {
        try {
          const sessaoResponse = await fetch(statsSessaoUrl, {
            method: 'GET',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            }
          });
          
          if (sessaoResponse.ok) {
            const sessaoData = await sessaoResponse.json();
            sessaoAtiva = sessaoData.stats && sessaoData.stats.sessao_ativa;
            
            if (sessaoAtiva) {
              console.log('✅ Sessão ativa encontrada:', sessaoData.stats.sessao_nome);
            } else {
              console.log('⚠️ Nenhuma sessão ativa encontrada. Criando nova sessão...');
              
              // Criar nova sessão
              if (criarSessaoUrl) {
                const criarResponse = await fetch(criarSessaoUrl, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({
                    nome: `Simulação - ${new Date().toLocaleString('pt-BR')}`,
                    tipo_trabalho: 'PESAGEM',
                    observacoes: 'Sessão criada automaticamente pelo simulador'
                  })
                });
                
                if (criarResponse.ok) {
                  const criarData = await criarResponse.json();
                  console.log('✅ Nova sessão criada:', criarData);
                  sessaoAtiva = true;
                } else {
                  console.warn('⚠️ Não foi possível criar sessão, mas continuando...');
                }
              }
            }
          }
        } catch (error) {
          console.warn('⚠️ Erro ao verificar sessão:', error);
        }
      }
      
      if (!sessaoAtiva) {
        console.warn('⚠️ Continuando sem sessão ativa (eventos podem não ser registrados)');
      }
      
      // ========== PASSO 1.5: ZERAR SESSÃO E CRIAR NOVA ==========
      console.log('🔄 [FLUXO PERFEITO] Zerando sessão atual e criando nova...');
      try {
        // Encerrar sessão atual se houver
        if (encerrarSessaoUrl) {
          const encerrarResponse = await fetch(encerrarSessaoUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          if (encerrarResponse.ok) {
            console.log('✅ Sessão anterior encerrada');
          }
        }
        
        // Criar nova sessão
        if (criarSessaoUrl) {
          const criarResponse = await fetch(criarSessaoUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
              nome: `Simulação - ${new Date().toLocaleString('pt-BR')}`,
              tipo_trabalho: 'PESAGEM',
              observacoes: 'Sessão criada automaticamente pelo simulador - fluxo completo'
            })
          });
          
          if (criarResponse.ok) {
            const criarData = await criarResponse.json();
            console.log('✅ Nova sessão criada:', criarData);
            mostrarToast('Nova sessão criada. Iniciando simulação...', 'success');
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      } catch (error) {
        console.warn('⚠️ Erro ao zerar/criar sessão:', error);
      }
      
      // ========== PASSO 2: BUSCAR DADOS DE SIMULAÇÃO ==========
      console.log('📋 [FLUXO PERFEITO] Passo 2: Buscando animais para simulação...');
      // Buscar dados de simulação da API
      console.log('📡 Fazendo requisição para:', dadosSimulacaoUrl);
      const response = await fetch(dadosSimulacaoUrl, {
        method: 'GET',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('❌ Erro na resposta da API:', response.status, errorText);
        throw new Error(`Erro ao buscar dados: ${response.status} - ${errorText.substring(0, 100)}`);
      }
      
      const dados = await response.json();
      console.log('📦 Dados recebidos da API:', dados);
      console.log('📦 Status da resposta:', dados.status);
      console.log('📦 Total brincos:', dados.total_brincos);
      console.log('📦 Total animais:', dados.total_animais);
      
      // A API retorna 'animais_cadastrados' e 'brincos_estoque'
      const animaisCadastrados = dados.animais_cadastrados || [];
      const brincosEstoque = dados.brincos_estoque || [];
      
      console.log(`📋 Animais cadastrados encontrados: ${animaisCadastrados.length}`);
      console.log(`📋 Brincos em estoque encontrados: ${brincosEstoque.length}`);
      
      // Função auxiliar para extrair número de manejo do código
      const extrairNumeroManejo = (codigo) => {
        if (!codigo) return 0;
        const codigoStr = String(codigo).replace(/\D/g, '');
        // Se for SISBOV (15 dígitos), extrair posições 8-13
        if (codigoStr.length === 15) {
          return parseInt(codigoStr.substring(7, 13)) || 0;
        }
        // Se for número de manejo (6 dígitos), usar diretamente
        if (codigoStr.length >= 6) {
          return parseInt(codigoStr.substring(codigoStr.length - 6)) || 0;
        }
        return parseInt(codigoStr) || 0;
      };
      
      // Combinar animais cadastrados e brincos em estoque para simulação
      const animais = [...animaisCadastrados];
      
      // Adicionar brincos de estoque como animais para cadastro
      if (brincosEstoque && brincosEstoque.length > 0) {
        brincosEstoque.forEach(brinco => {
          const codigo = brinco.numero_brinco || brinco.codigo_sisbov;
          if (codigo) {
            animais.push({
              numero_brinco: codigo,
              codigo_sisbov: brinco.codigo_sisbov || codigo,
              numero_manejo: brinco.numero_manejo || '',
              codigo_eletronico: brinco.codigo_rfid || '',
              is_estoque: true // Marcar como brinco em estoque
            });
          }
        });
      }
      
      // Filtrar e ordenar: apenas animais/brincos a partir do número 619512
      const numeroInicial = 619512;
      const animaisFiltrados = animais.filter(animal => {
        const codigo = animal.numero_brinco || animal.codigo_sisbov || animal.numero_manejo;
        if (!codigo) return false;
        const numeroManejo = extrairNumeroManejo(codigo);
        return numeroManejo >= numeroInicial;
      });
      
      // Ordenar por número de manejo (crescente)
      animaisFiltrados.sort((a, b) => {
        const codigoA = a.numero_brinco || a.codigo_sisbov || a.numero_manejo;
        const codigoB = b.numero_brinco || b.codigo_sisbov || b.numero_manejo;
        const numeroA = extrairNumeroManejo(codigoA);
        const numeroB = extrairNumeroManejo(codigoB);
        return numeroA - numeroB;
      });
      
      console.log(`📋 Total de registros combinados: ${animais.length}`);
      console.log(`📋 Registros após filtrar a partir de ${numeroInicial}: ${animaisFiltrados.length}`);
      
      if (animaisFiltrados.length === 0) {
        const mensagem = `Nenhum animal ou brinco encontrado a partir do número ${numeroInicial}.\n\n` +
          `Total de registros disponíveis: ${animais.length}\n` +
          `Animais cadastrados: ${animaisCadastrados.length}\n` +
          `Brincos em estoque: ${brincosEstoque.length}`;
        console.warn('⚠️', mensagem);
        mostrarToast(mensagem, 'warning');
        throw new Error(`Nenhum animal disponível a partir do número ${numeroInicial}`);
      }
      
      console.log(`✅ Total de registros para processar: ${animaisFiltrados.length} (a partir de ${numeroInicial})`);
      
      console.log(`📋 Processando ${animaisFiltrados.length} animais...`);
      
      // Processar cada animal
      for (let i = 0; i < animaisFiltrados.length && window.simuladorAtivo; i++) {
        if (simuladorPausado) {
          await new Promise(resolve => {
            const checkPause = setInterval(() => {
              if (!simuladorPausado) {
                clearInterval(checkPause);
                resolve();
              }
            }, 100);
          });
        }
        
        const animal = animaisFiltrados[i];
        const codigo = animal.numero_brinco || animal.codigo_sisbov || animal.numero_manejo;
        console.log(`📋 Processando animal ${i + 1}/${animaisFiltrados.length}: ${codigo}`);
        
        if (!codigo) {
          console.warn(`⚠️ Animal ${i + 1} não tem código válido, pulando...`);
          continue;
        }
        
        // ========== FLUXO PERFEITO: PASSO 3 - IDENTIFICAR ANIMAL ==========
        console.log(`\n📋 [FLUXO PERFEITO] Animal ${i + 1}/${animaisFiltrados.length}`);
        console.log(`🔍 [PASSO 3] Identificando animal: ${codigo}`);
        
        const brincoInputSim = document.getElementById('brincoInputV3');
        const pesoInputSim = document.getElementById('pesoValorV3');
        
        // FLUXO PERFEITO: Limpar APENAS o campo de peso (mantém animal identificado se houver)
        // O campo de busca NÃO é limpo automaticamente (conforme documentação)
        if (pesoInputSim) {
          pesoInputSim.value = '';
          pesoInputSim.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        await new Promise(resolve => setTimeout(resolve, 400));
        
        // Se for brinco em estoque, processar cadastro completo
        if (animal.is_estoque) {
          console.log(`📦 [${i + 1}/${animaisFiltrados.length}] Brinco ${codigo} está em estoque - processando cadastro...`);
          
          // Limpar campo de busca
          if (brincoInputSim) {
            brincoInputSim.value = '';
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Simular digitação realista do código
            const codigoStr = String(codigo);
            for (let char of codigoStr) {
              brincoInputSim.value += char;
              brincoInputSim.dispatchEvent(new Event('input', { bubbles: true }));
              await new Promise(resolve => setTimeout(resolve, 60 + Math.random() * 40));
            }
            await new Promise(resolve => setTimeout(resolve, 300));
          }
          
          // Buscar brinco (vai abrir modal automaticamente)
          if (typeof window.buscarBrincoV3 === 'function') {
            await window.buscarBrincoV3(codigo);
            
            // Aguardar modal abrir
            let modalAberto = false;
            for (let tentativa = 0; tentativa < 20; tentativa++) {
              await new Promise(resolve => setTimeout(resolve, 300));
              const modal = document.getElementById('modalCadastroEstoque');
              if (modal && (modal.style.display === 'flex' || modal.classList.contains('show'))) {
                modalAberto = true;
                console.log(`✅ Modal de cadastro aberto após ${tentativa + 1} tentativas`);
                break;
              }
            }
            
            if (modalAberto) {
              // Preencher e cadastrar animal
              if (typeof preencherECadastrarEstoqueSimulador === 'function') {
                console.log(`📝 Preenchendo e cadastrando animal ${codigo}...`);
                await preencherECadastrarEstoqueSimulador(animal, codigo);
                
                // Aguardar modal fechar
                let modalFechado = false;
                for (let tentativa = 0; tentativa < 30; tentativa++) {
                  await new Promise(resolve => setTimeout(resolve, 300));
                  const modal = document.getElementById('modalCadastroEstoque');
                  if (!modal || modal.style.display === 'none' || !modal.classList.contains('show')) {
                    modalFechado = true;
                    console.log(`✅ Modal fechado após ${tentativa + 1} tentativas`);
                    break;
                  }
                }
                
                if (modalFechado) {
                  console.log(`✅ Animal ${codigo} cadastrado com sucesso!`);
                  // Aguardar um pouco e buscar novamente para obter dados completos
                  await new Promise(resolve => setTimeout(resolve, 1500));
                  await window.buscarBrincoV3(codigo);
                  await new Promise(resolve => setTimeout(resolve, 1500));
                  // Continuar com o fluxo normal de pesagem abaixo
                } else {
                  console.warn(`⚠️ Modal não fechou, continuando mesmo assim...`);
                  continue;
                }
              } else {
                console.error('❌ Função preencherECadastrarEstoqueSimulador não disponível!');
                continue;
              }
            } else {
              console.warn(`⚠️ Modal não abriu para ${codigo}, pulando...`);
              continue;
            }
          } else {
            console.error('❌ Função buscarBrincoV3 não está disponível!');
            continue;
          }
        }
        
        console.log(`🔍 [${i + 1}/${animaisFiltrados.length}] Buscando animal: ${codigo}`);
        
        // Limpar campo de busca apenas se necessário (para garantir busca limpa)
        if (brincoInputSim) {
          brincoInputSim.value = '';
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // Simular digitação realista do código
          const codigoStr = String(codigo);
          for (let char of codigoStr) {
            brincoInputSim.value += char;
            brincoInputSim.dispatchEvent(new Event('input', { bubbles: true }));
            await new Promise(resolve => setTimeout(resolve, 60 + Math.random() * 40));
          }
          await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        // Buscar animal usando a função real
        if (typeof window.buscarBrincoV3 === 'function') {
          await window.buscarBrincoV3(codigo);
          
          // Aguardar animal carregar completamente (verificar se campos foram preenchidos)
          let animalCarregado = false;
          for (let tentativa = 0; tentativa < 15; tentativa++) {
            await new Promise(resolve => setTimeout(resolve, 400));
            const sisbovEl = document.getElementById('scannerSisbovV3');
            const numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
            
            // Verificar se pelo menos um campo foi preenchido
            if ((sisbovEl && sisbovEl.textContent && sisbovEl.textContent !== '—') ||
                (numeroManejoEl && numeroManejoEl.textContent && numeroManejoEl.textContent !== '—')) {
              animalCarregado = true;
              console.log(`✅ Animal ${codigo} carregado após ${tentativa + 1} tentativas`);
              break;
            }
          }
          
          if (!animalCarregado) {
            console.warn(`⚠️ Animal ${codigo} não carregou após 15 tentativas, pulando...`);
            continue;
          }
          
          // Aguardar um pouco mais para garantir que tudo foi processado
          await new Promise(resolve => setTimeout(resolve, 800));
        } else {
          console.error('❌ Função buscarBrincoV3 não está disponível!');
          continue;
        }
        
        // Verificar se o campo de peso está habilitado
        const pesoInputAtual = document.getElementById('pesoValorV3');
        if (!pesoInputAtual || pesoInputAtual.disabled) {
          console.warn(`⚠️ Campo de peso não está habilitado para ${codigo}, tentando habilitar...`);
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Inserir peso sugerido baseado no peso atual ou gerar um aleatório realista
        let pesoSugerido;
        if (animal.peso_atual && animal.peso_atual > 0) {
          // Se tem peso atual, simular uma variação pequena (±5%)
          const variacao = (Math.random() * 0.1 - 0.05); // -5% a +5%
          pesoSugerido = (parseFloat(animal.peso_atual) * (1 + variacao)).toFixed(1);
        } else {
          // Gerar peso aleatório realista baseado na idade/categoria
          pesoSugerido = (Math.random() * 300 + 150).toFixed(1); // 150 a 450 kg
        }
        
        console.log(`⚖️ [${i + 1}/${animaisFiltrados.length}] Inserindo peso: ${pesoSugerido} kg`);
        
        if (pesoInputAtual) {
          // Simular digitação realista
          pesoInputAtual.focus();
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // Limpar campo
          pesoInputAtual.value = '';
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Digitar peso caractere por caractere (simulação realista)
          const pesoStr = pesoSugerido.replace('.', ',');
          for (let char of pesoStr) {
            pesoInputAtual.value += char;
            pesoInputAtual.dispatchEvent(new Event('input', { bubbles: true }));
            await new Promise(resolve => setTimeout(resolve, 80 + Math.random() * 40));
          }
          
          await new Promise(resolve => setTimeout(resolve, 300));
          
          // ========== APARTAÇÃO DURANTE PESAGEM ==========
          // Determinar apartação baseada no peso inserido
          const apartacao = determinarApartacao(pesoSugerido);
          if (apartacao) {
            console.log(`📊 [${i + 1}/${animaisFiltrados.length}] Apartação: ${apartacao.nome} (${apartacao.faixa})`);
            
            // Mostrar popup de apartação
            mostrarPopupApartacao(codigo, pesoSugerido, apartacao);
            
            // Aguardar um pouco para o usuário ver a apartação
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
        
        // ========== FLUXO PERFEITO: PASSO 4 - REGISTRAR PESAGEM ==========
        console.log(`⚖️ [PASSO 4] Registrando pesagem...`);
        console.log(`💾 [${i + 1}/${animaisFiltrados.length}] Gravando pesagem no banco de dados...`);
        
        if (typeof window.gravarPesagemV3 === 'function') {
          const sucesso = await window.gravarPesagemV3();
          
          if (sucesso) {
            console.log(`✅ [${i + 1}/${animaisFiltrados.length}] Pesagem gravada com sucesso no banco de dados!`);
            
            // FLUXO PERFEITO: Pós-gravação
            // - Atualizar campo "Peso Registrado" (já feito em gravarPesagemV3)
            // - Calcular ganhos (já feito em gravarPesagemV3)
            // - Atualizar gráfico de eficiência (já feito em gravarPesagemV3)
            // - Adicionar animal à tabela (se houver)
            // - Atualizar estatísticas da sessão
            
            // Atualizar estatísticas após gravar
            if (typeof window.atualizarEstatisticasV3 === 'function') {
              await window.atualizarEstatisticasV3();
            }
            
            // ========== APARTAÇÃO APÓS PESAGEM ==========
            // Determinar apartação baseada no peso
            const apartacao = determinarApartacao(pesoSugerido);
            if (apartacao) {
              console.log(`📊 [${i + 1}/${animaisFiltrados.length}] Apartação: ${apartacao.nome} (${apartacao.faixa})`);
              
              // Registrar apartação como manejo
              await registrarApartacaoSimulador(codigo, pesoSugerido, apartacao);
            }
            
            // Aguardar processamento completo
            await new Promise(resolve => setTimeout(resolve, 600));
          } else {
            console.error(`❌ [${i + 1}/${animaisFiltrados.length}] Erro ao gravar pesagem para ${codigo}`);
          }
        } else {
          console.error('❌ Função gravarPesagemV3 não está disponível!');
          
          // Fallback: tentar clicar no botão
          const pesoBtnSim = document.getElementById('pesoGravarBtnV3');
          if (pesoBtnSim && !pesoBtnSim.disabled) {
            console.log('🔄 Tentando gravar via clique no botão...');
            pesoBtnSim.click();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Verificar se foi gravado
            const pesoRegistrado = document.getElementById('pesoRegistradoV3');
            if (pesoRegistrado && pesoRegistrado.textContent && pesoRegistrado.textContent !== '—') {
              console.log('✅ Pesagem parece ter sido gravada via botão');
              if (typeof window.atualizarEstatisticasV3 === 'function') {
                await window.atualizarEstatisticasV3();
              }
            }
          }
        }
        
        // ========== FLUXO PERFEITO: PASSO 5 - PREPARAR PRÓXIMO ANIMAL ==========
        console.log(`🔄 [PASSO 5] Preparando para próximo animal...`);
        
        // FLUXO PERFEITO: O campo de peso já foi limpo pela função gravarPesagemV3
        // O campo de busca NÃO é limpo (conforme documentação)
        // Apenas focar no campo de busca para facilitar próxima entrada
        
        // FLUXO PERFEITO: Focar no campo de busca para facilitar próxima entrada
        // Conforme documentação: "Foca no campo de busca para facilitar próxima entrada"
        // "Campo de Busca: Nunca é limpo automaticamente após gravar pesagem"
        if (brincoInputSim) {
          setTimeout(() => {
            brincoInputSim.focus();
            // Limpar campo de busca apenas para o próximo animal (não mantém código anterior)
            brincoInputSim.value = '';
          }, 400);
        }
        
        // Aguardar entre animais (tempo realista para usuário processar)
        await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
      }
      
      console.log('\n✅ ========== SIMULADOR CONCLUÍDO ==========');
      console.log(`📊 Total de animais processados: ${animais.length}`);
      console.log(`💾 Todos os dados foram gravados no banco de dados`);
      console.log(`📈 Estatísticas atualizadas`);
      console.log(`✅ Fluxo perfeito executado com sucesso!`);
      
      mostrarToast(`✅ Simulador concluído! ${animais.length} animais processados e gravados no banco de dados.`, 'success');
      
      // Atualizar estatísticas finais
      if (typeof window.atualizarEstatisticasV3 === 'function') {
        await window.atualizarEstatisticasV3();
      }
      
    } catch (error) {
      console.error('❌ Erro no simulador:', error);
      console.error('❌ Stack trace:', error.stack);
      mostrarToast('Erro no simulador: ' + error.message, 'error');
    } finally {
      console.log('🛑 ========== SIMULADOR FINALIZADO ==========');
      window.simuladorAtivo = false;
      if (btnSimulador) {
        btnSimulador.style.display = 'inline-block';
      }
      if (btnParar) {
        btnParar.style.display = 'none';
      }
    }
  };
  
  // Implementar pararSimulador
  window.pararSimulador = function() {
    window.simuladorAtivo = false;
    simuladorPausado = false;
    console.log('🛑 Simulador parado');
    mostrarToast('Simulador parado', 'info');
    
    const btnSimulador = document.getElementById('btnSimulador');
    const btnParar = document.getElementById('btnPararSimulador');
    
    if (btnSimulador) {
      btnSimulador.style.display = 'inline-block';
    }
    if (btnParar) {
      btnParar.style.display = 'none';
    }
  };
  
  console.log('✅ Função window.executarSimulador (completa) definida e disponível!');
  console.log('✅ Função window.pararSimulador definida e disponível!');

})(); // Fim do IIFE

</script>
{% endblock %}
