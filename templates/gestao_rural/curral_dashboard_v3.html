{% extends "base_modulos_unificado.html" %}
<!-- Curral Inteligente 3.0 - Design Premium Baseado na Refer√™ncia -->
<!-- Criado em {{ "now"|date:"Y-m-d H:i:s" }} -->

{% block title %}Curral Inteligente 3.0 ¬∑ {{ propriedade.nome_propriedade }}{% endblock %}

{% block extra_css %}
<style>
  /* ========== ESCONDER MENU LATERAL E OCUPAR TELA INTEIRA ========== */
  /* Regras com m√°xima especificidade para garantir que funcionem */
  html body.curral-v3,
  body.curral-v3 {
    overflow-x: hidden !important;
    max-width: 100vw;
  }
  
  .curral-v3-content {
    max-width: 100%;
    overflow-x: hidden;
  }
  
  /* Esconder sidebar completamente */
  html body.curral-v3 nav.sidebar,
  body.curral-v3 nav.sidebar,
  html body.curral-v3 .sidebar,
  body.curral-v3 .sidebar,
  nav.sidebar {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    opacity: 0 !important;
    position: absolute !important;
    left: -9999px !important;
  }
  
  /* Main content ocupar toda a largura */
  html body.curral-v3 main.main-content,
  body.curral-v3 main.main-content,
  html body.curral-v3 .main-content,
  body.curral-v3 .main-content,
  main.main-content {
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  /* Esconder bot√£o menu mobile */
  html body.curral-v3 .btn-menu-mobile,
  body.curral-v3 .btn-menu-mobile,
  .btn-menu-mobile {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
  
  /* Header fixo ocupar toda a largura */
  html body.curral-v3 .header-fixo,
  body.curral-v3 .header-fixo,
  .header-fixo {
    margin-left: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Esconder overlay do sidebar */
  html body.curral-v3 .sidebar-overlay,
  body.curral-v3 .sidebar-overlay,
  .sidebar-overlay {
    display: none !important;
    visibility: hidden !important;
  }
  
  /* Garantir que o wrapper ocupe toda a tela */
  html body.curral-v3 .curral-v3-wrapper,
  body.curral-v3 .curral-v3-wrapper {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  /* ========== DESIGN PREMIUM CURRAL 3.0 - BASEADO NA REFER√äNCIA ========== */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
  
  :root {
    --primary: #1e88e5;
    --primary-dark: #1565c0;
    --primary-light: #42a5f5;
    --secondary: #8b5cf6;
    --accent: #ec4899;
    --success: #43a047;
    --warning: #fb8c00;
    --danger: #e53935;
    --info: #3b82f6;
    
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #ffffff;
    --bg-light: #f5f7fa;
    --bg-header: #1976d2;
    
    --text-primary: #212121;
    --text-secondary: #757575;
    --text-light: #94a3b8;
    --text-white: #ffffff;
    
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    
    --radius: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body.curral-v3 {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  .curral-v3-wrapper {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  /* ========== HEADER SUPERIOR ========== */
  .curral-v3-header {
    background: var(--bg-header);
    color: var(--text-white);
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-md);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 10000;
    backdrop-filter: blur(10px);
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
  }

  .curral-v3-header-left {
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }

  .curral-v3-header-title {
    font-size: 2.75rem;
    font-weight: 900;
    margin: 0;
    line-height: 1.2;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    color: var(--text-white);
  }

  .curral-v3-header-fazenda {
    font-size: 1.25rem;
    opacity: 1;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    color: var(--text-white);
    letter-spacing: 0.5px;
  }

  .curral-v3-header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .status-conexao {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius);
    font-size: 0.875rem;
  }

  .status-conexao-badge {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .sessao-ativa-box {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 12px 16px;
    border-radius: var(--radius);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .sessao-ativa-linha1 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: nowrap;
  }

  .sessao-ativa-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 0;
  }

  .sessao-ativa-titulo {
    font-size: 0.7rem;
    opacity: 0.95;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .sessao-ativa-nome {
    font-size: 0.8rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sessao-ativa-stats {
    display: flex;
    gap: 12px;
    font-size: 0.7rem;
    margin: 0;
    flex-shrink: 0;
  }

  .sessao-stat-item {
    text-align: center;
    min-width: 45px;
  }

  .sessao-stat-valor {
    font-size: 0.95rem;
    font-weight: 700;
    display: block;
    line-height: 1.2;
  }

  .sessao-stat-label {
    font-size: 0.65rem;
    opacity: 0.85;
    margin-top: 2px;
  }

  .sessao-ativa-linha2 {
    display: flex;
    justify-content: flex-end;
    width: 100%;
  }

  .btn-relatorios {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: var(--primary);
    border: 3px solid rgba(255, 255, 255, 0.8);
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 1.125rem;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), inset 0 2px 0 rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    min-width: 180px;
    justify-content: center;
  }

  .btn-relatorios:hover {
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 0.8);
  }
  
  .btn-relatorios:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }

  .btn-encerrar {
    background: var(--danger);
    border: none;
    color: var(--text-white);
    padding: 6px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-encerrar:hover {
    background: #c62828;
    transform: translateY(-1px);
  }

  .btn-criar-sessao {
    background: #4caf50;
    border: none;
    color: var(--text-white);
    padding: 6px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-criar-sessao:hover {
    background: #43a047;
    transform: translateY(-1px);
  }

  /* ========== CONTE√öDO PRINCIPAL ========== */
  .curral-v3-content {
    padding: 16px;
    padding-top: 60px; /* Espa√ßo para o header fixo reduzido */
    display: grid;
    grid-template-columns: 1.6fr 1.2fr 0.8fr;
    gap: 24px;
  }

  /* ========== RESPONSIVIDADE ========== */
  @media (max-width: 1400px) {
    .curral-v3-content {
      grid-template-columns: 1.4fr 1fr 0.7fr;
      gap: 20px;
      padding: 20px;
      padding-top: 60px;
    }
  }

  @media (max-width: 1200px) {
    .curral-v3-content {
      grid-template-columns: 1fr 0.9fr;
      grid-template-rows: auto auto auto 1fr;
      padding-top: 60px;
    }
    
    .card-pesagem {
      grid-column: 1 / -1;
      max-width: 100%;
    }
  }

  @media (max-width: 992px) {
    .curral-v3-content {
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      padding-top: 60px;
    }
    
    .scanner-animal-resumo {
      padding: 16px;
    }
    
    .card-pesagem {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .curral-v3-content {
      padding: 12px;
      padding-top: 60px;
      gap: 12px;
    }
    
    .scanner-animal-resumo {
      padding: 12px;
      margin-top: 12px;
    }
    
    .resumo-label {
      font-size: 0.875rem;
      width: 35%;
    }
    
    .resumo-value {
      font-size: 0.9375rem;
    }
    
    .resumo-value.resumo-sisbov,
    td.resumo-value.resumo-sisbov,
    #scannerSisbovV3.resumo-sisbov {
      font-size: 1.1rem !important;
    }
    
    .resumo-value.resumo-numero-manejo,
    td.resumo-value.resumo-numero-manejo,
    #scannerNumeroManejoV3.resumo-numero-manejo {
      font-size: 1.5rem !important;
    }
    
    .resumo-value.resumo-codigo-eletronico,
    td.resumo-value.resumo-codigo-eletronico,
    #scannerCodigoEletronicoV3.resumo-codigo-eletronico {
      font-size: 1.25rem !important;
      font-weight: 700 !important;
      color: var(--text-primary) !important;
    }
  }

  @media (max-width: 576px) {
    .curral-v3-content {
      padding: 8px;
      padding-top: 60px;
      gap: 8px;
    }
    
    .scanner-animal-resumo {
      padding: 10px;
    }
    
    .resumo-label {
      font-size: 0.75rem;
      padding-right: 8px;
    }
    
    .resumo-value {
      font-size: 0.875rem;
    }
    
    .resumo-input {
      font-size: 0.875rem;
      padding: 6px 10px;
    }
  }

  /* ========== CARD IDENTIFICA√á√ÉO E PESAGEM ========== */
  .card-curral {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 2px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.2s;
  }
  
  .card-curral:hover {
    box-shadow: var(--shadow-xl);
    border-color: rgba(30, 136, 229, 0.2);
    transform: translateY(-2px);
  }

  .card-pesagem {
    max-width: 90%;
    margin: 0 auto;
  }

  .card-curral-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    padding: 12px 16px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-curral-header h2 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-curral-body {
    padding: 16px;
  }

  .scanner-brinco-input {
    margin-bottom: 14px;
  }

  .scanner-brinco-input label {
    display: block;
    font-size: 0.875rem;
    font-weight: 800;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 10px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .scanner-brinco-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .scanner-brinco-input input {
    flex: 1;
    padding: 14px 18px;
    border: 3px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius);
    font-size: 1.125rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    transition: all 0.2s;
    background: #ffffff;
    color: var(--text-primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .scanner-brinco-input input:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    transform: translateY(-2px);
  }
  
  .scanner-brinco-input input:hover {
    border-color: rgba(30, 136, 229, 0.5);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  }

  .btn-buscar {
    background: var(--primary);
    color: var(--text-white);
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-buscar:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .scanner-animal-resumo {
    margin-top: 14px;
    padding: 16px;
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 2px solid rgba(76, 175, 80, 0.3);
  }

  .scanner-animal-resumo table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
  }

  .scanner-animal-resumo table tr {
    border-bottom: 1px solid rgba(44, 62, 45, 0.2); /* Linha mais vis√≠vel com verde escuro */
  }

  .scanner-animal-resumo table tr:last-child {
    border-bottom: none;
  }

  .scanner-animal-resumo table td {
    padding: 8px 8px;
    vertical-align: middle;
  }

  .resumo-item {
    display: table-row;
  }

  .resumo-label {
    font-size: 1.0625rem;
    color: #1a1a1a; /* Preto forte para m√°xima visibilidade */
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: 40%;
    padding-right: 16px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .resumo-value {
    font-size: 1rem;
    color: #1a1a1a; /* Preto forte para m√°xima visibilidade */
    font-weight: 700;
    text-align: right;
  }

  .resumo-value.resumo-sisbov,
  td.resumo-value.resumo-sisbov,
  #scannerSisbovV3.resumo-sisbov {
    font-size: 1.25rem !important;
    color: #2196F3 !important;
    font-weight: 700 !important;
  }

  .resumo-value.resumo-numero-manejo,
  td.resumo-value.resumo-numero-manejo,
  #scannerNumeroManejoV3.resumo-numero-manejo {
    font-size: 1.75rem !important;
    color: #4CAF50 !important;
    font-weight: 700 !important;
  }

  .resumo-input {
    width: 100%;
    background: #ffffff;
    border: 3px solid rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    padding: 10px 14px;
    color: #1a1a1a;
    font-size: 1rem;
    font-weight: 700;
    text-align: right;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .resumo-input:focus {
    outline: none;
    background: #ffffff;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }
  
  .resumo-input:hover {
    border-color: rgba(30, 136, 229, 0.4);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
  }

  .resumo-input::placeholder {
    color: rgba(26, 26, 26, 0.5); /* Placeholder mais escuro */
  }

  .resumo-input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0); /* √çcone preto no fundo claro */
    cursor: pointer;
    opacity: 0.7;
  }

  .resumo-input[type="date"]::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
  }

  /* ========== CARD PESAGEM ========== */
  .peso-display-v2 {
    text-align: center;
  }

  .peso-display-v2-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
  }

  .peso-display-v2-input-wrapper {
    position: relative;
    margin-bottom: 20px;
  }

  .peso-display-v2-input {
    width: 100%;
    padding: 16px 20px;
    font-size: 2.5rem;
    font-weight: 900;
    text-align: center;
    border: 4px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    transition: all 0.3s;
    letter-spacing: 0.05em;
    height: auto;
    min-height: 80px;
    color: var(--text-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .peso-display-v2-input:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 5px;
    box-shadow: 0 0 0 8px rgba(30, 136, 229, 0.25), 0 6px 20px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    color: var(--primary);
    transform: translateY(-3px);
    text-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
  }
  
  .peso-display-v2-input:hover {
    border-color: rgba(30, 136, 229, 0.5);
    box-shadow: 0 5px 16px rgba(0, 0, 0, 0.15);
  }

  .peso-display-v2-unit {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .peso-display-v2-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .btn-gravar {
    flex: 1;
    background: var(--success);
    color: var(--text-white);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-gravar:hover {
    background: #388e3c;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-limpar {
    background: var(--danger);
    color: var(--text-white);
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-limpar:hover {
    background: #c62828;
  }

  .btn-finalizar {
    width: 100%;
    background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
    color: var(--text-white);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-finalizar:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .peso-display-v2-info {
    text-align: left;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .peso-info-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    font-size: 1.125rem;
  }

  .peso-info-label {
    color: var(--text-secondary);
    font-weight: 700;
    font-size: 1.125rem;
  }

  .peso-info-value {
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1.25rem;
  }
  
  /* Estilo especial para Ganho Total */
  #pesoGanhoTotalV3 {
    font-weight: 900;
    font-size: 1.35rem;
  }
  
  #pesoGanhoTotalV3.ganho-positivo {
    color: #4CAF50;
  }
  
  #pesoGanhoTotalV3.ganho-negativo {
    color: #F44336;
  }

  /* ========== CARDS DE ESTAT√çSTICAS ========== */
  .stats-grid-v3 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* Tabela de Estat√≠sticas */
  .stats-table-v3 {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .stats-table-v3 table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
  }

  .stats-table-v3 thead {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }

  .stats-table-v3 th {
    padding: 18px 24px;
    text-align: left;
    font-size: 1rem;
    font-weight: 900;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-right: 1px solid rgba(0, 0, 0, 0.05);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .stats-table-v3 th:last-child {
    border-right: none;
  }

  .stats-table-v3 tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background-color 0.2s;
  }

  .stats-table-v3 tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .stats-table-v3 tbody tr:last-child {
    border-bottom: none;
  }

  .stats-table-v3 td {
    padding: 16px 24px;
    vertical-align: middle;
    border-bottom: 2px solid rgba(0, 0, 0, 0.08);
  }
  
  .stats-table-v3 tbody tr:last-child td {
    border-bottom: none;
  }

  .stat-cell-label {
    font-size: 1.125rem;
    font-weight: 800;
    color: var(--text-primary);
    padding: 14px 20px;
    vertical-align: middle;
    letter-spacing: 0.3px;
  }

  .stat-cell-value {
    font-size: 1.75rem;
    font-weight: 900;
    text-align: center;
    min-width: 120px;
    padding: 14px 20px;
    vertical-align: middle;
    letter-spacing: 0.5px;
  }

  .stat-cell-value.purple { color: #8b5cf6; }
  .stat-cell-value.pink { color: #ec4899; }
  .stat-cell-value.blue { color: #3b82f6; }
  .stat-cell-value.green { color: #43a047; }

  /* ========== CARD MANEJOS ========== */
  .manejos-selecionados {
    min-height: 200px;
  }
  
  .manejos-lista {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  
  .manejo-item-card {
    background: var(--bg-light);
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
    position: relative;
  }
  
  .manejo-item-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  
  .manejo-item-card.pesagem { border-left: 4px solid #43a047; }
  .manejo-item-card.vacinacao { border-left: 4px solid #3b82f6; }
  .manejo-item-card.tratamento { border-left: 4px solid #f59e0b; }
  .manejo-item-card.reproducao { border-left: 4px solid #ec4899; }
  .manejo-item-card.diagnostico { border-left: 4px solid #8b5cf6; }
  
  .manejo-item-info {
    flex: 1;
  }
  
  .manejo-item-titulo {
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
    font-size: 0.9375rem;
  }
  
  .manejo-item-desc {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  .manejo-item-remove {
    background: var(--danger);
    color: var(--text-white);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  
  .manejo-item-remove:hover {
    background: #c62828;
    transform: scale(1.1);
  }
  
  .manejos-acoes {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  
  .btn-manejo-tipo {
    padding: 10px 20px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    background: var(--bg-card);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }
  
  .btn-manejo-tipo:hover {
    border-color: var(--primary);
    background: rgba(30, 136, 229, 0.05);
    transform: translateY(-2px);
  }
  
  .btn-manejo-tipo.pesagem { border-color: #43a047; color: #43a047; }
  .btn-manejo-tipo.vacinacao { border-color: #3b82f6; color: #3b82f6; }
  .btn-manejo-tipo.tratamento { border-color: #f59e0b; color: #f59e0b; }
  .btn-manejo-tipo.reproducao { border-color: #ec4899; color: #ec4899; }
  .btn-manejo-tipo.diagnostico { border-color: #8b5cf6; color: #8b5cf6; }
  .btn-manejo-tipo.movimentacao { border-color: #06b6d4; color: #06b6d4; }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state-text {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .empty-state-hint {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* ========== TABELA ESTAT√çSTICAS DE LOTES ========== */
  .estatisticas-lotes {
    grid-column: 1 / -1;
    margin-top: 24px;
  }

  .table-wrapper-estatisticas-lotes {
    max-height: calc(4 * 54px + 60px); /* 4 linhas (18px padding * 2 + 18px conte√∫do) + cabe√ßalho */
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-track {
    background: var(--bg-light);
    border-radius: 4px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-thumb {
    background: var(--text-secondary);
    border-radius: 4px;
  }

  .table-wrapper-estatisticas-lotes::-webkit-scrollbar-thumb:hover {
    background: var(--text-primary);
  }

  .table-estatisticas-lotes {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    background: var(--bg-card);
  }

  .table-estatisticas-lotes thead {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .table-estatisticas-lotes thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--text-white);
    border-bottom: 3px solid rgba(0, 0, 0, 0.1);
  }

  .table-estatisticas-lotes th {
    padding: 18px 16px;
    text-align: left;
    font-weight: 700;
    color: var(--text-white);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    border-right: 1px solid rgba(255, 255, 255, 0.25);
    white-space: nowrap;
  }

  .table-estatisticas-lotes th:last-child {
    border-right: none;
  }

  .table-estatisticas-lotes tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    background: var(--bg-card);
  }

  .table-estatisticas-lotes tbody tr:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    transform: translateX(3px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .table-estatisticas-lotes tbody tr:last-child {
    border-bottom: none;
  }

  .table-estatisticas-lotes td {
    padding: 18px 16px;
    vertical-align: middle;
    border-right: 1px solid rgba(0, 0, 0, 0.05);
  }

  .table-estatisticas-lotes td:last-child {
    border-right: none;
  }

  .table-estatisticas-lotes tbody tr:nth-child(even) {
    background-color: rgba(0, 0, 0, 0.015);
  }

  .table-estatisticas-lotes tbody tr:nth-child(even):hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
  }

  .table-estatisticas-lotes .empty-state {
    padding: 60px 20px;
  }

  /* ========== TABELA ANIMAIS ========== */
  .animais-registrados {
    grid-column: 1 / -1;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .table-animais {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .table-animais thead {
    background: var(--bg-light);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }

  .table-animais th {
    padding: 12px;
    text-align: left;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .table-animais td {
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .table-animais tbody tr:hover {
    background: var(--bg-light);
  }
  
  /* Linhas ocultas da tabela de animais */
  .table-animais tbody tr.animal-oculto {
    display: none;
  }
  
  .table-animais.expandida tbody tr.animal-oculto {
    display: table-row;
  }

  /* ========== MODAL ========== */
  .modal-v3-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 10000;
    display: none;
    align-items: flex-start;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    overflow-y: auto;
    padding: 20px;
    padding-top: 20px;
    box-sizing: border-box;
  }

  .modal-v3-overlay.show {
    display: flex;
    opacity: 1;
  }
  
  .modal-v3-overlay.show .modal-v3 {
    transform: scale(1);
    margin-top: 5px;
  }

  .modal-v3 {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s;
    margin: 0 auto;
    margin-top: 5px;
  }
  
  /* Modal espec√≠fico de cadastro em paisagem */
  #modalCadastroEstoque .modal-v3 {
    max-width: 850px;
    width: 85%;
    max-height: 92vh;
    margin-top: 5px;
  }

  .cadastro-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }

  .cadastro-data-full {
    grid-column: 1 / -1;
  }
  
  /* Header do brinco em layout horizontal */
  .cadastro-header-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 12px 14px;
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
    border: 2px solid var(--primary);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    align-items: center;
  }
  
  .cadastro-header-item {
    text-align: center;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .cadastro-header-label {
    font-size: 0.7rem;
    color: var(--primary-dark);
    margin-bottom: 6px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .cadastro-header-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-dark);
    letter-spacing: 1px;
    word-break: break-all;
    line-height: 1.2;
  }
  
  .cadastro-header-item:first-child .cadastro-header-value {
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: 2px;
  }
  
  .cadastro-header-item small {
    margin-top: 3px !important;
    font-size: 0.6rem !important;
    line-height: 1.2;
  }

  @media (max-width: 1400px) {
    .modal-v3 {
      max-width: 90%;
      width: 90%;
    }
  }

  @media (max-width: 992px) {
    .modal-v3-overlay {
      padding: 10px;
    }
    
    #modalCadastroEstoque .modal-v3 {
      max-width: 95%;
      width: 95%;
      margin: 10px;
    }
    
    .modal-v3-header {
      padding: 16px 20px;
    }
    
    .modal-v3-title {
      font-size: 1.1rem;
    }
    
    .cadastro-form-grid {
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .cadastro-header-info {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .cadastro-header-value {
      font-size: 1.3rem;
    }
    
    .cadastro-header-item:first-child .cadastro-header-value {
      font-size: 1.8rem;
    }
  }

  @media (max-width: 768px) {
    .modal-v3-overlay {
      padding: 0;
    }
    
    .modal-v3 {
      max-width: 100%;
      width: 100%;
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
    }
    
    .modal-v3-header {
      padding: 14px 16px;
    }
    
    .modal-v3-title {
      font-size: 1rem;
    }
    
    .modal-v3-body {
      padding: 16px !important;
    }
    
    .cadastro-form-grid {
      grid-template-columns: 1fr !important;
      gap: 12px !important;
    }
    
    .cadastro-data-full {
      grid-column: 1;
    }
    
    /* Manter Idade e Data Nascimento na mesma linha mesmo em mobile */
    .cadastro-form-grid .form-group-v3[style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr 1fr !important;
      display: grid !important;
    }
    
    .modal-v3-footer {
      padding: 12px 16px !important;
      flex-direction: column;
      gap: 8px;
    }
    
    .modal-v3-footer .btn-v3 {
      width: 100%;
    }
  }

  .modal-v3-header {
    padding: 16px 20px;
    background: var(--primary);
    color: var(--text-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  #modalCadastroEstoque .modal-v3-header {
    padding: 12px 16px;
  }

  .modal-v3-title {
    font-size: 1.15rem;
    font-weight: 700;
    margin: 0;
  }
  
  #modalCadastroEstoque .modal-v3-title {
    font-size: 1rem;
  }

  .modal-v3-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: var(--text-white);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .modal-v3-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-v3-body {
    padding: 20px;
  }
  
  #modalCadastroEstoque .modal-v3-body {
    padding: 14px 16px;
  }

  .modal-v3-footer {
    padding: 14px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  #modalCadastroEstoque .modal-v3-footer {
    padding: 10px 16px;
  }

  .form-group-v3 {
    margin-bottom: 16px;
  }
  
  #modalCadastroEstoque .form-group-v3 {
    margin-bottom: 12px;
  }

  .form-label-v3 {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 0.875rem;
  }

  .form-input-v3 {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(0, 0, 0, 0.15);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 500;
    background: #ffffff;
    color: var(--text-primary);
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  #modalCadastroEstoque .form-input-v3 {
    padding: 11px 14px;
    font-size: 0.95rem;
  }

  .form-input-v3:focus {
    outline: none;
    border-color: var(--primary);
    border-width: 4px;
    box-shadow: 0 0 0 5px rgba(30, 136, 229, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
    background: #ffffff;
    transform: translateY(-1px);
  }
  
  .form-input-v3:hover {
    border-color: rgba(30, 136, 229, 0.4);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
  }

  .btn-v3 {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-v3-primary {
    background: var(--primary);
    color: var(--text-white);
  }

  .btn-v3-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-v3-secondary {
    background: var(--bg-light);
    color: var(--text-primary);
    border: 2px solid rgba(0, 0, 0, 0.1);
  }

  .btn-v3-secondary:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  /* ========== TOAST ========== */
  .toast-v3 {
    position: fixed;
    top: 24px;
    right: 24px;
    background: var(--bg-card);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    min-width: 300px;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(400px);
    transition: transform 0.3s;
    border-left: 4px solid var(--primary);
  }

  .toast-v3.show {
    transform: translateX(0);
  }

  .toast-v3-success { border-left-color: var(--success); }
  .toast-v3-error { border-left-color: var(--danger); }
  .toast-v3-warning { border-left-color: var(--warning); }

  /* ========== LOADING ========== */
  .loading-v3 {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10002;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .loading-v3.show {
    display: flex;
  }

  .spinner-v3 {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========== RESPONSIVO ========== */
  @media (max-width: 1400px) {
    .curral-v3-content {
      grid-template-columns: 1fr 1fr;
    }
    
    .animais-registrados {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 768px) {
    .curral-v3-content {
      grid-template-columns: 1fr;
      padding: 16px;
      padding-top: 60px;
    }
    
    .curral-v3-header {
      flex-direction: column;
      gap: 12px;
      align-items: flex-start;
      padding: 16px;
    }
    
    .curral-v3-header-right {
      width: 100%;
      flex-wrap: wrap;
    }
  }
</style>
{% endblock %}

{% block body_attrs %} class="curral-v3"{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-v3" id="loadingV3">
  <div class="spinner-v3"></div>
  <div style="color: white; font-weight: 600;">Processando...</div>
</div>

<!-- Toast Container -->
<div id="toastContainerV3"></div>

<div class="curral-v3-wrapper">
  <!-- Header Superior -->
  <div class="curral-v3-header">
    <div class="curral-v3-header-left">
      <h1 class="curral-v3-header-title">Super Tela</h1>
      <div class="curral-v3-header-fazenda">Monpec - Curral</div>
    </div>
    <div class="curral-v3-header-right">
      <button class="btn-relatorios" id="btnSimulador" onclick="(function(){try{console.log('üñ±Ô∏è Click direto no bot√£o via onclick');console.log('üîç window.iniciarSimulador:',typeof window.iniciarSimulador);console.log('üîç window.executarSimulador:',typeof window.executarSimulador);if(typeof window.iniciarSimulador==='function'){window.iniciarSimulador();}else if(typeof window.executarSimulador==='function'){if(confirm('Deseja iniciar o simulador?')){window.executarSimulador();}}else{console.error('‚ùå Fun√ß√µes n√£o dispon√≠veis');alert('Simulador ainda n√£o carregado. Aguarde alguns segundos e tente novamente.');}}catch(e){console.error('‚ùå Erro ao iniciar simulador:',e);alert('Erro ao iniciar simulador: '+e.message);}})();" style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
        <i class="fas fa-play-circle"></i> Iniciar Simulador
      </button>
      <button class="btn-relatorios" id="btnPararSimulador" onclick="if(typeof window.pararSimulador==='function'){window.pararSimulador();}else{alert('Fun√ß√£o de parar n√£o dispon√≠vel');}" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
        <i class="fas fa-stop-circle"></i> Parar Simulador
      </button>
      <button class="btn-relatorios">
        <i class="fas fa-file-alt"></i> Relat√≥rios
      </button>
      <div class="status-conexao">
        <span class="status-conexao-badge"></span>
        <span id="statusConexaoTextoV3">Online</span>
      </div>
      <div class="sessao-ativa-box">
        <!-- Linha 1: T√≠tulo + Nome + Estat√≠sticas -->
        <div class="sessao-ativa-linha1">
          <div class="sessao-ativa-info">
            <div class="sessao-ativa-titulo">
              <i class="fas fa-circle" style="font-size: 0.4rem; color: #4caf50;"></i>
              Sess√£o Ativa
            </div>
            <div class="sessao-ativa-nome" id="sessaoAtivaNomeV3">
              {% if sessao_ativa %}{{ sessao_ativa.nome }} {{ super_tela.sessao_data|default:"" }}{% else %}Nenhuma sess√£o ativa{% endif %}
            </div>
          </div>
          <div class="sessao-ativa-stats" id="sessaoAtivaStatsV3" style="display: {% if sessao_ativa %}flex{% else %}none{% endif %};">
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatEventosV3">{{ stats_sessao.total_eventos|default:0 }}</span>
              <span class="sessao-stat-label">Eventos</span>
            </div>
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatAnimaisV3">{{ stats_sessao.animais_processados|default:0 }}</span>
              <span class="sessao-stat-label">Animais</span>
            </div>
            <div class="sessao-stat-item">
              <span class="sessao-stat-valor" id="sessaoStatPesagensV3">{{ stats_sessao.pesagens|default:0 }}</span>
              <span class="sessao-stat-label">Pesagens</span>
            </div>
          </div>
        </div>
        <!-- Linha 2: Bot√£o Encerrar ou Criar Sess√£o -->
        {% if sessao_ativa %}
        <div class="sessao-ativa-linha2">
          <button class="btn-encerrar" onclick="encerrarSessaoV3()">
            <i class="fas fa-stop"></i> Encerrar
          </button>
        </div>
        {% else %}
        <div class="sessao-ativa-linha2">
          <button class="btn-criar-sessao" onclick="abrirModalCriarSessao()">
            <i class="fas fa-plus-circle"></i> Criar Nova Sess√£o
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Conte√∫do Principal -->
  <div class="curral-v3-content">
    <!-- Card Identifica√ß√£o e Pesagem -->
    <div class="card-curral">
      <div class="card-curral-header">
        <h2><i class="fas fa-qrcode"></i> Identifica√ß√£o e Pesagem</h2>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
          <span style="font-size: 0.875rem; color: var(--text-primary); font-weight: 600;">Consultar/Cadastrar Bovinos</span>
          <span style="font-size: 0.75rem; color: var(--text-secondary);">Balan√ßa conectada</span>
        </div>
      </div>
      <div class="card-curral-body">
        <div class="scanner-brinco-input">
          <label>IDENTIFICA√á√ÉO DO ANIMAL</label>
          <div style="margin-bottom: 8px; padding: 8px 12px; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; border-radius: 4px;">
            <span style="font-size: 0.875rem; color: var(--text-primary); font-weight: 700;">
              <i class="fas fa-barcode" style="margin-right: 6px;"></i>Leitura de Elemento Identificador
            </span>
          </div>
          <div class="scanner-brinco-input-wrapper">
            <input type="text" id="brincoInputV3" 
                   placeholder="SISBOV, N√∫mero de Manejo ou Brinco/Botton RFID - CHIP"
                   onkeypress="if(event.key === 'Enter') buscarBrincoV3()">
            <button class="btn-buscar" onclick="buscarBrincoV3()">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <small style="display: block; margin-top: 8px; color: var(--text-secondary); font-size: 0.75rem;">
            Busque por: <strong>SISBOV</strong> (ID principal), <strong>N√∫mero de Manejo</strong> ou <strong>Brinco/Botton RFID - CHIP</strong>
          </small>
        </div>
        
        <div class="scanner-animal-resumo" id="scannerAnimalResumoV3">
          <table>
            <tr class="resumo-item">
              <td class="resumo-label">N√∫mero de Manejo:</td>
              <td class="resumo-value resumo-numero-manejo" id="scannerNumeroManejoV3">‚Äî</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">SISBOV:</td>
              <td class="resumo-value resumo-sisbov" id="scannerSisbovV3">‚Äî</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Brinco/Botton RFID - CHIP:</td>
              <td class="resumo-value resumo-codigo-eletronico" id="scannerCodigoEletronicoV3">‚Äî</td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Ra√ßa / Sexo:</td>
              <td class="resumo-value">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="text" class="resumo-input" id="scannerRacaV3" placeholder="Ra√ßa" style="flex: 1;">
                  <select class="resumo-input" id="scannerSexoV3" style="width: 100px;">
                    <option value="">Sexo</option>
                    <option value="F">F√™mea</option>
                    <option value="M">Macho</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Nascimento:</td>
              <td class="resumo-value">
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                  <input type="date" class="resumo-input" id="scannerDataNascV3" style="width: 100%;">
                  <span id="scannerIdadeV3" style="font-size: 0.75rem; color: #2c3e2d; font-weight: 700;">‚Äî</span>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">√öltimo peso:</td>
              <td class="resumo-value">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" class="resumo-input" id="scannerUltimoPesoV3" placeholder="Peso" step="0.1" min="0" style="flex: 1;">
                  <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">kg</span>
                </div>
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Categoria:</td>
              <td class="resumo-value">
                <input type="text" class="resumo-input" id="scannerCategoriaV3" placeholder="Categoria">
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Pasto/Lote:</td>
              <td class="resumo-value">
                <input type="text" class="resumo-input" id="scannerPastoLoteV3" placeholder="Pasto/Lote">
              </td>
            </tr>
            <tr class="resumo-item">
              <td class="resumo-label">Conforme BND:</td>
              <td class="resumo-value">
                <span id="scannerConformeBndV3" class="conforme-bnd-badge" style="
                  display: inline-block;
                  padding: 6px 12px;
                  border-radius: 6px;
                  font-weight: 700;
                  font-size: 0.875rem;
                  text-align: center;
                  min-width: 100px;
                ">‚Äî</span>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Card Registro de Pesagem -->
    <div class="card-curral card-pesagem">
      <div class="card-curral-header">
        <h2><i class="fas fa-weight"></i> Registro de Pesagem</h2>
      </div>
      <div class="card-curral-body">
        <div class="peso-display-v2">
          <div class="peso-display-v2-label">REGISTRO DE PESAGEM</div>
          <div class="peso-display-v2-input-wrapper">
            <input type="text" id="pesoValorV3" 
                   class="peso-display-v2-input" 
                   placeholder="0,0"
                   inputmode="decimal"
                   disabled>
            <span class="peso-display-v2-unit">kg</span>
          </div>
          <div class="peso-display-v2-buttons">
            <button class="btn-gravar" id="pesoGravarBtnV3" onclick="gravarPesagemV3()" disabled>
              <i class="fas fa-save"></i> Gravar
            </button>
            <button class="btn-limpar" onclick="limparPesoV3()">
              <i class="fas fa-eraser"></i> Limpar
            </button>
          </div>
          <button class="btn-finalizar" id="btnFinalizarGravarV3" onclick="finalizarEGravarV3()" disabled>
            <i class="fas fa-check-double"></i> Finalizar e Gravar
          </button>
          <div class="peso-display-v2-info">
            <div class="peso-info-item">
              <span class="peso-info-label">Peso Registrado:</span>
              <span class="peso-info-value" id="pesoRegistradoV3">‚Äî</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Data √∫ltima pesagem:</span>
              <span class="peso-info-value" id="pesoUltimoDataV3">‚Äî</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Dias desde a √∫ltima:</span>
              <span class="peso-info-value" id="pesoDiasV3">‚Äî</span>
            </div>
            <div class="peso-info-item">
              <span class="peso-info-label">Ganho total:</span>
              <span class="peso-info-value" id="pesoGanhoTotalV3">‚Äî</span>
            </div>
            <div class="peso-info-item" style="margin-bottom: 0;">
              <span class="peso-info-label">Ganho di√°rio m√©dio:</span>
              <span class="peso-info-value" id="pesoGanhoDiaV3">‚Äî</span>
            </div>
          </div>
          
          <!-- Gr√°fico de Barras Horizontais - Efici√™ncia de Ganho de Peso -->
          <div class="gauge-container" style="margin-top: 4px; padding-top: 12px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
            <div class="gauge-header" style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: rgba(255, 255, 255, 0.9); font-size: 1rem; font-weight: 600; margin: 0;">
                <i class="fas fa-chart-bar" style="margin-right: 8px;"></i>
                Efici√™ncia de Ganho de Peso
              </h3>
        </div>
            <div class="gauge-wrapper" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
              <!-- Gr√°fico de Barras Horizontais -->
              <div class="bar-chart-container" id="gaugeChartV3" style="
                position: relative;
                width: 100%;
                max-width: 500px;
                height: 180px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
              ">
                <!-- Barra de progresso horizontal -->
                <div style="position: relative; width: 100%; height: 50px; margin: 40px 0;">
                  <!-- Fundo da barra -->
                  <div style="
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.1);
                    border-radius: 25px;
                    overflow: hidden;
                    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
                  ">
                    <!-- Se√ß√£o Ruim (vermelho) -->
                    <div style="
                      position: absolute;
                      left: 0;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #FF6B6B 0%, #FF5722 100%);
                      border-radius: 25px 0 0 25px;
                    "></div>
                    
                    <!-- Se√ß√£o Regular (amarelo) -->
                    <div style="
                      position: absolute;
                      left: 25%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #FFD93D 0%, #FFC107 100%);
                    "></div>
                    
                    <!-- Se√ß√£o Bom (azul) -->
                    <div style="
                      position: absolute;
                      left: 50%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #4DABF7 0%, #2196F3 100%);
                    "></div>
                    
                    <!-- Se√ß√£o √ìtimo (verde) -->
                    <div style="
                      position: absolute;
                      left: 75%;
                      width: 25%;
                      height: 100%;
                      background: linear-gradient(90deg, #69DB7C 0%, #4CAF50 100%);
                      border-radius: 0 25px 25px 0;
                    "></div>
                  </div>
                  
                  <!-- Indicador (marcador) -->
                  <div id="gaugeNeedleV3" style="
                    position: absolute;
                    top: -10px;
                    left: 0%;
                    width: 4px;
                    height: 70px;
                    background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
                    border-radius: 2px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(255, 255, 255, 0.3);
                    transform: translateX(-50%);
                    transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
                    z-index: 10;
                  ">
                    <!-- Seta no topo -->
                    <div style="
                      position: absolute;
                      top: -8px;
                      left: 50%;
                      transform: translateX(-50%);
                      width: 0;
                      height: 0;
                      border-left: 8px solid transparent;
                      border-right: 8px solid transparent;
                      border-top: 12px solid #1a1a1a;
                      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
                    "></div>
                  </div>
                  
                  <!-- Labels nas se√ß√µes -->
                  <div style="position: absolute; top: 60px; left: 0; width: 100%; display: flex; justify-content: space-between;">
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 13px; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Ruim</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 13px; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Regular</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 13px; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">Bom</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 13px; font-weight: 700; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">√ìtimo</span>
                  </div>
                </div>
                
                <!-- Valor exibido -->
                <div class="gauge-value" id="gaugeValueV3" style="
                  text-align: center;
                  margin-top: 20px;
                  background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
                  color: #FFFFFF;
                  padding: 14px 28px;
                  border-radius: 8px;
                  font-size: 1.5rem;
                  font-weight: 900;
                  min-width: 180px;
                  margin-left: auto;
                  margin-right: auto;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
                  border: 2px solid rgba(255, 255, 255, 0.2);
                  letter-spacing: 1px;
                  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 255, 255, 0.3);
                ">‚Äî</div>
              </div>
              
              <!-- Legenda -->
              <div class="gauge-legenda" style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                width: 100%;
                max-width: 400px;
              ">
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #FF6B6B 0%, #FF5722 100%);"></div>
                  <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">Ruim: &lt; 0.4 kg/dia</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #FFD93D 0%, #FFC107 100%);"></div>
                  <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">Regular: 0.4 - 0.7</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #4DABF7 0%, #2196F3 100%);"></div>
                  <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">Bom: 0.7 - 1.0</span>
                </div>
                <div class="legenda-item" style="display: flex; align-items: center; gap: 8px;">
                  <div class="legenda-cor" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(90deg, #69DB7C 0%, #4CAF50 100%);"></div>
                  <span style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">√ìtimo: &gt; 1.0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de Estat√≠sticas -->
    <div class="stats-table-v3">
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th style="text-align: center; width: 120px;">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; letter-spacing: 0.5px;">Total de Animais</td>
            <td class="stat-cell-value purple" id="statTotalAnimais" style="font-weight: 900; font-size: 2.25rem; letter-spacing: 1px;">0</td>
          </tr>
          <tr style="border-top: 3px solid rgba(0, 0, 0, 0.15);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-tasks" style="margin-right: 10px;"></i> Trabalhados
            </td>
            <td class="stat-cell-value" id="statTrabalhados" style="font-weight: 900; font-size: 2.25rem; letter-spacing: 1px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-mars" style="margin-right: 10px; color: #2196F3;"></i> Machos
            </td>
            <td class="stat-cell-value" id="statMachos" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-venus" style="margin-right: 10px; color: #E91E63;"></i> F√™meas
            </td>
            <td class="stat-cell-value" id="statFemeas" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-tags" style="margin-right: 10px;"></i> Por Categoria
            </td>
            <td class="stat-cell-value" id="statCategorias" style="font-weight: 800; font-size: 1.5rem; text-align: left; padding-left: 24px; letter-spacing: 0.3px;">‚Äî</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-weight" style="margin-right: 10px;"></i> M√©dia de Peso
            </td>
            <td class="stat-cell-value" id="statMediaPeso" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">‚Äî</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-balance-scale" style="margin-right: 10px;"></i> Total de Pesagens
            </td>
            <td class="stat-cell-value" id="statTotalPesagens" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-chart-line" style="margin-right: 10px;"></i> Ganho M√©dio Di√°rio
            </td>
            <td class="stat-cell-value" id="statGanhoMedioDia" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">‚Äî</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-arrow-up" style="margin-right: 10px; color: #4CAF50;"></i> Com Ganho Positivo
            </td>
            <td class="stat-cell-value" id="statGanhoPositivo" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px; color: #4CAF50;">0</td>
          </tr>
          <tr>
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.1875rem; letter-spacing: 0.3px;">
              <i class="fas fa-arrow-down" style="margin-right: 10px; color: #F44336;"></i> Com Ganho Negativo
            </td>
            <td class="stat-cell-value" id="statGanhoNegativo" style="font-weight: 900; font-size: 1.75rem; letter-spacing: 0.5px; color: #F44336;">0</td>
          </tr>
          <tr style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.375rem; color: rgba(255, 255, 255, 0.95); letter-spacing: 0.5px;">
              <i class="fas fa-clipboard-list" style="margin-right: 10px;"></i> Total de Manejos
            </td>
            <td class="stat-cell-value" id="statTotalManejos" style="font-weight: 900; font-size: 2rem; letter-spacing: 0.5px;">0</td>
          </tr>
          <tr id="statDiagnosticoRow" style="display: none; border-top: 3px solid rgba(0, 0, 0, 0.15);">
            <td class="stat-cell-label" style="font-weight: 900; font-size: 1.25rem; color: rgba(255, 255, 255, 0.95);">
              <i class="fas fa-stethoscope" style="margin-right: 10px;"></i> Diagn√≥stico Reprodutivo
            </td>
            <td class="stat-cell-value" id="statDiagnostico" style="font-weight: 900; font-size: 1.875rem;">‚Äî</td>
          </tr>
          <tr id="statPrenhasRow" style="display: none;">
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.125rem;">
              <i class="fas fa-baby" style="margin-right: 10px; color: #4CAF50;"></i> Prenhas
            </td>
            <td class="stat-cell-value" id="statPrenhas" style="font-weight: 900; font-size: 1.625rem;">0</td>
          </tr>
          <tr id="statVaziasRow" style="display: none;">
            <td class="stat-cell-label" style="padding-left: 40px; font-weight: 800; font-size: 1.125rem;">
              <i class="fas fa-circle" style="margin-right: 10px; color: #FF9800;"></i> Vazias
            </td>
            <td class="stat-cell-value" id="statVazias" style="font-weight: 900; font-size: 1.625rem;">0</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Card Manejos Selecionados -->
    <div class="card-curral manejos-selecionados" style="grid-column: 1 / -1;">
      <div class="card-curral-header">
        <h2><i class="fas fa-list"></i> Manejos Selecionados</h2>
        <button onclick="limparTodosManejosV3()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.125rem;" title="Limpar todos os manejos">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="card-curral-body">
        <div id="emptyStateManejosV3" class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <div class="empty-state-text">Nenhum manejo selecionado</div>
          <div class="empty-state-hint">Selecione os manejos abaixo para aplicar ao animal</div>
        </div>
        <div id="listaManejosV3" class="manejos-lista" style="display: none;"></div>
        <div class="manejos-acoes">
          <button class="btn-manejo-tipo pesagem" onclick="adicionarManejoV3('PESAGEM', 'Pesagem', 'Registrar peso do animal')">
            Pesagem
          </button>
          <button class="btn-manejo-tipo vacinacao" onclick="adicionarManejoV3('VACINACAO', 'Vacina√ß√£o', 'Aplicar vacina no animal')">
            Vacina√ß√£o
          </button>
          <button class="btn-manejo-tipo tratamento" onclick="adicionarManejoV3('TRATAMENTO', 'Tratamento', 'Tratamento sanit√°rio')">
            Tratamento
          </button>
          <button class="btn-manejo-tipo reproducao" onclick="adicionarManejoV3('REPRODUCAO', 'Reprodu√ß√£o', 'Protocolo reprodutivo/IATF')">
            Reprodu√ß√£o
          </button>
          <button class="btn-manejo-tipo diagnostico" onclick="adicionarManejoV3('DIAGNOSTICO', 'Diagn√≥stico', 'Diagn√≥stico de prenhez')">
            Diagn√≥stico
          </button>
          <button class="btn-manejo-tipo movimentacao" onclick="adicionarManejoV3('MOVIMENTACAO', 'Movimenta√ß√£o', 'Registrar movimenta√ß√£o do animal')">
            Movimenta√ß√£o
          </button>
        </div>
      </div>
    </div>

    <!-- Tabela Animais Registrados -->
    <div class="card-curral animais-registrados">
      <div class="card-curral-header">
        <h2><i class="fas fa-table"></i> Animais Registrados</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="btnExpandirAnimaisV3" onclick="toggleExpandirAnimaisV3()" style="display: none; align-items: center; gap: 6px; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); color: var(--primary); cursor: pointer; font-size: 0.875rem; padding: 6px 12px; border-radius: 4px; font-weight: 600;">
            <i class="fas fa-chevron-down" id="iconExpandirAnimaisV3"></i> <span id="textoExpandirAnimaisV3">Ver todos</span>
          </button>
        <button style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.125rem;">
          <i class="fas fa-trash"></i>
        </button>
        </div>
      </div>
      <div class="card-curral-body">
        <div class="table-wrapper">
          <table class="table-animais">
            <thead>
              <tr>
                <th>Brinco/Botton RFID - CHIP</th>
                <th>SISBOV</th>
                <th>N√∫mero de Manejo</th>
                <th>Ra√ßa/Sexo</th>
                <th>Nascimento</th>
                <th>Categoria</th>
                <th>Pasto/Lote</th>
                <th>Status BND Sisbov</th>
              </tr>
            </thead>
            <tbody id="tabelaAnimaisV3">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                  <div class="empty-state">
                    <div class="empty-state-icon">üêÑ</div>
                    <div class="empty-state-text">Nenhum animal registrado ainda</div>
                    <div class="empty-state-hint">Os animais processados aparecer√£o aqui</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL DE DUPLICIDADE ========== -->
<div class="modal-v3-overlay" id="modalDuplicidade">
  <div class="modal-v3" style="max-width: 700px;">
    <div class="modal-v3-header">
      <h2 class="modal-v3-title">‚ö†Ô∏è M√∫ltiplos Animais Encontrados</h2>
      <button class="modal-v3-close" onclick="fecharModal('modalDuplicidade')">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div style="background: #fff3e0; padding: 16px; border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin-bottom: 20px;">
        <div style="font-size: 0.875rem; color: #e65100; font-weight: 600;">
          <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Foram encontrados m√∫ltiplos animais com o mesmo n√∫mero de manejo ou c√≥digo RFID. Selecione o animal correto pelo <strong>SISBOV completo</strong>:
        </div>
      </div>
      
      <div id="listaDuplicidadeAnimais" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: var(--radius);">
        <!-- Lista ser√° preenchida dinamicamente -->
      </div>
      
      <div style="background: #e3f2fd; padding: 12px; border-radius: var(--radius-lg); margin-top: 16px; font-size: 0.875rem; color: #1565c0;">
        <strong>üí° Importante:</strong> O sistema sempre busca pelo SISBOV (ID principal do animal). O n√∫mero de manejo e o c√≥digo RFID s√£o identifica√ß√µes auxiliares.
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalDuplicidade')">Cancelar</button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE CADASTRO DE ESTOQUE ========== -->
<div class="modal-v3-overlay" id="modalCadastroEstoque">
  <div class="modal-v3">
    <div class="modal-v3-header">
      <h2 class="modal-v3-title">‚ûï Cadastrar Animal do Estoque</h2>
      <button class="modal-v3-close" onclick="fecharModal('modalCadastroEstoque')">&times;</button>
    </div>
    <div class="modal-v3-body">
      <div class="cadastro-header-info">
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">BRINCO NO ESTOQUE</div>
          <div id="cadastroBrincoV3" class="cadastro-header-value">‚Äî</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">N√∫mero do brinco f√≠sico</small>
        </div>
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">SISBOV</div>
          <div id="cadastroSisbovV3" class="cadastro-header-value">‚Äî</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">C√≥digo completo (15 d√≠gitos)</small>
        </div>
        <div class="cadastro-header-item">
          <div class="cadastro-header-label">N√öMERO DE MANEJO</div>
          <div id="cadastroNumeroManejoV3" class="cadastro-header-value">‚Äî</div>
          <small style="display: block; margin-top: 4px; font-size: 0.65rem; color: var(--primary-dark); opacity: 0.8;">6 d√≠gitos (extra√≠do do SISBOV)</small>
        </div>
      </div>
      
      <div class="cadastro-form-grid">
        <!-- C√≥digo Eletr√¥nico (RFID) (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">
            <i class="fas fa-microchip" style="margin-right: 6px; color: var(--primary); font-size: 0.9rem;"></i>
            C√≥digo Eletr√¥nico (Brinco/Botton RFID - CHIP)
          </label>
          <input type="text" id="cadastroRfidV3" class="form-input-v3" placeholder="Ex.: 900123456789012" autofocus style="font-size: 1rem; font-weight: 600; padding: 12px 16px;">
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; line-height: 1.3;">
            <strong>Opcional:</strong> C√≥digo eletr√¥nico do chip RFID do brinco/botton.
            <span style="display: block; margin-top: 2px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.85;">
              SISBOV (15 d√≠gitos) | Manejo (6 d√≠gitos) | RFID (ex: 900123456789012)
            </span>
          </small>
        </div>
        
        <!-- Ra√ßa e Sexo (juntos em uma linha) -->
        <div class="form-group-v3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start;">
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0;">Ra√ßa *</label>
            <select id="cadastroRacaV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
              <option value="">Selecione</option>
              <option value="NE">NE - Nelore</option>
              <option value="XX">XX - Composto</option>
              <option value="AN">AN - Angus</option>
              <option value="BR">BR - Brahman</option>
              <option value="CA">CA - Canchim</option>
              <option value="GU">GU - Guzer√°</option>
              <option value="GI">GI - Gir</option>
              <option value="GN">GN - Girolando</option>
              <option value="HO">HO - Holand√™s</option>
              <option value="IN">IN - Indubrasil</option>
              <option value="MA">MA - Marchigiana</option>
              <option value="MO">MO - Montana</option>
              <option value="PO">PO - Polled Hereford</option>
              <option value="PR">PR - Pardo Su√≠√ßo</option>
              <option value="RA">RA - Ra√ßa Santa Gertrudis</option>
              <option value="SI">SI - Simental</option>
              <option value="TA">TA - Tabapu√£</option>
              <option value="TR">TR - Tricross</option>
              <option value="ZE">ZE - Zebu</option>
              <option value="OT">OT - Outra</option>
            </select>
        </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0;">Sexo *</label>
            <select id="cadastroSexoV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
            <option value="">Selecione</option>
            <option value="F">F√™mea</option>
            <option value="M">Macho</option>
          </select>
        </div>
        </div>
        
        <!-- Idade e Data Nascimento (juntos em uma linha) -->
        <div class="form-group-v3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; grid-column: 1 / -1;">
          <div style="display: flex; flex-direction: column; gap: 6px; min-width: 0;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0; white-space: nowrap;">Idade (meses)</label>
            <input type="number" id="cadastroIdadeV3" class="form-input-v3" placeholder="Ex.: 8" min="0" step="1" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; min-width: 0;">
            <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0; white-space: nowrap;">Data Nascimento</label>
            <input type="date" id="cadastroDataNascV3" class="form-input-v3" style="font-size: 1rem; font-weight: 600; width: 100%; padding: 12px 16px;">
          </div>
        </div>
        
        <!-- M√£e (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">
            <i class="fas fa-female" style="margin-right: 6px; color: var(--primary); font-size: 0.9rem;"></i>
            M√£e (SISBOV, Manejo ou RFID)
          </label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
            <input type="text" id="cadastroMaeV3" class="form-input-v3" placeholder="Digite o c√≥digo da m√£e e pressione Enter" style="font-size: 1rem; font-weight: 600; padding: 12px 16px; flex: 1;" onkeypress="if(event.key === 'Enter') buscarMaeV3()">
            <button class="btn-buscar" onclick="buscarMaeV3()" style="padding: 12px 20px; white-space: nowrap;">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; line-height: 1.3;">
            <strong>Opcional:</strong> Informe o c√≥digo da m√£e para verificar se h√° registro de IATF e informa√ß√µes do touro.
          </small>
          <!-- Informa√ß√µes da M√£e e IATF -->
          <div id="infoMaeIATFV3" style="display: none; margin-top: 12px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: var(--radius); border-left: 4px solid #4caf50;">
            <div style="font-size: 0.875rem; font-weight: 700; color: #2e7d32; margin-bottom: 8px;">
              <i class="fas fa-check-circle" style="margin-right: 6px;"></i>Informa√ß√µes da M√£e e IATF
            </div>
            <div id="detalhesMaeIATFV3" style="font-size: 0.8rem; color: #1b5e20; line-height: 1.5;">
              <!-- Informa√ß√µes ser√£o preenchidas aqui -->
            </div>
          </div>
        </div>
        
        <!-- Tipo de Registro (linha completa) -->
        <div class="form-group-v3 cadastro-data-full">
          <label class="form-label-v3" style="font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">Tipo de Registro *</label>
          <select id="cadastroTipoRegistroV3" class="form-input-v3" required style="font-size: 1rem; font-weight: 600; padding: 12px 16px;">
            <option value="">Selecione</option>
            <option value="NASCIMENTO">Nascimento</option>
            <option value="DESMAMA">Desmama</option>
          </select>
          <small style="display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;">
            Selecione se o animal est√° sendo cadastrado por nascimento ou desmama
          </small>
        </div>
      </div>
      
      <div style="background: #fff3e0; padding: 12px 14px; border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin-top: 12px;">
        <div style="font-size: 0.8rem; color: #e65100; font-weight: 600; line-height: 1.4;">
          <strong>üí° Dica:</strong> Informe a idade em meses OU a data de nascimento. O sistema calcula automaticamente o campo que faltar.
        </div>
      </div>
    </div>
    <div class="modal-v3-footer">
      <button class="btn-v3 btn-v3-secondary" onclick="fecharModal('modalCadastroEstoque')">Cancelar</button>
      <button class="btn-v3 btn-v3-primary" id="btnConfirmarCadastroV3" disabled>Confirmar Cadastro</button>
    </div>
  </div>
</div>

<script>
// ========== CURRAL INTELIGENTE 3.0 - SCRIPT COMPLETO ==========

// Definir fun√ß√£o do simulador globalmente ANTES do IIFE para garantir disponibilidade
window.iniciarSimulador = function() {
  console.log('üîµ window.iniciarSimulador chamado');
  console.log('üîµ window.executarSimulador dispon√≠vel?', typeof window.executarSimulador);
  
  if (typeof window.executarSimulador === 'function') {
    const mensagem = 'Deseja iniciar o simulador de pesagem e identifica√ß√£o?\n\n' +
      'O simulador ir√°:\n' +
      '‚Ä¢ Aguardar 20 segundos antes de come√ßar\n' +
      '‚Ä¢ FASE 1: Cadastrar todos os brincos dispon√≠veis do estoque\n' +
      '‚Ä¢ FASE 2: Processar todos os animais cadastrados com pesagem e manejo\n' +
      '‚Ä¢ Criar uma sess√£o de pesagem\n' +
      '‚Ä¢ Gerar um log detalhado em TXT de todas as opera√ß√µes\n' +
      '‚Ä¢ Relat√≥rio completo com erros e status OK';
    
    if (confirm(mensagem)) {
      console.log('üîµ Confirmado! Chamando window.executarSimulador()...');
      window.executarSimulador();
    } else {
      console.log('üîµ Usu√°rio cancelou');
    }
  } else {
    console.error('‚ùå window.executarSimulador n√£o est√° dispon√≠vel');
    alert('Simulador ainda n√£o carregado. Aguarde alguns segundos e tente novamente.\n\n' +
          'Se o problema persistir, recarregue a p√°gina (F5).');
  }
};

(function() {
  'use strict';

  const csrfToken = '{{ csrf_token }}';
  const propriedadeId = {{ propriedade.id }};
  const identificarUrl = '{{ identificar_url }}';
  const registrarUrl = '{{ registrar_url }}';
  const statsUrl = '{{ stats_url }}';
  const criarSessaoUrl = '{{ criar_sessao_url|default:"" }}';
  const encerrarSessaoUrl = '{{ encerrar_sessao_url|default:"" }}';
  const statsSessaoUrl = '{{ stats_sessao_url|default:"" }}';
  const dadosSimulacaoUrl = `/propriedade/${propriedadeId}/curral/api/dados-simulacao/`;
  
  // Verificar se as URLs est√£o definidas
  if (!criarSessaoUrl || criarSessaoUrl === '') {
    console.error('‚ö†Ô∏è criarSessaoUrl n√£o est√° definida no template');
  }
  if (!encerrarSessaoUrl || encerrarSessaoUrl === '') {
    console.error('‚ö†Ô∏è encerrarSessaoUrl n√£o est√° definida no template');
  }
  if (!statsSessaoUrl || statsSessaoUrl === '') {
    console.error('‚ö†Ô∏è statsSessaoUrl n√£o est√° definida no template');
  }
  
  // Sistema de diagn√≥stico e tratamento de erros global
  window.diagnosticoSistema = {
    erros: [],
    avisos: [],
    inicializado: false,
    adicionarErro: function(erro, contexto) {
      const erroObj = {
        timestamp: new Date().toISOString(),
        erro: erro,
        contexto: contexto,
        stack: erro.stack || 'N/A'
      };
      this.erros.push(erroObj);
      console.error('‚ùå ERRO CAPTURADO:', erroObj);
      
      // Se houver muitos erros, mostrar alerta
      if (this.erros.length > 10) {
        console.error('‚ö†Ô∏è Muitos erros detectados! Verifique o console.');
      }
    },
    adicionarAviso: function(aviso, contexto) {
      const avisoObj = {
        timestamp: new Date().toISOString(),
        aviso: aviso,
        contexto: contexto
      };
      this.avisos.push(avisoObj);
      console.warn('‚ö†Ô∏è AVISO:', avisoObj);
    },
    verificarSistema: function() {
      console.log('üîç DIAGN√ìSTICO DO SISTEMA:');
      console.log('  ‚úÖ Inicializado:', this.inicializado);
      console.log('  ‚ùå Erros:', this.erros.length);
      console.log('  ‚ö†Ô∏è Avisos:', this.avisos.length);
      console.log('  üîó URLs:', {
        identificarUrl: identificarUrl,
        registrarUrl: registrarUrl,
        statsUrl: statsUrl,
        criarSessaoUrl: criarSessaoUrl,
        encerrarSessaoUrl: encerrarSessaoUrl,
        statsSessaoUrl: statsSessaoUrl,
        dadosSimulacaoUrl: dadosSimulacaoUrl
      });
      console.log('  üîß Fun√ß√µes dispon√≠veis:', {
        iniciarSimulador: typeof window.iniciarSimulador,
        executarSimulador: typeof window.executarSimulador,
        buscarBrincoV3: typeof window.buscarBrincoV3
      });
      return {
        inicializado: this.inicializado,
        erros: this.erros,
        avisos: this.avisos
      };
    }
  };
  
  // Capturar erros n√£o tratados
  window.addEventListener('error', function(event) {
    window.diagnosticoSistema.adicionarErro(event.error || event.message, {
      arquivo: event.filename,
      linha: event.lineno,
      coluna: event.colno
    });
  });
  
  // Capturar promessas rejeitadas n√£o tratadas
  window.addEventListener('unhandledrejection', function(event) {
    window.diagnosticoSistema.adicionarErro(event.reason, {
      tipo: 'Promise Rejection',
      promessa: event.promise
    });
  });
  
  let animalAtualV3 = null;
  let brincoAtualV3 = null;
  let animaisRegistrados = [];
  let manejosSelecionadosV3 = [];
  let ultimoCadastroEstoqueV3 = null; // Armazenar dados do √∫ltimo cadastro

  // Aplicar cores do SISBOV e N√∫mero de Manejo quando a p√°gina carregar
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar bot√£o do simulador
    const btnSimulador = document.getElementById('btnSimulador');
    if (btnSimulador) {
      console.log('‚úÖ Bot√£o do simulador encontrado no DOMContentLoaded');
      console.log('üîç window.iniciarSimulador dispon√≠vel?', typeof window.iniciarSimulador);
      console.log('üîç window.executarSimulador dispon√≠vel?', typeof window.executarSimulador);
      
      // N√ÉO remover onclick inline - manter ambos para garantir funcionamento
      // Adicionar event listener adicional (n√£o substitui o onclick)
      btnSimulador.addEventListener('click', function(e) {
        // N√£o prevenir default para n√£o interferir com onclick inline
        console.log('üñ±Ô∏è Bot√£o clicado via event listener!');
        console.log('üîç window.iniciarSimulador dispon√≠vel?', typeof window.iniciarSimulador);
        console.log('üîç window.executarSimulador dispon√≠vel?', typeof window.executarSimulador);
        
        if (typeof window.iniciarSimulador === 'function') {
          console.log('‚úÖ Chamando window.iniciarSimulador() via event listener');
          window.iniciarSimulador();
        } else {
          console.error('‚ùå window.iniciarSimulador n√£o est√° dispon√≠vel no event listener');
          // N√£o mostrar alert aqui para n√£o duplicar com onclick inline
        }
      });
      
      console.log('‚úÖ Event listener adicionado ao bot√£o do simulador (al√©m do onclick inline)');
    } else {
      console.error('‚ùå Bot√£o btnSimulador n√£o encontrado no DOMContentLoaded!');
    }
    
    const sisbovEl = document.getElementById('scannerSisbovV3');
    const numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
    
    if (sisbovEl) {
      sisbovEl.className = 'resumo-value resumo-sisbov';
      sisbovEl.style.color = '#2196F3';
      sisbovEl.style.fontSize = '1.25rem';
      sisbovEl.style.fontWeight = '700';
    }
    
    if (numeroManejoEl) {
      numeroManejoEl.className = 'resumo-value resumo-numero-manejo';
      numeroManejoEl.style.color = '#4CAF50';
      numeroManejoEl.style.fontSize = '1.75rem';
      numeroManejoEl.style.fontWeight = '700';
    }
  });

  // ========== FUN√á√ïES DE UTILIDADE ==========
  function mostrarToast(mensagem, tipo = 'info') {
    const container = document.getElementById('toastContainerV3');
    const toast = document.createElement('div');
    toast.className = `toast-v3 toast-v3-${tipo}`;
    
    const icon = {
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è'
    }[tipo] || '‚ÑπÔ∏è';
    
    toast.innerHTML = `<span style="font-size: 1.5rem;">${icon}</span><span>${mensagem}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => container.removeChild(toast), 300);
    }, 4000);
  }

  function mostrarLoading(mostrar) {
    const loading = document.getElementById('loadingV3');
    if (mostrar) {
      loading.classList.add('show');
    } else {
      loading.classList.remove('show');
    }
  }

  // ========== FUN√á√ÉO PARA ATUALIZAR GR√ÅFICO DE BARRAS DE EFICI√äNCIA ==========
  function atualizarGaugeEficiencia(ganhoDiario) {
    const gaugeNeedle = document.getElementById('gaugeNeedleV3');
    const gaugeValue = document.getElementById('gaugeValueV3');
    
    if (!gaugeNeedle || !gaugeValue) {
      return;
    }
    
    // Se n√£o h√° ganho di√°rio, resetar gr√°fico (marcador na posi√ß√£o inicial - esquerda)
    if (!ganhoDiario || isNaN(ganhoDiario) || ganhoDiario === 0) {
      gaugeNeedle.style.left = '0%';
      gaugeValue.textContent = '‚Äî';
      return;
    }
    
    // Definir faixas de efici√™ncia e posi√ß√µes na barra horizontal
    // A barra vai de 0% (esquerda) a 100% (direita)
    // Ruim: < 0.4 kg/dia (0% a 25%)
    // Regular: 0.4 - 0.7 kg/dia (25% a 50%)
    // Bom: 0.7 - 1.0 kg/dia (50% a 75%)
    // √ìtimo: > 1.0 kg/dia (75% a 100%)
    
    let posicaoPercentual = 0;
    let textoValor = `${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
    
    if (ganhoDiario >= 1.0) {
      // √ìtimo: 75% a 100%
      // 1.0 = 75%, 1.5+ = 100%
      const progresso = Math.min(1, (ganhoDiario - 1.0) / 0.5);
      posicaoPercentual = 75 + (progresso * 25);
    } else if (ganhoDiario >= 0.7) {
      // Bom: 50% a 75%
      // 0.7 = 50%, 1.0 = 75%
      const progresso = (ganhoDiario - 0.7) / 0.3;
      posicaoPercentual = 50 + (progresso * 25);
    } else if (ganhoDiario >= 0.4) {
      // Regular: 25% a 50%
      // 0.4 = 25%, 0.7 = 50%
      const progresso = (ganhoDiario - 0.4) / 0.3;
      posicaoPercentual = 25 + (progresso * 25);
    } else {
      // Ruim: 0% a 25%
      // 0 = 0%, 0.4 = 25%
      const progresso = ganhoDiario / 0.4;
      posicaoPercentual = progresso * 25;
    }
    
    // Limitar posi√ß√£o entre 0% e 100%
    posicaoPercentual = Math.max(0, Math.min(100, posicaoPercentual));
    
    // Atualizar posi√ß√£o do marcador
    gaugeNeedle.style.left = `${posicaoPercentual}%`;
    
    // Atualizar valor exibido
    gaugeValue.textContent = textoValor;
    
    console.log('üìä Gr√°fico de barras atualizado:', {
      ganhoDiario: ganhoDiario,
      posicaoPercentual: posicaoPercentual,
      textoValor: textoValor
    });
  }
  
  // ========== FUN√á√ÉO PARA ATUALIZAR CARD DE PESAGEM EM TEMPO REAL ==========
  function atualizarCardPesagemEmTempoReal() {
    const pesoInput = document.getElementById('pesoValorV3');
    if (!pesoInput || !animalAtualV3) {
      // Limpar campos se n√£o houver animal
      limparCamposPesagem();
      atualizarGaugeEficiencia(0);
      return;
    }
    
    const pesoDigitado = pesoInput.value.replace(',', '.').trim();
    const pesoNumero = parseFloat(pesoDigitado);
    
    if (!pesoNumero || isNaN(pesoNumero) || pesoNumero <= 0) {
      // Limpar campos se peso inv√°lido
      limparCamposPesagem();
      atualizarGaugeEficiencia(0);
      return;
    }
    
    // Atualizar "Peso Registrado"
    const pesoRegistrado = document.getElementById('pesoRegistradoV3');
    if (pesoRegistrado) {
      pesoRegistrado.textContent = `${pesoNumero.toFixed(1).replace('.', ',')} kg`;
    }
    
    // Atualizar "Data √∫ltima pesagem" com a data atual
    const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
    if (pesoUltimoData) {
      const hoje = new Date();
      pesoUltimoData.textContent = hoje.toLocaleDateString('pt-BR');
    }
    
    // Calcular ganho total baseado no peso digitado e peso anterior
    const pesoAnterior = parseFloat(animalAtualV3.peso_atual || animalAtualV3.peso_anterior || 0);
    
    if (!pesoAnterior || pesoAnterior <= 0) {
      // Se n√£o h√° peso anterior, limpar campos de ganho
      const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
      const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
      if (pesoGanhoTotal) {
        pesoGanhoTotal.textContent = '‚Äî';
        pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
      }
      if (pesoGanhoDia) {
        pesoGanhoDia.textContent = '‚Äî';
      }
      atualizarGaugeEficiencia(0);
      return;
    }
    
    const ganhoTotal = pesoNumero - pesoAnterior;
    
    // Atualizar "Ganho total" com cores din√¢micas
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
    if (pesoGanhoTotal) {
      pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
      pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
      if (ganhoTotal > 0) {
        pesoGanhoTotal.classList.add('ganho-positivo');
      } else if (ganhoTotal < 0) {
        pesoGanhoTotal.classList.add('ganho-negativo');
      }
    }
    
    // Calcular dias desde √∫ltima pesagem
    let dias = 30; // Padr√£o: 30 dias se n√£o houver data
    if (animalAtualV3.data_peso_atual || animalAtualV3.data_peso_anterior) {
      try {
        const dataAnterior = animalAtualV3.data_peso_anterior 
          ? new Date(animalAtualV3.data_peso_anterior) 
          : (animalAtualV3.data_peso_atual ? new Date(animalAtualV3.data_peso_atual) : new Date());
        const dataAtual = new Date();
        const diffTime = Math.abs(dataAtual - dataAnterior);
        dias = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
      } catch (e) {
        console.warn('Erro ao calcular dias:', e);
      }
    }
    
    // Atualizar "Dias desde a √∫ltima"
    const pesoDias = document.getElementById('pesoDiasV3');
    if (pesoDias) {
      pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
    }
    
    // Calcular e atualizar "Ganho di√°rio m√©dio"
    const ganhoDiario = ganhoTotal / dias;
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
    if (pesoGanhoDia) {
      pesoGanhoDia.textContent = `${ganhoDiario > 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
    }
    
    // Atualizar gauge
    atualizarGaugeEficiencia(ganhoDiario);
  }
  
  // Fun√ß√£o auxiliar para limpar campos de pesagem
  function limparCamposPesagem() {
    const pesoRegistrado = document.getElementById('pesoRegistradoV3');
    const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
    const pesoDias = document.getElementById('pesoDiasV3');
    
    if (pesoRegistrado) pesoRegistrado.textContent = '‚Äî';
    if (pesoUltimoData) pesoUltimoData.textContent = '‚Äî';
    if (pesoGanhoTotal) {
      pesoGanhoTotal.textContent = '‚Äî';
      pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
    }
    if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
    if (pesoDias) pesoDias.textContent = '‚Äî';
  }
  
  // ========== FUN√á√ÉO PARA CALCULAR E ATUALIZAR GAUGE EM TEMPO REAL ==========
  function calcularEficienciaEmTempoReal() {
    atualizarCardPesagemEmTempoReal();
  }
  
  // Tornar fun√ß√µes globais
  window.atualizarTermometroEficiencia = atualizarGaugeEficiencia;
  window.atualizarGaugeEficiencia = atualizarGaugeEficiencia;
  window.calcularEficienciaEmTempoReal = calcularEficienciaEmTempoReal;

  function fecharModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
  }

  // ========== BUSCAR BRINCO ==========
  window.buscarBrincoV3 = async function(brincoParam) {
    // Se receber brinco como par√¢metro, usar ele; sen√£o, pegar do input
    let brinco = brincoParam;
    if (!brinco) {
      brinco = document.getElementById('brincoInputV3')?.value.trim() || '';
    }
    
    if (!brinco) {
      mostrarToast('Digite o n√∫mero de manejo, SISBOV ou RFID', 'warning');
      return;
    }
    
    // Limpar o c√≥digo: remover espa√ßos, tra√ßos e outros caracteres especiais
    // Manter apenas n√∫meros e letras
    brinco = String(brinco).trim().replace(/[\s\-\.]/g, '');
    
    // Validar se o c√≥digo n√£o est√° vazio ap√≥s limpeza
    if (!brinco || brinco.length === 0) {
      mostrarToast('C√≥digo inv√°lido. Digite o n√∫mero de manejo, SISBOV ou RFID', 'warning');
      return;
    }
    
    console.log('üîç Buscando animal com c√≥digo:', brinco, '(tamanho:', brinco.length, 'd√≠gitos)');
    
    // Atualizar o input se foi passado como par√¢metro
    const brincoInput = document.getElementById('brincoInputV3');
    if (brincoInput && brincoParam) {
      brincoInput.value = brinco;
    }

    mostrarLoading(true);
    
    try {
      const response = await fetch(identificarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ codigo: brinco })
      });

      const data = await response.json();
      mostrarLoading(false);
      
      console.log('üì• Resposta da API:', data);
      console.log('üìä Status:', data.status);
      console.log('üìã Dados:', data.dados);
      console.log('üîç C√≥digo buscado:', brinco);
      
      // Se n√£o encontrou, mostrar mensagem mais espec√≠fica
      if (data.status !== 'animal' && data.status !== 'estoque' && data.status !== 'duplicidade') {
        console.warn('‚ö†Ô∏è Animal n√£o encontrado. Status:', data.status);
        console.warn('‚ö†Ô∏è Mensagem:', data.mensagem || data.erro || 'Animal n√£o encontrado');
        
        // Verificar se √© um SISBOV completo (15 d√≠gitos)
        if (brinco.length === 15 && /^\d+$/.test(brinco)) {
          console.log('‚ÑπÔ∏è C√≥digo parece ser um SISBOV completo (15 d√≠gitos)');
          mostrarToast(`SISBOV ${brinco} n√£o encontrado. Verifique se o c√≥digo est√° correto.`, 'error');
        } else if (brinco.length === 6 && /^\d+$/.test(brinco)) {
          console.log('‚ÑπÔ∏è C√≥digo parece ser um n√∫mero de manejo (6 d√≠gitos)');
          mostrarToast(`N√∫mero de manejo ${brinco} n√£o encontrado. Verifique se o c√≥digo est√° correto.`, 'error');
        } else {
          mostrarToast(data.mensagem || data.erro || 'Animal n√£o encontrado. Verifique o c√≥digo digitado.', 'error');
        }
      }

      // Tratar duplicidade (m√∫ltiplos animais encontrados)
      if (data.status === 'duplicidade' && data.animais) {
        abrirModalDuplicidade(data.animais, data.codigo_lido, data.mensagem);
        mostrarToast(data.mensagem || 'M√∫ltiplos animais encontrados. Selecione o correto.', 'warning');
        return;
      }
      
      // A view retorna status: 'animal' com dados em 'dados'
      if (data.status === 'animal' && data.dados) {
        try {
          animalAtualV3 = data.dados;
          brincoAtualV3 = brinco;
          
          console.log('Animal encontrado:', data.dados);
          
          // Atualizar o campo de busca com o n√∫mero de manejo (mais leg√≠vel)
          const brincoInput = document.getElementById('brincoInputV3');
          if (brincoInput && data.dados.numero_manejo) {
            brincoInput.value = data.dados.numero_manejo;
            console.log('üìù Campo de busca atualizado com n√∫mero de manejo:', data.dados.numero_manejo);
          }
          
          // Preencher resumo - tabela sempre vis√≠vel
          const codigoEletronico = document.getElementById('scannerCodigoEletronicoV3');
          const sisbov = document.getElementById('scannerSisbovV3');
          const numeroManejo = document.getElementById('scannerNumeroManejoV3');
          const racaInput = document.getElementById('scannerRacaV3');
          const sexoSelect = document.getElementById('scannerSexoV3');
          const dataNasc = document.getElementById('scannerDataNascV3');
          const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
          const categoria = document.getElementById('scannerCategoriaV3');
          const pastoLote = document.getElementById('scannerPastoLoteV3');
          
          // Preencher c√≥digo eletr√¥nico (Brinco/Botton RFID - CHIP)
          if (codigoEletronico) {
            const codigoEletronicoValor = data.dados.codigo_eletronico || data.dados.numero_brinco || '';
            // Verificar se o valor n√£o √© vazio, null, undefined ou 'None'
            if (codigoEletronicoValor && codigoEletronicoValor !== 'None' && codigoEletronicoValor !== 'null' && String(codigoEletronicoValor).trim() !== '') {
              codigoEletronico.textContent = String(codigoEletronicoValor).trim();
              codigoEletronico.style.fontWeight = '700';
              codigoEletronico.style.fontSize = '1.25rem';
              codigoEletronico.style.color = 'var(--text-primary)';
            } else {
              codigoEletronico.textContent = '‚Äî';
            }
          }
          if (sisbov) {
            sisbov.textContent = data.dados.codigo_sisbov || '‚Äî';
            sisbov.className = 'resumo-value resumo-sisbov';
            // Aplicar estilos inline para garantir que a cor azul seja aplicada
            sisbov.style.color = '#2196F3';
            sisbov.style.fontSize = '1.25rem';
            sisbov.style.fontWeight = '700';
          }
          if (numeroManejo) {
            numeroManejo.textContent = data.dados.numero_manejo || '‚Äî';
            numeroManejo.className = 'resumo-value resumo-numero-manejo';
            // Aplicar estilos inline para garantir que a cor verde seja aplicada
            numeroManejo.style.color = '#4CAF50';
            numeroManejo.style.fontSize = '1.75rem';
            numeroManejo.style.fontWeight = '700';
          }
          
          // Preencher campos edit√°veis
          if (racaInput) racaInput.value = data.dados.raca || '';
          
          // Converter sexo de display (F√™mea/Macho) para c√≥digo (F/M)
          if (sexoSelect && data.dados.sexo) {
            const sexoStr = String(data.dados.sexo).toUpperCase();
            if (sexoStr.includes('F√äMEA') || sexoStr.includes('FEMEA') || sexoStr === 'F') {
              sexoSelect.value = 'F';
            } else if (sexoStr.includes('MACHO') || sexoStr === 'M') {
              sexoSelect.value = 'M';
            } else {
              sexoSelect.value = '';
            }
          }
          
          // Formatar data de nascimento para input type="date" (formato YYYY-MM-DD)
          const idadeSpan = document.getElementById('scannerIdadeV3');
          if (dataNasc && data.dados.data_nascimento) {
            let dataNascObj = null;
            const dataNascStr = String(data.dados.data_nascimento).trim();
            
            // Tentar diferentes formatos de data
            if (dataNascStr.includes('/')) {
              // Formato DD/MM/YYYY
              const partes = dataNascStr.split('/');
              if (partes.length === 3) {
                dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
              }
            } else if (dataNascStr.includes('-')) {
              // Formato YYYY-MM-DD ou DD-MM-YYYY
              const partes = dataNascStr.split('-');
              if (partes.length === 3) {
                if (partes[0].length === 4) {
                  // YYYY-MM-DD
                  dataNascObj = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
                } else {
                  // DD-MM-YYYY
                  dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
                }
              }
            } else {
              // Tentar como Date ISO
              dataNascObj = new Date(data.dados.data_nascimento);
            }
            
            if (dataNascObj && !isNaN(dataNascObj.getTime())) {
              const year = dataNascObj.getFullYear();
              const month = String(dataNascObj.getMonth() + 1).padStart(2, '0');
              const day = String(dataNascObj.getDate()).padStart(2, '0');
              dataNasc.value = `${year}-${month}-${day}`;
              // Calcular e exibir idade
              if (idadeSpan) {
                const idade = calcularIdade(dataNasc.value);
                idadeSpan.textContent = idade ? `Idade: ${idade}` : '‚Äî';
              }
            } else {
              dataNasc.value = '';
              if (idadeSpan) idadeSpan.textContent = '‚Äî';
            }
          } else if (dataNasc) {
            dataNasc.value = '';
            if (idadeSpan) idadeSpan.textContent = '‚Äî';
          }
          
          if (ultimoPeso) {
            ultimoPeso.value = data.dados.peso_atual ? parseFloat(data.dados.peso_atual).toFixed(1) : '';
          }
          
          if (categoria) categoria.value = data.dados.categoria_nome || data.dados.categoria || '';
          if (pastoLote) pastoLote.value = data.dados.pasto_nome || data.dados.lote_nome || '';
          
          // Atualizar campo CONFORME BND (animal j√° cadastrado = verde)
          atualizarConformeBnd(data.dados, false);
          
          // Configurar event listeners para salvar automaticamente quando editar
          configurarCamposEditaveis();
          
          // Tabela sempre vis√≠vel, n√£o precisa mudar display
          
          // Habilitar campo de peso - CR√çTICO: sempre habilitar quando animal √© encontrado
          const pesoInput = document.getElementById('pesoValorV3');
          const pesoBtn = document.getElementById('pesoGravarBtnV3');
          const finalizarBtn = document.getElementById('btnFinalizarGravarV3');
          
          console.log('Habilitando campos de peso...');
          console.log('pesoInput encontrado:', !!pesoInput);
          console.log('pesoBtn encontrado:', !!pesoBtn);
          console.log('finalizarBtn encontrado:', !!finalizarBtn);
          
          if (pesoInput) {
            pesoInput.disabled = false;
            pesoInput.removeAttribute('disabled');
            pesoInput.focus();
            console.log('Campo de peso habilitado');
          } else {
            console.error('Campo pesoValorV3 n√£o encontrado!');
          }
          
          if (pesoBtn) {
            pesoBtn.disabled = false;
            pesoBtn.removeAttribute('disabled');
            console.log('Bot√£o gravar habilitado');
          } else {
            console.error('Bot√£o pesoGravarBtnV3 n√£o encontrado!');
          }
          
          // Habilitar bot√£o finalizar se houver manejos ou peso
          if (finalizarBtn) {
            // Sempre habilitar quando animal √© encontrado (pode adicionar peso ou manejos)
            finalizarBtn.disabled = false;
            finalizarBtn.removeAttribute('disabled');
            console.log('Bot√£o finalizar habilitado');
          } else {
            console.error('Bot√£o btnFinalizarGravarV3 n√£o encontrado!');
          }
          
          // Atualizar resumo de pesagem e term√¥metro se houver dados
          if (data.dados.peso_atual) {
            const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
            const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
            let ganhoDiario = 0;
            let ganhoTotal = 0;
            
            // Tentar obter ganho di√°rio do backend
            if (data.dados.ganho_diario_medio) {
              ganhoDiario = parseFloat(data.dados.ganho_diario_medio);
            } else if (data.dados.peso_anterior && data.dados.data_peso_anterior) {
              // Calcular ganho di√°rio se n√£o vier do backend
              const pesoAtual = parseFloat(data.dados.peso_atual) || 0;
              const pesoAnterior = parseFloat(data.dados.peso_anterior) || 0;
              ganhoTotal = pesoAtual - pesoAnterior;
              
              // Atualizar ganho total com cores din√¢micas
              if (pesoGanhoTotal) {
                pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
                pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
                if (ganhoTotal > 0) {
                  pesoGanhoTotal.classList.add('ganho-positivo');
                } else if (ganhoTotal < 0) {
                  pesoGanhoTotal.classList.add('ganho-negativo');
                }
              }
              
              try {
                const dataAnterior = new Date(data.dados.data_peso_anterior);
                const dataAtual = data.dados.data_peso_atual ? new Date(data.dados.data_peso_atual) : new Date();
                const diffTime = Math.abs(dataAtual - dataAnterior);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                  ganhoDiario = ganhoTotal / diffDays;
                }
              } catch (e) {
                console.warn('Erro ao calcular ganho di√°rio:', e);
              }
            }
            
            if (ganhoDiario !== 0) {
              if (pesoGanhoDia) {
                pesoGanhoDia.textContent = `${ganhoDiario > 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
              }
              // Atualizar term√¥metro
              atualizarTermometroEficiencia(ganhoDiario);
            } else {
              // Resetar term√¥metro se n√£o h√° ganho di√°rio
              atualizarTermometroEficiencia(0);
              // Limpar ganho total se n√£o houver dados
              const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
              if (pesoGanhoTotal) {
                pesoGanhoTotal.textContent = '‚Äî';
                pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
              }
            }
          } else {
            // Limpar campos de ganho se n√£o houver peso atual
            const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
            const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
            if (pesoGanhoTotal) {
              pesoGanhoTotal.textContent = '‚Äî';
              pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
            }
            if (pesoGanhoDia) {
              pesoGanhoDia.textContent = '‚Äî';
            }
            atualizarTermometroEficiencia(0);
            // Resetar term√¥metro se n√£o h√° dados de peso
            atualizarTermometroEficiencia(0);
          }
          
          mostrarToast('Animal identificado com sucesso!', 'success');
        } catch (error) {
          console.error('Erro ao processar animal encontrado:', error);
          mostrarToast('Erro ao processar dados do animal. Verifique o console.', 'error');
        }
      } else if (data.status === 'estoque') {
        // Brinco no estoque - abrir modal de cadastro
        abrirModalCadastroEstoque(brinco, data.dados);
        mostrarToast('Brinco encontrado no estoque. Complete o cadastro.', 'info');
      }
    } catch (error) {
      console.error('Erro ao buscar brinco:', error);
      mostrarLoading(false); // Garantir que o loading seja desativado em caso de erro
      mostrarToast('Erro ao buscar animal. Tente novamente.', 'error');
    }
  };

  // ========== BUSCAR M√ÉE E INFORMA√á√ïES DE IATF ==========
  window.buscarMaeV3 = async function() {
    const codigoMae = document.getElementById('cadastroMaeV3')?.value.trim() || '';
    
    if (!codigoMae) {
      mostrarToast('Digite o c√≥digo da m√£e (SISBOV, Manejo ou RFID)', 'warning');
      return;
    }
    
    // Limpar c√≥digo
    const codigoLimpo = String(codigoMae).trim().replace(/[\s\-\.]/g, '');
    
    if (!codigoLimpo || codigoLimpo.length === 0) {
      mostrarToast('C√≥digo inv√°lido', 'warning');
      return;
    }
    
    const infoDiv = document.getElementById('infoMaeIATFV3');
    const detalhesDiv = document.getElementById('detalhesMaeIATFV3');
    
    // Ocultar informa√ß√µes anteriores
    if (infoDiv) infoDiv.style.display = 'none';
    if (detalhesDiv) detalhesDiv.innerHTML = '';
    
    mostrarLoading(true);
    
    try {
      // 1. Buscar animal m√£e
      const response = await fetch(identificarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ codigo: codigoLimpo })
      });
      
      const data = await response.json();
      
      if (data.status !== 'animal' || !data.dados) {
        mostrarLoading(false);
        mostrarToast('M√£e n√£o encontrada no sistema', 'error');
        return;
      }
      
      const mae = data.dados;
      console.log('M√£e encontrada:', mae);
      
      // 2. Buscar manejos de IATF da m√£e
      if (!mae.id) {
      mostrarLoading(false);
        mostrarToast('Erro: ID da m√£e n√£o encontrado', 'error');
        return;
      }
      
      let infoIATF = null;
      let touroInfo = null;
      
      // 2. Buscar manejos de IATF da m√£e (com tratamento de erro)
      try {
        const manejosResponse = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/${mae.id}/manejos/`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        if (manejosResponse.ok) {
          const manejosData = await manejosResponse.json();
          console.log('Manejos da m√£e:', manejosData);
          
          // Procurar manejo de IATF mais recente
          if (manejosData.historico && Array.isArray(manejosData.historico)) {
            // Ordenar por data (mais recente primeiro) e buscar IATF
            const manejosOrdenados = manejosData.historico
              .filter(m => m.tipo === 'manejo')
              .sort((a, b) => {
                const dataA = a.data_prevista || a.data || a.criado_em || '';
                const dataB = b.data_prevista || b.data || b.criado_em || '';
                return dataB.localeCompare(dataA);
              });
            
            const iatfManejo = manejosOrdenados.find(m => {
              const tipoNome = (m.tipo_manejo || m.tipo_nome || '').toUpperCase();
              const tipoSlug = (m.tipo_slug || '').toLowerCase();
              return tipoSlug.includes('iatf') || 
                     tipoSlug.includes('protocolo-reprodutivo') ||
                     tipoNome.includes('IATF') ||
                     tipoNome.includes('PROTOCOLO REPRODUTIVO') ||
                     (m.metadados && (m.metadados.protocolo || m.metadados.touro || m.metadados.touro_nome));
            });
            
            if (iatfManejo) {
              infoIATF = iatfManejo;
              console.log('Manejo IATF encontrado:', iatfManejo);
              
              // Extrair informa√ß√µes do touro dos metadados
              if (iatfManejo.metadados) {
                touroInfo = {
                  nome: iatfManejo.metadados.touro || iatfManejo.metadados.touro_nome || iatfManejo.metadados.touro_reprodutor || '',
                  id: iatfManejo.metadados.touro_id || null,
                  protocolo: iatfManejo.metadados.protocolo || iatfManejo.metadados.protocolo_nome || '',
                  data_iatf: iatfManejo.metadados.data_iatf || iatfManejo.data_prevista || iatfManejo.data || '',
                  inseminador: iatfManejo.metadados.inseminador || iatfManejo.metadados.inseminador_nome || ''
                };
                console.log('Informa√ß√µes do touro:', touroInfo);
              }
            }
          }
        }
      } catch (errorManejos) {
        console.warn('Erro ao buscar manejos da m√£e (n√£o cr√≠tico):', errorManejos);
        // Continuar mesmo se houver erro ao buscar manejos
      }
      
      // 3. Se n√£o encontrou via API de manejos, tentar buscar diretamente
      if (!infoIATF) {
        // Buscar em metadados do animal ou outras fontes
        // Por enquanto, vamos mostrar informa√ß√µes b√°sicas da m√£e
      }
      
      mostrarLoading(false);
      
      // 4. Exibir informa√ß√µes
      if (infoDiv && detalhesDiv) {
        let html = '';
        
        html += `<div style="margin-bottom: 8px;"><strong>M√£e:</strong> ${mae.numero_brinco || mae.codigo_sisbov || 'N/A'}`;
        if (mae.raca) html += ` - ${mae.raca}`;
        html += `</div>`;
        
        if (infoIATF && touroInfo) {
          html += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);">`;
          html += `<div style="font-weight: 700; color: #1b5e20; margin-bottom: 6px;">üêÑ Bezerro de IATF</div>`;
          
          if (touroInfo.nome) {
            html += `<div style="margin-bottom: 4px;"><strong>Touro:</strong> ${touroInfo.nome}</div>`;
          }
          
          if (touroInfo.protocolo) {
            html += `<div style="margin-bottom: 4px;"><strong>Protocolo:</strong> ${touroInfo.protocolo}</div>`;
          }
          
          if (touroInfo.data_iatf) {
            const dataIATF = new Date(touroInfo.data_iatf);
            html += `<div style="margin-bottom: 4px;"><strong>Data IATF:</strong> ${dataIATF.toLocaleDateString('pt-BR')}</div>`;
          }
          
          if (touroInfo.inseminador) {
            html += `<div><strong>Inseminador:</strong> ${touroInfo.inseminador}</div>`;
          }
          
          html += `</div>`;
        } else {
          html += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); color: #666; font-size: 0.85rem;">`;
          html += `‚ÑπÔ∏è Nenhum registro de IATF encontrado para esta m√£e.`;
          html += `</div>`;
        }
        
        detalhesDiv.innerHTML = html;
        infoDiv.style.display = 'block';
        
        if (infoIATF && touroInfo) {
          mostrarToast('M√£e encontrada! Informa√ß√µes de IATF carregadas.', 'success');
        } else {
          mostrarToast('M√£e encontrada, mas sem registro de IATF.', 'info');
        }
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('Erro ao buscar m√£e:', error);
      mostrarToast('Erro ao buscar informa√ß√µes da m√£e. Tente novamente.', 'error');
    }
  };

  // ========== FUN√á√ÉO PARA CALCULAR IDADE ==========
  function calcularIdade(dataNascimento) {
    if (!dataNascimento) return null;
    
    try {
      const nascimento = new Date(dataNascimento);
      if (isNaN(nascimento.getTime())) return null;
      
      const hoje = new Date();
      let anos = hoje.getFullYear() - nascimento.getFullYear();
      let meses = hoje.getMonth() - nascimento.getMonth();
      
      if (meses < 0 || (meses === 0 && hoje.getDate() < nascimento.getDate())) {
        anos--;
        meses += 12;
      }
      
      if (anos > 0) {
        return `${anos} ano${anos > 1 ? 's' : ''}${meses > 0 ? ` e ${meses} m√™s${meses > 1 ? 'es' : ''}` : ''}`;
      }
      return `${meses} m√™s${meses > 1 ? 'es' : ''}`;
    } catch (e) {
      return null;
    }
  }

  // ========== ATUALIZAR IDADE QUANDO DATA MUDAR ==========
  function atualizarIdade() {
    const dataNasc = document.getElementById('scannerDataNascV3');
    const idadeSpan = document.getElementById('scannerIdadeV3');
    
    if (dataNasc && idadeSpan) {
      const dataNascValue = dataNasc.value;
      if (dataNascValue) {
        const idade = calcularIdade(dataNascValue);
        idadeSpan.textContent = idade ? `Idade: ${idade}` : '‚Äî';
      } else {
        idadeSpan.textContent = '‚Äî';
      }
    }
  }

  // ========== CONFIGURAR CAMPOS EDIT√ÅVEIS ==========
  function configurarCamposEditaveis() {
    if (!animalAtualV3 || !animalAtualV3.id) return;
    
    const racaInput = document.getElementById('scannerRacaV3');
    const sexoSelect = document.getElementById('scannerSexoV3');
    const dataNasc = document.getElementById('scannerDataNascV3');
    const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
    const categoria = document.getElementById('scannerCategoriaV3');
    const pastoLote = document.getElementById('scannerPastoLoteV3');
    
    // Fun√ß√£o para salvar dados
    const salvarDados = async (campo, valor) => {
      if (!animalAtualV3 || !animalAtualV3.id) return;
      
      const payload = {
        animal_id: animalAtualV3.id
      };
      
      // Adicionar apenas o campo que foi alterado
      if (campo === 'raca') payload.raca = valor;
      else if (campo === 'sexo') payload.sexo = valor;
      else if (campo === 'data_nascimento') payload.data_nascimento = valor;
      else if (campo === 'peso') payload.peso = valor;
      else if (campo === 'categoria') payload.categoria = valor;
      else if (campo === 'lote') payload.lote = valor;
      
      try {
        const response = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/atualizar/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        if (data.status === 'ok') {
          mostrarToast('Dados atualizados com sucesso!', 'success');
        } else {
          mostrarToast(data.mensagem || 'Erro ao atualizar dados', 'error');
        }
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        mostrarToast('Erro ao salvar dados. Tente novamente.', 'error');
      }
    };
    
    // Remover listeners antigos se existirem
    if (racaInput) {
      racaInput.removeEventListener('blur', racaInput._saveHandler);
      racaInput._saveHandler = () => salvarDados('raca', racaInput.value);
      racaInput.addEventListener('blur', racaInput._saveHandler);
    }
    
    if (sexoSelect) {
      sexoSelect.removeEventListener('change', sexoSelect._saveHandler);
      sexoSelect._saveHandler = () => salvarDados('sexo', sexoSelect.value);
      sexoSelect.addEventListener('change', sexoSelect._saveHandler);
    }
    
    if (dataNasc) {
      dataNasc.removeEventListener('change', dataNasc._saveHandler);
      dataNasc._saveHandler = () => {
        salvarDados('data_nascimento', dataNasc.value);
        atualizarIdade(); // Atualizar idade quando a data mudar
      };
      dataNasc.addEventListener('change', dataNasc._saveHandler);
      // Tamb√©m atualizar quando o campo perder o foco
      dataNasc.addEventListener('blur', atualizarIdade);
    }
    
    if (ultimoPeso) {
      ultimoPeso.removeEventListener('blur', ultimoPeso._saveHandler);
      ultimoPeso._saveHandler = () => salvarDados('peso', ultimoPeso.value);
      ultimoPeso.addEventListener('blur', ultimoPeso._saveHandler);
    }
    
    if (categoria) {
      categoria.removeEventListener('blur', categoria._saveHandler);
      categoria._saveHandler = () => salvarDados('categoria', categoria.value);
      categoria.addEventListener('blur', categoria._saveHandler);
    }
    
    if (pastoLote) {
      pastoLote.removeEventListener('blur', pastoLote._saveHandler);
      pastoLote._saveHandler = () => salvarDados('lote', pastoLote.value);
      pastoLote.addEventListener('blur', pastoLote._saveHandler);
    }
  }

  // ========== BUSCAR ANIMAL POR ID ==========
  async function buscarAnimalPorId(animalId, codigo) {
    try {
      const response = await fetch(identificarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ 
          codigo: codigo,
          animal_id: animalId
        })
      });
      
      const data = await response.json();
      if (data.status === 'animal' && data.dados) {
        // Processar animal encontrado (mesmo c√≥digo do buscarBrincoV3)
        animalAtualV3 = data.dados;
        brincoAtualV3 = codigo;
        
        // Atualizar o campo de busca com o c√≥digo correto
        const brincoInput = document.getElementById('brincoInputV3');
        if (brincoInput) {
          // Usar n√∫mero de manejo se dispon√≠vel, sen√£o usar SISBOV
          const codigoParaInput = data.dados.numero_manejo || data.dados.codigo_sisbov || codigo;
          brincoInput.value = codigoParaInput;
          console.log('üìù Campo de busca atualizado com:', codigoParaInput);
        }
        
        // Preencher resumo
        const codigoEletronico = document.getElementById('scannerCodigoEletronicoV3');
        const sisbov = document.getElementById('scannerSisbovV3');
        const numeroManejo = document.getElementById('scannerNumeroManejoV3');
        const racaInput = document.getElementById('scannerRacaV3');
        const sexoSelect = document.getElementById('scannerSexoV3');
        const dataNasc = document.getElementById('scannerDataNascV3');
        const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
        const categoria = document.getElementById('scannerCategoriaV3');
        const pastoLote = document.getElementById('scannerPastoLoteV3');
        
        if (codigoEletronico) codigoEletronico.textContent = data.dados.codigo_eletronico || data.dados.numero_brinco || '‚Äî';
        if (sisbov) {
          sisbov.textContent = data.dados.codigo_sisbov || '‚Äî';
          sisbov.className = 'resumo-value resumo-sisbov';
          sisbov.style.color = '#2196F3';
          sisbov.style.fontSize = '1.25rem';
          sisbov.style.fontWeight = '700';
        }
        if (numeroManejo) {
          numeroManejo.textContent = data.dados.numero_manejo || '‚Äî';
          numeroManejo.className = 'resumo-value resumo-numero-manejo';
          numeroManejo.style.color = '#4CAF50';
          numeroManejo.style.fontSize = '1.75rem';
          numeroManejo.style.fontWeight = '700';
        }
        
        // Preencher campos edit√°veis
        if (racaInput) racaInput.value = data.dados.raca || '';
        
        // Converter sexo de display (F√™mea/Macho) para c√≥digo (F/M)
        if (sexoSelect && data.dados.sexo) {
          const sexoStr = String(data.dados.sexo).toUpperCase();
          if (sexoStr.includes('F√äMEA') || sexoStr.includes('FEMEA') || sexoStr === 'F') {
            sexoSelect.value = 'F';
          } else if (sexoStr.includes('MACHO') || sexoStr === 'M') {
            sexoSelect.value = 'M';
          } else {
            sexoSelect.value = '';
          }
        }
        
        // Formatar data de nascimento
        const idadeSpan = document.getElementById('scannerIdadeV3');
        if (dataNasc && data.dados.data_nascimento) {
          let dataNascObj = null;
          const dataNascStr = String(data.dados.data_nascimento).trim();
          
          if (dataNascStr.includes('/')) {
            const partes = dataNascStr.split('/');
            if (partes.length === 3) {
              dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
            }
          } else if (dataNascStr.includes('-')) {
            const partes = dataNascStr.split('-');
            if (partes.length === 3) {
              if (partes[0].length === 4) {
                dataNascObj = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
              } else {
                dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
              }
            }
          } else {
            dataNascObj = new Date(data.dados.data_nascimento);
          }
          
          if (dataNascObj && !isNaN(dataNascObj.getTime())) {
            const year = dataNascObj.getFullYear();
            const month = String(dataNascObj.getMonth() + 1).padStart(2, '0');
            const day = String(dataNascObj.getDate()).padStart(2, '0');
            dataNasc.value = `${year}-${month}-${day}`;
            if (idadeSpan) {
              const idade = calcularIdade(dataNasc.value);
              idadeSpan.textContent = idade ? `Idade: ${idade}` : '‚Äî';
            }
          } else {
            dataNasc.value = '';
            if (idadeSpan) idadeSpan.textContent = '‚Äî';
          }
        } else if (dataNasc) {
          dataNasc.value = '';
          if (idadeSpan) idadeSpan.textContent = '‚Äî';
        }
        
        if (ultimoPeso) {
          ultimoPeso.value = data.dados.peso_atual ? parseFloat(data.dados.peso_atual).toFixed(1) : '';
        }
        
        if (categoria) categoria.value = data.dados.categoria_nome || data.dados.categoria || '';
        if (pastoLote) pastoLote.value = data.dados.pasto_nome || data.dados.lote_nome || '';
        
        // Atualizar campo CONFORME BND (animal j√° cadastrado = verde)
        atualizarConformeBnd(data.dados, false);
        
        // Configurar event listeners
        configurarCamposEditaveis();
        atualizarIdade();
        
        // Habilitar campo de peso
        const pesoInput = document.getElementById('pesoValorV3');
        const pesoBtn = document.getElementById('pesoGravarBtnV3');
        const finalizarBtn = document.getElementById('btnFinalizarGravarV3');
        
        if (pesoInput) {
          pesoInput.disabled = false;
          pesoInput.removeAttribute('disabled');
        }
        if (pesoBtn) {
          pesoBtn.disabled = false;
          pesoBtn.removeAttribute('disabled');
        }
        if (finalizarBtn) {
          finalizarBtn.disabled = false;
          finalizarBtn.removeAttribute('disabled');
        }
      }
    } catch (error) {
      console.error('Erro ao buscar animal por ID:', error);
    }
  }

  // ========== BUSCAR PR√ìXIMO BRINCO E PREENCHER CAMPO ==========
  async function buscarProximoBrincoEAbrirModal(manejoAtualParam = null) {
    try {
      let manejoAtual = manejoAtualParam;
      
      // Se n√£o foi passado como par√¢metro, extrair n√∫mero de manejo do card
      if (!manejoAtual) {
        const numeroManejoAtual = document.getElementById('scannerNumeroManejoV3');
        manejoAtual = numeroManejoAtual ? numeroManejoAtual.textContent.trim() : '';
        
        // Se n√£o conseguiu do card, tentar do brinco atual
        if ((!manejoAtual || manejoAtual === '‚Äî') && brincoAtualV3) {
          // Tentar extrair do SISBOV
          const sisbovAtual = document.getElementById('scannerSisbovV3');
          const sisbov = sisbovAtual ? sisbovAtual.textContent.trim() : '';
          if (sisbov && sisbov.length >= 15) {
            manejoAtual = sisbov.substring(8, 14);
          } else if (sisbov && sisbov.length >= 6) {
            manejoAtual = sisbov.slice(-6);
          } else if (brincoAtualV3 && brincoAtualV3.length >= 6) {
            // Tentar extrair do pr√≥prio brinco
            manejoAtual = brincoAtualV3.length === 15 ? brincoAtualV3.substring(8, 14) : brincoAtualV3.slice(-6);
          }
        }
      }
      
      if (!manejoAtual || manejoAtual === '‚Äî') {
        console.log('N√£o foi poss√≠vel extrair n√∫mero de manejo');
        return;
      }
      
      // Garantir que √© um n√∫mero v√°lido
      const manejoNum = parseInt(manejoAtual);
      if (isNaN(manejoNum)) {
        console.log('N√∫mero de manejo inv√°lido:', manejoAtual);
        return;
      }
      
      // Calcular pr√≥ximo n√∫mero de manejo (sempre sequencial, n√£o pular)
      const proximoManejo = String(manejoNum + 1).padStart(6, '0');
      
      // Construir pr√≥ximo SISBOV (assumindo formato padr√£o)
      let proximoSisbov = '';
      const sisbovAtual = document.getElementById('scannerSisbovV3');
      const sisbov = sisbovAtual ? sisbovAtual.textContent.trim() : '';
      if (sisbov && sisbov.length === 15) {
        // Formato: 10550037 + manejo + d√≠gito verificador
        const prefixo = sisbov.substring(0, 8);
        const verificador = sisbov.substring(14, 15);
        proximoSisbov = prefixo + proximoManejo + verificador;
      } else {
        // Se n√£o conseguir construir, usar apenas o manejo
        proximoSisbov = proximoManejo;
      }
      
      // Sempre usar o pr√≥ximo n√∫mero sequencial (n√£o pular n√∫meros)
      const codigoParaBuscar = proximoSisbov || proximoManejo;
      
      // Verificar se est√° no estoque
      try {
        const response = await fetch(identificarUrl + '?codigo=' + encodeURIComponent(codigoParaBuscar), {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'estoque' && data.dados) {
          // Encontrou no estoque - abrir modal de cadastro preenchido
          abrirModalCadastroEstoque(codigoParaBuscar, data.dados);
          return;
        } else if (data.status === 'animal' && data.dados) {
          // J√° √© um animal cadastrado - apenas preencher o card, N√ÉO abrir modal
          console.log('‚úÖ Animal j√° cadastrado encontrado, preenchendo card apenas');
          const brincoInput = document.getElementById('brincoInputV3');
          if (brincoInput) {
            brincoInput.value = codigoParaBuscar;
            // Buscar e preencher o card diretamente sem abrir modal
            setTimeout(() => {
              buscarBrincoV3();
            }, 300);
          }
          // N√ÉO abrir modal quando animal j√° est√° cadastrado
          return;
        } else if (data.status === 'estoque_multiplos' && data.brincos) {
          // M√∫ltiplos brincos encontrados - abrir modal de sele√ß√£o
          abrirModalCadastroEstoque(codigoParaBuscar, data.dados);
          return;
        } else {
          // N√£o encontrou no estoque nem como animal - abrir modal para cadastro
          // Usar apenas o n√∫mero de manejo para construir o SISBOV
          console.log('üìù Brinco n√£o encontrado, abrindo modal para cadastro');
          abrirModalCadastroEstoque(codigoParaBuscar, {
            numero_manejo: proximoManejo,
            numero_brinco: proximoSisbov || proximoManejo
          });
          return;
        }
      } catch (error) {
        console.error('Erro ao buscar brinco:', error);
        // Em caso de erro, ainda assim abrir modal com o pr√≥ximo n√∫mero
        abrirModalCadastroEstoque(codigoParaBuscar, {
          numero_manejo: proximoManejo,
          numero_brinco: proximoSisbov || proximoManejo
        });
      }
    } catch (error) {
      console.error('Erro ao buscar pr√≥ximo brinco:', error);
    }
  }

  // ========== GRAVAR PESAGEM ==========
  window.gravarPesagemV3 = async function() {
    const peso = document.getElementById('pesoValorV3').value.trim().replace(',', '.');
    
    if (!peso || parseFloat(peso) <= 0) {
      mostrarToast('Informe um peso v√°lido', 'warning');
      return;
    }

    if (!brincoAtualV3) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }

    mostrarLoading(true);
    
    const payload = {
      tipo_fluxo: animalAtualV3 ? 'animal' : 'estoque',
      manejo: 'PESAGEM',
      codigo: brincoAtualV3,
      animal_id: animalAtualV3?.id || null,
      dados: {
        peso_kg: parseFloat(peso)
      }
    };

    try {
      const response = await fetch(registrarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      mostrarLoading(false);

      if (data.status === 'ok') {
        mostrarToast(data.mensagem || 'Pesagem registrada com sucesso!', 'success');
        
        // Gravar manejos selecionados tamb√©m
        if (manejosSelecionadosV3.length > 0 && animalAtualV3) {
          try {
            const manejosPayload = {
              tipo_fluxo: 'animal',
              codigo: brincoAtualV3,
              animal_id: animalAtualV3.id,
              manejos: manejosSelecionadosV3.map(m => ({
                tipo: m.tipo,
                dados: m.dados || {}
              }))
            };
            
            const manejosResponse = await fetch('/propriedade/' + propriedadeId + '/curral/api/manejos/registrar/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify(manejosPayload)
            });
            
            const manejosData = await manejosResponse.json();
            if (manejosData.status === 'ok') {
              console.log('Manejos registrados com sucesso');
            }
          } catch (error) {
            console.error('Erro ao registrar manejos:', error);
          }
        }
        
        // Atualizar campos de peso registrado
        const pesoRegistrado = document.getElementById('pesoRegistradoV3');
        const pesoUltimoData = document.getElementById('pesoUltimoDataV3');
        const pesoDiasUltimo = document.getElementById('pesoDiasUltimoV3');
        const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV3');
        const pesoGanhoDiario = document.getElementById('pesoGanhoDiarioV3');
        
        if (pesoRegistrado) pesoRegistrado.textContent = `${peso.replace('.', ',')} kg`;
        if (pesoUltimoData && data.data) {
          const dataPesagem = new Date(data.data);
          pesoUltimoData.textContent = dataPesagem.toLocaleDateString('pt-BR');
        }
        
        // Calcular dias desde √∫ltima pesagem
        if (pesoDiasUltimo && data.data) {
          const dataPesagem = new Date(data.data);
          const hoje = new Date();
          const diffTime = Math.abs(hoje - dataPesagem);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          pesoDiasUltimo.textContent = `${diffDays} dias`;
        }
        
        // Calcular ganho se houver peso anterior
        let ganhoTotal = 0;
        let ganhoDiario = 0;
        if (animalAtualV3 && animalAtualV3.peso_atual && pesoGanhoTotal) {
          const pesoAnterior = parseFloat(animalAtualV3.peso_atual) || 0;
          const pesoAtual = parseFloat(peso);
          ganhoTotal = pesoAtual - pesoAnterior;
          pesoGanhoTotal.textContent = `${ganhoTotal > 0 ? '+' : ''}${ganhoTotal.toFixed(2).replace('.', ',')} kg`;
          // Aplicar cores din√¢micas: verde para ganho, vermelho para perda
          pesoGanhoTotal.classList.remove('ganho-positivo', 'ganho-negativo');
          if (ganhoTotal > 0) {
            pesoGanhoTotal.classList.add('ganho-positivo');
          } else if (ganhoTotal < 0) {
            pesoGanhoTotal.classList.add('ganho-negativo');
          }
          
          // Calcular ganho di√°rio m√©dio
          if (pesoDiasUltimo && data.data) {
            const dataPesagem = new Date(data.data);
            const hoje = new Date();
            const diffTime = Math.abs(hoje - dataPesagem);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 0) {
              ganhoDiario = ganhoTotal / diffDays;
              const pesoGanhoDia = document.getElementById('pesoGanhoDiaV3');
              if (pesoGanhoDia) {
                pesoGanhoDia.textContent = `${ganhoDiario > 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
              }
            }
          }
        }
        
        // Atualizar term√¥metro de efici√™ncia
        atualizarTermometroEficiencia(ganhoDiario);
        
        document.getElementById('pesoValorV3').value = '';
        
        // Limpar manejos selecionados
        manejosSelecionadosV3 = [];
        atualizarListaManejosV3();
        
        // Adicionar √† tabela
        adicionarAnimalTabela(animalAtualV3, peso);
        
        // Habilitar bot√£o finalizar
        document.getElementById('btnFinalizarGravarV3').disabled = false;
        
        // Atualizar estat√≠sticas
        atualizarEstatisticas();
        
        // Atualizar estat√≠sticas da sess√£o
        atualizarEstatisticasSessao();
        
        // Buscar pr√≥ximo brinco dispon√≠vel e abrir modal automaticamente
        await buscarProximoBrincoEAbrirModal();
      } else {
        console.error('Erro ao registrar pesagem:', data);
        mostrarToast(data.mensagem || 'Erro ao registrar pesagem', 'error');
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('Erro ao gravar pesagem:', error);
      mostrarToast('Erro ao gravar pesagem. Tente novamente.', 'error');
    }
  };

  // ========== LIMPAR PESO ==========
  window.limparPesoV3 = function() {
    document.getElementById('pesoValorV3').value = '';
    document.getElementById('pesoValorV3').focus();
  };

  // ========== FINALIZAR E GRAVAR ==========
  window.finalizarEGravarV3 = async function() {
    if (!brincoAtualV3) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }

    if (!document.getElementById('pesoValorV3').value && manejosSelecionadosV3.length === 0) {
      mostrarToast('Registre uma pesagem ou selecione manejos', 'warning');
      return;
    }

    mostrarLoading(true);
    
    try {
      // Gravar pesagem se houver
      if (document.getElementById('pesoValorV3').value) {
        await gravarPesagemV3();
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Gravar manejos selecionados
      if (manejosSelecionadosV3.length > 0) {
        for (const manejo of manejosSelecionadosV3) {
          const payload = {
            tipo_fluxo: animalAtualV3 ? 'animal' : 'estoque',
            manejo: manejo.tipo,
            codigo: brincoAtualV3,
            animal_id: animalAtualV3?.id || null,
            dados: manejo.dados || {}
          };

          const response = await fetch(registrarUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            console.error('Erro ao registrar manejo:', manejo.tipo);
          }
        }
      }

      mostrarLoading(false);
      mostrarToast('Processo finalizado com sucesso!', 'success');
      
      // Buscar pr√≥ximo brinco ANTES de limpar os campos (para ter acesso aos dados)
      await buscarProximoBrincoEAbrirModal();
      
      // Limpar campos
      document.getElementById('brincoInputV3').value = '';
      document.getElementById('pesoValorV3').value = '';
      document.getElementById('pesoValorV3').disabled = true;
      document.getElementById('pesoGravarBtnV3').disabled = true;
      document.getElementById('btnFinalizarGravarV3').disabled = true;
      
      // Limpar valores da tabela (mas manter vis√≠vel)
      document.getElementById('scannerCodigoEletronicoV3').textContent = '‚Äî';
      const sisbovEl = document.getElementById('scannerSisbovV3');
      const numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
      if (sisbovEl) {
        sisbovEl.textContent = '‚Äî';
        sisbovEl.className = 'resumo-value resumo-sisbov';
        sisbovEl.style.color = '#2196F3';
        sisbovEl.style.fontSize = '1.25rem';
        sisbovEl.style.fontWeight = '700';
      }
      if (numeroManejoEl) {
        numeroManejoEl.textContent = '‚Äî';
        numeroManejoEl.className = 'resumo-value resumo-numero-manejo';
        numeroManejoEl.style.color = '#4CAF50';
        numeroManejoEl.style.fontSize = '1.75rem';
        numeroManejoEl.style.fontWeight = '700';
      }
      const racaInput = document.getElementById('scannerRacaV3');
      const sexoSelect = document.getElementById('scannerSexoV3');
      const dataNasc = document.getElementById('scannerDataNascV3');
      const idadeSpan = document.getElementById('scannerIdadeV3');
      const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
      const categoria = document.getElementById('scannerCategoriaV3');
      const pastoLote = document.getElementById('scannerPastoLoteV3');
      if (racaInput) racaInput.value = '';
      if (sexoSelect) sexoSelect.value = '';
      if (dataNasc) dataNasc.value = '';
      if (idadeSpan) idadeSpan.textContent = '‚Äî';
      if (ultimoPeso) ultimoPeso.value = '';
      if (categoria) categoria.value = '';
      if (pastoLote) pastoLote.value = '';
      
      limparTodosManejosV3();
      animalAtualV3 = null;
      brincoAtualV3 = null;
      
      // Atualizar estat√≠sticas
      atualizarEstatisticas();
      
      // Atualizar estat√≠sticas da sess√£o
      atualizarEstatisticasSessao();
    } catch (error) {
      mostrarLoading(false);
      console.error('Erro ao finalizar:', error);
      mostrarToast('Erro ao finalizar processo', 'error');
    }
  };

  // ========== MODAL DE DUPLICIDADE ==========
  window.abrirModalDuplicidade = function(animais, codigoLido, mensagem) {
    const modal = document.getElementById('modalDuplicidade');
    const listaContainer = document.getElementById('listaDuplicidadeAnimais');
    
    listaContainer.innerHTML = '';
    
    animais.forEach((animal, index) => {
      const card = document.createElement('div');
      card.style.cssText = 'padding: 16px; border: 2px solid #e0e0e0; border-radius: var(--radius); margin-bottom: 12px; cursor: pointer; transition: all 0.2s; background: white;';
      card.onmouseenter = function() {
        this.style.borderColor = 'var(--primary)';
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
      card.onmouseleave = function() {
        this.style.borderColor = '#e0e0e0';
        this.style.boxShadow = 'none';
      };
      card.onclick = function() {
        selecionarAnimalDuplicidade(animal.id, codigoLido);
      };
      
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
          <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1.125rem; color: var(--primary); margin-bottom: 8px;">
              SISBOV: ${animal.codigo_sisbov}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.875rem; color: var(--text-secondary);">
              <div><strong>N√∫mero de Manejo:</strong> ${animal.numero_manejo || '‚Äî'}</div>
              <div><strong>RFID:</strong> ${animal.codigo_eletronico || '‚Äî'}</div>
              <div><strong>Ra√ßa:</strong> ${animal.raca || '‚Äî'}</div>
              <div><strong>Sexo:</strong> ${animal.sexo || '‚Äî'}</div>
              <div><strong>Nascimento:</strong> ${animal.data_nascimento || '‚Äî'}</div>
              <div><strong>Categoria:</strong> ${animal.categoria || '‚Äî'}</div>
              ${animal.peso_atual ? `<div><strong>Peso Atual:</strong> ${animal.peso_atual.toFixed(1)} kg</div>` : ''}
            </div>
          </div>
          <div style="color: var(--primary); font-size: 1.5rem;">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 0.75rem; color: var(--text-light); text-align: center;">
          Clique para selecionar este animal
        </div>
      `;
      
      listaContainer.appendChild(card);
    });
    
    modal.classList.add('show');
  };
  
  window.selecionarAnimalDuplicidade = async function(animalId, codigoLido) {
    mostrarLoading(true);
    
    try {
      // Buscar animal pelo ID usando o c√≥digo lido novamente, mas agora com o animal_id
      const response = await fetch(identificarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ 
          codigo: codigoLido,
          animal_id: animalId  // Informar qual animal foi selecionado
        })
      });

      const data = await response.json();
      mostrarLoading(false);
      
      if (data.status === 'animal' && data.dados) {
        // Processar animal encontrado (mesmo c√≥digo do buscarBrincoV3)
        animalAtualV3 = data.dados;
        brincoAtualV3 = codigoLido;
        
        // Preencher resumo
        const codigoEletronico = document.getElementById('scannerCodigoEletronicoV3');
        const sisbov = document.getElementById('scannerSisbovV3');
        const numeroManejo = document.getElementById('scannerNumeroManejoV3');
        const racaInput = document.getElementById('scannerRacaV3');
        const sexoSelect = document.getElementById('scannerSexoV3');
        const dataNasc = document.getElementById('scannerDataNascV3');
        const ultimoPeso = document.getElementById('scannerUltimoPesoV3');
        const categoria = document.getElementById('scannerCategoriaV3');
        const pastoLote = document.getElementById('scannerPastoLoteV3');
        
        if (codigoEletronico) codigoEletronico.textContent = data.dados.codigo_eletronico || data.dados.numero_brinco || '‚Äî';
        if (sisbov) {
          sisbov.textContent = data.dados.codigo_sisbov || '‚Äî';
          sisbov.className = 'resumo-value resumo-sisbov';
          // Aplicar estilos inline para garantir que a cor azul seja aplicada
          sisbov.style.color = '#2196F3';
          sisbov.style.fontSize = '1.25rem';
          sisbov.style.fontWeight = '700';
        }
        if (numeroManejo) {
          numeroManejo.textContent = data.dados.numero_manejo || '‚Äî';
          numeroManejo.className = 'resumo-value resumo-numero-manejo';
          // Aplicar estilos inline para garantir que a cor verde seja aplicada
          numeroManejo.style.color = '#4CAF50';
          numeroManejo.style.fontSize = '1.75rem';
          numeroManejo.style.fontWeight = '700';
        }
        
        // Preencher campos edit√°veis
        // Mapear ra√ßa do animal para o c√≥digo do select (ex: "Nelore" -> "NE")
        if (racaInput && data.dados.raca) {
          const racaMap = {
            'Nelore': 'NE', 'NE': 'NE', 'NE - Nelore': 'NE', 'NELORE': 'NE',
            'Composto': 'XX', 'XX': 'XX', 'XX - Composto': 'XX',
            'Angus': 'AN', 'AN': 'AN', 'AN - Angus': 'AN', 'ANGUS': 'AN',
            'Brahman': 'BR', 'BR': 'BR', 'BR - Brahman': 'BR', 'BRAHMAN': 'BR',
            'Canchim': 'CA', 'CA': 'CA', 'CA - Canchim': 'CA', 'CANCHIM': 'CA',
            'Guzer√°': 'GU', 'GU': 'GU', 'GU - Guzer√°': 'GU', 'GUZERA': 'GU',
            'Gir': 'GI', 'GI': 'GI', 'GI - Gir': 'GI', 'GIR': 'GI',
            'Girolando': 'GN', 'GN': 'GN', 'GN - Girolando': 'GN',
            'Holand√™s': 'HO', 'HO': 'HO', 'HO - Holand√™s': 'HO',
            'Indubrasil': 'IN', 'IN': 'IN', 'IN - Indubrasil': 'IN',
            'Marchigiana': 'MA', 'MA': 'MA', 'MA - Marchigiana': 'MA',
            'Montana': 'MO', 'MO': 'MO', 'MO - Montana': 'MO',
            'Polled Hereford': 'PO', 'PO': 'PO', 'PO - Polled Hereford': 'PO',
            'Pardo Su√≠√ßo': 'PR', 'PR': 'PR', 'PR - Pardo Su√≠√ßo': 'PR',
            'Santa Gertrudis': 'RA', 'RA': 'RA', 'RA - Ra√ßa Santa Gertrudis': 'RA',
            'Simental': 'SI', 'SI': 'SI', 'SI - Simental': 'SI', 'SIMENTAL': 'SI',
            'Tabapu√£': 'TA', 'TA': 'TA', 'TA - Tabapu√£': 'TA',
            'Tricross': 'TR', 'TR': 'TR', 'TR - Tricross': 'TR',
            'Zebu': 'ZE', 'ZE': 'ZE', 'ZE - Zebu': 'ZE',
            'Outra': 'OT', 'OT': 'OT', 'OT - Outra': 'OT', 'OUTROS': 'OT'
          };
          const racaCodigo = racaMap[data.dados.raca] || '';
          racaInput.value = racaCodigo;
        } else if (racaInput) {
          racaInput.value = '';
        }
        
        // Converter sexo de display (F√™mea/Macho) para c√≥digo (F/M)
        if (sexoSelect && data.dados.sexo) {
          const sexoStr = String(data.dados.sexo).toUpperCase();
          if (sexoStr.includes('F√äMEA') || sexoStr.includes('FEMEA') || sexoStr === 'F') {
            sexoSelect.value = 'F';
          } else if (sexoStr.includes('MACHO') || sexoStr === 'M') {
            sexoSelect.value = 'M';
          } else {
            sexoSelect.value = '';
          }
        }
        
        // Formatar data de nascimento para input type="date" (formato YYYY-MM-DD)
        const idadeSpan = document.getElementById('scannerIdadeV3');
        if (dataNasc && data.dados.data_nascimento) {
          let dataNascObj = null;
          const dataNascStr = String(data.dados.data_nascimento).trim();
          
          // Tentar diferentes formatos de data
          if (dataNascStr.includes('/')) {
            // Formato DD/MM/YYYY
            const partes = dataNascStr.split('/');
            if (partes.length === 3) {
              dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
            }
          } else if (dataNascStr.includes('-')) {
            // Formato YYYY-MM-DD ou DD-MM-YYYY
            const partes = dataNascStr.split('-');
            if (partes.length === 3) {
              if (partes[0].length === 4) {
                // YYYY-MM-DD
                dataNascObj = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
              } else {
                // DD-MM-YYYY
                dataNascObj = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
              }
            }
          } else {
            // Tentar como Date ISO
            dataNascObj = new Date(data.dados.data_nascimento);
          }
          
          if (dataNascObj && !isNaN(dataNascObj.getTime())) {
            const year = dataNascObj.getFullYear();
            const month = String(dataNascObj.getMonth() + 1).padStart(2, '0');
            const day = String(dataNascObj.getDate()).padStart(2, '0');
            dataNasc.value = `${year}-${month}-${day}`;
            // Calcular e exibir idade
            if (idadeSpan) {
              const idade = calcularIdade(dataNasc.value);
              idadeSpan.textContent = idade ? `Idade: ${idade}` : '‚Äî';
            }
          } else {
            dataNasc.value = '';
            if (idadeSpan) idadeSpan.textContent = '‚Äî';
          }
        } else if (dataNasc) {
          dataNasc.value = '';
          if (idadeSpan) idadeSpan.textContent = '‚Äî';
        }
        
        if (ultimoPeso) {
          ultimoPeso.value = data.dados.peso_atual ? parseFloat(data.dados.peso_atual).toFixed(1) : '';
        }
        
        if (categoria) categoria.value = data.dados.categoria_nome || data.dados.categoria || '';
        if (pastoLote) pastoLote.value = data.dados.pasto_nome || data.dados.lote_nome || '';
        
        // Configurar event listeners para salvar automaticamente quando editar
        configurarCamposEditaveis();
        
        // Atualizar idade se houver data de nascimento
        atualizarIdade();
        
        // Habilitar campos
        const pesoInput = document.getElementById('pesoValorV3');
        const pesoBtn = document.getElementById('pesoGravarBtnV3');
        const finalizarBtn = document.getElementById('btnFinalizarGravarV3');
        
        if (pesoInput) {
          pesoInput.disabled = false;
          pesoInput.removeAttribute('disabled');
          pesoInput.focus();
        }
        
        if (pesoBtn) {
          pesoBtn.disabled = false;
          pesoBtn.removeAttribute('disabled');
        }
        
        if (finalizarBtn) {
          finalizarBtn.disabled = false;
          finalizarBtn.removeAttribute('disabled');
        }
        
        // Fechar modal
        fecharModal('modalDuplicidade');
        
        mostrarToast('Animal selecionado com sucesso!', 'success');
      } else {
        mostrarToast('Erro ao selecionar animal. Tente novamente.', 'error');
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('Erro ao selecionar animal:', error);
      mostrarToast('Erro ao selecionar animal. Tente novamente.', 'error');
    }
  };

  // ========== CADASTRO DE ESTOQUE ==========
  window.abrirModalCadastroEstoque = function(brinco, dadosEstoque) {
    const brincoSpan = document.getElementById('cadastroBrincoV3');
    const sisbovSpan = document.getElementById('cadastroSisbovV3');
    const numeroManejoSpan = document.getElementById('cadastroNumeroManejoV3');
    const rfidInput = document.getElementById('cadastroRfidV3');
    
    // Garantir que o brinco seja sempre definido
    if (brinco) {
      // Remover espa√ßos extras do brinco
      brinco = String(brinco).trim().replace(/\s+/g, '');
      brincoAtualV3 = brinco;
      if (brincoSpan) {
        // Exibir brinco formatado (com espa√ßo se for longo)
        const brincoFormatado = brinco.length > 12 ? brinco.substring(0, 12) + ' ' + brinco.substring(12) : brinco;
        brincoSpan.textContent = brincoFormatado;
      }
    } else if (brincoSpan && brincoSpan.textContent && brincoSpan.textContent.trim() !== '‚Äî') {
      // Se n√£o veio brinco mas o span tem valor, usar ele
      brinco = brincoSpan.textContent.trim().replace(/\s+/g, '');
      brincoAtualV3 = brinco;
    }
    
    // Preencher SISBOV e n√∫mero de manejo se vierem dos dados do estoque
    if (dadosEstoque) {
      if (sisbovSpan && dadosEstoque.numero_brinco) {
        sisbovSpan.textContent = dadosEstoque.numero_brinco;
      }
      if (numeroManejoSpan && dadosEstoque.numero_manejo) {
        numeroManejoSpan.textContent = dadosEstoque.numero_manejo;
      }
      if (rfidInput && dadosEstoque.codigo_rfid) {
        rfidInput.value = dadosEstoque.codigo_rfid;
      }
    } else {
      // Se n√£o vieram dados, usar o brinco como SISBOV e extrair manejo
      if (sisbovSpan && brinco) {
        sisbovSpan.textContent = brinco;
      }
      if (numeroManejoSpan && brinco && brinco.length >= 6) {
        // Extrair n√∫mero de manejo (√∫ltimos 6 d√≠gitos se for SISBOV completo, ou o pr√≥prio c√≥digo)
        const manejo = brinco.length === 15 ? brinco.substring(8, 14) : (brinco.length >= 6 ? brinco.slice(-6) : brinco);
        numeroManejoSpan.textContent = manejo;
      }
    }
    
    // Preencher campos com dados do √∫ltimo cadastro, se existir
    const racaInput = document.getElementById('cadastroRacaV3');
    const sexoInput = document.getElementById('cadastroSexoV3');
    const idadeInput = document.getElementById('cadastroIdadeV3');
    const dataNascInput = document.getElementById('cadastroDataNascV3');
    const tipoRegistroInput = document.getElementById('cadastroTipoRegistroV3');
    
    if (ultimoCadastroEstoqueV3) {
      if (racaInput && ultimoCadastroEstoqueV3.raca) {
        racaInput.value = ultimoCadastroEstoqueV3.raca;
      }
      if (sexoInput && ultimoCadastroEstoqueV3.sexo) {
        sexoInput.value = ultimoCadastroEstoqueV3.sexo;
      }
      if (idadeInput && ultimoCadastroEstoqueV3.idade) {
        idadeInput.value = ultimoCadastroEstoqueV3.idade;
      }
      if (dataNascInput && ultimoCadastroEstoqueV3.data_nascimento) {
        dataNascInput.value = ultimoCadastroEstoqueV3.data_nascimento;
      }
      if (rfidInput && ultimoCadastroEstoqueV3.rfid) {
        rfidInput.value = ultimoCadastroEstoqueV3.rfid;
      }
    } else {
      // Limpar campos se n√£o houver √∫ltimo cadastro
      if (racaInput) racaInput.value = '';
      if (sexoInput) sexoInput.value = '';
      if (idadeInput) idadeInput.value = '';
      if (dataNascInput) dataNascInput.value = '';
      if (tipoRegistroInput) tipoRegistroInput.value = '';
      if (rfidInput && !rfidInput.value) rfidInput.value = '';
    }
    
    // Verificar se pode habilitar o bot√£o
    validarBotaoConfirmarCadastro();
    
    // Abrir modal
    document.getElementById('modalCadastroEstoque').classList.add('show');
    
    // Reconfigurar listeners de Enter e idade/data (sem duplicar)
    setTimeout(() => {
      if (!window._enterModalConfigurado) {
        window._enterModalConfigurado = true;
        configurarEnterModalCadastro();
      }
      
      // For√ßar c√°lculo se j√° tiver valor no campo de idade
      const idadeField = document.getElementById('cadastroIdadeV3');
      if (idadeField && idadeField.value) {
        calcularDataNascimentoDeIdade();
      }
    }, 100);
    
    // Focar no campo RFID (primeiro campo)
    setTimeout(() => {
      const rfidInput = document.getElementById('cadastroRfidV3');
      if (rfidInput) {
        rfidInput.focus();
      } else if (racaInput && !racaInput.value) {
        racaInput.focus();
      } else if (sexoInput && !sexoInput.value) {
        sexoInput.focus();
      } else if (idadeInput && !idadeInput.value && !dataNascInput.value) {
        idadeInput.focus();
      }
    }, 150);
  };

  // Fun√ß√£o para adicionar listeners de Enter nos campos do modal
  function configurarEnterModalCadastro() {
    const camposModal = ['cadastroRacaV3', 'cadastroSexoV3', 'cadastroRfidV3', 'cadastroIdadeV3', 'cadastroDataNascV3', 'cadastroTipoRegistroV3'];
    
    camposModal.forEach(campoId => {
      const campo = document.getElementById(campoId);
      if (campo && !campo._enterListenerAdicionado) {
        campo._enterListenerAdicionado = true;
        
        // Adicionar listener apenas uma vez
        campo.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
            if (btnConfirmar && !btnConfirmar.disabled && typeof window.confirmarCadastroEstoqueV3 === 'function') {
              window.confirmarCadastroEstoqueV3();
            }
          }
        }, { passive: false });
      }
    });
  }

  document.getElementById('cadastroSexoV3')?.addEventListener('change', function() {
    validarBotaoConfirmarCadastro();
  });
  
  // Listener para o campo de ra√ßa
  document.getElementById('cadastroRacaV3')?.addEventListener('input', function() {
    validarBotaoConfirmarCadastro();
  });
  
  document.getElementById('cadastroRacaV3')?.addEventListener('change', function() {
    validarBotaoConfirmarCadastro();
  });
  
  // Listener para o campo de tipo de registro
  document.getElementById('cadastroTipoRegistroV3')?.addEventListener('change', function() {
    validarBotaoConfirmarCadastro();
  });

  // Fun√ß√£o para validar e habilitar/desabilitar bot√£o de confirmar cadastro
  function validarBotaoConfirmarCadastro() {
    const raca = document.getElementById('cadastroRacaV3')?.value.trim() || '';
    const sexo = document.getElementById('cadastroSexoV3')?.value || '';
    const idade = document.getElementById('cadastroIdadeV3')?.value || '';
    const dataNasc = document.getElementById('cadastroDataNascV3')?.value || '';
    const tipoRegistro = document.getElementById('cadastroTipoRegistroV3')?.value || '';
    const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
    
    if (btnConfirmar) {
      btnConfirmar.disabled = !(raca && sexo && (idade || dataNasc) && tipoRegistro);
    }
  }

  // Fun√ß√£o para calcular data de nascimento a partir da idade
  function calcularDataNascimentoDeIdade() {
    const idadeInput = document.getElementById('cadastroIdadeV3');
    const dataNascInput = document.getElementById('cadastroDataNascV3');
    
    if (!idadeInput || !dataNascInput) return;
    
    const idade = parseInt(idadeInput.value);
    if (idade && idade > 0) {
      const hoje = new Date();
      const dataNasc = new Date(hoje.getFullYear(), hoje.getMonth() - idade, hoje.getDate());
      dataNascInput.value = dataNasc.toISOString().split('T')[0];
      
      // Atualizar habilita√ß√£o do bot√£o
      validarBotaoConfirmarCadastro();
    }
  }
  
  // Fun√ß√£o para calcular idade a partir da data de nascimento
  function calcularIdadeDeDataNascimento() {
    const idadeInput = document.getElementById('cadastroIdadeV3');
    const dataNascInput = document.getElementById('cadastroDataNascV3');
    
    if (!idadeInput || !dataNascInput) return;
    
    const dataNasc = new Date(dataNascInput.value);
    if (dataNasc && !isNaN(dataNasc.getTime())) {
      const hoje = new Date();
      const diffAnos = hoje.getFullYear() - dataNasc.getFullYear();
      const diffMeses = hoje.getMonth() - dataNasc.getMonth();
      const diffDias = hoje.getDate() - dataNasc.getDate();
      let totalMeses = diffAnos * 12 + diffMeses;
      if (diffDias < 0) totalMeses--;
      if (totalMeses >= 0) {
        idadeInput.value = totalMeses;
      }
      
      // Atualizar habilita√ß√£o do bot√£o
      validarBotaoConfirmarCadastro();
    }
  }

  // Fun√ß√£o para configurar listeners de idade e data de nascimento
  function configurarIdadeDataNascimento() {
    const idadeInput = document.getElementById('cadastroIdadeV3');
    const dataNascInput = document.getElementById('cadastroDataNascV3');
    
    if (idadeInput && !idadeInput._listenersConfigurados) {
      idadeInput._listenersConfigurados = true;
      
      // Debounce para evitar m√∫ltiplas execu√ß√µes
      let timeoutIdade = null;
      const handlerIdade = function() {
        clearTimeout(timeoutIdade);
        timeoutIdade = setTimeout(calcularDataNascimentoDeIdade, 300);
      };
      
      idadeInput.addEventListener('input', handlerIdade, { passive: true });
      idadeInput.addEventListener('change', calcularDataNascimentoDeIdade, { passive: true });
      idadeInput.addEventListener('keyup', function(e) {
        if (e.key !== 'Enter') {
          handlerIdade();
        }
      }, { passive: true });
    }
    
    if (dataNascInput && !dataNascInput._listenersConfigurados) {
      dataNascInput._listenersConfigurados = true;
      
      // Debounce para evitar m√∫ltiplas execu√ß√µes
      let timeoutData = null;
      const handlerData = function() {
        clearTimeout(timeoutData);
        timeoutData = setTimeout(calcularIdadeDeDataNascimento, 300);
      };
      
      dataNascInput.addEventListener('change', handlerData, { passive: true });
      dataNascInput.addEventListener('input', handlerData, { passive: true });
    }
  }
  
  // Vari√°vel para armazenar refer√™ncia do intervalo de estat√≠sticas
  let intervaloEstatisticas = null;
  
  // Configurar event delegation e listeners quando a p√°gina carregar
  document.addEventListener('DOMContentLoaded', function() {
    // Usar event delegation no modal para garantir que sempre funcione
    const modalCadastro = document.getElementById('modalCadastroEstoque');
    if (modalCadastro && !modalCadastro._listenersConfigurados) {
      // Marcar como configurado para evitar duplica√ß√£o
      modalCadastro._listenersConfigurados = true;
      
      // Event delegation unificado para todos os eventos
      modalCadastro.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'cadastroIdadeV3') {
          calcularDataNascimentoDeIdade();
        } else if (e.target && e.target.id === 'cadastroRacaV3') {
          validarBotaoConfirmarCadastro();
        }
      }, { passive: true });
      
      // Event delegation para o campo de data
      modalCadastro.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'cadastroDataNascV3') {
          calcularIdadeDeDataNascimento();
        } else if (e.target && (e.target.id === 'cadastroRacaV3' || e.target.id === 'cadastroSexoV3' || e.target.id === 'cadastroIdadeV3')) {
          validarBotaoConfirmarCadastro();
        }
      }, { passive: true });
      
      // Capturar keyup para o campo de idade (debounced)
      let timeoutIdade = null;
      modalCadastro.addEventListener('keyup', function(e) {
        if (e.target && e.target.id === 'cadastroIdadeV3' && e.key !== 'Enter') {
          clearTimeout(timeoutIdade);
          timeoutIdade = setTimeout(() => {
            calcularDataNascimentoDeIdade();
          }, 300);
        }
      }, { passive: true });
    }
    
    // Configurar listeners iniciais apenas uma vez
    if (!window._listenersIniciaisConfigurados) {
      window._listenersIniciaisConfigurados = true;
      configurarIdadeDataNascimento();
    }
    
    // Garantir que o bot√£o de confirmar cadastro tenha o listener correto
    const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
    if (btnConfirmar && !btnConfirmar._listenerAdicionado) {
      btnConfirmar._listenerAdicionado = true;
      // Remover onclick inline e adicionar event listener
      btnConfirmar.removeAttribute('onclick');
      btnConfirmar.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Bot√£o Confirmar Cadastro clicado!');
        if (typeof window.confirmarCadastroEstoqueV3 === 'function') {
          window.confirmarCadastroEstoqueV3();
        } else {
          console.error('‚ùå Fun√ß√£o confirmarCadastroEstoqueV3 n√£o encontrada!');
          mostrarToast('Erro: Fun√ß√£o de cadastro n√£o encontrada. Recarregue a p√°gina.', 'error');
        }
      });
    }
  });

  window.confirmarCadastroEstoqueV3 = async function() {
    console.log('üöÄ confirmarCadastroEstoqueV3 chamada!');
    
    // Verificar se registrarUrl e csrfToken est√£o definidos
    if (!registrarUrl) {
      console.error('‚ùå registrarUrl n√£o est√° definido!');
      mostrarToast('Erro de configura√ß√£o: URL de registro n√£o encontrada.', 'error');
      return;
    }
    
    if (!csrfToken) {
      console.error('‚ùå csrfToken n√£o est√° definido!');
      mostrarToast('Erro de configura√ß√£o: Token CSRF n√£o encontrado.', 'error');
      return;
    }
    
    // Obter brinco de m√∫ltiplas fontes (fallback)
    let brinco = brincoAtualV3;
    if (!brinco) {
      // Tentar obter do elemento do modal
      const brincoSpan = document.getElementById('cadastroBrincoV3');
      if (brincoSpan && brincoSpan.textContent && brincoSpan.textContent.trim() !== '‚Äî') {
        brinco = brincoSpan.textContent.trim();
        // Remover espa√ßos extras que podem aparecer (ex: "105500376195 562" -> "105500376195562")
        brinco = brinco.replace(/\s+/g, '');
      }
    }
    if (!brinco) {
      // Tentar obter do SISBOV como √∫ltimo recurso
      const sisbovSpan = document.getElementById('cadastroSisbovV3');
      if (sisbovSpan && sisbovSpan.textContent && sisbovSpan.textContent.trim() !== '‚Äî') {
        brinco = sisbovSpan.textContent.trim();
      }
    }
    
    const racaCodigo = document.getElementById('cadastroRacaV3')?.value.trim() || '';
    // Converter c√≥digo do select para nome completo da ra√ßa
    const racaMap = {
      'NE': 'Nelore',
      'XX': 'Composto',
      'AN': 'Angus',
      'BR': 'Brahman',
      'CA': 'Canchim',
      'GU': 'Guzer√°',
      'GI': 'Gir',
      'GN': 'Girolando',
      'HO': 'Holand√™s',
      'IN': 'Indubrasil',
      'MA': 'Marchigiana',
      'MO': 'Montana',
      'PO': 'Polled Hereford',
      'PR': 'Pardo Su√≠√ßo',
      'RA': 'Santa Gertrudis',
      'SI': 'Simental',
      'TA': 'Tabapu√£',
      'TR': 'Tricross',
      'ZE': 'Zebu',
      'OT': 'Outra'
    };
    const raca = racaMap[racaCodigo] || racaCodigo;
    
    const sexo = document.getElementById('cadastroSexoV3')?.value || '';
    const idade = document.getElementById('cadastroIdadeV3')?.value.trim() || '';
    const dataNasc = document.getElementById('cadastroDataNascV3')?.value || '';
    const tipoRegistro = document.getElementById('cadastroTipoRegistroV3')?.value || '';
    const rfid = document.getElementById('cadastroRfidV3')?.value.trim() || '';
    const sisbovSpan = document.getElementById('cadastroSisbovV3');
    const numeroSisbov = sisbovSpan && sisbovSpan.textContent && sisbovSpan.textContent.trim() !== '‚Äî' 
      ? sisbovSpan.textContent.trim() 
      : brinco;

    console.log('üîç Dados do cadastro:', { brinco, brincoAtualV3, raca, racaCodigo, sexo, idade, dataNasc, tipoRegistro, rfid, numeroSisbov });
    console.log('üîç URLs:', { registrarUrl, identificarUrl });

    if (!raca || !sexo || (!idade && !dataNasc) || !tipoRegistro) {
      mostrarToast('Preencha todos os campos obrigat√≥rios (Ra√ßa, Sexo, Idade ou Data de Nascimento e Tipo de Registro)', 'warning');
      return;
    }

    if (!brinco) {
      console.error('‚ùå Brinco n√£o encontrado em nenhuma fonte:', { 
        brincoAtualV3, 
        cadastroBrincoV3: document.getElementById('cadastroBrincoV3')?.textContent,
        cadastroSisbovV3: document.getElementById('cadastroSisbovV3')?.textContent
      });
      mostrarToast('Brinco n√£o identificado. Tente novamente.', 'error');
      return;
    }

    mostrarLoading(true);

    const payload = {
      tipo_fluxo: 'estoque',
      manejo: 'CADASTRO_INICIAL',
      codigo: brinco,
      numero_sisbov: numeroSisbov || brinco,
      rfid: rfid || '',
      sexo: sexo,
      raca: raca || '',
      idade: idade || '',
      data_nascimento: dataNasc || '',
      origem_cadastro: tipoRegistro || 'NASCIMENTO',
      tipo_registro: tipoRegistro || 'NASCIMENTO'
    };
    
    console.log('üì§ Payload enviado:', payload);

    try {
      const response = await fetch(registrarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        mostrarLoading(false);
        let errorMessage = 'Erro ao cadastrar animal';
        try {
          const errorData = await response.json();
          errorMessage = errorData.mensagem || errorData.erro || errorMessage;
        } catch (e) {
          errorMessage = `Erro ${response.status}: ${response.statusText}`;
        }
        console.error('Erro HTTP:', response.status, errorMessage);
        mostrarToast(errorMessage, 'error');
        return;
      }

      const data = await response.json();
      console.log('üì• Resposta recebida:', data);
      mostrarLoading(false);

      if (data.status === 'ok') {
        console.log('‚úÖ Cadastro bem-sucedido!', data);
        mostrarToast(data.mensagem || 'Animal cadastrado com sucesso!', 'success');
        
        // IMPORTANTE: Usar o SISBOV completo retornado pelo backend (mais confi√°vel)
        // O SISBOV completo (15 d√≠gitos) √© √∫nico e evita confus√£o com RFID ou n√∫mero de manejo
        let codigoAnimalCadastrado = data.codigo_sisbov || data.numero_brinco || numeroSisbov || brinco;
        
        // Se o backend retornou n√∫mero de manejo, podemos usar para busca tamb√©m
        const numeroManejoCadastrado = data.numero_manejo;
        
        // Se temos SISBOV completo (15 d√≠gitos), usar ele para busca (mais preciso)
        // Se n√£o temos SISBOV completo, usar n√∫mero de manejo (6 d√≠gitos)
        const codigoParaBusca = (codigoAnimalCadastrado && codigoAnimalCadastrado.length === 15) 
          ? codigoAnimalCadastrado 
          : (numeroManejoCadastrado || codigoAnimalCadastrado);
        
        console.log('üìå C√≥digo do animal rec√©m-cadastrado (do backend):', codigoAnimalCadastrado);
        console.log('üìå N√∫mero de manejo (do backend):', numeroManejoCadastrado);
        console.log('üìå C√≥digo para busca (priorizando SISBOV completo):', codigoParaBusca);
        console.log('üìå Dados completos da resposta:', data);
        
        // Limpar vari√°veis antigas para evitar confus√£o
        animalAtualV3 = null;
        brincoAtualV3 = null;
        
        // Armazenar dados do √∫ltimo cadastro para reutilizar
        ultimoCadastroEstoqueV3 = {
          raca: raca,
          sexo: sexo,
          idade: idade,
          data_nascimento: dataNasc,
          rfid: rfid
        };
        
        // Fechar modal imediatamente
        fecharModal('modalCadastroEstoque');
        
        // Aguardar um pouco para o modal fechar completamente
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Buscar o animal rec√©m-cadastrado para preencher o card
        console.log('üîç Buscando animal rec√©m-cadastrado...');
        console.log('üìã Dados da resposta:', data);
        console.log('üîë C√≥digo para buscar:', codigoAnimalCadastrado);
        
        let animalEncontrado = false;
        
        // Limpar vari√°veis antes de buscar para garantir dados frescos
        animalAtualV3 = null;
        brincoAtualV3 = null;
        
        // Atualizar o campo de busca com o c√≥digo correto ANTES de buscar
        // IMPORTANTE: Usar SISBOV completo se dispon√≠vel (15 d√≠gitos) para busca precisa
        // Se n√£o tiver SISBOV completo, usar n√∫mero de manejo (6 d√≠gitos)
        const brincoInput = document.getElementById('brincoInputV3');
        if (brincoInput) {
          // Priorizar SISBOV completo para busca (mais preciso, evita confus√£o)
          // Se n√£o tiver SISBOV completo, usar n√∫mero de manejo
          const codigoParaInput = codigoParaBusca;
          brincoInput.value = codigoParaInput;
          console.log('üìù Campo de busca atualizado com:', codigoParaInput, '(tipo:', codigoParaInput.length === 15 ? 'SISBOV completo' : 'N√∫mero de manejo', ')');
          
          // Simular Enter autom√°tico para for√ßar a busca/identifica√ß√£o
          // Isso garante que o sistema identifique o animal como se o usu√°rio tivesse digitado e pressionado Enter
          await new Promise(resolve => setTimeout(resolve, 100));
          const enterEvent = new KeyboardEvent('keypress', {
            key: 'Enter',
            code: 'Enter',
            keyCode: 13,
            which: 13,
            bubbles: true,
            cancelable: true
          });
          brincoInput.dispatchEvent(enterEvent);
          console.log('‚å®Ô∏è Enter autom√°tico simulado no campo de busca');
        }
        
        // Aguardar um pouco para garantir que o input foi atualizado e o evento processado
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Priorizar busca por ID (mais confi√°vel)
        if (data.animal_id) {
          console.log('üîç Buscando animal por ID:', data.animal_id);
          console.log('üîë Usando c√≥digo para busca:', codigoParaBusca);
          try {
            // Buscar por ID usando o c√≥digo correto (SISBOV completo se dispon√≠vel)
            await buscarAnimalPorId(data.animal_id, codigoParaBusca);
            
            // Verificar se encontrou o animal correto
            if (animalAtualV3 && animalAtualV3.id === data.animal_id) {
              animalEncontrado = true;
              console.log('‚úÖ Animal encontrado por ID e verificado:', animalAtualV3.numero_manejo);
              // Atualizar campo CONFORME BND (animal rec√©m-cadastrado = amarelo)
              atualizarConformeBnd(animalAtualV3, true);
        } else {
              console.warn('‚ö†Ô∏è Animal encontrado mas ID n√£o confere, tentando busca por c√≥digo...');
              animalEncontrado = false; // For√ßar busca por c√≥digo
            }
          } catch (error) {
            console.error('‚ùå Erro ao buscar por ID:', error);
            animalEncontrado = false;
          }
        }
        
        // Se n√£o encontrou por ID ou n√£o retornou ID, buscar pelo c√≥digo
        if (!animalEncontrado) {
          console.log('üîç Buscando animal por c√≥digo:', codigoParaBusca);
          console.log('üìã Tipo de c√≥digo:', codigoParaBusca.length === 15 ? 'SISBOV completo (15 d√≠gitos)' : codigoParaBusca.length === 6 ? 'N√∫mero de manejo (6 d√≠gitos)' : 'Outro');
          try {
            // Limpar vari√°veis novamente antes de buscar
            animalAtualV3 = null;
            brincoAtualV3 = null;
            
            // Garantir que o input est√° com o valor correto
            // IMPORTANTE: Usar SISBOV completo se dispon√≠vel (evita confus√£o com RFID)
            if (brincoInput) {
              brincoInput.value = codigoParaBusca;
              console.log('üìù Campo de busca atualizado para:', codigoParaBusca);
              
              // Simular Enter autom√°tico para garantir que a busca seja executada
              await new Promise(resolve => setTimeout(resolve, 150));
              const enterEvent = new KeyboardEvent('keypress', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                which: 13,
                bubbles: true,
                cancelable: true
              });
              brincoInput.dispatchEvent(enterEvent);
              console.log('‚å®Ô∏è Enter autom√°tico simulado no campo de busca');
              
              // Aguardar um pouco para o evento ser processado
              await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Chamar a fun√ß√£o de busca diretamente tamb√©m (garantir que execute)
            // IMPORTANTE: Passar o SISBOV completo se dispon√≠vel para busca precisa
            await buscarBrincoV3(codigoParaBusca);
            
            // Aguardar um pouco para o processamento
        await new Promise(resolve => setTimeout(resolve, 300));
            
            // Verificar se encontrou o animal correto (comparar n√∫mero de manejo se dispon√≠vel)
            if (animalAtualV3) {
              if (numeroManejoCadastrado && animalAtualV3.numero_manejo) {
                const manejoEncontrado = String(animalAtualV3.numero_manejo).trim();
                const manejoEsperado = String(numeroManejoCadastrado).trim();
                if (manejoEncontrado === manejoEsperado) {
                  animalEncontrado = true;
                  console.log('‚úÖ Animal encontrado por c√≥digo e n√∫mero de manejo confere:', manejoEncontrado);
                } else {
                  console.warn('‚ö†Ô∏è Animal encontrado mas n√∫mero de manejo n√£o confere:', {
                    esperado: manejoEsperado,
                    encontrado: manejoEncontrado
                  });
                  // Tentar buscar novamente com o n√∫mero de manejo diretamente
                  if (brincoInput) {
                    brincoInput.value = manejoEsperado;
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await buscarBrincoV3(manejoEsperado);
                    await new Promise(resolve => setTimeout(resolve, 300));
                  }
                }
              } else {
                animalEncontrado = true;
                console.log('‚úÖ Animal encontrado por c√≥digo');
              }
            }
          } catch (error) {
            console.error('‚ùå Erro ao buscar por c√≥digo:', error);
          }
        }
        
        // Aguardar um tempo para garantir que o card foi atualizado
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Verificar se o card foi preenchido corretamente
        const sisbovEl = document.getElementById('scannerSisbovV3');
        const numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
        const racaEl = document.getElementById('scannerRacaV3');
        
        // Verificar se os campos principais foram preenchidos
        const sisbovPreenchido = sisbovEl && sisbovEl.textContent && sisbovEl.textContent.trim() !== '‚Äî';
        const manejoPreenchido = numeroManejoEl && numeroManejoEl.textContent && numeroManejoEl.textContent.trim() !== '‚Äî';
        const racaPreenchida = racaEl && racaEl.value && racaEl.value.trim() !== '';
        
        const cardPreenchido = sisbovPreenchido && manejoPreenchido;
        
        console.log('üîç Verifica√ß√£o do card:', {
          sisbov: sisbovEl?.textContent,
          numeroManejo: numeroManejoEl?.textContent,
          raca: racaEl?.value,
          cardPreenchido: cardPreenchido
        });
        
        if (cardPreenchido) {
          console.log('‚úÖ Card preenchido com sucesso!');
          console.log('üìã Dados do animal no card:', {
            sisbov: sisbovEl.textContent,
            numeroManejo: numeroManejoEl.textContent,
            raca: racaEl?.value,
            animalAtual: animalAtualV3?.numero_manejo
          });
          atualizarEstatisticas();
        } else {
          console.warn('‚ö†Ô∏è Card n√£o foi preenchido completamente, tentando novamente...');
          // Tentar buscar novamente ap√≥s mais um delay
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Limpar vari√°veis antes de buscar novamente
          animalAtualV3 = null;
          brincoAtualV3 = null;
          
          // Atualizar input com c√≥digo correto
          const brincoInput = document.getElementById('brincoInputV3');
          if (brincoInput) {
            brincoInput.value = codigoAnimalCadastrado;
          }
          
          // Buscar novamente
          if (data.animal_id) {
            console.log('üîÑ Tentando buscar novamente por ID:', data.animal_id);
            await buscarAnimalPorId(data.animal_id, codigoAnimalCadastrado);
          } else {
            console.log('üîÑ Tentando buscar novamente por c√≥digo:', codigoAnimalCadastrado);
            
            // Atualizar input e simular Enter
            if (brincoInput) {
              const codigoParaInput = numeroManejoCadastrado || codigoAnimalCadastrado;
              brincoInput.value = codigoParaInput;
              
              // Simular Enter autom√°tico
              await new Promise(resolve => setTimeout(resolve, 100));
              const enterEvent = new KeyboardEvent('keypress', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                which: 13,
                bubbles: true,
                cancelable: true
              });
              brincoInput.dispatchEvent(enterEvent);
            }
            
            await buscarBrincoV3(codigoAnimalCadastrado);
          }
          
          // Aguardar mais um pouco
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Verificar novamente
          const sisbovEl2 = document.getElementById('scannerSisbovV3');
          const numeroManejoEl2 = document.getElementById('scannerNumeroManejoV3');
          const cardPreenchido2 = sisbovEl2 && sisbovEl2.textContent && sisbovEl2.textContent.trim() !== '‚Äî' &&
                                  numeroManejoEl2 && numeroManejoEl2.textContent && numeroManejoEl2.textContent.trim() !== '‚Äî';
          
          if (cardPreenchido2) {
            console.log('‚úÖ Card preenchido na segunda tentativa!');
            atualizarEstatisticas();
          } else {
            console.error('‚ùå Card ainda n√£o foi preenchido ap√≥s segunda tentativa');
            mostrarToast('Card n√£o foi atualizado. Tente buscar o animal manualmente.', 'warning');
          }
        }
        
        // Focar no campo de pesagem para continuar o fluxo
        // Aguardar um pouco mais para garantir que o card foi renderizado
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const pesoInput = document.getElementById('pesoValorV3');
        if (pesoInput) {
          pesoInput.disabled = false;
          pesoInput.removeAttribute('disabled');
          pesoInput.focus();
          console.log('‚öñÔ∏è Focado no campo de pesagem');
          
          // Scroll suave at√© o campo de pesagem se necess√°rio
          pesoInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          console.error('‚ùå Campo de pesagem n√£o encontrado!');
        }
        
        // N√ÉO buscar pr√≥ximo brinco automaticamente aqui
        // Isso ser√° feito apenas ap√≥s gravar a pesagem
      } else {
        // Mostrar erro detalhado
        const mensagemErro = data.mensagem || data.erro || 'Erro ao cadastrar animal';
        console.error('‚ùå Erro ao cadastrar:', data);
        mostrarToast(mensagemErro, 'error');
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('‚ùå Erro ao cadastrar animal:', error);
      console.error('‚ùå Stack trace:', error.stack);
      const mensagemErro = error.message || 'Erro ao cadastrar animal. Verifique sua conex√£o e tente novamente.';
      mostrarToast(mensagemErro, 'error');
    }
  };
  
  // Garantir que a fun√ß√£o est√° acess√≠vel globalmente
  if (typeof window !== 'undefined') {
    window.confirmarCadastroEstoqueV3 = window.confirmarCadastroEstoqueV3 || confirmarCadastroEstoqueV3;
  }

  // ========== SISTEMA DE MANEJOS ==========
  window.adicionarManejoV3 = function(tipo, titulo, descricao) {
    // Verificar se j√° existe
    if (manejosSelecionadosV3.find(m => m.tipo === tipo)) {
      mostrarToast('Este manejo j√° foi selecionado', 'warning');
      return;
    }

    const manejo = {
      tipo: tipo,
      titulo: titulo,
      descricao: descricao,
      dados: {}
    };

    manejosSelecionadosV3.push(manejo);
    atualizarListaManejosV3();
    mostrarToast(`${titulo} adicionado aos manejos`, 'success');
  };

  window.removerManejoV3 = function(tipo) {
    manejosSelecionadosV3 = manejosSelecionadosV3.filter(m => m.tipo !== tipo);
    atualizarListaManejosV3();
    mostrarToast('Manejo removido', 'info');
  };

  window.limparTodosManejosV3 = function() {
    if (manejosSelecionadosV3.length === 0) return;
    
    if (confirm('Deseja remover todos os manejos selecionados?')) {
      manejosSelecionadosV3 = [];
      atualizarListaManejosV3();
      mostrarToast('Todos os manejos foram removidos', 'info');
    }
  };

  function atualizarListaManejosV3() {
    const listaContainer = document.getElementById('listaManejosV3');
    const emptyState = document.getElementById('emptyStateManejosV3');

    if (manejosSelecionadosV3.length === 0) {
      listaContainer.style.display = 'none';
      emptyState.style.display = 'block';
      document.getElementById('btnFinalizarGravarV3').disabled = !brincoAtualV3;
      return;
    }

    emptyState.style.display = 'none';
    listaContainer.style.display = 'grid';
    listaContainer.innerHTML = '';

    manejosSelecionadosV3.forEach((manejo) => {
      const card = document.createElement('div');
      const classeCss = manejo.tipo.toLowerCase();
      card.className = `manejo-item-card ${classeCss}`;
      card.innerHTML = `
        <div class="manejo-item-info">
          <div class="manejo-item-titulo">${manejo.titulo}</div>
          <div class="manejo-item-desc">${manejo.descricao}</div>
        </div>
        <button class="manejo-item-remove" onclick="removerManejoV3('${manejo.tipo}')" title="Remover manejo">
          <i class="fas fa-times"></i>
        </button>
      `;
      listaContainer.appendChild(card);
    });

    // Habilitar bot√£o finalizar se houver animal e manejos
    if (brincoAtualV3 && (manejosSelecionadosV3.length > 0 || document.getElementById('pesoValorV3').value)) {
      document.getElementById('btnFinalizarGravarV3').disabled = false;
    }
  }

  // ========== ADICIONAR √Ä TABELA ==========
  function adicionarAnimalTabela(animal, peso) {
    const tbody = document.getElementById('tabelaAnimaisV3');
    const table = tbody.closest('table');
    
    // Remover mensagem vazia
    if (tbody.querySelector('td[colspan]')) {
      tbody.innerHTML = '';
    }
    
    // Verificar se o animal j√° est√° na lista (evitar duplicatas)
    const animalJaExiste = animaisRegistrados.some(item => 
      item.animal && animal && (
        (item.animal.id && animal.id && item.animal.id === animal.id) ||
        (item.animal.codigo_sisbov && animal.codigo_sisbov && item.animal.codigo_sisbov === animal.codigo_sisbov) ||
        (item.animal.numero_manejo && animal.numero_manejo && item.animal.numero_manejo === animal.numero_manejo)
      )
    );
    
    if (animalJaExiste) {
      console.log('‚ö†Ô∏è Animal j√° est√° na lista, atualizando peso se fornecido');
      // Atualizar peso do animal existente se fornecido
      const animalExistente = animaisRegistrados.find(item => 
        item.animal && animal && (
          (item.animal.id && animal.id && item.animal.id === animal.id) ||
          (item.animal.codigo_sisbov && animal.codigo_sisbov && item.animal.codigo_sisbov === animal.codigo_sisbov)
        )
      );
      if (animalExistente && peso) {
        animalExistente.peso = peso;
        animalExistente.animal = { ...animalExistente.animal, ...animal }; // Atualizar dados do animal
      }
      // Atualizar estat√≠sticas mesmo se n√£o adicionar novo animal
      atualizarEstatisticasDetalhadas();
      return;
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${animal.numero_brinco || animal.codigo_eletronico || '‚Äî'}</td>
      <td>${animal.codigo_sisbov || '‚Äî'}</td>
      <td>${animal.numero_manejo || '‚Äî'}</td>
      <td>${animal.raca || '‚Äî'} / ${animal.sexo || '‚Äî'}</td>
      <td>${animal.data_nascimento || '‚Äî'}</td>
      <td>${animal.categoria || animal.categoria_nome || '‚Äî'}</td>
      <td>${animal.pasto_lote || animal.pasto_nome || animal.lote_nome || '‚Äî'}</td>
      <td>‚Äî</td>
    `;
    
    // Inserir no in√≠cio (√∫ltimos animais aparecem primeiro)
    tbody.insertBefore(tr, tbody.firstChild);
    
    // Adicionar animal √† lista (mesmo sem peso, conta como trabalhado)
    animaisRegistrados.unshift({ animal, peso: peso || null }); // Adicionar no in√≠cio do array
    
    console.log('‚úÖ Animal adicionado √† tabela:', {
      sisbov: animal.codigo_sisbov,
      manejo: animal.numero_manejo,
      peso: peso || 'sem peso',
      totalAnimais: animaisRegistrados.length
    });
    
    // Aplicar classes de visibilidade (mostrar apenas os 5 primeiros)
    aplicarVisibilidadeAnimais();
    
    // Atualizar estat√≠sticas detalhadas
    atualizarEstatisticasDetalhadas();
  }
  
  // ========== APLICAR VISIBILIDADE DOS ANIMAIS ==========
  function aplicarVisibilidadeAnimais() {
    const tbody = document.getElementById('tabelaAnimaisV3');
    if (!tbody) return;
    
    const table = tbody.closest('table');
    const linhas = Array.from(tbody.querySelectorAll('tr'));
    const estaExpandida = table && table.classList.contains('expandida');
    
    if (!estaExpandida) {
      // Ocultar linhas ap√≥s a 5¬™
      linhas.forEach((linha, index) => {
        if (index >= 5) {
          linha.classList.add('animal-oculto');
        } else {
          linha.classList.remove('animal-oculto');
        }
      });
    } else {
      // Mostrar todas as linhas quando expandida
      linhas.forEach(linha => {
        linha.classList.remove('animal-oculto');
      });
    }
    
    // Atualizar texto do bot√£o
    const btnExpandir = document.getElementById('btnExpandirAnimaisV3');
    const textoExpandir = document.getElementById('textoExpandirAnimaisV3');
    const iconExpandir = document.getElementById('iconExpandirAnimaisV3');
    
    if (btnExpandir && textoExpandir && iconExpandir) {
      const totalAnimais = linhas.length;
      
      if (estaExpandida) {
        textoExpandir.textContent = 'Recolher';
        iconExpandir.className = 'fas fa-chevron-up';
      } else {
        const animaisOcultos = Math.max(0, totalAnimais - 5);
        textoExpandir.textContent = animaisOcultos > 0 ? `Ver mais (${animaisOcultos})` : 'Ver todos';
        iconExpandir.className = 'fas fa-chevron-down';
      }
      
      // Ocultar bot√£o se houver 5 ou menos animais
      if (totalAnimais <= 5) {
        btnExpandir.style.display = 'none';
      } else {
        btnExpandir.style.display = 'flex';
      }
    }
  }
  
  // ========== TOGGLE EXPANDIR/RECOLHER ANIMAIS ==========
  window.toggleExpandirAnimaisV3 = function() {
    const table = document.querySelector('.table-animais');
    if (table) {
      table.classList.toggle('expandida');
      aplicarVisibilidadeAnimais();
    }
  };
  
  // ========== FUN√á√ÉO PARA ATUALIZAR ESTAT√çSTICAS DETALHADAS ==========
  function atualizarEstatisticasDetalhadas() {
    if (!animaisRegistrados || animaisRegistrados.length === 0) {
      // Resetar todos os valores
      document.getElementById('statTrabalhados').textContent = '0';
      document.getElementById('statMachos').textContent = '0';
      document.getElementById('statFemeas').textContent = '0';
      document.getElementById('statCategorias').textContent = '‚Äî';
      document.getElementById('statMediaPeso').textContent = '‚Äî';
      document.getElementById('statTotalPesagens').textContent = '0';
      document.getElementById('statGanhoMedioDia').textContent = '‚Äî';
      document.getElementById('statGanhoPositivo').textContent = '0';
      document.getElementById('statGanhoNegativo').textContent = '0';
      document.getElementById('statTotalManejos').textContent = '0';
      document.getElementById('statDiagnosticoRow').style.display = 'none';
      return;
    }
    
    // Total trabalhados
    const totalTrabalhados = animaisRegistrados.length;
    document.getElementById('statTrabalhados').textContent = totalTrabalhados;
    
    // Por sexo
    let machos = 0;
    let femeas = 0;
    const categorias = {};
    const pesos = [];
    const ganhosDiarios = [];
    let prenhas = 0;
    let vazias = 0;
    let temDiagnostico = false;
    let totalPesagens = 0;
    let ganhoPositivo = 0;
    let ganhoNegativo = 0;
    let totalManejos = 0;
    
    animaisRegistrados.forEach(({ animal, peso }) => {
      // Contar por sexo
      const sexo = String(animal.sexo || '').toUpperCase();
      if (sexo.includes('MACHO') || sexo === 'M') {
        machos++;
      } else if (sexo.includes('F√äMEA') || sexo.includes('FEMEA') || sexo === 'F') {
        femeas++;
      }
      
      // Contar por categoria
      const categoria = animal.categoria_nome || animal.categoria || 'Sem categoria';
      categorias[categoria] = (categorias[categoria] || 0) + 1;
      
      // Coletar pesos e calcular ganhos
      const pesoAtual = peso ? parseFloat(peso) : (animal.peso_atual ? parseFloat(animal.peso_atual) : null);
      
      // Contar pesagens (cada animal com peso registrado = 1 pesagem)
      if (pesoAtual && !isNaN(pesoAtual) && pesoAtual > 0) {
        pesos.push(pesoAtual);
        totalPesagens++;
        totalManejos++; // Cada pesagem √© um manejo
        
        // Calcular ganho di√°rio se houver peso anterior
        // Priorizar peso_anterior, sen√£o usar peso_atual do animal (antes da pesagem atual)
        const pesoAnterior = animal.peso_anterior ? parseFloat(animal.peso_anterior) : 
                           (animal.peso_atual && peso ? parseFloat(animal.peso_atual) : null);
        
        if (pesoAnterior && pesoAnterior > 0 && pesoAtual !== pesoAnterior) {
          const ganhoTotal = pesoAtual - pesoAnterior;
          
          // Calcular dias desde √∫ltima pesagem
          let dias = 30; // Padr√£o 30 dias
          if (animal.data_peso_anterior) {
            try {
              const dataAnterior = new Date(animal.data_peso_anterior);
              const dataAtual = animal.data_peso_atual ? new Date(animal.data_peso_atual) : new Date();
              const diffTime = Math.abs(dataAtual - dataAnterior);
              dias = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            } catch (e) {
              console.warn('Erro ao calcular dias:', e);
            }
          } else if (animal.dias_ultima_pesagem) {
            dias = parseInt(animal.dias_ultima_pesagem) || 30;
          }
          
          if (dias > 0) {
            const ganhoDiario = ganhoTotal / dias;
            ganhosDiarios.push(ganhoDiario);
            
            // Contar ganhos positivos e negativos baseado no ganho TOTAL (n√£o apenas di√°rio)
            // Um animal tem ganho positivo se ganhou peso, negativo se perdeu
            if (ganhoTotal > 0) {
              ganhoPositivo++;
            } else if (ganhoTotal < 0) {
              ganhoNegativo++;
            }
          }
        }
      } else if (animal.peso_atual && !isNaN(parseFloat(animal.peso_atual))) {
        pesos.push(parseFloat(animal.peso_atual));
      }
      
      // Se o animal foi trabalhado mas n√£o tem peso registrado, ainda conta como 1 manejo
      // (pode ter sido trabalhado com outros manejos como vacina√ß√£o, tratamento, etc.)
      if (!pesoAtual && totalTrabalhados > 0) {
        // Verificar se h√° outros manejos registrados para este animal
        if (animal.total_manejos) {
          totalManejos += parseInt(animal.total_manejos) || 0;
        } else {
          // Se n√£o h√° informa√ß√£o de manejos, mas o animal est√° na lista, contar como 1 manejo
          // (pode ter sido trabalhado sem pesagem)
          totalManejos++;
        }
      }
      
      // Contar outros manejos do animal (se houver informa√ß√£o e n√£o foi pesagem)
      if (animal.total_manejos && !pesoAtual) {
        const outrosManejos = parseInt(animal.total_manejos) || 0;
        if (outrosManejos > 0) {
          totalManejos += outrosManejos;
        }
      }
      
      // Verificar diagn√≥stico reprodutivo
      // Procurar em manejos ou dados do animal
      if (animal.diagnostico_reprodutivo || animal.diagnostico) {
        temDiagnostico = true;
        const diagnostico = String(animal.diagnostico_reprodutivo || animal.diagnostico || '').toUpperCase();
        if (diagnostico.includes('PRENHA') || diagnostico.includes('PREGNANT') || diagnostico.includes('GESTANTE')) {
          prenhas++;
        } else if (diagnostico.includes('VAZIA') || diagnostico.includes('VAZIO')) {
          vazias++;
        }
      }
    });
    
    // Contar manejos selecionados tamb√©m (manejos pendentes de registro)
    if (manejosSelecionadosV3 && manejosSelecionadosV3.length > 0) {
      totalManejos += manejosSelecionadosV3.length;
    }
    
    // IMPORTANTE: Total de Manejos deve ser pelo menos igual ao Total de Pesagens
    // Cada pesagem √© um manejo, ent√£o se houver pesagens, deve haver pelo menos esse n√∫mero de manejos
    // O total de manejos √© a soma de: pesagens + manejos selecionados + outros manejos do animal
    // Se n√£o houver manejos contados mas houver pesagens, usar pesagens como base
    if (totalManejos === 0 && totalPesagens > 0) {
      totalManejos = totalPesagens;
    } else if (totalPesagens > 0 && totalManejos < totalPesagens) {
      // Se totalManejos for menor que totalPesagens, ajustar para garantir que pesagens sejam contadas
      totalManejos = totalPesagens;
    }
    
    // Garantir que totalManejos nunca seja menor que o n√∫mero de animais trabalhados
    // Cada animal trabalhado tem pelo menos 1 manejo (a pesagem ou outro manejo)
    if (totalTrabalhados > 0 && totalManejos < totalTrabalhados) {
      totalManejos = totalTrabalhados;
    }
    
    console.log('üìä Estat√≠sticas calculadas:', {
      totalPesagens,
      totalManejos,
      ganhosDiarios: ganhosDiarios.length,
      ganhoPositivo,
      ganhoNegativo
    });
    
    // Atualizar contadores de sexo
    document.getElementById('statMachos').textContent = machos;
    document.getElementById('statFemeas').textContent = femeas;
    
    // Atualizar categorias (mostrar as 3 mais comuns)
    const categoriasOrdenadas = Object.entries(categorias)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);
    
    if (categoriasOrdenadas.length > 0) {
      const categoriasTexto = categoriasOrdenadas
        .map(([cat, qtd]) => `${cat}: ${qtd}`)
        .join(', ');
      document.getElementById('statCategorias').textContent = categoriasTexto;
    } else {
      document.getElementById('statCategorias').textContent = '‚Äî';
    }
    
    // Calcular m√©dia de peso
    if (pesos.length > 0) {
      const somaPesos = pesos.reduce((acc, p) => acc + p, 0);
      const mediaPeso = somaPesos / pesos.length;
      document.getElementById('statMediaPeso').textContent = `${mediaPeso.toFixed(1).replace('.', ',')} kg`;
    } else {
      document.getElementById('statMediaPeso').textContent = '‚Äî';
    }
    
    // Atualizar total de pesagens
    document.getElementById('statTotalPesagens').textContent = totalPesagens;
    
    // Calcular ganho m√©dio di√°rio
    if (ganhosDiarios.length > 0) {
      const somaGanhos = ganhosDiarios.reduce((acc, g) => acc + g, 0);
      const ganhoMedio = somaGanhos / ganhosDiarios.length;
      document.getElementById('statGanhoMedioDia').textContent = `${ganhoMedio > 0 ? '+' : ''}${ganhoMedio.toFixed(2).replace('.', ',')} kg/dia`;
    } else {
      document.getElementById('statGanhoMedioDia').textContent = '‚Äî';
    }
    
    // Atualizar ganhos positivos e negativos
    document.getElementById('statGanhoPositivo').textContent = ganhoPositivo;
    document.getElementById('statGanhoNegativo').textContent = ganhoNegativo;
    
    // Atualizar total de manejos
    document.getElementById('statTotalManejos').textContent = totalManejos;
    
    // Atualizar diagn√≥stico reprodutivo
    if (temDiagnostico || prenhas > 0 || vazias > 0) {
      document.getElementById('statDiagnosticoRow').style.display = 'table-row';
      document.getElementById('statPrenhasRow').style.display = 'table-row';
      document.getElementById('statVaziasRow').style.display = 'table-row';
      
      const totalDiagnostico = prenhas + vazias;
      document.getElementById('statDiagnostico').textContent = totalDiagnostico > 0 ? `${totalDiagnostico} animais` : '‚Äî';
      document.getElementById('statPrenhas').textContent = prenhas;
      document.getElementById('statVazias').textContent = vazias;
    } else {
      document.getElementById('statDiagnosticoRow').style.display = 'none';
      document.getElementById('statPrenhasRow').style.display = 'none';
      document.getElementById('statVaziasRow').style.display = 'none';
    }
    
    console.log('üìä Estat√≠sticas detalhadas atualizadas:', {
      totalTrabalhados,
      machos,
      femeas,
      categorias,
      mediaPeso: pesos.length > 0 ? (pesos.reduce((a, b) => a + b, 0) / pesos.length).toFixed(1) : 'N/A',
      totalPesagens,
      ganhoMedio: ganhosDiarios.length > 0 ? (ganhosDiarios.reduce((a, b) => a + b, 0) / ganhosDiarios.length).toFixed(2) : 'N/A',
      ganhoPositivo,
      ganhoNegativo,
      totalManejos,
      prenhas,
      vazias
    });
  }
  
  // Tornar fun√ß√£o global
  window.atualizarEstatisticasDetalhadas = atualizarEstatisticasDetalhadas;
  
  // ========== ATUALIZAR CAMPO CONFORME BND ==========
  function atualizarConformeBnd(dadosAnimal, foiCadastradoAgora) {
    const conformeBndEl = document.getElementById('scannerConformeBndV3');
    if (!conformeBndEl) return;
    
    if (foiCadastradoAgora) {
      // Animal rec√©m-cadastrado = amarelo
      conformeBndEl.textContent = 'CONFORME BND';
      conformeBndEl.style.backgroundColor = '#FFC107';
      conformeBndEl.style.color = '#000000';
      conformeBndEl.style.border = '2px solid #FFA000';
    } else {
      // Animal j√° cadastrado = verde
      conformeBndEl.textContent = 'CONFORME BND';
      conformeBndEl.style.backgroundColor = '#4CAF50';
      conformeBndEl.style.color = '#FFFFFF';
      conformeBndEl.style.border = '2px solid #388E3C';
    }
  }
  
  window.atualizarConformeBnd = atualizarConformeBnd;

  // ========== SISTEMA DE MANEJOS ==========
  window.adicionarManejoV3 = function(tipo, titulo, descricao) {
    // Verificar se j√° existe
    if (manejosSelecionadosV3.find(m => m.tipo === tipo)) {
      mostrarToast('Este manejo j√° foi selecionado', 'warning');
      return;
    }

    const manejo = {
      tipo: tipo,
      titulo: titulo,
      descricao: descricao,
      dados: {}
    };

    manejosSelecionadosV3.push(manejo);
    atualizarListaManejosV3();
    mostrarToast(`${titulo} adicionado aos manejos`, 'success');
  };

  window.removerManejoV3 = function(tipo) {
    manejosSelecionadosV3 = manejosSelecionadosV3.filter(m => m.tipo !== tipo);
    atualizarListaManejosV3();
    mostrarToast('Manejo removido', 'info');
  };

  window.limparTodosManejosV3 = function() {
    if (manejosSelecionadosV3.length === 0) return;
    
    if (confirm('Deseja remover todos os manejos selecionados?')) {
      manejosSelecionadosV3 = [];
      atualizarListaManejosV3();
      mostrarToast('Todos os manejos foram removidos', 'info');
    }
  };

  function atualizarListaManejosV3() {
    const listaContainer = document.getElementById('listaManejosV3');
    const emptyState = document.getElementById('emptyStateManejosV3');

    if (manejosSelecionadosV3.length === 0) {
      listaContainer.style.display = 'none';
      emptyState.style.display = 'block';
      if (!brincoAtualV3) {
        document.getElementById('btnFinalizarGravarV3').disabled = true;
      }
      return;
    }

    emptyState.style.display = 'none';
    listaContainer.style.display = 'grid';
    listaContainer.innerHTML = '';

    manejosSelecionadosV3.forEach((manejo) => {
      const card = document.createElement('div');
      const classeCss = manejo.tipo.toLowerCase();
      card.className = `manejo-item-card ${classeCss}`;
      card.innerHTML = `
        <div class="manejo-item-info">
          <div class="manejo-item-titulo">${manejo.titulo}</div>
          <div class="manejo-item-desc">${manejo.descricao}</div>
        </div>
        <button class="manejo-item-remove" onclick="removerManejoV3('${manejo.tipo}')" title="Remover manejo">
          <i class="fas fa-times"></i>
        </button>
      `;
      listaContainer.appendChild(card);
    });

    // Habilitar bot√£o finalizar se houver animal e manejos
    if (brincoAtualV3 && (manejosSelecionadosV3.length > 0 || document.getElementById('pesoValorV3').value)) {
      document.getElementById('btnFinalizarGravarV3').disabled = false;
    }
  }

  // ========== ESTAT√çSTICAS ==========
  async function atualizarEstatisticas() {
    try {
      const response = await fetch(statsUrl, {
        headers: { 
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'ok') {
          document.getElementById('statTotalAnimais').textContent = data.total_animais || 0;
        }
      }
    } catch (error) {
      console.error('Erro ao atualizar estat√≠sticas:', error);
    }
    
    // Sempre atualizar estat√≠sticas detalhadas tamb√©m
    if (typeof atualizarEstatisticasDetalhadas === 'function') {
      atualizarEstatisticasDetalhadas();
    }
  }

  // ========== CRIAR SESS√ÉO ==========
  window.criarSessaoV3 = async function(nome, tipoTrabalho, quantidadeEsperada, nomeLote, descricao) {
    console.log('üîµ Iniciando cria√ß√£o de sess√£o...');
    console.log('URL criar sess√£o:', criarSessaoUrl);
    
    if (!criarSessaoUrl) {
      mostrarToast('Erro: URL de cria√ß√£o de sess√£o n√£o configurada. Recarregue a p√°gina.', 'error');
      console.error('‚ùå criarSessaoUrl n√£o est√° definida');
      return false;
    }
    
    mostrarLoading(true);
    
    try {
      // Verificar se j√° existe sess√£o ativa (opcional, n√£o bloqueia se der erro)
      try {
        if (statsSessaoUrl) {
          const statsResponse = await fetch(statsSessaoUrl, {
            method: 'GET',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          if (statsResponse.ok) {
            const statsData = await statsResponse.json();
            if (statsData.status === 'ok' && statsData.stats && statsData.stats.sessao_ativa) {
              mostrarLoading(false);
              mostrarToast('J√° existe uma sess√£o ativa. Encerre a sess√£o atual antes de criar uma nova.', 'info');
              return false;
            }
          }
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Erro ao verificar sess√£o ativa (continuando...):', e);
      }
      
      // Preparar dados da sess√£o
      const dadosSessao = {
        nome: nome || `Trabalho - ${new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`,
        tipo_trabalho: tipoTrabalho || 'COLETA_DADOS',
        quantidade_esperada: quantidadeEsperada || null,
        nome_lote: nomeLote || null,
        descricao: descricao || null
      };
      
      console.log('üì§ Enviando dados:', dadosSessao);
      
      // Criar nova sess√£o
      const response = await fetch(criarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(dadosSessao)
      });
      
      console.log('üì• Resposta recebida. Status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Erro na resposta:', errorText);
        mostrarLoading(false);
        mostrarToast(`Erro ao criar sess√£o (${response.status}): ${errorText.substring(0, 100)}`, 'error');
        return false;
      }
      
      const data = await response.json();
      console.log('üìä Dados recebidos:', data);
      mostrarLoading(false);
      
      if (data.status === 'ok') {
        mostrarToast(data.mensagem || 'Sess√£o criada com sucesso!', 'success');
        
        // Atualizar UI da sess√£o ap√≥s um pequeno delay
        setTimeout(async () => {
          await atualizarEstatisticasSessao();
        }, 500);
        
        return true;
      } else {
        const mensagemErro = data.mensagem || 'Erro ao criar sess√£o';
        console.error('‚ùå Erro:', mensagemErro);
        mostrarToast(mensagemErro, 'error');
        return false;
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('‚ùå Erro ao criar sess√£o:', error);
      console.error('Stack:', error.stack);
      mostrarToast(`Erro ao criar sess√£o: ${error.message}`, 'error');
      return false;
    }
  };

  // ========== ABRIR MODAL PARA CRIAR SESS√ÉO ==========
  window.abrirModalCriarSessao = function() {
    // Verificar se a URL est√° configurada
    if (!criarSessaoUrl || criarSessaoUrl === '' || criarSessaoUrl === 'None') {
      mostrarToast('Erro: Sistema de sess√£o n√£o configurado. Recarregue a p√°gina.', 'error');
      console.error('‚ùå criarSessaoUrl n√£o est√° definida:', criarSessaoUrl);
      return;
    }
    
    // Verificar se o CSRF token est√° dispon√≠vel
    if (!csrfToken || csrfToken === '') {
      mostrarToast('Erro: Token de seguran√ßa n√£o encontrado. Recarregue a p√°gina.', 'error');
      console.error('‚ùå csrfToken n√£o est√° definido');
      return;
    }
    
    // Vers√£o simplificada: criar sess√£o diretamente com valores padr√£o
    // Ou perguntar apenas o nome
    const nome = prompt('Nome da sess√£o (ou deixe em branco para nome autom√°tico):\n\nExemplo: "Pesagem - Desmama"');
    if (nome === null) return; // Usu√°rio cancelou
    
    // Criar sess√£o com valores padr√£o
    criarSessaoV3(
      nome || null,  // Nome (ou null para autom√°tico)
      'COLETA_DADOS', // Tipo padr√£o
      null,           // Quantidade esperada
      null,           // Nome do lote
      null            // Descri√ß√£o
    );
  };

  // ========== ENCERRAR SESS√ÉO ==========
  window.encerrarSessaoV3 = async function() {
    if (!confirm('Deseja realmente encerrar a sess√£o?')) {
      return;
    }
    
    mostrarLoading(true);
    
    try {
      const response = await fetch(encerrarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({})
      });
      
      const data = await response.json();
      mostrarLoading(false);
      
      if (data.status === 'ok') {
        mostrarToast(data.mensagem || 'Sess√£o encerrada com sucesso!', 'success');
        
        // Atualizar UI da sess√£o
        atualizarUISessao(false, null);
        
        // Se houver URL de relat√≥rio de sa√≠das, mostrar op√ß√£o
        if (data.relatorio_saidas_url) {
          setTimeout(() => {
            if (confirm('Deseja visualizar o relat√≥rio de sa√≠das?')) {
              window.location.href = data.relatorio_saidas_url;
            }
          }, 1000);
        } else {
          // Recarregar p√°gina ap√≥s 2 segundos para atualizar estat√≠sticas
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      } else {
        mostrarToast(data.mensagem || 'Erro ao encerrar sess√£o', 'error');
      }
    } catch (error) {
      mostrarLoading(false);
      console.error('Erro ao encerrar sess√£o:', error);
      mostrarToast('Erro ao encerrar sess√£o. Tente novamente.', 'error');
    }
  };
  
  // ========== ATUALIZAR UI DA SESS√ÉO ==========
  function atualizarUISessao(sessaoAtiva, stats) {
    const sessaoNomeEl = document.getElementById('sessaoAtivaNomeV3');
    const sessaoStatsEl = document.getElementById('sessaoAtivaStatsV3');
    const sessaoEventosEl = document.getElementById('sessaoStatEventosV3');
    const sessaoAnimaisEl = document.getElementById('sessaoStatAnimaisV3');
    const sessaoPesagensEl = document.getElementById('sessaoStatPesagensV3');
    const btnEncerrar = document.querySelector('.btn-encerrar');
    const btnCriarSessao = document.querySelector('.btn-criar-sessao');
    const linha2 = document.querySelector('.sessao-ativa-linha2');
    
    if (!sessaoAtiva || !stats) {
      if (sessaoNomeEl) sessaoNomeEl.textContent = 'Nenhuma sess√£o ativa';
      if (sessaoStatsEl) sessaoStatsEl.style.display = 'none';
      if (btnEncerrar && linha2) linha2.style.display = 'none';
      if (btnCriarSessao && linha2) linha2.style.display = 'flex';
      return;
    }
    
    if (sessaoNomeEl) {
      sessaoNomeEl.textContent = stats.sessao_nome || stats.nome || 'Sess√£o Ativa';
    }
    
    if (sessaoStatsEl) sessaoStatsEl.style.display = 'flex';
    if (sessaoEventosEl) sessaoEventosEl.textContent = stats.total_eventos || 0;
    if (sessaoAnimaisEl) sessaoAnimaisEl.textContent = stats.animais_processados || 0;
    if (sessaoPesagensEl) sessaoPesagensEl.textContent = stats.pesagens || 0;
    
    if (btnEncerrar && linha2) {
      linha2.style.display = 'flex';
      if (btnCriarSessao) btnCriarSessao.style.display = 'none';
      if (btnEncerrar) btnEncerrar.style.display = 'flex';
    }
  }
  
  // ========== ATUALIZAR ESTAT√çSTICAS DA SESS√ÉO ==========
  async function atualizarEstatisticasSessao() {
    if (!statsSessaoUrl) return;
    
    try {
      const response = await fetch(statsSessaoUrl, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'ok' && data.stats) {
          atualizarUISessao(data.stats.sessao_ativa, data.stats);
        }
      }
    } catch (error) {
      console.error('Erro ao atualizar estat√≠sticas da sess√£o:', error);
    }
  }

  // Fechar modal ao clicar fora
  document.querySelectorAll('.modal-v3-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('show');
      }
    });
  });

  // Vari√°vel para armazenar intervalo de atualiza√ß√£o da sess√£o
  let intervaloSessao = null;
  
  // Inicializar
  document.addEventListener('DOMContentLoaded', function() {
    atualizarEstatisticas();
    atualizarEstatisticasSessao();
    
    // Limpar intervalos anteriores se existirem
    if (intervaloEstatisticas) {
      clearInterval(intervaloEstatisticas);
    }
    if (intervaloSessao) {
      clearInterval(intervaloSessao);
    }
    
    // Criar novos intervalos
    intervaloEstatisticas = setInterval(atualizarEstatisticas, 30000);
    intervaloSessao = setInterval(atualizarEstatisticasSessao, 15000); // Atualizar sess√£o a cada 15 segundos
    
    // Configurar event listener para atualiza√ß√£o em tempo real do gauge
    const pesoInput = document.getElementById('pesoValorV3');
    if (pesoInput && !pesoInput._gaugeListenerAdicionado) {
      pesoInput._gaugeListenerAdicionado = true;
      
      // Debounce para evitar m√∫ltiplas execu√ß√µes
      let timeoutPeso = null;
      const handlerPeso = function() {
        clearTimeout(timeoutPeso);
        timeoutPeso = setTimeout(calcularEficienciaEmTempoReal, 200);
      };
      
      // Atualizar gauge em tempo real quando o peso √© digitado
      pesoInput.addEventListener('input', handlerPeso, { passive: true });
      pesoInput.addEventListener('keyup', handlerPeso, { passive: true });
      
      console.log('‚úÖ Event listeners configurados para atualiza√ß√£o em tempo real do gauge');
    }
    
    // Aplicar visibilidade inicial dos animais
    aplicarVisibilidadeAnimais();
  });

  window.fecharModal = fecharModal;
  window.mostrarToast = mostrarToast;
  window.mostrarLoading = mostrarLoading;

  // Limpar recursos quando a p√°gina for fechada
  window.addEventListener('beforeunload', function() {
    if (intervaloEstatisticas) {
      clearInterval(intervaloEstatisticas);
      intervaloEstatisticas = null;
    }
    if (intervaloSessao) {
      clearInterval(intervaloSessao);
      intervaloSessao = null;
    }
  });

  // Limpar recursos quando a p√°gina ficar oculta
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      // Pausar atualiza√ß√µes quando a p√°gina estiver oculta
      if (intervaloEstatisticas) {
        clearInterval(intervaloEstatisticas);
        intervaloEstatisticas = null;
      }
      if (intervaloSessao) {
        clearInterval(intervaloSessao);
        intervaloSessao = null;
      }
    } else {
      // Retomar atualiza√ß√µes quando a p√°gina voltar a ficar vis√≠vel
      if (!intervaloEstatisticas) {
        atualizarEstatisticas();
        intervaloEstatisticas = setInterval(atualizarEstatisticas, 30000);
      }
      if (!intervaloSessao) {
        atualizarEstatisticasSessao();
        intervaloSessao = setInterval(atualizarEstatisticasSessao, 15000);
      }
    }
  });

  console.log('‚úÖ Curral Inteligente 3.0 carregado!');
  
  // Marcar sistema como inicializado
  try {
    window.diagnosticoSistema.inicializado = true;
    console.log('‚úÖ Sistema de diagn√≥stico inicializado');
  } catch (error) {
    console.error('‚ùå Erro ao inicializar sistema de diagn√≥stico:', error);
  }

  // ========== SIMULADOR DE PESAGEM E IDENTIFICA√á√ÉO ==========
  let simuladorAtivo = false;
  let simuladorRelatorio = {
    fase: 'INICIO', // INICIO, CADASTRO_BRINCOS, PROCESSAMENTO_ANIMAIS, FINALIZADO
    brincosCadastrados: 0,
    brincosComErro: 0,
    animaisProcessados: 0,
    animaisComErro: 0,
    operacoes: [], // Array de todas as opera√ß√µes realizadas
    erros: [],
    inicio: null,
    fim: null
  };

  // Fun√ß√£o para exibir mensagem explicativa na tela
  function exibirMensagemSimulador(mensagem, tipo = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-v3 toast-v3-${tipo} show`;
    toast.style.position = 'fixed';
    toast.style.top = '80px';
    toast.style.right = '24px';
    toast.style.zIndex = '10003';
    toast.style.maxWidth = '400px';
    toast.innerHTML = `
      <i class="fas fa-${tipo === 'info' ? 'info-circle' : tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}" style="font-size: 1.2rem;"></i>
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 4px;">Simulador</div>
        <div style="font-size: 0.875rem;">${mensagem}</div>
      </div>
    `;
    document.body.appendChild(toast);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
      toast.style.transition = 'transform 0.3s';
      toast.style.transform = 'translateX(400px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Fun√ß√£o para adicionar opera√ß√£o ao log
  function adicionarLogOperacao(operacao, status, detalhes = {}) {
    const logEntry = {
      timestamp: new Date().toISOString(),
      operacao: operacao,
      status: status, // 'OK', 'ERRO', 'INFO'
      detalhes: detalhes
    };
    simuladorRelatorio.operacoes.push(logEntry);
    console.log(`[${status}] ${operacao}:`, detalhes);
  }

  // Fun√ß√£o para aguardar (simular velocidade humana)
  function aguardar(min = 500, max = 1500) {
    const tempo = Math.floor(Math.random() * (max - min + 1)) + min;
    return new Promise(resolve => setTimeout(resolve, tempo));
  }

  // Fun√ß√£o para simular digita√ß√£o humana
  async function simularDigitacao(elemento, texto, velocidade = 100) {
    if (!elemento) return;
    elemento.value = '';
    elemento.focus();
    
    for (let i = 0; i < texto.length; i++) {
      elemento.value += texto[i];
      elemento.dispatchEvent(new Event('input', { bubbles: true }));
      await new Promise(resolve => setTimeout(resolve, velocidade + Math.random() * 50));
    }
    
    elemento.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // Fun√ß√£o para gerar n√∫mero de estoque
  // Gera um SISBOV v√°lido (15 d√≠gitos) com o n√∫mero de manejo nas posi√ß√µes 8-13
  function gerarNumeroEstoque(inicio, index) {
    const numeroManejo = inicio + index; // N√∫mero de manejo (ex: 619700, 619701, etc)
    const manejoStr = String(numeroManejo).padStart(6, '0'); // Garante 6 d√≠gitos
    
    // Formato SISBOV: 8 d√≠gitos prefixo + 6 d√≠gitos manejo + 1 d√≠gito verificador
    // Usando prefixo padr√£o brasileiro: 10550037 (exemplo comum)
    const prefixo = '10550037'; // 8 d√≠gitos prefixo
    const verificador = Math.floor(Math.random() * 10); // D√≠gito verificador aleat√≥rio (0-9)
    
    // SISBOV completo: prefixo (8) + manejo (6) + verificador (1) = 15 d√≠gitos
    const sisbov = prefixo + manejoStr + String(verificador);
    
    return sisbov;
  }
  
  // Fun√ß√£o para extrair n√∫mero de manejo do SISBOV (para uso em busca)
  function extrairNumeroManejo(sisbov) {
    if (sisbov.length === 15) {
      return sisbov.substring(8, 14); // Posi√ß√µes 8-13 (6 d√≠gitos)
    }
    return sisbov;
  }

  // Fun√ß√£o para gerar peso aleat√≥rio baseado no sexo
  function gerarPeso(sexo) {
    if (sexo === 'F') {
      // F√™meas: 185 a 210 kg
      return (185 + Math.random() * 25).toFixed(1);
    } else {
      // Machos: 195 a 220 kg
      return (195 + Math.random() * 25).toFixed(1);
    }
  }

  // Fun√ß√£o para gerar sexo aleat√≥rio
  function gerarSexo() {
    return Math.random() < 0.5 ? 'F' : 'M';
  }

  // Fun√ß√£o para criar sess√£o de pesagem
  async function criarSessaoPesagem() {
    exibirMensagemSimulador('Criando sess√£o de pesagem...', 'info');
    
    try {
      // Verificar se j√° existe sess√£o ativa
      const statsResponse = await fetch(statsSessaoUrl, {
        method: 'GET',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const statsData = await statsResponse.json();
      if (statsData.sessao_ativa) {
        exibirMensagemSimulador('Usando sess√£o ativa existente', 'info');
        return true;
      }
      
      const response = await fetch(criarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          nome: `Pesagem - Desmama - ${new Date().toLocaleString('pt-BR')}`,
          tipo_trabalho: 'PESAGEM_ROTINA',
          quantidade_esperada: 195,
          nome_lote: 'Desmama',
          descricao: 'Simula√ß√£o de pesagem e identifica√ß√£o de animais na desmama'
        })
      });

      const data = await response.json();
      if (data.status === 'ok' || response.ok) {
        exibirMensagemSimulador('Sess√£o de pesagem criada com sucesso!', 'success');
        return true;
      } else {
        exibirMensagemSimulador('Erro ao criar sess√£o: ' + (data.mensagem || 'Erro desconhecido'), 'error');
        simuladorRelatorio.erros.push({
          tipo: 'Cria√ß√£o de Sess√£o',
          mensagem: data.mensagem || 'Erro desconhecido',
          timestamp: new Date().toISOString()
        });
        return false;
      }
    } catch (error) {
      exibirMensagemSimulador('Erro ao criar sess√£o: ' + error.message, 'error');
      simuladorRelatorio.erros.push({
        tipo: 'Cria√ß√£o de Sess√£o',
        mensagem: error.message,
        timestamp: new Date().toISOString()
      });
      return false;
    }
  }

  // Fun√ß√£o para cadastrar um brinco do estoque
  async function processarCadastroBrinco(brinco, index, total) {
    const numeroBrinco = brinco.numero_brinco || brinco.codigo_sisbov || '';
    const codigoRfid = brinco.codigo_rfid || gerarNumeroChip();
    
    // Gerar dados aleat√≥rios
    const sexo = gerarSexo();
    const peso = gerarPeso(sexo);
    const racasDisponiveis = [
      { nome: 'Nelore', codigo: 'NE' },
      { nome: 'Composto', codigo: 'XX' }
    ];
    const racaSelecionada = racasDisponiveis[Math.floor(Math.random() * racasDisponiveis.length)];
    const racaCodigo = racaSelecionada.codigo;
    
    // 1. Leitura do brinco
    exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Lendo brinco ${numeroBrinco}...`, 'info');
    await aguardar(800, 1500);
    
    const brincoInput = document.getElementById('brincoInputV3');
    if (!brincoInput) {
      throw new Error('Campo de brinco n√£o encontrado');
    }
    
    brincoInput.value = '';
    // N√£o focar no input para evitar desfoque da tela
    await aguardar(200, 400);
    
    await simularDigitacao(brincoInput, numeroBrinco, 80);
    await aguardar(500, 1000);
    
    // Remover foco do input ap√≥s digitar
    if (brincoInput === document.activeElement) {
      brincoInput.blur();
    }
    
    // Buscar brinco
    exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Buscando brinco no sistema...`, 'info');
    if (typeof window.buscarBrincoV3 === 'function') {
      await window.buscarBrincoV3(numeroBrinco);
    } else {
      const btnBuscar = document.querySelector('button[onclick="buscarBrincoV3()"]');
      if (btnBuscar) btnBuscar.click();
    }
    
    await aguardar(2000, 3000);
    
    // Verificar se precisa cadastrar
    let numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
    let animalEncontrado = (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '');
    
    if (!animalEncontrado) {
      await aguardar(1000, 2000);
      numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
      animalEncontrado = (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '');
    }
    
    if (!animalEncontrado) {
      // Abrir modal de cadastro
      const modalCadastro = document.getElementById('modalCadastroEstoque');
      if (!modalCadastro) {
        throw new Error('Modal de cadastro n√£o encontrado');
      }
      
      if (!modalCadastro.classList.contains('show')) {
        modalCadastro.classList.add('show');
        await aguardar(800, 1500);
      }
      
      // Preencher dados
      exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Preenchendo dados (Ra√ßa: ${racaSelecionada.nome}, Sexo: ${sexo === 'F' ? 'F√™mea' : 'Macho'})...`, 'info');
      await aguardar(500, 1000);
      
      const rfidInput = document.getElementById('cadastroRfidV3');
      const racaInput = document.getElementById('cadastroRacaV3');
      const sexoInput = document.getElementById('cadastroSexoV3');
      const idadeInput = document.getElementById('cadastroIdadeV3');
      const tipoRegistroInput = document.getElementById('cadastroTipoRegistroV3');
      
      if (rfidInput) {
        rfidInput.value = codigoRfid;
        rfidInput.dispatchEvent(new Event('input', { bubbles: true }));
        await aguardar(200, 400);
      }
      
      if (racaInput) {
        racaInput.value = racaCodigo;
        racaInput.dispatchEvent(new Event('change', { bubbles: true }));
        await aguardar(200, 400);
      }
      
      if (sexoInput) {
        sexoInput.value = sexo;
        sexoInput.dispatchEvent(new Event('change', { bubbles: true }));
        await aguardar(200, 400);
      }
      
      if (idadeInput) {
        const idade = Math.floor(Math.random() * 12) + 6;
        idadeInput.value = String(idade);
        idadeInput.dispatchEvent(new Event('input', { bubbles: true }));
        await aguardar(500, 800);
      }
      
      if (tipoRegistroInput) {
        tipoRegistroInput.value = 'DESMAMA';
        tipoRegistroInput.dispatchEvent(new Event('change', { bubbles: true }));
        await aguardar(200, 400);
      }
      
      // Confirmar cadastro
      exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Confirmando cadastro...`, 'info');
      const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
      if (btnConfirmar) {
        btnConfirmar.click();
        await aguardar(2000, 3000);
      }
      
      // Fechar modal - garantir que fecha completamente
      if (modalCadastro.classList.contains('show')) {
        modalCadastro.classList.remove('show');
        await aguardar(500, 1000);
      }
      
      // Tentar fechar modal de outras formas se ainda estiver aberto
      const modalOverlay = modalCadastro.closest('.modal-v3-overlay');
      if (modalOverlay && modalOverlay.classList.contains('show')) {
        modalOverlay.classList.remove('show');
        await aguardar(300, 600);
      }
      
      // Chamar fun√ß√£o de fechar modal se existir
      if (typeof window.fecharModal === 'function') {
        window.fecharModal('modalCadastroEstoque');
        await aguardar(300, 600);
      }
      
      // Remover foco de qualquer elemento do modal para manter tela n√≠tida
      const elementosModal = modalCadastro.querySelectorAll('input, select, button, textarea');
      elementosModal.forEach(el => {
        if (el === document.activeElement && el.blur) {
          el.blur();
        }
      });
      
      // Garantir que o body recebe foco para manter tela n√≠tida
      document.body.focus();
      await aguardar(200, 400);
      
      // Buscar novamente para atualizar o card com os dados do animal
      exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Atualizando card do animal...`, 'info');
      if (typeof window.buscarBrincoV3 === 'function') {
        await window.buscarBrincoV3(numeroBrinco);
        await aguardar(2000, 3000);
      }
      
      // Verificar se o card foi atualizado (animal encontrado)
      let numeroManejoElCard = document.getElementById('scannerNumeroManejoV3');
      let animalEncontradoCard = (numeroManejoElCard && numeroManejoElCard.textContent !== '‚Äî' && numeroManejoElCard.textContent.trim() !== '');
      
      if (!animalEncontradoCard) {
        await aguardar(1000, 2000);
        numeroManejoElCard = document.getElementById('scannerNumeroManejoV3');
        animalEncontradoCard = (numeroManejoElCard && numeroManejoElCard.textContent !== '‚Äî' && numeroManejoElCard.textContent.trim() !== '');
      }
      
      // Se animal foi encontrado no card, fazer pesagem e manejo imediatamente
      if (animalEncontradoCard) {
        exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Animal cadastrado! Fazendo pesagem e manejo...`, 'success');
        await processarPesagemEManejo(brinco, index, total);
        
        // Atualizar indicadores ap√≥s cadastro e pesagem
        if (typeof atualizarEstatisticas === 'function') {
          await atualizarEstatisticas();
        }
        if (typeof atualizarEstatisticasSessao === 'function') {
          await atualizarEstatisticasSessao();
        }
      }
      
      // Remover foco de qualquer elemento para manter tela n√≠tida
      if (document.activeElement && document.activeElement.blur) {
        document.activeElement.blur();
      }
      // Focar no body para manter tela n√≠tida
      document.body.focus();
    }
    
    // Limpar campo para pr√≥ximo brinco
    const brincoInputLimpar = document.getElementById('brincoInputV3');
    if (brincoInputLimpar) {
      brincoInputLimpar.value = '';
      // Remover foco do input
      if (brincoInputLimpar === document.activeElement) {
        brincoInputLimpar.blur();
      }
    }
  }

  // Fun√ß√£o para processar pesagem e manejo ap√≥s cadastro
  async function processarPesagemEManejo(brinco, index, total) {
    const numeroBrinco = brinco.numero_brinco || brinco.codigo_sisbov || '';
    
    // 1. Preencher peso
    const sexo = gerarSexo();
    const peso = gerarPeso(sexo);
    
    exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Registrando pesagem (${peso} kg)...`, 'info');
    const pesoInput = document.getElementById('pesoValorV3');
    if (pesoInput) {
      // N√£o focar no input para evitar desfoque da tela
      pesoInput.value = String(peso);
      pesoInput.dispatchEvent(new Event('input', { bubbles: true }));
      pesoInput.dispatchEvent(new Event('change', { bubbles: true }));
      await aguardar(500, 1000);
      // Remover foco imediatamente ap√≥s preencher
      if (pesoInput === document.activeElement) {
        pesoInput.blur();
      }
    }
    
    // 2. Selecionar manejo
    exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Selecionando manejo (Desmama)...`, 'info');
    const manejoSelect = document.getElementById('manejoSelectV3');
    if (manejoSelect) {
      // Procurar op√ß√£o "Desmama"
      const opcoes = manejoSelect.options;
      for (let i = 0; i < opcoes.length; i++) {
        if (opcoes[i].text.toLowerCase().includes('desmama') || opcoes[i].value.toLowerCase().includes('desmama')) {
          manejoSelect.value = opcoes[i].value;
          manejoSelect.dispatchEvent(new Event('change', { bubbles: true }));
          break;
        }
      }
      await aguardar(500, 1000);
    }
    
    // 3. Finalizar e gravar
    exibirMensagemSimulador(`Brinco ${index + 1}/${total}: Finalizando e gravando pesagem e manejo...`, 'info');
    const btnFinalizar = document.getElementById('btnFinalizarGravarV3') || document.getElementById('pesoGravarBtnV3');
    if (btnFinalizar) {
      btnFinalizar.click();
      await aguardar(2000, 3000);
    }
    
    // Atualizar indicadores ap√≥s gravar
    if (typeof atualizarEstatisticas === 'function') {
      await atualizarEstatisticas();
    }
    if (typeof atualizarEstatisticasSessao === 'function') {
      await atualizarEstatisticasSessao();
    }
    
    // Remover foco para manter tela n√≠tida
    if (document.activeElement && document.activeElement.blur) {
      document.activeElement.blur();
    }
    document.body.focus();
  }

  // Fun√ß√£o para processar um animal j√° cadastrado (pesagem e manejo)
  async function processarAnimalCadastrado(animal, index, total) {
    const codigoAnimal = animal.codigo_sisbov || animal.numero_brinco || animal.numero_manejo || '';
    
    // 1. Leitura do brinco
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Lendo brinco ${codigoAnimal}...`, 'info');
    await aguardar(800, 1500);
    
    const brincoInputAnimal = document.getElementById('brincoInputV3');
    if (!brincoInputAnimal) {
      throw new Error('Campo de brinco n√£o encontrado');
    }
    
    brincoInputAnimal.value = '';
    // N√£o focar no input para evitar desfoque da tela
    await aguardar(200, 400);
    
    await simularDigitacao(brincoInputAnimal, codigoAnimal, 80);
    await aguardar(500, 1000);
    
    // Remover foco do input ap√≥s digitar
    if (brincoInputAnimal === document.activeElement) {
      brincoInputAnimal.blur();
    }
    
    // Buscar animal
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Buscando animal no sistema...`, 'info');
    if (typeof window.buscarBrincoV3 === 'function') {
      await window.buscarBrincoV3(codigoAnimal);
    } else {
      const btnBuscar = document.querySelector('button[onclick="buscarBrincoV3()"]');
      if (btnBuscar) btnBuscar.click();
    }
    
    await aguardar(2000, 3000);
    
    // Verificar se animal foi encontrado
    let numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
    let animalEncontrado = (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '');
    
    if (!animalEncontrado) {
      await aguardar(1000, 2000);
      numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
      animalEncontrado = (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '');
    }
    
    if (!animalEncontrado) {
      throw new Error(`Animal n√£o encontrado ap√≥s busca: ${codigoAnimal}`);
    }
    
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal encontrado! Card atualizado.`, 'success');
    await aguardar(500, 1000);
    
    // 2. Preencher peso
    const sexo = animal.sexo || (Math.random() < 0.5 ? 'F' : 'M');
    const peso = gerarPeso(sexo);
    
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Registrando pesagem (${peso} kg)...`, 'info');
    const pesoInput = document.getElementById('pesoValorV3');
    if (pesoInput) {
      // N√£o focar no input para evitar desfoque da tela
      pesoInput.value = String(peso);
      pesoInput.dispatchEvent(new Event('input', { bubbles: true }));
      pesoInput.dispatchEvent(new Event('change', { bubbles: true }));
      await aguardar(500, 1000);
      // Remover foco imediatamente ap√≥s preencher
      if (pesoInput === document.activeElement) {
        pesoInput.blur();
      }
    }
    
    // 3. Selecionar manejo
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Selecionando manejo (Desmama)...`, 'info');
    const manejoSelect = document.getElementById('manejoSelectV3');
    if (manejoSelect) {
      // Procurar op√ß√£o "Desmama"
      const opcoes = manejoSelect.options;
      for (let i = 0; i < opcoes.length; i++) {
        if (opcoes[i].text.toLowerCase().includes('desmama') || opcoes[i].value.toLowerCase().includes('desmama')) {
          manejoSelect.value = opcoes[i].value;
          manejoSelect.dispatchEvent(new Event('change', { bubbles: true }));
          break;
        }
      }
      await aguardar(500, 1000);
    }
    
    // 4. Finalizar e gravar
    exibirMensagemSimulador(`Animal ${index + 1}/${total}: Finalizando e gravando...`, 'info');
    const btnFinalizar = document.getElementById('btnFinalizarGravarV3') || document.getElementById('pesoGravarBtnV3');
    if (btnFinalizar) {
      btnFinalizar.click();
      await aguardar(2000, 3000);
    }
    
    // Atualizar indicadores ap√≥s gravar
    if (typeof atualizarEstatisticas === 'function') {
      await atualizarEstatisticas();
    }
    if (typeof atualizarEstatisticasSessao === 'function') {
      await atualizarEstatisticasSessao();
    }
    
    // Limpar campo para pr√≥ximo animal
    const brincoInputLimpar2 = document.getElementById('brincoInputV3');
    if (brincoInputLimpar2) {
      brincoInputLimpar2.value = '';
      // Remover foco do input
      if (brincoInputLimpar2 === document.activeElement) {
        brincoInputLimpar2.blur();
      }
    }
    
    // Remover foco de qualquer elemento para manter tela n√≠tida
    if (document.activeElement && document.activeElement.blur) {
      document.activeElement.blur();
    }
    document.body.focus();
  }

  // Fun√ß√£o para processar um animal (vers√£o antiga - mantida para compatibilidade)
  async function processarAnimal(numeroEstoque, index, total) {
    try {
      const sexo = gerarSexo();
      const peso = gerarPeso(sexo);
      // Mapear ra√ßas para c√≥digos do select - apenas Nelore e Composto
      const racasDisponiveis = [
        { nome: 'Nelore', codigo: 'NE' },
        { nome: 'Composto', codigo: 'XX' }
      ];
      const racaSelecionada = racasDisponiveis[Math.floor(Math.random() * racasDisponiveis.length)];
      const raca = racaSelecionada.nome;
      const racaCodigo = racaSelecionada.codigo;
      // Gerar n√∫mero do chip RFID
      const numeroChip = gerarNumeroChip();
      
      // 1. Leitura do brinco
      // Extrair n√∫mero de manejo do SISBOV para exibi√ß√£o
      const numeroManejo = extrairNumeroManejo(numeroEstoque);
      exibirMensagemSimulador(`Animal ${index + 1}/${total}: Lendo brinco (SISBOV: ${numeroEstoque}, Manejo: ${numeroManejo})...`, 'info');
      await aguardar(800, 1500);
      
      const brincoInputAntigo = document.getElementById('brincoInputV3');
      if (!brincoInputAntigo) {
        throw new Error('Campo de brinco n√£o encontrado');
      }
      
      // Limpar campo antes de digitar
      brincoInputAntigo.value = '';
      brincoInputAntigo.focus();
      await aguardar(200, 400);
      
      // Simular digita√ß√£o do brinco (usar SISBOV completo)
      await simularDigitacao(brincoInputAntigo, numeroEstoque, 80);
      await aguardar(500, 1000);
      
      // Buscar animal (pressionar Enter ou clicar no bot√£o)
      exibirMensagemSimulador(`Animal ${index + 1}/${total}: Buscando animal no sistema...`, 'info');
      const btnBuscar = document.querySelector('button[onclick="buscarBrincoV3()"]') || 
                       document.querySelector('.btn-buscar');
      if (btnBuscar) {
        btnBuscar.click();
      } else {
        // Tentar chamar a fun√ß√£o diretamente
        if (typeof window.buscarBrincoV3 === 'function') {
          await window.buscarBrincoV3(numeroEstoque);
        } else {
          brincoInput.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', keyCode: 13, bubbles: true }));
        }
      }
      
      await aguardar(2000, 3000); // Aguardar mais tempo para a busca processar
      
      // 2. Verificar se animal foi encontrado ou precisa cadastrar
      // Verificar m√∫ltiplos elementos para garantir que encontrou
      let numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
      let sisbovEl = document.getElementById('scannerSisbovV3');
      let codigoEletronicoEl = document.getElementById('scannerCodigoEletronicoV3');
      
      // Animal encontrado se qualquer um dos campos principais tiver valor
      let animalEncontrado = (
        (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '') ||
        (sisbovEl && sisbovEl.textContent !== '‚Äî' && sisbovEl.textContent.trim() !== '') ||
        (codigoEletronicoEl && codigoEletronicoEl.textContent !== '‚Äî' && codigoEletronicoEl.textContent.trim() !== '')
      );
      
      // Se ainda n√£o encontrou, aguardar mais um pouco e verificar novamente
      if (!animalEncontrado) {
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Aguardando resposta da busca...`, 'info');
        await aguardar(1000, 2000);
        
        // Verificar novamente
        numeroManejoEl = document.getElementById('scannerNumeroManejoV3');
        sisbovEl = document.getElementById('scannerSisbovV3');
        codigoEletronicoEl = document.getElementById('scannerCodigoEletronicoV3');
        
        animalEncontrado = (
          (numeroManejoEl && numeroManejoEl.textContent !== '‚Äî' && numeroManejoEl.textContent.trim() !== '') ||
          (sisbovEl && sisbovEl.textContent !== '‚Äî' && sisbovEl.textContent.trim() !== '') ||
          (codigoEletronicoEl && codigoEletronicoEl.textContent !== '‚Äî' && codigoEletronicoEl.textContent.trim() !== '')
        );
        
        if (animalEncontrado) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal encontrado! Card atualizado.`, 'success');
        }
      } else {
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal j√° cadastrado! Card atualizado.`, 'success');
      }
      
      if (!animalEncontrado) {
        // Animal n√£o encontrado - precisa cadastrar
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal n√£o encontrado. Verificando estoque de brincos...`, 'info');
        await aguardar(1000, 2000);
        
        // Verificar se o sistema retornou que o brinco est√° no estoque
        // Se sim, o modal pode abrir automaticamente ou precisamos abrir manualmente
        const modalCadastro = document.getElementById('modalCadastroEstoque');
        if (!modalCadastro) {
          throw new Error('Modal de cadastro n√£o encontrado');
        }
        
        // Verificar se o modal j√° est√° aberto (pode ter aberto automaticamente)
        const modalAberto = modalCadastro.classList.contains('show');
        if (!modalAberto) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Abrindo modal de cadastro...`, 'info');
          modalCadastro.classList.add('show');
          await aguardar(800, 1500); // Aguardar modal abrir completamente
        } else {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Modal de cadastro j√° est√° aberto`, 'info');
          await aguardar(500, 1000);
        }
        
        // Preencher dados do cadastro
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Preenchendo dados do cadastro (Ra√ßa: ${raca}, Sexo: ${sexo === 'F' ? 'F√™mea' : 'Macho'})...`, 'info');
        
        // Aguardar um pouco mais para garantir que o modal est√° totalmente renderizado
        await aguardar(500, 1000);
        
        const racaInput = document.getElementById('cadastroRacaV3');
        const sexoInput = document.getElementById('cadastroSexoV3');
        const idadeInput = document.getElementById('cadastroIdadeV3');
        const tipoRegistroInput = document.getElementById('cadastroTipoRegistroV3');
        const rfidInput = document.getElementById('cadastroRfidV3');
        
        // Verificar se os campos existem e est√£o vis√≠veis
        if (!racaInput || !sexoInput || !idadeInput || !tipoRegistroInput) {
          console.warn('Alguns campos do modal n√£o foram encontrados:', {
            raca: !!racaInput,
            sexo: !!sexoInput,
            idade: !!idadeInput,
            tipoRegistro: !!tipoRegistroInput,
            rfid: !!rfidInput
          });
        }
        
        // Preencher n√∫mero do chip RFID primeiro (campo opcional mas importante)
        if (rfidInput) {
          rfidInput.focus();
          await aguardar(200, 400);
          await simularDigitacao(rfidInput, numeroChip, 80);
          await aguardar(300, 600);
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Chip RFID preenchido (${numeroChip})...`, 'info');
        }
        
        if (racaInput) {
          racaInput.focus();
          await aguardar(200, 400);
          // O campo de ra√ßa √© um select, n√£o um input de texto
          // Precisamos selecionar a op√ß√£o pelo valor
          racaInput.value = racaCodigo;
          racaInput.dispatchEvent(new Event('change', { bubbles: true }));
          racaInput.dispatchEvent(new Event('input', { bubbles: true }));
          // Verificar se a sele√ß√£o foi aplicada
          if (racaInput.value !== racaCodigo) {
            // Tentar novamente
            await aguardar(200, 400);
            racaInput.value = racaCodigo;
            racaInput.dispatchEvent(new Event('change', { bubbles: true }));
            racaInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
          await aguardar(300, 600);
        }
        
        if (sexoInput) {
          sexoInput.focus();
          await aguardar(200, 400);
          sexoInput.value = sexo;
          sexoInput.dispatchEvent(new Event('change', { bubbles: true }));
          sexoInput.dispatchEvent(new Event('input', { bubbles: true }));
          await aguardar(300, 600);
        }
        
        if (idadeInput) {
          idadeInput.focus();
          await aguardar(200, 400);
          const idade = Math.floor(Math.random() * 12) + 6; // 6 a 18 meses
          await simularDigitacao(idadeInput, String(idade), 80);
          await aguardar(500, 800); // Aguardar mais para o c√°lculo da data de nascimento
        }
        
        if (tipoRegistroInput) {
          tipoRegistroInput.focus();
          await aguardar(200, 400);
          tipoRegistroInput.value = 'DESMAMA';
          tipoRegistroInput.dispatchEvent(new Event('change', { bubbles: true }));
          tipoRegistroInput.dispatchEvent(new Event('input', { bubbles: true }));
          await aguardar(300, 600);
        }
        
        await aguardar(500, 1000);
        
        // Confirmar cadastro
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Verificando se pode confirmar cadastro...`, 'info');
        await aguardar(500, 1000);
        
        const btnConfirmar = document.getElementById('btnConfirmarCadastroV3');
        if (!btnConfirmar) {
          throw new Error('Bot√£o de confirmar cadastro n√£o encontrado');
        }
        
        // Verificar se o bot√£o est√° habilitado
        if (btnConfirmar.disabled) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Bot√£o desabilitado. Verificando campos obrigat√≥rios...`, 'warning');
          await aguardar(1000, 2000);
          
          // Verificar novamente ap√≥s aguardar
          if (btnConfirmar.disabled) {
            // Tentar for√ßar habilita√ß√£o verificando campos
            const racaValor = document.getElementById('cadastroRacaV3')?.value.trim() || '';
            const sexoValor = document.getElementById('cadastroSexoV3')?.value || '';
            const idadeValor = document.getElementById('cadastroIdadeV3')?.value || '';
            const dataNascValor = document.getElementById('cadastroDataNascV3')?.value || '';
            const tipoRegistroValor = document.getElementById('cadastroTipoRegistroV3')?.value || '';
            
            console.warn('Campos do cadastro:', { raca: racaValor, sexo: sexoValor, idade: idadeValor, dataNasc: dataNascValor, tipoRegistro: tipoRegistroValor });
            
            // Se a ra√ßa n√£o foi selecionada, tentar selecionar novamente
            if (!racaValor && racaCodigo) {
              exibirMensagemSimulador(`Animal ${index + 1}/${total}: Ra√ßa n√£o selecionada, tentando novamente...`, 'warning');
              const racaInputNovo = document.getElementById('cadastroRacaV3');
              if (racaInputNovo) {
                racaInputNovo.value = racaCodigo;
                racaInputNovo.dispatchEvent(new Event('change', { bubbles: true }));
                racaInputNovo.dispatchEvent(new Event('input', { bubbles: true }));
                await aguardar(500, 1000);
              }
            }
            
            if (!racaValor || !sexoValor || (!idadeValor && !dataNascValor) || !tipoRegistroValor) {
              throw new Error(`Campos obrigat√≥rios n√£o preenchidos: raca=${!!racaValor}(${racaValor}), sexo=${!!sexoValor}(${sexoValor}), idade/data=${!!(idadeValor || dataNascValor)}, tipo=${!!tipoRegistroValor}(${tipoRegistroValor})`);
            }
          }
        }
        
        if (!btnConfirmar.disabled) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Confirmando cadastro...`, 'info');
          
          // Verificar se o modal est√° aberto antes de confirmar
          const modalCadastro = document.getElementById('modalCadastroEstoque');
          const modalAbertoAntes = modalCadastro && modalCadastro.classList.contains('show');
          
          if (typeof window.confirmarCadastroEstoqueV3 === 'function') {
            await window.confirmarCadastroEstoqueV3();
          } else {
            btnConfirmar.click();
          }
          
          // Aguardar o cadastro processar
          await aguardar(2000, 3500);
          
          // Verificar se o modal foi fechado
          if (modalAbertoAntes) {
            const modalAbertoDepois = modalCadastro && modalCadastro.classList.contains('show');
            if (modalAbertoDepois) {
              exibirMensagemSimulador(`Animal ${index + 1}/${total}: Modal ainda aberto, fechando manualmente...`, 'warning');
              // Fechar modal manualmente se n√£o fechou automaticamente
              if (typeof window.fecharModal === 'function') {
                window.fecharModal('modalCadastroEstoque');
              } else {
                modalCadastro.classList.remove('show');
              }
              await aguardar(500, 1000);
            } else {
              exibirMensagemSimulador(`Animal ${index + 1}/${total}: Modal fechado com sucesso!`, 'success');
            }
          }
          
          // Aguardar um pouco mais para garantir que o animal foi identificado ap√≥s o cadastro
          await aguardar(1000, 2000);
          
          // Verificar se o animal foi identificado ap√≥s o cadastro
          const numeroManejoAposCadastro = document.getElementById('scannerNumeroManejoV3');
          if (numeroManejoAposCadastro && numeroManejoAposCadastro.textContent !== '‚Äî' && numeroManejoAposCadastro.textContent.trim() !== '') {
            exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal identificado ap√≥s cadastro!`, 'success');
            animalEncontrado = true; // Marcar como encontrado para pular a verifica√ß√£o abaixo
          }
        } else {
          throw new Error('Bot√£o de confirmar cadastro permanece desabilitado ap√≥s preencher todos os campos');
        }
      }
      
      // Se o animal foi encontrado (j√° cadastrado ou rec√©m-cadastrado), continuar com pesagem
      if (animalEncontrado) {
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Animal identificado com sucesso! Card atualizado.`, 'success');
        
        // Aguardar um pouco para garantir que o card foi totalmente atualizado
        await aguardar(1000, 1500);
        
        // Verificar se o card foi atualizado corretamente
        const numeroManejoCard = document.getElementById('scannerNumeroManejoV3');
        const sisbovCard = document.getElementById('scannerSisbovV3');
        const cardAtualizado = (numeroManejoCard && numeroManejoCard.textContent !== '‚Äî' && numeroManejoCard.textContent.trim() !== '') ||
                               (sisbovCard && sisbovCard.textContent !== '‚Äî' && sisbovCard.textContent.trim() !== '');
        
        if (!cardAtualizado) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Card n√£o atualizado, aguardando mais um pouco...`, 'warning');
          await aguardar(1000, 2000);
        }
      }
      
      // 3. Preencher peso (tanto para animal j√° cadastrado quanto rec√©m-cadastrado)
      exibirMensagemSimulador(`Animal ${index + 1}/${total}: Registrando pesagem (${peso} kg)...`, 'info');
      await aguardar(800, 1500);
      
      const pesoInput = document.getElementById('pesoValorV3');
      
      // Verificar se o campo de peso est√° habilitado, se n√£o estiver, tentar habilitar
      if (pesoInput) {
        if (pesoInput.disabled) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Campo de peso desabilitado, aguardando habilita√ß√£o...`, 'warning');
          await aguardar(1000, 2000);
          
          // Tentar habilitar manualmente se ainda estiver desabilitado
          if (pesoInput.disabled) {
            pesoInput.disabled = false;
            pesoInput.removeAttribute('disabled');
            await aguardar(300, 500);
          }
        }
        
        if (!pesoInput.disabled) {
        await simularDigitacao(pesoInput, peso.replace('.', ','), 100);
        await aguardar(500, 1000);
        
        // 4. Selecionar manejo (Desmama) - opcional
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Verificando manejos dispon√≠veis...`, 'info');
        await aguardar(500, 1000);
        
        // Procurar por checkboxes ou selects de manejo
        const manejosCheckboxes = document.querySelectorAll('input[type="checkbox"][name*="manejo"], input[type="checkbox"][id*="manejo"], input[type="checkbox"][data-manejo]');
        let manejoSelecionado = false;
        
        for (const checkbox of manejosCheckboxes) {
          const label = checkbox.closest('label')?.textContent || 
                       checkbox.nextElementSibling?.textContent || 
                       checkbox.getAttribute('data-manejo') || 
                       checkbox.getAttribute('name') || '';
          if (label.toLowerCase().includes('desmama') || 
              label.toLowerCase().includes('desmame') ||
              label.toLowerCase().includes('desmama')) {
            if (!checkbox.checked) {
              checkbox.click();
              manejoSelecionado = true;
              await aguardar(300, 600);
              break;
            }
          }
        }
        
        if (!manejoSelecionado) {
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Manejo de desmama n√£o encontrado, continuando apenas com pesagem...`, 'info');
        }
        
        // 5. Finalizar e gravar
        exibirMensagemSimulador(`Animal ${index + 1}/${total}: Finalizando e gravando...`, 'info');
        await aguardar(500, 1000);
        
        const btnFinalizar = document.getElementById('btnFinalizarGravarV3');
        if (btnFinalizar && !btnFinalizar.disabled) {
          if (typeof window.finalizarEGravarV3 === 'function') {
            await window.finalizarEGravarV3();
          } else {
            btnFinalizar.click();
          }
        } else {
          // Tentar gravar apenas a pesagem
          const btnGravar = document.getElementById('pesoGravarBtnV3');
          if (btnGravar && !btnGravar.disabled) {
            if (typeof window.gravarPesagemV3 === 'function') {
              await window.gravarPesagemV3();
            } else {
              btnGravar.click();
            }
          }
        }
        
          await aguardar(2000, 3500);
          
          exibirMensagemSimulador(`Animal ${index + 1}/${total}: Processado com sucesso! (Peso: ${peso} kg)`, 'success');
          simuladorRelatorio.animaisProcessados++;
        } else {
          throw new Error('Campo de peso n√£o p√¥de ser habilitado');
        }
      } else {
        throw new Error('Campo de peso n√£o encontrado');
      }
      
      // Limpar campos para pr√≥ximo animal
      exibirMensagemSimulador(`Animal ${index + 1}/${total}: Limpando campos para pr√≥ximo animal...`, 'info');
      await aguardar(500, 1000);
      
      const brincoInputLimpar4 = document.getElementById('brincoInputV3');
      if (brincoInputLimpar4) {
        brincoInputLimpar4.value = '';
        brincoInputLimpar4.focus();
      }
      
      const pesoInputLimpar = document.getElementById('pesoValorV3');
      if (pesoInputLimpar) {
        pesoInputLimpar.value = '';
      }
      
      // Limpar tamb√©m os campos do card (mas manter vis√≠vel)
      const numeroManejoLimpar = document.getElementById('scannerNumeroManejoV3');
      const sisbovLimpar = document.getElementById('scannerSisbovV3');
      if (numeroManejoLimpar) numeroManejoLimpar.textContent = '‚Äî';
      if (sisbovLimpar) sisbovLimpar.textContent = '‚Äî';
      
      // Limpar vari√°veis globais
      animalAtualV3 = null;
      brincoAtualV3 = null;
      
      await aguardar(500, 1000);
      
    } catch (error) {
      console.error(`Erro ao processar animal ${index + 1}:`, error);
      exibirMensagemSimulador(`Animal ${index + 1}/${total}: Erro - ${error.message}`, 'error');
      simuladorRelatorio.animaisComErro++;
      simuladorRelatorio.erros.push({
        animal: numeroEstoque,
        indice: index + 1,
        tipo: 'Processamento',
        mensagem: error.message,
        timestamp: new Date().toISOString()
      });
    }
  }

  // Fun√ß√£o para buscar brincos dispon√≠veis do estoque
  async function buscarBrincosDisponiveis() {
    try {
      adicionarLogOperacao('Buscar brincos dispon√≠veis do estoque', 'INFO', { url: dadosSimulacaoUrl });
      exibirMensagemSimulador('Buscando brincos dispon√≠veis no estoque...', 'info');
      
      if (!dadosSimulacaoUrl) {
        throw new Error('URL de dados de simula√ß√£o n√£o configurada');
      }
      
      const response = await fetch(dadosSimulacaoUrl, {
        method: 'GET',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Resposta: ${errorText.substring(0, 200)}`);
      }

      const data = await response.json();
      
      if (data.status === 'sucesso' && data.brincos_estoque) {
        adicionarLogOperacao('Brincos dispon√≠veis encontrados', 'OK', { 
          total: data.brincos_estoque.length 
        });
        exibirMensagemSimulador(`Encontrados ${data.brincos_estoque.length} brincos dispon√≠veis no estoque`, 'success');
        return data.brincos_estoque;
      } else {
        throw new Error(data.mensagem || 'Resposta inv√°lida da API');
      }
    } catch (error) {
      console.error('‚ùå Erro ao buscar brincos dispon√≠veis:', error);
      window.diagnosticoSistema.adicionarErro(error, { contexto: 'buscarBrincosDisponiveis' });
      adicionarLogOperacao('Erro ao buscar brincos dispon√≠veis', 'ERRO', { 
        mensagem: error.message 
      });
      exibirMensagemSimulador(`Erro ao buscar brincos: ${error.message}`, 'error');
      return [];
    }
  }

  // Fun√ß√£o para buscar animais cadastrados
  async function buscarAnimaisCadastrados() {
    try {
      adicionarLogOperacao('Buscar animais cadastrados', 'INFO', { url: dadosSimulacaoUrl });
      exibirMensagemSimulador('Buscando animais cadastrados...', 'info');
      
      if (!dadosSimulacaoUrl) {
        throw new Error('URL de dados de simula√ß√£o n√£o configurada');
      }
      
      const response = await fetch(dadosSimulacaoUrl, {
        method: 'GET',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Resposta: ${errorText.substring(0, 200)}`);
      }

      const data = await response.json();
      
      if (data.status === 'sucesso' && data.animais_cadastrados) {
        adicionarLogOperacao('Animais cadastrados encontrados', 'OK', { 
          total: data.animais_cadastrados.length 
        });
        exibirMensagemSimulador(`Encontrados ${data.animais_cadastrados.length} animais cadastrados`, 'success');
        return data.animais_cadastrados;
      } else {
        throw new Error(data.mensagem || 'Resposta inv√°lida da API');
      }
    } catch (error) {
      console.error('‚ùå Erro ao buscar animais cadastrados:', error);
      window.diagnosticoSistema.adicionarErro(error, { contexto: 'buscarAnimaisCadastrados' });
      adicionarLogOperacao('Erro ao buscar animais cadastrados', 'ERRO', { 
        mensagem: error.message 
      });
      exibirMensagemSimulador(`Erro ao buscar animais: ${error.message}`, 'error');
      return [];
    }
  }

  // Fun√ß√£o principal do simulador
  window.executarSimulador = async function() {
    try {
      console.log('üöÄ executarSimulador chamado');
      
      if (simuladorAtivo) {
        mostrarToast('Simulador j√° est√° em execu√ß√£o', 'warning');
        return;
      }
      
      // Verificar se as fun√ß√µes necess√°rias est√£o dispon√≠veis
      if (typeof window.buscarBrincoV3 !== 'function') {
        const erro = 'Fun√ß√£o buscarBrincoV3 n√£o est√° dispon√≠vel';
        console.error('‚ùå', erro);
        window.diagnosticoSistema.adicionarErro(new Error(erro), { contexto: 'executarSimulador' });
        mostrarToast('Erro: Sistema n√£o est√° completamente carregado. Recarregue a p√°gina.', 'error');
        return;
      }
      
      simuladorAtivo = true;
      
      // Garantir que o loading esteja desativado no in√≠cio do simulador
      // (pode ter ficado ativo de uma execu√ß√£o anterior)
      mostrarLoading(false);
      
    simuladorRelatorio = {
      fase: 'INICIO',
      brincosCadastrados: 0,
      brincosComErro: 0,
      animaisProcessados: 0,
      animaisComErro: 0,
      operacoes: [],
      erros: [],
      inicio: new Date().toISOString(),
      fim: null
    };
    
    adicionarLogOperacao('Simulador iniciado', 'INFO', {
      timestamp: simuladorRelatorio.inicio
    });
    
    // Esconder bot√£o do simulador e mostrar bot√£o de parar
    const btnSimulador = document.getElementById('btnSimulador');
    const btnPararSimuladorInicio = document.getElementById('btnPararSimulador');
    if (btnSimulador) {
      btnSimulador.style.display = 'none';
    }
    if (btnPararSimuladorInicio) {
      btnPararSimuladorInicio.style.display = 'inline-block';
    }
    
    // Aguardar 20 segundos antes de come√ßar
    exibirMensagemSimulador('Simulador iniciado. Aguardando 20 segundos antes de come√ßar...', 'info');
    
    for (let i = 20; i > 0; i--) {
      await new Promise(resolve => setTimeout(resolve, 1000));
      if (i % 5 === 0 || i <= 5) {
        exibirMensagemSimulador(`Iniciando em ${i} segundos...`, 'info');
      }
    }
    
    // Criar sess√£o de pesagem
    exibirMensagemSimulador('Criando sess√£o de pesagem...', 'info');
    const sessaoCriada = await criarSessaoPesagem();
    if (sessaoCriada) {
      adicionarLogOperacao('Sess√£o de pesagem criada', 'OK');
    } else {
      adicionarLogOperacao('Erro ao criar sess√£o de pesagem', 'ERRO');
      exibirMensagemSimulador('Aviso: N√£o foi poss√≠vel criar a sess√£o, mas continuando...', 'warning');
    }
    
    await aguardar(1000, 2000);
    
    // ========== FASE 1: CADASTRAR BRINCOS DO ESTOQUE ==========
    simuladorRelatorio.fase = 'CADASTRO_BRINCOS';
    exibirMensagemSimulador('FASE 1: Cadastrando brincos dispon√≠veis do estoque...', 'info');
    adicionarLogOperacao('Iniciando fase de cadastro de brincos', 'INFO');
    
    const brincosDisponiveis = await buscarBrincosDisponiveis();
    
    if (brincosDisponiveis.length === 0) {
      exibirMensagemSimulador('Nenhum brinco dispon√≠vel encontrado. Pulando fase de cadastro.', 'warning');
      adicionarLogOperacao('Nenhum brinco dispon√≠vel encontrado', 'INFO');
    } else {
      exibirMensagemSimulador(`Cadastrando ${brincosDisponiveis.length} brincos do estoque...`, 'info');
      
      for (let i = 0; i < brincosDisponiveis.length; i++) {
        if (!simuladorAtivo) {
          exibirMensagemSimulador('Simulador interrompido pelo usu√°rio', 'warning');
          break;
        }
        
        const brinco = brincosDisponiveis[i];
        const numeroBrinco = brinco.numero_brinco || brinco.codigo_sisbov || '';
        const codigoRfid = brinco.codigo_rfid || '';
        
        try {
          adicionarLogOperacao(`Cadastrar brinco ${i + 1}/${brincosDisponiveis.length}`, 'INFO', {
            numero_brinco: numeroBrinco,
            codigo_rfid: codigoRfid
          });
          
          exibirMensagemSimulador(`Brinco ${i + 1}/${brincosDisponiveis.length}: Cadastrando ${numeroBrinco}...`, 'info');
          
          await processarCadastroBrinco(brinco, i, brincosDisponiveis.length);
          
          simuladorRelatorio.brincosCadastrados++;
          adicionarLogOperacao(`Brinco ${i + 1}/${brincosDisponiveis.length} cadastrado`, 'OK', {
            numero_brinco: numeroBrinco
          });
        } catch (error) {
          simuladorRelatorio.brincosComErro++;
          adicionarLogOperacao(`Erro ao cadastrar brinco ${i + 1}/${brincosDisponiveis.length}`, 'ERRO', {
            numero_brinco: numeroBrinco,
            mensagem: error.message
          });
          simuladorRelatorio.erros.push({
            fase: 'CADASTRO_BRINCOS',
            brinco: numeroBrinco,
            indice: i + 1,
            tipo: 'Cadastro de Brinco',
            mensagem: error.message,
            timestamp: new Date().toISOString()
          });
        }
        
        await aguardar(1000, 2000);
      }
    }
    
    exibirMensagemSimulador(`Fase 1 conclu√≠da: ${simuladorRelatorio.brincosCadastrados} brincos cadastrados`, 'success');
    await aguardar(2000, 3000);
    
    // ========== FASE 2: LOOP INFINITO DE PESAGEM E MANEJO ==========
    simuladorRelatorio.fase = 'PROCESSAMENTO_ANIMAIS';
    exibirMensagemSimulador('FASE 2: Iniciando loop cont√≠nuo de pesagem e manejo...', 'info');
    exibirMensagemSimulador('O simulador processar√° todos os animais em loop at√© voc√™ parar.', 'info');
    adicionarLogOperacao('Iniciando fase de processamento cont√≠nuo de animais', 'INFO');
    
    let ciclo = 0;
    let totalProcessamentos = 0;
    
    // Loop infinito at√© o usu√°rio parar
    while (simuladorAtivo) {
      ciclo++;
      exibirMensagemSimulador(`=== CICLO ${ciclo} === Buscando animais cadastrados...`, 'info');
      adicionarLogOperacao(`Iniciando ciclo ${ciclo} de processamento`, 'INFO');
      
      const animaisCadastrados = await buscarAnimaisCadastrados();
      
      if (animaisCadastrados.length === 0) {
        exibirMensagemSimulador('Nenhum animal cadastrado encontrado. Aguardando 5 segundos antes de tentar novamente...', 'warning');
        adicionarLogOperacao('Nenhum animal cadastrado encontrado, aguardando...', 'INFO');
        await aguardar(5000, 5000);
        continue; // Volta ao in√≠cio do loop
      }
      
      exibirMensagemSimulador(`Ciclo ${ciclo}: Processando ${animaisCadastrados.length} animais (do primeiro ao √∫ltimo)...`, 'info');
      
      // Processar todos os animais do primeiro ao √∫ltimo
      for (let i = 0; i < animaisCadastrados.length; i++) {
        if (!simuladorAtivo) {
          exibirMensagemSimulador('Simulador interrompido pelo usu√°rio', 'warning');
          break;
        }
        
        const animal = animaisCadastrados[i];
        const codigoAnimal = animal.codigo_sisbov || animal.numero_brinco || animal.numero_manejo || '';
        
        try {
          adicionarLogOperacao(`Ciclo ${ciclo} - Animal ${i + 1}/${animaisCadastrados.length}`, 'INFO', {
            codigo: codigoAnimal,
            id: animal.id,
            ciclo: ciclo
          });
          
          exibirMensagemSimulador(`Ciclo ${ciclo} - Animal ${i + 1}/${animaisCadastrados.length}: Processando ${codigoAnimal}...`, 'info');
          
          await processarAnimalCadastrado(animal, i, animaisCadastrados.length);
          
          simuladorRelatorio.animaisProcessados++;
          totalProcessamentos++;
          adicionarLogOperacao(`Ciclo ${ciclo} - Animal ${i + 1}/${animaisCadastrados.length} processado`, 'OK', {
            codigo: codigoAnimal,
            ciclo: ciclo,
            total_processamentos: totalProcessamentos
          });
        } catch (error) {
          simuladorRelatorio.animaisComErro++;
          adicionarLogOperacao(`Ciclo ${ciclo} - Erro ao processar animal ${i + 1}/${animaisCadastrados.length}`, 'ERRO', {
            codigo: codigoAnimal,
            mensagem: error.message,
            ciclo: ciclo
          });
          simuladorRelatorio.erros.push({
            fase: 'PROCESSAMENTO_ANIMAIS',
            animal: codigoAnimal,
            indice: i + 1,
            ciclo: ciclo,
            tipo: 'Processamento de Animal',
            mensagem: error.message,
            timestamp: new Date().toISOString()
          });
        }
        
        await aguardar(1000, 2000);
      }
      
      // Ap√≥s processar todos os animais, volta ao in√≠cio
      exibirMensagemSimulador(`Ciclo ${ciclo} conclu√≠do! Total de ${totalProcessamentos} processamentos realizados. Reiniciando do primeiro animal...`, 'success');
      await aguardar(2000, 3000);
    }
    
    // Se saiu do loop, finalizar
    simuladorRelatorio.fase = 'FINALIZADO';
    simuladorRelatorio.fim = new Date().toISOString();
    simuladorAtivo = false;
    
    // Garantir que o loading seja desativado ao finalizar
    mostrarLoading(false);
    
    adicionarLogOperacao('Simulador finalizado pelo usu√°rio', 'INFO', {
      timestamp: simuladorRelatorio.fim,
      total_ciclos: ciclo,
      total_processamentos: totalProcessamentos
    });
    
    // Gerar relat√≥rio
    gerarRelatorioSimulador();
    
    // Mostrar bot√£o novamente e esconder bot√£o de parar
    const btnPararSimulador = document.getElementById('btnPararSimulador');
    if (btnSimulador) {
      btnSimulador.style.display = 'block';
    }
    if (btnPararSimulador) {
      btnPararSimulador.style.display = 'none';
    }
    
    exibirMensagemSimulador(`Simula√ß√£o finalizada! ${ciclo} ciclos completos, ${totalProcessamentos} processamentos realizados. Verifique o relat√≥rio.`, 'success');
    } catch (error) {
      console.error('‚ùå ERRO CR√çTICO no simulador:', error);
      window.diagnosticoSistema.adicionarErro(error, { contexto: 'executarSimulador - erro cr√≠tico' });
      mostrarToast(`Erro cr√≠tico no simulador: ${error.message}. Verifique o console.`, 'error');
      simuladorAtivo = false;
      
      // Garantir que o loading seja desativado em caso de erro cr√≠tico
      mostrarLoading(false);
      
      // Restaurar bot√µes
      const btnSimulador = document.getElementById('btnSimulador');
      const btnPararSimulador = document.getElementById('btnPararSimulador');
      if (btnSimulador) btnSimulador.style.display = 'block';
      if (btnPararSimulador) btnPararSimulador.style.display = 'none';
    }
  }

  // Fun√ß√£o para gerar relat√≥rio
  function gerarRelatorioSimulador() {
    const duracao = new Date(simuladorRelatorio.fim) - new Date(simuladorRelatorio.inicio);
    const minutos = Math.floor(duracao / 60000);
    const segundos = Math.floor((duracao % 60000) / 1000);
    
    // Contar opera√ß√µes por status
    const operacoesOK = simuladorRelatorio.operacoes.filter(op => op.status === 'OK').length;
    const operacoesERRO = simuladorRelatorio.operacoes.filter(op => op.status === 'ERRO').length;
    const operacoesINFO = simuladorRelatorio.operacoes.filter(op => op.status === 'INFO').length;
    
    const relatorio = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        RELAT√ìRIO DO SIMULADOR DE PESAGEM E IDENTIFICA√á√ÉO     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ INFORMA√á√ïES GERAIS:
   ‚Ä¢ Data/Hora In√≠cio: ${new Date(simuladorRelatorio.inicio).toLocaleString('pt-BR')}
   ‚Ä¢ Data/Hora Fim: ${new Date(simuladorRelatorio.fim).toLocaleString('pt-BR')}
   ‚Ä¢ Dura√ß√£o Total: ${minutos} minutos e ${segundos} segundos
   ‚Ä¢ Fase Final: ${simuladorRelatorio.fase}

üìä FASE 1: CADASTRO DE BRINCOS DO ESTOQUE
   ‚Ä¢ Brincos cadastrados com sucesso: ${simuladorRelatorio.brincosCadastrados}
   ‚Ä¢ Brincos com erro: ${simuladorRelatorio.brincosComErro}
   ‚Ä¢ Taxa de sucesso: ${simuladorRelatorio.brincosCadastrados + simuladorRelatorio.brincosComErro > 0 
     ? ((simuladorRelatorio.brincosCadastrados / (simuladorRelatorio.brincosCadastrados + simuladorRelatorio.brincosComErro)) * 100).toFixed(2) 
     : 0}%

üìä FASE 2: PROCESSAMENTO DE ANIMAIS CADASTRADOS
   ‚Ä¢ Animais processados com sucesso: ${simuladorRelatorio.animaisProcessados}
   ‚Ä¢ Animais com erro: ${simuladorRelatorio.animaisComErro}
   ‚Ä¢ Taxa de sucesso: ${simuladorRelatorio.animaisProcessados + simuladorRelatorio.animaisComErro > 0 
     ? ((simuladorRelatorio.animaisProcessados / (simuladorRelatorio.animaisProcessados + simuladorRelatorio.animaisComErro)) * 100).toFixed(2) 
     : 0}%

üìã OPERA√á√ïES REALIZADAS:
   ‚Ä¢ Total de opera√ß√µes: ${simuladorRelatorio.operacoes.length}
   ‚Ä¢ Opera√ß√µes OK: ${operacoesOK}
   ‚Ä¢ Opera√ß√µes com ERRO: ${operacoesERRO}
   ‚Ä¢ Opera√ß√µes INFO: ${operacoesINFO}

${simuladorRelatorio.erros.length > 0 ? `\n‚ùå ERROS ENCONTRADOS (${simuladorRelatorio.erros.length}):\n` : '\n‚úÖ NENHUM ERRO ENCONTRADO!\n'}
${simuladorRelatorio.erros.map((erro, idx) => `
   ${idx + 1}. [${erro.fase || 'N/A'}] ${erro.tipo} - ${erro.brinco || erro.animal || erro.indice || 'N/A'}
      Mensagem: ${erro.mensagem}
      Timestamp: ${new Date(erro.timestamp).toLocaleString('pt-BR')}
`).join('')}

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    LOG DETALHADO DE OPERA√á√ïES                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

${simuladorRelatorio.operacoes.map((op, idx) => {
  const data = new Date(op.timestamp).toLocaleString('pt-BR');
  const statusIcon = op.status === 'OK' ? '‚úÖ' : op.status === 'ERRO' ? '‚ùå' : '‚ÑπÔ∏è';
  const detalhes = Object.keys(op.detalhes).length > 0 
    ? '\n      Detalhes: ' + JSON.stringify(op.detalhes, null, 2).split('\n').join('\n      ')
    : '';
  return `${idx + 1}. ${statusIcon} [${data}] ${op.operacao}${detalhes}`;
}).join('\n\n')}

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    FIM DO RELAT√ìRIO                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    `;
    
    console.log(relatorio);
    
    // Criar arquivo de texto para download
    const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    a.href = url;
    a.download = `relatorio_simulador_${timestamp}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Mostrar relat√≥rio em um modal tamb√©m
    mostrarRelatorioModal(relatorio);
  }

  // Fun√ß√£o para mostrar relat√≥rio em modal
  function mostrarRelatorioModal(relatorio) {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10004;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    `;
    
    const pre = document.createElement('pre');
    pre.style.cssText = `
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    `;
    pre.textContent = relatorio;
    
    const btnFechar = document.createElement('button');
    btnFechar.textContent = 'Fechar';
    btnFechar.style.cssText = `
      margin-top: 16px;
      padding: 10px 20px;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    `;
    btnFechar.onclick = () => {
      document.body.removeChild(modal);
    };
    
    content.appendChild(pre);
    content.appendChild(btnFechar);
    modal.appendChild(content);
    document.body.appendChild(modal);
  }

  // Fun√ß√£o para gerar n√∫mero de chip RFID
  function gerarNumeroChip() {
    // Formato comum de RFID: 900 + 12 d√≠gitos
    const prefixo = '900';
    const digitos = String(Math.floor(Math.random() * 1000000000000)).padStart(12, '0');
    return prefixo + digitos;
  }

  // N√ÉO sobrescrever window.iniciarSimulador - j√° est√° definido antes do IIFE
  // Apenas garantir que window.executarSimulador est√° dispon√≠vel
  console.log('‚úÖ window.executarSimulador definido dentro do IIFE');
  
  // Garantir que a fun√ß√£o global ainda est√° dispon√≠vel ap√≥s o IIFE
  if (typeof window.iniciarSimulador !== 'function') {
    window.iniciarSimulador = function() {
      console.log('üîµ iniciarSimulador chamado (fallback)');
      if (typeof window.executarSimulador === 'function') {
        const mensagem = 'Deseja iniciar o simulador de pesagem e identifica√ß√£o?\n\n' +
          'O simulador ir√°:\n' +
          '‚Ä¢ Aguardar 20 segundos antes de come√ßar\n' +
          '‚Ä¢ FASE 1: Cadastrar todos os brincos dispon√≠veis do estoque\n' +
          '‚Ä¢ FASE 2: Processar todos os animais cadastrados com pesagem e manejo\n' +
          '‚Ä¢ Criar uma sess√£o de pesagem\n' +
          '‚Ä¢ Gerar um log detalhado em TXT de todas as opera√ß√µes\n' +
          '‚Ä¢ Relat√≥rio completo com erros e status OK';
        
        if (confirm(mensagem)) {
          window.executarSimulador();
        }
      } else {
        alert('Simulador ainda n√£o carregado. Aguarde alguns segundos e tente novamente.');
      }
    };
  }

  // Fun√ß√£o para parar o simulador
  window.pararSimulador = function() {
    console.log('üõë Parando simulador...');
    simuladorAtivo = false;
    
    // Garantir que o loading seja desativado ao parar o simulador
    mostrarLoading(false);
    
    exibirMensagemSimulador('Simulador sendo interrompido... Aguarde finaliza√ß√£o do animal atual.', 'warning');
    adicionarLogOperacao('Simulador interrompido pelo usu√°rio', 'INFO', {
      timestamp: new Date().toISOString()
    });
    
    const btnSimulador = document.getElementById('btnSimulador');
    const btnPararSimulador = document.getElementById('btnPararSimulador');
    if (btnSimulador) {
      btnSimulador.style.display = 'block';
    }
    if (btnPararSimulador) {
      btnPararSimulador.style.display = 'none';
    }
  };

})();

// ========== SISTEMA DE AN√ÅLISE E DIAGN√ìSTICO AVAN√áADO ==========
// Sistema que monitora, analisa e diagnostica o fluxo do simulador em tempo real
(function() {
  'use strict';

  // ========== CONFIGURA√á√ÉO DO SISTEMA DE AN√ÅLISE ==========
  const ANALISE_CONFIG = {
    maxAnalises: 10000, // M√°ximo de an√°lises a realizar
    intervaloAnalise: 100, // Intervalo em ms entre an√°lises (100ms = 10 an√°lises/segundo)
    historicoMaximo: 10000, // M√°ximo de eventos no hist√≥rico
    metricasAtivas: true, // Ativar coleta de m√©tricas
    diagnosticoAtivo: true, // Ativar diagn√≥sticos autom√°ticos
    painelVisual: true // Ativar painel visual de monitoramento
  };

  // ========== ESTRUTURA DE DADOS PARA AN√ÅLISE ==========
  const sistemaAnalise = {
    inicio: null,
    eventos: [],
    metricas: {
      // M√©tricas de tempo
      temposOperacao: {
        buscaBrinco: [],
        cadastroBrinco: [],
        pesagem: [],
        selecaoManejo: [],
        gravacao: [],
        totalPorAnimal: []
      },
      // M√©tricas de sucesso/erro
      taxasSucesso: {
        busca: { sucesso: 0, erro: 0 },
        cadastro: { sucesso: 0, erro: 0 },
        pesagem: { sucesso: 0, erro: 0 },
        gravacao: { sucesso: 0, erro: 0 }
      },
      // M√©tricas de fluxo
      fluxo: {
        animaisProcessados: 0,
        brincosCadastrados: 0,
        animaisComErro: 0,
        brincosComErro: 0,
        faseAtual: 'INICIO',
        tempoPorFase: {}
      },
      // M√©tricas de performance
      performance: {
        operacoesPorSegundo: [],
        tempoMedioOperacao: 0,
        picoOperacoes: 0,
        tempoOcioso: 0
      },
      // M√©tricas de DOM
      dom: {
        elementosNaoEncontrados: [],
        elementosDesabilitados: [],
        modaisAbertos: [],
        camposPreenchidos: []
      }
    },
    diagnosticos: [],
    recomendacoes: [],
    padroes: {
      errosRecorrentes: {},
      sequenciasSucesso: [],
      sequenciasErro: [],
      gargalos: []
    },
    analisesRealizadas: 0
  };

  // ========== INTERCEPTA√á√ÉO DE FUN√á√ïES DO SIMULADOR ==========
  function interceptarFuncoes() {
    // Interceptar adicionarLogOperacao
    const originalAdicionarLog = window.adicionarLogOperacao;
    if (typeof originalAdicionarLog === 'function') {
      window.adicionarLogOperacao = function(operacao, status, detalhes) {
        registrarEvento('OPERACAO', {
          operacao: operacao,
          status: status,
          detalhes: detalhes || {},
          timestamp: new Date().toISOString()
        });
        return originalAdicionarLog.apply(this, arguments);
      };
    }

    // Interceptar exibirMensagemSimulador
    const originalExibirMensagem = window.exibirMensagemSimulador;
    if (typeof originalExibirMensagem === 'function') {
      window.exibirMensagemSimulador = function(mensagem, tipo) {
        registrarEvento('MENSAGEM', {
          mensagem: mensagem,
          tipo: tipo,
          timestamp: new Date().toISOString()
        });
        return originalExibirMensagem.apply(this, arguments);
      };
    }

    // Interceptar aguardar para medir tempos
    const originalAguardar = window.aguardar;
    if (typeof originalAguardar === 'function') {
      window.aguardar = async function(min, max) {
        const inicio = performance.now();
        const resultado = await originalAguardar.apply(this, arguments);
        const tempo = performance.now() - inicio;
        registrarMetrica('tempo_aguardo', tempo, { min, max });
        return resultado;
      };
    }
  }

  // ========== REGISTRO DE EVENTOS ==========
  function registrarEvento(tipo, dados) {
    const evento = {
      id: sistemaAnalise.eventos.length + 1,
      tipo: tipo,
      dados: dados,
      timestamp: dados.timestamp || new Date().toISOString(),
      timestampPerformance: performance.now()
    };

    sistemaAnalise.eventos.push(evento);

    // Limitar hist√≥rico
    if (sistemaAnalise.eventos.length > ANALISE_CONFIG.historicoMaximo) {
      sistemaAnalise.eventos.shift();
    }

    // An√°lise imediata do evento
    analisarEvento(evento);
  }

  // ========== REGISTRO DE M√âTRICAS ==========
  function registrarMetrica(categoria, valor, contexto = {}) {
    if (!sistemaAnalise.metricas[categoria]) {
      sistemaAnalise.metricas[categoria] = [];
    }

    const metrica = {
      valor: valor,
      contexto: contexto,
      timestamp: new Date().toISOString(),
      timestampPerformance: performance.now()
    };

    sistemaAnalise.metricas[categoria].push(metrica);

    // Limitar hist√≥rico de m√©tricas
    if (sistemaAnalise.metricas[categoria].length > 1000) {
      sistemaAnalise.metricas[categoria].shift();
    }
  }

  // ========== AN√ÅLISE DE EVENTOS ==========
  function analisarEvento(evento) {
    sistemaAnalise.analisesRealizadas++;

    // An√°lise de padr√µes de erro
    if (evento.dados.status === 'ERRO' || evento.dados.tipo === 'error') {
      const mensagemErro = evento.dados.mensagem || evento.dados.operacao || '';
      const chaveErro = mensagemErro.substring(0, 50);
      
      if (!sistemaAnalise.padroes.errosRecorrentes[chaveErro]) {
        sistemaAnalise.padroes.errosRecorrentes[chaveErro] = {
          ocorrencias: 0,
          primeiroTimestamp: evento.timestamp,
          ultimoTimestamp: evento.timestamp,
          contexto: evento.dados
        };
      }
      
      sistemaAnalise.padroes.errosRecorrentes[chaveErro].ocorrencias++;
      sistemaAnalise.padroes.errosRecorrentes[chaveErro].ultimoTimestamp = evento.timestamp;
    }

    // An√°lise de sequ√™ncias
    if (sistemaAnalise.eventos.length >= 2) {
      const eventoAnterior = sistemaAnalise.eventos[sistemaAnalise.eventos.length - 2];
      const sequencia = {
        de: eventoAnterior.tipo,
        para: evento.tipo,
        tempo: evento.timestampPerformance - eventoAnterior.timestampPerformance
      };

      if (evento.dados.status === 'OK' || evento.dados.tipo === 'success') {
        sistemaAnalise.padroes.sequenciasSucesso.push(sequencia);
      } else if (evento.dados.status === 'ERRO' || evento.dados.tipo === 'error') {
        sistemaAnalise.padroes.sequenciasErro.push(sequencia);
      }
    }

    // An√°lise de fase
    if (evento.dados.fase) {
      sistemaAnalise.metricas.fluxo.faseAtual = evento.dados.fase;
      
      if (!sistemaAnalise.metricas.fluxo.tempoPorFase[evento.dados.fase]) {
        sistemaAnalise.metricas.fluxo.tempoPorFase[evento.dados.fase] = {
          inicio: evento.timestampPerformance,
          duracao: 0,
          eventos: 0
        };
      }
      
      sistemaAnalise.metricas.fluxo.tempoPorFase[evento.dados.fase].eventos++;
    }
  }

  // ========== AN√ÅLISE PERI√ìDICA PROFUNDA ==========
  function realizarAnaliseProfunda() {
    if (!ANALISE_CONFIG.diagnosticoAtivo) return;

    // An√°lise de gargalos
    analisarGargalos();

    // An√°lise de performance
    analisarPerformance();

    // An√°lise de fluxo
    analisarFluxo();

    // An√°lise de DOM
    analisarDOM();

    // Gerar diagn√≥sticos
    gerarDiagnosticos();

    // Gerar recomenda√ß√µes
    gerarRecomendacoes();
  }

  // ========== AN√ÅLISE DE GARGALOS ==========
  function analisarGargalos() {
    const temposOperacao = sistemaAnalise.metricas.temposOperacao;
    const gargalos = [];

    // Analisar cada tipo de opera√ß√£o
    Object.keys(temposOperacao).forEach(tipo => {
      const tempos = temposOperacao[tipo];
      if (tempos.length > 0) {
        const media = tempos.reduce((a, b) => a + b, 0) / tempos.length;
        const max = Math.max(...tempos);
        const min = Math.min(...tempos);
        const desvioPadrao = calcularDesvioPadrao(tempos);

        // Identificar como gargalo se m√©dia > 2s ou desvio padr√£o alto
        if (media > 2000 || desvioPadrao > media * 0.5) {
          gargalos.push({
            tipo: tipo,
            tempoMedio: media,
            tempoMaximo: max,
            tempoMinimo: min,
            desvioPadrao: desvioPadrao,
            ocorrencias: tempos.length,
            severidade: media > 5000 ? 'ALTA' : media > 2000 ? 'M√âDIA' : 'BAIXA'
          });
        }
      }
    });

    sistemaAnalise.padroes.gargalos = gargalos;
  }

  // ========== AN√ÅLISE DE PERFORMANCE ==========
  function analisarPerformance() {
    if (sistemaAnalise.eventos.length < 2) return;

    const ultimosEventos = sistemaAnalise.eventos.slice(-100);
    const temposEntreEventos = [];

    for (let i = 1; i < ultimosEventos.length; i++) {
      const tempo = ultimosEventos[i].timestampPerformance - ultimosEventos[i - 1].timestampPerformance;
      temposEntreEventos.push(tempo);
    }

    if (temposEntreEventos.length > 0) {
      const tempoMedio = temposEntreEventos.reduce((a, b) => a + b, 0) / temposEntreEventos.length;
      const opsPorSegundo = 1000 / tempoMedio;

      sistemaAnalise.metricas.performance.operacoesPorSegundo.push(opsPorSegundo);
      sistemaAnalise.metricas.performance.tempoMedioOperacao = tempoMedio;

      if (opsPorSegundo > sistemaAnalise.metricas.performance.picoOperacoes) {
        sistemaAnalise.metricas.performance.picoOperacoes = opsPorSegundo;
      }

      // Calcular tempo ocioso (tempos > 1 segundo sem eventos)
      const tempoOcioso = temposEntreEventos.filter(t => t > 1000).reduce((a, b) => a + b, 0);
      sistemaAnalise.metricas.performance.tempoOcioso = tempoOcioso;
    }
  }

  // ========== AN√ÅLISE DE FLUXO ==========
  function analisarFluxo() {
    const eventos = sistemaAnalise.eventos;
    
    // Contar opera√ß√µes por tipo
    const contadores = {};
    eventos.forEach(evento => {
      const chave = evento.dados.operacao || evento.dados.mensagem || evento.tipo;
      contadores[chave] = (contadores[chave] || 0) + 1;
    });

    // Identificar fluxo mais comum
    const fluxoMaisComum = Object.entries(contadores)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)
      .map(([operacao, count]) => ({ operacao, count }));

    sistemaAnalise.padroes.fluxoMaisComum = fluxoMaisComum;
  }

  // ========== AN√ÅLISE DE DOM ==========
  function analisarDOM() {
    const elementosNaoEncontrados = [];
    const elementosDesabilitados = [];

    // Verificar elementos cr√≠ticos
    const elementosCriticos = [
      'brincoInputV3',
      'pesoValorV3',
      'manejoSelectV3',
      'btnFinalizarGravarV3',
      'modalCadastroEstoque',
      'btnConfirmarCadastroV3'
    ];

    elementosCriticos.forEach(id => {
      const elemento = document.getElementById(id);
      if (!elemento) {
        elementosNaoEncontrados.push(id);
      } else if (elemento.disabled) {
        elementosDesabilitados.push({ id, motivo: 'disabled' });
      }
    });

    sistemaAnalise.metricas.dom.elementosNaoEncontrados = elementosNaoEncontrados;
    sistemaAnalise.metricas.dom.elementosDesabilitados = elementosDesabilitados;

    // Verificar modais abertos
    const modais = document.querySelectorAll('.modal.show, [class*="modal"][class*="show"]');
    sistemaAnalise.metricas.dom.modaisAbertos = Array.from(modais).map(m => m.id || 'sem-id');
  }

  // ========== GERA√á√ÉO DE DIAGN√ìSTICOS ==========
  function gerarDiagnosticos() {
    sistemaAnalise.diagnosticos = [];

    // Diagn√≥stico 1: Gargalos de performance
    if (sistemaAnalise.padroes.gargalos && sistemaAnalise.padroes.gargalos.length > 0) {
      sistemaAnalise.padroes.gargalos.forEach(gargalo => {
        sistemaAnalise.diagnosticos.push({
          tipo: 'GARGALO_PERFORMANCE',
          severidade: gargalo.severidade,
          mensagem: `Opera√ß√£o "${gargalo.tipo}" est√° demorando em m√©dia ${(gargalo.tempoMedio / 1000).toFixed(2)}s (m√°ximo: ${(gargalo.tempoMaximo / 1000).toFixed(2)}s)`,
          recomendacao: `Otimizar a opera√ß√£o "${gargalo.tipo}" reduzindo tempos de espera ou melhorando a l√≥gica de processamento`,
          dados: gargalo
        });
      });
    }

    // Diagn√≥stico 2: Erros recorrentes
    const errosRecorrentes = Object.entries(sistemaAnalise.padroes.errosRecorrentes)
      .filter(([_, dados]) => dados.ocorrencias >= 3)
      .sort((a, b) => b[1].ocorrencias - a[1].ocorrencias);

    errosRecorrentes.forEach(([erro, dados]) => {
      sistemaAnalise.diagnosticos.push({
        tipo: 'ERRO_RECORRENTE',
        severidade: dados.ocorrencias > 10 ? 'ALTA' : dados.ocorrencias > 5 ? 'M√âDIA' : 'BAIXA',
        mensagem: `Erro recorrente detectado: "${erro.substring(0, 100)}" (${dados.ocorrencias} ocorr√™ncias)`,
        recomendacao: `Investigar e corrigir a causa raiz deste erro. Primeira ocorr√™ncia: ${new Date(dados.primeiroTimestamp).toLocaleString('pt-BR')}`,
        dados: dados
      });
    });

    // Diagn√≥stico 3: Elementos DOM n√£o encontrados
    if (sistemaAnalise.metricas.dom.elementosNaoEncontrados.length > 0) {
      sistemaAnalise.diagnosticos.push({
        tipo: 'DOM_ELEMENTO_NAO_ENCONTRADO',
        severidade: 'ALTA',
        mensagem: `Elementos cr√≠ticos n√£o encontrados: ${sistemaAnalise.metricas.dom.elementosNaoEncontrados.join(', ')}`,
        recomendacao: 'Verificar se os elementos est√£o sendo criados corretamente no DOM ou se h√° problemas de timing',
        dados: sistemaAnalise.metricas.dom.elementosNaoEncontrados
      });
    }

    // Diagn√≥stico 4: Performance geral
    const tempoMedio = sistemaAnalise.metricas.performance.tempoMedioOperacao;
    if (tempoMedio > 2000) {
      sistemaAnalise.diagnosticos.push({
        tipo: 'PERFORMANCE_BAIXA',
        severidade: 'M√âDIA',
        mensagem: `Tempo m√©dio entre opera√ß√µes: ${(tempoMedio / 1000).toFixed(2)}s (ideal: < 1s)`,
        recomendacao: 'Otimizar fluxo de opera√ß√µes para reduzir tempos de espera desnecess√°rios',
        dados: { tempoMedio }
      });
    }

    // Diagn√≥stico 5: Taxa de erro
    const totalOperacoes = sistemaAnalise.metricas.fluxo.animaisProcessados + sistemaAnalise.metricas.fluxo.animaisComErro;
    if (totalOperacoes > 0) {
      const taxaErro = (sistemaAnalise.metricas.fluxo.animaisComErro / totalOperacoes) * 100;
      if (taxaErro > 10) {
        sistemaAnalise.diagnosticos.push({
          tipo: 'TAXA_ERRO_ALTA',
          severidade: 'ALTA',
          mensagem: `Taxa de erro: ${taxaErro.toFixed(2)}% (${sistemaAnalise.metricas.fluxo.animaisComErro} erros de ${totalOperacoes} opera√ß√µes)`,
          recomendacao: 'Investigar causas dos erros e implementar tratamento de erros mais robusto',
          dados: { taxaErro, totalOperacoes, erros: sistemaAnalise.metricas.fluxo.animaisComErro }
        });
      }
    }
  }

  // ========== GERA√á√ÉO DE RECOMENDA√á√ïES ==========
  function gerarRecomenda√ß√µes() {
    sistemaAnalise.recomendacoes = [];

    // Recomenda√ß√£o 1: Otimiza√ß√£o de tempos de espera
    const temposAguardo = sistemaAnalise.metricas.tempo_aguardo || [];
    if (temposAguardo.length > 0) {
      const tempoMedioAguardo = temposAguardo.reduce((a, b) => a + b.valor, 0) / temposAguardo.length;
      if (tempoMedioAguardo > 1500) {
        sistemaAnalise.recomendacoes.push({
          prioridade: 'ALTA',
          categoria: 'PERFORMANCE',
          titulo: 'Reduzir tempos de espera',
          descricao: `Tempo m√©dio de espera: ${(tempoMedioAguardo / 1000).toFixed(2)}s. Considere reduzir os intervalos de aguardo entre opera√ß√µes.`,
          acao: 'Ajustar valores de min/max na fun√ß√£o aguardar() para valores menores'
        });
      }
    }

    // Recomenda√ß√£o 2: Melhorar tratamento de erros
    const errosRecorrentes = Object.keys(sistemaAnalise.padroes.errosRecorrentes).length;
    if (errosRecorrentes > 5) {
      sistemaAnalise.recomendacoes.push({
        prioridade: 'ALTA',
        categoria: 'ESTABILIDADE',
        titulo: 'Melhorar tratamento de erros',
        descricao: `${errosRecorrentes} tipos diferentes de erros recorrentes detectados. Implementar retry logic e tratamento mais robusto.`,
        acao: 'Adicionar mecanismos de retry e valida√ß√£o pr√©via antes de opera√ß√µes cr√≠ticas'
      });
    }

    // Recomenda√ß√£o 3: Otimizar fluxo de cadastro
    const sequenciasErro = sistemaAnalise.padroes.sequenciasErro.length;
    const sequenciasSucesso = sistemaAnalise.padroes.sequenciasSucesso.length;
    if (sequenciasErro > sequenciasSucesso * 0.3) {
      sistemaAnalise.recomendacoes.push({
        prioridade: 'M√âDIA',
        categoria: 'FLUXO',
        titulo: 'Otimizar sequ√™ncia de opera√ß√µes',
        descricao: `Taxa de sequ√™ncias com erro: ${((sequenciasErro / (sequenciasErro + sequenciasSucesso)) * 100).toFixed(2)}%`,
        acao: 'Revisar ordem de opera√ß√µes e adicionar valida√ß√µes intermedi√°rias'
      });
    }

    // Recomenda√ß√£o 4: Monitoramento cont√≠nuo
    sistemaAnalise.recomendacoes.push({
      prioridade: 'BAIXA',
      categoria: 'MONITORAMENTO',
      titulo: 'Implementar monitoramento cont√≠nuo',
      descricao: 'Sistema de an√°lise detectou padr√µes importantes. Considere manter monitoramento ativo em produ√ß√£o.',
      acao: 'Manter sistema de an√°lise ativo para detectar problemas em tempo real'
    });
  }

  // ========== FUN√á√ïES AUXILIARES ==========
  function calcularDesvioPadrao(valores) {
    if (valores.length === 0) return 0;
    const media = valores.reduce((a, b) => a + b, 0) / valores.length;
    const variancia = valores.reduce((a, b) => a + Math.pow(b - media, 2), 0) / valores.length;
    return Math.sqrt(variancia);
  }

  // ========== PAINEL VISUAL DE MONITORAMENTO ==========
  function criarPainelVisual() {
    if (!ANALISE_CONFIG.painelVisual) return null;

    // Verificar se j√° existe para evitar duplica√ß√£o
    let painel = document.getElementById('painelAnaliseSimulador');
    let btnToggle = document.getElementById('btnTogglePainel');

    // Criar painel se n√£o existir
    if (!painel) {
      painel = document.createElement('div');
      painel.id = 'painelAnaliseSimulador';
      painel.style.cssText = `
        position: fixed;
        top: 60px;
        right: 20px;
        width: 400px;
        max-height: 80vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10005;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        overflow-y: auto;
        display: none;
      `;

      painel.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 16px; font-weight: 700;">üîç An√°lise em Tempo Real</h3>
          <button id="btnFecharPainel" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
        </div>
        <div id="conteudoPainel">
          <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <div>üìä An√°lises realizadas: <strong id="contadorAnalises">0</strong></div>
            <div>‚ö° Ops/seg: <strong id="opsPorSegundo">0</strong></div>
            <div>üîÑ Fase: <strong id="faseAtual">Aguardando</strong></div>
            <div>‚úÖ Animais processados: <strong id="sucessos">0</strong></div>
            <div>üì¶ Brincos cadastrados: <strong id="brincosCadastrados">0</strong></div>
            <div>‚ùå Erros: <strong id="erros">0</strong></div>
            <div>üìà Eventos registrados: <strong id="eventosRegistrados">0</strong></div>
          </div>
          <div id="diagnosticosPainel" style="margin-top: 12px;"></div>
          <div id="recomendacoesPainel" style="margin-top: 12px;"></div>
        </div>
      `;

      if (document.body) {
        document.body.appendChild(painel);
        console.log('‚úÖ Painel de an√°lise criado');
      } else {
        console.warn('‚ö†Ô∏è document.body n√£o dispon√≠vel, tentando novamente...');
        setTimeout(() => {
          if (document.body) {
            document.body.appendChild(painel);
            console.log('‚úÖ Painel de an√°lise criado (retry)');
          }
        }, 100);
      }

      // Configurar bot√£o fechar
      setTimeout(() => {
        const btnFechar = document.getElementById('btnFecharPainel');
        if (btnFechar) {
          btnFechar.onclick = () => {
            painel.style.display = 'none';
          };
        }
      }, 100);
    }

    // Criar bot√£o toggle se n√£o existir
    if (!btnToggle) {
      btnToggle = document.createElement('button');
      btnToggle.id = 'btnTogglePainel';
      btnToggle.textContent = 'üìä An√°lise';
      btnToggle.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        z-index: 10004;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.2s;
      `;

      btnToggle.onmouseenter = () => {
        btnToggle.style.transform = 'scale(1.05)';
      };
      btnToggle.onmouseleave = () => {
        btnToggle.style.transform = 'scale(1)';
      };

      btnToggle.onclick = () => {
        const painelAtual = document.getElementById('painelAnaliseSimulador');
        if (painelAtual) {
          painelAtual.style.display = painelAtual.style.display === 'none' ? 'block' : 'none';
        }
      };

      if (document.body) {
        document.body.appendChild(btnToggle);
        console.log('‚úÖ Bot√£o de an√°lise criado');
      } else {
        console.warn('‚ö†Ô∏è document.body n√£o dispon√≠vel para bot√£o, tentando novamente...');
        setTimeout(() => {
          if (document.body) {
            document.body.appendChild(btnToggle);
            console.log('‚úÖ Bot√£o de an√°lise criado (retry)');
          }
        }, 100);
      }
    }

    return painel;
  }

  // ========== ATUALIZA√á√ÉO DO PAINEL ==========
  function atualizarPainel() {
    if (!ANALISE_CONFIG.painelVisual) return;

    const painel = document.getElementById('painelAnaliseSimulador');
    if (!painel) return;

    // Sincronizar com simuladorRelatorio se dispon√≠vel
    if (window.simuladorRelatorio) {
      sistemaAnalise.metricas.fluxo.animaisProcessados = window.simuladorRelatorio.animaisProcessados || 0;
      sistemaAnalise.metricas.fluxo.brincosCadastrados = window.simuladorRelatorio.brincosCadastrados || 0;
      sistemaAnalise.metricas.fluxo.animaisComErro = window.simuladorRelatorio.animaisComErro || 0;
      sistemaAnalise.metricas.fluxo.brincosComErro = window.simuladorRelatorio.brincosComErro || 0;
      sistemaAnalise.metricas.fluxo.faseAtual = window.simuladorRelatorio.fase || 'INICIO';
    }

    // Atualizar contadores
    const contadorAnalises = document.getElementById('contadorAnalises');
    const opsPorSegundo = document.getElementById('opsPorSegundo');
    const sucessos = document.getElementById('sucessos');
    const erros = document.getElementById('erros');

    if (contadorAnalises) {
      contadorAnalises.textContent = sistemaAnalise.analisesRealizadas.toLocaleString('pt-BR');
    }
    
    if (opsPorSegundo) {
      const ops = sistemaAnalise.metricas.performance.operacoesPorSegundo;
      const ultimaOps = ops.length > 0 ? ops[ops.length - 1] : 0;
      opsPorSegundo.textContent = ultimaOps.toFixed(2);
    }
    
    if (sucessos) {
      sucessos.textContent = sistemaAnalise.metricas.fluxo.animaisProcessados;
    }
    
    if (erros) {
      erros.textContent = sistemaAnalise.metricas.fluxo.animaisComErro;
    }

    // Atualizar brincos cadastrados
    const brincosCadastrados = document.getElementById('brincosCadastrados');
    if (brincosCadastrados) {
      brincosCadastrados.textContent = sistemaAnalise.metricas.fluxo.brincosCadastrados;
    }

    // Atualizar eventos registrados
    const eventosRegistrados = document.getElementById('eventosRegistrados');
    if (eventosRegistrados) {
      eventosRegistrados.textContent = sistemaAnalise.eventos.length;
    }

    // Atualizar fase atual se dispon√≠vel
    const faseElement = document.getElementById('faseAtual');
    if (faseElement) {
      const fase = sistemaAnalise.metricas.fluxo.faseAtual;
      faseElement.textContent = fase === 'INICIO' ? 'Aguardando' :
                                fase === 'CADASTRO_BRINCOS' ? 'Cadastrando Brincos' :
                                fase === 'PROCESSAMENTO_ANIMAIS' ? 'Processando Animais' :
                                fase === 'FINALIZADO' ? 'Finalizado' : fase;
    }

    // Atualizar diagn√≥sticos
    const diagnosticosPainel = document.getElementById('diagnosticosPainel');
    if (diagnosticosPainel) {
      const diagnosticosAtivos = sistemaAnalise.diagnosticos.slice(-5);
      diagnosticosPainel.innerHTML = diagnosticosAtivos.length > 0 
        ? `<div style="font-weight: 600; margin-bottom: 8px;">üîç Diagn√≥sticos:</div>` +
          diagnosticosAtivos.map(d => `
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-bottom: 6px; font-size: 11px;">
              <div style="font-weight: 600;">${d.mensagem.substring(0, 80)}...</div>
              <div style="margin-top: 4px; opacity: 0.9; font-size: 10px;">${d.recomendacao.substring(0, 100)}...</div>
            </div>
          `).join('')
        : '<div style="opacity: 0.7;">Nenhum diagn√≥stico ativo</div>';
    }

    // Atualizar recomenda√ß√µes
    const recomendacoesPainel = document.getElementById('recomendacoesPainel');
    if (recomendacoesPainel) {
      const recomendacoesAtivas = sistemaAnalise.recomendacoes.slice(-3);
      recomendacoesPainel.innerHTML = recomendacoesAtivas.length > 0
        ? `<div style="font-weight: 600; margin-bottom: 8px;">üí° Recomenda√ß√µes:</div>` +
          recomendacoesAtivas.map(r => `
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-bottom: 6px; font-size: 11px;">
              <div style="font-weight: 600;">${r.titulo}</div>
              <div style="margin-top: 4px; opacity: 0.9; font-size: 10px;">${r.descricao.substring(0, 100)}...</div>
            </div>
          `).join('')
        : '<div style="opacity: 0.7;">Nenhuma recomenda√ß√£o no momento</div>';
    }
  }

  // ========== RELAT√ìRIO COMPLETO DE AN√ÅLISE ==========
  function gerarRelatorioAnalise() {
    const duracao = sistemaAnalise.inicio 
      ? performance.now() - (sistemaAnalise.inicio || 0)
      : 0;

    const relatorio = {
      resumo: {
        analisesRealizadas: sistemaAnalise.analisesRealizadas,
        eventosRegistrados: sistemaAnalise.eventos.length,
        duracao: duracao,
        timestamp: new Date().toISOString()
      },
      metricas: sistemaAnalise.metricas,
      diagnosticos: sistemaAnalise.diagnosticos,
      recomendacoes: sistemaAnalise.recomendacoes,
      padroes: {
        errosRecorrentes: sistemaAnalise.padroes.errosRecorrentes,
        gargalos: sistemaAnalise.padroes.gargalos,
        fluxoMaisComum: sistemaAnalise.padroes.fluxoMaisComum
      },
      eventos: sistemaAnalise.eventos.slice(-1000) // √öltimos 1000 eventos
    };

    return relatorio;
  }

  // ========== EXPORTAR DADOS DE AN√ÅLISE ==========
  function exportarAnalise() {
    const relatorio = gerarRelatorioAnalise();
    const json = JSON.stringify(relatorio, null, 2);
    
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    a.href = url;
    a.download = `analise_simulador_${timestamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    console.log('üìä Relat√≥rio de An√°lise Completo:', relatorio);
  }

  // ========== INICIALIZA√á√ÉO DO SISTEMA ==========
  function inicializarSistemaAnalise() {
    sistemaAnalise.inicio = performance.now();
    
    // Interceptar fun√ß√µes
    interceptarFuncoes();

    // Criar painel visual
    if (ANALISE_CONFIG.painelVisual) {
      criarPainelVisual();
    }

    // Iniciar monitoramento cont√≠nuo do DOM
    setInterval(() => {
      monitorarSimulador();
    }, 500); // Monitorar a cada 500ms

    // Iniciar monitoramento do estado do simulador
    setInterval(() => {
      monitorarEstadoSimulador();
    }, 1000); // Monitorar estado a cada 1 segundo

    // Iniciar loop de an√°lise
    const intervaloAnalise = setInterval(() => {
      if (sistemaAnalise.analisesRealizadas < ANALISE_CONFIG.maxAnalises) {
        realizarAnaliseProfunda();
        atualizarPainel();
      } else {
        clearInterval(intervaloAnalise);
        console.log('‚úÖ Sistema de an√°lise completou', ANALISE_CONFIG.maxAnalises, 'an√°lises');
      }
    }, ANALISE_CONFIG.intervaloAnalise);

    // Atualizar painel mais frequentemente para tempo real
    setInterval(() => {
      atualizarPainel();
    }, 500); // Atualizar a cada 500ms para tempo real

    // Sincronizar m√©tricas periodicamente com simuladorRelatorio
    setInterval(() => {
      if (window.simuladorRelatorio) {
        // Sincronizar m√©tricas
        sistemaAnalise.metricas.fluxo.animaisProcessados = window.simuladorRelatorio.animaisProcessados || 0;
        sistemaAnalise.metricas.fluxo.brincosCadastrados = window.simuladorRelatorio.brincosCadastrados || 0;
        sistemaAnalise.metricas.fluxo.animaisComErro = window.simuladorRelatorio.animaisComErro || 0;
        sistemaAnalise.metricas.fluxo.brincosComErro = window.simuladorRelatorio.brincosComErro || 0;
        sistemaAnalise.metricas.fluxo.faseAtual = window.simuladorRelatorio.fase || 'INICIO';
        
        // Exportar quando finalizar
        if (window.simuladorRelatorio.fase === 'FINALIZADO' && !sistemaAnalise._exportado) {
          sistemaAnalise._exportado = true;
          setTimeout(() => {
            exportarAnalise();
          }, 5000);
        }
      }
    }, 2000); // Verificar a cada 2 segundos

    console.log('%c‚úÖ Sistema de An√°lise e Diagn√≥stico inicializado', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
    console.log('%cüîÑ Monitoramento em Tempo Real ATIVO', 'color: #2196F3; font-weight: bold; font-size: 12px;');
    console.log('üìä Configura√ß√£o:', ANALISE_CONFIG);
    console.log('‚è±Ô∏è Atualiza√ß√£o do painel: A cada 500ms');
    console.log('üîç Monitoramento DOM: A cada 500ms');
    console.log('üìà Monitoramento de estado: A cada 1 segundo');
    console.log('üí° Use window.exportarAnalise() para exportar dados de an√°lise');
    console.log('üí° Use window.sistemaAnalise para acessar dados em tempo real');
    console.log('üí° Use window.verificarSistemaAnalise() para verificar o status');
    console.log('üí° Use window.criarPainelAnalise() para criar o painel manualmente');
    
    // Verificar se o bot√£o foi criado ap√≥s um pequeno delay
    setTimeout(() => {
      const btn = document.getElementById('btnTogglePainel');
      if (btn) {
        console.log('%c‚úÖ Bot√£o de An√°lise criado com sucesso! Procure por "üìä An√°lise" no canto superior direito.', 'color: #2196F3; font-weight: bold;');
      } else {
        console.warn('%c‚ö†Ô∏è Bot√£o de An√°lise n√£o foi criado. Use window.criarPainelAnalise() para criar manualmente.', 'color: #FF9800; font-weight: bold;');
      }
    }, 1000);
  }

  // ========== EXPORTA√á√ÉO GLOBAL ==========
  window.sistemaAnalise = sistemaAnalise;
  window.exportarAnalise = exportarAnalise;
  window.gerarRelatorioAnalise = gerarRelatorioAnalise;
  window.criarPainelAnalise = criarPainelVisual; // Exportar fun√ß√£o para criar painel manualmente
  window.verificarSistemaAnalise = function() {
    console.log('üîç Verificando Sistema de An√°lise...');
    console.log('üìä Painel existe?', !!document.getElementById('painelAnaliseSimulador'));
    console.log('üîò Bot√£o existe?', !!document.getElementById('btnTogglePainel'));
    console.log('‚öôÔ∏è Config painel visual:', ANALISE_CONFIG.painelVisual);
    console.log('üìà An√°lises realizadas:', sistemaAnalise.analisesRealizadas);
    console.log('üí° Para criar o painel manualmente, use: window.criarPainelAnalise()');
  };

  // ========== INICIALIZAR QUANDO DOM ESTIVER PRONTO ==========
  function tentarInicializar() {
    try {
      if (document.body) {
        inicializarSistemaAnalise();
        console.log('‚úÖ Sistema de An√°lise inicializado com sucesso');
      } else {
        // Tentar novamente ap√≥s um delay
        setTimeout(tentarInicializar, 100);
      }
    } catch (error) {
      console.error('‚ùå Erro ao inicializar sistema de an√°lise:', error);
      // Tentar novamente ap√≥s um delay
      setTimeout(tentarInicializar, 500);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tentarInicializar);
  } else {
    // Se j√° carregou, tentar imediatamente e tamb√©m ap√≥s um pequeno delay
    tentarInicializar();
    setTimeout(tentarInicializar, 500);
  }

  // Garantir que o bot√£o seja criado mesmo ap√≥s alguns segundos (fallback)
  setTimeout(() => {
    const btnExistente = document.getElementById('btnTogglePainel');
    if (!btnExistente && ANALISE_CONFIG.painelVisual) {
      console.log('‚ö†Ô∏è Bot√£o de an√°lise n√£o encontrado, criando novamente...');
      criarPainelVisual();
    }
  }, 2000);

})();

// Garantir que a fun√ß√£o esteja dispon√≠vel mesmo ap√≥s o IIFE
console.log('‚úÖ Script do simulador carregado');
console.log('‚úÖ window.iniciarSimulador dispon√≠vel?', typeof window.iniciarSimulador);
console.log('‚úÖ window.executarSimulador dispon√≠vel?', typeof window.executarSimulador);

// Garantir que o bot√£o de an√°lise seja criado ap√≥s carregamento completo
window.addEventListener('load', function() {
  setTimeout(() => {
    const btnAnalise = document.getElementById('btnTogglePainel');
    if (!btnAnalise && typeof window.criarPainelAnalise === 'function') {
      console.log('üîÑ Tentando criar bot√£o de an√°lise ap√≥s carregamento completo...');
      window.criarPainelAnalise();
    }
    
    // Verificar novamente ap√≥s mais um segundo
    setTimeout(() => {
      const btnAnalise2 = document.getElementById('btnTogglePainel');
      if (btnAnalise2) {
        console.log('%c‚úÖ Bot√£o de An√°lise est√° vis√≠vel! Procure por "üìä An√°lise" no canto superior direito da tela.', 'color: #4CAF50; font-weight: bold; font-size: 14px;');
      } else {
        console.warn('%c‚ö†Ô∏è Bot√£o de An√°lise n√£o encontrado. Execute no console: window.criarPainelAnalise()', 'color: #FF9800; font-weight: bold;');
      }
    }, 1000);
  }, 1000);
});

// Teste direto: tentar chamar a fun√ß√£o se o bot√£o for clicado
window.testeSimulador = function() {
  console.log('üß™ TESTE: Verificando simulador...');
  console.log('üß™ window.iniciarSimulador:', typeof window.iniciarSimulador);
  console.log('üß™ window.executarSimulador:', typeof window.executarSimulador);
  
  if (typeof window.iniciarSimulador === 'function') {
    console.log('üß™ TESTE: Chamando window.iniciarSimulador()...');
    window.iniciarSimulador();
  } else {
    console.error('üß™ TESTE: window.iniciarSimulador n√£o est√° dispon√≠vel!');
  }
};

// Teste: verificar se o bot√£o existe e pode ser clicado
setTimeout(function() {
  const btn = document.getElementById('btnSimulador');
  if (btn) {
    console.log('‚úÖ Bot√£o encontrado ap√≥s 1 segundo:', btn);
    console.log('‚úÖ window.iniciarSimulador dispon√≠vel?', typeof window.iniciarSimulador);
    console.log('‚úÖ window.executarSimulador dispon√≠vel?', typeof window.executarSimulador);
    
    // Adicionar listener adicional como backup (se ainda n√£o foi adicionado)
    if (!btn._listenerAdicionado) {
      btn._listenerAdicionado = true;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Click no bot√£o (backup listener)');
        console.log('üîç window.iniciarSimulador:', typeof window.iniciarSimulador);
        
        if (typeof window.iniciarSimulador === 'function') {
          console.log('‚úÖ Chamando window.iniciarSimulador() do backup listener');
          window.iniciarSimulador();
        } else {
          console.error('‚ùå window.iniciarSimulador n√£o est√° dispon√≠vel no backup listener');
          alert('Erro: Fun√ß√£o do simulador n√£o encontrada. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ Backup listener adicionado ao bot√£o');
    }
  } else {
    console.error('‚ùå Bot√£o n√£o encontrado ap√≥s 1 segundo');
  }
}, 1000);
</script>
{% endblock %}
