{% extends "base_modulos_unificado.html" %}
<!-- 
================================================================================
  LAYOUT OFICIAL DO CURRAL INTELIGENTE - VERS√ÉO DEFINITIVA
================================================================================
  Este √© o LAYOUT OFICIAL e √öNICO do sistema Curral Inteligente.
  
  IMPORTANTE:
  - Este layout N√ÉO deve ser alterado em sua estrutura visual
  - Os cards e a disposi√ß√£o do layout est√£o DEFINITIVOS
  - Melhorias futuras devem ser feitas APENAS em:
    * Modais adicionais (JavaScript/CSS dos modais)
    * Programa√ß√£o/Backend (funcionalidades, l√≥gica)
    * N√£o alterar a estrutura HTML dos cards principais
  - Este arquivo √© usado por todas as views (v2, v3, v4)
  
  Data de Defini√ß√£o como Oficial: 19/12/2025
  √öltima Atualiza√ß√£o: {{ "now"|date:"Y-m-d H:i:s" }}
================================================================================
-->

{% block title %}Curral Inteligente ¬∑ {{ propriedade.nome_propriedade }}{% endblock %}

{% block extra_css %}
<style>
  /* ========== ESCONDER MENU LATERAL E OCUPAR TELA INTEIRA ========== */
  /* Regras com m√°xima especificidade para garantir que funcionem */
  html body.curral-v2,
  body.curral-v2 {
    overflow-x: hidden !important;
    max-width: 100vw;
  }
  
  /* Esconder sidebar completamente */
  html body.curral-v2 nav.sidebar,
  body.curral-v2 nav.sidebar,
  html body.curral-v2 .sidebar,
  body.curral-v2 .sidebar {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    opacity: 0 !important;
    position: absolute !important;
    left: -9999px !important;
  }
  
  /* Main content ocupar toda a largura */
  html body.curral-v2 main.main-content,
  body.curral-v2 main.main-content,
  html body.curral-v2 .main-content,
  body.curral-v2 .main-content {
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  /* Esconder bot√£o menu mobile */
  html body.curral-v2 .btn-menu-mobile,
  body.curral-v2 .btn-menu-mobile {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
  
  /* Header fixo ocupar toda a largura */
  html body.curral-v2 .header-fixo,
  body.curral-v2 .header-fixo {
    margin-left: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Esconder overlay do sidebar */
  html body.curral-v2 .sidebar-overlay,
  body.curral-v2 .sidebar-overlay {
    display: none !important;
    visibility: hidden !important;
  }
  
  /* Container principal ocupar toda a largura */
  html body.curral-v2 .container-fluid,
  body.curral-v2 .container-fluid,
  html body.curral-v2 .container,
  body.curral-v2 .container {
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  /* Ajustar wrapper do curral para ocupar toda a tela */
  body.curral-v2 .curral-v2-wrapper {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 auto !important;
    padding: 20px !important;
    box-sizing: border-box !important;
  }
  
  /* Regras adicionais para garantir que o sidebar seja escondido */
  body.curral-v2 nav.sidebar,
  body.curral-v2 .sidebar,
  body.curral-v2 .sidebar-nav,
  body.curral-v2 .sidebar-header,
  body.curral-v2 .sidebar-overlay,
  body.curral-v2 .btn-menu-mobile,
  body.curral-v2 .sidebar-mobile-actions {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
  }
  
  /* Garantir que o main-content n√£o tenha margem esquerda */
  body.curral-v2 main,
  body.curral-v2 .main-content,
  body.curral-v2 .content-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Garantir que o body n√£o tenha padding ou margin relacionado ao sidebar */
  body.curral-v2 {
    padding-left: 0 !important;
    margin-left: 0 !important;
  }
  
  /* Garantir que o container principal ocupe toda a largura */
  body.curral-v2 .container-fluid,
  body.curral-v2 .container {
    width: 100% !important;
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  /* Garantir que o content-area ocupe toda a largura */
  body.curral-v2 .content-area {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  /* Garantir que o header ocupe toda a largura */
  body.curral-v2 .header-fixo {
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Responsividade para cards de configura√ß√£o */
  @media (max-width: 1400px) {
    #gridConfigCards {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }
  
  @media (max-width: 768px) {
    #gridConfigCards {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* Responsividade para lotes na pesagem de aparta√ß√£o */
  @media (max-width: 1200px) {
    #balancaApartacaoContainer [style*="grid-template-columns: repeat(4, 1fr)"] {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }
  
  @media (max-width: 768px) {
    #balancaApartacaoContainer [style*="grid-template-columns: repeat(4, 1fr)"],
    #balancaApartacaoContainer [style*="grid-template-columns: repeat(2, 1fr)"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
<!-- Otimiza√ß√£o: Logs apenas em desenvolvimento -->
<script>
// ========== DEFINIR FUN√á√ïES DE MODAIS PRIMEIRO (ANTES DE QUALQUER USO) ==========
// Garantir que as fun√ß√µes estejam dispon√≠veis globalmente desde o in√≠cio
if (typeof window.abrirModalConfigPesagem === 'undefined') {
  window.abrirModalConfigPesagem = function() {
    console.log('üîµ [PESAGEM] Tentando abrir modal de configura√ß√£o...');
    try {
      const modal = document.getElementById('modalConfigPesagem');
      if (!modal) {
        console.error('‚ùå [PESAGEM] Modal n√£o encontrado!');
        alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
        return;
      }
      console.log('‚úÖ [PESAGEM] Modal encontrado, abrindo...');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.zIndex = '10000';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.background = 'rgba(0,0,0,0.5)';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      console.log('‚úÖ [PESAGEM] Modal aberto com sucesso!');
      
      // Ativar aba de pesagem
      setTimeout(() => {
        const tab = document.querySelector('.config-sessao-tab[data-tab="pesagem"]');
        if (tab) {
          document.querySelectorAll('.config-sessao-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          tab.style.borderBottomColor = '#1976d2';
          
          const contents = ['configPesagemContent', 'configSanitarioContent', 'configReprodutivoContent', 'configMovimentacaoContent'];
          contents.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
          });
          const pesagemContent = document.getElementById('configPesagemContent');
          if (pesagemContent) pesagemContent.style.display = 'block';
        }
      }, 100);
    } catch(e) {
      console.error('‚ùå Erro ao abrir modal de pesagem:', e);
      alert('Erro ao abrir modal: ' + e.message);
    }
  };
}

if (typeof window.abrirModalConfigSessao === 'undefined') {
  window.abrirModalConfigSessao = function(tipo) {
    console.log('üîµ [ABRIR MODAL CONFIG] Tipo:', tipo);
    try {
      const modalPesagem = document.getElementById('modalConfigPesagem');
      const modalReprodutivo = document.getElementById('modalConfigReprodutivo');
      
      if (modalPesagem) modalPesagem.style.display = 'none';
      if (modalReprodutivo && tipo !== 'reprodutivo' && tipo !== 'reproducao') {
        modalReprodutivo.style.display = 'none';
      }
      
      if (tipo === 'reprodutivo' || tipo === 'reproducao') {
        const modal = document.getElementById('modalConfigReprodutivo');
        if (modal) {
          modal.style.display = 'flex';
          modal.style.visibility = 'visible';
          modal.style.opacity = '1';
          modal.style.zIndex = '10000';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          console.log('‚úÖ [REPRODU√á√ÉO] Modal aberto!');
          return;
        }
      }
      
      if (modalPesagem) {
        modalPesagem.style.display = 'flex';
        modalPesagem.style.visibility = 'visible';
        modalPesagem.style.opacity = '1';
        modalPesagem.style.zIndex = '10000';
        
        setTimeout(() => {
          const tabMap = { 'sanitario': 'sanitario', 'movimentacao': 'movimentacao', 'pesagem': 'pesagem' };
          const tabId = tabMap[tipo] || 'pesagem';
          const tab = document.querySelector(`.config-sessao-tab[data-tab="${tabId}"]`);
          if (tab) {
            document.querySelectorAll('.config-sessao-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const contents = ['configPesagemContent', 'configSanitarioContent', 'configReprodutivoContent', 'configMovimentacaoContent'];
            contents.forEach(id => {
              const el = document.getElementById(id);
              if (el) el.style.display = 'none';
            });
            
            const contentMap = {
              'pesagem': 'configPesagemContent',
              'sanitario': 'configSanitarioContent',
              'reprodutivo': 'configReprodutivoContent',
              'movimentacao': 'configMovimentacaoContent'
            };
            
            const contentId = contentMap[tabId];
            if (contentId) {
              const content = document.getElementById(contentId);
              if (content) {
                content.style.display = 'block';
                if (tabId === 'sanitario' && typeof window.carregarConfigSanitario === 'function') {
                  setTimeout(() => window.carregarConfigSanitario(), 100);
                } else if (tabId === 'movimentacao' && typeof window.carregarConfigMovimentacao === 'function') {
                  setTimeout(() => window.carregarConfigMovimentacao(), 100);
                }
              }
            }
          }
        }, 150);
      } else {
        console.error('‚ùå Modal de pesagem n√£o encontrado!');
        alert('Erro: Modal de configura√ß√£o n√£o encontrado. Recarregue a p√°gina.');
      }
    } catch(e) {
      console.error('‚ùå Erro ao abrir modal:', e);
      alert('Erro ao abrir modal: ' + e.message);
    }
  };
}

console.log('‚úÖ Fun√ß√µes de modal definidas no in√≠cio do script!');

// ========== VERS√ÉO DO SCRIPT - FOR√áAR RECARREGAMENTO ==========
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  console.log('üîÑ Script carregado - VERS√ÉO: 2025-01-20-00:00-PESAGEM-FIX');
}

// ========== FUN√á√ÉO DIRETA NO ONCLICK (DEFINIDA IMEDIATAMENTE) ==========
// Esta fun√ß√£o DEVE estar dispon√≠vel ANTES do HTML ser renderizado
// ========== STUBS INICIAIS PARA FUN√á√ïES DE ESTAT√çSTICAS ==========
// Garantir que as fun√ß√µes existam globalmente antes de serem usadas
if (typeof window.adicionarAnimalTrabalhado === 'undefined') {
  window.adicionarAnimalTrabalhado = function(dados) {
    console.warn('‚ö†Ô∏è [STUB] window.adicionarAnimalTrabalhado ainda n√£o foi definida completamente');
    // Esta fun√ß√£o ser√° sobrescrita quando a vers√£o completa for carregada
  };
}

if (typeof window.adicionarAnimalTabelaRegistrados === 'undefined') {
  window.adicionarAnimalTabelaRegistrados = function(dadosAnimal) {
    console.warn('‚ö†Ô∏è [STUB] window.adicionarAnimalTabelaRegistrados ainda n√£o foi definida completamente');
    // Esta fun√ß√£o ser√° sobrescrita quando a vers√£o completa for carregada
  };
}

if (typeof window.atualizarEstatisticasAnimais === 'undefined') {
  window.atualizarEstatisticasAnimais = function() {
    console.warn('‚ö†Ô∏è [STUB] window.atualizarEstatisticasAnimais ainda n√£o foi definida completamente');
    // Esta fun√ß√£o ser√° sobrescrita quando a vers√£o completa for carregada
  };
}

if (typeof window.atualizarTabelaAnimaisRegistrados === 'undefined') {
  window.atualizarTabelaAnimaisRegistrados = function() {
    console.warn('‚ö†Ô∏è [STUB] window.atualizarTabelaAnimaisRegistrados ainda n√£o foi definida completamente');
    // Esta fun√ß√£o ser√° sobrescrita quando a vers√£o completa for carregada
  };
}

// ========== FUN√á√ÉO DE CADASTRO DE ESTOQUE - VERS√ÉO LIMPA ==========
// Fun√ß√£o ser√° definida completamente mais abaixo no c√≥digo

// ========== FUN√á√ÉO PARA CONVERTER SIGLA DE RA√áA PARA NOME COMPLETO ==========
window.obterNomeCompletoRaca = function(sigla) {
  if (!sigla) return '‚Äî';
  
  const siglaUpper = sigla.toUpperCase().trim();
  
  // Mapeamento de siglas para nomes completos
  const mapeamentoRacas = {
    'IN': 'Indubrasil',
    'NE': 'Nelore',
    'AN': 'Angus',
    'BR': 'Brahman',
    'GI': 'Gir',
    'GU': 'Guzer√°',
    'CA': 'Canchim',
    'SI': 'Simental',
    'LI': 'Limousin',
    'HE': 'Hereford',
    'CH': 'Charol√™s',
    'TA': 'Tabapu√£',
    'MA': 'Marchigiana',
    'MO': 'Mocho Nacional',
    'PO': 'Polled Hereford',
    'RE': 'Red Angus',
    'SH': 'Shorthorn',
    'HO': 'Holand√™s',
    'JE': 'Jersey',
    'GI': 'Gir',
    'GU': 'Guzer√°',
    'NE': 'Nelore',
    'IN': 'Indubrasil',
    'AN': 'Angus',
    'CA': 'Canchim',
    'TA': 'Tabapu√£',
    'MA': 'Marchigiana',
    'MO': 'Mocho Nacional',
    'PO': 'Polled Hereford',
    'RE': 'Red Angus',
    'SH': 'Shorthorn',
    'LI': 'Limousin',
    'HE': 'Hereford',
    'CH': 'Charol√™s',
    'BR': 'Brahman'
  };
  
  // Se a sigla existe no mapeamento, retornar nome completo
  if (mapeamentoRacas[siglaUpper]) {
    return mapeamentoRacas[siglaUpper];
  }
  
  // Se n√£o encontrar no mapeamento, verificar se j√° √© um nome completo (mais de 3 caracteres)
  if (sigla.length > 3) {
    return sigla; // Provavelmente j√° √© um nome completo
  }
  
  // Se for sigla desconhecida, retornar a sigla original
  return sigla;
};

// ========== ESTAT√çSTICAS DE PESAGEM EM TEMPO REAL ==========
if (typeof window.pesagensRegistradas === 'undefined') {
  window.pesagensRegistradas = [];
}

window.atualizarEstatisticasPesagem = function() {
  try {
    const pesagens = window.pesagensRegistradas || [];
    
    // Calcular estat√≠sticas gerais
    const quantidade = pesagens.length;
    const pesoTotal = pesagens.reduce((sum, p) => sum + (parseFloat(p.peso) || 0), 0);
    const mediaIndividual = quantidade > 0 ? pesoTotal / quantidade : 0;
    
    // Atualizar elementos gerais
    const quantidadeEl = document.getElementById('balancaQuantidadeAnimais');
    const pesoTotalEl = document.getElementById('balancaPesoTotal');
    const mediaEl = document.getElementById('balancaMediaIndividual');
    
    if (quantidadeEl) quantidadeEl.textContent = quantidade;
    if (pesoTotalEl) pesoTotalEl.textContent = pesoTotal.toFixed(1).replace('.', ',') + ' kg';
    if (mediaEl) {
      if (quantidade > 0) {
        mediaEl.textContent = mediaIndividual.toFixed(1).replace('.', ',') + ' kg';
      } else {
        mediaEl.textContent = '‚Äî';
      }
    }
    
    // Calcular por sexo
    const machos = pesagens.filter(p => {
      const sexo = (p.sexo || '').toUpperCase().trim();
      // Verificar se √© macho: M, MACHO, MALE, ou come√ßa com M
      return sexo === 'M' || sexo === 'MACHO' || sexo === 'MALE' || sexo.startsWith('M') || sexo.includes('MACHO');
    });
    const femeas = pesagens.filter(p => {
      const sexo = (p.sexo || '').toUpperCase().trim();
      // Verificar se √© f√™mea: F, F√äMEA, FEMEA, FEMALE, ou come√ßa com F
      return sexo === 'F' || sexo === 'F√äMEA' || sexo === 'FEMEA' || sexo === 'FEMALE' || sexo.startsWith('F') || sexo.includes('F√äMEA') || sexo.includes('FEMEA');
    });
    
    // Debug: log para verificar se est√° diferenciando corretamente
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('üìä [ESTAT√çSTICAS PESAGEM] Total:', pesagens.length, '| Machos:', machos.length, '| F√™meas:', femeas.length);
      if (pesagens.length > 0) {
        console.log('üìä [ESTAT√çSTICAS PESAGEM] Sexos encontrados:', pesagens.map(p => ({ id: p.animal_id, sexo: p.sexo })));
      }
    }
    
    const quantidadeMacho = machos.length;
    const pesoTotalMacho = machos.reduce((sum, p) => sum + (parseFloat(p.peso) || 0), 0);
    const mediaMacho = quantidadeMacho > 0 ? pesoTotalMacho / quantidadeMacho : 0;
    
    const quantidadeFemea = femeas.length;
    const pesoTotalFemea = femeas.reduce((sum, p) => sum + (parseFloat(p.peso) || 0), 0);
    const mediaFemea = quantidadeFemea > 0 ? pesoTotalFemea / quantidadeFemea : 0;
    
    // Atualizar elementos por sexo
    const quantidadeMachoEl = document.getElementById('balancaQuantidadeMacho');
    const pesoTotalMachoEl = document.getElementById('balancaPesoTotalMacho');
    const mediaMachoEl = document.getElementById('balancaMediaMacho');
    
    if (quantidadeMachoEl) quantidadeMachoEl.textContent = quantidadeMacho;
    if (pesoTotalMachoEl) pesoTotalMachoEl.textContent = pesoTotalMacho.toFixed(1).replace('.', ',');
    if (mediaMachoEl) {
      if (quantidadeMacho > 0) {
        mediaMachoEl.textContent = mediaMacho.toFixed(1).replace('.', ',') + ' kg';
      } else {
        mediaMachoEl.textContent = '‚Äî';
      }
    }
    
    const quantidadeFemeaEl = document.getElementById('balancaQuantidadeFemea');
    const pesoTotalFemeaEl = document.getElementById('balancaPesoTotalFemea');
    const mediaFemeaEl = document.getElementById('balancaMediaFemea');
    
    if (quantidadeFemeaEl) quantidadeFemeaEl.textContent = quantidadeFemea;
    if (pesoTotalFemeaEl) pesoTotalFemeaEl.textContent = pesoTotalFemea.toFixed(1).replace('.', ',');
    if (mediaFemeaEl) {
      if (quantidadeFemea > 0) {
        mediaFemeaEl.textContent = mediaFemea.toFixed(1).replace('.', ',') + ' kg';
      } else {
        mediaFemeaEl.textContent = '‚Äî';
      }
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao atualizar estat√≠sticas de pesagem:', error);
  }
};

window.gravarPesagemDireto = async function() {
  console.log('üîòüîòüîò [ONCLICK DIRETO] BOT√ÉO GRAVAR CLICADO! üîòüîòüîò');
  
  const pesoInput = document.getElementById('pesoValorV2');
  const brincoInput = document.getElementById('brincoInputV2');
  
  if (!pesoInput || !brincoInput) {
    console.error('‚ùå Campos n√£o encontrados!');
    alert('Erro: Campos n√£o encontrados.');
    return;
  }
  
  // Captura peso
  let peso = pesoInput.value || '';
  peso = peso.toString().trim().replace(/kg/gi, '').replace(/\s/g, '');
  
  const brinco = brincoInput.value.trim();
  
  console.log('üìä [ONCLICK DIRETO] Dados:', { peso, brinco });
  
  if (!peso || peso === '0') {
    alert('Informe um peso v√°lido.');
    pesoInput.focus();
    return;
  }
  
  const pesoNumero = parseFloat(peso.replace(',', '.'));
  if (isNaN(pesoNumero) || pesoNumero <= 0) {
    alert('O peso deve ser um n√∫mero maior que zero.');
    pesoInput.focus();
    return;
  }
  
  if (!brinco) {
    alert('Identifique um animal primeiro.');
    brincoInput.focus();
    return;
  }
  
  // Chama fun√ß√£o de salvar ou executa diretamente
  if (typeof window.salvarPesagemBackendV2 === 'function') {
    console.log('üíæ [ONCLICK DIRETO] Chamando salvarPesagemBackendV2...');
    try {
      const resultado = await window.salvarPesagemBackendV2();
      console.log('‚úÖ [ONCLICK DIRETO] Resultado:', resultado);
    } catch (error) {
      console.error('‚ùå [ONCLICK DIRETO] Erro:', error);
      alert('Erro ao salvar: ' + error.message);
    }
  } else {
    console.warn('‚ö†Ô∏è [ONCLICK DIRETO] Fun√ß√£o salvarPesagemBackendV2 n√£o encontrada, salvando diretamente...');
    
    // Salvar diretamente sem depender da fun√ß√£o
    try {
      const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
      const propriedadeId = urlMatch ? urlMatch[1] : null;
      
      if (!propriedadeId) {
        alert('Erro: N√£o foi poss√≠vel identificar a propriedade.');
        return;
      }
      
      // Buscar animal pelo brinco se necess√°rio
      let animalId = null;
      const brincoInput = document.getElementById('brincoInputV2');
      
      if (brincoInput && brincoInput.value) {
        try {
          const response = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'animal' && data.dados) {
              animalId = data.dados.id;
              window.animalAtualV2 = data.dados;
              console.log('‚úÖ [GRAVAR PESAGEM] window.animalAtualV2 definido:', window.animalAtualV2);
              // Habilitar bot√£o Finalizar e Gravar imediatamente
              setTimeout(() => {
                const btnFinalizar = document.getElementById('btnFinalizarGravarV2');
                if (btnFinalizar && window.animalAtualV2 && window.animalAtualV2.id) {
                  btnFinalizar.disabled = false;
                  btnFinalizar.style.opacity = '1';
                  btnFinalizar.style.cursor = 'pointer';
                }
                if (typeof window.atualizarBotaoFinalizarV2 === 'function') {
                  window.atualizarBotaoFinalizarV2();
                }
              });
            }
          }
        } catch (error) {
          console.error('Erro ao buscar animal:', error);
        }
      }
      
      if (!animalId) {
        alert('Erro: Animal n√£o encontrado. Verifique o brinco.');
        return;
      }
      
      // Obter CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // Salvar pesagem
      console.log('üíæ [ONCLICK DIRETO] Salvando pesagem diretamente...', { animalId, peso: pesoNumero });
      
      const response = await fetch(`/propriedade/${propriedadeId}/curral/api/pesagem/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          animal_id: animalId,
          brinco: brinco,
          peso: pesoNumero
        })
      });
      
      const responseData = await response.json();
      
      if (response.ok) {
        console.log('‚úÖ [ONCLICK DIRETO] Pesagem salva com sucesso!', responseData);
        
        // ========== IMPORTANTE: Atualizar contadores e tabela ap√≥s gravar pesagem ==========
        // Garantir que window.estatisticasAnimais est√° inicializado
        if (typeof window.estatisticasAnimais === 'undefined') {
          window.estatisticasAnimais = {
            identificados: 0,
            cadastrados: 0,
            processados: 0
          };
        }
        
        // Adicionar aos animais trabalhados (incrementa Processados)
        if (window.animalAtualV2 && window.animalAtualV2.id) {
          const pesoFormatado = pesoNumero.toFixed(1);
          
          // Registrar pesagem para estat√≠sticas
          if (!window.pesagensRegistradas) {
            window.pesagensRegistradas = [];
          }
          
          // Verificar se j√° existe pesagem para este animal (evitar duplicatas)
          const existePesagem = window.pesagensRegistradas.find(p => 
            p.animal_id === window.animalAtualV2.id && 
            Math.abs(parseFloat(p.peso) - pesoNumero) < 0.1
          );
          
          if (!existePesagem) {
            const sexoAnimal = window.animalAtualV2.sexo || '';
            console.log('üìä [GRAVAR PESAGEM] Animal ID:', window.animalAtualV2.id, '| Sexo capturado:', sexoAnimal);
            
            window.pesagensRegistradas.push({
              animal_id: window.animalAtualV2.id,
              peso: pesoNumero,
              sexo: sexoAnimal,
              data: new Date().toISOString()
            });
            
            // Atualizar estat√≠sticas de pesagem
            if (typeof window.atualizarEstatisticasPesagem === 'function') {
              window.atualizarEstatisticasPesagem();
            }
            
            // Atualizar progresso da sess√£o
            if (typeof window.atualizarProgressoSessao === 'function') {
              setTimeout(() => {
                window.atualizarProgressoSessao();
              }, 500);
            }
          }
          
          console.log('üìä [GRAVAR PESAGEM] Atualizando contadores e tabela...');
          
          // Fun√ß√£o auxiliar para tentar chamar fun√ß√£o com retry
          const tentarChamarFuncao = async (nomeFuncao, args, maxTentativas = 10) => {
            for (let i = 0; i < maxTentativas; i++) {
              // Verificar se a fun√ß√£o existe e n√£o √© apenas um stub
              if (typeof window[nomeFuncao] === 'function') {
                // Verificar se n√£o √© apenas o stub inicial (verificando se tem a l√≥gica completa)
                try {
                  // Tentar chamar a fun√ß√£o
                  const resultado = window[nomeFuncao](...args);
                  // Se retornou promise, aguardar
                  if (resultado && typeof resultado.then === 'function') {
                    await resultado;
                  }
                  console.log(`‚úÖ Fun√ß√£o ${nomeFuncao} chamada com sucesso (tentativa ${i + 1})`);
                  return true;
                } catch (error) {
                  console.error(`‚ùå Erro ao chamar ${nomeFuncao}:`, error);
                  // Se for erro de fun√ß√£o n√£o implementada, continuar tentando
                  if (i < maxTentativas - 1) {
                    await new Promise(resolve => setTimeout(resolve, 150));
                    continue;
                  }
                  return false;
                }
              } else {
                if (i < maxTentativas - 1) {
                  console.log(`‚è≥ Fun√ß√£o ${nomeFuncao} n√£o encontrada, aguardando... (tentativa ${i + 1}/${maxTentativas})`);
                  await new Promise(resolve => setTimeout(resolve, 150));
                } else {
                  console.error(`‚ùå Fun√ß√£o ${nomeFuncao} n√£o encontrada ap√≥s ${maxTentativas} tentativas!`);
                  // Tentar atualizar manualmente como √∫ltimo recurso
                  if (nomeFuncao === 'atualizarEstatisticasAnimais') {
                    console.log('üîÑ Tentando atualizar estat√≠sticas manualmente como fallback...');
                    atualizarEstatisticasManualmente();
                  }
                  return false;
                }
              }
            }
          };
          
          // Fun√ß√£o fallback para atualizar estat√≠sticas manualmente
          const atualizarEstatisticasManualmente = function() {
            if (!window.estatisticasAnimais) {
              window.estatisticasAnimais = { identificados: 0, cadastrados: 0, processados: 0 };
            }
            
            const stats = window.estatisticasAnimais;
            const total = (stats.identificados || 0) + (stats.cadastrados || 0);
            
            const totalEl = document.getElementById('statsTotalTrabalhados');
            const identificadosEl = document.getElementById('statsIdentificados');
            const cadastradosEl = document.getElementById('statsCadastrados');
            const processadosEl = document.getElementById('statsProcessados');
            
            if (totalEl) totalEl.textContent = total;
            if (identificadosEl) identificadosEl.textContent = stats.identificados || 0;
            if (cadastradosEl) cadastradosEl.textContent = stats.cadastrados || 0;
            if (processadosEl) processadosEl.textContent = stats.processados || 0;
            
            console.log('‚úÖ Estat√≠sticas atualizadas manualmente (fallback)');
          };
          
          // Tentar adicionar aos animais trabalhados (incrementa Processados)
          const adicionouTrabalhado = await tentarChamarFuncao('adicionarAnimalTrabalhado', [{
            sisbov: window.animalAtualV2.codigo_sisbov || window.animalAtualV2.numero_brinco || '',
            brinco: window.animalAtualV2.numero_manejo || window.animalAtualV2.numero_brinco || '',
            peso: pesoFormatado,
            tipo: 'pesagem',
            detalhes: `${typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(window.animalAtualV2.raca) : (window.animalAtualV2.raca || '')} ${window.animalAtualV2.sexo === 'M' ? 'Macho' : window.animalAtualV2.sexo === 'F' ? 'F√™mea' : ''} ¬∑ ${pesoFormatado} kg`.trim(),
            data: new Date().toLocaleString('pt-BR')
          }]);
          
          // Se n√£o conseguiu adicionar aos trabalhados, fazer manualmente
          if (!adicionouTrabalhado) {
            console.log('üîÑ Tentando adicionar animal aos trabalhados manualmente (fallback)...');
            if (!window.animaisTrabalhados) {
              window.animaisTrabalhados = [];
            }
            if (!window.estatisticasAnimais) {
              window.estatisticasAnimais = { identificados: 0, cadastrados: 0, processados: 0 };
            }
            // Incrementar processados manualmente
            window.estatisticasAnimais.processados = (window.estatisticasAnimais.processados || 0) + 1;
            console.log('‚úÖ Processados incrementado manualmente:', window.estatisticasAnimais.processados);
          }
          
          // Tentar adicionar √† tabela de registrados
          const adicionouTabela = await tentarChamarFuncao('adicionarAnimalTabelaRegistrados', [window.animalAtualV2]);
          
          // Se n√£o conseguiu adicionar √† tabela, fazer manualmente
          if (!adicionouTabela) {
            console.log('üîÑ Tentando adicionar animal √† tabela manualmente (fallback)...');
            if (!window.animaisRegistradosTabela) {
              window.animaisRegistradosTabela = [];
            }
            // Verificar se j√° existe
            const existe = window.animaisRegistradosTabela.find(a => a.id === window.animalAtualV2.id);
            if (!existe) {
              window.animaisRegistradosTabela.push({
                id: window.animalAtualV2.id,
                codigo_eletronico: window.animalAtualV2.codigo_eletronico || '‚Äî',
                codigo_sisbov: window.animalAtualV2.codigo_sisbov || window.animalAtualV2.numero_brinco || '‚Äî',
                numero_manejo: window.animalAtualV2.numero_manejo || '‚Äî',
                raca: window.animalAtualV2.raca || '‚Äî',
                sexo: window.animalAtualV2.sexo || '‚Äî',
                data_nascimento: window.animalAtualV2.data_nascimento || window.animalAtualV2.data_nascimento_format || '‚Äî',
                categoria: window.animalAtualV2.categoria || '‚Äî',
                lote_atual: window.animalAtualV2.lote_atual || '‚Äî',
                situacao_bnd: window.animalAtualV2.situacao_bnd || 'NAO_CONFORME',
                data_registro: new Date().toLocaleString('pt-BR')
              });
              
              // Atualizar tabela manualmente
              const tbody = document.getElementById('tabelaAnimaisRegistradosBody');
              if (tbody) {
                let html = '';
                window.animaisRegistradosTabela.forEach(animal => {
                  const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(animal.raca) : (animal.raca || '‚Äî');
                  const racaSexo = `${racaCompleta} / ${animal.sexo || '‚Äî'}`;
                  html += `
                    <tr style="font-size: 0.85rem;">
                      <td>${animal.codigo_eletronico || '‚Äî'}</td>
                      <td style="color: #2196F3; font-weight: 500;">${animal.codigo_sisbov || '‚Äî'}</td>
                      <td style="font-weight: 700;">${animal.numero_manejo || '‚Äî'}</td>
                      <td>${racaSexo}</td>
                      <td>${animal.data_nascimento || '‚Äî'}</td>
                      <td>${animal.categoria || '‚Äî'}</td>
                      <td>${animal.lote_atual || '‚Äî'}</td>
                      <td>Conforme BND</td>
                    </tr>
                  `;
                });
                tbody.innerHTML = html;
                console.log('‚úÖ Tabela atualizada manualmente (fallback). Total:', window.animaisRegistradosTabela.length);
              }
            }
          }
          
          // Tentar atualizar estat√≠sticas visuais
          const atualizouEstatisticas = await tentarChamarFuncao('atualizarEstatisticasAnimais', []);
          
          // Se n√£o conseguiu atualizar estat√≠sticas, fazer manualmente
          if (!atualizouEstatisticas) {
            console.log('üîÑ Tentando atualizar estat√≠sticas manualmente (fallback)...');
            atualizarEstatisticasManualmente();
          }
        } else {
          console.error('‚ùå window.animalAtualV2 n√£o encontrado para atualizar contadores!');
        }
        
        // Mostrar notifica√ß√£o de sucesso
        if (typeof mostrarToast === 'function') {
          mostrarToast('Pesagem registrada com sucesso!', 'success');
        } else {
          alert('Pesagem registrada com sucesso!');
        }
        
        // Registrar eventos configurados automaticamente
        if (window.animalAtualV2 && window.animalAtualV2.id) {
          setTimeout(() => {
            if (typeof window.registrarEventosConfigurados === 'function') {
              window.registrarEventosConfigurados(window.animalAtualV2.id);
            }
          }, 500);
        }
        
        // Atualizar campos visualmente
        const novoPeso = parseFloat(responseData.novo_peso || responseData.peso || pesoNumero);
        const dataAtual = new Date();
        const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' ' + dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        // ========== ATUALIZA√á√ÉO VISUAL COMPLETA ==========
        console.log('üé® [ONCLICK DIRETO] Atualizando TODOS os campos visualmente...');
        
        const pesoRegistrado = document.getElementById('pesoRegistradoV2');
        const pesoUltimo = document.getElementById('pesoUltimoValorV2');
        const pesoData = document.getElementById('pesoUltimoDataV2');
        const pesoDias = document.getElementById('pesoDiasV2');
        const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
        const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
        const scannerUltimoPeso = document.getElementById('scannerUltimoPesoV2');
        
        const pesoFormatado = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
        
        // 1. Peso Registrado (em verde)
        if (pesoRegistrado) {
          pesoRegistrado.textContent = pesoFormatado;
          pesoRegistrado.innerText = pesoFormatado;
          pesoRegistrado.style.color = '#4caf50';
          pesoRegistrado.style.fontWeight = '600';
          pesoRegistrado.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Peso Registrado" atualizado:', pesoFormatado);
          
          // Mostrar bot√£o de editar
          if (typeof atualizarBotaoEditarPesagem === 'function') {
            atualizarBotaoEditarPesagem();
          }
        } else {
          console.error('‚ùå Campo pesoRegistradoV2 n√£o encontrado!');
        }
        
        // 2. √öltimo Peso (N√ÉO atualizar aqui - ser√° atualizado ap√≥s recarregar dados do animal)
        // O "√öltimo Peso" deve mostrar o peso da pesagem ANTERIOR, n√£o a atual
        // Por enquanto, manter o valor anterior ou limpar
        if (pesoUltimo) {
          // N√£o atualizar ainda - ser√° atualizado ap√≥s recarregar dados do animal
          console.log('‚è≥ Campo "√öltimo Peso" ser√° atualizado ap√≥s recarregar dados do animal');
        }
        
        // 3. Data √öltima Pesagem
        if (pesoData) {
          pesoData.textContent = dataFormatada;
          pesoData.innerText = dataFormatada;
          pesoData.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Data √öltima Pesagem" atualizado:', dataFormatada);
        }
        
        // 4. Dias desde a √∫ltima
        if (pesoDias) {
          pesoDias.textContent = '0 dias';
          pesoDias.innerText = '0 dias';
          pesoDias.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Dias desde a √∫ltima" atualizado: 0 dias');
        }
        
        // 5. Scanner √öltimo Peso
        if (scannerUltimoPeso) {
          scannerUltimoPeso.textContent = pesoFormatado;
          scannerUltimoPeso.innerText = pesoFormatado;
        }
        
        // ========== MELHORIA: Limpar campos e focar no brinco para pr√≥xima leitura ==========
        // Aguardar um momento para o usu√°rio ver a mensagem de sucesso
        setTimeout(async () => {
          console.log('üîÑ [GRAVAR PESAGEM] Limpando campos e preparando para pr√≥xima leitura...');
          
          // Limpar brinco e peso
          if (brincoInput) {
            brincoInput.value = '';
            console.log('‚úÖ Campo brinco limpo');
          }
          
          if (pesoInput) {
            pesoInput.value = '';
            console.log('‚úÖ Campo peso limpo');
          }
          
          // Limpar resumo do animal
          if (typeof window.atualizarScannerResumoV2 === 'function') {
            window.atualizarScannerResumoV2(null);
            console.log('‚úÖ Resumo do animal limpo');
          }
          
          // Limpar campos de pesagem
          if (pesoRegistrado) pesoRegistrado.textContent = '‚Äî';
          if (pesoUltimo) pesoUltimo.textContent = '‚Äî';
          if (pesoData) pesoData.textContent = '‚Äî';
          if (pesoDias) pesoDias.textContent = '‚Äî';
          if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
          if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
          
          // Limpar vari√°vel global do animal
          window.animalAtualV2 = null;
          if (typeof currentAnimalV2 !== 'undefined') {
            currentAnimalV2 = null;
          }
          
          // Desabilitar campo de peso
          if (typeof window.desabilitarCampoPesoV2 === 'function') {
            window.desabilitarCampoPesoV2();
          }
          
          // Limpar sele√ß√µes de manejos
          if (typeof window.limparSelecoesManejosV2 === 'function') {
            window.limparSelecoesManejosV2();
          }
          
          // Focar no campo de brinco para pr√≥xima leitura
          if (brincoInput) {
            setTimeout(() => {
              brincoInput.focus();
              brincoInput.select();
              console.log('‚úÖ Foco retornado para campo de brinco');
              
              // Tentar novamente se o foco n√£o funcionou
              setTimeout(() => {
                if (document.activeElement !== brincoInput) {
                  brincoInput.focus();
                  console.log('üîÑ Tentativa adicional de foco no brinco');
                }
              }, 100);
            }, 100);
          }
          
          console.log('‚úÖ Campos limpos e pronto para pr√≥xima leitura!');
        }, 800); // Aguardar 800ms para o usu√°rio ver a mensagem de sucesso
        
        // 6. Ganhos (ser√£o calculados ap√≥s recarregar dados do animal)
        // Por enquanto, limpar ou manter valores anteriores
        if (pesoGanhoTotal) {
          // Tentar calcular se temos dados do animal
          const animalAtual = window.animalAtualV2;
          if (animalAtual && animalAtual.pesagem_anterior && animalAtual.pesagem_anterior.peso) {
            const pesoAnterior = parseFloat(animalAtual.pesagem_anterior.peso);
            const ganhoTotal = novoPeso - pesoAnterior;
            pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
            console.log('‚úÖ Campo "Ganho Total" atualizado:', ganhoTotal);
          } else {
            pesoGanhoTotal.textContent = '‚Äî';
          }
        }
        
        if (pesoGanhoDia) {
          // Ser√° calculado ap√≥s recarregar dados do animal
          pesoGanhoDia.textContent = '‚Äî';
        }
        
        // Recarregar dados do animal para atualizar ganhos e hist√≥rico completo
        setTimeout(async () => {
          if (brincoInput && brincoInput.value) {
            try {
              console.log('üîÑ [ONCLICK DIRETO] Recarregando dados do animal para atualizar hist√≥rico...');
              const responseAnimal = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
              if (responseAnimal.ok) {
                const dataAnimal = await responseAnimal.json();
                if (dataAnimal.status === 'animal' && dataAnimal.dados) {
                  window.animalAtualV2 = dataAnimal.dados;
                  
                  // Atualizar ganhos com dados atualizados
                  const dados = dataAnimal.dados;
                  console.log('üìä [ONCLICK DIRETO] Dados do animal recarregados:', dados);
                  
                  // O backend retorna pesagem_anterior como objeto {peso, data, data_hora}
                  const pesagemAnterior = dados.pesagem_anterior;
                  const pesoAnterior = pesagemAnterior && pesagemAnterior.peso ? parseFloat(pesagemAnterior.peso) : null;
                  // Usar data_hora se dispon√≠vel (tem hora), sen√£o usar data (s√≥ data)
                  const dataPesoAnterior = pesagemAnterior && pesagemAnterior.data_hora ? pesagemAnterior.data_hora : (pesagemAnterior && pesagemAnterior.data ? pesagemAnterior.data : null);
                  
                  // ========== ATUALIZAR "√öLTIMO PESO" COM PESO ANTERIOR ==========
                  // O "√öltimo Peso" deve mostrar o peso da pesagem ANTERIOR, n√£o a atual
                  if (pesoUltimo) {
                    if (pesoAnterior !== null && !isNaN(pesoAnterior)) {
                      const pesoAnteriorFormatado = `${pesoAnterior.toFixed(1).replace('.', ',')} kg`;
                      pesoUltimo.textContent = pesoAnteriorFormatado;
                      pesoUltimo.innerText = pesoAnteriorFormatado;
                      console.log('‚úÖ Campo "√öltimo Peso" atualizado com peso anterior:', pesoAnteriorFormatado);
                    } else {
                      // Se n√£o h√° peso anterior, mostrar o peso atual como √∫ltimo
                      pesoUltimo.textContent = pesoFormatado;
                      pesoUltimo.innerText = pesoFormatado;
                      console.log('‚ö†Ô∏è Sem peso anterior, mostrando peso atual como √∫ltimo:', pesoFormatado);
                    }
                  }
                  
                  // Atualizar data da √∫ltima pesagem anterior
                  if (pesoData && dataPesoAnterior) {
                    try {
                      // Se dataPesoAnterior j√° tem hora (formato ISO completo), usar diretamente
                      let dataAnteriorObj;
                      if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
                        // J√° tem hora no formato ISO ou datetime
                        dataAnteriorObj = new Date(dataPesoAnterior);
                      } else {
                        // S√≥ tem data, adicionar hora padr√£o (mas isso n√£o √© ideal)
                        dataAnteriorObj = new Date(dataPesoAnterior + 'T00:00:00');
                      }
                      
                      if (!isNaN(dataAnteriorObj.getTime())) {
                        const dataAnteriorFormatada = dataAnteriorObj.toLocaleDateString('pt-BR') + ' ' + dataAnteriorObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        pesoData.textContent = dataAnteriorFormatada;
                        pesoData.innerText = dataAnteriorFormatada;
                        console.log('‚úÖ Campo "Data √öltima Pesagem" atualizado com data anterior:', dataPesoAnterior, '‚Üí', dataAnteriorFormatada);
                      }
                    } catch (error) {
                      console.warn('‚ö†Ô∏è Erro ao formatar data anterior:', error);
                    }
                  }
                  
                  // Atualizar dias desde a √∫ltima pesagem anterior
                  if (pesoDias && dataPesoAnterior) {
                    try {
                      // Usar data_hora se dispon√≠vel para c√°lculo de dias
                      let dataAnterior;
                      if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
                        dataAnterior = new Date(dataPesoAnterior);
                      } else {
                        dataAnterior = new Date(dataPesoAnterior + 'T00:00:00');
                      }
                      const dataAtual = new Date();
                      const diffMs = dataAtual.getTime() - dataAnterior.getTime();
                      const dias = Math.max(0, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
                      pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
                      pesoDias.innerText = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
                      console.log('‚úÖ Campo "Dias desde a √∫ltima" atualizado:', dias, 'dias');
                    } catch (error) {
                      console.warn('‚ö†Ô∏è Erro ao calcular dias:', error);
                    }
                  }
                  
                  console.log('üìä [ONCLICK DIRETO] Dados de ganho:', {
                    novoPeso: novoPeso,
                    pesoAnterior: pesoAnterior,
                    dataPesoAnterior: dataPesoAnterior,
                    pesagemAnterior: pesagemAnterior
                  });
                  
                  // Calcular Ganho Total
                  if (pesoGanhoTotal && pesoAnterior !== null && !isNaN(pesoAnterior)) {
                    const ganhoTotal = novoPeso - pesoAnterior;
                    pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
                    console.log('‚úÖ [ONCLICK DIRETO] Ganho Total calculado:', ganhoTotal);
                  } else if (pesoGanhoTotal) {
                    pesoGanhoTotal.textContent = '‚Äî';
                    console.log('‚ö†Ô∏è [ONCLICK DIRETO] N√£o foi poss√≠vel calcular Ganho Total (sem peso anterior)');
                  }
                  
                  // Calcular Ganho Di√°rio M√©dio
                  if (pesoGanhoDia && pesoAnterior !== null && !isNaN(pesoAnterior) && dataPesoAnterior) {
                    try {
                      // Usar data_hora se dispon√≠vel para c√°lculo mais preciso
                      let dataAnterior;
                      if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
                        dataAnterior = new Date(dataPesoAnterior);
                      } else {
                        dataAnterior = new Date(dataPesoAnterior + 'T00:00:00');
                      }
                      
                      const dataAtual = new Date();
                      
                      if (!isNaN(dataAnterior.getTime()) && !isNaN(dataAtual.getTime())) {
                        const diffMs = dataAtual.getTime() - dataAnterior.getTime();
                        const dias = Math.max(1, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
                        const ganhoTotal = novoPeso - pesoAnterior;
                        const ganhoDia = ganhoTotal / dias;
                        
                        pesoGanhoDia.textContent = `${ganhoDia >= 0 ? '+' : ''}${ganhoDia.toFixed(2).replace('.', ',')} kg/dia`;
                        if (pesoDias) {
                          pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
                          pesoDias.innerText = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
                        }
                        console.log('‚úÖ [ONCLICK DIRETO] Ganho Di√°rio calculado:', ganhoDia, 'kg/dia em', dias, 'dias');
                      } else {
                        console.warn('‚ö†Ô∏è [ONCLICK DIRETO] Datas inv√°lidas para calcular ganho di√°rio');
                        if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
                        if (pesoDias) pesoDias.textContent = '‚Äî';
                      }
                    } catch (error) {
                      console.error('‚ùå [ONCLICK DIRETO] Erro ao calcular ganho di√°rio:', error);
                      if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
                      if (pesoDias) pesoDias.textContent = '‚Äî';
                    }
                  } else if (pesoGanhoDia) {
                    pesoGanhoDia.textContent = '‚Äî';
                    console.log('‚ö†Ô∏è [ONCLICK DIRETO] N√£o foi poss√≠vel calcular Ganho Di√°rio (sem dados anteriores)');
                  }
                  
                  console.log('‚úÖ [ONCLICK DIRETO] Hist√≥rico completo atualizado!');
                  
                  // Atualizar gr√°fico de evolu√ß√£o
                  if (typeof atualizarGraficoEvolucaoPeso === 'function') {
                    atualizarGraficoEvolucaoPeso(dataAnimal.dados);
                  }
                }
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è [ONCLICK DIRETO] Erro ao recarregar hist√≥rico:', error);
            }
          }
        }, 500);
        
        // Feedback visual
        const gravarBtn = document.getElementById('pesoGravarBtnV2');
        if (gravarBtn) {
          const originalText = gravarBtn.innerHTML;
          gravarBtn.innerHTML = '<i class="fas fa-check-circle"></i> Gravado!';
          gravarBtn.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
          setTimeout(() => {
            gravarBtn.innerHTML = originalText;
            gravarBtn.style.background = '';
          }, 3000);
        }
        
        alert('Pesagem gravada com sucesso!');
        console.log('‚úÖ [ONCLICK DIRETO] Campos atualizados visualmente!');
      } else {
        const mensagemErro = responseData.mensagem || responseData.status || 'Erro desconhecido';
        console.error('‚ùå [ONCLICK DIRETO] Erro ao salvar:', responseData);
        alert(`Erro ao salvar pesagem: ${mensagemErro}`);
      }
    } catch (error) {
      console.error('‚ùå [ONCLICK DIRETO] Erro ao salvar:', error);
      alert('Erro ao conectar com o servidor: ' + error.message);
    }
  }
};

console.log('‚úÖ Fun√ß√£o window.gravarPesagemDireto definida e dispon√≠vel!');
console.log('üîç Verifica√ß√£o:', typeof window.gravarPesagemDireto, window.gravarPesagemDireto ? 'FUN√á√ÉO OK ‚úÖ' : 'ERRO ‚ùå');

// ========== FUN√á√ÉO SIMULADOR (DEFINIDA IMEDIATAMENTE - STUB) ==========
// Esta fun√ß√£o ser√° sobrescrita pelo c√≥digo completo mais abaixo
window.executarSimulador = async function() {
  console.log('‚ö†Ô∏è Simulador ainda n√£o foi completamente carregado. Aguarde...');
  alert('Simulador ainda est√° carregando. Aguarde alguns segundos e tente novamente.');
};

console.log('‚úÖ Fun√ß√£o window.executarSimulador (stub) definida e dispon√≠vel!');

// ========== FUN√á√ÉO FINALIZAR E GRAVAR (DEFINIDA IMEDIATAMENTE) ==========
// Esta fun√ß√£o DEVE estar dispon√≠vel ANTES do HTML ser renderizado
window.finalizarEGravarManejos = async function() {
  console.log('üéØ [FINALIZAR E GRAVAR] Fun√ß√£o chamada!');
  
  // Verificar se a fun√ß√£o completa est√° dispon√≠vel (ser√° definida mais abaixo)
  if (typeof window._finalizarEGravarManejosCompleto === 'function') {
    return await window._finalizarEGravarManejosCompleto();
  }
  
  // Fallback b√°sico se a fun√ß√£o completa n√£o estiver dispon√≠vel
  const animalAtual = window.animalAtualV2;
  const brincoInput = document.getElementById('brincoInputV2');
  const pesoValor = document.getElementById('pesoValorV2');
  
  if (!animalAtual || !animalAtual.id) {
    alert('Animal n√£o identificado. Identifique o animal primeiro.');
    return;
  }
  
  // Se houver peso, gravar primeiro
  if (pesoValor && pesoValor.value) {
    const pesoTexto = pesoValor.value.replace(',', '.').trim();
    const peso = parseFloat(pesoTexto);
    if (!isNaN(peso) && peso > 0) {
      if (typeof window.gravarPesagemDireto === 'function') {
        await window.gravarPesagemDireto();
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }
  }
  
  alert('Registro gravado! (Fun√ß√£o completa ainda n√£o carregada)');
};

console.log('‚úÖ Fun√ß√£o window.finalizarEGravarManejos definida e dispon√≠vel!');
console.log('üîç Verifica√ß√£o:', typeof window.finalizarEGravarManejos, window.finalizarEGravarManejos ? 'FUN√á√ÉO OK ‚úÖ' : 'ERRO ‚ùå');

// Garantir que a fun√ß√£o est√° dispon√≠vel globalmente
if (typeof window.gravarPesagemDireto !== 'function') {
  console.error('‚ùå ERRO CR√çTICO: Fun√ß√£o gravarPesagemDireto n√£o foi definida!');
}

// ========== FUN√á√ïES PARA HABILITAR/DESABILITAR CAMPO DE PESO ==========
window.habilitarCampoPesoV2 = function() {
  // Verificar qual tipo de pesagem est√° ativo
  const config = window.configPesagemSalva;
  const isApartacao = config && config.tipoPesagem === 'aparte';
  
  if (isApartacao) {
    // Habilitar campo de aparta√ß√£o
    const pesoInputApartacao = document.getElementById('pesoValorApartacaoV2');
    const gravarBtnApartacao = document.getElementById('pesoGravarBtnApartacaoV2');
    
    if (pesoInputApartacao) {
      // Resetar campo quando novo animal for identificado
      pesoInputApartacao.disabled = false;
      pesoInputApartacao.value = '';
      pesoInputApartacao.placeholder = '0,0';
      pesoInputApartacao.style.backgroundColor = '';
      pesoInputApartacao.style.cursor = 'text';
      pesoInputApartacao.style.color = '#1b5e20';
      pesoInputApartacao.focus();
      
      // Adicionar event listener para Enter
      pesoInputApartacao.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !pesoInputApartacao.disabled) {
          event.preventDefault();
          // Verificar se h√° peso v√°lido
          const pesoTexto = pesoInputApartacao.value.trim().replace(',', '.');
          const peso = parseFloat(pesoTexto);
          if (peso && peso > 0 && !isNaN(peso)) {
            // Gravar peso ao pressionar Enter
            if (typeof window.gravarPesagemApartacao === 'function') {
              window.gravarPesagemApartacao();
            }
          }
        }
      });
      
      console.log('‚úÖ Campo de peso APARTA√á√ÉO HABILITADO');
    }
    
    if (gravarBtnApartacao) {
      gravarBtnApartacao.disabled = false;
      gravarBtnApartacao.style.opacity = '1';
      gravarBtnApartacao.style.cursor = 'pointer';
      // Garantir que o bot√£o est√° configurado para gravar
      gravarBtnApartacao.innerHTML = '<i class="fas fa-save"></i> <span>Gravar</span>';
      gravarBtnApartacao.onclick = function() {
        if (typeof window.gravarPesagemApartacao === 'function') {
          window.gravarPesagemApartacao();
        }
      };
      gravarBtnApartacao.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%)';
      console.log('‚úÖ Bot√£o Gravar APARTA√á√ÉO HABILITADO');
    }
  } else {
    // Habilitar campo de rotina
    const pesoInput = document.getElementById('pesoValorV2');
    const gravarBtn = document.getElementById('pesoGravarBtnV2');
    
    if (pesoInput) {
      pesoInput.disabled = false;
      pesoInput.placeholder = '0,0';
      pesoInput.style.backgroundColor = '';
      pesoInput.style.cursor = 'text';
      pesoInput.focus();
      console.log('‚úÖ Campo de peso ROTINA HABILITADO');
    }
    
    if (gravarBtn) {
      gravarBtn.disabled = false;
      gravarBtn.style.opacity = '';
      gravarBtn.style.cursor = '';
      console.log('‚úÖ Bot√£o Gravar ROTINA HABILITADO');
    }
    
    // Habilitar tamb√©m o bot√£o "Finalizar e Gravar"
    if (typeof window.atualizarBotaoFinalizarV2 === 'function') {
      window.atualizarBotaoFinalizarV2();
    }
  }
  
  return true;
};

window.desabilitarCampoPesoV2 = function() {
  // Desabilitar campo de rotina
  const pesoInput = document.getElementById('pesoValorV2');
  const gravarBtn = document.getElementById('pesoGravarBtnV2');
  
  if (pesoInput) {
    pesoInput.disabled = true;
    pesoInput.value = '';
    pesoInput.placeholder = 'Identifique o animal primeiro';
    pesoInput.style.backgroundColor = '#f5f5f5';
    pesoInput.style.cursor = 'not-allowed';
    console.log('üîí Campo de peso ROTINA DESABILITADO');
  }
  
  if (gravarBtn) {
    gravarBtn.disabled = true;
    gravarBtn.style.opacity = '0.5';
    gravarBtn.style.cursor = 'not-allowed';
    console.log('üîí Bot√£o Gravar ROTINA DESABILITADO');
  }
  
  // Desabilitar campo de aparta√ß√£o
  const pesoInputApartacao = document.getElementById('pesoValorApartacaoV2');
  const gravarBtnApartacao = document.getElementById('pesoGravarBtnApartacaoV2');
  
  if (pesoInputApartacao) {
    pesoInputApartacao.disabled = true;
    pesoInputApartacao.value = '';
    pesoInputApartacao.placeholder = 'Identifique o animal primeiro';
    pesoInputApartacao.style.backgroundColor = 'rgba(255,255,255,0.15)';
    pesoInputApartacao.style.cursor = 'not-allowed';
    pesoInputApartacao.style.color = '#1b5e20';
    console.log('üîí Campo de peso APARTA√á√ÉO DESABILITADO');
  }
  
  if (gravarBtnApartacao) {
    gravarBtnApartacao.disabled = true;
    gravarBtnApartacao.style.opacity = '0.5';
    gravarBtnApartacao.style.cursor = 'not-allowed';
    // Resetar bot√£o para "Gravar"
    gravarBtnApartacao.innerHTML = '<i class="fas fa-save"></i> <span>Gravar</span>';
    gravarBtnApartacao.onclick = function() {
      if (typeof window.gravarPesagemApartacao === 'function') {
        window.gravarPesagemApartacao();
      }
    };
    gravarBtnApartacao.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%)';
    console.log('üîí Bot√£o Gravar APARTA√á√ÉO DESABILITADO');
  }
  
  return true;
};

console.log('‚úÖ Fun√ß√µes de controle do campo de peso definidas!');

// ========== DEFINIR atualizarScannerResumoV2 IMEDIATAMENTE ==========
// Garantir que a fun√ß√£o esteja dispon√≠vel antes de qualquer busca
window.atualizarScannerResumoV2 = function(dados) {
  console.log('üìã [FICHA V4] atualizarScannerResumoV2 chamada', dados ? 'com dados' : 'sem dados');
  
  // Buscar elementos dinamicamente para garantir que existem
  const fichaCodigoEletronico = document.getElementById('fichaCodigoEletronicoV4');
  const fichaSisbov = document.getElementById('fichaSisbovV4');
  const fichaNumeroManejo = document.getElementById('fichaNumeroManejoV4');
  const fichaRaca = document.getElementById('fichaRacaV4');
  const fichaSexo = document.getElementById('fichaSexoV4');
  const fichaNascimento = document.getElementById('fichaNascimentoV4');
  const fichaCategoria = document.getElementById('fichaCategoriaV4');
  const fichaPastoLote = document.getElementById('fichaPastoLoteV4');
  const fichaStatusBnd = document.getElementById('fichaStatusBndV4');
  const fichaUltimoPeso = document.getElementById('fichaUltimoPesoV4');
  
  console.log('üìã [FICHA V4] Elementos encontrados:', {
    fichaCodigoEletronico: !!fichaCodigoEletronico,
    fichaSisbov: !!fichaSisbov,
    fichaNumeroManejo: !!fichaNumeroManejo,
    fichaRaca: !!fichaRaca,
    fichaSexo: !!fichaSexo,
    fichaNascimento: !!fichaNascimento,
    fichaCategoria: !!fichaCategoria,
    fichaPastoLote: !!fichaPastoLote,
    fichaStatusBnd: !!fichaStatusBnd,
    fichaUltimoPeso: !!fichaUltimoPeso
  });
  
  if (!dados) {
    // Limpar campos
    if (fichaCodigoEletronico) fichaCodigoEletronico.textContent = '‚Äî';
    if (fichaSisbov) fichaSisbov.textContent = '‚Äî';
    if (fichaNumeroManejo) fichaNumeroManejo.textContent = '‚Äî';
    if (fichaRaca) fichaRaca.textContent = '‚Äî';
    if (fichaSexo) fichaSexo.textContent = '‚Äî';
    if (fichaNascimento) fichaNascimento.textContent = '‚Äî';
    if (fichaCategoria) fichaCategoria.textContent = '‚Äî';
    if (fichaPastoLote) fichaPastoLote.textContent = '‚Äî';
    if (fichaStatusBnd) fichaStatusBnd.textContent = '‚Äî';
    if (fichaUltimoPeso) fichaUltimoPeso.textContent = '‚Äî';
    const fichaCotaHilton = document.getElementById('fichaCotaHiltonV4');
    if (fichaCotaHilton) fichaCotaHilton.textContent = '‚Äî';
    return;
  }
  
  // C√≥digo Eletr√¥nico
  const codigoEletronico = dados.codigo_eletronico || '';
  const codigoEletronicoFormatado = (codigoEletronico && codigoEletronico !== 'None' && codigoEletronico !== '') ? codigoEletronico : '‚Äî';
  const sisbov = dados.codigo_sisbov || dados.numero_brinco || '‚Äî';
  
  // Atualizar campos
  if (fichaCodigoEletronico) {
    fichaCodigoEletronico.textContent = codigoEletronicoFormatado;
    console.log('‚úÖ [FICHA V4] C√≥digo Eletr√¥nico:', codigoEletronicoFormatado);
  }
  
  if (fichaSisbov) {
    fichaSisbov.textContent = sisbov;
    console.log('‚úÖ [FICHA V4] SISBOV:', sisbov);
  }
  
  if (fichaNumeroManejo) {
    fichaNumeroManejo.textContent = dados.numero_manejo || '‚Äî';
    console.log('‚úÖ [FICHA V4] N¬∞ Manejo:', dados.numero_manejo || '‚Äî');
  }
  
  if (fichaRaca) {
    const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' 
      ? window.obterNomeCompletoRaca(dados.raca) 
      : (dados.raca || '‚Äî');
    fichaRaca.textContent = racaCompleta;
    console.log('‚úÖ [FICHA V4] Ra√ßa:', dados.raca, '‚Üí', racaCompleta);
  }
  
  if (fichaSexo) {
    fichaSexo.textContent = dados.sexo || '‚Äî';
    console.log('‚úÖ [FICHA V4] Sexo:', dados.sexo || '‚Äî');
  }
  
  if (fichaNascimento) {
    const dataNasc = dados.data_nascimento_format || dados.data_nascimento || '';
    fichaNascimento.textContent = dataNasc || '‚Äî';
    console.log('‚úÖ [FICHA V4] Nascimento:', dataNasc || '‚Äî');
  }
  
  if (fichaCategoria) {
    fichaCategoria.textContent = dados.categoria || '‚Äî';
    console.log('‚úÖ [FICHA V4] Categoria:', dados.categoria || '‚Äî');
  }
  
  if (fichaPastoLote) {
    fichaPastoLote.textContent = dados.lote_atual || '‚Äî';
    console.log('‚úÖ [FICHA V4] Pasto/Lote:', dados.lote_atual || '‚Äî');
  }
  
  if (fichaStatusBnd) {
    const situacaoBnd = dados.situacao_bnd || '';
    if (situacaoBnd === 'CONFORME' || (!situacaoBnd && dados.consta_bnd !== false)) {
      fichaStatusBnd.textContent = 'Conforme';
    } else {
      fichaStatusBnd.textContent = situacaoBnd || '‚Äî';
    }
    console.log('‚úÖ [FICHA V4] Status BND:', fichaStatusBnd.textContent);
  }
  
  if (fichaUltimoPeso) {
    const up = dados.ultimo_peso || dados.peso_atual || (dados.pesagem_atual && dados.pesagem_atual.peso);
    if (up) {
      if (typeof formatarNumeroBr === 'function') {
        fichaUltimoPeso.textContent = formatarNumeroBr(up);
      } else {
        const pesoNum = typeof up === 'number' ? up : parseFloat(up);
        fichaUltimoPeso.textContent = !isNaN(pesoNum) && pesoNum > 0 ? `${pesoNum.toFixed(1).replace('.', ',')} kg` : '‚Äî';
      }
    } else {
      fichaUltimoPeso.textContent = '‚Äî';
    }
    console.log('‚úÖ [FICHA V4] √öltimo Peso:', fichaUltimoPeso.textContent);
  }
  
  console.log('‚úÖ [FICHA V4] Ficha cadastral atualizada com sucesso!');
  
  // Carregar informa√ß√µes reprodutivas e bezerros se o animal tiver ID
  if (dados && dados.id) {
    setTimeout(() => {
      if (typeof window.carregarStatusReprodutivoV4 === 'function') {
        window.carregarStatusReprodutivoV4(dados.id);
      }
    }, 500);
    
    // Atualizar informa√ß√µes de pesagem individual
    if (typeof window.atualizarResumoPesagemV2 === 'function') {
      window.atualizarResumoPesagemV2(dados);
    }
  }
};

  console.log('‚úÖ atualizarScannerResumoV2 definida globalmente!');

// ========== FUN√á√ÉO PARA ATUALIZAR PROGRESSO DA SESS√ÉO ==========
window.atualizarProgressoSessao = async function() {
  console.log('üìä [PROGRESSO] Iniciando atualiza√ß√£o do progresso da sess√£o...');
  
  try {
    // Buscar URL da API de estat√≠sticas da sess√£o
    const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
    if (!urlMatch) {
      console.error('‚ùå [PROGRESSO] N√£o foi poss√≠vel identificar a propriedade');
      return;
    }
    
    const propriedadeId = urlMatch[1];
    const statsUrl = `/propriedade/${propriedadeId}/curral/api/sessao/stats/`;
    
    console.log('üìä [PROGRESSO] Buscando estat√≠sticas em:', statsUrl);
    
    const response = await fetch(statsUrl);
    if (!response.ok) {
      console.error('‚ùå [PROGRESSO] Erro ao buscar estat√≠sticas:', response.status);
      return;
    }
    
    const data = await response.json();
    console.log('üìä [PROGRESSO] Dados recebidos:', data);
    
    if (data.status !== 'ok' || !data.stats) {
      console.warn('‚ö†Ô∏è [PROGRESSO] Resposta inv√°lida ou sem sess√£o ativa');
      // Limpar campos se n√£o houver sess√£o ativa
      const planejadosEl = document.getElementById('progressoPlanejados');
      const trabalhadosEl = document.getElementById('progressoTrabalhados');
      const restantesEl = document.getElementById('progressoRestantes');
      
      if (planejadosEl) planejadosEl.textContent = '‚Äî';
      if (trabalhadosEl) trabalhadosEl.textContent = '0';
      if (restantesEl) restantesEl.textContent = '‚Äî';
      
      return;
    }
    
    const stats = data.stats;
    
    // Atualizar elementos principais
    const trabalhadosEl = document.getElementById('progressoTrabalhados');
    if (trabalhadosEl) {
      trabalhadosEl.textContent = stats.animais_processados || 0;
      console.log('‚úÖ [PROGRESSO] Trabalhados atualizado:', stats.animais_processados || 0);
    }
    
    // Planejados - se houver informa√ß√£o, sen√£o mostrar "‚Äî"
    const planejadosEl = document.getElementById('progressoPlanejados');
    if (planejadosEl) {
      // Se houver informa√ß√£o de planejados no backend, usar, sen√£o mostrar "‚Äî"
      planejadosEl.textContent = stats.animais_planejados || '‚Äî';
    }
    
    // Calcular restantes (se houver planejados)
    const restantesEl = document.getElementById('progressoRestantes');
    if (restantesEl) {
      if (stats.animais_planejados && stats.animais_planejados > 0) {
        const restantes = Math.max(0, stats.animais_planejados - (stats.animais_processados || 0));
        restantesEl.textContent = restantes;
      } else {
        restantesEl.textContent = '‚Äî';
      }
    }
    
    // Atualizar barra de progresso e percentual
    const progressoPercentualEl = document.getElementById('progressoPercentual');
    const progressoBarFillEl = document.getElementById('progressoBarFill');
    
    if (stats.animais_planejados && stats.animais_planejados > 0) {
      const percentual = Math.min(100, Math.round(((stats.animais_processados || 0) / stats.animais_planejados) * 100));
      
      if (progressoPercentualEl) {
        progressoPercentualEl.textContent = `${percentual}%`;
      }
      
      if (progressoBarFillEl) {
        progressoBarFillEl.style.width = `${percentual}%`;
        progressoBarFillEl.textContent = `${percentual}%`;
      }
    } else {
      if (progressoPercentualEl) progressoPercentualEl.textContent = '0%';
      if (progressoBarFillEl) {
        progressoBarFillEl.style.width = '0%';
        progressoBarFillEl.textContent = '';
      }
    }
    
    // Atualizar estat√≠sticas por sexo
    // Buscar informa√ß√µes por sexo dos eventos (se dispon√≠vel)
    const progressoSexoMachoEl = document.getElementById('progressoSexoMacho');
    const progressoSexoFemeaEl = document.getElementById('progressoSexoFemea');
    
    if (progressoSexoMachoEl) {
      // Se backend retornar informa√ß√µes por sexo, usar, sen√£o calcular localmente
      progressoSexoMachoEl.textContent = stats.machos || 0;
    }
    
    if (progressoSexoFemeaEl) {
      progressoSexoFemeaEl.textContent = stats.femeas || 0;
    }
    
    console.log('‚úÖ [PROGRESSO] Progresso da sess√£o atualizado com sucesso!');
    
  } catch (error) {
    console.error('‚ùå [PROGRESSO] Erro ao atualizar progresso:', error);
  }
};

// Atualizar progresso periodicamente (a cada 5 segundos)
if (typeof window.setInterval !== 'undefined') {
  // Atualizar imediatamente ao carregar
  setTimeout(() => {
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
  }, 1000);
  
  // Atualizar periodicamente
  setInterval(() => {
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
  }, 5000);
}

console.log('‚úÖ atualizarProgressoSessao definida globalmente!');

// ========== FUN√á√ÉO PARA ATUALIZAR RESUMO DE PESAGEM INDIVIDUAL ==========
window.atualizarResumoPesagemV2 = function(dadosOuPeso, dataPeso) {
  console.log('‚öñÔ∏è [PESAGEM INDIVIDUAL] Atualizando resumo de pesagem...', dadosOuPeso, dataPeso);
  
  // Aceita tanto objeto dados completo quanto par√¢metros individuais (peso, data)
  let dados = null;
  
  if (typeof dadosOuPeso === 'object' && dadosOuPeso !== null) {
    // Se primeiro par√¢metro √© um objeto, usar como dados
    dados = dadosOuPeso;
  } else if (typeof dadosOuPeso === 'number' || (typeof dadosOuPeso === 'string' && !isNaN(parseFloat(dadosOuPeso)))) {
    // Se primeiro par√¢metro √© um n√∫mero (peso), construir objeto dados
    const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    dados = {
      peso_atual: parseFloat(dadosOuPeso),
      data_peso_atual: dataPeso || new Date().toISOString(),
      pesagem_anterior: animalAtual ? {
        peso: animalAtual.peso_anterior,
        data: animalAtual.data_peso_anterior,
        data_hora: animalAtual.data_peso_anterior
      } : null,
      ganho_peso: animalAtual && animalAtual.peso_anterior ? 
        (parseFloat(dadosOuPeso) - parseFloat(animalAtual.peso_anterior)) : null
    };
  }
  
  if (!dados) {
    console.warn('‚ö†Ô∏è [PESAGEM INDIVIDUAL] Sem dados fornecidos');
    return;
  }
  
  // Formatar valores
  const formatarPeso = (peso) => {
    if (!peso) return '‚Äî';
    const pesoNum = typeof peso === 'number' ? peso : parseFloat(peso);
    if (isNaN(pesoNum) || pesoNum <= 0) return '‚Äî';
    return `${pesoNum.toFixed(1).replace('.', ',')} kg`;
  };
  
  const formatarDias = (dias) => {
    if (!dias || dias === 0) return '‚Äî';
    return `${dias} dia${dias !== 1 ? 's' : ''}`;
  };
  
  // √öltimo peso (peso anterior)
  const pesoUltimoEl = document.getElementById('pesoUltimoValorV2');
  if (pesoUltimoEl) {
    const ultimoPeso = dados.pesagem_anterior?.peso || dados.peso_anterior || null;
    pesoUltimoEl.textContent = formatarPeso(ultimoPeso);
  }
  
  // Peso atual (peso mais recente)
  const pesoAtualEl = document.getElementById('pesoAtualValorV2');
  if (pesoAtualEl) {
    const pesoAtual = dados.peso_atual || dados.pesagem_atual?.peso || null;
    pesoAtualEl.textContent = formatarPeso(pesoAtual);
  }
  
  // Per√≠odo em dias
  const periodoDiasEl = document.getElementById('periodoDiasValorV2');
  if (periodoDiasEl) {
    let dias = null;
    
    if (dados.periodo_dias) {
      dias = dados.periodo_dias;
    } else if (dados.pesagem_atual?.data && dados.pesagem_anterior?.data) {
      // Calcular diferen√ßa entre datas
      const dataAtual = new Date(dados.pesagem_atual.data);
      const dataAnterior = new Date(dados.pesagem_anterior.data);
      dias = Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
    }
    
    periodoDiasEl.textContent = formatarDias(dias);
  }
  
  // Ganho di√°rio
  const ganhoDiaEl = document.getElementById('pesoGanhoDiaV2');
  if (ganhoDiaEl) {
    let ganhoDia = null;
    
    if (dados.ganho_peso_diario) {
      ganhoDia = dados.ganho_peso_diario;
    } else if (dados.ganho_peso && periodoDiasEl && periodoDiasEl.textContent !== '‚Äî') {
      const dias = parseInt(periodoDiasEl.textContent);
      if (dias > 0 && dados.ganho_peso) {
        ganhoDia = dados.ganho_peso / dias;
      }
    }
    
    if (ganhoDia !== null && ganhoDia > 0) {
      ganhoDiaEl.textContent = `+${ganhoDia.toFixed(2).replace('.', ',')} kg/dia`;
    } else {
      ganhoDiaEl.textContent = '‚Äî';
    }
  }
  
  // Ganho total
  const ganhoTotalEl = document.getElementById('pesoGanhoTotalV2');
  if (ganhoTotalEl) {
    const ganhoTotal = dados.ganho_peso || null;
    if (ganhoTotal !== null && ganhoTotal > 0) {
      ganhoTotalEl.textContent = `+${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
    } else {
      ganhoTotalEl.textContent = '‚Äî';
    }
  }
  
  console.log('‚úÖ [PESAGEM INDIVIDUAL] Resumo de pesagem atualizado!');
};

console.log('‚úÖ atualizarResumoPesagemV2 definida globalmente!');

// Fun√ß√£o para carregar status reprodutivo e bezerros
window.carregarStatusReprodutivoV4 = async function(animalId) {
  if (!animalId) {
    console.warn('‚ö†Ô∏è [FICHA V4] Sem ID do animal para carregar status reprodutivo');
    return;
  }
  
  const card = document.getElementById('fichaStatusReprodutivoCard');
  const content = document.getElementById('fichaStatusReprodutivoContent');
  
  if (!card || !content) {
    console.warn('‚ö†Ô∏è [FICHA V4] Elementos do card reprodutivo n√£o encontrados');
    return;
  }
  
  // Mostrar card (agora √© um ficha-item dentro do grid)
  card.style.display = 'flex';
  content.innerHTML = '<div style="color: #666; font-size: 0.85rem;"><i class="fas fa-spinner fa-spin"></i> Carregando informa√ß√µes...</div>';
  
  try {
    // Obter propriedadeId da URL
    const propriedadeMatch = window.location.pathname.match(/propriedade\/(\d+)/);
    if (!propriedadeMatch) {
      throw new Error('N√£o foi poss√≠vel determinar a propriedade');
    }
    const propriedadeId = propriedadeMatch[1];
    
    // Buscar registros do animal (inclui eventos reprodutivos)
    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/${animalId}/registros/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Erro ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('üìä [FICHA V4] Dados reprodutivos recebidos:', data);
    
    // Obter informa√ß√µes do animal da resposta da API ou do window
    const animalInfo = data.animal || {};
    const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    
    console.log('üìä [FICHA V4] animalInfo:', animalInfo);
    console.log('üìä [FICHA V4] animalAtual:', animalAtual);
    
    // Determinar sexo do animal
    let sexo = animalInfo.sexo || (animalAtual && animalAtual.sexo) || '';
    // Normalizar sexo
    if (sexo === 'F' || sexo === 'F√™mea' || sexo === 'Femea' || sexo === 'FEMEA') {
      sexo = 'F';
    } else if (sexo === 'M' || sexo === 'Macho' || sexo === 'MACHO') {
      sexo = 'M';
    }
    
    const categoria = animalInfo.categoria || (animalAtual && animalAtual.categoria) || '';
    const idadeMeses = animalInfo.idade_meses !== null && animalInfo.idade_meses !== undefined ? animalInfo.idade_meses : null;
    
    // Determinar se √© jovem
    const isJovem = (idadeMeses !== null && idadeMeses < 24) || 
                    (categoria && (categoria.toLowerCase().includes('bezerro') || 
                                   categoria.toLowerCase().includes('novilho') ||
                                   categoria.toLowerCase().includes('0-12') ||
                                   categoria.toLowerCase().includes('12-24')));
    
    console.log('üìä [FICHA V4] sexo:', sexo, 'categoria:', categoria, 'idadeMeses:', idadeMeses, 'isJovem:', isJovem);
    
    // Processar dados
    const eventosReprodutivos = (data.registros && data.registros.reproducao) || data.reproducao || [];
    
    // Montar HTML do status reprodutivo ou desempenho
    let html = '';
    
    // Se for MACHO, mostrar desempenho de peso
    if (sexo === 'M') {
      const pesoAtual = animalInfo.peso_atual || (animalAtual && animalAtual.peso_atual) || null;
      const pesoAnterior = animalInfo.peso_anterior || null;
      const ganhoPeso = animalInfo.ganho_peso || (pesoAtual && pesoAnterior ? pesoAtual - pesoAnterior : null);
      
      html += `<div style="font-size: 0.85rem; font-weight: 600; color: #1976d2; margin-bottom: 6px;">
        Desempenho de Peso
      </div>`;
      
      if (pesoAtual) {
        html += `<div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
          <strong>Peso Atual:</strong> ${typeof formatarNumeroBr === 'function' ? formatarNumeroBr(pesoAtual) : pesoAtual.toFixed(1).replace('.', ',')} kg
        </div>`;
      }
      
      if (pesoAnterior) {
        html += `<div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
          <strong>Peso Anterior:</strong> ${typeof formatarNumeroBr === 'function' ? formatarNumeroBr(pesoAnterior) : pesoAnterior.toFixed(1).replace('.', ',')} kg
        </div>`;
      }
      
      if (ganhoPeso !== null && ganhoPeso !== undefined) {
        const corGanho = ganhoPeso > 0 ? '#4caf50' : ganhoPeso < 0 ? '#f44336' : '#666';
        html += `<div style="font-size: 0.75rem; color: ${corGanho}; margin-bottom: 4px; font-weight: 600;">
          <strong>Ganho:</strong> ${ganhoPeso > 0 ? '+' : ''}${typeof formatarNumeroBr === 'function' ? formatarNumeroBr(ganhoPeso) : ganhoPeso.toFixed(1).replace('.', ',')} kg
        </div>`;
      }
      
      if (!pesoAtual && !pesoAnterior) {
        html += `<div style="font-size: 0.75rem; color: #999; text-align: center; margin-top: 8px;">
          Sem dados de peso dispon√≠veis
        </div>`;
      }
    } 
    // Se for F√äMEA
    else if (sexo === 'F') {
      // Priorizar status_reprodutivo do animalInfo (vindo da API)
      const statusReprodutivo = animalInfo.status_reprodutivo || (animalAtual && animalAtual.status_reprodutivo) || null;
      
      console.log('üìä [FICHA V4] Status reprodutivo:', statusReprodutivo, 'Tipo:', typeof statusReprodutivo);
      
      // Se N√ÉO tiver status reprodutivo (ou for INDEFINIDO), mostrar mensagem
      // IMPORTANTE: Mesmo sendo jovem, se tiver status reprodutivo, devemos mostrar
      if (!statusReprodutivo || statusReprodutivo === 'INDEFINIDO' || statusReprodutivo === null || statusReprodutivo === '') {
        console.log('üìä [FICHA V4] Mostrando "Animal sem status reprodutivo"');
        html += `<div style="font-size: 0.85rem; color: #999; text-align: center; padding: 8px 0;">
          Animal sem status reprodutivo
        </div>`;
        
        if (isJovem) {
          html += `<div style="font-size: 0.7rem; color: #999; text-align: center; margin-top: 4px;">
            (Animal jovem - ${idadeMeses ? idadeMeses + ' meses' : categoria})
          </div>`;
        }
      } else {
        console.log('üìä [FICHA V4] Status reprodutivo encontrado, exibindo:', statusReprodutivo);
        // Status reprodutivo existente
        const statusLabels = {
          'PRENHE': 'Prenha',
          'VAZIA': 'Vazia',
          'LACTACAO': 'Lacta√ß√£o',
          'SECAGEM': 'Secagem',
          'DESCARTE': 'Descarte',
          'INDEFINIDO': 'Indefinido'
        };
        const statusColors = {
          'PRENHE': '#4caf50',
          'VAZIA': '#ff9800',
          'LACTACAO': '#2196f3',
          'SECAGEM': '#9c27b0',
          'DESCARTE': '#f44336',
          'INDEFINIDO': '#9e9e9e'
        };
        
        html += `<div style="font-size: 0.85rem; font-weight: 600; color: ${statusColors[statusReprodutivo] || '#333'}; margin-bottom: 4px;">
          ${statusLabels[statusReprodutivo] || statusReprodutivo}
        </div>`;
        
        // √öltimo diagn√≥stico
        if (animalInfo.data_ultima_diagnostico) {
          const dataDiagnostico = new Date(animalInfo.data_ultima_diagnostico).toLocaleDateString('pt-BR');
          html += `<div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
            Diagn√≥stico: ${dataDiagnostico}
          </div>`;
        }
        
        // Trabalhos reprodutivos
        if (eventosReprodutivos && eventosReprodutivos.length > 0) {
          html += `<div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">
            ${eventosReprodutivos.length} trabalho(s) reprodutivo(s)
          </div>`;
        }
        
        // Buscar bezerros (filhos do animal)
        let bezerros = [];
        try {
          const bezerrosResponse = await fetch(`/propriedade/${propriedadeId}/pecuaria/api/animal/${animalId}/filhos/`, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            }
          });
          if (bezerrosResponse.ok) {
            const bezerrosData = await bezerrosResponse.json();
            bezerros = bezerrosData.filhos || bezerrosData || [];
          }
        } catch (e) {
          if (animalAtual && animalAtual.filhos) {
            bezerros = animalAtual.filhos;
          } else if (animalAtual && animalAtual.filhos_como_mae) {
            bezerros = animalAtual.filhos_como_mae;
          }
        }
        
        // Mostrar bezerros se houver
        if (bezerros && bezerros.length > 0) {
          html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e0e0e0;">
            <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px; font-weight: 600;">
              ${bezerros.length} bezerro(s)
            </div>`;
          
          bezerros.slice(0, 2).forEach(bezerro => {
            const brinco = bezerro.numero_brinco || bezerro.codigo_sisbov || 'N/A';
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-size: 0.7rem; color: #333;">${brinco}</span>
              <a href="/propriedade/${propriedadeId}/rastreabilidade/animal/${bezerro.id}/" 
                 target="_blank" 
                 style="padding: 2px 8px; background: #1976d2; color: white; border-radius: 3px; text-decoration: none; font-size: 0.7rem; font-weight: 600;"
                 onmouseover="this.style.background='#1565c0';" 
                 onmouseout="this.style.background='#1976d2';">
                <i class="fas fa-external-link-alt"></i>
              </a>
            </div>`;
          });
          
          if (bezerros.length > 2) {
            html += `<div style="font-size: 0.7rem; color: #666; text-align: center;">
              + ${bezerros.length - 2} mais
            </div>`;
          }
          
          html += `</div>`;
        }
      }
    } 
    // Se n√£o conseguir determinar o sexo
    else {
      html += `<div style="font-size: 0.85rem; color: #999; text-align: center; padding: 8px 0;">
        Sem informa√ß√µes dispon√≠veis
      </div>`;
    }
    
    content.innerHTML = html || '<div style="color: #666; font-size: 0.85rem;">Sem informa√ß√µes</div>';
    
  } catch (error) {
    console.error('‚ùå [FICHA V4] Erro ao carregar status reprodutivo:', error);
    console.error('‚ùå [FICHA V4] Stack trace:', error.stack);
    
    // Tentar mostrar informa√ß√µes b√°sicas mesmo com erro
    const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    if (animalAtual) {
      const sexo = animalAtual.sexo || '';
      const categoria = animalAtual.categoria || '';
      
      if (sexo === 'F' || sexo === 'F√™mea' || sexo === 'Femea') {
        const isJovem = categoria && (categoria.toLowerCase().includes('bezerro') || 
                                     categoria.toLowerCase().includes('0-12') ||
                                     categoria.toLowerCase().includes('12-24'));
        if (isJovem || !animalAtual.status_reprodutivo) {
          content.innerHTML = `<div style="font-size: 0.85rem; color: #999; text-align: center; padding: 8px 0;">
            Animal sem status reprodutivo
          </div>`;
          return;
        }
      } else if (sexo === 'M' || sexo === 'Macho') {
        content.innerHTML = `<div style="font-size: 0.85rem; color: #999; text-align: center; padding: 8px 0;">
          Desempenho de peso n√£o dispon√≠vel
        </div>`;
        return;
      }
    }
    
    // Se n√£o conseguir usar dados b√°sicos, mostrar erro
    content.innerHTML = `<div style="color: #f44336; font-size: 0.85rem;">
      <i class="fas fa-exclamation-triangle"></i> Erro ao carregar informa√ß√µes reprodutivas
    </div>`;
  }
};

// Fun√ß√£o para abrir ficha completa do animal
window.abrirFichaCompletaV4 = function() {
  const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
  
  if (!animalAtual || !animalAtual.id) {
    alert('‚ö†Ô∏è Animal n√£o identificado. Identifique um animal primeiro.');
    return;
  }
  
  // Obter propriedadeId da URL
  const propriedadeMatch = window.location.pathname.match(/propriedade\/(\d+)/);
  if (!propriedadeMatch) {
    alert('Erro: N√£o foi poss√≠vel determinar a propriedade.');
    return;
  }
  const propriedadeId = propriedadeMatch[1];
  
  // Abrir ficha em nova aba - URL correta
  const url = `/propriedade/${propriedadeId}/rastreabilidade/animal/${animalAtual.id}/`;
  window.open(url, '_blank');
};

// ========== FUN√á√ÉO DE BUSCA DE BRINCO - DEFINIDA ANTES DO HTML ==========
// Esta fun√ß√£o DEVE estar dispon√≠vel ANTES do HTML ser renderizado
(function() {
  'use strict';
  
  // Flag para evitar m√∫ltiplas execu√ß√µes simult√¢neas
  let buscandoBrinco = false;
  let ultimoValorBuscado = '';
  
  // Fun√ß√£o principal para buscar e identificar brinco
  window.buscarBrincoSimples = async function() {
    try {
      // Evitar m√∫ltiplas execu√ß√µes simult√¢neas
      if (buscandoBrinco) {
        console.log('‚è∏Ô∏è Busca j√° em andamento, ignorando chamada duplicada...');
        return;
      }
      
      const campo = document.getElementById('brincoInputV2');
      if (!campo) {
        console.error('Campo brincoInputV2 n√£o encontrado');
        return;
      }
      
      const valor = campo.value.trim();
      if (!valor || valor.length < 3) {
        alert('Digite pelo menos 3 caracteres para buscar.');
        return;
      }
      
      // Evitar buscar o mesmo valor novamente (mas permitir ap√≥s 2 segundos)
      const agora = Date.now();
      if (ultimoValorBuscado === valor && (window.ultimaBuscaTimestamp && (agora - window.ultimaBuscaTimestamp) < 2000)) {
        console.log('‚è∏Ô∏è Mesmo valor j√° foi buscado recentemente, ignorando...');
        return;
      }
      
      buscandoBrinco = true;
      ultimoValorBuscado = valor;
      window.ultimaBuscaTimestamp = agora;
      
      console.log('üîç buscarBrincoSimples chamado com:', valor);
      console.log('üìç URL atual:', window.location.pathname);
      
      // Se identificarBrinco j√° estiver dispon√≠vel (carregada ap√≥s DOMContentLoaded), usar ela
      if (typeof identificarBrinco === 'function') {
        console.log('‚úÖ Usando fun√ß√£o identificarBrinco existente');
        console.log('üîó identificarUrl:', typeof identificarUrl !== 'undefined' ? identificarUrl : 'n√£o definido');
        identificarBrinco(valor);
        return;
      }
      
      // Caso contr√°rio, fazer busca direta (fallback)
      console.log('‚ö†Ô∏è identificarBrinco n√£o dispon√≠vel, fazendo busca direta...');
      
      // Obter ID da propriedade da URL
      const propriedadeId = window.location.pathname.match(/propriedade\/(\d+)/);
      if (!propriedadeId) {
        console.error('‚ùå N√£o foi poss√≠vel extrair propriedadeId da URL:', window.location.pathname);
        alert('Erro: n√£o foi poss√≠vel determinar a propriedade.');
        return;
      }
      
      console.log('üè¢ Propriedade ID extra√≠da:', propriedadeId[1]);
      
      // Mostrar loading
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) loadingOverlay.classList.add('show');
      
      // Verificar se est√° em modo de simula√ß√£o
      const modoSimulacao = typeof SimulacaoSistema !== 'undefined' && SimulacaoSistema.config && SimulacaoSistema.config.ativa;
      
      // Fazer requisi√ß√£o
      let url = `/propriedade/${propriedadeId[1]}/curral/api/identificar/?codigo=${encodeURIComponent(valor)}`;
      if (modoSimulacao) {
        url += '&simulacao=true';
      }
      console.log('üåê Fazendo requisi√ß√£o para:', url);
      const headers = {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      };
      if (modoSimulacao) {
        headers['X-Simulacao'] = 'true';
      }
      const response = await fetch(url, { headers });
      
      if (!response.ok) {
        buscandoBrinco = false;
        if (loadingOverlay) loadingOverlay.classList.remove('show');
        const errorText = await response.text();
        console.error('‚ùå Erro na resposta:', response.status, errorText);
        alert(`Erro ao buscar animal (${response.status}). Verifique o c√≥digo informado.`);
        return;
      }
      
      const data = await response.json();
      console.log('üì¶ Resposta recebida:', data);
      console.log('üìä Status da resposta:', data.status);
      console.log('üí¨ Mensagem:', data.mensagem || 'sem mensagem');
      
      // Esconder loading
      if (loadingOverlay) loadingOverlay.classList.remove('show');
      
      // Processar resposta
      if (data.status === 'animal' && data.dados) {
        console.log('‚úÖ Animal encontrado! Dados:', data.dados);
        console.log('üîç Verificando campos do animal:', {
          codigo_eletronico: data.dados.codigo_eletronico,
          codigo_sisbov: data.dados.codigo_sisbov,
          numero_brinco: data.dados.numero_brinco,
          numero_manejo: data.dados.numero_manejo,
          raca: data.dados.raca,
          sexo: data.dados.sexo
        });
        
        // Garantir que atualizarScannerResumoV2 seja chamada IMEDIATAMENTE
        if (typeof window.atualizarScannerResumoV2 === 'function') {
          console.log('‚úÖ Chamando atualizarScannerResumoV2 IMEDIATAMENTE com dados do animal');
          try {
            window.atualizarScannerResumoV2(data.dados);
            console.log('‚úÖ atualizarScannerResumoV2 executada com sucesso');
          } catch (e) {
            console.error('‚ùå Erro ao chamar atualizarScannerResumoV2:', e);
          }
        } else {
          console.warn('‚ö†Ô∏è atualizarScannerResumoV2 n√£o encontrada, tentando novamente...');
          // Tentar v√°rias vezes com delays progressivos
          const tentarAtualizar = (tentativa = 0) => {
            if (tentativa > 5) {
              console.error('‚ùå atualizarScannerResumoV2 n√£o encontrada ap√≥s 5 tentativas!');
              return;
            }
            setTimeout(() => {
              if (typeof window.atualizarScannerResumoV2 === 'function') {
                console.log(`‚úÖ atualizarScannerResumoV2 encontrada na tentativa ${tentativa + 1}`);
                try {
                  window.atualizarScannerResumoV2(data.dados);
                } catch (e) {
                  console.error('‚ùå Erro ao chamar atualizarScannerResumoV2:', e);
                }
              } else {
                tentarAtualizar(tentativa + 1);
              }
            }, 300 * (tentativa + 1));
          };
          tentarAtualizar();
        }
        // Fun√ß√£o para tentar processar o animal (com retry melhorado)
        let processamentoConcluido = false;
        const tentarProcessarAnimal = (tentativas = 0) => {
          // Se j√° foi processado, n√£o tentar novamente
          if (processamentoConcluido) {
            console.log('‚úÖ Processamento j√° conclu√≠do, ignorando tentativa duplicada');
            return;
          }
          
          const maxTentativas = 15; // Aumentado para 15 tentativas
          const delay = tentativas < 5 ? 200 : 500; // Delay menor nas primeiras tentativas
          
          // Verificar se a fun√ß√£o est√° dispon√≠vel
          if (typeof window.processarAnimalIdentificado === 'function') {
            console.log('‚úÖ Fun√ß√£o processarAnimalIdentificado encontrada, processando...');
            processamentoConcluido = true;
            buscandoBrinco = false; // Liberar flag
            try {
              window.processarAnimalIdentificado(data.dados);
              // Garantir que window.animalAtualV2 est√° definido
              if (!window.animalAtualV2) {
                window.animalAtualV2 = data.dados;
                console.log('‚úÖ [PROCESSAR ANIMAL] window.animalAtualV2 definido:', window.animalAtualV2);
              }
              // Habilitar campo de peso e bot√£o ap√≥s processar
              setTimeout(() => {
                if (typeof window.habilitarCampoPesoV2 === 'function') {
                  window.habilitarCampoPesoV2();
                }
                // Habilitar bot√£o Finalizar e Gravar diretamente
                const btnFinalizar3 = document.getElementById('btnFinalizarGravarV2');
                if (btnFinalizar3 && window.animalAtualV2 && window.animalAtualV2.id) {
                  btnFinalizar3.disabled = false;
                  btnFinalizar3.style.opacity = '1';
                  btnFinalizar3.style.cursor = 'pointer';
                  console.log('‚úÖ [PROCESSAR ANIMAL] Bot√£o Finalizar e Gravar HABILITADO!');
                }
                if (typeof atualizarBotaoFinalizarV2 === 'function') {
                  atualizarBotaoFinalizarV2();
                }
              }, 100);
            } catch (e) {
              console.error('‚ùå Erro ao processar animal:', e);
              // Continuar para fallback
              processamentoConcluido = false;
            }
            return;
          } else if (typeof processarAnimalIdentificado === 'function') {
            console.log('‚úÖ Fun√ß√£o processarAnimalIdentificado encontrada (sem window), processando...');
            processamentoConcluido = true;
            buscandoBrinco = false; // Liberar flag
            try {
              processarAnimalIdentificado(data.dados);
              // Habilitar campo de peso e bot√£o ap√≥s processar
              setTimeout(() => {
                if (typeof window.habilitarCampoPesoV2 === 'function') {
                  window.habilitarCampoPesoV2();
                }
                if (typeof atualizarBotaoFinalizarV2 === 'function') {
                  atualizarBotaoFinalizarV2();
                }
              }, 100);
            } catch (e) {
              console.error('‚ùå Erro ao processar animal:', e);
              processamentoConcluido = false;
            }
            return;
          } else if (typeof window.atualizarScannerResumoV2 === 'function') {
            // Se atualizarScannerResumoV2 existir, usar ela diretamente
            console.log('‚úÖ Usando atualizarScannerResumoV2 como fallback');
            processamentoConcluido = true;
            buscandoBrinco = false; // Liberar flag
            try {
              window.atualizarScannerResumoV2(data.dados);
              // Tamb√©m atualizar vari√°veis globais
              if (typeof window !== 'undefined') {
                window.animalAtualV2 = data.dados;
                if (typeof currentAnimalV2 !== 'undefined') {
                  currentAnimalV2 = data.dados;
                }
              }
              
              // Habilitar campo de peso e bot√£o
              if (typeof window.habilitarCampoPesoV2 === 'function') {
                window.habilitarCampoPesoV2();
              } else {
                const pesoInput = document.getElementById('pesoValorV2');
                const gravarBtn = document.getElementById('pesoGravarBtnV2');
                
                if (pesoInput) {
                  pesoInput.disabled = false;
                  pesoInput.placeholder = '0,0';
                  pesoInput.style.backgroundColor = '';
                  pesoInput.style.cursor = 'text';
                  pesoInput.focus();
                  console.log('‚úÖ Campo de peso HABILITADO ap√≥s identifica√ß√£o do animal');
                }
                
                if (gravarBtn) {
                  gravarBtn.disabled = false;
                  gravarBtn.style.opacity = '';
                  gravarBtn.style.cursor = '';
                  console.log('‚úÖ Bot√£o Gravar HABILITADO');
                }
              }
              
              // Habilitar bot√£o "Finalizar e Gravar" - FOR√áAR HABILITA√á√ÉO
              console.log('üîò [ATUALIZAR SCANNER] Tentando habilitar bot√£o Finalizar e Gravar...');
              console.log('üîò [ATUALIZAR SCANNER] window.animalAtualV2:', window.animalAtualV2);
              const btnFinalizar2 = document.getElementById('btnFinalizarGravarV2');
              if (btnFinalizar2) {
                if (window.animalAtualV2 && window.animalAtualV2.id) {
                  btnFinalizar2.disabled = false;
                  btnFinalizar2.style.opacity = '1';
                  btnFinalizar2.style.cursor = 'pointer';
                  console.log('‚úÖ [ATUALIZAR SCANNER] Bot√£o Finalizar e Gravar HABILITADO diretamente!');
                } else {
                  console.warn('‚ö†Ô∏è [ATUALIZAR SCANNER] window.animalAtualV2 n√£o tem id:', window.animalAtualV2);
                }
              } else {
                console.error('‚ùå [ATUALIZAR SCANNER] Bot√£o btnFinalizarGravarV2 n√£o encontrado!');
              }
              
              // Tamb√©m tentar via fun√ß√£o se dispon√≠vel
              if (typeof window.atualizarBotaoFinalizarV2 === 'function') {
                window.atualizarBotaoFinalizarV2();
              } else if (typeof atualizarBotaoFinalizarV2 === 'function') {
                atualizarBotaoFinalizarV2();
              }
            } catch (e) {
              console.error('‚ùå Erro ao atualizar scanner:', e);
              processamentoConcluido = false;
            }
            return;
          } else if (typeof identificarBrinco === 'function') {
            // Se identificarBrinco existir, ela j√° processa tudo corretamente
            console.log('‚úÖ Usando identificarBrinco como fallback');
            processamentoConcluido = true;
            buscandoBrinco = false; // Liberar flag
            try {
              identificarBrinco(data.dados.codigo_sisbov || data.dados.numero_brinco || '');
              // Habilitar campo de peso e bot√£o ap√≥s identificar
              setTimeout(() => {
                if (typeof window.habilitarCampoPesoV2 === 'function') {
                  window.habilitarCampoPesoV2();
                }
                if (typeof atualizarBotaoFinalizarV2 === 'function') {
                  atualizarBotaoFinalizarV2();
                }
              }, 100);
            } catch (e) {
              console.error('‚ùå Erro ao identificar brinco:', e);
              processamentoConcluido = false;
            }
            return;
          }
          
          // Se n√£o encontrou e ainda tem tentativas, tentar novamente
          if (tentativas < maxTentativas) {
            // S√≥ mostrar log a cada 3 tentativas para n√£o poluir o console
            if (tentativas % 3 === 0 || tentativas === 0) {
            console.log(`‚è≥ Aguardando fun√ß√µes carregarem... (tentativa ${tentativas + 1}/${maxTentativas})`);
            }
            setTimeout(() => tentarProcessarAnimal(tentativas + 1), delay);
          } else {
            // √öltima tentativa: preencher cards diretamente
            if (!processamentoConcluido) {
              console.log('‚ö†Ô∏è Fun√ß√µes n√£o encontradas ap√≥s todas as tentativas, preenchendo cards diretamente...');
              processamentoConcluido = true;
              buscandoBrinco = false; // Liberar flag
            try {
              // Preencher cards diretamente no DOM
              const preencherCards = () => {
                const brinco = data.dados.numero_brinco || data.dados.codigo_sisbov || '';
                const sisbov = data.dados.codigo_sisbov || data.dados.numero_brinco || '';
                const raca = data.dados.raca || '';
                const sexo = data.dados.sexo || '';
                const dataNasc = data.dados.data_nascimento_format || data.dados.data_nascimento || '';
                const numeroManejo = data.dados.numero_manejo || '';
                const pesoAtual = data.dados.peso_atual || data.dados.ultimo_peso || null;
                
                const racaSexo = raca && sexo ? `${raca} ¬∑ ${sexo}` : (raca || sexo || '‚Äî');
                let pesoFormatado = '‚Äî';
                if (pesoAtual) {
                  const peso = typeof pesoAtual === 'number' ? pesoAtual : parseFloat(pesoAtual);
                  if (!isNaN(peso) && peso > 0) {
                    pesoFormatado = `${peso.toFixed(1).replace('.', ',')} kg`;
                  }
                }
                
                  // C√≥digo Eletr√¥nico (usado para leitura por radio frequ√™ncia)
                  const codigoEletronico = data.dados.codigo_eletronico || '';
                  const codigoEletronicoFormatado = (codigoEletronico && codigoEletronico !== 'None' && codigoEletronico !== '') ? codigoEletronico : '‚Äî';
                  
                  // Preencher campos b√°sicos
                  const scannerCodigoEletronicoEl = document.getElementById('scannerCodigoEletronicoV2');
                  const scannerSisbovEl = document.getElementById('scannerSisbovV2');
                  const scannerNumeroManejoEl = document.getElementById('scannerNumeroManejoV2');
                  const scannerRacaSexoEl = document.getElementById('scannerRacaSexoV2');
                  const scannerDataNascEl = document.getElementById('scannerDataNascV2');
                  const scannerUltimoPesoEl = document.getElementById('scannerUltimoPesoV2');
                  const scannerCategoriaEl = document.getElementById('scannerCategoriaV2');
                  const scannerDiagnosticoEl = document.getElementById('scannerDiagnosticoV2');
                  const resumoItemDiagnosticoEl = document.getElementById('resumoItemDiagnosticoV2');
                  const scannerPastoLoteEl = document.getElementById('scannerPastoLoteV2');
                  const scannerStatusBndEl = document.getElementById('scannerStatusBndV2');
                  
                  if (scannerCodigoEletronicoEl) scannerCodigoEletronicoEl.textContent = codigoEletronicoFormatado;
                  if (scannerSisbovEl) {
                    scannerSisbovEl.textContent = sisbov || brinco || '‚Äî';
                    scannerSisbovEl.className = 'resumo-value resumo-sisbov';
                  }
                  if (scannerNumeroManejoEl) {
                    scannerNumeroManejoEl.textContent = numeroManejo || '‚Äî';
                    scannerNumeroManejoEl.className = 'resumo-value resumo-numero-manejo';
                  }
                  if (scannerRacaSexoEl) scannerRacaSexoEl.textContent = racaSexo;
                  if (scannerDataNascEl) scannerDataNascEl.textContent = dataNasc || '‚Äî';
                  if (scannerUltimoPesoEl) scannerUltimoPesoEl.textContent = pesoFormatado;
                  
                  // Categoria
                  if (scannerCategoriaEl) {
                    const categoria = data.dados.categoria || '';
                    scannerCategoriaEl.textContent = categoria || '‚Äî';
                  }
                  
                  // Diagn√≥stico
                  const statusReprodutivo = data.dados.status_reprodutivo || '';
                  if (statusReprodutivo && resumoItemDiagnosticoEl && scannerDiagnosticoEl) {
                    resumoItemDiagnosticoEl.style.display = 'flex';
                    scannerDiagnosticoEl.textContent = statusReprodutivo;
                  } else if (resumoItemDiagnosticoEl) {
                    resumoItemDiagnosticoEl.style.display = 'none';
                  }
                  
                  // Pasto/Lote
                  if (scannerPastoLoteEl) {
                    const loteAtual = data.dados.lote_atual || '';
                    scannerPastoLoteEl.textContent = loteAtual || '‚Äî';
                  }
                  
                  // Status BND Sisbov
                  if (scannerStatusBndEl) {
                    const constaBnd = data.dados.consta_bnd !== undefined ? data.dados.consta_bnd : true;
                    const situacaoBnd = data.dados.situacao_bnd || '';
                    
                    scannerStatusBndEl.className = 'resumo-value';
                    
                    if (situacaoBnd === 'CONFORME' || (constaBnd && !situacaoBnd)) {
                      scannerStatusBndEl.textContent = 'Conforme BND';
                      scannerStatusBndEl.classList.add('status-bnd-conforme');
                    } else if (situacaoBnd === 'NAO_CONFORME' || (!constaBnd && !situacaoBnd)) {
                      scannerStatusBndEl.textContent = 'N√£o Conforme';
                      scannerStatusBndEl.classList.add('status-bnd-nao-conforme');
                    } else if (situacaoBnd === 'ATUALIZAR' || situacaoBnd === 'DIVERGENCIA' || situacaoBnd.includes('DIVERGENCIA') || situacaoBnd.includes('ATUALIZAR')) {
                      let divergenciaTexto = 'Diverg√™ncia de Cadastro';
                      if (situacaoBnd.includes(':')) {
                        divergenciaTexto = situacaoBnd.split(':')[1].trim();
                      } else if (situacaoBnd === 'ATUALIZAR') {
                        divergenciaTexto = 'C√≥digo existe na BND mas precisa ser atualizado no sistema';
                      }
                      scannerStatusBndEl.textContent = `Diverg√™ncia de Cadastro: ${divergenciaTexto}`;
                      scannerStatusBndEl.classList.add('status-bnd-divergencia');
                    } else {
                      scannerStatusBndEl.textContent = situacaoBnd || '‚Äî';
                    }
                }
                
                // Atualizar vari√°veis globais
                if (typeof window !== 'undefined') {
                  window.animalAtualV2 = data.dados;
                  if (typeof currentAnimalV2 !== 'undefined') {
                    currentAnimalV2 = data.dados;
                  }
                }
                
                  // ========== HABILITAR CAMPO DE PESO E BOT√ÉO ==========
                  if (typeof window.habilitarCampoPesoV2 === 'function') {
                    window.habilitarCampoPesoV2();
                  } else {
                    const pesoInput = document.getElementById('pesoValorV2');
                    const gravarBtn = document.getElementById('pesoGravarBtnV2');
                    
                    if (pesoInput) {
                      pesoInput.disabled = false;
                      pesoInput.placeholder = '0,0';
                      pesoInput.style.backgroundColor = '';
                      pesoInput.style.cursor = 'text';
                      pesoInput.focus();
                      console.log('‚úÖ Campo de peso HABILITADO ap√≥s identifica√ß√£o do animal (fallback)');
                    }
                    
                    if (gravarBtn) {
                      gravarBtn.disabled = false;
                      gravarBtn.style.opacity = '';
                      gravarBtn.style.cursor = '';
                      console.log('‚úÖ Bot√£o Gravar HABILITADO (fallback)');
                    }
                  }
                  
                  // Habilitar bot√£o "Finalizar e Gravar" - FOR√áAR HABILITA√á√ÉO
                  console.log('üîò [FALLBACK] Tentando habilitar bot√£o Finalizar e Gravar...');
                  console.log('üîò [FALLBACK] window.animalAtualV2:', window.animalAtualV2);
                  const btnFinalizar = document.getElementById('btnFinalizarGravarV2');
                  if (btnFinalizar) {
                    if (window.animalAtualV2 && window.animalAtualV2.id) {
                      btnFinalizar.disabled = false;
                      btnFinalizar.style.opacity = '1';
                      btnFinalizar.style.cursor = 'pointer';
                      console.log('‚úÖ [FALLBACK] Bot√£o Finalizar e Gravar HABILITADO diretamente!');
                    } else {
                      console.warn('‚ö†Ô∏è [FALLBACK] window.animalAtualV2 n√£o tem id:', window.animalAtualV2);
                    }
                  } else {
                    console.error('‚ùå [FALLBACK] Bot√£o btnFinalizarGravarV2 n√£o encontrado!');
                  }
                  
                  // Tamb√©m tentar via fun√ß√£o se dispon√≠vel
                  if (typeof window.atualizarBotaoFinalizarV2 === 'function') {
                    window.atualizarBotaoFinalizarV2();
                  } else if (typeof atualizarBotaoFinalizarV2 === 'function') {
                    atualizarBotaoFinalizarV2();
                  }
                  
                  console.log('‚úÖ Cards preenchidos diretamente (fallback)');
              };
              
              preencherCards();
            } catch (e) {
              console.error('‚ùå Erro ao preencher cards diretamente:', e);
                buscandoBrinco = false; // Garantir que a flag seja liberada mesmo em caso de erro
            }
            
            // N√£o mostrar alert em modo de simula√ß√£o ou quando fun√ß√£o n√£o est√° dispon√≠vel
            const emSimulacao = typeof SimulacaoSistema !== 'undefined' || modoSimulacao || data.simulado;
            if (!emSimulacao) {
                console.warn('‚ö†Ô∏è Animal encontrado, mas fun√ß√µes de processamento n√£o est√£o dispon√≠veis. Cards preenchidos via fallback.');
              }
            }
          }
        };
        
        // Iniciar tentativa de processamento
        tentarProcessarAnimal();
      } else if (data.status === 'estoque') {
        console.log('üì¶ Brinco encontrado no estoque');
        // Tentar abrir o modal de cadastro de estoque
        const tentarAbrirModal = () => {
          // Primeiro, tentar usar a fun√ß√£o se dispon√≠vel
          if (typeof abrirCadastroEstoqueV2 === 'function') {
            console.log('‚úÖ Usando abrirCadastroEstoqueV2');
            abrirCadastroEstoqueV2(data.dados || {}, valor);
            return true;
          } else if (typeof window.abrirCadastroEstoqueV2 === 'function') {
            console.log('‚úÖ Usando window.abrirCadastroEstoqueV2');
            window.abrirCadastroEstoqueV2(data.dados || {}, valor);
            return true;
          }
          
          // Se a fun√ß√£o n√£o estiver dispon√≠vel, tentar abrir o modal diretamente via DOM
          const overlay = document.getElementById('estoqueCadastroOverlayV2');
          if (overlay) {
            console.log('‚úÖ Abrindo modal diretamente via DOM');
            // Definir vari√°vel global se existir
            if (typeof estoqueCadastroCodigoAtual !== 'undefined') {
              estoqueCadastroCodigoAtual = valor;
            } else if (typeof window !== 'undefined') {
              window.estoqueCadastroCodigoAtual = valor;
            }
            // Preencher dados do brinco se houver elementos
            const brincoSpan = document.getElementById('estoqueCadastroBrincoV2');
            if (brincoSpan && valor) {
              brincoSpan.textContent = valor;
            }
            // Mostrar modal
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            // Inicializar event listeners
            setTimeout(() => {
              if (typeof inicializarModalEstoque === 'function') {
                inicializarModalEstoque();
              } else if (typeof window !== 'undefined' && typeof window.inicializarModalEstoque === 'function') {
                window.inicializarModalEstoque();
              }
            }, 100);
            // Garantir que os event listeners estejam ativos
            if (typeof configurarEventListenersEstoque === 'function') {
              configurarEventListenersEstoque();
            } else {
              // Se a fun√ß√£o n√£o estiver dispon√≠vel, configurar diretamente
              setTimeout(() => {
                const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
                const sexoInput = document.getElementById('estoqueCadastroSexoV2');
                const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
                const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
                
                if (idadeInput) {
                  idadeInput.addEventListener('input', function() {
                    const idadeMeses = this.value;
                    // Fun√ß√£o inline para calcular data de nascimento (fallback se a fun√ß√£o global n√£o estiver dispon√≠vel)
                    const calcularData = (meses) => {
                      const mesesNum = parseInt(meses, 10);
                      if (isNaN(mesesNum) || mesesNum < 0) return '';
                      const hoje = new Date();
                      const ano = hoje.getFullYear();
                      const mes = hoje.getMonth();
                      const dia = hoje.getDate();
                      const totalMeses = ano * 12 + mes - mesesNum;
                      const anoNasc = Math.floor(totalMeses / 12);
                      let mesNasc = totalMeses % 12;
                      if (mesNasc < 0) {
                        mesNasc += 12;
                      }
                      const dataNasc = new Date(anoNasc, mesNasc, dia);
                      const yyyy = dataNasc.getFullYear();
                      const mm = String(dataNasc.getMonth() + 1).padStart(2, '0');
                      const dd = String(dataNasc.getDate()).padStart(2, '0');
                      return `${yyyy}-${mm}-${dd}`;
                    };
                    // Tentar usar a fun√ß√£o global primeiro, depois a local, depois a inline
                    let dataCalc = '';
                    if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
                      dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
                    } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
                      dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
                    } else {
                      dataCalc = calcularData(idadeMeses);
                    }
                    if (dataNascInput && dataCalc) {
                      // Input type="date" precisa do formato YYYY-MM-DD
                      dataNascInput.value = dataCalc; // dataCalc j√° est√° no formato YYYY-MM-DD
                    }
                    // Validar e habilitar bot√£o (aceita idade OU data)
                    const sexo = sexoInput ? sexoInput.value.trim() : '';
                    const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
                    const temIdadeOuData = idadeMeses || dataNasc;
                    
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                if (sexoInput) {
                  sexoInput.addEventListener('change', function() {
                    const idade = idadeInput ? idadeInput.value.trim() : '';
                    const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
                    const sexo = this.value.trim();
                    const temIdadeOuData = idade || dataNasc;
                    
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                // Event listener para data de nascimento (calcular idade)
                if (dataNascInput) {
                  dataNascInput.addEventListener('change', function() {
                    const dataNasc = this.value.trim();
                    const idade = idadeInput ? idadeInput.value.trim() : '';
                    const sexo = sexoInput ? sexoInput.value.trim() : '';
                    
                    if (dataNasc && !idade) {
                      // Calcular idade em meses
                      const hoje = new Date();
                      const nasc = new Date(dataNasc);
                      const diffAnos = hoje.getFullYear() - nasc.getFullYear();
                      const diffMeses = hoje.getMonth() - nasc.getMonth();
                      const diffDias = hoje.getDate() - nasc.getDate();
                      let totalMeses = diffAnos * 12 + diffMeses;
                      if (diffDias < 0) {
                        totalMeses--;
                      }
                      if (totalMeses >= 0 && idadeInput) {
                        idadeInput.value = totalMeses.toString();
                        console.log('‚úÖ Idade calculada da data:', totalMeses, 'meses');
                      }
                    }
                    
                    // Validar bot√£o
                    const temIdadeOuData = idade || dataNasc;
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                // Garantir que o event listener do bot√£o esteja anexado
                if (okBtn) {
                  const temListener = okBtn.getAttribute('data-listener-anexado');
                  if (!temListener) {
                    console.log('‚úÖ Anexando event listener ao bot√£o de cadastro');
                    okBtn.setAttribute('data-listener-anexado', 'true');
                    okBtn.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log('üñ±Ô∏è Bot√£o de cadastro clicado!');
                      
                      // CHAMAR FUN√á√ÉO DIRETAMENTE - VERS√ÉO SIMPLIFICADA
                      console.log('üîç Verificando fun√ß√£o window.registrarCadastroEstoqueV2...');
                      
                      if (typeof window.registrarCadastroEstoqueV2 === 'function') {
                        const fnStr = window.registrarCadastroEstoqueV2.toString();
                        const isStub = fnStr.indexOf('[STUB]') !== -1 || fnStr.length < 500 || window.registrarCadastroEstoqueV2._isStub === true;
                        
                        console.log('  - Tamanho:', fnStr.length, 'caracteres');
                        console.log('  - Cont√©m [STUB]?', fnStr.indexOf('[STUB]') !== -1);
                        console.log('  - Flag _isStub:', window.registrarCadastroEstoqueV2._isStub);
                        console.log('  - √â stub?', isStub ? 'SIM ‚ùå' : 'N√ÉO ‚úÖ');
                        
                        if (!isStub) {
                          console.log('‚úÖ Chamando window.registrarCadastroEstoqueV2()...');
                          try {
                            window.registrarCadastroEstoqueV2();
                          } catch (err) {
                            console.error('‚ùå Erro ao executar fun√ß√£o:', err);
                            const mensagemErro = err.message || 'Erro desconhecido';
                            if (typeof mostrarToast === 'function') {
                              mostrarToast('Erro ao processar cadastro: ' + mensagemErro, 'error');
                            } else {
                              alert('Erro ao processar cadastro: ' + mensagemErro);
                            }
                          }
                        } else {
                          console.error('‚ùå Fun√ß√£o encontrada mas √© apenas o stub!');
                          const mensagem = 'Erro: fun√ß√£o de registro ainda n√£o foi carregada completamente. Aguarde alguns segundos e tente novamente.';
                          if (typeof mostrarToast === 'function') {
                            mostrarToast(mensagem, 'error');
                          } else {
                            alert(mensagem);
                          }
                        }
                      } else {
                        console.error('‚ùå Fun√ß√£o window.registrarCadastroEstoqueV2 n√£o encontrada!');
                        const mensagem = 'Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina com Ctrl+Shift+R (limpar cache).';
                        if (typeof mostrarToast === 'function') {
                          mostrarToast(mensagem, 'error');
                        } else {
                          alert(mensagem + '\n\nVerifique o console (F12) para mais detalhes.');
                        }
                      }
                    });
                  }
                }
              }, 100);
            }
            // Fun√ß√£o de valida√ß√£o que ser√° chamada ap√≥s os campos serem preenchidos
            const validarAposPreenchimento = () => {
              const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
              const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
              const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
              const sexoInput = document.getElementById('estoqueCadastroSexoV2');
              
              if (!okBtn || !sexoInput) {
                console.log('‚ö†Ô∏è Elementos do modal n√£o encontrados para valida√ß√£o');
                return;
              }
              
              const idade = idadeInput ? idadeInput.value.trim() : '';
              const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
              const sexo = sexoInput.value.trim();
              const temIdadeOuData = idade || dataNasc;
              
              console.log('üîç Valida√ß√£o manual:', { 
                idade, 
                dataNasc, 
                sexo, 
                temIdadeOuData,
                idadeInputExiste: !!idadeInput,
                dataNascInputExiste: !!dataNascInput,
                sexoInputExiste: !!sexoInput
              });
              
              if (temIdadeOuData && sexo) {
                console.log('‚úÖ Habilitando bot√£o manualmente');
                okBtn.disabled = false;
                okBtn.removeAttribute('disabled');
                okBtn.style.opacity = '1';
                okBtn.style.cursor = 'pointer';
                okBtn.classList.remove('disabled');
              } else {
                console.log('‚ùå Desabilitando bot√£o manualmente - faltando:', { idadeOuData: !temIdadeOuData, sexo: !sexo });
                okBtn.disabled = true;
                okBtn.setAttribute('disabled', 'disabled');
                okBtn.style.opacity = '0.6';
                okBtn.style.cursor = 'not-allowed';
                okBtn.classList.add('disabled');
              }
            };
            
            // Habilitar/desabilitar bot√£o baseado nos campos (com delay maior para garantir que campos estejam preenchidos)
            setTimeout(() => {
              if (typeof validarCamposEstoque === 'function') {
                validarCamposEstoque();
              } else {
                validarAposPreenchimento();
              }
              
              // Adicionar event listeners para validar em tempo real
              const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
              const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
              const sexoInput = document.getElementById('estoqueCadastroSexoV2');
              
              if (idadeInput) {
                idadeInput.addEventListener('input', validarAposPreenchimento);
                idadeInput.addEventListener('change', validarAposPreenchimento);
              }
              if (dataNascInput) {
                dataNascInput.addEventListener('input', validarAposPreenchimento);
                dataNascInput.addEventListener('change', validarAposPreenchimento);
              }
              if (sexoInput) {
                sexoInput.addEventListener('change', validarAposPreenchimento);
              }
            }, 300);
            return true;
          }
          
          return false;
        };
        
        // Tentar abrir imediatamente
        if (!tentarAbrirModal()) {
          // Se n√£o conseguiu, tentar novamente ap√≥s delays progressivos
          console.log('‚è≥ Modal n√£o encontrado, tentando novamente...');
          const tentativas = [300, 500, 1000, 2000];
          tentativas.forEach((delay, index) => {
            setTimeout(() => {
              if (tentarAbrirModal()) {
                console.log(`‚úÖ Modal aberto na tentativa ${index + 1}`);
                buscandoBrinco = false; // Liberar flag quando modal for aberto
              } else if (index === tentativas.length - 1) {
                // √öltima tentativa falhou
                buscandoBrinco = false; // Liberar flag
                if (typeof mostrarToast === 'function') {
                  mostrarToast('Brinco encontrado no estoque. Preencha os dados para cadastrar.', 'info');
                } else {
                  alert('Brinco encontrado no estoque. Use o cadastro de animais.');
                }
              }
            }, delay);
          });
        } else {
          buscandoBrinco = false; // Liberar flag se modal foi aberto imediatamente
        }
      } else if (data.status === 'animal_externo') {
        console.log('‚ö†Ô∏è Animal em outra propriedade');
        buscandoBrinco = false; // Liberar flag
        alert(data.mensagem || 'Animal pertence a outra propriedade.');
      } else {
        console.log('‚ùå Brinco n√£o encontrado. Status:', data.status);
        buscandoBrinco = false; // Liberar flag
        alert(data.mensagem || 'Brinco n√£o encontrado.');
      }
    } catch (error) {
      console.error('‚ùå Erro ao buscar brinco:', error);
      buscandoBrinco = false; // Liberar flag em caso de erro
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) loadingOverlay.classList.remove('show');
      alert('Erro ao buscar brinco: ' + error.message);
    }
  };
  
  console.log('‚úÖ Fun√ß√£o window.buscarBrincoSimples definida e dispon√≠vel!');
})();
</script>
<style>
  :root {
    /* Cores profissionais estilo Prodap/Wieus/Irancho */
    --monpec-primary: #2c3e50;
    --monpec-primary-dark: #1a252f;
    --monpec-accent: #3498db;
    --monpec-bg: #ecf0f1;
    --monpec-success: #27ae60;
    --monpec-danger: #e74c3c;
    --monpec-warning: #f39c12;
    --monpec-text: #2c3e50;
    --monpec-text-light: #7f8c8d;
    --monpec-border: #bdc3c7;
    --monpec-card-bg: #ffffff;
  }

  /* Estilo profissional e limpo */
  body.curral-v2 {
    background: #f5f6fa;
    font-family: 'Poppins', 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif !important;
    font-size: 0.95rem;
    color: var(--monpec-text);
  }
  
  body.curral-v2 p,
  body.curral-v2 span,
  body.curral-v2 div,
  body.curral-v2 td,
  body.curral-v2 th,
  body.curral-v2 label,
  body.curral-v2 small {
    color: #1a1a1a;
  }

  .curral-v2 .main-content {
    margin-left: 0 !important;
    margin-top: 0 !important;
    background: transparent !important;
  }

  .curral-v2 .header-fixo,
  .curral-v2 .sidebar,
  .curral-v2 .breadcrumb-inteligente {
    display: none !important;
  }

  .curral-v2-wrapper {
    max-width: 100%;
    width: 100%;
    margin: 20px auto 40px;
    padding: 0;
    overflow-x: visible;
  }
  
  /* Card ANIMAIS NA SESS√ÉO - ocupar toda a largura da p√°gina */
  .animais-na-sessao-full-width {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    box-sizing: border-box;
    position: relative;
  }
  
  /* Garantir que o wrapper n√£o limite a largura dos cards full-width */
  .curral-v2-wrapper > .animais-na-sessao-full-width {
    width: 100vw !important;
    max-width: 100vw !important;
    margin-left: calc(-50vw + 50%) !important;
    margin-right: calc(-50vw + 50%) !important;
    padding-left: 20px !important;
    padding-right: 20px !important;
  }
  
  /* Card de Progresso da Sess√£o */
  .progresso-sessao-container {
    width: 100%;
  }
  
  .progresso-sessao-linha {
    width: 100%;
  }
  
  .progresso-item {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }
  
  .progresso-label {
    font-size: 0.85rem;
    color: #78909c;
    font-weight: 500;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .progresso-valor {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1a1a1a;
    line-height: 1.2;
  }
  
  .progresso-valor.progresso-destaque {
    color: #4caf50;
  }
  
  .progresso-valor.progresso-tempo {
    font-size: 1.5rem;
    color: #1976d2;
    font-family: 'Courier New', monospace;
  }
  
  .progresso-detalhes {
    font-size: 0.9rem;
    color: #1a1a1a;
  }
  
  .progresso-bar {
    position: relative;
  }
  
  .progresso-bar-fill {
    min-width: 0%;
  }
  
  .progresso-bar-label {
    font-size: 0.85rem;
    color: #78909c;
    font-weight: 500;
  }

  /* Layout de duas colunas para v4 - 60% esquerdo / 40% direito (balan√ßa) */
  .curral-v4-layout {
    display: grid;
    grid-template-columns: 60% 40%;
    gap: 20px;
    margin-top: 20px;
    align-items: start;
  }

  @media (max-width: 1400px) {
    .curral-v4-layout {
      grid-template-columns: 1fr;
    }
  }

  /* Painel esquerdo - Configura√ß√£o e Identifica√ß√£o */
  .curral-v4-painel-esquerdo {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Painel direito - Pesagem e Manejos */
  .curral-v4-painel-direito {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
  }
  
  /* Wrapper para pesagem e manejos - layout horizontal */
  .pesagem-manejos-wrapper {
    width: 100%;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex: 1;
    min-height: 0;
    box-sizing: border-box;
  }
  
  /* Ajustar largura do card de balan√ßa para preencher melhor o espa√ßo */
  .balanca-eletronica-grande {
    width: 100% !important;
    max-width: 100% !important;
    flex: 1 !important;
  }
  
  /* Garantir que o container de aparta√ß√£o ocupe toda a largura */
  #balancaApartacaoContainer {
    width: 100% !important;
    max-width: 100% !important;
  }
  
  #balancaApartacaoContainer > div {
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Grid de lotes deve ocupar toda a largura dispon√≠vel */
  #balancaApartacaoContainer [style*="grid-template-columns: repeat(4, 1fr)"] {
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Grid horizontal para os cards de manejo - ajustado para n√£o ultrapassar */
  .pesagem-manejos-wrapper .row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 0;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 0;
    flex: 1;
    min-height: 0;
    align-items: stretch;
  }
  
  /* Garantir que todos os cards de manejo tenham a mesma altura */
  .pesagem-manejos-wrapper .row > div {
    display: flex;
    height: 100%;
  }
  
  .pesagem-manejos-wrapper .row .card-curral {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .pesagem-manejos-wrapper .row .col-md-6 {
    width: 100%;
    max-width: 100%;
    flex: 0 0 100%;
    padding: 0;
    box-sizing: border-box;
  }
  
  /* Garantir que o card ANIMAIS NA SESS√ÉO respeite o container */
  .curral-v2-wrapper > .card-curral:last-child,
  #cardRegistrosAnimalV2 {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    clear: both;
    margin-left: 0;
    margin-right: 0;
  }
  
  /* Garantir que o layout n√£o ultrapasse */
  .curral-v4-layout {
    max-width: 100%;
    box-sizing: border-box;
  }
  
  /* Ajustar cards do painel esquerdo para ocupar todo o espa√ßo dispon√≠vel */
  .curral-v4-painel-esquerdo .card-curral {
    width: 100%;
  }
  
  @media (max-width: 1600px) {
    .pesagem-manejos-wrapper .row {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 1200px) {
    .pesagem-manejos-wrapper .row {
      grid-template-columns: 1fr;
    }
  }

  /* Configura√ß√£o da Sess√£o com Tabs */
  .config-sessao-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #e0e0e0;
    border-radius: 8px 8px 0 0;
    overflow-x: auto;
  }

  .config-sessao-tab {
    flex: 1;
    min-width: 120px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  /* Cores espec√≠ficas para cada tab */
  .config-tab-pesagem {
    color: #1976d2; /* Azul */
  }
  
  .config-tab-pesagem.active {
    color: #1976d2;
    border-bottom-color: #1976d2;
    background: #fff;
  }
  
  .config-tab-pesagem:hover {
    background: #e3f2fd;
    color: #1565c0;
  }

  .config-tab-sanitario {
    color: #d32f2f; /* Vermelho */
  }
  
  .config-tab-sanitario.active {
    color: #d32f2f;
    border-bottom-color: #d32f2f;
    background: #fff;
  }
  
  .config-tab-sanitario:hover {
    background: #ffebee;
    color: #c62828;
  }

  .config-tab-reprodutivo {
    color: #7b1fa2; /* Roxo */
  }
  
  .config-tab-reprodutivo.active {
    color: #7b1fa2;
    border-bottom-color: #7b1fa2;
    background: #fff;
  }
  
  .config-tab-reprodutivo:hover {
    background: #f3e5f5;
    color: #6a1b9a;
  }

  .config-tab-movimentacao {
    color: #f57c00; /* Laranja */
  }
  
  .config-tab-movimentacao.active {
    color: #f57c00;
    border-bottom-color: #f57c00;
    background: #fff;
  }
  
  .config-tab-movimentacao:hover {
    background: #fff3e0;
    color: #ef6c00;
  }

  .config-sessao-content {
    padding: 16px;
    background: #fff;
    border-radius: 0 0 8px 8px;
    min-height: 100px;
  }

  /* Ficha Cadastral - Ajustado para ocupar melhor o espa√ßo horizontal */
  .ficha-cadastral-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 16px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }
  
  /* Status Reprodutivo dentro do grid - mesma linha que Cota Hilton */
  .ficha-status-reprodutivo-item {
    margin-top: 0;
    align-items: flex-start;
    grid-column: span 1; /* Ocupa apenas 1 coluna para ficar ao lado da Cota Hilton */
  }
  
  .ficha-status-reprodutivo-item .ficha-label {
    margin-bottom: 4px;
    color: #e91e63;
    font-weight: 600;
    line-height: 1.2;
    font-size: 0.75rem;
    text-transform: uppercase;
  }
  
  .ficha-status-reprodutivo-item .ficha-status-reprodutivo-content {
    width: 100%;
    min-height: 32px;
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    font-size: 0.85rem;
    box-sizing: border-box;
  }
  
  @media (max-width: 1200px) {
    .ficha-cadastral-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  @media (max-width: 768px) {
    .ficha-cadastral-grid {
      grid-template-columns: 1fr;
    }
  }

  .ficha-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .ficha-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #78909c;
    text-transform: uppercase;
    line-height: 1.4;
    margin-bottom: 2px;
    display: block;
  }

  .ficha-value {
    font-size: 0.9rem;
    font-weight: 500;
    color: #1a1a1a;
    padding: 6px 8px;
    line-height: 1.4;
    background: #f5f5f5;
    border-radius: 4px;
    min-height: 32px;
    display: flex;
    align-items: center;
  }

  /* Linha de Reprodu√ß√£o */
  .linha-reproducao-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    padding: 16px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }

  /* Balan√ßa Eletr√¥nica Grande */
  .balanca-eletronica-grande {
    background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 24px rgba(25, 118, 210, 0.3);
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    flex: 1;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin: 0;
    min-height: 0;
  }
  
  /* Ajustar largura do card de pesagem quando for aparta√ß√£o */
  #balancaApartacaoContainer {
    width: 100%;
    max-width: 100%;
  }
  
  #balancaApartacaoContainer > div {
    width: 100%;
    max-width: 100%;
  }

  .balanca-titulo {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.9;
  }

  .balanca-peso {
    font-size: 4rem;
    font-weight: 700;
    line-height: 1;
    margin: 20px 0;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .balanca-unidade {
    font-size: 1.5rem;
    font-weight: 500;
    opacity: 0.8;
    margin-left: 8px;
  }

  .curral-v2-header {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    background: var(--monpec-primary);
    color: #fff;
    padding: 14px 20px;
    border-radius: 4px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-bottom: 3px solid var(--monpec-accent);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    position: relative;
    overflow: hidden;
  }

  .curral-v2-header-left {
    flex: 1;
  }

  .curral-v2-header-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 8px 0;
    line-height: 1.2;
  }
  
  .curral-v2-header-fazenda {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    opacity: 0.95;
    letter-spacing: 0.5px;
  }

  .curral-v2-header-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 1;
    flex-wrap: wrap;
    max-width: 100%;
    box-sizing: border-box;
  }

  .curral-v2-header-sub {
    display: none;
  }

  .card-curral {
    background: var(--monpec-card-bg);
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border: 1px solid var(--monpec-border);
    margin-top: 16px;
    overflow: hidden;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .card-curral-header {
    padding: 12px 16px;
    border-bottom: 2px solid var(--monpec-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0;
  }

  .card-curral-header h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--monpec-text);
  }
  
  .card-curral-header h2 i {
    color: var(--monpec-accent);
    margin-right: 8px;
  }
  
  .card-curral-header span {
    color: var(--monpec-text-light);
    font-size: 0.78rem;
  }

  .card-curral-body {
    padding: 20px 24px;
    background: #ffffff;
  }

  .scanner-brinco-input {
    background: var(--monpec-card-bg);
    border-radius: 4px;
    padding: 18px 20px;
    color: var(--monpec-text);
    border: 1px solid var(--monpec-border);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .scanner-brinco-input label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--monpec-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: block;
    margin-bottom: 10px;
  }

  .scanner-brinco-input input {
    margin-top: 0;
    width: 100%;
    border-radius: 4px;
    border: 1px solid var(--monpec-border);
    background: var(--monpec-card-bg);
    color: var(--monpec-text);
    padding: 12px 14px;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: all 0.2s ease;
  }

  .scanner-brinco-input input:focus {
    outline: none;
    border-color: var(--monpec-accent);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }

  .scanner-brinco-input input::placeholder {
    color: var(--monpec-text-light);
  }

  .scanner-brinco-input small {
    display: block;
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    line-height: 1.4;
  }

  .scanner-brinco-buttons {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .scanner-brinco-buttons .btn {
    font-size: 0.8rem;
    padding: 7px 12px;
    border-radius: 4px;
    font-weight: 500;
    border: 1px solid var(--monpec-border);
    background: var(--monpec-card-bg);
    color: var(--monpec-text);
    transition: all 0.2s ease;
  }

  .scanner-brinco-buttons .btn:hover {
    background: var(--monpec-bg);
    border-color: var(--monpec-accent);
    transform: translateY(-1px);
  }

  .scanner-animal-resumo {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--monpec-border);
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .resumo-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: var(--monpec-bg);
    border-bottom: 1px solid var(--monpec-border);
    transition: background 0.2s ease;
  }

  .resumo-item:last-child {
    border-bottom: none;
    border-radius: 0 0 6px 6px;
  }

  .resumo-item:first-of-type {
    border-radius: 6px 6px 0 0;
  }

  .resumo-item:hover {
    background: #e0e6e8;
  }

  .resumo-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--monpec-text-light);
    text-transform: uppercase;
    letter-spacing: 0.2px;
  }
  
  .resumo-value.resumo-sisbov {
    color: #2196F3;
    font-weight: 500;
  }
  
  .resumo-value.resumo-numero-manejo {
    font-size: 1.1rem;
    font-weight: 700;
  }
  
  .resumo-value.status-bnd-conforme {
    color: #4caf50;
    font-weight: 600;
  }
  
  .resumo-value.status-bnd-nao-conforme {
    color: #f44336;
    font-weight: 600;
  }
  
  .resumo-value.status-bnd-divergencia {
    color: #ff9800;
    font-weight: 600;
    background-color: #fff3cd;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .resumo-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--monpec-text);
    text-align: right;
  }

  .peso-display-v2 {
    background: var(--monpec-card-bg);
    border-radius: 4px;
    padding: 24px 24px;
    color: var(--monpec-text);
    text-align: center;
    border: 1px solid var(--monpec-border);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    min-height: 600px;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .peso-display-v2-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--monpec-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
  }

  .peso-display-v2-input-wrapper {
    position: relative;
    margin: 10px 0;
  }

  .peso-display-v2-input {
    width: 100%;
    border-radius: 4px;
    border: 1px solid var(--monpec-border);
    background: var(--monpec-card-bg);
    color: var(--monpec-text);
    padding: 16px 50px 16px 16px;
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 1px;
    transition: all 0.2s ease;
  }

  .peso-display-v2-input:focus {
    outline: none;
    border-color: rgba(255,255,255,0.6);
    box-shadow: 0 0 0 3px rgba(255,255,255,0.2), 0 6px 16px rgba(0,0,0,0.25);
    background: rgba(255,255,255,0.2);
    transform: scale(1.02);
    color: #1b5e20 !important;
    font-weight: 700 !important;
  }

  .peso-display-v2-input:not(:disabled):hover {
    border-color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.18);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    color: #1b5e20 !important;
    font-weight: 700 !important;
  }

  .peso-display-v2-input:not(:disabled) {
    cursor: text;
    color: #1b5e20 !important;
    font-weight: 700 !important;
  }

  .peso-display-v2-input::placeholder {
    color: rgba(255,255,255,0.5);
    font-size: 2.2rem;
  }
  
  /* Garantir que o texto digitado sempre seja verde escuro e negrito */
  #pesoValorV2 {
    color: #1b5e20 !important;
    font-weight: 700 !important;
    font-size: 2.8rem !important;
  }
  
  #pesoValorV2:not(:placeholder-shown) {
    color: #1b5e20 !important;
    font-weight: 700 !important;
    font-size: 2.8rem !important;
  }
  
  #pesoValorV2:focus {
    font-size: 2.8rem !important;
  }

  .peso-display-v2-unit-input {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--monpec-text-light);
    pointer-events: none;
  }

  .peso-display-v2-buttons {
    margin-top: 14px;
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .peso-display-v2-buttons .btn {
    font-size: 0.85rem;
    padding: 10px 16px;
    border-radius: 4px;
    font-weight: 600;
    border: 1px solid var(--monpec-border);
    background: var(--monpec-card-bg);
    color: var(--monpec-text);
    transition: all 0.2s ease;
    flex: 1;
    min-width: 100px;
  }

  .peso-display-v2-buttons .btn:hover {
    background: var(--monpec-bg);
    border-color: var(--monpec-accent);
  }

  .peso-display-v2-buttons .btn-gravar {
    background: var(--monpec-success);
    border-color: var(--monpec-success);
    color: #fff;
  }

  .peso-display-v2-buttons .btn-gravar:hover {
    background: #229954;
    border-color: #229954;
  }

  .peso-display-v2-buttons .btn-limpar {
    background: var(--monpec-danger);
    border-color: var(--monpec-danger);
    color: #fff;
  }

  .peso-display-v2-buttons .btn-limpar:hover {
    background: #c0392b;
    border-color: #c0392b;
  }

  .peso-display-v2-info {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--monpec-border);
    display: flex;
    flex-direction: column;
    gap: 0;
    flex: 1;
  }
  
  .peso-grafico-container {
    width: 100%;
    min-height: 150px;
  }
  
  .peso-grafico-container canvas {
    width: 100% !important;
    height: 150px !important;
  }

  .peso-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 7px 9px;
    background: var(--monpec-bg);
    border-bottom: 1px solid var(--monpec-border);
    transition: background 0.2s ease;
  }

  .peso-info-item:last-child {
    border-bottom: none;
    border-radius: 0 0 6px 6px;
  }

  .peso-info-item:first-of-type {
    border-radius: 6px 6px 0 0;
  }

  .peso-info-item:hover {
    background: #e0e6e8;
  }

  .peso-info-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--monpec-text-light);
    text-transform: uppercase;
    letter-spacing: 0.2px;
  }

  .peso-info-value {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--monpec-text);
    text-align: right;
  }

  .btn-ficha-animal {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 1px solid var(--monpec-accent);
    background: var(--monpec-accent);
    color: #ffffff;
    transition: all 0.2s ease;
  }

  .btn-ficha-animal:hover {
    background: var(--monpec-primary-dark);
    border-color: var(--monpec-primary-dark);
    transform: translateY(-1px);
  }

  .registros-animal-section {
    margin-bottom: 20px;
  }

  .registros-animal-section-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--monpec-text);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--monpec-border);
  }

  .registro-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--monpec-bg);
    border-left: 3px solid var(--monpec-accent);
    margin-bottom: 6px;
    border-radius: 4px;
    border: 1px solid var(--monpec-border);
    border-left-width: 3px;
    transition: all 0.2s ease;
  }

  .registro-item:hover {
    background: #e0e6e8;
    transform: translateX(2px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .registro-item.pesagem {
    border-left-color: var(--monpec-success);
  }

  .registro-item.entrada {
    border-left-color: var(--monpec-warning);
  }

  .registro-item.saida {
    border-left-color: var(--monpec-danger);
  }

  .registro-item.movimentacao {
    border-left-color: var(--monpec-accent);
  }

  .registro-data {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--monpec-text-light);
    min-width: 100px;
  }

  .registro-descricao {
    font-size: 0.9rem;
    color: var(--monpec-text);
    flex: 1;
    margin: 0 12px;
  }

  .registro-valor {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--monpec-text);
    text-align: right;
    min-width: 80px;
  }

  .resumo-registros {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 2px solid var(--monpec-border);
  }

  .resumo-registros-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }

  .resumo-registros-item {
    background: var(--monpec-card-bg);
    padding: 12px;
    border-radius: 4px;
    border: 1px solid var(--monpec-border);
    border-left: 4px solid var(--monpec-accent);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .resumo-registros-item.pesagem {
    border-left-color: var(--monpec-success);
  }

  .resumo-registros-item.entrada {
    border-left-color: var(--monpec-warning);
  }

  .resumo-registros-item.saida {
    border-left-color: var(--monpec-danger);
  }

  .resumo-registros-item.movimentacao {
    border-left-color: var(--monpec-accent);
  }

  .resumo-registros-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--monpec-text-light);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .resumo-registros-total {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--monpec-text);
  }

  .resumo-registros-detalhes {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    margin-top: 4px;
  }

  /* Card √önico com Navega√ß√£o por Abas */
  .curral-tabs-card-main {
    margin-top: 18px;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    overflow: hidden;
  }

  .curral-tabs-nav {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #e0e0e0;
    overflow-x: auto;
  }

  .curral-tab-btn {
    flex: 1;
    min-width: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 18px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
    font-weight: 600;
    color: #666;
    white-space: nowrap;
  }

  .curral-tab-btn:hover {
    background: #f0f0f0;
    color: var(--monpec-primary);
  }

  .curral-tab-btn.active {
    color: var(--monpec-primary-dark);
    border-bottom-color: var(--monpec-primary);
    background: #fff;
  }

  .curral-tab-btn i {
    font-size: 1rem;
  }

  .curral-tabs-content {
    background: #fafafa;
  }

  .curral-tab-pane {
    padding: 18px;
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .curral-tab-pane.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .curral-tabs-main {
    margin-top: 18px;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
  }

  .curral-tabs-main .nav-link {
    padding: 10px 16px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    border-radius: 0;
    border-bottom: 2px solid transparent;
  }

  .curral-tabs-main .nav-link.active {
    color: var(--monpec-primary-dark);
    border-bottom-color: var(--monpec-primary);
    background: var(--monpec-bg);
  }

  .curral-tabs-main .nav-link i {
    margin-right: 6px;
  }

  .curral-tabs-main-body {
    padding: 14px 16px 16px;
  }

  .section-title-v2 {
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--monpec-primary-dark);
  }

  .section-subtitle-v2 {
    font-size: 0.8rem;
    color: #1a1a1a;
    margin-bottom: 10px;
  }

  .config-trabalho-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
  }

  .config-trabalho-card {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 8px 6px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .config-trabalho-card.active {
    border-color: var(--monpec-primary);
    background: var(--monpec-bg);
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  }

  .config-trabalho-card i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 4px;
    color: var(--monpec-primary);
  }

  .config-trabalho-extra {
    margin-top: 8px;
    font-size: 0.8rem;
    color: #1a1a1a;
  }

  /* Card de Configura√ß√£o de Pesagem - Redesenhado */
  .config-pesagem-card {
    background: var(--monpec-card-bg);
    border-radius: 8px;
    border: 1px solid var(--monpec-border);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    margin-bottom: 20px;
  }

  .config-pesagem-header {
    background: linear-gradient(135deg, var(--monpec-primary) 0%, var(--monpec-primary-dark) 100%);
    padding: 16px 20px;
    border-bottom: 2px solid var(--monpec-accent);
  }

  .config-pesagem-header-title {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .config-pesagem-header-title i {
    font-size: 1.2rem;
    color: var(--monpec-accent);
  }

  .config-pesagem-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .config-pesagem-edit-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .config-pesagem-edit-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
  }

  .config-pesagem-edit-btn i {
    font-size: 0.9rem;
  }

  /* Resumo da Configura√ß√£o */
  .config-pesagem-resumo {
    padding: 20px;
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, rgba(39, 174, 96, 0.02) 100%);
    border-bottom: 2px solid var(--monpec-success);
  }

  .config-pesagem-resumo-content {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }

  .config-pesagem-resumo-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    background: var(--monpec-success);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.5rem;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
  }

  .config-pesagem-resumo-text {
    flex: 1;
  }

  .config-pesagem-resumo-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--monpec-text);
    margin-bottom: 6px;
  }

  .config-pesagem-resumo-desc {
    font-size: 0.85rem;
    color: var(--monpec-text-light);
    line-height: 1.5;
    margin-bottom: 16px;
  }

  .config-pesagem-resumo-tarefas {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .config-pesagem-resumo-tarefa {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--monpec-card-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--monpec-text);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .config-pesagem-resumo-tarefa i {
    color: var(--monpec-success);
    font-size: 0.85rem;
  }

  /* Bot√£o Confirmar */
  .config-pesagem-actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--monpec-border);
    display: flex;
    justify-content: center;
  }

  .config-pesagem-confirm-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--monpec-success) 0%, #229954 100%);
    border: none;
    border-radius: 6px;
    color: #fff;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
  }

  .config-pesagem-confirm-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
    background: linear-gradient(135deg, #229954 0%, var(--monpec-success) 100%);
  }

  .config-pesagem-confirm-btn:active {
    transform: translateY(0);
  }

  .config-pesagem-confirm-btn i {
    font-size: 1rem;
  }

  .config-pesagem-body {
    padding: 20px;
    background: #fff;
  }

  .config-pesagem-description {
    font-size: 0.85rem;
    color: var(--monpec-text-light);
    margin-bottom: 24px;
    line-height: 1.5;
  }

  .config-pesagem-section {
    margin-bottom: 24px;
  }

  .config-pesagem-section-last {
    margin-bottom: 0;
    padding-top: 20px;
    border-top: 1px solid var(--monpec-border);
  }

  .config-pesagem-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--monpec-text);
    margin-bottom: 14px;
  }

  .config-pesagem-section-title .ms-auto {
    margin-left: auto;
  }

  /* Estilos para Sanidade V2 */
  .sanidade-lista-v2 {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 60px;
  }

  .sanidade-item-v2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--monpec-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .sanidade-item-v2:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
  }

  .sanidade-item-info-v2 {
    flex: 1;
  }

  .sanidade-item-nome-v2 {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .sanidade-item-detalhes-v2 {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
  }

  .sanidade-item-acoes-v2 {
    display: flex;
    gap: 8px;
  }

  .sanidade-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--monpec-text-light);
  }

  .sanidade-empty-state i {
    font-size: 2.5rem;
    color: var(--monpec-border);
    margin-bottom: 12px;
    display: block;
  }

  .sanidade-empty-state p {
    font-size: 0.9rem;
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--monpec-text);
  }

  .sanidade-empty-state small {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
  }

  .sanidade-rapida-grid-v2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }

  .sanidade-rapida-btn-v2 {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    background: var(--monpec-card-bg);
    border: 2px solid var(--monpec-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .sanidade-rapida-btn-v2:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .sanidade-rapida-btn-v2.active {
    border-color: #4caf50;
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
    font-weight: 600;
  }
  
  .reprodutivo-diagnostico-btn-v2.active {
    border-color: #4caf50;
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
    font-weight: 600;
  }

  .sanidade-rapida-btn-v2 i {
    font-size: 1.8rem;
    color: var(--monpec-accent);
  }

  .sanidade-rapida-btn-v2 span {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--monpec-text);
  }

  /* Estilos para Reprodutivo V2 */
  .reprodutivo-lista-v2 {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 60px;
  }

  .reprodutivo-diagnostico-grid-v2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }

  .reprodutivo-diagnostico-btn-v2 {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    background: var(--monpec-card-bg);
    border: 2px solid var(--monpec-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .reprodutivo-diagnostico-btn-v2:hover {
    border-color: var(--monpec-success);
    background: rgba(39, 174, 96, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="PRENHA"] {
    border-color: var(--monpec-success);
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="VAZIA"] {
    border-color: var(--monpec-danger);
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="ABORTO"] {
    border-color: var(--monpec-warning);
  }

  .reprodutivo-diagnostico-btn-v2 i {
    font-size: 1.8rem;
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="PRENHA"] i {
    color: var(--monpec-success);
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="VAZIA"] i {
    color: var(--monpec-danger);
  }

  .reprodutivo-diagnostico-btn-v2[data-diagnostico="ABORTO"] i {
    color: var(--monpec-warning);
  }

  .reprodutivo-diagnostico-btn-v2 span {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--monpec-text);
  }

  .reprodutivo-manejos-grid-v2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }

  .reprodutivo-manejo-card-v2 {
    padding: 16px;
    background: var(--monpec-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .reprodutivo-manejo-card-v2:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .reprodutivo-manejo-icon-v2 {
    font-size: 2rem;
    color: var(--monpec-accent);
    margin-bottom: 8px;
  }

  .reprodutivo-manejo-titulo-v2 {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .reprodutivo-manejo-desc-v2 {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    line-height: 1.4;
  }

  /* Estilos para Movimenta√ß√£o V2 */
  .movimentacao-form-v2 {
    background: var(--monpec-bg);
    padding: 16px;
    border-radius: 6px;
    border: 1px solid var(--monpec-border);
  }

  .movimentacao-rapida-grid-v2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }

  .movimentacao-rapida-btn-v2 {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    background: var(--monpec-card-bg);
    border: 2px solid var(--monpec-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .movimentacao-rapida-btn-v2:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .movimentacao-rapida-btn-v2 i {
    font-size: 1.8rem;
    color: var(--monpec-accent);
  }

  .movimentacao-rapida-btn-v2 span {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--monpec-text);
  }

  .movimentacao-historico-v2 {
    min-height: 100px;
  }

  .movimentacao-item-v2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--monpec-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .movimentacao-item-info-v2 {
    flex: 1;
  }

  .movimentacao-item-desc-v2 {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .movimentacao-item-data-v2 {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
  }

  /* Tabs de Tipo de Movimenta√ß√£o */
  .movimentacao-tipo-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 8px;
    margin-bottom: 20px;
  }

  .movimentacao-tipo-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 12px 16px;
    background: var(--monpec-bg);
    border: 2px solid var(--monpec-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .movimentacao-tipo-tab:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .movimentacao-tipo-tab.active {
    border-color: var(--monpec-primary);
    background: rgba(44, 62, 80, 0.08);
    box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
  }

  .movimentacao-tipo-tab i {
    font-size: 1.5rem;
    color: var(--monpec-text-light);
    transition: color 0.3s ease;
  }

  .movimentacao-tipo-tab.active i {
    color: var(--monpec-primary);
  }

  .movimentacao-tipo-tab span {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--monpec-text);
  }

  .movimentacao-form-tipo {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-label .text-danger {
    color: var(--monpec-danger);
    margin-left: 2px;
  }

  .config-pesagem-section-title i {
    color: var(--monpec-accent);
    font-size: 1rem;
  }

  .config-pesagem-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .config-pesagem-option {
    position: relative;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 14px 16px;
    background: var(--monpec-bg);
    border: 2px solid var(--monpec-border);
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .config-pesagem-option:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .config-pesagem-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .config-pesagem-option input[type="radio"]:checked + .config-pesagem-option-content {
    color: var(--monpec-primary);
  }

  .config-pesagem-option:has(input[type="radio"]:checked) {
    border-color: var(--monpec-success);
    background: rgba(39, 174, 96, 0.08);
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
  }

  .config-pesagem-option:has(input[type="radio"]:checked) .config-pesagem-option-icon {
    color: var(--monpec-success);
  }

  .config-pesagem-option-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .config-pesagem-option-icon {
    font-size: 1.5rem;
    color: var(--monpec-text-light);
    transition: color 0.3s ease;
  }

  .config-pesagem-option-text {
    flex: 1;
  }

  .config-pesagem-option-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .config-pesagem-option-desc {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
  }

  .config-pesagem-option-btn {
    margin-left: 8px;
    padding: 6px 10px;
    border: 1px solid var(--monpec-border);
    background: var(--monpec-card-bg);
    border-radius: 4px;
    color: var(--monpec-accent);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
  }

  .config-pesagem-option-btn:hover {
    background: var(--monpec-accent);
    color: #fff;
    border-color: var(--monpec-accent);
    transform: scale(1.05);
  }

  /* Tarefas Adicionais - Cards Melhorados */
  .config-trabalho-card {
    position: relative;
    border-radius: 8px;
    border: 2px solid var(--monpec-border);
    padding: 14px 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--monpec-card-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .config-trabalho-card:hover {
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .config-trabalho-card.active {
    border-color: var(--monpec-success);
    background: rgba(39, 174, 96, 0.08);
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
  }

  .config-trabalho-card-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border: 2px solid var(--monpec-border);
    border-radius: 4px;
    background: var(--monpec-card-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .config-trabalho-card.active .config-trabalho-card-checkbox {
    background: var(--monpec-success);
    border-color: var(--monpec-success);
  }

  .config-trabalho-card-checkbox input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .config-trabalho-card-check-icon {
    font-size: 0.7rem;
    color: #fff;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .config-trabalho-card.active .config-trabalho-card-check-icon {
    opacity: 1;
  }

  .config-trabalho-card-icon {
    font-size: 1.8rem;
    color: var(--monpec-text-light);
    margin-bottom: 4px;
    transition: color 0.3s ease;
  }

  .config-trabalho-card.active .config-trabalho-card-icon {
    color: var(--monpec-success);
  }

  .config-trabalho-card-text {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--monpec-text);
  }

  /* Auto-pr√≥ximo Switch */
  .config-pesagem-auto-proximo {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 12px;
    background: var(--monpec-bg);
    border-radius: 6px;
    border: 1px solid var(--monpec-border);
  }

  .config-pesagem-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .config-pesagem-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .config-pesagem-switch-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--monpec-border);
    transition: 0.3s;
    border-radius: 26px;
  }

  .config-pesagem-switch-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .config-pesagem-switch input:checked + .config-pesagem-switch-slider {
    background-color: var(--monpec-success);
  }

  .config-pesagem-switch input:checked + .config-pesagem-switch-slider:before {
    transform: translateX(22px);
  }

  .config-pesagem-switch input:focus + .config-pesagem-switch-slider {
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
  }

  /* Estilos inline para garantir funcionamento do switch no modal */
  #autoProximoModal:checked + .config-pesagem-switch-slider {
    background-color: #4caf50 !important;
  }

  #autoProximoModal:checked + .config-pesagem-switch-slider:before {
    transform: translateX(24px) !important;
  }

  .config-pesagem-auto-proximo-text {
    flex: 1;
  }

  .config-pesagem-auto-proximo-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .config-pesagem-auto-proximo-title i {
    color: var(--monpec-accent);
  }

  .config-pesagem-auto-proximo-desc {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    line-height: 1.4;
  }

  /* Estilos para aba Sanidade */
  .sanidade-config-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .sanidade-section {
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 16px;
  }

  .sanidade-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 0.95rem;
    font-weight: 700;
    color: #1a1a1a;
  }

  .sanidade-section-header i {
    color: #f44336;
    font-size: 1.1rem;
  }

  .sanidade-lista {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .sanidade-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;
    border-left: 3px solid #f44336;
  }

  .sanidade-item-info {
    flex: 1;
  }

  .sanidade-item-nome {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
  }

  .sanidade-item-detalhes {
    font-size: 0.8rem;
    color: #757575;
  }

  .sanidade-rapida-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }

  .sanidade-rapida-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
    font-weight: 600;
    color: #1a1a1a;
  }

  .sanidade-rapida-btn:hover {
    border-color: #f44336;
    background: #ffebee;
    transform: translateY(-2px);
  }

  .sanidade-rapida-btn i {
    font-size: 1.5rem;
    color: #f44336;
  }

  /* Estilos para aba Reprodutivo */
  .reprodutivo-config-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .reprodutivo-section {
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 16px;
  }

  .reprodutivo-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 0.95rem;
    font-weight: 700;
    color: #1a1a1a;
  }

  .reprodutivo-section-header i {
    color: #9c27b0;
    font-size: 1.1rem;
  }

  .reprodutivo-lista {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .reprodutivo-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;
    border-left: 3px solid #9c27b0;
  }

  .reprodutivo-item-info {
    flex: 1;
  }

  .reprodutivo-item-nome {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
  }

  .reprodutivo-item-detalhes {
    font-size: 0.8rem;
    color: #757575;
  }

  .reprodutivo-diagnostico-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
  }

  .reprodutivo-diagnostico-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
    font-weight: 600;
    color: #1a1a1a;
  }

  .reprodutivo-diagnostico-btn:hover {
    border-color: #9c27b0;
    background: #f3e5f5;
    transform: translateY(-2px);
  }

  .reprodutivo-diagnostico-btn i {
    font-size: 1.5rem;
    color: #9c27b0;
  }

  .reprodutivo-manejos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
  }

  .reprodutivo-manejo-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .reprodutivo-manejo-card:hover {
    border-color: #9c27b0;
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.15);
    transform: translateY(-2px);
  }

  .reprodutivo-manejo-icon {
    font-size: 2rem;
    color: #9c27b0;
    margin-bottom: 8px;
  }

  .reprodutivo-manejo-titulo {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
  }

  .reprodutivo-manejo-desc {
    font-size: 0.75rem;
    color: #757575;
  }

  /* Estilos para aba Movimenta√ß√£o */
  .movimentacao-config-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .movimentacao-section {
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 16px;
  }

  .movimentacao-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 0.95rem;
    font-weight: 700;
    color: #1a1a1a;
  }

  .movimentacao-section-header i {
    color: #ff9800;
    font-size: 1.1rem;
  }

  .movimentacao-form {
    margin-top: 12px;
  }

  .movimentacao-rapida-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }

  .movimentacao-rapida-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
    font-weight: 600;
    color: #1a1a1a;
  }

  .movimentacao-rapida-btn:hover {
    border-color: #ff9800;
    background: #fff3e0;
    transform: translateY(-2px);
  }

  .movimentacao-rapida-btn i {
    font-size: 1.5rem;
    color: #ff9800;
  }

  .movimentacao-historico {
    margin-top: 12px;
  }

  .movimentacao-historico-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 6px;
    margin-bottom: 6px;
    border-left: 3px solid #ff9800;
  }

  .movimentacao-historico-info {
    flex: 1;
  }

  .movimentacao-historico-data {
    font-size: 0.75rem;
    color: #757575;
    margin-bottom: 4px;
  }

  .movimentacao-historico-desc {
    font-size: 0.85rem;
    color: #1a1a1a;
    font-weight: 500;
  }

  /* Popup de confirma√ß√£o de brinco */
  .curral-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none !important;
    align-items: center;
    z-index: 10001; /* Acima de modais de erro (que geralmente s√£o 10000) */
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .curral-modal-overlay.show {
    display: flex !important;
    opacity: 1;
  }

  .curral-modal {
    background: #fff;
    border-radius: 10px;
    padding: 16px 18px;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }

  .curral-modal-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--monpec-primary-dark);
    margin-bottom: 8px;
  }

  .curral-modal-body {
    font-size: 0.85rem;
    color: #1a1a1a;
  }

  .curral-modal-body p {
    margin: 2px 0;
  }

  .curral-modal-body strong {
    font-weight: 700;
  }

  .curral-modal-footer {
    margin-top: 12px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .curral-modal-footer .btn {
    font-size: 0.8rem;
    padding: 6px 10px;
    border-radius: 6px;
  }
  
  /* Estilos para alertas dentro dos modais */
  .curral-modal-body .alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid;
    font-size: 0.9rem;
  }
  
  .curral-modal-body .alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }
  
  .curral-modal-body .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
  }
  
  .curral-modal-body .alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }

  /* Popup de diagn√≥stico r√°pido */
  .diagnostico-opcoes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 8px;
    margin-top: 8px;
  }

  .diagnostico-btn {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 8px 6px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
  }

  .diagnostico-btn.diagnostico-p {
    background: #e8f5e9;
    border-color: #66bb6a;
    color: #2e7d32;
  }

  .diagnostico-btn.diagnostico-v {
    background: #ffebee;
    border-color: #ef5350;
    color: #b71c1c;
  }

  .diagnostico-btn.diagnostico-n {
    background: #eceff1;
    border-color: #b0bec5;
    color: #455a64;
  }

  .diagnostico-btn.diagnostico-d {
    background: #fff8e1;
    border-color: #ffb300;
    color: #ef6c00;
  }

  .diagnostico-btn.diagnostico-r {
    background: #ede7f6;
    border-color: #7e57c2;
    color: #4527a0;
  }

  .diagnostico-btn.active {
    box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.5);
  }

  /* Popup de cadastro r√°pido a partir do estoque */
  .estoque-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 8px;
    margin-top: 8px;
    font-size: 0.8rem;
  }

  .estoque-form-grid label {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .estoque-form-grid input,
  .estoque-form-grid select {
    width: 100%;
    font-size: 0.8rem;
    padding: 4px 6px;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;
  }

  .toast-curral {
    min-width: 300px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.3s ease-out;
  }

  .toast-curral.success {
    border-left: 4px solid #4caf50;
  }

  .toast-curral.error {
    border-left: 4px solid #f44336;
  }

  .toast-curral.info {
    border-left: 4px solid #2196f3;
  }

  .toast-curral.warning {
    border-left: 4px solid #ff9800;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Loading overlay */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2500;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-spinner {
    background: #fff;
    border-radius: 10px;
    padding: 24px 32px;
    text-align: center;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--monpec-primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Estat√≠sticas r√°pidas */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .stat-card {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
  }

  .stat-card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--monpec-primary-dark);
    margin: 4px 0;
  }

  .stat-card-label {
    font-size: 0.75rem;
    color: #607d8b;
    text-transform: uppercase;
  }

  /* Cat√°logo de manejos */
  .catalogo-manejos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 12px;
  }

  .manejo-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .manejo-card:hover {
    border-color: var(--monpec-primary);
    box-shadow: 0 2px 8px rgba(30, 136, 229, 0.15);
  }

  .manejo-card-title {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--monpec-primary-dark);
    margin-bottom: 4px;
  }

  .manejo-card-desc {
    font-size: 0.75rem;
    color: #607d8b;
  }

  /* Resumo de lotes */
  .lotes-resumo {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 12px;
  }

  .lote-card {
    background: var(--monpec-card-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 4px;
    padding: 12px;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .lote-card:hover {
    border-color: var(--monpec-accent);
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transform: translateY(-1px);
  }

  .lote-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
  }

  .lote-card-nome {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--monpec-text);
  }

  .lote-card-info {
    font-size: 0.75rem;
    color: var(--monpec-text-light);
    margin-top: 4px;
  }

  /* Cards de Estat√≠sticas - Cores Profissionais Melhoradas */
  .card-stats-curral {
    background: white;
    border-radius: 14px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
  }

  .card-stats-curral::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0.6;
  }

  .card-stats-curral:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .card-stats-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.4rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 1;
  }

  .card-stats-content {
    flex: 1;
    min-width: 0;
    position: relative;
    z-index: 1;
  }

  .card-stats-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: #1a1a1a;
    line-height: 1.2;
    letter-spacing: -0.5px;
  }

  .card-stats-label {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Responsividade para melhor aproveitamento horizontal */
  @media (min-width: 1400px) {
    .curral-v2-wrapper {
      max-width: 1920px;
      padding: 0 30px;
    }
    
    .card-stats-curral {
      padding: 18px;
    }
    
    .card-stats-icon {
      width: 64px;
      height: 64px;
      font-size: 1.6rem;
    }
    
    .card-stats-value {
      font-size: 2rem;
    }
    
    .card-stats-label {
      font-size: 0.85rem;
    }
  }

  @media (min-width: 1600px) {
    .curral-v2-wrapper {
      max-width: 100%;
      padding: 0 40px;
    }
  }

  @media (max-width: 1200px) {
    .card-stats-value {
      font-size: 1.6rem;
    }
    
    .card-stats-icon {
      width: 50px;
      height: 50px;
      font-size: 1.3rem;
    }
  }

  @media (max-width: 992px) {
    .curral-v2-wrapper {
      padding: 0 15px;
    }
  }

  /* Cards de Manejos Selecionados - Card Principal por Categoria */
  .manejo-categoria-card {
    background: white;
    border: 1px solid var(--monpec-border);
    border-radius: 8px;
    border-left: 4px solid;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
  }

  .manejo-categoria-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }

  .manejo-categoria-card.pesagem {
    border-left-color: #4caf50;
  }

  .manejo-categoria-card.sanidade {
    border-left-color: #f44336;
  }

  .manejo-categoria-card.reprodutivo {
    border-left-color: #9c27b0;
  }

  .manejo-categoria-card.movimentacao {
    border-left-color: #ff9800;
  }

  .manejo-categoria-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    cursor: pointer;
  }

  .manejo-categoria-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
    color: white;
  }

  .manejo-categoria-icon.pesagem {
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
  }

  .manejo-categoria-icon.sanidade {
    background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
  }

  .manejo-categoria-icon.reprodutivo {
    background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);
  }

  .manejo-categoria-icon.movimentacao {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  }

  .manejo-categoria-title {
    flex: 1;
    font-size: 1rem;
    font-weight: 600;
    color: var(--monpec-text);
  }

  .manejo-categoria-count {
    font-size: 0.85rem;
    color: #78909c;
    background: white;
    padding: 2px 8px;
    border-radius: 12px;
  }

  .manejo-categoria-body {
    padding: 8px 12px 12px;
    display: none;
    max-height: 400px;
    overflow-y: auto;
  }

  .manejo-categoria-card.expandido .manejo-categoria-body {
    display: block;
  }
  
  .manejo-categoria-card.expandido .manejo-categoria-header .fa-chevron-down {
    transform: rotate(180deg);
  }

  .manejo-tipo-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin: 4px 0;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .manejo-tipo-item:hover {
    background: #f5f5f5;
    border-color: #1e3a5f;
    transform: translateX(4px);
  }

  .manejo-tipo-item-nome {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--monpec-text);
    flex: 1;
  }

  .manejo-tipo-item-acoes {
    display: flex;
    gap: 8px;
  }

  .manejo-tipo-item-btn {
    background: transparent;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .manejo-tipo-item-btn:hover {
    background: #1e3a5f;
    color: white;
    border-color: #1e3a5f;
  }

  .manejo-tipo-item-remover {
    background: transparent;
    border: none;
    color: #78909c;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .manejo-tipo-item-remover:hover {
    background: #ffebee;
    color: #f44336;
  }

  .manejo-selecionado-card.pesagem {
    border-left-color: #4caf50;
  }

  .manejo-selecionado-card.sanidade {
    border-left-color: #f44336;
  }

  .manejo-selecionado-card.reprodutivo {
    border-left-color: #9c27b0;
  }

  .manejo-selecionado-card.movimentacao {
    border-left-color: #ff9800;
  }

  .manejo-selecionado-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    flex-shrink: 0;
    color: white;
  }

  .manejo-selecionado-icon.pesagem {
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
  }

  .manejo-selecionado-icon.sanidade {
    background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
  }

  .manejo-selecionado-icon.reprodutivo {
    background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);
  }

  .manejo-selecionado-icon.movimentacao {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  }

  .manejo-selecionado-content {
    flex: 1;
    min-width: 0;
  }

  .manejo-selecionado-titulo {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .manejo-selecionado-descricao {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    line-height: 1.3;
  }

  .manejo-selecionado-remover {
    background: transparent;
    border: none;
    color: #78909c;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }

  .manejo-selecionado-remover:hover {
    background: #f5f5f5;
    color: #f44336;
  }

  .manejo-selecionado-card.card-expandido {
    background: #f8f9fa;
    border-left-width: 6px;
  }

  .manejo-selecionado-acoes {
    animation: slideDown 0.2s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .manejo-selecionado-acoes .btn {
    font-size: 0.75rem;
    padding: 4px 8px;
  }

  .manejo-selecionado-acoes .btn i {
    margin-right: 4px;
  }

  .animal-trabalhado-info {
    flex: 1;
    min-width: 0;
  }

  .animal-trabalhado-brinco {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--monpec-text);
    margin-bottom: 2px;
  }

  .animal-trabalhado-detalhes {
    font-size: 0.75rem;
    color: var(--monpec-text-light);
  }

  .animal-trabalhado-peso {
    text-align: right;
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--monpec-text);
  }

  .animal-trabalhado-acoes {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .btn-animal-trabalhado {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    background: var(--monpec-card-bg);
    border: 1px solid var(--monpec-border);
    color: var(--monpec-text);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s ease;
  }

  .btn-animal-trabalhado:hover {
    background: var(--monpec-accent);
    border-color: var(--monpec-accent);
    color: #fff;
  }

  /* Cards Indicadores de Manejo Ativo */
  .manejo-indicadores-container {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    padding: 0 4px;
  }

  .manejo-indicador-card {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid var(--monpec-border);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--monpec-text);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
    opacity: 0.85;
  }

  .manejo-indicador-card.ativo {
    opacity: 1;
    border-color: var(--monpec-accent);
    background: rgba(52, 152, 219, 0.08);
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.15);
  }

  .manejo-indicador-card i {
    font-size: 0.7rem;
    color: var(--monpec-accent);
  }

  .manejo-indicador-card.ativo i {
    color: var(--monpec-primary);
  }

  .manejo-indicador-card.rotina {
    border-left: 3px solid var(--monpec-success);
  }

  .manejo-indicador-card.rotina.ativo {
    background: rgba(39, 174, 96, 0.1);
    border-color: var(--monpec-success);
  }

  .manejo-indicador-card.rotina.ativo i {
    color: var(--monpec-success);
  }

  .manejo-indicador-card.aparte {
    border-left: 3px solid var(--monpec-warning);
  }

  .manejo-indicador-card.aparte.ativo {
    background: rgba(241, 196, 15, 0.1);
    border-color: var(--monpec-warning);
  }

  .manejo-indicador-card.aparte.ativo i {
    color: var(--monpec-warning);
  }

  .manejo-indicador-card.sanidade {
    border-left: 3px solid var(--monpec-danger);
  }

  .manejo-indicador-card.sanidade.ativo {
    background: rgba(231, 76, 60, 0.1);
    border-color: var(--monpec-danger);
  }

  .manejo-indicador-card.sanidade.ativo i {
    color: var(--monpec-danger);
  }

  .manejo-indicador-card.reprodutivo {
    border-left: 3px solid #9b59b6;
  }

  .manejo-indicador-card.reprodutivo.ativo {
    background: rgba(155, 89, 182, 0.1);
    border-color: #9b59b6;
  }

  .manejo-indicador-card.reprodutivo.ativo i {
    color: #9b59b6;
  }

  .manejo-indicador-card.movimentacao {
    border-left: 3px solid #3498db;
  }

  .manejo-indicador-card.movimentacao.ativo {
    background: rgba(52, 152, 219, 0.1);
    border-color: #3498db;
  }

  .manejo-indicador-card.movimentacao.ativo i {
    color: #3498db;
  }

  /* Popup de Indica√ß√£o de Aparta√ß√£o */
  .popup-apartacao {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .popup-apartacao.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .popup-apartacao-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 32px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 16px;
    min-width: 280px;
    text-align: center;
  }

  .popup-apartacao-icon {
    font-size: 2.5rem;
    opacity: 0.9;
  }

  .popup-apartacao-text {
    flex: 1;
  }

  .popup-apartacao-title {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .popup-apartacao-nome {
    font-size: 1.5rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Cores diferentes para aparta√ß√µes */
  .popup-apartacao.cor-1 .popup-apartacao-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .popup-apartacao.cor-2 .popup-apartacao-content {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .popup-apartacao.cor-3 .popup-apartacao-content {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .popup-apartacao.cor-4 .popup-apartacao-content {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  }

  .popup-apartacao.cor-5 .popup-apartacao-content {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }

  .popup-apartacao.cor-6 .popup-apartacao-content {
    background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
  }

  /* Lista de Aparta√ß√µes */
  .apartacao-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--monpec-card-bg);
    border: 1px solid var(--monpec-border);
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .apartacao-item-info {
    flex: 1;
  }

  .apartacao-item-nome {
    font-weight: 600;
    color: var(--monpec-text);
    margin-bottom: 4px;
  }

  .apartacao-item-faixa {
    font-size: 0.85rem;
    color: var(--monpec-text-light);
  }

  .apartacao-item-acoes {
    display: flex;
    gap: 4px;
  }

  /* ========== SISTEMA DE SIMULA√á√ÉO PROFISSIONAL ========== */
  .simulacao-painel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 450px;
    max-height: 500px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 9998;
    display: none;
    flex-direction: column;
    border: 1px solid var(--monpec-border);
  }

  .simulacao-painel.ativo {
    display: flex;
  }

  .simulacao-painel.minimizado {
    max-height: 50px;
  }

  .simulacao-painel.minimizado .simulacao-painel-body {
    display: none;
  }

  .simulacao-painel-header {
    padding: 12px 16px;
    background: var(--monpec-primary);
    color: #fff;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
  }

  .simulacao-painel-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .simulacao-painel-controles {
    display: flex;
    gap: 6px;
  }

  .simulacao-painel-controles .btn {
    padding: 4px 8px;
    font-size: 0.75rem;
    color: #fff;
    border-color: rgba(255, 255, 255, 0.5);
  }

  .simulacao-painel-controles .btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.8);
  }

  .simulacao-painel-body {
    padding: 12px;
    overflow-y: auto;
    max-height: 436px;
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .simulacao-log {
    padding: 6px 8px;
    margin-bottom: 4px;
    border-left: 3px solid transparent;
    border-radius: 2px;
    display: flex;
    gap: 8px;
    animation: logFadeIn 0.3s ease;
  }

  @keyframes logFadeIn {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .simulacao-log.info {
    background: rgba(52, 152, 219, 0.1);
    border-left-color: #3498db;
  }

  .simulacao-log.success {
    background: rgba(39, 174, 96, 0.1);
    border-left-color: #27ae60;
  }

  .simulacao-log.warning {
    background: rgba(241, 196, 15, 0.1);
    border-left-color: #f1c40f;
  }

  .simulacao-log.error {
    background: rgba(231, 76, 60, 0.1);
    border-left-color: #e74c3c;
  }

  .simulacao-log-time {
    color: #888;
    font-size: 0.75rem;
    min-width: 70px;
    flex-shrink: 0;
  }

  .simulacao-log-message {
    flex: 1;
    word-break: break-word;
  }

  .simulacao-log.success .simulacao-log-message {
    color: #2ecc71;
  }

  .simulacao-log.warning .simulacao-log-message {
    color: #f39c12;
  }

  .simulacao-log.error .simulacao-log-message {
    color: #e74c3c;
  }

  .simulacao-log.info .simulacao-log-message {
    color: #3498db;
  }

  .btn-simulacao {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    z-index: 9999 !important;
    padding: 12px 20px;
    border-radius: 8px;
    border: none;
    background: var(--monpec-warning);
    color: #fff !important;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex !important;
    align-items: center;
    gap: 8px;
  }

  .btn-simulacao:hover {
    background: #e67e22;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  }

  .btn-simulacao.ativo {
    background: var(--monpec-danger);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  /* Indicador de status offline/online - agora dentro do header */
  .status-conexao {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s;
    white-space: nowrap;
  }

  .status-conexao.online {
    background: rgba(76, 175, 80, 0.9);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .status-conexao.offline {
    background: rgba(244, 67, 54, 0.9);
    color: #fff;
    animation: pulse 2s infinite;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .status-conexao.sincronizando {
    background: rgba(255, 152, 0, 0.9);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .status-conexao-badge {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .sync-pendentes {
    position: fixed;
    top: 60px;
    left: 20px;
    z-index: 1999;
    padding: 6px 10px;
    background: #ff9800;
    color: #fff;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: none;
  }

  .sync-pendentes.show {
    display: block;
  }

  .sync-pendentes:hover {
    background: #f57c00;
  }

  /* Indicador de sess√£o ativa - agora dentro do header */
  .sessao-ativa-header {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 8px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 260px;
    max-width: 320px;
    border-left: 3px solid rgba(255, 255, 255, 0.5);
    opacity: 1;
    transition: opacity 0.5s ease-out, width 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out;
    color: #1a1a1a;
    overflow: hidden;
    position: relative;
    z-index: 10;
    flex-shrink: 1;
    box-sizing: border-box;
  }
  
  .sessao-ativa-header.escondido {
    opacity: 0;
    pointer-events: none;
    width: 0;
    min-width: 0;
    max-width: 0;
    padding: 0;
    margin: 0;
    overflow: hidden;
    transition: opacity 0.5s ease-out, width 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out;
  }

  .sessao-ativa-header.sem-sessao {
    border-left-color: #9e9e9e;
    opacity: 0.8;
  }

  .sessao-ativa-linha1 {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-bottom: 4px;
  }

  .sessao-ativa-titulo {
    font-size: 0.6rem;
    color: #607d8b;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .sessao-ativa-nome {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--monpec-primary-dark);
    margin: 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .sessao-ativa-linha2 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    margin-top: 0;
    flex-wrap: nowrap;
  }

  .sessao-ativa-stats {
    display: flex;
    gap: 6px;
    flex: 1;
    align-items: center;
  }

  .sessao-stat-item {
    text-align: center;
    flex: 1;
    min-width: 0;
  }

  .sessao-stat-valor {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--monpec-primary);
    line-height: 1;
  }

  .sessao-stat-label {
    font-size: 0.5rem;
    color: #78909c;
    margin-top: 1px;
    line-height: 1;
  }

  .sessao-ativa-acoes {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .sessao-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 5px;
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .sessao-btn-nova {
    background: var(--monpec-primary);
    color: #fff;
  }

  .sessao-btn-nova:hover {
    background: var(--monpec-primary-dark);
  }

  .sessao-btn-encerrar {
    background: #f44336;
    color: #fff;
  }

  .sessao-btn-encerrar:hover {
    background: #d32f2f;
  }

  .sessao-btn-ver {
    background: #e0e0e0;
    color: #424242;
  }

  .sessao-btn-ver:hover {
    background: #bdbdbd;
  }

  /* ========== MODAL DE CADASTRO DE TRABALHO ========== */
  .modal-cadastro-trabalho {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(2px);
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
  }

  .modal-cadastro-trabalho-content {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideIn 0.3s ease;
  }

  .modal-cadastro-trabalho-header {
    padding: 20px 24px;
    border-bottom: 2px solid var(--monpec-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--monpec-primary) 0%, var(--monpec-primary-dark) 100%);
    color: #fff;
    border-radius: 8px 8px 0 0;
  }

  .modal-cadastro-trabalho-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .modal-cadastro-trabalho-header .modal-close {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .modal-cadastro-trabalho-header .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .modal-cadastro-trabalho-body {
    padding: 24px;
  }

  .modal-cadastro-trabalho-body .form-group {
    margin-bottom: 20px;
  }

  .modal-cadastro-trabalho-body label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--monpec-text);
    font-size: 0.9rem;
  }

  .modal-cadastro-trabalho-body .form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--monpec-border);
    border-radius: 4px;
    font-size: 0.95rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .modal-cadastro-trabalho-body .form-control:focus {
    outline: none;
    border-color: var(--monpec-accent);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
  }

  .modal-cadastro-trabalho-body textarea.form-control {
    resize: vertical;
    min-height: 80px;
  }

  .modal-cadastro-trabalho-body .form-text {
    font-size: 0.8rem;
    color: var(--monpec-text-light);
    margin-top: 4px;
  }

  .modal-cadastro-trabalho-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--monpec-border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
  }

  .modal-cadastro-trabalho-footer .btn {
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .modal-cadastro-trabalho-footer .btn-secondary {
    background: #e0e0e0;
    color: #424242;
  }

  .modal-cadastro-trabalho-footer .btn-secondary:hover {
    background: #bdbdbd;
  }

  .modal-cadastro-trabalho-footer .btn-primary {
    background: linear-gradient(135deg, var(--monpec-accent) 0%, #2980b9 100%);
    color: #fff;
  }

  .modal-cadastro-trabalho-footer .btn-primary:hover {
    background: linear-gradient(135deg, #2980b9 0%, var(--monpec-accent) 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .modal-cadastro-trabalho-content {
      width: 95%;
      max-height: 95vh;
    }

    .modal-cadastro-trabalho-header {
      padding: 16px 20px;
    }

    .modal-cadastro-trabalho-body {
      padding: 20px;
    }

    .modal-cadastro-trabalho-footer {
      padding: 12px 20px;
      flex-direction: column;
    }

    .modal-cadastro-trabalho-footer .btn {
      width: 100%;
      justify-content: center;
    }
  }
  /* ========== JANELA MODAL DO MENU LATERAL EM TELA CHEIA ========== */
  .menu-lateral-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .menu-lateral-fullscreen.show {
    display: flex;
    opacity: 1;
  }
  
  .menu-lateral-window {
    position: absolute;
    width: 100%;
    height: 100%;
    background: white;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }
  
  .menu-lateral-window.minimized {
    width: 400px;
    height: 500px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 8px;
    overflow: hidden;
  }
  
  .menu-lateral-window.maximized {
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    transform: none;
    border-radius: 0;
  }
  
  .menu-lateral-window-header {
    background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
  }
  
  .menu-lateral-window-title {
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .menu-lateral-window-controls {
    display: flex;
    gap: 8px;
  }
  
  .menu-lateral-window-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  
  .menu-lateral-window-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }
  
  .menu-lateral-window-btn.close:hover {
    background: #e53e3e;
  }
  
  .menu-lateral-window-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }
  
  .menu-lateral-window-content .sidebar {
    position: relative;
    width: 100%;
    height: 100%;
    transform: none;
    box-shadow: none;
  }
</style>
{% endblock %}

{% block body_attrs %} class="curral-v2"{% endblock %}

{% block content %}
<!-- Contador de itens pendentes de sincroniza√ß√£o -->
<div class="sync-pendentes" id="syncPendentesV2" onclick="curralSync.sincronizarPendentes()">
  <i class="fas fa-sync-alt"></i> <span id="syncPendentesCountV2">0</span> pendente(s)
</div>

<div class="curral-v2-wrapper">
  <div class="curral-v2-header">
    <div class="curral-v2-header-left">
      <h1 class="curral-v2-header-title">
        Super Tela
      </h1>
      <div class="curral-v2-header-fazenda">
        MONPEC CURRAL - {{ propriedade.nome_propriedade }}
      </div>
    </div>
    <div class="curral-v2-header-right">
      <!-- Menu de Relat√≥rios -->
      <div class="relatorios-menu-dropdown" style="position: relative; margin-right: 12px;">
        <button class="btn-relatorios-menu" id="btnRelatoriosMenu" onclick="toggleRelatoriosMenu()">
          <i class="fas fa-file-alt"></i> Relat√≥rios
          <i class="fas fa-chevron-down" style="margin-left: 6px; font-size: 0.7rem;"></i>
        </button>
        <div class="relatorios-submenu" id="relatoriosSubmenu" style="display: none;">
          <a href="{% url 'curral_relatorio_reprodutivo' propriedade.id %}" class="relatorios-submenu-item">
            <i class="fas fa-baby-carriage"></i> Reprodutivo
          </a>
          <a href="{% url 'curral_relatorio_iatf' propriedade.id %}" class="relatorios-submenu-item">
            <i class="fas fa-syringe"></i> Criar IATF CURRAL
          </a>
        </div>
      </div>
      
      <!-- Indicador de status de conex√£o -->
      <div class="status-conexao" id="statusConexaoV2">
        <span class="status-conexao-badge"></span>
        <span id="statusConexaoTextoV2">Online</span>
      </div>
      
      <!-- Indicador de sess√£o ativa - Layout compacto em 2 linhas -->
      <div class="sessao-ativa-header" id="sessaoAtivaHeaderV2">
        <!-- Linha 1: T√≠tulo e Nome da Sess√£o -->
        <div class="sessao-ativa-linha1">
          <div class="sessao-ativa-titulo">
            <i class="fas fa-circle" style="font-size: 0.4rem; color: #4caf50;"></i>
            Sess√£o Ativa
          </div>
          <div class="sessao-ativa-nome" id="sessaoAtivaNomeV2">
            {% if sessao_ativa %}{{ sessao_ativa.nome }} {{ super_tela.sessao_data|default:"" }}{% else %}Nenhuma sess√£o ativa{% endif %}
          </div>
        </div>
        
        <!-- Linha 2: Estat√≠sticas e Bot√µes -->
        <div id="sessaoAtivaStatsV2" style="display: {% if sessao_ativa %}flex{% else %}none{% endif %};" class="sessao-ativa-linha2">
          <div class="sessao-ativa-stats">
            <div class="sessao-stat-item">
              <div class="sessao-stat-valor" id="sessaoStatEventosV2">{{ stats_sessao.total_eventos|default:0 }}</div>
              <div class="sessao-stat-label">Eventos</div>
            </div>
            <div class="sessao-stat-item">
              <div class="sessao-stat-valor" id="sessaoStatAnimaisV2">{{ stats_sessao.animais_processados|default:0 }}</div>
              <div class="sessao-stat-label">Animais</div>
            </div>
            <div class="sessao-stat-item">
              <div class="sessao-stat-valor" id="sessaoStatPesagensV2">{{ stats_sessao.pesagens|default:0 }}</div>
              <div class="sessao-stat-label">Pesagens</div>
            </div>
          </div>
          <div class="sessao-ativa-acoes">
            {% if sessao_ativa %}
            <button type="button" class="sessao-btn sessao-btn-ver" data-url="{% url 'curral_sessao' propriedade.id sessao_ativa.id %}" onclick="window.verSessaoV2(this)">
              <i class="fas fa-eye"></i> Ver
            </button>
            <button type="button" class="sessao-btn sessao-btn-encerrar" onclick="window.encerrarSessaoV2()">
              <i class="fas fa-stop"></i> Encerrar
            </button>
            {% else %}
            <button type="button" class="sessao-btn sessao-btn-nova" onclick="abrirModalNovaSessaoV2()">
              <i class="fas fa-plus"></i> Nova
            </button>
            {% endif %}
          </div>
        </div>
        <!-- Modal de Cadastro de Trabalho -->
        <div id="modalCadastroTrabalhoV2" class="modal-cadastro-trabalho" style="display: none;">
          <div class="modal-cadastro-trabalho-content">
            <div class="modal-cadastro-trabalho-header">
              <h3><i class="fas fa-clipboard-list"></i> Cadastro de Trabalho</h3>
              <button type="button" class="modal-close" onclick="fecharModalCadastroTrabalhoV2()">&times;</button>
            </div>
            <div class="modal-cadastro-trabalho-body">
              <form id="formCadastroTrabalhoV2">
                <div class="form-group">
                  <label for="tipoTrabalhoV2">Tipo de Trabalho <span style="color: red;">*</span>:</label>
                  <select id="tipoTrabalhoV2" class="form-control" required>
                    <option value="">Selecione o tipo de trabalho</option>
                    {% for tipo in tipos_trabalho %}
                    <option value="{{ tipo.valor }}">{{ tipo.rotulo }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="quantidadeEsperadaV2">Quantidade Esperada:</label>
                  <input type="number" id="quantidadeEsperadaV2" class="form-control" min="1" placeholder="Ex: 50">
                </div>
                
                <div class="form-group">
                  <label for="nomeLoteV2">Nome do Lote:</label>
                  <input type="text" id="nomeLoteV2" class="form-control" placeholder="Ex: Lote 1, Lote Engorda, etc.">
                </div>
                
                <div class="form-group">
                  <label for="dataTrabalhoV2">Data do Trabalho:</label>
                  <input type="date" id="dataTrabalhoV2" class="form-control" required>
                </div>
                
                <div class="form-group">
                  <label for="pastoOrigemV2">Pasto de Origem:</label>
                  <select id="pastoOrigemV2" class="form-control">
                    <option value="">Selecione o pasto de origem</option>
                    {% for pastagem in pastagens_disponiveis %}
                    <option value="{{ pastagem.nome }}">{{ pastagem.nome }}{% if pastagem.area_ha %} ({{ pastagem.area_ha|floatformat:2 }} ha){% endif %}</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Ou digite o nome do pasto manualmente</small>
                  <input type="text" id="pastoOrigemManualV2" class="form-control" style="margin-top: 5px;" placeholder="Digite o nome do pasto">
                </div>
                
                <div class="form-group">
                  <label for="observacoesTrabalhoV2">Observa√ß√µes:</label>
                  <textarea id="observacoesTrabalhoV2" class="form-control" rows="3" placeholder="Observa√ß√µes adicionais sobre o trabalho"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-cadastro-trabalho-footer">
              <button type="button" class="btn btn-secondary" onclick="fecharModalCadastroTrabalhoV2()">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="salvarCadastroTrabalhoV2()">
                <i class="fas fa-save"></i> Salvar e Iniciar Trabalho
              </button>
            </div>
          </div>
        </div>
        
        <div id="sessaoAtivaSemSessaoV2" style="display: {% if sessao_ativa %}none{% else %}block{% endif %};">
          <div style="font-size: 0.65rem; color: #78909c; margin-bottom: 6px;">
            Crie uma sess√£o para organizar os eventos
          </div>
          <button type="button" class="sessao-btn sessao-btn-nova" onclick="abrirModalNovaSessaoV2()" style="width: 100%;">
            <i class="fas fa-plus"></i> Criar Sess√£o
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Cards Indicadores de Manejo Ativo (Discretos) -->
  <div class="manejo-indicadores-container" id="manejoIndicadoresContainer">
    <!-- Ser√° preenchido dinamicamente pelo JavaScript -->
  </div>

  <!-- Layout de duas colunas V4 -->
  <div class="curral-v4-layout">
    <!-- PAINEL ESQUERDO -->
    <div class="curral-v4-painel-esquerdo">
      <!-- T√≠tulo da Se√ß√£o -->
      <div style="margin-bottom: 16px;">
        <h2 style="margin: 0; color: #1976d2; display: flex; align-items: center; gap: 12px; font-size: 1.3rem;">
          <i class="fas fa-cog"></i> CONFIGURA√á√ÉO DA SESS√ÉO
        </h2>
        <p style="margin: 8px 0 0 0; color: #666; font-size: 0.9rem;">Configure as op√ß√µes abaixo para esta sess√£o</p>
      </div>

      <!-- Grid de Cards de Configura√ß√£o - 4 colunas (responsivo) -->
      <div id="gridConfigCards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <!-- PESAGEM -->
        <div style="position: relative; min-height: 200px;">
          <!-- Card Original -->
          <div id="cardConfigPesagem" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer;" onclick="event.preventDefault(); event.stopPropagation(); console.log('üîµ Card PESAGEM clicado'); try { if(typeof window.abrirModalConfigPesagem === 'function') { window.abrirModalConfigPesagem(); } else { console.error('Fun√ß√£o n√£o encontrada'); alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.'); } } catch(e) { console.error('Erro ao abrir modal:', e); alert('Erro ao abrir modal: ' + e.message); }">
            <div class="card-curral" style="height: 100%; display: flex; flex-direction: column;">
              <div class="card-curral-body" style="padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h3 style="margin: 0 0 8px 0; color: #1976d2; font-size: 1rem; font-weight: 600;">PESAGEM</h3>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">Clique para configurar</p>
              </div>
            </div>
          </div>
          
          <!-- Card de Resumo -->
          <div id="cardResumoConfigPesagem" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div class="card-curral" style="height: 100%; background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%); border-left: 4px solid #1976d2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-curral-body" style="padding: 16px; height: 100%; display: flex; flex-direction: column;">
                <div id="resumoConfigPesagem" style="color: #555; font-size: 0.85rem; flex: 1;">
                  <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="abrirModalConfigPesagem()" style="white-space: nowrap; font-size: 0.8rem; padding: 4px 8px;">
                    Editar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SANIT√ÅRIO -->
        <div style="position: relative; min-height: 200px;">
          <!-- Card Original -->
          <div id="cardConfigSanitarioOriginal" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer;" onclick="event.preventDefault(); event.stopPropagation(); console.log('üî¥ Card SANIT√ÅRIO clicado'); try { if(typeof window.abrirModalConfigSessao === 'function') { window.abrirModalConfigSessao('sanitario'); } else { console.error('Fun√ß√£o n√£o encontrada'); alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.'); } } catch(e) { console.error('Erro ao abrir modal:', e); alert('Erro ao abrir modal: ' + e.message); }">
            <div class="card-curral" style="height: 100%; display: flex; flex-direction: column;">
              <div class="card-curral-body" style="padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h3 style="margin: 0 0 8px 0; color: #d32f2f; font-size: 1rem; font-weight: 600;">SANIT√ÅRIO</h3>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">Clique para configurar</p>
              </div>
            </div>
          </div>
          
          <!-- Card de Resumo -->
          <div id="cardResumoConfigSanitario" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div class="card-curral" style="height: 100%; background: linear-gradient(135deg, #ffebee 0%, #f5f5f5 100%); border-left: 4px solid #d32f2f; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-curral-body" style="padding: 16px; height: 100%; display: flex; flex-direction: column;">
                <div id="resumoConfigSanitario" style="color: #555; font-size: 0.85rem; flex: 1;">
                  <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="if(typeof window.abrirModalConfigSessao === 'function'){window.abrirModalConfigSessao('sanitario');}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" style="white-space: nowrap; font-size: 0.8rem; padding: 4px 8px;">
                    Editar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- REPRODU√á√ÉO -->
        <div style="position: relative; min-height: 200px;">
          <!-- Card Original -->
          <div id="cardConfigReprodutivoOriginal" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer;" onclick="if(typeof window.abrirModalConfigSessao === 'function'){window.abrirModalConfigSessao('reprodutivo');}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}">
            <div class="card-curral" style="height: 100%; display: flex; flex-direction: column;">
              <div class="card-curral-body" style="padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h3 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 1rem; font-weight: 600;">REPRODU√á√ÉO</h3>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">Clique para configurar</p>
              </div>
            </div>
          </div>
          
          <!-- Card de Resumo -->
          <div id="cardResumoConfigReprodutivo" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div class="card-curral" style="height: 100%; background: linear-gradient(135deg, #f3e5f5 0%, #f5f5f5 100%); border-left: 4px solid #7b1fa2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-curral-body" style="padding: 16px; height: 100%; display: flex; flex-direction: column;">
                <div id="resumoConfigReprodutivo" style="color: #555; font-size: 0.85rem; flex: 1;">
                  <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="if(typeof window.abrirModalConfigSessao === 'function'){window.abrirModalConfigSessao('reprodutivo');}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" style="white-space: nowrap; font-size: 0.8rem; padding: 4px 8px;">
                    Editar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- MOVIMENTA√á√ÉO -->
        <div style="position: relative; min-height: 200px;">
          <!-- Card Original -->
          <div id="cardConfigMovimentacaoOriginal" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: pointer;" onclick="event.preventDefault(); event.stopPropagation(); console.log('üü† Card MOVIMENTA√á√ÉO clicado'); try { if(typeof window.abrirModalConfigSessao === 'function') { window.abrirModalConfigSessao('movimentacao'); } else { console.error('Fun√ß√£o n√£o encontrada'); alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.'); } } catch(e) { console.error('Erro ao abrir modal:', e); alert('Erro ao abrir modal: ' + e.message); }">
            <div class="card-curral" style="height: 100%; display: flex; flex-direction: column;">
              <div class="card-curral-body" style="padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h3 style="margin: 0 0 8px 0; color: #f57c00; font-size: 1rem; font-weight: 600;">MOVIMENTA√á√ÉO</h3>
                <p style="margin: 0; color: #666; font-size: 0.85rem;">Clique para configurar</p>
              </div>
            </div>
          </div>
          
          <!-- Card de Resumo -->
          <div id="cardResumoConfigMovimentacao" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
            <div class="card-curral" style="height: 100%; background: linear-gradient(135deg, #fff3e0 0%, #f5f5f5 100%); border-left: 4px solid #f57c00; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-curral-body" style="padding: 16px; height: 100%; display: flex; flex-direction: column;">
                <div id="resumoConfigMovimentacao" style="color: #555; font-size: 0.85rem; flex: 1;">
                  <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="if(typeof window.abrirModalConfigSessao === 'function'){window.abrirModalConfigSessao('movimentacao');}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" style="white-space: nowrap; font-size: 0.8rem; padding: 4px 8px;">
                    Editar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- IDENTIFICA√á√ÉO (F2) -->
      <div class="card-curral">
        <div class="card-curral-header">
          <h2><i class="fas fa-qrcode"></i> IDENTIFICA√á√ÉO (F2)</h2>
        </div>
        <div class="card-curral-body" style="padding: 16px;">
          <div class="scanner-brinco-input">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
              <input type="text" id="brincoInputV2" placeholder="Digite ou leia o n√∫mero SISBOV / brinco" 
                     style="flex: 1;" 
                     onkeypress="if(event.key === 'Enter' || event.keyCode === 13) { event.preventDefault(); event.stopPropagation(); window.buscarBrincoSimples(); return false; }">
              <button type="button" class="btn btn-warning" id="btnTrocaBrinco" 
                      onclick="event.preventDefault(); event.stopPropagation(); window.abrirModalTrocaBrinco(); return false;" 
                      style="white-space: nowrap;"
                      title="Troca de Brinco">
                <i class="fas fa-exchange-alt"></i> Troca de Brinco
              </button>
              <button type="button" class="btn btn-primary" id="btnBuscarBrinco" 
                      onclick="event.preventDefault(); event.stopPropagation(); window.buscarBrincoSimples(); return false;" 
                      style="white-space: nowrap;">
                <i class="fas fa-search"></i> Buscar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- FICHA CADASTRAL -->
      <div class="card-curral">
        <div class="card-curral-header">
          <h2><i class="fas fa-file-alt"></i> FICHA CADASTRAL</h2>
          <button type="button" class="btn btn-sm btn-primary" id="btnFichaAnimalV2" style="display: none;">
            <i class="fas fa-file-alt"></i> Ficha Animal
          </button>
        </div>
        <div class="ficha-cadastral-grid" id="fichaCadastralV4">
          <!-- Campos da Ficha Cadastral -->
          <div class="ficha-item">
            <span class="ficha-label">C√≥digo Eletr√¥nico</span>
            <span class="ficha-value" id="fichaCodigoEletronicoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">SISBOV</span>
            <span class="ficha-value" id="fichaSisbovV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">N¬∫ Manejo</span>
            <span class="ficha-value" id="fichaNumeroManejoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Ra√ßa</span>
            <span class="ficha-value" id="fichaRacaV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Sexo</span>
            <span class="ficha-value" id="fichaSexoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Nascimento</span>
            <span class="ficha-value" id="fichaNascimentoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Categoria</span>
            <span class="ficha-value" id="fichaCategoriaV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Pasto/Lote</span>
            <span class="ficha-value" id="fichaPastoLoteV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">√öltimo Peso</span>
            <span class="ficha-value" id="fichaUltimoPesoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Status BND</span>
            <span class="ficha-value" id="fichaStatusBndV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Cota Hilton</span>
            <span class="ficha-value" id="fichaCotaHiltonV4">‚Äî</span>
          </div>
          
          <!-- Status Reprodutivo - na mesma linha que Cota Hilton -->
          <div class="ficha-item ficha-status-reprodutivo-item" id="fichaStatusReprodutivoCard" style="display: none; align-items: stretch;">
            <span class="ficha-label" style="color: #e91e63; line-height: 1.2;">
              Status Reprodutivo
            </span>
            <div class="ficha-status-reprodutivo-content" id="fichaStatusReprodutivoContent" style="padding: 6px 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 32px; display: flex; align-items: center; font-size: 0.85rem; box-sizing: border-box;">
              <div style="color: #666;">Carregando informa√ß√µes...</div>
            </div>
          </div>
        </div>
        
        <!-- Card Ficha Completa do Animal -->
        <div class="ficha-completa-card" style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin: 0 0 4px 0; font-size: 0.95rem; font-weight: 600; color: white;">
                <i class="fas fa-file-medical" style="margin-right: 8px;"></i>
                Ficha Cadastral Completa
              </h3>
              <p style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.9);">Visualizar hist√≥rico completo do animal</p>
            </div>
            <button type="button" id="btnAbrirFichaCompletaV4" class="btn btn-sm" onclick="if(typeof window.abrirFichaCompletaV4 === 'function'){window.abrirFichaCompletaV4();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
              <i class="fas fa-external-link-alt"></i> Abrir Ficha
            </button>
          </div>
        </div>
      </div>

      <!-- LINHA DE REPRODU√á√ÉO -->
      <div class="card-curral" id="linhaReproducaoCard" style="display: none;">
        <div class="card-curral-header">
          <h2><i class="fas fa-baby-carriage"></i> LINHA DE REPRODU√á√ÉO</h2>
        </div>
        <div class="linha-reproducao-grid" id="linhaReproducaoV4">
          <div class="ficha-item">
            <span class="ficha-label">Diagn√≥stico</span>
            <span class="ficha-value" id="linhaDiagnosticoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Data Insemina√ß√£o</span>
            <span class="ficha-value" id="linhaDataInseminacaoV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Touro</span>
            <span class="ficha-value" id="linhaTouroV4">‚Äî</span>
          </div>
          <div class="ficha-item">
            <span class="ficha-label">Data IATF</span>
            <span class="ficha-value" id="linhaDataIATFV4">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PAINEL DIREITO -->
    <div class="curral-v4-painel-direito" style="flex: 1; width: 100%; max-width: 100%;">
      <!-- Wrapper para pesagem e manejos -->
      <div class="pesagem-manejos-wrapper" style="flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 100%;">
      <!-- BALAN√áA ELETR√îNICA -->
      <div class="balanca-eletronica-grande">
        <!-- T√≠tulo din√¢mico -->
        <div class="balanca-titulo" id="balancaTitulo">BALAN√áA ELETR√îNICA</div>
        
        <!-- Vers√£o Pesagem de Rotina -->
        <div id="balancaRotinaContainer">
        
        <!-- Estat√≠sticas de Pesagem em Tempo Real -->
        <div style="margin-top: 20px; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.15); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); display: grid; grid-template-rows: auto auto; gap: 20px;">
          <!-- Linha 1: Estat√≠sticas Gerais (Horizontal) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 10px; border-left: 3px solid rgba(255,255,255,0.3);">
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Animais Pesados</div>
              <div id="balancaQuantidadeAnimais" style="font-size: 2rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">0</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 10px; border-left: 3px solid rgba(255,255,255,0.3);">
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Peso Total</div>
              <div id="balancaPesoTotal" style="font-size: 2rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">0 kg</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 10px; border-left: 3px solid rgba(255,255,255,0.3);">
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">M√©dia Individual</div>
              <div id="balancaMediaIndividual" style="font-size: 2rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚Äî</div>
            </div>
          </div>
          
          <!-- Linha 2: Divis√£o por Sexo e Campo de Peso -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; align-items: start;">
            <!-- Macho -->
            <div style="text-align: center; padding: 14px; background: linear-gradient(135deg, rgba(25, 118, 210, 0.15) 0%, rgba(25, 118, 210, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(25, 118, 210, 0.5); box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);">
              <div style="font-size: 0.7rem; color: rgba(144, 202, 249, 1); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                Macho
              </div>
              <div style="font-size: 1rem; color: rgba(144, 202, 249, 1); margin-bottom: 6px; font-weight: 700;">
                <span id="balancaQuantidadeMacho" style="font-size: 1.2rem;">0</span> <span style="font-size: 0.8rem; opacity: 0.9;">animais</span>
              </div>
              <div style="font-size: 1rem; color: rgba(144, 202, 249, 1); margin-bottom: 8px; font-weight: 700;">
                <span id="balancaPesoTotalMacho" style="font-size: 1.2rem;">0</span> <span style="font-size: 0.8rem; opacity: 0.9;">kg</span>
              </div>
              <div style="font-size: 0.75rem; color: rgba(144, 202, 249, 0.8); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(25, 118, 210, 0.3);">
                M√©dia: <span id="balancaMediaMacho" style="font-weight: 700; color: rgba(144, 202, 249, 1);">‚Äî</span>
              </div>
            </div>
            
            <!-- F√™mea -->
            <div style="text-align: center; padding: 14px; background: linear-gradient(135deg, rgba(194, 24, 91, 0.15) 0%, rgba(194, 24, 91, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(194, 24, 91, 0.5); box-shadow: 0 2px 8px rgba(194, 24, 91, 0.2);">
              <div style="font-size: 0.7rem; color: rgba(244, 143, 177, 1); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                F√™mea
              </div>
              <div style="font-size: 1rem; color: rgba(244, 143, 177, 1); margin-bottom: 6px; font-weight: 700;">
                <span id="balancaQuantidadeFemea" style="font-size: 1.2rem;">0</span> <span style="font-size: 0.8rem; opacity: 0.9;">animais</span>
              </div>
              <div style="font-size: 1rem; color: rgba(244, 143, 177, 1); margin-bottom: 8px; font-weight: 700;">
                <span id="balancaPesoTotalFemea" style="font-size: 1.2rem;">0</span> <span style="font-size: 0.8rem; opacity: 0.9;">kg</span>
              </div>
              <div style="font-size: 0.75rem; color: rgba(244, 143, 177, 0.8); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(194, 24, 91, 0.3);">
                M√©dia: <span id="balancaMediaFemea" style="font-weight: 700; color: rgba(244, 143, 177, 1);">‚Äî</span>
              </div>
            </div>
            
            <!-- Campo de Peso e Bot√µes -->
            <div style="display: flex; flex-direction: column; gap: 16px; width: 100%; align-items: center; justify-content: center;">
              <div style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <label style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Peso (kg)</label>
                <input type="text" 
                       id="pesoValorV2" 
                       class="peso-display-v2-input" 
                       placeholder="0,00"
                       inputmode="decimal"
                       pattern="[0-9,\.]+"
                       disabled
                       style="width: 100%; max-width: 280px; font-size: 2.8rem; padding: 18px 22px; text-align: center; border: 2px solid rgba(255,255,255,0.4); border-radius: 12px; background: rgba(255,255,255,0.15); color: #1b5e20; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 2px 4px rgba(255,255,255,0.1); transition: all 0.3s ease; outline: none; letter-spacing: 1px;">
              </div>
              <div style="display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap;">
                <button type="button" class="btn btn-gravar" id="pesoGravarBtnV2" onclick="if(typeof window.gravarPesagemDireto==='function'){window.gravarPesagemDireto();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" disabled style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; cursor: not-allowed; opacity: 0.5; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-save"></i> <span>Gravar</span>
                </button>
                <button type="button" class="btn btn-limpar" id="pesoLimparBtnV2" onclick="var p=document.getElementById('pesoValorV2');if(p){p.value='';p.focus();}" style="background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%); border: 2px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; cursor: pointer;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.25) 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';">
                  <i class="fas fa-eraser"></i> <span>Limpar</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px; width: 100%;">
          <!-- Informa√ß√µes adicionais de pesagem -->
          <div class="peso-display-v2-info" style="margin-top: 20px; color: rgba(255,255,255,0.9); font-size: 0.85rem;">
            <!-- Linha 1: √öltimo peso e Peso Atual -->
            <div style="display: flex; gap: 20px; margin-bottom: 8px; flex-wrap: wrap;">
              <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">√öltimo peso:</span>
                <span class="peso-info-value" id="pesoUltimoValorV2" style="color: white; font-weight: 600;">‚Äî</span>
              </div>
              <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Peso Atual:</span>
                <span class="peso-info-value" id="pesoAtualValorV2" style="color: white; font-weight: 600;">‚Äî</span>
              </div>
            </div>
            <!-- Linha 2: Per√≠odos em Dias e Ganho di√°rio -->
            <div style="display: flex; gap: 20px; margin-bottom: 8px; flex-wrap: wrap;">
              <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Per√≠odos em Dias:</span>
                <span class="peso-info-value" id="periodoDiasValorV2" style="color: white; font-weight: 600;">‚Äî</span>
              </div>
              <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Ganho di√°rio:</span>
                <span class="peso-info-value" id="pesoGanhoDiaV2" style="color: white; font-weight: 600;">‚Äî</span>
              </div>
            </div>
            <!-- Linha 3: Ganho Total de Peso -->
            <div style="margin-bottom: 8px;">
              <div class="peso-info-item">
                <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Ganho Total de Peso:</span>
                <span class="peso-info-value" id="pesoGanhoTotalV2" style="color: white; font-weight: 600;">‚Äî</span>
              </div>
            </div>
          </div>
        </div>
        </div>
        
        <!-- Vers√£o Pesagem de Aparta√ß√£o -->
        <div id="balancaApartacaoContainer" style="display: none;">
          <!-- Estat√≠sticas de Pesagem por Lotes -->
          <div style="margin-top: 20px; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.15); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
            <!-- Grid de Lotes - 4 colunas -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
              <!-- Lote BOIADA - VERDE -->
              <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.7); box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);">
                <div style="font-size: 0.8rem; color: rgba(76, 175, 80, 1); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                  BOIADA
                </div>
                <div style="font-size: 0.75rem; color: rgba(76, 175, 80, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Quantidade:
                </div>
                <div id="loteBoiadaQuantidade" style="font-size: 1.5rem; color: rgba(76, 175, 80, 1); font-weight: 700; margin-bottom: 12px;">0</div>
                <div style="font-size: 0.75rem; color: rgba(76, 175, 80, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Peso Total:
                </div>
                <div id="loteBoiadaPesoTotal" style="font-size: 1.3rem; color: rgba(76, 175, 80, 1); font-weight: 700; margin-bottom: 12px;">0 kg</div>
                <div style="font-size: 0.75rem; color: rgba(76, 175, 80, 0.9); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(76, 175, 80, 0.3);">
                  M√©dia: <span id="loteBoiadaMedia" style="font-weight: 700; color: rgba(76, 175, 80, 1);">‚Äî</span>
                </div>
              </div>
              
              <!-- Lote CABECEIRA - AZUL -->
              <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(33, 150, 243, 0.15) 0%, rgba(33, 150, 243, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(33, 150, 243, 0.7); box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);">
                <div style="font-size: 0.8rem; color: rgba(33, 150, 243, 1); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                  CABECEIRA
                </div>
                <div style="font-size: 0.75rem; color: rgba(33, 150, 243, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Quantidade:
                </div>
                <div id="loteCabeceiraQuantidade" style="font-size: 1.5rem; color: rgba(33, 150, 243, 1); font-weight: 700; margin-bottom: 12px;">0</div>
                <div style="font-size: 0.75rem; color: rgba(33, 150, 243, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Peso Total:
                </div>
                <div id="loteCabeceiraPesoTotal" style="font-size: 1.3rem; color: rgba(33, 150, 243, 1); font-weight: 700; margin-bottom: 12px;">0 kg</div>
                <div style="font-size: 0.75rem; color: rgba(33, 150, 243, 0.9); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(33, 150, 243, 0.3);">
                  M√©dia: <span id="loteCabeceiraMedia" style="font-weight: 700; color: rgba(33, 150, 243, 1);">‚Äî</span>
                </div>
              </div>
              
              <!-- Lote MEIO - LARANJA -->
              <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 152, 0, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(255, 152, 0, 0.7); box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);">
                <div style="font-size: 0.8rem; color: rgba(255, 152, 0, 1); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                  MEIO
                </div>
                <div style="font-size: 0.75rem; color: rgba(255, 152, 0, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Quantidade:
                </div>
                <div id="loteMeioQuantidade" style="font-size: 1.5rem; color: rgba(255, 152, 0, 1); font-weight: 700; margin-bottom: 12px;">0</div>
                <div style="font-size: 0.75rem; color: rgba(255, 152, 0, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Peso Total:
                </div>
                <div id="loteMeioPesoTotal" style="font-size: 1.3rem; color: rgba(255, 152, 0, 1); font-weight: 700; margin-bottom: 12px;">0 kg</div>
                <div style="font-size: 0.75rem; color: rgba(255, 152, 0, 0.9); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 152, 0, 0.3);">
                  M√©dia: <span id="loteMeioMedia" style="font-weight: 700; color: rgba(255, 152, 0, 1);">‚Äî</span>
                </div>
              </div>
              
              <!-- Lote FUNDO - VERMELHO -->
              <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.08) 100%); border-radius: 10px; border: 2px solid rgba(244, 67, 54, 0.7); box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);">
                <div style="font-size: 0.8rem; color: rgba(244, 67, 54, 1); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                  FUNDO
                </div>
                <div style="font-size: 0.75rem; color: rgba(244, 67, 54, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Quantidade:
                </div>
                <div id="loteFundoQuantidade" style="font-size: 1.5rem; color: rgba(244, 67, 54, 1); font-weight: 700; margin-bottom: 12px;">0</div>
                <div style="font-size: 0.75rem; color: rgba(244, 67, 54, 0.9); margin-bottom: 8px; font-weight: 500;">
                  Peso Total:
                </div>
                <div id="loteFundoPesoTotal" style="font-size: 1.3rem; color: rgba(244, 67, 54, 1); font-weight: 700; margin-bottom: 12px;">0 kg</div>
                <div style="font-size: 0.75rem; color: rgba(244, 67, 54, 0.9); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(244, 67, 54, 0.3);">
                  M√©dia: <span id="loteFundoMedia" style="font-weight: 700; color: rgba(244, 67, 54, 1);">‚Äî</span>
                </div>
              </div>
            </div>
            
            <!-- Campo de Peso e Bot√µes (mesmo layout) -->
            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center; justify-content: center; margin-top: 20px;">
              <div style="width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center;">
                <label style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Peso (kg)</label>
                <input type="text" 
                       id="pesoValorApartacaoV2" 
                       class="peso-display-v2-input" 
                       placeholder="0,00"
                       inputmode="decimal"
                       pattern="[0-9,\.]+"
                       disabled
                       style="width: 100%; font-size: 2.8rem; padding: 18px 22px; text-align: center; border: 2px solid rgba(255,255,255,0.4); border-radius: 12px; background: rgba(255,255,255,0.15); color: #1b5e20; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 2px 4px rgba(255,255,255,0.1); transition: all 0.3s ease; outline: none; letter-spacing: 1px;">
              </div>
              <div style="display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap;">
                <button type="button" class="btn btn-gravar" id="pesoGravarBtnApartacaoV2" onclick="if(typeof window.gravarPesagemApartacao==='function'){window.gravarPesagemApartacao();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" disabled style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; cursor: not-allowed; opacity: 0.5; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-save"></i> <span>Gravar</span>
                </button>
                <button type="button" class="btn btn-limpar" id="pesoLimparBtnApartacaoV2" onclick="if(typeof window.limparCampoPesoApartacao==='function'){window.limparCampoPesoApartacao();}else{var p=document.getElementById('pesoValorApartacaoV2');if(p){p.value='';p.focus();}}" style="background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%); border: 2px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <i class="fas fa-eraser"></i> <span>Limpar</span>
                </button>
              </div>
            </div>
            
            <!-- Informa√ß√µes adicionais de pesagem -->
            <div class="peso-display-v2-info" style="margin-top: 20px; color: rgba(255,255,255,0.9); font-size: 0.85rem;">
              <!-- Linha 1: √öltimo peso e Peso Atual -->
              <div style="display: flex; gap: 20px; margin-bottom: 8px; flex-wrap: wrap;">
                <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                  <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">√öltimo peso:</span>
                  <span class="peso-info-value" id="pesoUltimoValorApartacaoV2" style="color: white; font-weight: 600;">‚Äî</span>
                </div>
                <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                  <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Peso Atual:</span>
                  <span class="peso-info-value" id="pesoAtualValorApartacaoV2" style="color: white; font-weight: 600;">‚Äî</span>
                </div>
              </div>
              <!-- Linha 2: Per√≠odos em Dias e Ganho di√°rio -->
              <div style="display: flex; gap: 20px; margin-bottom: 8px; flex-wrap: wrap;">
                <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                  <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Per√≠odos em Dias:</span>
                  <span class="peso-info-value" id="periodoDiasValorApartacaoV2" style="color: white; font-weight: 600;">‚Äî</span>
                </div>
                <div class="peso-info-item" style="flex: 1; min-width: 120px;">
                  <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Ganho di√°rio:</span>
                  <span class="peso-info-value" id="pesoGanhoDiaApartacaoV2" style="color: white; font-weight: 600;">‚Äî</span>
                </div>
              </div>
              <!-- Linha 3: Ganho Total de Peso -->
              <div style="margin-bottom: 8px;">
                <div class="peso-info-item">
                  <span class="peso-info-label" style="color: rgba(255,255,255,0.8);">Ganho Total de Peso:</span>
                  <span class="peso-info-value" id="pesoGanhoTotalApartacaoV2" style="color: white; font-weight: 600;">‚Äî</span>
                </div>
              </div>
              
              <!-- Card de Status do Animal -->
              <div id="cardStatusAnimalApartacao" style="display: none; margin-top: 16px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 100%; box-sizing: border-box;">
                <div style="text-align: center;">
                  <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Status do Animal</div>
                  <div id="statusAnimalTexto" style="font-size: 1.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;"></div>
                  <div id="statusAnimalDetalhes" style="font-size: 1.1rem; font-weight: 600; margin-top: 8px; opacity: 0.9;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>

      <!-- Espa√ßo reservado para outras funcionalidades (se necess√°rio) -->
      <!-- Fim do wrapper pesagem-manejos-wrapper -->
      
      <!-- Bot√£o GRAVAR DADOS -->
      <button type="button" class="btn btn-primary btn-lg" id="btnFinalizarGravarV2" onclick="if(typeof window.finalizarEGravarManejos==='function'){window.finalizarEGravarManejos();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" disabled style="width: 100%; max-width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 700; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none; border-radius: 8px; color: white; opacity: 0.5; cursor: not-allowed; margin-top: auto; margin-left: 0; margin-right: 0; box-sizing: border-box;">
        <i class="fas fa-check-double"></i> GRAVAR DADOS
      </button>
    </div>
  </div>

  <!-- Container para alinhar os dois cards na mesma altura -->
  <div style="display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 20px; margin-top: 20px; margin-bottom: 20px; align-items: stretch; width: 100%; max-width: 100%; box-sizing: border-box; position: relative;">
    <!-- Card de Progresso da Sess√£o -->
    <div class="card-curral" style="display: flex !important; flex-direction: column; height: 100%; width: 100% !important; max-width: 100% !important; box-sizing: border-box; margin-left: 0 !important; margin-right: 0 !important;">
      <div class="card-curral-header">
        <h2><i class="fas fa-chart-line"></i> PROGRESSO DA SESS√ÉO</h2>
        <button type="button" class="btn btn-sm btn-success" onclick="if(typeof window.iniciarSimuladorApartacao==='function'){const qtd=prompt('Quantos animais machos deseja simular?', '10');if(qtd&&!isNaN(qtd)&&parseInt(qtd)>0){window.iniciarSimuladorApartacao(parseInt(qtd));}else if(qtd){alert('Por favor, informe um n√∫mero v√°lido maior que zero.');}}" title="Iniciar Simulador de Pesagem">
          <i class="fas fa-play"></i> Simulador
        </button>
      </div>
      <div class="card-curral-body" style="padding: 20px; flex: 1;">
        <div class="progresso-sessao-container">
          <!-- Linha 1: Quantidade Planejada e Trabalhada -->
          <div class="progresso-sessao-linha" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="progresso-item">
              <div class="progresso-label">Animais Planejados</div>
              <div class="progresso-valor" id="progressoPlanejados">‚Äî</div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Animais Trabalhados</div>
              <div class="progresso-valor progresso-destaque" id="progressoTrabalhados">0</div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Animais Restantes</div>
              <div class="progresso-valor" id="progressoRestantes">‚Äî</div>
            </div>
          </div>
          
          <!-- Barra de Progresso -->
          <div class="progresso-bar-container" style="margin-bottom: 20px;">
            <div class="progresso-bar-label" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Progresso</span>
              <span id="progressoPercentual">0%</span>
            </div>
            <div class="progresso-bar" style="width: 100%; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden; position: relative;">
              <div class="progresso-bar-fill" id="progressoBarFill" style="height: 100%; background: linear-gradient(90deg, #4caf50 0%, #45a049 100%); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;"></div>
            </div>
          </div>
          
          <!-- Linha √∫nica: Por Sexo, Por Ra√ßa, Tempo Decorrido, Estimativa de T√©rmino e Tempo M√©dio por Animal -->
          <div class="progresso-sessao-linha" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px;">
            <div class="progresso-item">
              <div class="progresso-label">Por Sexo</div>
              <div class="progresso-detalhes" id="progressoSexo">
                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 8px;">
                  <div><span style="color: #1976d2;">Macho:</span> <strong id="progressoSexoMacho">0</strong></div>
                  <div><span style="color: #c2185b;">F√™mea:</span> <strong id="progressoSexoFemea">0</strong></div>
                </div>
              </div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Por Ra√ßa</div>
              <div class="progresso-detalhes" id="progressoRaca" style="margin-top: 8px; max-height: 100px; overflow-y: auto;">
                <div id="progressoRacaLista">‚Äî</div>
              </div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Tempo Decorrido</div>
              <div class="progresso-valor progresso-tempo" id="progressoTempoDecorrido">00:00:00</div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Estimativa de T√©rmino</div>
              <div class="progresso-valor progresso-tempo" id="progressoEstimativaTermino">‚Äî</div>
            </div>
            <div class="progresso-item">
              <div class="progresso-label">Tempo M√©dio por Animal</div>
              <div class="progresso-valor progresso-tempo" id="progressoTempoMedio">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela ANIMAIS NA SESS√ÉO -->
    <div class="card-curral" style="display: flex !important; flex-direction: column; height: 100% !important; max-height: 500px !important; width: 100% !important; max-width: 100% !important; box-sizing: border-box; margin-left: 0 !important; margin-right: 0 !important; overflow: hidden;">
    <div class="card-curral-header" style="flex-shrink: 0;">
      <h2><i class="fas fa-table"></i> ANIMAIS NA SESS√ÉO</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparTabelaAnimaisRegistrados()" title="Limpar tabela">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    <div class="card-curral-body" style="padding: 12px; flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
      <div class="table-responsive" style="flex: 1; overflow-y: auto; overflow-x: auto; min-height: 0; max-height: 100%;">
        <table class="table table-sm table-hover mb-0" id="tabelaAnimaisRegistrados" style="width: 100%;">
          <thead style="position: sticky; top: 0; background: white; z-index: 10;">
            <tr>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">ID</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">SISBOV</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">N¬∫ Manejo</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">RA√áA</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">SEXO</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: left; white-space: nowrap;">IDADE</th>
              <th style="font-size: 0.8rem; font-weight: 600; padding: 8px 12px; text-align: center; white-space: nowrap;">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="tabelaAnimaisRegistradosBody">
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-cow" style="font-size: 1.5rem; opacity: 0.3; margin-bottom: 8px;"></i>
                <p style="margin: 0; font-size: 0.85rem;">Nenhum animal registrado ainda</p>
                <small style="color: #78909c;">Os animais processados aparecer√£o aqui</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>

  <!-- Manter se√ß√µes antigas para compatibilidade (ocultas) -->
  <div style="display: none;">
        <div class="col-lg-4 col-md-6">
          <div class="peso-display-v2" style="min-height: 600px;">
            <div class="peso-display-v2-label">Registro de pesagem</div>
            <div class="peso-display-v2-input-wrapper">
              <input type="text" 
                     id="pesoValorV2" 
                     class="peso-display-v2-input" 
                     placeholder="Identifique o animal primeiro"
                     inputmode="decimal"
                     pattern="[0-9,\.]+"
                     disabled
                     style="background-color: #f5f5f5; cursor: not-allowed;">
              <span class="peso-display-v2-unit-input">kg</span>
            </div>
            <div class="peso-display-v2-buttons">
              <button type="button" class="btn btn-gravar" id="pesoGravarBtnV2" onclick="if(typeof window.gravarPesagemDireto==='function'){window.gravarPesagemDireto();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" disabled style="opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-save"></i> Gravar
              </button>
              <button type="button" class="btn btn-limpar" id="pesoLimparBtnV2" onclick="var p=document.getElementById('pesoValorV2');if(p){p.value='';p.focus();}">
                <i class="fas fa-eraser"></i> Limpar
              </button>
              <button type="button" class="btn btn-finalizar" id="btnFinalizarGravarV2" onclick="if(typeof window.finalizarEGravarManejos==='function'){window.finalizarEGravarManejos();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" disabled style="opacity: 0.5; cursor: not-allowed; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none; color: white; font-weight: 600;">
                <i class="fas fa-check-double"></i> Finalizar e Gravar
              </button>
            </div>
            <div class="peso-display-v2-info">
              <div class="peso-info-item">
                <span class="peso-info-label">Peso Registrado:</span>
                <span class="peso-info-value" id="pesoRegistradoV2" style="color: #4caf50; font-weight: 600;">‚Äî</span>
                <button type="button" 
                        id="btnEditarPesagemV2" 
                        class="btn-editar-pesagem" 
                        style="display: none; margin-left: 8px; padding: 2px 8px; font-size: 0.7rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;"
                        title="Editar √∫ltima pesagem"
                        onclick="abrirModalEditarPesagem()">
                  <i class="fas fa-edit"></i> Editar
                </button>
              </div>
              <div class="peso-info-item">
                <span class="peso-info-label">√öltimo peso:</span>
                <span class="peso-info-value" id="pesoUltimoValorV2">‚Äî</span>
              </div>
              <div class="peso-info-item">
                <span class="peso-info-label">Data √∫ltima pesagem:</span>
                <span class="peso-info-value" id="pesoUltimoDataV2">‚Äî</span>
              </div>
              <div class="peso-info-item">
                <span class="peso-info-label">Dias desde a √∫ltima:</span>
                <span class="peso-info-value" id="pesoDiasV2">‚Äî</span>
              </div>
              <div class="peso-info-item">
                <span class="peso-info-label">Ganho total:</span>
                <span class="peso-info-value" id="pesoGanhoTotalV2">‚Äî</span>
              </div>
              <div class="peso-info-item">
                <span class="peso-info-label">Ganho di√°rio m√©dio:</span>
                <span class="peso-info-value" id="pesoGanhoDiaV2">‚Äî</span>
              </div>
              <!-- Gr√°fico de Evolu√ß√£o das √öltimas 3 Pesagens -->
              <div class="peso-info-graph-container" id="pesoGraficoContainerV2" style="display: none; padding: 10px; background: var(--monpec-bg); border-top: 1px solid var(--monpec-border); border-radius: 0 0 6px 6px; min-height: 200px;">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--monpec-text-light); margin-bottom: 8px; text-align: center;">
                  Evolu√ß√£o das √öltimas 3 Pesagens
            </div>
                <canvas id="pesoGraficoEvolucaoV2" style="max-height: 150px; width: 100% !important; height: 150px !important;"></canvas>
          </div>
        </div>
          </div>
        </div>
        
        <!-- Modal para Editar Pesagem -->
        <div id="modalEditarPesagem" class="modal-editar-pesagem" style="display: none;" onclick="if(event.target === this) fecharModalEditarPesagem();">
          <div class="modal-editar-pesagem-content" onclick="event.stopPropagation();">
            <div class="modal-editar-pesagem-header">
              <h3><i class="fas fa-edit"></i> Editar Pesagem</h3>
              <button type="button" class="modal-close" onclick="fecharModalEditarPesagem()">&times;</button>
            </div>
            <div class="modal-editar-pesagem-body">
              <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                Edite o peso da √∫ltima pesagem registrada:
              </p>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                  Peso Atual:
                </label>
                <span id="pesoAtualExibicao" style="font-size: 1.1rem; color: #666;">‚Äî</span>
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                  Novo Peso (kg):
                </label>
                <input type="text" 
                       id="novoPesoInput" 
                       class="form-control" 
                       placeholder="0,0"
                       inputmode="decimal"
                       pattern="[0-9,\.]+"
                       style="font-size: 1.1rem; padding: 10px; border: 2px solid #ddd; border-radius: 6px; width: 100%;">
              </div>
            </div>
            <div class="modal-editar-pesagem-footer">
              <button type="button" class="btn btn-secondary" onclick="fecharModalEditarPesagem()">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button type="button" class="btn btn-primary" onclick="salvarEdicaoPesagem()">
                <i class="fas fa-save"></i> Salvar
              </button>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4 col-md-12">
          <!-- Cards de Estat√≠sticas -->
          <div class="row g-2 mb-3">
            <div class="col-6">
              <div class="card-stats-curral" style="border-top-color: #8b5cf6;">
                <div class="card-stats-icon" style="background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);">
                  <i class="fas fa-cow"></i>
                </div>
                <div class="card-stats-content">
                  <div class="card-stats-value" id="statsTotalTrabalhados" style="color: #7c3aed;">0</div>
                  <div class="card-stats-label">Total</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card-stats-curral" style="border-top-color: #ec4899;">
                <div class="card-stats-icon" style="background: linear-gradient(135deg, #db2777 0%, #f472b6 100%);">
                  <i class="fas fa-search"></i>
                </div>
                <div class="card-stats-content">
                  <div class="card-stats-value" id="statsIdentificados" style="color: #db2777;">0</div>
                  <div class="card-stats-label">Identificados</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card-stats-curral" style="border-top-color: #3b82f6;">
                <div class="card-stats-icon" style="background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);">
                  <i class="fas fa-database"></i>
                </div>
                <div class="card-stats-content">
                  <div class="card-stats-value" id="statsCadastrados" style="color: #2563eb;">0</div>
                  <div class="card-stats-label">Cadastrados</div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="card-stats-curral" style="border-top-color: #10b981;">
                <div class="card-stats-icon" style="background: linear-gradient(135deg, #059669 0%, #34d399 100%);">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-stats-content">
                  <div class="card-stats-value" id="statsProcessados" style="color: #059669;">0</div>
                  <div class="card-stats-label">Processados</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card Lateral - Manejos Selecionados -->
          <div class="card-curral" style="margin-top: 0;">
            <div class="card-curral-header">
              <h2><i class="fas fa-tasks"></i> Manejos Selecionados</h2>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparManejosSelecionados()" title="Limpar todos os manejos">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="card-curral-body" style="padding: 12px;">
              <!-- Lista de Cards de Manejos Selecionados -->
              <div id="listaManejosSelecionados" style="display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto;">
                <!-- Empty State -->
                <div class="text-center text-muted py-4" id="emptyStateManejosSelecionados">
                  <i class="fas fa-clipboard-list" style="font-size: 2rem; opacity: 0.3; margin-bottom: 8px;"></i>
                  <p style="margin: 0; font-size: 0.85rem;">Nenhum manejo selecionado</p>
                  <small style="color: #78909c;">Configure e grave os manejos nas abas abaixo</small>
                </div>
              </div>
            </div>
          </div>
              </div>
              
  <!-- Tabela de Animais Registrados -->
  <div class="card-curral" style="margin-top: 16px;">
    <div class="card-curral-header">
      <h2><i class="fas fa-table"></i> Animais Registrados</h2>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparTabelaAnimaisRegistrados()" title="Limpar tabela">
        <i class="fas fa-trash"></i>
      </button>
                </div>
    <div class="card-curral-body" style="padding: 12px;">
      <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0" id="tabelaAnimaisRegistrados">
          <thead style="position: sticky; top: 0; background: white; z-index: 10;">
            <tr>
              <th style="font-size: 0.8rem; font-weight: 600;">C√≥digo Eletr√¥nico</th>
              <th style="font-size: 0.8rem; font-weight: 600;">SISBOV</th>
              <th style="font-size: 0.8rem; font-weight: 600;">N√∫mero de Manejo</th>
              <th style="font-size: 0.8rem; font-weight: 600;">Ra√ßa / Sexo</th>
              <th style="font-size: 0.8rem; font-weight: 600;">Nascimento</th>
              <th style="font-size: 0.8rem; font-weight: 600;">Categoria</th>
              <th style="font-size: 0.8rem; font-weight: 600;">Pasto/Lote</th>
              <th style="font-size: 0.8rem; font-weight: 600;">Status BND Sisbov</th>
            </tr>
          </thead>
          <tbody id="tabelaAnimaisRegistradosBody">
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-cow" style="font-size: 1.5rem; opacity: 0.3; margin-bottom: 8px;"></i>
                <p style="margin: 0; font-size: 0.85rem;">Nenhum animal registrado ainda</p>
                <small style="color: #78909c;">Os animais processados aparecer√£o aqui</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Card de Registros do Animal -->
  <div class="card-curral" id="cardRegistrosAnimalV2" style="display: none; margin-top: 16px;">
    <div class="card-curral-header">
      <h2><i class="fas fa-history"></i> Registros do Animal</h2>
    </div>
    <div class="card-curral-body">
      <div id="registrosAnimalConteudoV2">
        <div class="text-center text-muted py-4">
          Identifique um animal para ver seus registros
        </div>
      </div>
    </div>
  </div>

<!-- Popup de confirma√ß√£o de brinco -->
<div class="curral-modal-overlay" id="brincoConfirmOverlay">
  <div class="curral-modal" style="max-width: 500px;">
    <div class="curral-modal-title">
      <i class="fas fa-cow"></i> Confirmar animal identificado
    </div>
    <div class="curral-modal-body">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Brinco:</strong></p>
          <p style="margin: 0; font-size: 1rem; font-weight: 600; color: #1565c0;" id="brincoConfirmNumero">‚Äî</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>SISBOV:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; font-weight: 500; color: #455a64;" id="brincoConfirmSisbov">‚Äî</p>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>N√∫mero de Manejo:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; font-weight: 500; color: #455a64;" id="brincoConfirmManejo">‚Äî</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Status BND:</strong></p>
          <p style="margin: 0;" id="brincoConfirmBnd">
            <span style="font-size: 0.9rem; font-weight: 500; color: #455a64;">‚Äî</span>
          </p>
        </div>
      </div>

      <div style="border-top: 1px solid #e0e0e0; padding-top: 12px; margin-top: 8px; margin-bottom: 12px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Ra√ßa:</strong></p>
            <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmRaca">‚Äî</p>
          </div>
          <div>
            <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Sexo:</strong></p>
            <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmSexo">‚Äî</p>
          </div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Data nascimento:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmDataNasc">‚Äî</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>√öltimo peso:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmUltimoPeso">‚Äî</p>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Lote:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmLote">‚Äî</p>
        </div>
        <div>
          <p style="margin: 0 0 4px 0; font-size: 0.85rem; color: #607d8b;"><strong>Status reprodutivo:</strong></p>
          <p style="margin: 0; font-size: 0.9rem; color: #455a64;" id="brincoConfirmReprodutivo">‚Äî</p>
        </div>
      </div>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="brincoConfirmCancelarBtn">
        Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-primary" id="brincoConfirmOkBtn">
        Confirmar (Enter / OK)
      </button>
    </div>
  </div>
</div>

<!-- Popup de diagn√≥stico r√°pido -->
<div class="curral-modal-overlay" id="diagnosticoOverlayV2">
  <div class="curral-modal">
    <div class="curral-modal-title">
      <i class="fas fa-stethoscope"></i> Diagn√≥stico reprodutivo r√°pido
    </div>
    <div class="curral-modal-body">
      <p style="margin-bottom:6px;">Fale ou selecione o diagn√≥stico para o animal atual:</p>
      <div class="diagnostico-opcoes">
        <button type="button" class="diagnostico-btn diagnostico-p" data-valor="PRENHA">Prenha</button>
        <button type="button" class="diagnostico-btn diagnostico-v" data-valor="VAZIA">Vazia</button>
        <button type="button" class="diagnostico-btn diagnostico-n" data-valor="NAO_AVALIADA">N√£o avaliada</button>
        <button type="button" class="diagnostico-btn diagnostico-d" data-valor="DESCARTE">Descarte</button>
        <button type="button" class="diagnostico-btn diagnostico-r" data-valor="REPETIR_CIO">Repetir cio</button>
      </div>
      <p style="margin-top:8px;font-size:0.78rem;color:#607d8b;">
        Voc√™ pode dizer: <strong>"prenha"</strong>, <strong>"vazia"</strong>, <strong>"n√£o avaliada"</strong>, <strong>"descarte"</strong>, <strong>"repetir cio"</strong> e depois <strong>"ok"</strong> para confirmar ou <strong>"cancelar"</strong> para voltar.
      </p>
      <button type="button" class="btn btn-sm btn-outline-primary" id="diagnosticoVozBtnV2">
        <i class="fas fa-microphone"></i> Falar diagn√≥stico
      </button>
      <span id="diagnosticoVozStatusV2" style="margin-left:8px;font-size:0.78rem;color:#546e7a;"></span>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="diagnosticoCancelarBtnV2">
        Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-primary" id="diagnosticoOkBtnV2">
        Confirmar (Enter / OK)
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE TROCA DE BRINCO ========== -->
<div class="curral-modal-overlay" id="trocaBrincoOverlay" style="z-index: 2600;">
  <div class="curral-modal" style="max-width: 500px;">
    <div class="curral-modal-title" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
      <i class="fas fa-exchange-alt"></i> Troca de Brinco
      <button type="button" id="trocaBrincoCloseBtn" style="float: right; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 30px;" onclick="fecharModalTrocaBrinco();">&times;</button>
    </div>
    <div class="curral-modal-body" style="padding: 20px;">
      <div style="margin-bottom: 20px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
        <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #e65100; font-weight: 600;">Animal Atual:</p>
        <p style="margin: 0; font-size: 1.1rem; color: #333; font-weight: 700;" id="trocaBrincoAnimalAtual">‚Äî</p>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="trocaBrincoNovo" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
          Novo Brinco <span style="color: #f44336;">*</span>
        </label>
        <input type="text" 
               id="trocaBrincoNovo" 
               class="form-control" 
               placeholder="Digite ou leia o novo n√∫mero de brinco"
               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;"
               onkeypress="if(event.key === 'Enter') { event.preventDefault(); document.getElementById('trocaBrincoMotivo').focus(); }">
        <small style="color: #666; font-size: 0.85rem;">O brinco deve estar dispon√≠vel no estoque</small>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="trocaBrincoMotivo" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
          Motivo da Troca <span style="color: #f44336;">*</span>
        </label>
        <select id="trocaBrincoMotivo" 
                class="form-control" 
                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;">
          <option value="">Selecione o motivo...</option>
          <option value="DANIFICADO">Brinco Danificado</option>
          <option value="PERDIDO">Brinco Perdido</option>
          <option value="TROCA_ROTINA">Troca de Rotina</option>
          <option value="OUTROS">Outros</option>
        </select>
      </div>
      
      <div class="form-group" id="trocaBrincoObservacoesGroup" style="margin-bottom: 20px; display: none;">
        <label for="trocaBrincoObservacoes" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
          Observa√ß√µes
        </label>
        <textarea id="trocaBrincoObservacoes" 
                  class="form-control" 
                  rows="3"
                  placeholder="Descreva o motivo da troca (opcional)"
                  style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95rem; resize: vertical;"></textarea>
      </div>
      
      <div id="trocaBrincoMensagem" style="display: none; padding: 12px; border-radius: 6px; margin-bottom: 15px;"></div>
    </div>
    <div class="curral-modal-footer" style="padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fecharModalTrocaBrinco();">
        Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-warning" id="trocaBrincoConfirmarBtn" onclick="confirmarTrocaBrinco();">
        <i class="fas fa-exchange-alt"></i> Confirmar Troca
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE CADASTRO DE ESTOQUE - VERS√ÉO LIMPA E FUNCIONAL ========== -->
<div class="curral-modal-overlay" id="estoqueCadastroOverlayV2" style="display: none; z-index: 2500;">
  <div class="curral-modal" style="max-width: 550px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
    <div class="curral-modal-title" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 16px 20px;">
      <i class="fas fa-tag" style="margin-right: 8px;"></i> 
      <span>Cadastrar Animal do Estoque</span>
      <button type="button" id="estoqueCadastroCloseBtnV2" style="float: right; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 30px;">&times;</button>
    </div>
    <div class="curral-modal-body" style="padding: 20px;">
      <!-- Badge do Brinco -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 2px solid #2196f3;">
        <div style="font-size: 0.85rem; color: #1565c0; margin-bottom: 4px; font-weight: 600;">BRINCO NO ESTOQUE</div>
        <div id="estoqueCadastroBrincoV2" style="font-size: 24px; font-weight: 700; color: #0d47a1; letter-spacing: 2px;">‚Äî</div>
      </div>
      
      <!-- Formul√°rio em Grid Moderno -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div>
          <label for="estoqueCadastroRacaV2" style="display: block; margin-bottom: 6px; font-weight: 600; color: #37474f; font-size: 0.9rem;">
            <i class="fas fa-cow" style="margin-right: 4px; color: #1976d2;"></i>Ra√ßa *
          </label>
          <input type="text" id="estoqueCadastroRacaV2" class="form-control" placeholder="Ex.: Nelore" 
                 style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem;">
        </div>
        <div>
          <label for="estoqueCadastroSexoV2" style="display: block; margin-bottom: 6px; font-weight: 600; color: #37474f; font-size: 0.9rem;">
            <i class="fas fa-venus-mars" style="margin-right: 4px; color: #e91e63;"></i>Sexo *
          </label>
          <select id="estoqueCadastroSexoV2" class="form-control" 
                  style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; background: white; cursor: pointer;">
            <option value="">Selecione</option>
            <option value="F">F√™mea</option>
            <option value="M">Macho</option>
          </select>
        </div>
        <div>
          <label for="estoqueCadastroIdadeMesesV2" style="display: block; margin-bottom: 6px; font-weight: 600; color: #37474f; font-size: 0.9rem;">
            <i class="fas fa-calendar-alt" style="margin-right: 4px; color: #ff9800;"></i>Idade (meses)
          </label>
          <input type="number" id="estoqueCadastroIdadeMesesV2" min="0" step="1" class="form-control" placeholder="Ex.: 8" 
                 style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem;">
          <small style="font-size: 0.75rem; color: #757575; display: block; margin-top: 4px; font-style: italic;">Ou preencha a data abaixo</small>
        </div>
        <div>
          <label for="estoqueCadastroDataNascV2" style="display: block; margin-bottom: 6px; font-weight: 600; color: #37474f; font-size: 0.9rem;">
            <i class="fas fa-birthday-cake" style="margin-right: 4px; color: #4caf50;"></i>Data nascimento
          </label>
          <input type="date" id="estoqueCadastroDataNascV2" class="form-control" 
                 style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem;">
          <small style="font-size: 0.75rem; color: #757575; display: block; margin-top: 4px; font-style: italic;">Ou preencha a idade acima</small>
        </div>
      </div>
      
      <!-- Alerta Informativo Moderno -->
      <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800; margin-top: 8px;">
        <div style="display: flex; align-items: start;">
          <i class="fas fa-info-circle" style="color: #f57c00; font-size: 18px; margin-right: 10px; margin-top: 2px;"></i>
          <div style="font-size: 0.85rem; color: #e65100; line-height: 1.4;">
            <strong>Informe a idade em meses OU a data de nascimento.</strong><br>
            O sistema calcula automaticamente o campo que faltar.
          </div>
        </div>
      </div>
    </div>
    <div class="curral-modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 16px 20px; background: #f5f5f5; border-top: 1px solid #e0e0e0;">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="estoqueCadastroCancelarBtnV2" 
              style="min-width: 120px; padding: 10px 20px; border-radius: 6px; font-weight: 600;">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-primary" id="estoqueCadastroOkBtnV2" 
              style="min-width: 160px; padding: 10px 20px; border-radius: 6px; font-weight: 600; background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); border: none;"
              onclick="(async function() { 
                const btn = this; 
                if (btn.disabled) { 
                  alert('Preencha todos os campos obrigat√≥rios'); 
                  return; 
                } 
                console.log('üñ±Ô∏è Bot√£o clicado via onclick'); 
                if (typeof window.registrarCadastroEstoqueV2 === 'function') { 
                  try { 
                    await window.registrarCadastroEstoqueV2(); 
                  } catch(e) { 
                    console.error('Erro:', e); 
                    alert('Erro: ' + (e.message || 'Erro desconhecido')); 
                  } 
                } else { 
                  console.error('Fun√ß√£o n√£o encontrada!'); 
                  alert('Erro: fun√ß√£o n√£o encontrada. Recarregue a p√°gina com Ctrl+Shift+R'); 
                } 
              }).call(this); return false;"
              disabled>
        <i class="fas fa-check"></i> Confirmar cadastro
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE SELE√á√ÉO DE M√öLTIPLOS BRINCOS ========== -->
<div class="curral-modal-overlay" id="selecaoBrincoMultiploOverlay" style="display: none; z-index: 2600;">
  <div class="curral-modal" style="max-width: 700px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
    <div class="curral-modal-title" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 16px 20px;">
      <i class="fas fa-list" style="margin-right: 8px;"></i> 
      <span>Selecione o Brinco SISBOV</span>
      <button type="button" id="selecaoBrincoMultiploCloseBtn" style="float: right; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 30px;">&times;</button>
    </div>
    <div class="curral-modal-body" style="padding: 20px;">
      <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 20px;">
        <div style="display: flex; align-items: start;">
          <i class="fas fa-info-circle" style="color: #f57c00; font-size: 18px; margin-right: 10px; margin-top: 2px;"></i>
          <div style="font-size: 0.9rem; color: #e65100; line-height: 1.4;">
            <strong>M√∫ltiplos brincos encontrados!</strong><br>
            Foram encontrados brincos com o mesmo manejo/RFID, mas com SISBOV diferentes.<br>
            Selecione o brinco SISBOV correto abaixo:
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="font-size: 0.85rem; color: #1565c0; margin-bottom: 8px; font-weight: 600;">
          <i class="fas fa-barcode" style="margin-right: 4px;"></i>C√≥digo lido: <span id="selecaoBrincoCodigoLido" style="font-weight: 700; color: #0d47a1;"></span>
        </div>
      </div>
      
      <div id="selecaoBrincoMultiploLista" style="max-height: 400px; overflow-y: auto;">
        <!-- Lista de brincos ser√° preenchida aqui -->
      </div>
    </div>
    <div class="curral-modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 16px 20px; background: #f5f5f5; border-top: 1px solid #e0e0e0;">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="selecaoBrincoMultiploCancelarBtn" 
              style="min-width: 120px; padding: 10px 20px; border-radius: 6px; font-weight: 600;">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Toast notifications -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <div style="font-size: 0.9rem; color: #455a64;">Processando...</div>
  </div>
</div>

<!-- Modal completo para programa√ß√£o de IATF -->
<div class="curral-modal-overlay" id="iatfModalOverlayV2" style="z-index: 2300;">
  <div class="curral-modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div class="curral-modal-title">
      <i class="fas fa-syringe"></i> Programar Protocolo IATF
    </div>
    <div class="curral-modal-body">
      <div id="iatfFormV2">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px;">Animal</label>
          <div style="padding: 8px; background: #f5f5f5; border-radius: 6px;">
            <strong id="iatfAnimalBrincoV2">‚Äî</strong> ¬∑ <span id="iatfAnimalCategoriaV2">‚Äî</span>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Protocolo *</label>
            <select id="iatfProtocoloSelectV2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Selecione o protocolo</option>
              {% for protocolo in protocolos_iatf %}
              <option value="{{ protocolo.id }}" data-duracao="{{ protocolo.duracao|default:10 }}">{{ protocolo.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Data de In√≠cio *</label>
            <input type="date" id="iatfDataInicioV2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" value="{{ "now"|date:"Y-m-d" }}">
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Touro/S√™men</label>
            <select id="iatfTouroSelectV2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Selecione o touro</option>
              {% for touro in touros_iatf %}
              <option value="{{ touro.id }}">{{ touro.nome }} ({{ touro.numero }})</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Inseminador</label>
            <select id="iatfInseminadorSelectV2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Selecione o inseminador</option>
              {% for inseminador in inseminadores_iatf %}
              <option value="{{ inseminador.id }}">{{ inseminador.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px;">Lote IATF</label>
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
            <select id="iatfLoteSelectV2" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Usar lote existente</option>
              {% for lote in lotes_iatf %}
              <option value="{{ lote.id }}">{{ lote.nome }} ({{ lote.status }})</option>
              {% endfor %}
            </select>
            <input type="text" id="iatfLoteNovoV2" placeholder="Ou criar novo lote" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px;">Observa√ß√µes</label>
          <textarea id="iatfObservacoesV2" rows="3" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Observa√ß√µes sobre o protocolo..."></textarea>
        </div>
        
        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 8px;">Etapas do Protocolo (ser√£o geradas automaticamente)</div>
          <div id="iatfEtapasPreviewV2" style="font-size: 0.85rem; color: #455a64;">
            Selecione um protocolo para visualizar as etapas
          </div>
        </div>
      </div>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="iatfCancelarBtnV2">
        Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-primary" id="iatfConfirmarBtnV2">
        <i class="fas fa-check"></i> Confirmar Protocolo
      </button>
    </div>
  </div>
</div>

<!-- Modal de hist√≥rico e gr√°ficos -->
<div class="curral-modal-overlay" id="historicoModalOverlayV2" style="z-index: 2400;">
  <div class="curral-modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
    <div class="curral-modal-title">
      <i class="fas fa-chart-line"></i> Hist√≥rico do Animal
    </div>
    <div class="curral-modal-body">
      <div style="margin-bottom: 16px;">
        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
          <button type="button" class="btn btn-sm btn-outline-primary active" id="historicoTabPesoV2" onclick="mostrarHistoricoTab('peso')">
            <i class="fas fa-weight"></i> Evolu√ß√£o de Peso
          </button>
          <button type="button" class="btn btn-sm btn-outline-primary" id="historicoTabManejosV2" onclick="mostrarHistoricoTab('manejos')">
            <i class="fas fa-list"></i> Hist√≥rico de Manejos
          </button>
        </div>
      </div>
      
      <div id="historicoConteudoPesoV2">
        <div style="margin-bottom: 16px;">
          <canvas id="pesoChartV2" style="max-height: 300px;"></canvas>
        </div>
        <div id="pesoHistoricoListaV2" style="max-height: 300px; overflow-y: auto;">
          <!-- Lista ser√° preenchida dinamicamente -->
        </div>
      </div>
      
      <div id="historicoConteudoManejosV2" style="display: none;">
        <div id="manejosHistoricoListaV2" style="max-height: 500px; overflow-y: auto;">
          <!-- Lista ser√° preenchida dinamicamente -->
        </div>
      </div>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="historicoFecharBtnV2">
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- Modal Nova Sess√£o -->
<div class="curral-modal-overlay" id="novaSessaoModalV2" style="display: none;">
  <div class="curral-modal" style="max-width: 500px;">
    <div class="curral-modal-title">
      <i class="fas fa-plus-circle"></i> Nova Sess√£o de Curral
    </div>
    <div class="curral-modal-body">
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem;">Nome da Sess√£o</label>
        <input type="text" id="novaSessaoNomeV2" class="form-control" placeholder="Ex.: Curral 01 - 05/08 (Lote Novilhas)" style="width: 100%;">
        <small style="color: #78909c; font-size: 0.75rem;">Deixe em branco para gerar automaticamente</small>
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem;">Descri√ß√£o / Observa√ß√µes</label>
        <textarea id="novaSessaoDescricaoV2" class="form-control" rows="3" placeholder="Observa√ß√µes gerais da sess√£o" style="width: 100%; resize: vertical;"></textarea>
      </div>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fecharModalNovaSessaoV2()">
        Cancelar
      </button>
      <button type="button" class="btn btn-sm btn-primary" onclick="criarSessaoV2()">
        <i class="fas fa-check"></i> Criar Sess√£o
      </button>
    </div>
  </div>
</div>

<!-- Popup de conflito de n√∫mero de manejo -->
<div class="curral-modal-overlay" id="conflitoManejoOverlayV2">
  <div class="curral-modal" style="max-width:600px;">
    <div class="curral-modal-title">
      <i class="fas fa-exclamation-triangle"></i> Conflito de n√∫mero de manejo
    </div>
    <div class="curral-modal-body">
      <p style="margin-bottom:12px;color:#d32f2f;font-weight:600;">
        Existem animais cadastrados com o mesmo n√∫mero de manejo. Selecione o animal correto pelo <strong>SISBOV completo</strong>:
      </p>
      <div id="conflitoManejoListaV2" style="max-height:300px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:6px;padding:8px;">
        <!-- Lista de animais ser√° preenchida dinamicamente -->
      </div>
      <p style="margin-top:12px;font-size:0.78rem;color:#607d8b;">
        <strong>Importante:</strong> O cadastro sempre deve ser feito pelo n√∫mero SISBOV completo (15 d√≠gitos), n√£o pelo n√∫mero de manejo.
      </p>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="conflitoManejoCancelarBtnV2">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Configura√ß√£o de Aparta√ß√µes -->
<div class="curral-modal-overlay" id="modalApartacaoV2" style="display: none;" onclick="if(event.target === this) fecharModalApartacao();">
  <div class="curral-modal" style="max-width: 600px;" onclick="event.stopPropagation();">
    <div class="curral-modal-header">
      <h3><i class="fas fa-layer-group"></i> Configurar Aparta√ß√µes</h3>
      <button type="button" class="btn-close-modal" onclick="fecharModalApartacao()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="curral-modal-body">
      <p style="margin-bottom: 16px; color: var(--monpec-text-light); font-size: 0.9rem;">
        Configure as aparta√ß√µes com nome e faixa de peso. Os animais ser√£o classificados automaticamente ap√≥s a pesagem.
      </p>
      
      <div id="listaApartacoesV2" style="margin-bottom: 16px;">
        <!-- Lista de aparta√ß√µes ser√° preenchida aqui -->
      </div>
      
      <div style="border-top: 1px solid var(--monpec-border); padding-top: 16px;">
        <h4 style="font-size: 0.95rem; margin-bottom: 12px; color: var(--monpec-text);">
          <i class="fas fa-plus-circle"></i> Adicionar Nova Aparta√ß√£o
        </h4>
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; align-items: end;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.85rem;">Nome</label>
            <input type="text" id="novaApartacaoNome" class="form-control" placeholder="Ex: Leve, M√©dia, Pesada" style="font-size: 0.9rem;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.85rem;">Peso M√≠n. (kg)</label>
            <input type="number" id="novaApartacaoMin" class="form-control" placeholder="0" step="0.1" style="font-size: 0.9rem;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.85rem;">Peso M√°x. (kg)</label>
            <input type="number" id="novaApartacaoMax" class="form-control" placeholder="999" step="0.1" style="font-size: 0.9rem;">
          </div>
          <div>
            <button type="button" class="btn btn-primary" onclick="adicionarApartacao()" style="font-size: 0.9rem;">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="curral-modal-footer">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fecharModalApartacao()">
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- Popup de Indica√ß√£o de Aparta√ß√£o -->
<div id="popupApartacaoV2" class="popup-apartacao" style="display: none;">
  <div class="popup-apartacao-content">
    <i class="fas fa-check-circle popup-apartacao-icon"></i>
    <div class="popup-apartacao-text">
      <div class="popup-apartacao-title">Aparta√ß√£o</div>
      <div class="popup-apartacao-nome" id="popupApartacaoNomeV2"></div>
    </div>
  </div>
</div>

<!-- Painel de Logs da Simula√ß√£o -->
<div id="simulacaoPainel" class="simulacao-painel">
  <div class="simulacao-painel-header">
    <h4><i class="fas fa-terminal"></i> Logs da Simula√ß√£o</h4>
    <div class="simulacao-painel-controles">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="btnLimparLogs" title="Limpar logs">
        <i class="fas fa-trash"></i>
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMinimizarPainel" title="Minimizar">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>
  <div class="simulacao-painel-body" id="simulacaoLogsConteudo">
    <div class="simulacao-log info">
      <span class="simulacao-log-time"></span>
      <span class="simulacao-log-message">Aguardando in√≠cio da simula√ß√£o...</span>
    </div>
  </div>
</div>

<!-- ========== SISTEMA DE SIMULA√á√ÉO PROFISSIONAL - VERS√ÉO 2.0 ========== -->
<script>
// ========== FUN√á√ïES GLOBAIS DO MODAL DE CONFIGURA√á√ÉO ==========
// Definir fun√ß√µes globais ANTES de qualquer outro c√≥digo para garantir disponibilidade

// Fun√ß√£o para abrir modal de configura√ß√£o da sess√£o
// Para reprodu√ß√£o, abre modal dedicado; para outros tipos, abre modal com abas
window.abrirModalConfigSessao = function(tipo) {
  console.log('üîµ [ABRIR MODAL CONFIG] Tipo:', tipo);
  
  try {
    // Fechar qualquer modal que possa estar aberto primeiro
    const modalPesagem = document.getElementById('modalConfigPesagem');
    const modalReprodutivo = document.getElementById('modalConfigReprodutivo');
  
  if (modalPesagem) {
    modalPesagem.style.display = 'none';
  }
  if (modalReprodutivo && tipo !== 'reprodutivo' && tipo !== 'reproducao') {
    modalReprodutivo.style.display = 'none';
  }
  
  // Se for reprodu√ß√£o, abrir modal dedicado
  if (tipo === 'reprodutivo' || tipo === 'reproducao') {
    console.log('üîµ [REPRODU√á√ÉO] Abrindo modal dedicado...');
    
    // Fun√ß√£o auxiliar para abrir o modal
    function abrirModalReprodutivo() {
      const modal = document.getElementById('modalConfigReprodutivo');
      console.log('üîç [REPRODU√á√ÉO] Tentando encontrar modal...', {
        modal: modal,
        modalEncontrado: !!modal,
        documentReadyState: document.readyState
      });
      
      if (modal) {
        // For√ßar todas as propriedades CSS necess√°rias para garantir visibilidade
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.zIndex = '10000';
        
        const computedStyle = window.getComputedStyle(modal);
        console.log('‚úÖ [REPRODU√á√ÉO] Modal dedicado aberto!', {
          display: modal.style.display,
          computedDisplay: computedStyle.display,
          visibility: computedStyle.visibility,
          opacity: computedStyle.opacity,
          zIndex: computedStyle.zIndex,
          position: computedStyle.position,
          top: computedStyle.top,
          left: computedStyle.left
        });
        
        // Verificar se realmente est√° vis√≠vel ap√≥s um pequeno delay
        setTimeout(function() {
          const computedStyle = window.getComputedStyle(modal);
          const aindaVisivel = computedStyle.display !== 'none';
          console.log('üîç [REPRODU√á√ÉO] Verifica√ß√£o p√≥s-abertura:', {
            display: computedStyle.display,
            visibility: computedStyle.visibility,
            opacity: computedStyle.opacity,
            zIndex: computedStyle.zIndex,
            width: computedStyle.width,
            height: computedStyle.height,
            top: computedStyle.top,
            left: computedStyle.left,
            position: computedStyle.position
          });
          
          if (!aindaVisivel) {
            console.error('‚ùå [REPRODU√á√ÉO] Modal foi fechado imediatamente ap√≥s abrir!');
            // Tentar abrir novamente
            modal.style.display = 'flex';
          } else {
            // Verificar se est√° realmente vis√≠vel na tela
            const rect = modal.getBoundingClientRect();
            console.log('üìê [REPRODU√á√ÉO] Posi√ß√£o do modal:', {
              top: rect.top,
              left: rect.left,
              width: rect.width,
              height: rect.height,
              visible: rect.width > 0 && rect.height > 0
            });
            
            if (rect.width === 0 || rect.height === 0) {
              console.error('‚ùå [REPRODU√á√ÉO] Modal tem largura/altura zero!');
            }
          }
        }, 100);
        
        // Carregar configura√ß√µes salvas se existirem
        setTimeout(function() {
          if (typeof window.carregarConfigReprodutivoModal === 'function') {
            window.carregarConfigReprodutivoModal();
          } else {
            console.warn('‚ö†Ô∏è Fun√ß√£o carregarConfigReprodutivoModal n√£o encontrada');
          }
        }, 100);
        return true;
      } else {
        console.error('‚ùå [REPRODU√á√ÉO] Modal n√£o encontrado! Verificando DOM...');
        // Tentar encontrar o modal de outra forma
        const todosModais = document.querySelectorAll('[id*="modal"], [id*="Modal"]');
        console.log('üîç Todos os modais encontrados:', Array.from(todosModais).map(m => m.id));
        return false;
      }
    }
    
    // Tentar abrir imediatamente
    if (abrirModalReprodutivo()) {
      return;
    }
    
    // Se n√£o encontrou, tentar novamente ap√≥s pequeno delay (para garantir que o DOM est√° renderizado)
    setTimeout(function() {
      if (abrirModalReprodutivo()) {
        return;
      }
      // √öltima tentativa ap√≥s mais tempo
      setTimeout(function() {
        if (!abrirModalReprodutivo()) {
          console.error('‚ùå [REPRODU√á√ÉO] Modal n√£o encontrado ap√≥s m√∫ltiplas tentativas!');
          console.error('‚ùå Verificando se o elemento existe no HTML...');
          const modalElement = document.querySelector('#modalConfigReprodutivo');
          if (!modalElement) {
            alert('Erro: Modal de reprodu√ß√£o n√£o encontrado no DOM. O elemento pode n√£o ter sido renderizado. Recarregue a p√°gina.');
          } else {
            alert('Erro: Modal encontrado mas n√£o conseguiu abrir. Verifique o console para mais detalhes.');
          }
        }
      }, 300);
    }, 100);
    return;
  }
  
  // Para outros tipos, usar modal com abas
  if (modalPesagem) {
    modalPesagem.style.display = 'flex';
    
    setTimeout(function() {
      const tabMap = {
        'sanitario': 'sanitario',
        'movimentacao': 'movimentacao',
        'pesagem': 'pesagem'
      };
      
      const tabId = tabMap[tipo] || 'pesagem';
      const tab = document.querySelector(`.config-sessao-tab[data-tab="${tabId}"]`);
      if (tab) {
        tab.click();
      }
    }, 150);
  } else {
    console.error('‚ùå Modal de pesagem n√£o encontrado!');
    alert('Erro: Modal de configura√ß√£o n√£o encontrado. Recarregue a p√°gina.');
  }
};

// Fun√ß√£o para fechar modal de reprodu√ß√£o
window.fecharModalConfigReprodutivo = function() {
  console.log('üî¥ [FECHAR MODAL] Fechando modal de reprodu√ß√£o...');
  const modal = document.getElementById('modalConfigReprodutivo');
  if (modal) {
    modal.style.display = 'none';
    console.log('‚úÖ [FECHAR MODAL] Modal fechado.');
  } else {
    console.warn('‚ö†Ô∏è [FECHAR MODAL] Modal n√£o encontrado para fechar.');
  }
};

// Garantir que a fun√ß√£o est√° dispon√≠vel
console.log('‚úÖ Fun√ß√£o abrirModalConfigSessao definida:', typeof window.abrirModalConfigSessao);
console.log('‚úÖ Fun√ß√£o fecharModalConfigReprodutivo definida:', typeof window.fecharModalConfigReprodutivo);

window.abrirModalConfigPesagem = function() {
  console.log('üîµ [PESAGEM] Tentando abrir modal de configura√ß√£o...');
  const modal = document.getElementById('modalConfigPesagem');
  if (!modal) {
    console.error('‚ùå [PESAGEM] Modal n√£o encontrado!');
    alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
    return;
  }
  console.log('‚úÖ [PESAGEM] Modal encontrado, abrindo...');
  modal.style.display = 'flex';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  modal.style.zIndex = '10000';
  
  // Ativar aba de pesagem
  setTimeout(() => {
    const tab = document.querySelector('.config-sessao-tab[data-tab="pesagem"]');
    if (tab) {
      // Remover active de todas as tabs
      document.querySelectorAll('.config-sessao-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      tab.style.borderBottomColor = '#1976d2';
      
      // Mostrar conte√∫do de pesagem
      const contents = ['configPesagemContent', 'configSanitarioContent', 'configReprodutivoContent', 'configMovimentacaoContent'];
      contents.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const pesagemContent = document.getElementById('configPesagemContent');
      if (pesagemContent) pesagemContent.style.display = 'block';
    }
  }, 100);
  // Carregar valores salvos se existirem
  const configSalva = window.configPesagemSalva || {};
  if (configSalva.tipoPesagem) {
    const radio = document.getElementById(configSalva.tipoPesagem === 'rotina' ? 'pesagemRotinaModal' : 'pesagemAparteModal');
    if (radio) radio.checked = true;
  }
  if (configSalva.autoProximo !== undefined) {
    const checkbox = document.getElementById('autoProximoModal');
    if (checkbox) checkbox.checked = configSalva.autoProximo;
  }
  
  // Carregar faixas de peso salvas ou usar valores padr√£o
  const faixas = configSalva.faixasPeso;
  if (faixas) {
    // Carregar valores salvos
    if (faixas.boiada) {
      const minBoiada = document.getElementById('faixaBoiadaMin');
      const maxBoiada = document.getElementById('faixaBoiadaMax');
      if (minBoiada) minBoiada.value = faixas.boiada.min !== null && faixas.boiada.min !== undefined ? faixas.boiada.min : '520';
      if (maxBoiada) maxBoiada.value = faixas.boiada.max !== null && faixas.boiada.max !== undefined ? faixas.boiada.max : '999';
    }
    if (faixas.cabeceira) {
      const minCabeceira = document.getElementById('faixaCabeceiraMin');
      const maxCabeceira = document.getElementById('faixaCabeceiraMax');
      if (minCabeceira) minCabeceira.value = faixas.cabeceira.min !== null && faixas.cabeceira.min !== undefined ? faixas.cabeceira.min : '380';
      if (maxCabeceira) maxCabeceira.value = faixas.cabeceira.max !== null && faixas.cabeceira.max !== undefined ? faixas.cabeceira.max : '519';
    }
    if (faixas.meio) {
      const minMeio = document.getElementById('faixaMeioMin');
      const maxMeio = document.getElementById('faixaMeioMax');
      if (minMeio) minMeio.value = faixas.meio.min !== null && faixas.meio.min !== undefined ? faixas.meio.min : '300';
      if (maxMeio) maxMeio.value = faixas.meio.max !== null && faixas.meio.max !== undefined ? faixas.meio.max : '379';
    }
    if (faixas.fundo) {
      const minFundo = document.getElementById('faixaFundoMin');
      const maxFundo = document.getElementById('faixaFundoMax');
      if (minFundo) minFundo.value = faixas.fundo.min !== null && faixas.fundo.min !== undefined ? faixas.fundo.min : '0';
      if (maxFundo) maxFundo.value = faixas.fundo.max !== null && faixas.fundo.max !== undefined ? faixas.fundo.max : '299';
    }
  } else {
    // Se n√£o h√° valores salvos, garantir que os valores padr√£o estejam presentes
    // (j√° est√£o no HTML, mas garantimos aqui tamb√©m)
    const minBoiada = document.getElementById('faixaBoiadaMin');
    const maxBoiada = document.getElementById('faixaBoiadaMax');
    const minCabeceira = document.getElementById('faixaCabeceiraMin');
    const maxCabeceira = document.getElementById('faixaCabeceiraMax');
    const minMeio = document.getElementById('faixaMeioMin');
    const maxMeio = document.getElementById('faixaMeioMax');
    const minFundo = document.getElementById('faixaFundoMin');
    const maxFundo = document.getElementById('faixaFundoMax');
    
    if (minBoiada && !minBoiada.value) minBoiada.value = '520';
    if (maxBoiada && !maxBoiada.value) maxBoiada.value = '999';
    if (minCabeceira && !minCabeceira.value) minCabeceira.value = '380';
    if (maxCabeceira && !maxCabeceira.value) maxCabeceira.value = '519';
    if (minMeio && !minMeio.value) minMeio.value = '300';
    if (maxMeio && !maxMeio.value) maxMeio.value = '379';
    if (minFundo && !minFundo.value) minFundo.value = '0';
    if (maxFundo && !maxFundo.value) maxFundo.value = '299';
  }
  
  // Atualizar visual dos radio buttons e mostrar/ocultar faixas
  setTimeout(function() {
    if (typeof window.atualizarVisualRadioPesagem === 'function') {
      window.atualizarVisualRadioPesagem();
    }
    // Configurar event listeners novamente quando o modal abrir
    const rotinaRadio = document.getElementById('pesagemRotinaModal');
    const aparteRadio = document.getElementById('pesagemAparteModal');
    const faixasContainer = document.getElementById('configFaixasPesoContainer');
    
    if (rotinaRadio) {
      rotinaRadio.onchange = function() {
        if (this.checked && faixasContainer) {
          faixasContainer.style.display = 'none';
        }
        if (typeof window.atualizarVisualRadioPesagem === 'function') {
          window.atualizarVisualRadioPesagem();
        }
      };
    }
    
    if (aparteRadio) {
      aparteRadio.onchange = function() {
        if (this.checked && faixasContainer) {
          faixasContainer.style.display = 'block';
        }
        if (typeof window.atualizarVisualRadioPesagem === 'function') {
          window.atualizarVisualRadioPesagem();
        }
      };
    }
    
    // Verificar estado inicial
    if (aparteRadio && aparteRadio.checked && faixasContainer) {
      faixasContainer.style.display = 'block';
    } else if (rotinaRadio && rotinaRadio.checked && faixasContainer) {
      faixasContainer.style.display = 'none';
    }
  }, 100);
};

window.fecharModalConfigPesagem = function() {
  const modal = document.getElementById('modalConfigPesagem');
  if (modal) {
    modal.style.display = 'none';
  }
};

// ========== FUN√á√ÉO PARA ATUALIZAR CARD DE RESUMO (DEFINIDA ANTES DE confirmarConfigPesagem) ==========
window.atualizarCardResumoConfig = function() {
  console.log('üîÑ [ATUALIZAR CARD] Iniciando atualiza√ß√£o do card de resumo...');
  
  const cardResumo = document.getElementById('cardResumoConfigPesagem');
  const resumoContent = document.getElementById('resumoConfigPesagem');
  const cardOriginal = document.getElementById('cardConfigPesagem');
  
  if (!cardResumo) {
    console.error('‚ùå [ATUALIZAR CARD] Card de resumo n√£o encontrado!');
    return;
  }
  
  if (!resumoContent) {
    console.error('‚ùå [ATUALIZAR CARD] Conte√∫do do resumo n√£o encontrado!');
    return;
  }
  
  console.log('‚úÖ [ATUALIZAR CARD] Elementos encontrados');
  
  const config = window.configPesagemSalva;
  if (!config) {
    console.log('‚ö†Ô∏è [ATUALIZAR CARD] Nenhuma configura√ß√£o salva, escondendo card');
    cardResumo.style.display = 'none';
    // Se n√£o h√° configura√ß√£o, mostrar o card original
    if (cardOriginal) {
      cardOriginal.style.display = 'block';
    }
    return;
  }
  
  console.log('‚úÖ [ATUALIZAR CARD] Configura√ß√£o encontrada:', config);
  
  const tipoTexto = config.tipoPesagem === 'rotina' ? 'Pesagem de Rotina' : 'Pesagem para Aparta√ß√£o';
  const autoTexto = config.autoProximo ? 'Sim' : 'N√£o';
  
  // Criar √≠cone baseado no tipo de pesagem
  const iconeTipo = config.tipoPesagem === 'rotina' ? 'fa-weight' : 'fa-layer-group';
  const corTipo = config.tipoPesagem === 'rotina' ? '#1976d2' : '#ff9800';
  
    resumoContent.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
        <div style="flex: 1; min-width: 0;">
          <h3 style="margin: 0 0 4px 0; font-size: 0.95rem; color: #1976d2; font-weight: 600;">
            Pesagem Ativa
          </h3>
          <div style="font-weight: 600; color: #333; font-size: 0.85rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${tipoTexto}</div>
          <div style="font-size: 0.75rem; color: #666; line-height: 1.2;">
            ${config.tipoPesagem === 'rotina' ? 'Registra no hist√≥rico' : 'Apenas loteamento'}
          </div>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 6px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; font-size: 0.75rem;">
        <span style="font-weight: 600; color: #333;">Auto:</span>
        <span style="font-weight: 500;">${autoTexto}</span>
      </div>
    `;
  
  console.log('‚úÖ [ATUALIZAR CARD] Conte√∫do HTML gerado');
  
  // Esconder card original e mostrar card de resumo
  if (cardOriginal) {
    cardOriginal.style.display = 'none';
    console.log('‚úÖ [ATUALIZAR CARD] Card original escondido');
  }
  
    // For√ßar exibi√ß√£o do card de resumo
    cardResumo.style.display = 'flex';
    cardResumo.style.visibility = 'visible';
    cardResumo.style.opacity = '1';
    
    // Atualizar visualiza√ß√£o da balan√ßa baseado no tipo de pesagem
    if (typeof window.atualizarVisualizacaoBalanca === 'function') {
      window.atualizarVisualizacaoBalanca();
    }
    
    console.log('‚úÖ [ATUALIZAR CARD] Card de resumo exibido');
    console.log('‚úÖ [ATUALIZAR CARD] display:', cardResumo.style.display, 'visibility:', cardResumo.style.visibility);
  };
  
  // Fun√ß√£o para atualizar visualiza√ß√£o da balan√ßa baseado no tipo de pesagem
  window.atualizarVisualizacaoBalanca = function() {
    console.log('üîÑ [ATUALIZAR BALAN√áA] Atualizando visualiza√ß√£o...');
    
    const config = window.configPesagemSalva;
    const containerRotina = document.getElementById('balancaRotinaContainer');
    const containerApartacao = document.getElementById('balancaApartacaoContainer');
    const tituloBalanca = document.getElementById('balancaTitulo');
    
    if (!containerRotina || !containerApartacao || !tituloBalanca) {
      console.error('‚ùå [ATUALIZAR BALAN√áA] Elementos n√£o encontrados!');
      return;
    }
    
    if (!config || config.tipoPesagem === 'rotina') {
      // Mostrar vers√£o de Rotina
      containerRotina.style.display = 'block';
      containerApartacao.style.display = 'none';
      tituloBalanca.textContent = 'PESAGEM DE ROTINA';
      console.log('‚úÖ [ATUALIZAR BALAN√áA] Exibindo vers√£o Rotina');
      
      // Se houver animal identificado, habilitar campo de rotina
      if (window.animalAtualV2 && window.animalAtualV2.id) {
        if (typeof window.habilitarCampoPesoV2 === 'function') {
          window.habilitarCampoPesoV2();
        }
      } else {
        if (typeof window.desabilitarCampoPesoV2 === 'function') {
          window.desabilitarCampoPesoV2();
        }
      }
    } else if (config.tipoPesagem === 'aparte') {
      // Mostrar vers√£o de Aparta√ß√£o
      containerRotina.style.display = 'none';
      containerApartacao.style.display = 'block';
      tituloBalanca.textContent = 'PESAGEM DE APARTA√á√ÉO';
      console.log('‚úÖ [ATUALIZAR BALAN√áA] Exibindo vers√£o Aparta√ß√£o');
      
      // Atualizar estat√≠sticas dos lotes
      if (typeof window.atualizarEstatisticasLotes === 'function') {
        window.atualizarEstatisticasLotes();
      }
      
      // Se houver animal identificado, habilitar campo de aparta√ß√£o
      if (window.animalAtualV2 && window.animalAtualV2.id) {
        if (typeof window.habilitarCampoPesoV2 === 'function') {
          window.habilitarCampoPesoV2();
        }
        // Atualizar campos de peso na se√ß√£o de aparta√ß√£o
        if (typeof window.atualizarCamposPesoApartacao === 'function') {
          window.atualizarCamposPesoApartacao(window.animalAtualV2);
        }
      } else {
        if (typeof window.desabilitarCampoPesoV2 === 'function') {
          window.desabilitarCampoPesoV2();
        }
        // Limpar campos se n√£o h√° animal
        if (typeof window.atualizarCamposPesoApartacao === 'function') {
          window.atualizarCamposPesoApartacao(null);
        }
      }
    }
  };
  
  // Fun√ß√£o para atualizar estat√≠sticas dos lotes na pesagem de aparta√ß√£o
  window.atualizarEstatisticasLotes = function() {
    console.log('üîÑ [ATUALIZAR LOTES] Atualizando estat√≠sticas dos lotes...');
    
    // Inicializar estrutura de dados dos lotes se n√£o existir
    if (!window.pesagensLotes) {
      window.pesagensLotes = {
        CABECEIRA: [],
        MEIO: [],
        FUNDO: [],
        BOIADA: []
      };
    }
    
    // Mapeamento de lotes para IDs (primeira letra mai√∫scula, resto min√∫sculo)
    const mapeamentoLotes = {
      'BOIADA': 'Boiada',
      'CABECEIRA': 'Cabeceira',
      'MEIO': 'Meio',
      'FUNDO': 'Fundo'
    };
    
    const lotes = ['BOIADA', 'CABECEIRA', 'MEIO', 'FUNDO'];
    
    lotes.forEach(function(lote) {
      const pesagens = window.pesagensLotes[lote] || [];
      const quantidade = pesagens.length;
      const pesoTotal = pesagens.reduce(function(sum, p) {
        return sum + (parseFloat(p.peso) || 0);
      }, 0);
      const media = quantidade > 0 ? pesoTotal / quantidade : 0;
      
      // Obter nome formatado para o ID
      const nomeFormatado = mapeamentoLotes[lote];
      
      // Atualizar elementos usando o formato correto do ID
      const quantidadeEl = document.getElementById('lote' + nomeFormatado + 'Quantidade');
      const pesoTotalEl = document.getElementById('lote' + nomeFormatado + 'PesoTotal');
      const mediaEl = document.getElementById('lote' + nomeFormatado + 'Media');
      
      console.log(`üìä [ATUALIZAR LOTES] ${lote}:`, {
        quantidade: quantidade,
        pesoTotal: pesoTotal,
        media: media,
        elementos: {
          quantidade: !!quantidadeEl,
          pesoTotal: !!pesoTotalEl,
          media: !!mediaEl
        }
      });
      
      if (quantidadeEl) {
        quantidadeEl.textContent = quantidade;
        console.log(`‚úÖ [ATUALIZAR LOTES] ${lote} Quantidade atualizada:`, quantidade);
      } else {
        console.warn(`‚ö†Ô∏è [ATUALIZAR LOTES] Elemento n√£o encontrado: lote${nomeFormatado}Quantidade`);
      }
      
      if (pesoTotalEl) {
        pesoTotalEl.textContent = pesoTotal.toFixed(1).replace('.', ',') + ' kg';
        console.log(`‚úÖ [ATUALIZAR LOTES] ${lote} Peso Total atualizado:`, pesoTotal);
      } else {
        console.warn(`‚ö†Ô∏è [ATUALIZAR LOTES] Elemento n√£o encontrado: lote${nomeFormatado}PesoTotal`);
      }
      
      if (mediaEl) {
        if (quantidade > 0) {
          mediaEl.textContent = media.toFixed(1).replace('.', ',') + ' kg';
          console.log(`‚úÖ [ATUALIZAR LOTES] ${lote} M√©dia atualizada:`, media);
        } else {
          mediaEl.textContent = '‚Äî';
        }
      } else {
        console.warn(`‚ö†Ô∏è [ATUALIZAR LOTES] Elemento n√£o encontrado: lote${nomeFormatado}Media`);
      }
    });
    
    console.log('‚úÖ [ATUALIZAR LOTES] Estat√≠sticas atualizadas. Dados:', window.pesagensLotes);
  };
  
  // Fun√ß√£o para mostrar notifica√ß√£o moderna no centro da p√°gina
  window.mostrarNotificacaoApartacao = function(mensagem, categoria, peso) {
    // Remover notifica√ß√£o anterior se existir
    const notificacaoAnterior = document.getElementById('notificacaoApartacao');
    if (notificacaoAnterior) {
      notificacaoAnterior.remove();
    }
    
    // Definir cores baseadas na categoria
    const coresCategoria = {
      'BOIADA': { bg: 'rgba(76, 175, 80, 0.95)', border: 'rgba(76, 175, 80, 1)', text: '#fff' },
      'CABECEIRA': { bg: 'rgba(33, 150, 243, 0.95)', border: 'rgba(33, 150, 243, 1)', text: '#fff' },
      'MEIO': { bg: 'rgba(255, 152, 0, 0.95)', border: 'rgba(255, 152, 0, 1)', text: '#fff' },
      'FUNDO': { bg: 'rgba(244, 67, 54, 0.95)', border: 'rgba(244, 67, 54, 1)', text: '#fff' }
    };
    
    const cor = coresCategoria[categoria] || coresCategoria['BOIADA'];
    
    // Criar elemento de notifica√ß√£o
    const notificacao = document.createElement('div');
    notificacao.id = 'notificacaoApartacao';
    notificacao.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: ${cor.bg};
      border: 3px solid ${cor.border};
      border-radius: 16px;
      padding: 32px 48px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 10001;
      text-align: center;
      color: ${cor.text};
      font-weight: 700;
      font-size: 1.5rem;
      min-width: 400px;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
    `;
    
    notificacao.innerHTML = `
      <div style="font-size: 2rem; margin-bottom: 12px;">
        <i class="fas fa-check-circle"></i>
      </div>
      <div style="font-size: 1.3rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
        ${mensagem}
      </div>
      <div style="font-size: 1.1rem; opacity: 0.9;">
        Peso: ${peso.toFixed(1).replace('.', ',')} kg
      </div>
    `;
    
    // Adicionar anima√ß√£o CSS
    if (!document.getElementById('notificacaoApartacaoStyle')) {
      const style = document.createElement('style');
      style.id = 'notificacaoApartacaoStyle';
      style.textContent = `
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translate(-50%, -60%);
            scale: 0.9;
          }
          to {
            opacity: 1;
            transform: translate(-50%, -50%);
            scale: 1;
          }
        }
        @keyframes slideOut {
          from {
            opacity: 1;
            transform: translate(-50%, -50%);
            scale: 1;
          }
          to {
            opacity: 0;
            transform: translate(-50%, -40%);
            scale: 0.9;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Adicionar ao body
    document.body.appendChild(notificacao);
    
    // Fun√ß√£o para fechar notifica√ß√£o
    const fecharNotificacao = function() {
      notificacao.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        if (notificacao.parentNode) {
          notificacao.remove();
        }
      }, 300);
    };
    
    // Fechar ap√≥s 2,5 segundos
    const timeout = setTimeout(fecharNotificacao, 2500);
    
    // Fechar ao pressionar Enter
    const handleKeyPress = function(event) {
      if (event.key === 'Enter' || event.key === 'Escape') {
        clearTimeout(timeout);
        fecharNotificacao();
        document.removeEventListener('keydown', handleKeyPress);
      }
    };
    
    document.addEventListener('keydown', handleKeyPress);
    
    // Fechar ao clicar na notifica√ß√£o
    notificacao.addEventListener('click', function() {
      clearTimeout(timeout);
      fecharNotificacao();
      document.removeEventListener('keydown', handleKeyPress);
    });
  };
  
  // Fun√ß√£o para atualizar campos de peso na se√ß√£o de aparta√ß√£o
  window.atualizarCamposPesoApartacao = function(animal, pesoNovo) {
    console.log('üìä [ATUALIZAR CAMPOS APARTA√á√ÉO] Atualizando campos de peso...', { animal, pesoNovo });
    
    const pesoUltimoValor = document.getElementById('pesoUltimoValorApartacaoV2');
    const pesoAtualValor = document.getElementById('pesoAtualValorApartacaoV2');
    const periodoDiasValor = document.getElementById('periodoDiasValorApartacaoV2');
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaApartacaoV2');
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalApartacaoV2');
    
    if (!animal) {
      // Limpar campos se n√£o h√° animal
      if (pesoUltimoValor) pesoUltimoValor.textContent = '‚Äî';
      if (pesoAtualValor) pesoAtualValor.textContent = '‚Äî';
      if (periodoDiasValor) periodoDiasValor.textContent = '‚Äî';
      if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
      if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
      return;
    }
    
    // Obter √∫ltimo peso e data
    const ultimoPeso = animal.peso_anterior || (animal.pesagem_anterior && animal.pesagem_anterior.peso ? parseFloat(animal.pesagem_anterior.peso) : null) || null;
    const dataUltimaPeso = animal.data_peso_anterior || (animal.pesagem_anterior && animal.pesagem_anterior.data ? animal.pesagem_anterior.data : null) || null;
    
    // Se temos peso novo, usar ele como peso atual
    const pesoAtual = pesoNovo || animal.peso_atual || (animal.pesagem_atual && animal.pesagem_atual.peso ? parseFloat(animal.pesagem_atual.peso) : null) || null;
    
    // Atualizar √öltimo Peso com data
    if (pesoUltimoValor) {
      if (ultimoPeso && !isNaN(ultimoPeso) && ultimoPeso > 0) {
        const pesoFormatado = ultimoPeso.toFixed(1).replace('.', ',');
        let textoUltimoPeso = `${pesoFormatado} kg`;
        
        // Adicionar data se dispon√≠vel
        if (dataUltimaPeso) {
          try {
            const dataFormatada = new Date(dataUltimaPeso).toLocaleDateString('pt-BR');
            textoUltimoPeso += ` (${dataFormatada})`;
          } catch (e) {
            console.warn('Erro ao formatar data do √∫ltimo peso:', e);
          }
        }
        
        pesoUltimoValor.textContent = textoUltimoPeso;
        console.log('‚úÖ [APARTA√á√ÉO] √öltimo peso atualizado:', textoUltimoPeso);
      } else {
        pesoUltimoValor.textContent = '‚Äî';
      }
    }
    
    // Atualizar Peso Atual
    if (pesoAtualValor) {
      if (pesoAtual && !isNaN(pesoAtual) && pesoAtual > 0) {
        pesoAtualValor.textContent = `${pesoAtual.toFixed(1).replace('.', ',')} kg`;
        console.log('‚úÖ [APARTA√á√ÉO] Peso atual atualizado:', pesoAtual);
      } else {
        pesoAtualValor.textContent = '‚Äî';
      }
    }
    
    // Calcular ganhos se temos ambos os pesos
    if (ultimoPeso && pesoAtual && !isNaN(ultimoPeso) && !isNaN(pesoAtual) && ultimoPeso > 0 && pesoAtual > 0 && ultimoPeso !== pesoAtual) {
      const ganhoTotal = pesoAtual - ultimoPeso;
      
      // Calcular dias
      let dias = 30; // Padr√£o
      if (dataUltimaPeso) {
        try {
          const dataUltima = new Date(dataUltimaPeso);
          const dataAtual = pesoNovo ? new Date() : (animal.data_peso_atual ? new Date(animal.data_peso_atual) : new Date());
          const diffMs = Math.abs(dataAtual - dataUltima);
          dias = Math.max(1, Math.round(diffMs / (1000 * 60 * 60 * 24)));
        } catch (e) {
          console.warn('Erro ao calcular dias:', e);
        }
      }
      
      const ganhoDiario = ganhoTotal / dias;
      
      // Atualizar Per√≠odos em Dias
      if (periodoDiasValor) {
        periodoDiasValor.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
      }
      
      // Atualizar Ganho di√°rio
      if (pesoGanhoDia) {
        pesoGanhoDia.textContent = `${ganhoDiario >= 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
      }
      
      // Atualizar Ganho Total de Peso
      if (pesoGanhoTotal) {
        pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
      }
      
      console.log('‚úÖ [APARTA√á√ÉO] Ganhos calculados:', { dias, ganhoTotal, ganhoDiario });
    } else {
      // Limpar campos de ganho se n√£o h√° dados suficientes
      if (periodoDiasValor) periodoDiasValor.textContent = '‚Äî';
      if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
      if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
    }
  };
  
  // ========== SIMULADOR DE PESAGEM POR APARTA√á√ÉO ==========
  window.simuladorApartacao = {
    ativo: false,
    animais: [],
    contador: 0,
    intervalo: null,
    tempoInicio: null,
    
    // Gerar animal macho com peso baseado na idade
    gerarAnimal: function() {
      const idades = [6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36];
      const idadeMeses = idades[Math.floor(Math.random() * idades.length)];
      
      // Calcular peso baseado na idade (somente machos)
      // F√≥rmula: peso base de 150kg + (idade em meses * 8kg/m√™s) + varia√ß√£o de -20 a +30kg
      const pesoBase = 150 + (idadeMeses * 8);
      const variacao = (Math.random() * 50) - 20; // -20 a +30
      const peso = Math.max(100, Math.round((pesoBase + variacao) * 10) / 10);
      
      // Gerar SISBOV
      const sisbov = 'BR' + Array.from({ length: 13 }, () => Math.floor(Math.random() * 10)).join('');
      const numeroManejo = sisbov.substring(8, 14);
      
      // Ra√ßas comuns
      const racas = ['Nelore', 'Angus', 'Brahman', 'Hereford', 'Indubrasil', 'Gir', 'Guzer√°', 'Canchim'];
      const raca = racas[Math.floor(Math.random() * racas.length)];
      
      // Calcular data de nascimento
      const hoje = new Date();
      const dataNascimento = new Date(hoje);
      dataNascimento.setMonth(dataNascimento.getMonth() - idadeMeses);
      
      // Gerar ID √∫nico baseado em timestamp e contador
      const idUnico = Date.now() + Math.random() * 1000 + this.animais.length;
      
      return {
        id: Math.floor(idUnico),
        codigo_sisbov: sisbov,
        numero_brinco: sisbov,
        numero_manejo: numeroManejo,
        raca: raca,
        sexo: 'M', // Sempre macho
        idade_meses: idadeMeses,
        data_nascimento: dataNascimento.toISOString().slice(0, 10),
        data_nascimento_format: dataNascimento.toLocaleDateString('pt-BR'),
        peso_atual: peso,
        peso_anterior: null,
        data_peso_atual: null,
        data_peso_anterior: null,
        categoria: idadeMeses < 12 ? 'Bezerro(o) 0-12 M' : idadeMeses < 24 ? 'Garrote 12-24 M' : 'Boi 24-36 M',
        situacao_bnd: 'Conforme',
        consta_bnd: true
      };
    },
    
    // Atualizar progresso da sess√£o
    atualizarProgresso: function() {
      const planejados = this.animais.length;
      const trabalhados = this.contador;
      const restantes = planejados - trabalhados;
      const percentual = planejados > 0 ? Math.round((trabalhados / planejados) * 100) : 0;
      
      const elPlanejados = document.getElementById('progressoPlanejados');
      const elTrabalhados = document.getElementById('progressoTrabalhados');
      const elRestantes = document.getElementById('progressoRestantes');
      const elPercentual = document.getElementById('progressoPercentual');
      const elBarFill = document.getElementById('progressoBarFill');
      
      if (elPlanejados) elPlanejados.textContent = planejados;
      if (elTrabalhados) elTrabalhados.textContent = trabalhados;
      if (elRestantes) elRestantes.textContent = restantes;
      if (elPercentual) elPercentual.textContent = percentual + '%';
      if (elBarFill) elBarFill.style.width = percentual + '%';
      
      // Atualizar por sexo (sempre machos)
      const elSexoMacho = document.getElementById('progressoSexoMacho');
      if (elSexoMacho) elSexoMacho.textContent = trabalhados;
      
      // Atualizar por ra√ßa
      const racasCount = {};
      this.animais.slice(0, trabalhados).forEach(animal => {
        const raca = animal.raca || 'Desconhecida';
        racasCount[raca] = (racasCount[raca] || 0) + 1;
      });
      
      const elRacaLista = document.getElementById('progressoRacaLista');
      if (elRacaLista) {
        if (Object.keys(racasCount).length > 0) {
          elRacaLista.innerHTML = Object.entries(racasCount)
            .map(([raca, count]) => `<div>${raca}: <strong>${count}</strong></div>`)
            .join('');
        } else {
          elRacaLista.textContent = '‚Äî';
        }
      }
      
      // Atualizar tempo decorrido
      if (this.tempoInicio) {
        const tempoDecorrido = Math.floor((Date.now() - this.tempoInicio) / 1000);
        const horas = Math.floor(tempoDecorrido / 3600);
        const minutos = Math.floor((tempoDecorrido % 3600) / 60);
        const segundos = tempoDecorrido % 60;
        const tempoFormatado = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
        
        const elTempoDecorrido = document.getElementById('progressoTempoDecorrido');
        if (elTempoDecorrido) elTempoDecorrido.textContent = tempoFormatado;
        
        // Tempo m√©dio por animal
        if (trabalhados > 0) {
          const tempoMedio = Math.floor(tempoDecorrido / trabalhados);
          const tempoMedioFormatado = `${String(Math.floor(tempoMedio / 60)).padStart(2, '0')}:${String(tempoMedio % 60).padStart(2, '0')}`;
          const elTempoMedio = document.getElementById('progressoTempoMedio');
          if (elTempoMedio) elTempoMedio.textContent = tempoMedioFormatado;
          
          // Estimativa de t√©rmino
          if (restantes > 0) {
            const tempoRestante = tempoMedio * restantes;
            const estimativa = new Date(Date.now() + tempoRestante * 1000);
            const estimativaFormatada = estimativa.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const elEstimativa = document.getElementById('progressoEstimativaTermino');
            if (elEstimativa) elEstimativa.textContent = estimativaFormatada;
          }
        }
      }
    },
    
    // Processar um animal
    processarAnimal: async function(animal) {
      console.log('üîÑ [SIMULADOR] Processando animal:', animal.numero_manejo);
      
      // 1. Preencher campo de brinco
      const brincoInput = document.getElementById('brincoInputV2');
      if (brincoInput) {
        brincoInput.value = animal.numero_manejo;
      }
      
      // 2. Preparar dados no formato esperado pelo sistema
      const dadosAnimal = {
        id: animal.id || Math.floor(Math.random() * 1000000),
        codigo_eletronico: animal.codigo_eletronico || '',
        codigo_sisbov: animal.codigo_sisbov,
        numero_brinco: animal.numero_brinco,
        numero_manejo: animal.numero_manejo,
        raca: animal.raca,
        sexo: animal.sexo,
        idade_meses: animal.idade_meses,
        data_nascimento: animal.data_nascimento,
        data_nascimento_format: animal.data_nascimento_format,
        peso_atual: animal.peso_atual,
        peso_anterior: animal.peso_anterior,
        data_peso_atual: animal.data_peso_atual,
        data_peso_anterior: animal.data_peso_anterior,
        categoria: animal.categoria,
        situacao_bnd: animal.situacao_bnd,
        consta_bnd: animal.consta_bnd,
        pesagem_atual: animal.peso_atual ? { peso: animal.peso_atual, data: animal.data_peso_atual || new Date().toISOString().slice(0, 10) } : null,
        pesagem_anterior: animal.peso_anterior ? { peso: animal.peso_anterior, data: animal.data_peso_anterior } : null
      };
      
      // 3. Simular resposta da API diretamente (sem fazer requisi√ß√£o real)
      // Definir animal atual
      window.animalAtualV2 = dadosAnimal;
      
      // 4. Processar animal identificado
      if (typeof window.processarAnimalIdentificado === 'function') {
        window.processarAnimalIdentificado(dadosAnimal);
      }
      
      // 5. Atualizar scanner resumo
      if (typeof window.atualizarScannerResumoV2 === 'function') {
        window.atualizarScannerResumoV2(dadosAnimal);
      }
      
      // 6. Aguardar processamento
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // 7. Atualizar campos de peso
      if (typeof window.atualizarCamposPesoApartacao === 'function') {
        window.atualizarCamposPesoApartacao(dadosAnimal);
      }
      
      // 8. Habilitar campo de peso
      if (typeof window.habilitarCampoPesoV2 === 'function') {
        window.habilitarCampoPesoV2();
      }
      
      // 9. Preencher campo de peso
      const pesoInput = document.getElementById('pesoValorApartacaoV2');
      if (pesoInput) {
        pesoInput.disabled = false;
        pesoInput.value = animal.peso_atual.toFixed(1).replace('.', ',');
        pesoInput.style.backgroundColor = '';
        pesoInput.style.cursor = 'text';
        pesoInput.style.color = '#1b5e20';
      }
      
      // 10. Aguardar um pouco
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // 11. Gravar pesagem
      if (typeof window.gravarPesagemApartacao === 'function') {
        await window.gravarPesagemApartacao();
      }
      
      // 12. Aguardar notifica√ß√£o desaparecer (2,5 segundos)
      await new Promise(resolve => setTimeout(resolve, 2600));
      
      // 13. Incrementar contador
      this.contador++;
      
      // 14. Atualizar progresso
      this.atualizarProgresso();
      
      // 15. Adicionar √† tabela
      // Garantir que dadosAnimal tenha todos os campos necess√°rios
      const dadosParaTabela = {
        id: dadosAnimal.id || Math.floor(Date.now() + Math.random() * 1000),
        codigo_eletronico: dadosAnimal.codigo_eletronico || '',
        codigo_sisbov: dadosAnimal.codigo_sisbov || dadosAnimal.numero_brinco || '',
        numero_brinco: dadosAnimal.numero_brinco || dadosAnimal.codigo_sisbov || '',
        numero_manejo: dadosAnimal.numero_manejo || '',
        raca: dadosAnimal.raca || '‚Äî',
        sexo: dadosAnimal.sexo || 'M',
        data_nascimento: dadosAnimal.data_nascimento || dadosAnimal.data_nascimento_format || '‚Äî',
        data_nascimento_format: dadosAnimal.data_nascimento_format || '‚Äî',
        categoria: dadosAnimal.categoria || '‚Äî',
        lote_atual: categoriaEncontrada || '‚Äî',
        situacao_bnd: dadosAnimal.situacao_bnd || 'Conforme',
        consta_bnd: dadosAnimal.consta_bnd !== undefined ? dadosAnimal.consta_bnd : true,
        idade_meses: dadosAnimal.idade_meses || null
      };
      
      if (typeof window.adicionarAnimalTabelaRegistrados === 'function') {
        console.log('üìã [SIMULADOR] Adicionando animal √† tabela:', dadosParaTabela);
        window.adicionarAnimalTabelaRegistrados(dadosParaTabela);
      } else {
        console.error('‚ùå [SIMULADOR] Fun√ß√£o adicionarAnimalTabelaRegistrados n√£o encontrada!');
      }
      
      console.log(`‚úÖ [SIMULADOR] Animal ${this.contador}/${this.animais.length} processado`);
    },
    
    // Iniciar simula√ß√£o
    iniciar: async function(quantidadeAnimais) {
      if (this.ativo) {
        console.warn('‚ö†Ô∏è Simulador j√° est√° ativo');
        return;
      }
      
      console.log('üöÄ [SIMULADOR] Iniciando simula√ß√£o com', quantidadeAnimais, 'animais machos');
      
      // Verificar se pesagem de aparta√ß√£o est√° configurada
      const config = window.configPesagemSalva;
      if (!config || config.tipoPesagem !== 'aparte') {
        alert('Configure a pesagem para "Pesagem para Aparta√ß√£o" primeiro!');
        return;
      }
      
      // Gerar animais
      this.animais = [];
      for (let i = 0; i < quantidadeAnimais; i++) {
        this.animais.push(this.gerarAnimal());
      }
      
      this.contador = 0;
      this.tempoInicio = Date.now();
      this.ativo = true;
      
      // Atualizar progresso inicial
      this.atualizarProgresso();
      
      // Processar animais um por um
      for (let i = 0; i < this.animais.length && this.ativo; i++) {
        await this.processarAnimal(this.animais[i]);
        
        // Aguardar entre animais (1-2 segundos)
        if (i < this.animais.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
        }
      }
      
      // Finalizar
      this.ativo = false;
      console.log('‚úÖ [SIMULADOR] Simula√ß√£o conclu√≠da!');
      alert(`Simula√ß√£o conclu√≠da! ${this.contador} animais processados.`);
    },
    
    // Parar simula√ß√£o
    parar: function() {
      this.ativo = false;
      if (this.intervalo) {
        clearInterval(this.intervalo);
        this.intervalo = null;
      }
      console.log('‚èπÔ∏è [SIMULADOR] Simula√ß√£o parada');
    }
  };
  
  // Fun√ß√£o global para iniciar simulador
  window.iniciarSimuladorApartacao = function(quantidadeAnimais) {
    if (typeof window.simuladorApartacao === 'object' && window.simuladorApartacao.iniciar) {
      window.simuladorApartacao.iniciar(quantidadeAnimais);
    } else {
      alert('Erro: Simulador n√£o dispon√≠vel. Recarregue a p√°gina.');
    }
  };
  
  // Fun√ß√£o para atualizar card de status do animal
  window.atualizarCardStatusAnimal = function(categoria, peso, brinco) {
    const cardStatus = document.getElementById('cardStatusAnimalApartacao');
    const statusTexto = document.getElementById('statusAnimalTexto');
    const statusDetalhes = document.getElementById('statusAnimalDetalhes');
    
    if (!cardStatus || !statusTexto || !statusDetalhes) {
      return;
    }
    
    // Definir cores baseadas na categoria
    const coresCategoria = {
      'BOIADA': { bg: 'linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(69, 160, 73, 0.95) 100%)', border: 'rgba(76, 175, 80, 1)' },
      'CABECEIRA': { bg: 'linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(25, 118, 210, 0.95) 100%)', border: 'rgba(33, 150, 243, 1)' },
      'MEIO': { bg: 'linear-gradient(135deg, rgba(255, 152, 0, 0.95) 0%, rgba(255, 143, 0, 0.95) 100%)', border: 'rgba(255, 152, 0, 1)' },
      'FUNDO': { bg: 'linear-gradient(135deg, rgba(244, 67, 54, 0.95) 0%, rgba(229, 57, 53, 0.95) 100%)', border: 'rgba(244, 67, 54, 1)' }
    };
    
    const cor = coresCategoria[categoria] || coresCategoria['BOIADA'];
    
    // Atualizar card
    cardStatus.style.display = 'block';
    cardStatus.style.background = cor.bg;
    cardStatus.style.border = `3px solid ${cor.border}`;
    
    statusTexto.textContent = `Lote: ${categoria}`;
    statusTexto.style.color = '#fff';
    
    statusDetalhes.innerHTML = `
      <div style="margin-top: 8px;">
        <span style="font-size: 1rem; opacity: 0.9;">Brinco: ${brinco || 'N/A'}</span>
        <span style="margin: 0 12px;">‚Ä¢</span>
        <span style="font-size: 1rem; opacity: 0.9;">Peso: ${peso.toFixed(1).replace('.', ',')} kg</span>
      </div>
    `;
    statusDetalhes.style.color = '#fff';
  };

  // Fun√ß√£o para gravar pesagem de aparta√ß√£o
  window.gravarPesagemApartacao = async function() {
    console.log('üîò [GRAVAR APARTA√á√ÉO] Fun√ß√£o chamada');
    
    // Verificar se h√° animal identificado
    if (!window.animalAtualV2 || !window.animalAtualV2.id) {
      alert('Identifique um animal primeiro.');
      return;
    }
    
    // Capturar peso do campo de aparta√ß√£o
    const pesoInput = document.getElementById('pesoValorApartacaoV2');
    if (!pesoInput) {
      alert('Erro: Campo de peso n√£o encontrado.');
      return;
    }
    
    let pesoTexto = pesoInput.value || pesoInput.textContent || '';
    pesoTexto = pesoTexto.toString().trim().replace(/kg/gi, '').replace(/\s/g, '').replace(',', '.');
    const peso = parseFloat(pesoTexto);
    
    if (!peso || peso <= 0 || isNaN(peso)) {
      alert('Informe um peso v√°lido.');
      pesoInput.focus();
      return;
    }
    
    console.log('üìä [GRAVAR APARTA√á√ÉO] Peso capturado:', peso);
    
    // Verificar se h√° faixas de peso configuradas
    const config = window.configPesagemSalva || {};
    const faixasPeso = config.faixasPeso;
    
    if (!faixasPeso) {
      alert('Configure as faixas de peso primeiro no modal de configura√ß√£o.');
      return;
    }
    
    // Determinar em qual categoria o animal se encaixa
    let categoriaEncontrada = null;
    
    // Verificar cada categoria (ordem: BOIADA, CABECEIRA, MEIO, FUNDO)
    const categorias = [
      { nome: 'BOIADA', faixa: faixasPeso.boiada },
      { nome: 'CABECEIRA', faixa: faixasPeso.cabeceira },
      { nome: 'MEIO', faixa: faixasPeso.meio },
      { nome: 'FUNDO', faixa: faixasPeso.fundo }
    ];
    
    for (let i = 0; i < categorias.length; i++) {
      const categoria = categorias[i];
      const faixa = categoria.faixa;
      
      if (faixa && faixa.min !== null && faixa.max !== null) {
        const min = parseFloat(faixa.min);
        const max = parseFloat(faixa.max);
        
        if (peso >= min && peso <= max) {
          categoriaEncontrada = categoria.nome;
          console.log(`‚úÖ [GRAVAR APARTA√á√ÉO] Animal classificado em ${categoriaEncontrada} (peso: ${peso} kg, faixa: ${min}-${max} kg)`);
          break;
        }
      } else if (faixa && faixa.min !== null) {
        // Se s√≥ tem m√≠nimo, verifica se o peso √© maior ou igual
        const min = parseFloat(faixa.min);
        if (peso >= min) {
          categoriaEncontrada = categoria.nome;
          console.log(`‚úÖ [GRAVAR APARTA√á√ÉO] Animal classificado em ${categoriaEncontrada} (peso: ${peso} kg, m√≠nimo: ${min} kg)`);
          break;
        }
      } else if (faixa && faixa.max !== null) {
        // Se s√≥ tem m√°ximo, verifica se o peso √© menor ou igual
        const max = parseFloat(faixa.max);
        if (peso <= max) {
          categoriaEncontrada = categoria.nome;
          console.log(`‚úÖ [GRAVAR APARTA√á√ÉO] Animal classificado em ${categoriaEncontrada} (peso: ${peso} kg, m√°ximo: ${max} kg)`);
          break;
        }
      }
    }
    
    if (!categoriaEncontrada) {
      alert(`Peso ${peso} kg n√£o se encaixa em nenhuma faixa configurada. Verifique as configura√ß√µes.`);
      return;
    }
    
    // Inicializar estrutura de dados dos lotes se n√£o existir
    if (!window.pesagensLotes) {
      window.pesagensLotes = {
        CABECEIRA: [],
        MEIO: [],
        FUNDO: [],
        BOIADA: []
      };
    }
    
    // Adicionar pesagem ao lote correspondente
    const pesagem = {
      animal_id: window.animalAtualV2.id,
      brinco: window.animalAtualV2.numero_brinco || window.animalAtualV2.numero_manejo || '',
      peso: peso,
      data: new Date().toISOString(),
      categoria: categoriaEncontrada
    };
    
    window.pesagensLotes[categoriaEncontrada].push(pesagem);
    
    console.log('‚úÖ [GRAVAR APARTA√á√ÉO] Pesagem adicionada ao lote:', pesagem);
    console.log('üìä [GRAVAR APARTA√á√ÉO] Estado atual de pesagensLotes:', window.pesagensLotes);
    console.log(`üìä [GRAVAR APARTA√á√ÉO] Lote ${categoriaEncontrada} agora tem ${window.pesagensLotes[categoriaEncontrada].length} animais`);
    
    // Atualizar estat√≠sticas dos lotes (com pequeno delay para garantir que o DOM esteja pronto)
    setTimeout(function() {
      if (typeof window.atualizarEstatisticasLotes === 'function') {
        console.log('üîÑ [GRAVAR APARTA√á√ÉO] Chamando atualizarEstatisticasLotes...');
        window.atualizarEstatisticasLotes();
      } else {
        console.error('‚ùå [GRAVAR APARTA√á√ÉO] Fun√ß√£o atualizarEstatisticasLotes n√£o encontrada!');
      }
    }, 100);
    
    // Mostrar notifica√ß√£o moderna no centro da p√°gina
    const mensagem = `Animal adicionado ao lote ${categoriaEncontrada}!`;
    if (typeof window.mostrarNotificacaoApartacao === 'function') {
      window.mostrarNotificacaoApartacao(mensagem, categoriaEncontrada, peso);
    }
    
    // Atualizar card de status do animal
    const brinco = window.animalAtualV2.numero_brinco || window.animalAtualV2.numero_manejo || '';
    if (typeof window.atualizarCardStatusAnimal === 'function') {
      window.atualizarCardStatusAnimal(categoriaEncontrada, peso, brinco);
    }
    
    // Atualizar campos de peso na se√ß√£o de aparta√ß√£o
    if (window.animalAtualV2) {
      // Atualizar dados do animal com o novo peso
      const hojeISO = new Date().toISOString().slice(0, 10);
      window.animalAtualV2.peso_anterior = window.animalAtualV2.peso_atual || null;
      window.animalAtualV2.data_peso_anterior = window.animalAtualV2.data_peso_atual || null;
      window.animalAtualV2.peso_atual = peso;
      window.animalAtualV2.data_peso_atual = hojeISO;
      
      if (typeof window.atualizarCamposPesoApartacao === 'function') {
        window.atualizarCamposPesoApartacao(window.animalAtualV2, peso);
      }
    }
    
    console.log('‚úÖ [GRAVAR APARTA√á√ÉO]', mensagem);
    
    // Bloquear campo de peso e mostrar valor gravado
    if (pesoInput) {
      pesoInput.disabled = true;
      pesoInput.style.backgroundColor = 'rgba(255,255,255,0.25)';
      pesoInput.style.cursor = 'not-allowed';
      pesoInput.style.color = '#fff';
      pesoInput.style.fontWeight = '700';
      // Manter o valor gravado vis√≠vel
      const pesoFormatado = peso.toFixed(1).replace('.', ',');
      pesoInput.value = pesoFormatado;
    }
    
    // Mudar bot√£o de "Gravar" para "Editar"
    const gravarBtn = document.getElementById('pesoGravarBtnApartacaoV2');
    if (gravarBtn) {
      gravarBtn.innerHTML = '<i class="fas fa-edit"></i> <span>Editar</span>';
      gravarBtn.onclick = function() {
        if (typeof window.editarPesagemApartacao === 'function') {
          window.editarPesagemApartacao();
        }
      };
      gravarBtn.style.background = 'linear-gradient(135deg, rgba(255, 152, 0, 0.8) 0%, rgba(255, 143, 0, 0.9) 100%)';
      gravarBtn.style.cursor = 'pointer';
      gravarBtn.disabled = false;
      gravarBtn.style.opacity = '1';
    }
    
    // Se auto-pr√≥ximo estiver ativado, limpar identifica√ß√£o para pr√≥ximo animal
    if (config.autoProximo) {
      const brincoInput = document.getElementById('brincoInputV2');
      if (brincoInput) {
        brincoInput.value = '';
        brincoInput.focus();
      }
      window.animalAtualV2 = null;
      // Se auto-pr√≥ximo, desbloquear campo para pr√≥ximo animal
      if (pesoInput) {
        pesoInput.disabled = false;
        pesoInput.value = '';
        pesoInput.style.backgroundColor = '';
        pesoInput.style.cursor = 'text';
        pesoInput.focus();
      }
      // Voltar bot√£o para Gravar
      if (gravarBtn) {
        gravarBtn.innerHTML = '<i class="fas fa-save"></i> <span>Gravar</span>';
        gravarBtn.onclick = function() {
          if (typeof window.gravarPesagemApartacao === 'function') {
            window.gravarPesagemApartacao();
          }
        };
        gravarBtn.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%)';
      }
    }
  };
  
  // Fun√ß√£o para limpar campo de peso de aparta√ß√£o
  window.limparCampoPesoApartacao = function() {
    const pesoInput = document.getElementById('pesoValorApartacaoV2');
    const gravarBtn = document.getElementById('pesoGravarBtnApartacaoV2');
    
    if (pesoInput) {
      pesoInput.disabled = false;
      pesoInput.value = '';
      pesoInput.style.backgroundColor = '';
      pesoInput.style.cursor = 'text';
      pesoInput.style.color = '#1b5e20';
      pesoInput.focus();
    }
    
    if (gravarBtn) {
      gravarBtn.innerHTML = '<i class="fas fa-save"></i> <span>Gravar</span>';
      gravarBtn.onclick = function() {
        if (typeof window.gravarPesagemApartacao === 'function') {
          window.gravarPesagemApartacao();
        }
      };
      gravarBtn.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%)';
      gravarBtn.style.cursor = 'pointer';
      gravarBtn.disabled = false;
      gravarBtn.style.opacity = '1';
    }
  };
  
  // Fun√ß√£o para editar peso gravado
  window.editarPesagemApartacao = function() {
    console.log('‚úèÔ∏è [EDITAR APARTA√á√ÉO] Habilitando edi√ß√£o do peso...');
    
    const pesoInput = document.getElementById('pesoValorApartacaoV2');
    const gravarBtn = document.getElementById('pesoGravarBtnApartacaoV2');
    
    if (pesoInput) {
      // Desbloquear campo
      pesoInput.disabled = false;
      pesoInput.style.backgroundColor = '';
      pesoInput.style.cursor = 'text';
      pesoInput.style.color = '#1b5e20';
      pesoInput.focus();
      // Selecionar todo o texto para facilitar edi√ß√£o
      pesoInput.select();
    }
    
    if (gravarBtn) {
      // Voltar bot√£o para "Gravar"
      gravarBtn.innerHTML = '<i class="fas fa-save"></i> <span>Gravar</span>';
      gravarBtn.onclick = function() {
        if (typeof window.gravarPesagemApartacao === 'function') {
          window.gravarPesagemApartacao();
        }
      };
      gravarBtn.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(69, 160, 73, 0.9) 100%)';
      gravarBtn.style.cursor = 'pointer';
      gravarBtn.disabled = false;
      gravarBtn.style.opacity = '1';
    }
  };

window.confirmarConfigPesagem = function() {
  console.log('üîµ [CONFIRMAR CONFIG] Iniciando confirma√ß√£o...');
  
  const tipoPesagem = document.querySelector('input[name="tipoPesagemModal"]:checked')?.value || 'rotina';
  const autoProximo = document.getElementById('autoProximoModal')?.checked || false;
  
  console.log('üîµ [CONFIRMAR CONFIG] Valores capturados:', { tipoPesagem, autoProximo });
  
  // Capturar faixas de peso se for pesagem para aparta√ß√£o
  let faixasPeso = null;
  if (tipoPesagem === 'aparte') {
    faixasPeso = {
      cabeceira: {
        min: parseFloat(document.getElementById('faixaCabeceiraMin')?.value) || null,
        max: parseFloat(document.getElementById('faixaCabeceiraMax')?.value) || null
      },
      meio: {
        min: parseFloat(document.getElementById('faixaMeioMin')?.value) || null,
        max: parseFloat(document.getElementById('faixaMeioMax')?.value) || null
      },
      fundo: {
        min: parseFloat(document.getElementById('faixaFundoMin')?.value) || null,
        max: parseFloat(document.getElementById('faixaFundoMax')?.value) || null
      },
      boiada: {
        min: parseFloat(document.getElementById('faixaBoiadaMin')?.value) || null,
        max: parseFloat(document.getElementById('faixaBoiadaMax')?.value) || null
      }
    };
    console.log('üîµ [CONFIRMAR CONFIG] Faixas de peso capturadas:', faixasPeso);
  }
  
  // Salvar configura√ß√£o
  window.configPesagemSalva = {
    tipoPesagem: tipoPesagem,
    autoProximo: autoProximo,
    faixasPeso: faixasPeso,
    dataConfiguracao: new Date().toISOString()
  };
  
  // Salvar no localStorage para persist√™ncia
  try {
    localStorage.setItem('monpecConfigPesagemSalva', JSON.stringify(window.configPesagemSalva));
    console.log('‚úÖ [CONFIRMAR CONFIG] Configura√ß√£o salva no localStorage');
  } catch (e) {
    console.warn('‚ö†Ô∏è Erro ao salvar configura√ß√£o no localStorage:', e);
  }
  
  // Esconder card original
  const cardOriginal = document.getElementById('cardConfigPesagem');
  if (cardOriginal) {
    cardOriginal.style.display = 'none';
    console.log('‚úÖ [CONFIRMAR CONFIG] Card original escondido');
  } else {
    console.error('‚ùå [CONFIRMAR CONFIG] Card original n√£o encontrado!');
  }
  
  // Atualizar e mostrar card de resumo
  const cardResumo = document.getElementById('cardResumoConfigPesagem');
  if (!cardResumo) {
    console.error('‚ùå [CONFIRMAR CONFIG] Card de resumo n√£o encontrado!');
  } else {
    console.log('‚úÖ [CONFIRMAR CONFIG] Card de resumo encontrado');
  }
  
  // Atualizar card de resumo
  if (typeof window.atualizarCardResumoConfig === 'function') {
    console.log('‚úÖ [CONFIRMAR CONFIG] Chamando atualizarCardResumoConfig...');
    window.atualizarCardResumoConfig();
    
    // Garantir que o card est√° vis√≠vel ap√≥s atualizar
    setTimeout(function() {
      const cardResumoCheck = document.getElementById('cardResumoConfigPesagem');
      if (cardResumoCheck) {
        cardResumoCheck.style.display = 'block';
        console.log('‚úÖ [CONFIRMAR CONFIG] Card de resumo for√ßado a aparecer');
      }
    }, 100);
  } else {
    console.error('‚ùå [CONFIRMAR CONFIG] Fun√ß√£o atualizarCardResumoConfig n√£o encontrada!');
  }
  
  // Fechar modal
  window.fecharModalConfigPesagem();
  
  // Atualizar visualiza√ß√£o da balan√ßa
  if (typeof window.atualizarVisualizacaoBalanca === 'function') {
    window.atualizarVisualizacaoBalanca();
  }
  
  console.log('‚úÖ [CONFIRMAR CONFIG] Configura√ß√£o de pesagem salva:', window.configPesagemSalva);
};

console.log('‚úÖ Fun√ß√µes do modal de configura√ß√£o definidas globalmente');

/**
 * SISTEMA DE SIMULA√á√ÉO PROFISSIONAL
 * Sistema completo e funcional para simula√ß√£o de processamento de animais
 * Criado do zero com arquitetura limpa e profissional
 */
(function() {
  'use strict';

  // ========== CONFIGURA√á√ÉO E ESTADO ==========
  const Simulacao = {
    ativa: false,
    intervalo: null,
    contador: 0,
    total: 139,
    velocidade: {
      digitacao: { min: 80, max: 120 },
      processamento: { min: 4000, max: 6000 },
      busca: { min: 300, max: 500 },
      gravar: { min: 1500, max: 2000 }
    }
  };

  // ========== GERADORES DE DADOS REALISTAS ==========
  const Geradores = {
    sisbov: function() {
      const prefixo = 'BR';
      const numeros = Array.from({ length: 13 }, () => Math.floor(Math.random() * 10)).join('');
      return prefixo + numeros;
    },
    peso: function() {
      const peso = (Math.random() * 300 + 150).toFixed(1);
      return peso.replace('.', ',');
    },
    raca: function() {
      const racas = ['Nelore', 'Angus', 'Brahman', 'Hereford', 'Brangus', 'Canchim', 'Tabapu√£'];
      return racas[Math.floor(Math.random() * racas.length)];
    },
    sexo: function() {
      return Math.random() < 0.5 ? 'M' : 'F';
    },
    idadeMeses: function() {
      return Math.floor(Math.random() * 54) + 6;
    },
    dataNascimento: function(idadeMeses) {
      const data = new Date();
      data.setMonth(data.getMonth() - idadeMeses);
      return data.toISOString().split('T')[0];
    }
  };

  // ========== UTILIT√ÅRIOS ==========
  const Utils = {
    simularDigitacao: async function(elemento, texto, velocidade = 50) {
      if (!elemento) return;
      elemento.focus();
      elemento.value = '';
      for (let i = 0; i < texto.length; i++) {
        elemento.value += texto[i];
        elemento.dispatchEvent(new Event('input', { bubbles: true }));
        await new Promise(resolve => setTimeout(resolve, velocidade));
      }
      elemento.dispatchEvent(new Event('change', { bubbles: true }));
    },
    calcularIdadeMeses: function(dataNascimento) {
      try {
        const dataNasc = new Date(dataNascimento);
        const hoje = new Date();
        const diffTime = hoje - dataNasc;
        return Math.floor(diffTime / (1000 * 60 * 60 * 24 * 30.44));
      } catch (error) {
        return 0;
      }
    },
    aguardar: function(min, max) {
      const tempo = min + Math.random() * (max - min);
      return new Promise(resolve => setTimeout(resolve, tempo));
    }
  };

  // ========== SISTEMA DE LOGS ==========
  const Logs = {
    adicionar: function(mensagem, tipo = 'info') {
      const conteudo = document.getElementById('simulacaoLogsConteudo');
      if (!conteudo) {
        console.log(`[${tipo.toUpperCase()}]`, mensagem);
        return;
      }
      const agora = new Date();
      const hora = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const logItem = document.createElement('div');
      logItem.className = `simulacao-log ${tipo}`;
      logItem.innerHTML = `<span class="simulacao-log-time">${hora}</span><span class="simulacao-log-message">${mensagem}</span>`;
      conteudo.appendChild(logItem);
      conteudo.scrollTop = conteudo.scrollHeight;
      const logs = conteudo.querySelectorAll('.simulacao-log');
      if (logs.length > 100) logs[0].remove();
      console.log(`[SIMULA√á√ÉO ${tipo.toUpperCase()}]`, mensagem);
    },
    limpar: function() {
      const conteudo = document.getElementById('simulacaoLogsConteudo');
      if (conteudo) {
        conteudo.innerHTML = '<div class="simulacao-log info"><span class="simulacao-log-time"></span><span class="simulacao-log-message">Logs limpos</span></div>';
      }
    }
  };

  // ========== CONTROLE DO PAINEL ==========
  const Painel = {
    mostrar: function() {
      const painel = document.getElementById('simulacaoPainel');
      if (painel) {
        painel.classList.add('ativo');
        Logs.adicionar('‚úÖ Painel de logs ativado', 'success');
      }
    },
    minimizar: function() {
      const painel = document.getElementById('simulacaoPainel');
      if (painel) painel.classList.toggle('minimizado');
    }
  };

  // ========== PROCESSAMENTO DE ANIMAL ==========
  const Processador = {
    processarAnimal: async function() {
      if (!Simulacao.ativa) return;
      try {
        Simulacao.contador++;
        Logs.adicionar(`üîÑ Processando animal ${Simulacao.contador}/${Simulacao.total}...`, 'info');
        const sisbov = Geradores.sisbov();
        const brinco = sisbov.substring(8, 14);
        const peso = Geradores.peso();
        const pesoFormatado = peso.replace('.', ',');
        const raca = Geradores.raca();
        const sexo = Geradores.sexo();
        const idadeMeses = Geradores.idadeMeses();
        const dataNasc = Geradores.dataNascimento(idadeMeses);
        Logs.adicionar(`üìñ Lendo brinco: ${brinco} (SISBOV: ${sisbov})`, 'info');
        const inputBrinco = document.getElementById('brincoInputV2');
        if (!inputBrinco) throw new Error('Campo de brinco n√£o encontrado');
        const velocidadeDigitacao = Simulacao.velocidade.digitacao.min + Math.random() * (Simulacao.velocidade.digitacao.max - Simulacao.velocidade.digitacao.min);
        await Utils.simularDigitacao(inputBrinco, sisbov, velocidadeDigitacao);
        Logs.adicionar(`‚å®Ô∏è Digitando brinco: ${sisbov}...`, 'info');
        await Utils.aguardar(Simulacao.velocidade.busca.min, Simulacao.velocidade.busca.max);
        const btnBuscar = document.getElementById('btnBuscarBrinco');
        if (btnBuscar) {
          btnBuscar.click();
          Logs.adicionar(`üîç Buscando animal...`, 'info');
        } else {
          inputBrinco.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', keyCode: 13, bubbles: true }));
        }
        await Utils.aguardar(1500, 2000);
        const estaNoEstoque = Math.random() < 0.3;
        const animalId = estaNoEstoque ? null : Math.floor(Math.random() * 10000) + 1;
        const dadosAnimal = {
          id: animalId,
          numero_brinco: brinco,
          codigo_sisbov: sisbov,
          raca: raca,
          sexo: sexo,
          data_nascimento: dataNasc,
          peso_atual: null
        };
        if (typeof window.processarAnimalIdentificado === 'function') {
          window.processarAnimalIdentificado(dadosAnimal);
          Logs.adicionar(animalId ? '‚úÖ Animal identificado (j√° cadastrado)' : '‚úÖ Animal identificado (novo)', 'success');
        }
        if (typeof window.tocarAvisoSonoro === 'function') {
          window.tocarAvisoSonoro('identificacao');
        }
        await Utils.aguardar(500, 800);
        const inputPeso = document.getElementById('pesoValorV2');
        if (!inputPeso) throw new Error('Campo de peso n√£o encontrado');
        const velocidadePeso = Simulacao.velocidade.digitacao.min + Math.random() * (Simulacao.velocidade.digitacao.max - Simulacao.velocidade.digitacao.min);
        await Utils.simularDigitacao(inputPeso, pesoFormatado, velocidadePeso);
        Logs.adicionar(`‚öñÔ∏è Digitando peso: ${pesoFormatado} kg`, 'info');
        await Utils.aguardar(300, 500);
        const btnGravar = document.getElementById('pesoGravarBtnV2');
        if (!btnGravar) throw new Error('Bot√£o Gravar n√£o encontrado');
        if (btnGravar.disabled) {
          Logs.adicionar('‚ö†Ô∏è Bot√£o Gravar est√° desabilitado', 'warning');
          return;
        }
        btnGravar.click();
        Logs.adicionar(`üíæ Gravando pesagem...`, 'info');
        await Utils.aguardar(Simulacao.velocidade.gravar.min, Simulacao.velocidade.gravar.max);
        if (typeof window.tocarAvisoSonoro === 'function') {
          window.tocarAvisoSonoro('peso');
        }
        if (sexo === 'F' && idadeMeses >= 18) {
          Logs.adicionar(`üî¨ F√™mea em reprodu√ß√£o (${idadeMeses} meses) - abrindo diagn√≥stico...`, 'info');
          await Utils.aguardar(500, 800);
          if (typeof window.abrirDiagnosticoV2 === 'function') {
            window.abrirDiagnosticoV2();
          }
          await Utils.aguardar(300, 500);
          const diagnosticos = ['PRENHA', 'VAZIA'];
          const diagnosticoAleatorio = diagnosticos[Math.floor(Math.random() * diagnosticos.length)];
          if (typeof window.selecionarDiagnosticoV2 === 'function') {
            window.selecionarDiagnosticoV2(diagnosticoAleatorio);
          }
          Logs.adicionar(`üé≤ Diagn√≥stico selecionado: ${diagnosticoAleatorio}`, 'info');
          await Utils.aguardar(400, 600);
          const diagnosticoOkBtn = document.getElementById('diagnosticoOkBtnV2');
          if (diagnosticoOkBtn) {
            diagnosticoOkBtn.click();
            Logs.adicionar(`‚úÖ Diagn√≥stico confirmado: ${diagnosticoAleatorio}`, 'success');
            await Utils.aguardar(800, 1200);
          }
        }
        if (typeof window.adicionarAnimalTrabalhado === 'function') {
          window.adicionarAnimalTrabalhado({
            sisbov: sisbov,
            brinco: brinco,
            peso: peso,
            tipo: 'pesagem',
            detalhes: `${raca} ${sexo === 'M' ? 'Macho' : 'F√™mea'} ¬∑ ${peso} kg`,
            data: new Date().toLocaleString('pt-BR')
          });
        }
        const autoProximo = document.getElementById('autoProximoV2');
        if (autoProximo && autoProximo.checked) {
          await Utils.aguardar(500, 700);
          if (inputBrinco) {
            inputBrinco.value = '';
            inputBrinco.focus();
          }
          if (inputPeso) {
            inputPeso.value = '';
          }
        }
        Logs.adicionar(`‚ú® Animal ${brinco} processado completamente (${pesoFormatado} kg)`, 'success');
      } catch (error) {
        Logs.adicionar(`‚ùå Erro ao processar animal: ${error.message}`, 'error');
        console.error('[SIMULA√á√ÉO] Erro:', error);
      }
    }
  };

  // ========== CONTROLE PRINCIPAL ==========
  const Controle = {
    iniciar: function() {
      if (Simulacao.ativa) {
        Controle.parar();
        return;
      }
      Simulacao.ativa = true;
      Simulacao.contador = 0;
      const btn = document.getElementById('btnSimulacao');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-pause"></i> Parar Simula√ß√£o (0/' + Simulacao.total + ')';
        btn.classList.add('ativo');
      }
      Painel.mostrar();
      Logs.adicionar(`üöÄ Simula√ß√£o iniciada - Processando ${Simulacao.total} registros...`, 'info');
      const statusSistema = window.verificarStatusSistema ? window.verificarStatusSistema() : { online: navigator.onLine !== false };
      const statusConexao = statusSistema.online ? 'Online' : 'Offline';
      Logs.adicionar(`üì° Status do sistema: ${statusConexao}`, statusConexao === 'Online' ? 'success' : 'warning');
      setTimeout(() => {
        if (Simulacao.ativa) {
          Processador.processarAnimal();
        }
      }, 1000 + Math.random() * 500);
      Simulacao.intervalo = setInterval(() => {
        if (!Simulacao.ativa) {
          clearInterval(Simulacao.intervalo);
          Simulacao.intervalo = null;
          return;
        }
        if (Simulacao.contador >= Simulacao.total) {
          Controle.finalizar();
          return;
        }
        Processador.processarAnimal();
      }, Simulacao.velocidade.processamento.min + Math.random() * (Simulacao.velocidade.processamento.max - Simulacao.velocidade.processamento.min));
      if (typeof mostrarToast === 'function') {
        mostrarToast(`Simula√ß√£o iniciada! Processando ${Simulacao.total} registros...`, 'success');
      }
    },
    parar: function() {
      Simulacao.ativa = false;
      if (Simulacao.intervalo) {
        clearInterval(Simulacao.intervalo);
        Simulacao.intervalo = null;
      }
      const btn = document.getElementById('btnSimulacao');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Simula√ß√£o';
        btn.classList.remove('ativo');
      }
      Logs.adicionar(`üõë Simula√ß√£o parada (${Simulacao.contador}/${Simulacao.total} processados)`, 'warning');
      if (typeof mostrarToast === 'function') {
        mostrarToast(`Simula√ß√£o parada (${Simulacao.contador}/${Simulacao.total} processados)`, 'info');
      }
    },
    finalizar: function() {
      Simulacao.ativa = false;
      if (Simulacao.intervalo) {
        clearInterval(Simulacao.intervalo);
        Simulacao.intervalo = null;
      }
      const btn = document.getElementById('btnSimulacao');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Simula√ß√£o';
        btn.classList.remove('ativo');
      }
      Logs.adicionar(`üéâ Simula√ß√£o conclu√≠da! ${Simulacao.contador} registros processados.`, 'success');
      if (typeof mostrarToast === 'function') {
        mostrarToast(`‚úÖ Simula√ß√£o conclu√≠da! ${Simulacao.contador} registros processados.`, 'success');
      }
    }
  };

  // ========== EXPORTA√á√ÉO GLOBAL ==========
  window.SimulacaoSistema = {
    iniciar: Controle.iniciar,
    parar: Controle.parar,
    finalizar: Controle.finalizar,
    logs: Logs,
    painel: Painel,
    config: Simulacao
  };

  // Compatibilidade com c√≥digo antigo
  window.iniciarSimulacao = Controle.iniciar;
  window.simularProcessamentoAnimal = Processador.processarAnimal;
  window.adicionarLogSimulacao = Logs.adicionar;
  window.limparLogsSimulacao = Logs.limpar;
  window.mostrarPainelLogs = Painel.mostrar;
  window.togglePainelLogs = Painel.minimizar;

  // ========== GARANTIR QUE MENU LATERAL SEJA ESCONDIDO ==========
  // Executar imediatamente e tamb√©m no DOMContentLoaded
  (function() {
    function esconderMenuLateral() {
      // Esconder sidebar
      const sidebars = document.querySelectorAll('nav.sidebar, .sidebar, .sidebar-nav, .sidebar-header, .sidebar-overlay, .btn-menu-mobile, .sidebar-mobile-actions');
      sidebars.forEach(function(el) {
        if (el) {
          el.style.display = 'none';
          el.style.visibility = 'hidden';
          el.style.opacity = '0';
          el.style.width = '0';
          el.style.height = '0';
          el.style.overflow = 'hidden';
        }
      });
      
      // Ajustar main-content
      const mainContents = document.querySelectorAll('main.main-content, .main-content, .content-wrapper, .content-area');
      mainContents.forEach(function(el) {
        if (el) {
          el.style.marginLeft = '0';
          el.style.paddingLeft = '0';
          el.style.width = '100%';
          el.style.maxWidth = '100%';
        }
      });
      
      // Ajustar header
      const headers = document.querySelectorAll('.header-fixo');
      headers.forEach(function(el) {
        if (el) {
          el.style.left = '0';
          el.style.right = '0';
          el.style.width = '100%';
          el.style.maxWidth = '100%';
        }
      });
    }
    
    // Executar imediatamente
    esconderMenuLateral();
    
    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', esconderMenuLateral);
    } else {
      esconderMenuLateral();
    }
    
    // Executar tamb√©m ap√≥s um pequeno delay para garantir
    setTimeout(esconderMenuLateral, 100);
  })();

  // ========== INICIALIZA√á√ÉO ==========
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('btnSimulacao');
    if (btn) {
      btn.style.display = 'flex';
      btn.style.visibility = 'visible';
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        Controle.iniciar();
      });
    }
    const btnLimpar = document.getElementById('btnLimparLogs');
    if (btnLimpar) {
      btnLimpar.addEventListener('click', Logs.limpar);
    }
    const btnMinimizar = document.getElementById('btnMinimizarPainel');
    if (btnMinimizar) {
      btnMinimizar.addEventListener('click', Painel.minimizar);
    }
    console.log('‚úÖ Sistema de simula√ß√£o profissional carregado');
  });

})();
</script>

<!-- Bot√£o de Simula√ß√£o Autom√°tica (fixo) -->
<button id="btnSimulacao" class="btn-simulacao" title="Clique para iniciar/parar simula√ß√£o autom√°tica do sistema">
  <i class="fas fa-play"></i> Iniciar Simula√ß√£o
</button>
<script>
// Garantir que o bot√£o esteja vis√≠vel e inicializar cards indicadores
document.addEventListener('DOMContentLoaded', function() {
  // ========== ESCONDER SIDEBAR FOR√áADAMENTE ==========
  // Garantir que o sidebar seja escondido mesmo que o CSS n√£o seja aplicado imediatamente
  function esconderSidebar() {
    const sidebars = document.querySelectorAll('.sidebar, nav.sidebar, .sidebar-nav, .sidebar-header, .sidebar-overlay, .btn-menu-mobile, .sidebar-mobile-actions');
    sidebars.forEach(sidebar => {
      sidebar.style.display = 'none';
      sidebar.style.visibility = 'hidden';
      sidebar.style.opacity = '0';
      sidebar.style.width = '0';
      sidebar.style.height = '0';
      sidebar.style.overflow = 'hidden';
    });
    
    // Ajustar main-content
    const mainContent = document.querySelector('.main-content, main, .content-wrapper');
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.paddingLeft = '0';
      mainContent.style.width = '100%';
      mainContent.style.maxWidth = '100%';
    }
  }
  
  // Executar imediatamente
  esconderSidebar();
  
  // Executar ap√≥s um pequeno delay para garantir
  setTimeout(esconderSidebar, 100);
  setTimeout(esconderSidebar, 500);
  
  // ========== MODAL DE CONFIGURA√á√ÉO DE PESAGEM ==========
  // Fun√ß√£o para atualizar visual dos radio buttons
  window.atualizarVisualRadioPesagem = function() {
    const rotinaRadio = document.getElementById('pesagemRotinaModal');
    const aparteRadio = document.getElementById('pesagemAparteModal');
    const rotinaLabel = document.getElementById('pesagemRotinaLabelModal');
    const aparteLabel = document.getElementById('pesagemAparteLabelModal');
    const faixasContainer = document.getElementById('configFaixasPesoContainer');
    
    if (rotinaRadio && aparteRadio && rotinaLabel && aparteLabel) {
      if (rotinaRadio.checked) {
        rotinaLabel.style.borderColor = '#1976d2';
        rotinaLabel.style.background = '#e3f2fd';
        aparteLabel.style.borderColor = '#e0e0e0';
        aparteLabel.style.background = '#f8f9fa';
        // Ocultar se√ß√£o de faixas de peso
        if (faixasContainer) {
          faixasContainer.style.display = 'none';
        }
      } else if (aparteRadio.checked) {
        aparteLabel.style.borderColor = '#1976d2';
        aparteLabel.style.background = '#e3f2fd';
        rotinaLabel.style.borderColor = '#e0e0e0';
        rotinaLabel.style.background = '#f8f9fa';
        // Mostrar se√ß√£o de faixas de peso
        if (faixasContainer) {
          faixasContainer.style.display = 'block';
        }
      }
    }
  };
  
  // Nota: As fun√ß√µes abrirModalConfigPesagem, fecharModalConfigPesagem, confirmarConfigPesagem
  // e atualizarCardResumoConfig j√° foram definidas no in√≠cio do script para garantir disponibilidade global
  
  // Fechar modal ao clicar fora dele
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('modalConfigPesagem');
    if (modal && event.target === modal) {
      fecharModalConfigPesagem();
    }
  });
  
  // Fechar modal com ESC
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      fecharModalConfigPesagem();
    }
  });
  
  // Garantir que o card de configura√ß√£o funcione
  function inicializarCardConfigPesagem() {
    const cardConfig = document.getElementById('cardConfigPesagem');
    if (cardConfig) {
      // Remover onclick antigo e adicionar event listener
      cardConfig.onclick = null;
      cardConfig.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîµ [PESAGEM] Card clicado via event listener');
        if (typeof window.abrirModalConfigPesagem === 'function') {
          window.abrirModalConfigPesagem();
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigPesagem n√£o est√° dispon√≠vel');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ Card de configura√ß√£o PESAGEM inicializado');
    }
    
    // Inicializar outros cards tamb√©m
    const cardSanitario = document.getElementById('cardConfigSanitarioOriginal');
    if (cardSanitario) {
      cardSanitario.onclick = null;
      cardSanitario.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üî¥ [SANIT√ÅRIO] Card clicado via event listener');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('sanitario');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o est√° dispon√≠vel');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ Card de configura√ß√£o SANIT√ÅRIO inicializado');
    }
    
    const cardReprodutivo = document.getElementById('cardConfigReprodutivoOriginal');
    if (cardReprodutivo) {
      cardReprodutivo.onclick = null;
      cardReprodutivo.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üü£ [REPRODU√á√ÉO] Card clicado via event listener');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('reprodutivo');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o est√° dispon√≠vel');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ Card de configura√ß√£o REPRODU√á√ÉO inicializado');
    }
    
    const cardMovimentacao = document.getElementById('cardConfigMovimentacaoOriginal');
    if (cardMovimentacao) {
      cardMovimentacao.onclick = null;
      cardMovimentacao.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üü† [MOVIMENTA√á√ÉO] Card clicado via event listener');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('movimentacao');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o est√° dispon√≠vel');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ Card de configura√ß√£o MOVIMENTA√á√ÉO inicializado');
    }
  }
  
  // Carregar configura√ß√£o salva do localStorage
  function carregarConfigPesagemSalva() {
    try {
      const saved = localStorage.getItem('monpecConfigPesagemSalva');
      if (saved) {
        window.configPesagemSalva = JSON.parse(saved);
        console.log('‚úÖ Configura√ß√£o de pesagem carregada do localStorage:', window.configPesagemSalva);
        
        // Atualizar visualiza√ß√£o da balan√ßa ap√≥s carregar configura√ß√£o
        setTimeout(function() {
          if (typeof window.atualizarVisualizacaoBalanca === 'function') {
            window.atualizarVisualizacaoBalanca();
          }
        }, 200);
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao carregar configura√ß√£o do localStorage:', e);
    }
  }
  
  // Configurar bot√£o do modal para garantir que a fun√ß√£o correta seja chamada
  function configurarBotaoModal() {
    const btnConfirmarModal = document.getElementById('confirmarConfigPesagemModal');
    if (btnConfirmarModal) {
      // Salvar refer√™ncia da fun√ß√£o do modal
      const funcaoModal = window.confirmarConfigPesagem;
      
      // Remover onclick antigo e adicionar event listener
      btnConfirmarModal.onclick = null;
      btnConfirmarModal.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîµ [BOT√ÉO MODAL] Bot√£o clicado, chamando fun√ß√£o do modal...');
        
        // Chamar fun√ß√£o do modal diretamente
        if (funcaoModal && typeof funcaoModal === 'function' && funcaoModal.toString().includes('tipoPesagemModal')) {
          funcaoModal();
        } else if (typeof window.confirmarConfigPesagem === 'function') {
          window.confirmarConfigPesagem();
        } else {
          console.error('‚ùå [BOT√ÉO MODAL] Fun√ß√£o n√£o encontrada!');
          alert('Erro: Fun√ß√£o de confirma√ß√£o n√£o encontrada. Recarregue a p√°gina.');
        }
      });
      console.log('‚úÖ [BOT√ÉO MODAL] Event listener adicionado diretamente ao bot√£o');
    } else {
      console.warn('‚ö†Ô∏è [BOT√ÉO MODAL] Bot√£o n√£o encontrado ainda, tentando novamente...');
      setTimeout(configurarBotaoModal, 500);
    }
  }
  
  // Inicializar card de resumo ao carregar a p√°gina
  function inicializarTudo() {
    carregarConfigPesagemSalva();
    inicializarCardConfigPesagem();
    configurarBotaoModal();
    setTimeout(function() {
      if (typeof window.atualizarCardResumoConfig === 'function') {
        window.atualizarCardResumoConfig();
      }
    }, 100);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarTudo);
  } else {
    inicializarTudo();
  }
  
  // Tamb√©m tentar inicializar ap√≥s um delay para garantir
  setTimeout(inicializarTudo, 1000);
  setTimeout(inicializarTudo, 2000);
  
  // Atualizar visual dos radio buttons quando selecionados
  document.addEventListener('change', function(event) {
    if (event.target.name === 'tipoPesagemModal') {
      if (typeof window.atualizarVisualRadioPesagem === 'function') {
        window.atualizarVisualRadioPesagem();
      }
    }
  });
  
  // Adicionar event listeners diretos aos radio buttons para mostrar/ocultar faixas
  function configurarEventListenersFaixasPeso() {
    const rotinaRadio = document.getElementById('pesagemRotinaModal');
    const aparteRadio = document.getElementById('pesagemAparteModal');
    const faixasContainer = document.getElementById('configFaixasPesoContainer');
    
    if (rotinaRadio) {
      rotinaRadio.addEventListener('change', function() {
        if (this.checked && faixasContainer) {
          faixasContainer.style.display = 'none';
        }
        if (typeof window.atualizarVisualRadioPesagem === 'function') {
          window.atualizarVisualRadioPesagem();
        }
      });
    }
    
    if (aparteRadio) {
      aparteRadio.addEventListener('change', function() {
        if (this.checked && faixasContainer) {
          faixasContainer.style.display = 'block';
        }
        if (typeof window.atualizarVisualRadioPesagem === 'function') {
          window.atualizarVisualRadioPesagem();
        }
      });
    }
    
    // Verificar estado inicial ao abrir o modal
    if (aparteRadio && aparteRadio.checked && faixasContainer) {
      faixasContainer.style.display = 'block';
    } else if (rotinaRadio && rotinaRadio.checked && faixasContainer) {
      faixasContainer.style.display = 'none';
    }
  }
  
  // Executar quando o DOM estiver pronto e tamb√©m quando o modal abrir
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(configurarEventListenersFaixasPeso, 500);
    });
  } else {
    setTimeout(configurarEventListenersFaixasPeso, 500);
  }
  
  // Tamb√©m configurar quando o modal for aberto
  const abrirModalOriginal = window.abrirModalConfigPesagem;
  if (abrirModalOriginal) {
    window.abrirModalConfigPesagem = function() {
      abrirModalOriginal();
      setTimeout(function() {
        configurarEventListenersFaixasPeso();
        if (typeof window.atualizarVisualRadioPesagem === 'function') {
          window.atualizarVisualRadioPesagem();
        }
      }, 100);
    };
  }
  
  // Garantir que a fun√ß√£o do modal seja preservada ap√≥s todas as inicializa√ß√µes
  // Salvar refer√™ncia da fun√ß√£o do modal antes de outras inicializa√ß√µes
  const confirmarConfigPesagemModalOriginal = (function() {
    const original = window.confirmarConfigPesagem;
    if (original && original.toString().includes('tipoPesagemModal')) {
      return original;
    }
    return null;
  })();
  
  // Restaurar fun√ß√£o do modal ap√≥s todas as inicializa√ß√µes
  function garantirFuncaoModal() {
    if (confirmarConfigPesagemModalOriginal) {
      window.confirmarConfigPesagem = confirmarConfigPesagemModalOriginal;
      console.log('‚úÖ [PROTE√á√ÉO] Fun√ß√£o do modal garantida');
    }
  }
  
  // Garantir ap√≥s carregamento completo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(garantirFuncaoModal, 2500);
    });
  } else {
    setTimeout(garantirFuncaoModal, 2500);
  }
  
  // Tamb√©m garantir quando a p√°gina estiver totalmente carregada
  window.addEventListener('load', function() {
    setTimeout(garantirFuncaoModal, 500);
  });
  
  // Fun√ß√£o abrirModalConfigSessao j√° est√° definida globalmente no in√≠cio do script
  // N√£o precisa redeclarar aqui
  
  // ========== TABS DE CONFIGURA√á√ÉO DA SESS√ÉO V4 (MANTIDO PARA COMPATIBILIDADE) ==========
  const configSessaoTabs = document.querySelectorAll('.config-sessao-tab');
  const configSessaoContent = document.getElementById('configSessaoContent');
  
  configSessaoTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Remover active de todas as tabs
      configSessaoTabs.forEach(t => t.classList.remove('active'));
      // Adicionar active na tab clicada
      this.classList.add('active');
      
      const tabId = this.getAttribute('data-tab');
      
      // Esconder todos os conte√∫dos
      const contents = ['configPesagemContent', 'configSanitarioContent', 'configReprodutivoContent', 'configMovimentacaoContent', 'configDefaultContent'];
      contents.forEach(contentId => {
        const content = document.getElementById(contentId);
        if (content) content.style.display = 'none';
      });
      
      // Mostrar conte√∫do correspondente
      const contentMap = {
        'pesagem': 'configPesagemContent',
        'sanitario': 'configSanitarioContent',
        'reprodutivo': 'configReprodutivoContent',
        'movimentacao': 'configMovimentacaoContent'
      };
      
      const contentId = contentMap[tabId];
      if (contentId) {
        const content = document.getElementById(contentId);
        
        // Carregar configura√ß√µes salvas ao abrir a aba
        if (tabId === 'sanitario' && typeof window.carregarConfigSanitario === 'function') {
          setTimeout(() => window.carregarConfigSanitario(), 100);
        } else if (tabId === 'movimentacao' && typeof window.carregarConfigMovimentacao === 'function') {
          setTimeout(() => window.carregarConfigMovimentacao(), 100);
        }
        if (content) {
          content.style.display = 'block';
          
          // Carregar valores salvos quando abrir a tab
          if (tabId === 'sanitario') {
            if (typeof window.carregarConfigSanitario === 'function') {
              window.carregarConfigSanitario();
            }
          } else if (tabId === 'movimentacao') {
            if (typeof window.carregarConfigMovimentacao === 'function') {
              window.carregarConfigMovimentacao();
            }
          } else if (tabId === 'reprodutivo') {
            // Carregar configura√ß√£o reprodutivo
            try {
              const saved = localStorage.getItem('monpecConfigReprodutivoV4');
              if (saved) {
                const config = JSON.parse(saved);
                if (config.tipo) {
                  const radio = document.querySelector(`input[name="tipoReprodutivoV4"][value="${config.tipo}"]`);
                  if (radio) {
                    radio.checked = true;
                    // Atualizar estilos dos labels
                    setTimeout(function() {
                      if (typeof window.atualizarEstilosReprodutivoV4 === 'function') {
                        window.atualizarEstilosReprodutivoV4();
                      }
                    }, 50);
                  }
                }
                if (config.protocolo) {
                  const protocoloInput = document.getElementById('protocoloIATFV4');
                  if (protocoloInput) protocoloInput.value = config.protocolo;
                }
                if (config.registrarTouro !== undefined) {
                  const checkbox = document.getElementById('registrarTouroV4');
                  if (checkbox) checkbox.checked = config.registrarTouro;
                }
                // Mostrar configura√ß√£o IATF se tipo for IATF
                if (config.tipo === 'iatf') {
                  const configIATFExtra = document.getElementById('configIATFExtraV4');
                  if (configIATFExtra) configIATFExtra.style.display = 'block';
                }
              }
              // Configurar evento de mudan√ßa para atualizar estilos
              setTimeout(function() {
                if (typeof window.configurarEventosReprodutivoV4 === 'function') {
                  window.configurarEventosReprodutivoV4();
                }
                if (typeof window.configurarReprodutivoIATF === 'function') {
                  window.configurarReprodutivoIATF();
                }
              }, 100);
            } catch (e) {
              console.warn('Erro ao carregar configura√ß√£o reprodutivo:', e);
            }
          } else if (tabId === 'movimentacao') {
            // Carregar configura√ß√£o movimenta√ß√£o
            try {
              const saved = localStorage.getItem('monpecConfigMovimentacaoV4');
              if (saved) {
                const config = JSON.parse(saved);
                if (config.tipo) {
                  const radio = document.querySelector(`input[name="tipoMovimentacaoV4"][value="${config.tipo}"]`);
                  if (radio) radio.checked = true;
                }
                if (config.registrarDestino !== undefined) {
                  const checkbox = document.getElementById('registrarDestinoV4');
                  if (checkbox) checkbox.checked = config.registrarDestino;
                }
              }
            } catch (e) {
              console.warn('Erro ao carregar configura√ß√£o movimenta√ß√£o:', e);
            }
          }
        }
      } else {
        const defaultContent = document.getElementById('configDefaultContent');
        if (defaultContent) defaultContent.style.display = 'block';
      }
      
      // Atualizar estilo dos radio buttons de pesagem
      if (tabId === 'pesagem') {
        const radioRotina = document.getElementById('pesagemRotinaV4');
        const radioAparte = document.getElementById('pesagemAparteV4');
        const labelRotina = document.getElementById('pesagemRotinaLabelV4');
        const labelAparte = document.getElementById('pesagemAparteLabelV4');
        
        function atualizarEstiloPesagem() {
          if (radioRotina && radioRotina.checked) {
            if (labelRotina) {
              labelRotina.style.borderColor = '#1976d2';
              labelRotina.style.background = '#e3f2fd';
            }
            if (labelAparte) {
              labelAparte.style.borderColor = '#e0e0e0';
              labelAparte.style.background = '#fff';
            }
          } else if (radioAparte && radioAparte.checked) {
            if (labelAparte) {
              labelAparte.style.borderColor = '#1976d2';
              labelAparte.style.background = '#e3f2fd';
            }
            if (labelRotina) {
              labelRotina.style.borderColor = '#e0e0e0';
              labelRotina.style.background = '#fff';
            }
          }
        }
        
        if (radioRotina) {
          radioRotina.addEventListener('change', atualizarEstiloPesagem);
        }
        if (radioAparte) {
          radioAparte.addEventListener('change', atualizarEstiloPesagem);
        }
        atualizarEstiloPesagem();
      }
    });
  });
  
  // Event listener para bot√£o de confirma√ß√£o de configura√ß√£o de pesagem
  const confirmarConfigPesagemBtn = document.getElementById('confirmarConfigPesagemV4');
  if (confirmarConfigPesagemBtn) {
    confirmarConfigPesagemBtn.addEventListener('click', function() {
      const tipoPesagem = document.querySelector('input[name="tipoPesagemV4"]:checked')?.value || 'rotina';
      const autoProximo = document.getElementById('autoProximoV4')?.checked || false;
      
      // Salvar configura√ß√£o no localStorage
      try {
        localStorage.setItem('monpecConfigPesagemV4', JSON.stringify({
          tipoPesagem: tipoPesagem,
          autoProximo: autoProximo,
          configurado: true
        }));
        console.log('‚úÖ Configura√ß√£o de pesagem salva:', { tipoPesagem, autoProximo });
        
        // Mostrar mensagem de sucesso
        if (typeof mostrarToast === 'function') {
          mostrarToast('Configura√ß√£o de pesagem salva com sucesso!', 'success');
        } else {
          alert('Configura√ß√£o salva com sucesso!');
        }
      } catch (e) {
        console.error('Erro ao salvar configura√ß√£o:', e);
        alert('Erro ao salvar configura√ß√£o.');
      }
    });
  }
  
  // ========== CONFIGURA√á√ÉO SANIT√ÅRIO ==========
  const configSanitarioV4 = {
    vacinas: [],
    medicamentos: []
  };
  
  // Carregar configura√ß√£o sanit√°ria salva
  function carregarConfigSanitarioV4() {
    try {
      const saved = localStorage.getItem('monpecConfigSanitarioV4');
      if (saved) {
        const config = JSON.parse(saved);
        if (config.vacinas) configSanitarioV4.vacinas = config.vacinas;
        if (config.medicamentos) configSanitarioV4.medicamentos = config.medicamentos;
        atualizarListasSanitarioV4();
      }
    } catch (e) {
      console.warn('Erro ao carregar configura√ß√£o sanit√°ria:', e);
    }
  }
  
  // Atualizar listas na interface
  function atualizarListasSanitarioV4() {
    const listaVacinas = document.getElementById('listaVacinasV4');
    const listaMedicamentos = document.getElementById('listaMedicamentosV4');
    
    if (listaVacinas) {
      if (configSanitarioV4.vacinas.length === 0) {
        listaVacinas.innerHTML = '<p style="text-align: center; color: #999; font-size: 0.85rem; margin: 8px 0;">Nenhuma vacina adicionada</p>';
      } else {
        listaVacinas.innerHTML = configSanitarioV4.vacinas.map((vacina, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 4px;">
            <span style="font-size: 0.9rem;">${vacina}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerVacinaV4(${index})" style="padding: 2px 8px; font-size: 0.8rem;">Remover</button>
          </div>
        `).join('');
      }
    }
    
    if (listaMedicamentos) {
      if (configSanitarioV4.medicamentos.length === 0) {
        listaMedicamentos.innerHTML = '<p style="text-align: center; color: #999; font-size: 0.85rem; margin: 8px 0;">Nenhum medicamento adicionado</p>';
      } else {
        listaMedicamentos.innerHTML = configSanitarioV4.medicamentos.map((med, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 4px;">
            <span style="font-size: 0.9rem;">${med}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMedicamentoV4(${index})" style="padding: 2px 8px; font-size: 0.8rem;">Remover</button>
          </div>
        `).join('');
      }
    }
  }
  
  window.removerVacinaV4 = function(index) {
    configSanitarioV4.vacinas.splice(index, 1);
    atualizarListasSanitarioV4();
  };
  
  window.removerMedicamentoV4 = function(index) {
    configSanitarioV4.medicamentos.splice(index, 1);
    atualizarListasSanitarioV4();
  };
  
  // Fun√ß√£o para adicionar vacina
  function adicionarVacinaV4() {
    const input = document.getElementById('vacinaNomeV4');
    const nome = input?.value.trim();
    if (nome) {
      configSanitarioV4.vacinas.push(nome);
      input.value = '';
      atualizarListasSanitarioV4();
    }
  }
  
  // Adicionar vacina
  const adicionarVacinaBtn = document.getElementById('adicionarVacinaV4');
  if (adicionarVacinaBtn) {
    adicionarVacinaBtn.addEventListener('click', adicionarVacinaV4);
  }
  
  // Permitir Enter para adicionar vacina
  const vacinaNomeInput = document.getElementById('vacinaNomeV4');
  if (vacinaNomeInput) {
    vacinaNomeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarVacinaV4();
      }
    });
  }
  
  // Fun√ß√£o para adicionar medicamento
  function adicionarMedicamentoV4() {
    const input = document.getElementById('medicamentoNomeV4');
    const nome = input?.value.trim();
    if (nome) {
      configSanitarioV4.medicamentos.push(nome);
      input.value = '';
      atualizarListasSanitarioV4();
    }
  }
  
  // Adicionar medicamento
  const adicionarMedicamentoBtn = document.getElementById('adicionarMedicamentoV4');
  if (adicionarMedicamentoBtn) {
    adicionarMedicamentoBtn.addEventListener('click', adicionarMedicamentoV4);
  }
  
  // Permitir Enter para adicionar medicamento
  const medicamentoNomeInput = document.getElementById('medicamentoNomeV4');
  if (medicamentoNomeInput) {
    medicamentoNomeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarMedicamentoV4();
      }
    });
  }
  
  // Fun√ß√£o para atualizar card de resumo sanit√°rio
  window.atualizarCardResumoSanitario = function() {
    console.log('üîÑ [ATUALIZAR CARD SANIT√ÅRIO] Iniciando...');
    
    const cardResumo = document.getElementById('cardResumoConfigSanitario');
    const resumoContent = document.getElementById('resumoConfigSanitario');
    const cardOriginal = document.getElementById('cardConfigSanitarioOriginal');
    
    if (!cardResumo || !resumoContent) {
      console.error('‚ùå [ATUALIZAR CARD SANIT√ÅRIO] Elementos n√£o encontrados!');
      return;
    }
    
    const config = configSanitarioV4;
    if (!config || (!config.vacinas || config.vacinas.length === 0) && (!config.medicamentos || config.medicamentos.length === 0)) {
      cardResumo.style.display = 'none';
      if (cardOriginal) cardOriginal.style.display = 'flex';
      return;
    }
    
    const vacinasTexto = config.vacinas && config.vacinas.length > 0 ? config.vacinas.join(', ') : 'Nenhuma';
    const medicamentosTexto = config.medicamentos && config.medicamentos.length > 0 ? config.medicamentos.join(', ') : 'Nenhum';
    
    const vacinasCount = config.vacinas && config.vacinas.length > 0 ? config.vacinas.length : 0;
    const medicamentosCount = config.medicamentos && config.medicamentos.length > 0 ? config.medicamentos.length : 0;
    const vacinasPreview = config.vacinas && config.vacinas.length > 0 ? (config.vacinas.length > 2 ? config.vacinas.slice(0, 2).join(', ') + '...' : config.vacinas.join(', ')) : 'Nenhuma';
    const medicamentosPreview = config.medicamentos && config.medicamentos.length > 0 ? (config.medicamentos.length > 2 ? config.medicamentos.slice(0, 2).join(', ') + '...' : config.medicamentos.join(', ')) : 'Nenhum';
    
    resumoContent.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
        <div style="width: 40px; height: 40px; border-radius: 10px; background: #d32f2f; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); flex-shrink: 0;">
          <i class="fas fa-syringe"></i>
        </div>
        <div style="flex: 1; min-width: 0;">
          <h3 style="margin: 0 0 4px 0; font-size: 0.95rem; color: #d32f2f; display: flex; align-items: center; gap: 6px; font-weight: 600;">
            <i class="fas fa-check-circle" style="font-size: 0.85rem;"></i> <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Sanit√°rio Ativo</span>
          </h3>
          <div style="font-size: 0.75rem; color: #666; line-height: 1.2;">
            Configura√ß√£o ativa
          </div>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; font-size: 0.75rem;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <i class="fas fa-vial" style="color: #666; font-size: 0.7rem;"></i>
          <span style="font-weight: 600; color: #333;">Vacinas:</span>
          <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${vacinasTexto}">${vacinasPreview}</span>
          ${vacinasCount > 0 ? `<span style="background: #d32f2f; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: auto;">${vacinasCount}</span>` : ''}
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <i class="fas fa-pills" style="color: #666; font-size: 0.7rem;"></i>
          <span style="font-weight: 600; color: #333;">Medic.:</span>
          <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${medicamentosTexto}">${medicamentosPreview}</span>
          ${medicamentosCount > 0 ? `<span style="background: #d32f2f; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: auto;">${medicamentosCount}</span>` : ''}
        </div>
      </div>
    `;
    
    if (cardOriginal) {
      cardOriginal.style.display = 'none';
    }
    cardResumo.style.display = 'flex';
    cardResumo.style.visibility = 'visible';
    cardResumo.style.opacity = '1';
    
    console.log('‚úÖ [ATUALIZAR CARD SANIT√ÅRIO] Card atualizado');
  };
  
  // Confirmar configura√ß√£o sanit√°ria
  const confirmarConfigSanitarioBtn = document.getElementById('confirmarConfigSanitarioV4');
  if (confirmarConfigSanitarioBtn) {
    confirmarConfigSanitarioBtn.addEventListener('click', function() {
      try {
        localStorage.setItem('monpecConfigSanitarioV4', JSON.stringify(configSanitarioV4));
        console.log('‚úÖ Configura√ß√£o sanit√°ria salva:', configSanitarioV4);
        
        // Atualizar card de resumo
        if (typeof window.atualizarCardResumoSanitario === 'function') {
          window.atualizarCardResumoSanitario();
        }
        
        if (typeof mostrarToast === 'function') {
          mostrarToast('Configura√ß√£o sanit√°ria salva com sucesso!', 'success');
        } else {
          alert('Configura√ß√£o salva com sucesso!');
        }
      } catch (e) {
        console.error('Erro ao salvar configura√ß√£o:', e);
        alert('Erro ao salvar configura√ß√£o.');
      }
    });
  }
  
  // ========== CONFIGURA√á√ÉO REPRODUTIVO ==========
  // Fun√ß√£o para atualizar estilos dos radio buttons de reprodu√ß√£o
  window.atualizarEstilosReprodutivoV4 = function() {
    const iatfRadio = document.getElementById('reprodutivoIATFV4');
    const montaRadio = document.getElementById('reprodutivoMontaV4');
    const inseminacaoRadio = document.getElementById('reprodutivoInseminacaoV4');
    const iatfLabel = document.getElementById('reprodutivoIATFLabelV4');
    const montaLabel = document.getElementById('reprodutivoMontaLabelV4');
    const inseminacaoLabel = document.getElementById('reprodutivoInseminacaoLabelV4');
    
    if (iatfRadio && montaRadio && inseminacaoRadio && iatfLabel && montaLabel && inseminacaoLabel) {
      // Resetar todos os estilos
      [iatfLabel, montaLabel, inseminacaoLabel].forEach(label => {
        label.style.borderColor = '#e0e0e0';
        label.style.background = '#f8f9fa';
      });
      
      // Aplicar estilo ao selecionado
      if (iatfRadio.checked) {
        iatfLabel.style.borderColor = '#7b1fa2';
        iatfLabel.style.background = '#f3e5f5';
      } else if (montaRadio.checked) {
        montaLabel.style.borderColor = '#7b1fa2';
        montaLabel.style.background = '#f3e5f5';
      } else if (inseminacaoRadio.checked) {
        inseminacaoLabel.style.borderColor = '#7b1fa2';
        inseminacaoLabel.style.background = '#f3e5f5';
      }
    }
  };
  
  // Configurar eventos para atualizar estilos quando radio buttons mudarem
  window.configurarEventosReprodutivoV4 = function() {
    const iatfRadio = document.getElementById('reprodutivoIATFV4');
    const montaRadio = document.getElementById('reprodutivoMontaV4');
    const inseminacaoRadio = document.getElementById('reprodutivoInseminacaoV4');
    
    if (iatfRadio) {
      iatfRadio.addEventListener('change', window.atualizarEstilosReprodutivoV4);
    }
    if (montaRadio) {
      montaRadio.addEventListener('change', window.atualizarEstilosReprodutivoV4);
    }
    if (inseminacaoRadio) {
      inseminacaoRadio.addEventListener('change', window.atualizarEstilosReprodutivoV4);
    }
    
    // Atualizar estilos iniciais
    window.atualizarEstilosReprodutivoV4();
  };
  
  // Mostrar campo extra quando IATF for selecionado
  window.configurarReprodutivoIATF = function() {
    const reprodutivoIATF = document.getElementById('reprodutivoIATFV4');
    const reprodutivoMonta = document.getElementById('reprodutivoMontaV4');
    const reprodutivoInseminacao = document.getElementById('reprodutivoInseminacaoV4');
    const configIATFExtra = document.getElementById('configIATFExtraV4');
    
    function atualizarVisibilidadeIATF() {
      if (configIATFExtra) {
        if (reprodutivoIATF && reprodutivoIATF.checked) {
          configIATFExtra.style.display = 'block';
        } else {
          configIATFExtra.style.display = 'none';
        }
      }
    }
    
    if (reprodutivoIATF) {
      reprodutivoIATF.addEventListener('change', atualizarVisibilidadeIATF);
    }
    if (reprodutivoMonta) {
      reprodutivoMonta.addEventListener('change', atualizarVisibilidadeIATF);
    }
    if (reprodutivoInseminacao) {
      reprodutivoInseminacao.addEventListener('change', atualizarVisibilidadeIATF);
    }
    
    // Verificar estado inicial
    atualizarVisibilidadeIATF();
  }
  
  // Inicializar quando a p√°gina carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', configurarReprodutivoIATF);
  } else {
    configurarReprodutivoIATF();
  }
  
  // Tamb√©m configurar quando a aba reprodutivo for aberta
  // (Usar o mesmo event listener j√° configurado em configSessaoTabs mais abaixo)
  
  // Fun√ß√£o para atualizar card de resumo reprodutivo
  window.atualizarCardResumoReprodutivo = function() {
    console.log('üîÑ [ATUALIZAR CARD REPRODUTIVO] Iniciando...');
    
    const cardResumo = document.getElementById('cardResumoConfigReprodutivo');
    const resumoContent = document.getElementById('resumoConfigReprodutivo');
    const cardOriginal = document.getElementById('cardConfigReprodutivoOriginal');
    
    if (!cardResumo || !resumoContent) {
      console.error('‚ùå [ATUALIZAR CARD REPRODUTIVO] Elementos n√£o encontrados!');
      return;
    }
    
    try {
      const saved = localStorage.getItem('monpecConfigReprodutivoV4');
      const config = saved ? JSON.parse(saved) : null;
      
      if (!config || !config.configurado) {
        cardResumo.style.display = 'none';
        if (cardOriginal) cardOriginal.style.display = 'flex';
        return;
      }
      
      const tipoTexto = config.tipo === 'iatf' ? 'IATF' : config.tipo === 'monta' ? 'Monta Natural' : config.tipo === 'inseminacao' ? 'Insemina√ß√£o Artificial' : 'N√£o especificado';
      const protocoloTexto = config.protocolo || (config.iatfConfig && config.iatfConfig.protocolo) || 'N√£o especificado';
      const temTouro = config.iatfConfig && config.iatfConfig.touroSemen && config.iatfConfig.touroSemen.trim() ? 'Sim' : 'N√£o';
      
      resumoContent.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="flex: 1; min-width: 0;">
            <h3 style="margin: 0 0 4px 0; font-size: 0.95rem; color: #7b1fa2; font-weight: 600;">
              Reprodu√ß√£o Ativa
            </h3>
            <div style="font-size: 0.75rem; color: #666; line-height: 1.2;">
              Configura√ß√£o ativa
            </div>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; font-size: 0.75rem;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="font-weight: 600; color: #333;">Tipo:</span>
            <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${tipoTexto}</span>
          </div>
          ${config.tipo === 'iatf' ? `
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="font-weight: 600; color: #333;">Protocolo:</span>
            <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${protocoloTexto}">${protocoloTexto.length > 15 ? protocoloTexto.substring(0, 15) + '...' : protocoloTexto}</span>
          </div>
          ` : ''}
          ${config.tipo === 'iatf' && config.iatfConfig && config.iatfConfig.touroSemen ? `
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="font-weight: 600; color: #333;">Touro/S√™men:</span>
            <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${config.iatfConfig.touroSemen}">${config.iatfConfig.touroSemen.length > 15 ? config.iatfConfig.touroSemen.substring(0, 15) + '...' : config.iatfConfig.touroSemen}</span>
          </div>
          ` : ''}
        </div>
      `;
      
      if (cardOriginal) cardOriginal.style.display = 'none';
      cardResumo.style.display = 'flex';
      cardResumo.style.visibility = 'visible';
      cardResumo.style.opacity = '1';
      
      console.log('‚úÖ [ATUALIZAR CARD REPRODUTIVO] Card atualizado');
    } catch (e) {
      console.error('‚ùå [ATUALIZAR CARD REPRODUTIVO] Erro:', e);
    }
  };
  
  // Confirmar configura√ß√£o reprodutivo
  const confirmarConfigReprodutivoBtn = document.getElementById('confirmarConfigReprodutivoV4');
  if (confirmarConfigReprodutivoBtn) {
    confirmarConfigReprodutivoBtn.addEventListener('click', function() {
      const tipo = document.querySelector('input[name="tipoReprodutivoV4"]:checked')?.value || '';
      const protocolo = document.getElementById('protocoloIATFV4')?.value || '';
      const registrarTouro = document.getElementById('registrarTouroV4')?.checked || false;
      
      // Validar se tipo foi selecionado
      if (!tipo) {
        alert('Por favor, selecione um tipo de manejo reprodutivo.');
        return;
      }
      
      // Validar protocolo se IATF foi selecionado
      if (tipo === 'iatf' && !protocolo.trim()) {
        alert('Por favor, informe o nome do protocolo IATF.');
        return;
      }
      
      try {
        localStorage.setItem('monpecConfigReprodutivoV4', JSON.stringify({
          tipo: tipo,
          protocolo: protocolo,
          registrarTouro: registrarTouro,
          configurado: true,
          dataConfiguracao: new Date().toISOString()
        }));
        console.log('‚úÖ Configura√ß√£o reprodutiva salva:', { tipo, protocolo, registrarTouro });
        
        // Atualizar card de resumo
        if (typeof window.atualizarCardResumoReprodutivo === 'function') {
          window.atualizarCardResumoReprodutivo();
        }
        
        // Fechar modal
        if (typeof window.fecharModalConfigPesagem === 'function') {
          window.fecharModalConfigPesagem();
        }
        
        if (typeof mostrarToast === 'function') {
          mostrarToast('Configura√ß√£o reprodutiva salva com sucesso!', 'success');
        } else {
          alert('Configura√ß√£o salva com sucesso!');
        }
      } catch (e) {
        console.error('Erro ao salvar configura√ß√£o:', e);
        alert('Erro ao salvar configura√ß√£o.');
      }
    });
  }
  
  // Fun√ß√£o para atualizar card de resumo movimenta√ß√£o
  window.atualizarCardResumoMovimentacao = function() {
    console.log('üîÑ [ATUALIZAR CARD MOVIMENTA√á√ÉO] Iniciando...');
    
    const cardResumo = document.getElementById('cardResumoConfigMovimentacao');
    const resumoContent = document.getElementById('resumoConfigMovimentacao');
    const cardOriginal = document.getElementById('cardConfigMovimentacaoOriginal');
    
    if (!cardResumo || !resumoContent) {
      console.error('‚ùå [ATUALIZAR CARD MOVIMENTA√á√ÉO] Elementos n√£o encontrados!');
      return;
    }
    
    try {
      const saved = localStorage.getItem('monpecConfigMovimentacaoV4');
      const config = saved ? JSON.parse(saved) : null;
      
      if (!config || !config.configurado) {
        cardResumo.style.display = 'none';
        if (cardOriginal) cardOriginal.style.display = 'flex';
        return;
      }
      
      const tipoTexto = config.tipo === 'entrada' ? 'Entrada' : config.tipo === 'saida' ? 'Sa√≠da' : config.tipo === 'transferencia' ? 'Transfer√™ncia' : 'N√£o especificado';
      const registrarDestinoTexto = config.registrarDestino ? 'Sim' : 'N√£o';
      
      resumoContent.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 40px; height: 40px; border-radius: 10px; background: #f57c00; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); flex-shrink: 0;">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <div style="flex: 1; min-width: 0;">
            <h3 style="margin: 0 0 4px 0; font-size: 0.95rem; color: #f57c00; display: flex; align-items: center; gap: 6px; font-weight: 600;">
              <i class="fas fa-check-circle" style="font-size: 0.85rem;"></i> <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Movimenta√ß√£o Ativa</span>
            </h3>
            <div style="font-size: 0.75rem; color: #666; line-height: 1.2;">
              Configura√ß√£o ativa
            </div>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; font-size: 0.75rem;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-arrows-alt" style="color: #666; font-size: 0.7rem;"></i>
            <span style="font-weight: 600; color: #333;">Tipo:</span>
            <span style="font-weight: 500; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${tipoTexto}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-map-marker-alt" style="color: #666; font-size: 0.7rem;"></i>
            <span style="font-weight: 600; color: #333;">Destino:</span>
            <span style="font-weight: 500; color: #555;">${registrarDestinoTexto}</span>
          </div>
        </div>
      `;
      
      if (cardOriginal) {
        cardOriginal.style.display = 'none';
      }
      cardResumo.style.display = 'flex';
      cardResumo.style.visibility = 'visible';
      cardResumo.style.opacity = '1';
      
      console.log('‚úÖ [ATUALIZAR CARD MOVIMENTA√á√ÉO] Card atualizado');
    } catch (e) {
      console.error('‚ùå [ATUALIZAR CARD MOVIMENTA√á√ÉO] Erro:', e);
    }
  };
  
  // ========== CONFIGURA√á√ÉO MOVIMENTA√á√ÉO ==========
  const confirmarConfigMovimentacaoBtn = document.getElementById('confirmarConfigMovimentacaoV4');
  if (confirmarConfigMovimentacaoBtn) {
    confirmarConfigMovimentacaoBtn.addEventListener('click', function() {
      const tipo = document.querySelector('input[name="tipoMovimentacaoV4"]:checked')?.value || '';
      const registrarDestino = document.getElementById('registrarDestinoV4')?.checked || false;
      
      try {
        localStorage.setItem('monpecConfigMovimentacaoV4', JSON.stringify({
          tipo: tipo,
          registrarDestino: registrarDestino,
          configurado: true
        }));
        console.log('‚úÖ Configura√ß√£o de movimenta√ß√£o salva:', { tipo, registrarDestino });
        
        // Atualizar card de resumo
        if (typeof window.atualizarCardResumoMovimentacao === 'function') {
          window.atualizarCardResumoMovimentacao();
        }
        
        if (typeof mostrarToast === 'function') {
          mostrarToast('Configura√ß√£o de movimenta√ß√£o salva com sucesso!', 'success');
        } else {
          alert('Configura√ß√£o salva com sucesso!');
        }
      } catch (e) {
        console.error('Erro ao salvar configura√ß√£o:', e);
        alert('Erro ao salvar configura√ß√£o.');
      }
    });
  }
  
        alert('Erro ao salvar configura√ß√£o.');
      }
    });
  }
  
  // Carregar configura√ß√µes salvas ao inicializar
  carregarConfigSanitarioV4();
  
  // Inicializar cards de resumo ao carregar a p√°gina
  function inicializarCardsResumo() {
    // Atualizar card sanit√°rio
    if (typeof window.atualizarCardResumoSanitario === 'function') {
      setTimeout(function() {
        window.atualizarCardResumoSanitario();
      }, 200);
    }
    
    // Atualizar card reprodutivo
    if (typeof window.atualizarCardResumoReprodutivo === 'function') {
      setTimeout(function() {
        window.atualizarCardResumoReprodutivo();
      }, 300);
    }
    
    // Atualizar card movimenta√ß√£o
    if (typeof window.atualizarCardResumoMovimentacao === 'function') {
      setTimeout(function() {
        window.atualizarCardResumoMovimentacao();
      }, 400);
    }
  }
  
  // Inicializar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarCardsResumo);
  } else {
    inicializarCardsResumo();
  }
  
  // Tamb√©m inicializar ap√≥s carregamento completo
  window.addEventListener('load', function() {
    setTimeout(inicializarCardsResumo, 500);
  });
  
  // Mostrar conte√∫do de pesagem por padr√£o (primeira aba ativa)
  const primeiraTab = document.querySelector('.config-sessao-tab.active');
  if (primeiraTab) {
    primeiraTab.click();
  }
  
  const btn = document.getElementById('btnSimulacao');
  if (btn) {
    btn.style.display = 'flex';
    btn.style.visibility = 'visible';
    console.log('‚úÖ Bot√£o de simula√ß√£o encontrado e vis√≠vel');
  }
  
  // Criar cards indicadores de manejo (com m√∫ltiplas tentativas)
  function tentarCriarCardsIndicadores(tentativas = 0) {
    const maxTentativas = 10;
    const delay = 300;
    
    if (typeof window.criarCardsIndicadoresManejo === 'function') {
      try {
        window.criarCardsIndicadoresManejo();
        if (typeof window.atualizarIndicadorPesagem === 'function') {
          window.atualizarIndicadorPesagem('rotina');
        }
        console.log('‚úÖ Cards indicadores de manejo criados com sucesso');
      } catch (e) {
        console.error('‚ùå Erro ao criar cards indicadores:', e);
      }
    } else if (tentativas < maxTentativas) {
      console.warn(`‚ö†Ô∏è Fun√ß√£o criarCardsIndicadoresManejo n√£o encontrada. Tentando novamente... (tentativa ${tentativas + 1}/${maxTentativas})`);
      setTimeout(() => tentarCriarCardsIndicadores(tentativas + 1), delay);
    } else {
      console.warn('‚ö†Ô∏è Fun√ß√£o criarCardsIndicadoresManejo n√£o foi encontrada ap√≥s todas as tentativas');
    }
  }
  
  // Iniciar tentativas ap√≥s um pequeno delay
  setTimeout(() => tentarCriarCardsIndicadores(), 100);
});
</script>

<!-- Modal Dedicado para Configura√ß√£o de Reprodu√ß√£o -->
<div id="modalConfigReprodutivo" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
  <div style="background: white; border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <div style="padding: 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); color: white; border-radius: 12px 12px 0 0;">
      <h2 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-dna"></i> Configura√ß√£o Reprodutiva
      </h2>
      <button type="button" onclick="window.fecharModalConfigReprodutivo()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
        √ó
      </button>
    </div>
    
    <div style="padding: 24px;">
      <!-- Tipo de Reprodu√ß√£o -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #333; font-size: 1rem;">
          Tipo de Manejo Reprodutivo:
        </label>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
          <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="reprodutivoIATFLabelModal" onmouseover="if(!document.getElementById('reprodutivoIATFModal').checked){this.style.borderColor='#7b1fa2'; this.style.background='#f3e5f5';}" onmouseout="if(!document.getElementById('reprodutivoIATFModal').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
            <input type="radio" name="tipoReprodutivoModal" value="iatf" id="reprodutivoIATFModal" style="margin-right: 8px; width: 18px; height: 18px;">
            <strong style="display: block; margin-top: 8px; color: #333;">IATF</strong>
            <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Insemina√ß√£o Artificial em Tempo Fixo</div>
          </label>
          <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="reprodutivoMontaLabelModal" onmouseover="if(!document.getElementById('reprodutivoMontaModal').checked){this.style.borderColor='#7b1fa2'; this.style.background='#f3e5f5';}" onmouseout="if(!document.getElementById('reprodutivoMontaModal').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
            <input type="radio" name="tipoReprodutivoModal" value="monta" id="reprodutivoMontaModal" style="margin-right: 8px; width: 18px; height: 18px;">
            <strong style="display: block; margin-top: 8px; color: #333;">Monta Natural</strong>
            <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Cobertura natural com touro</div>
          </label>
          <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="reprodutivoInseminacaoLabelModal" onmouseover="if(!document.getElementById('reprodutivoInseminacaoModal').checked){this.style.borderColor='#7b1fa2'; this.style.background='#f3e5f5';}" onmouseout="if(!document.getElementById('reprodutivoInseminacaoModal').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
            <input type="radio" name="tipoReprodutivoModal" value="inseminacao" id="reprodutivoInseminacaoModal" style="margin-right: 8px; width: 18px; height: 18px;">
            <strong style="display: block; margin-top: 8px; color: #333;">Insemina√ß√£o</strong>
            <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Insemina√ß√£o Artificial</div>
          </label>
        </div>
      </div>

      <!-- Configura√ß√µes IATF (aparece quando IATF √© selecionado) -->
      <div id="configIATFExpandidoModal" style="display: none; margin-bottom: 24px; padding: 24px; background: #f3e5f5; border-radius: 10px; border: 2px solid #7b1fa2;">
        <h4 style="margin: 0 0 20px 0; color: #7b1fa2; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-calendar-check"></i> Configura√ß√£o do Protocolo IATF
        </h4>
        
        <!-- Nome do Protocolo -->
        <div style="margin-bottom: 24px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.95rem;">
            Nome do Protocolo:
          </label>
          <input type="text" id="protocoloIATFModal" placeholder="Ex: IATF Padr√£o" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; background: white;">
        </div>

        <!-- Configura√ß√£o D0 - Implante -->
        <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #7b1fa2;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong style="color: #7b1fa2; font-size: 1rem;">D0 - Implante</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Data do Implante:</label>
              <input type="date" id="dataImplanteModal" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel:</label>
              <input type="text" id="responsavelImplanteModal" placeholder="Nome do respons√°vel" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="aplicarProgesteronaModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarProgesteronaModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar implante de progesterona intravaginal</label>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="aplicarEstradiolModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarEstradiolModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar benzoato de estradiol</label>
            </div>
          </div>
        </div>

        <!-- Configura√ß√£o D9 - Retirada -->
        <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ff9800;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong style="color: #ff9800; font-size: 1rem;">D9 - Retirada do Implante</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Data da Retirada:</label>
              <input type="date" id="dataRetiradaModal" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel:</label>
              <input type="text" id="responsavelRetiradaModal" placeholder="Nome do respons√°vel" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="retirarImplanteModal" checked style="width: 18px; height: 18px;">
              <label for="retirarImplanteModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Retirar implante intravaginal</label>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="aplicarProstaglandinaModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarProstaglandinaModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar prostaglandina</label>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="aplicarCipionatoModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarCipionatoModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar cipionato de estradiol</label>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="aplicarGonadotrofinaModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarGonadotrofinaModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar gonadotrofina cori√¥nica</label>
            </div>
          </div>
        </div>

        <!-- Configura√ß√£o D11 - Insemina√ß√£o -->
        <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #4caf50;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong style="color: #4caf50; font-size: 1rem;">D11 - Insemina√ß√£o</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Data da Insemina√ß√£o:</label>
              <input type="date" id="dataInseminacaoModal" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel (Inseminador):</label>
              <input type="text" id="responsavelInseminacaoModal" placeholder="Nome do inseminador" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
            </div>
          </div>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="aplicarGNRHModal" checked style="width: 18px; height: 18px;">
              <label for="aplicarGNRHModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Aplicar GNRH (Horm√¥nio Liberador de Gonadotrofinas)</label>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="realizarInseminacaoModal" checked style="width: 18px; height: 18px;">
              <label for="realizarInseminacaoModal" style="margin: 0; font-size: 0.9rem; cursor: pointer;">Realizar insemina√ß√£o artificial</label>
            </div>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Touro/S√™men (opcional):</label>
            <input type="text" id="touroSemenModal" placeholder="Identifica√ß√£o do touro ou c√≥digo do s√™men" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
          </div>
        </div>

        <!-- Observa√ß√µes -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Observa√ß√µes:</label>
          <textarea id="observacoesIATFModal" placeholder="Observa√ß√µes adicionais sobre o protocolo..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
        </div>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e0e0e0;">
        <button type="button" class="btn btn-secondary" onclick="window.fecharModalConfigReprodutivo()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600;">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="confirmarConfigReprodutivoModal" style="padding: 10px 24px; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); border: none; color: white;">
          <i class="fas fa-check"></i> Confirmar Configura√ß√£o
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Configura√ß√£o de Pesagem -->
<div id="modalConfigPesagem" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
  <div style="background: white; border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
    <div style="padding: 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border-radius: 12px 12px 0 0;">
      <h2 style="margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-cog"></i> Configura√ß√£o da Sess√£o
      </h2>
      <button type="button" onclick="fecharModalConfigPesagem()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
        √ó
      </button>
    </div>
    
    <!-- Tabs de Configura√ß√£o -->
    <div class="config-sessao-tabs" style="display: flex; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; overflow-x: auto;">
      <button type="button" class="config-sessao-tab config-tab-pesagem active" data-tab="pesagem" style="flex: 1; min-width: 120px; padding: 12px 16px; background: transparent; border: none; border-bottom: 3px solid #1976d2; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #1976d2;">
        <i class="fas fa-weight"></i> Pesagem
      </button>
      <button type="button" class="config-sessao-tab config-tab-sanitario" data-tab="sanitario" style="flex: 1; min-width: 120px; padding: 12px 16px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #d32f2f;">
        <i class="fas fa-syringe"></i> Sanit√°rio
      </button>
      <button type="button" class="config-sessao-tab config-tab-reprodutivo" data-tab="reprodutivo" style="flex: 1; min-width: 120px; padding: 12px 16px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #7b1fa2;">
        <i class="fas fa-dna"></i> Reprodu√ß√£o
      </button>
      <button type="button" class="config-sessao-tab config-tab-movimentacao" data-tab="movimentacao" style="flex: 1; min-width: 120px; padding: 12px 16px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #f57c00;">
        <i class="fas fa-exchange-alt"></i> Movimenta√ß√£o
      </button>
    </div>

    <div style="flex: 1; overflow-y: auto;">
      <!-- Conte√∫do da Aba Pesagem -->
      <div id="configPesagemContent" style="padding: 24px;">
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px 0; color: #1976d2; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-weight"></i> Configura√ß√£o de Pesagem
          </h3>
          <p style="color: #666; margin-bottom: 20px;">Configure o tipo de pesagem que ser√° realizada nesta sess√£o.</p>
        </div>

        <!-- Tipo de Pesagem -->
        <div style="margin-bottom: 24px;">
          <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #333; font-size: 1rem;">
            Tipo de Pesagem:
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="pesagemRotinaLabelModal" onmouseover="if(!document.getElementById('pesagemRotinaModal').checked){this.style.borderColor='#1976d2'; this.style.background='#e3f2fd';}" onmouseout="if(!document.getElementById('pesagemRotinaModal').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoPesagemModal" value="rotina" id="pesagemRotinaModal" checked style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Pesagem de Rotina</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Registra no hist√≥rico</div>
            </label>
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="pesagemAparteLabelModal" onmouseover="if(!document.getElementById('pesagemAparteModal').checked){this.style.borderColor='#1976d2'; this.style.background='#e3f2fd';}" onmouseout="if(!document.getElementById('pesagemAparteModal').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoPesagemModal" value="aparte" id="pesagemAparteModal" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Pesagem para Aparta√ß√£o</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Apenas loteamento</div>
            </label>
          </div>
        </div>

        <!-- Faixas de Peso (aparece quando Aparta√ß√£o √© selecionada) -->
        <div id="configFaixasPesoContainer" style="display: none; margin-bottom: 24px; padding: 20px; background: #e3f2fd; border-radius: 10px; border: 2px solid #1976d2;">
          <h4 style="margin: 0 0 16px 0; color: #1976d2; font-size: 1rem;">
            <i class="fas fa-layer-group"></i> Faixas de Peso para Aparta√ß√£o
          </h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Cabeceira (kg)</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input type="number" id="faixaCabeceiraMin" placeholder="M√≠n" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="faixaCabeceiraMax" placeholder="M√°x" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
              </div>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Meio (kg)</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input type="number" id="faixaMeioMin" placeholder="M√≠n" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="faixaMeioMax" placeholder="M√°x" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
              </div>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Fundo (kg)</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input type="number" id="faixaFundoMin" placeholder="M√≠n" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="faixaFundoMax" placeholder="M√°x" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
              </div>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Boiada (kg)</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input type="number" id="faixaBoiadaMin" placeholder="M√≠n" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="faixaBoiadaMax" placeholder="M√°x" min="0" step="0.1" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
              </div>
            </div>
          </div>
        </div>

        <!-- Auto Pr√≥ximo -->
        <div class="config-pesagem-auto-proximo" style="margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 10px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <label class="config-pesagem-switch" style="position: relative; display: inline-block; width: 50px; height: 26px; flex-shrink: 0;">
              <input type="checkbox" id="autoProximoModal" style="opacity: 0; width: 0; height: 0;">
              <span class="config-pesagem-switch-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px;">
                <span style="position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);"></span>
              </span>
            </label>
            <div class="config-pesagem-auto-proximo-text">
              <div class="config-pesagem-auto-proximo-title" style="font-weight: 600; color: #333; font-size: 0.95rem; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-forward"></i> Avan√ßar automaticamente para pr√≥ximo animal
              </div>
              <div class="config-pesagem-auto-proximo-desc" style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                Ap√≥s gravar a pesagem, limpa os campos e prepara para o pr√≥ximo animal
              </div>
            </div>
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <button type="button" class="btn btn-secondary" onclick="fecharModalConfigPesagem()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600;">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="confirmarConfigPesagemModal" onclick="if(typeof window.confirmarConfigPesagem === 'function'){window.confirmarConfigPesagem();}else{alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');}" style="padding: 10px 24px; border-radius: 8px; font-weight: 600; background: #1976d2; border-color: #1976d2;">
            <i class="fas fa-check"></i> Confirmar Configura√ß√£o
          </button>
        </div>
      </div>

      <!-- Conte√∫do da Aba Sanit√°rio -->
      <div id="configSanitarioContent" style="padding: 24px; display: none;">
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px 0; color: #d32f2f; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-syringe"></i> Configura√ß√£o Sanit√°ria
          </h3>
          <p style="color: #666; margin-bottom: 20px;">Configure os tratamentos sanit√°rios que ser√£o aplicados nesta sess√£o.</p>
        </div>

        <!-- Tipo de Manejo Sanit√°rio -->
        <div style="margin-bottom: 24px;">
          <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #333; font-size: 1rem;">
            Tipo de Manejo:
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="sanitarioVacinaLabel" onmouseover="if(!document.getElementById('sanitarioVacina').checked){this.style.borderColor='#d32f2f'; this.style.background='#ffebee';}" onmouseout="if(!document.getElementById('sanitarioVacina').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoSanitario" value="VACINACAO" id="sanitarioVacina" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Vacina√ß√£o</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Aplica√ß√£o de vacinas</div>
            </label>
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="sanitarioTratamentoLabel" onmouseover="if(!document.getElementById('sanitarioTratamento').checked){this.style.borderColor='#d32f2f'; this.style.background='#ffebee';}" onmouseout="if(!document.getElementById('sanitarioTratamento').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoSanitario" value="TRATAMENTO" id="sanitarioTratamento" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Tratamento</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Aplica√ß√£o de medicamentos</div>
            </label>
          </div>
        </div>

        <!-- Campos para Vacina√ß√£o -->
        <div id="camposVacina" style="display: none; margin-bottom: 24px; padding: 20px; background: #ffebee; border-radius: 10px; border: 2px solid #d32f2f;">
          <h4 style="margin: 0 0 16px 0; color: #d32f2f; font-size: 1rem;">
            <i class="fas fa-syringe"></i> Dados da Vacina√ß√£o
          </h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Nome da Vacina *</label>
              <input type="text" id="vacinaNome" placeholder="Ex: Aftosa, Brucelose" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;" required>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Lote</label>
              <input type="text" id="vacinaLote" placeholder="N√∫mero do lote" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Data de Validade</label>
              <input type="date" id="vacinaValidade" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel</label>
              <input type="text" id="vacinaResponsavel" placeholder="Nome do respons√°vel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Observa√ß√µes</label>
            <textarea id="vacinaObservacoes" placeholder="Observa√ß√µes adicionais..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; min-height: 80px; resize: vertical;"></textarea>
          </div>
        </div>

        <!-- Campos para Tratamento -->
        <div id="camposTratamento" style="display: none; margin-bottom: 24px; padding: 20px; background: #ffebee; border-radius: 10px; border: 2px solid #d32f2f;">
          <h4 style="margin: 0 0 16px 0; color: #d32f2f; font-size: 1rem;">
            <i class="fas fa-pills"></i> Dados do Tratamento
          </h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Medicamento/Tratamento *</label>
              <input type="text" id="tratamentoNome" placeholder="Ex: Antibi√≥tico, Verm√≠fugo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;" required>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Dosagem</label>
              <input type="text" id="tratamentoDosagem" placeholder="Ex: 5ml, 1 comprimido" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Car√™ncia (dias)</label>
              <input type="number" id="tratamentoCarencia" placeholder="Dias de car√™ncia" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel</label>
              <input type="text" id="tratamentoResponsavel" placeholder="Nome do respons√°vel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Observa√ß√µes</label>
            <textarea id="tratamentoObservacoes" placeholder="Observa√ß√µes adicionais..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; min-height: 80px; resize: vertical;"></textarea>
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <button type="button" class="btn btn-secondary" onclick="fecharModalConfigPesagem()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600;">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="salvarConfigSanitario()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600; background: #d32f2f; border-color: #d32f2f;">
            <i class="fas fa-save"></i> Salvar Configura√ß√£o
          </button>
        </div>
      </div>

      <!-- Conte√∫do da Aba Reprodutivo -->
      <div id="configReprodutivoContent" style="padding: 24px; display: none;">
        <p style="color: #666; margin-bottom: 20px;">Use o modal dedicado de Reprodu√ß√£o clicando no card "REPRODU√á√ÉO" na se√ß√£o de configura√ß√£o.</p>
        <button type="button" class="btn btn-primary" onclick="fecharModalConfigPesagem(); if(typeof window.abrirModalConfigSessao === 'function'){window.abrirModalConfigSessao('reprodutivo');}" style="padding: 10px 24px; border-radius: 8px; font-weight: 600; background: #7b1fa2; border-color: #7b1fa2;">
          <i class="fas fa-dna"></i> Abrir Modal de Reprodu√ß√£o
        </button>
      </div>

      <!-- Conte√∫do da Aba Movimenta√ß√£o -->
      <div id="configMovimentacaoContent" style="padding: 24px; display: none;">
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px 0; color: #f57c00; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-exchange-alt"></i> Configura√ß√£o de Movimenta√ß√£o
          </h3>
          <p style="color: #666; margin-bottom: 20px;">Configure o tipo de movimenta√ß√£o que ser√° realizada nesta sess√£o.</p>
        </div>

        <!-- Tipo de Movimenta√ß√£o -->
        <div style="margin-bottom: 24px;">
          <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #333; font-size: 1rem;">
            Tipo de Movimenta√ß√£o:
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="movimentacaoEntradaLabel" onmouseover="if(!document.getElementById('movimentacaoEntrada').checked){this.style.borderColor='#f57c00'; this.style.background='#fff3e0';}" onmouseout="if(!document.getElementById('movimentacaoEntrada').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoMovimentacao" value="ENTRADA" id="movimentacaoEntrada" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Entrada</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Animais chegando</div>
            </label>
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="movimentacaoSaidaLabel" onmouseover="if(!document.getElementById('movimentacaoSaida').checked){this.style.borderColor='#f57c00'; this.style.background='#fff3e0';}" onmouseout="if(!document.getElementById('movimentacaoSaida').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoMovimentacao" value="SAIDA" id="movimentacaoSaida" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Sa√≠da</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Animais saindo</div>
            </label>
            <label style="padding: 16px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; background: #f8f9fa;" id="movimentacaoApartacaoLabel" onmouseover="if(!document.getElementById('movimentacaoApartacao').checked){this.style.borderColor='#f57c00'; this.style.background='#fff3e0';}" onmouseout="if(!document.getElementById('movimentacaoApartacao').checked){this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa';}">
              <input type="radio" name="tipoMovimentacao" value="APARTACAO" id="movimentacaoApartacao" style="margin-right: 8px; width: 18px; height: 18px;">
              <strong style="display: block; margin-top: 8px; color: #333;">Aparta√ß√£o</strong>
              <div style="font-size: 0.85rem; color: #666; margin-top: 6px;">Mudan√ßa de lote</div>
            </label>
          </div>
        </div>

        <!-- Campos para Movimenta√ß√£o -->
        <div id="camposMovimentacao" style="display: none; margin-bottom: 24px; padding: 20px; background: #fff3e0; border-radius: 10px; border: 2px solid #f57c00;">
          <h4 style="margin: 0 0 16px 0; color: #f57c00; font-size: 1rem;">
            <i class="fas fa-exchange-alt"></i> Dados da Movimenta√ß√£o
          </h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Lote/Pasto Origem</label>
              <input type="text" id="movimentacaoOrigem" placeholder="Nome do lote/pasto de origem" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Lote/Pasto Destino</label>
              <input type="text" id="movimentacaoDestino" placeholder="Nome do lote/pasto de destino" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Motivo</label>
              <select id="movimentacaoMotivo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                <option value="">Selecione o motivo</option>
                <option value="ROTACAO">Rota√ß√£o de Pasto</option>
                <option value="LOTEAMENTO">Loteamento</option>
                <option value="COMPRA">Compra</option>
                <option value="VENDA">Venda</option>
                <option value="TRANSFERENCIA">Transfer√™ncia</option>
                <option value="OUTROS">Outros</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Respons√°vel</label>
              <input type="text" id="movimentacaoResponsavel" placeholder="Nome do respons√°vel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
            </div>
          </div>
          <div>
            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #555; font-size: 0.9rem;">Observa√ß√µes</label>
            <textarea id="movimentacaoObservacoes" placeholder="Observa√ß√µes adicionais..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; min-height: 80px; resize: vertical;"></textarea>
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <button type="button" class="btn btn-secondary" onclick="fecharModalConfigPesagem()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600;">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="salvarConfigMovimentacao()" style="padding: 10px 24px; border-radius: 8px; font-weight: 600; background: #f57c00; border-color: #f57c00;">
            <i class="fas fa-save"></i> Salvar Configura√ß√£o
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ========== CONFIGURA√á√ÉO DO MODAL DE REPRODU√á√ÉO ==========
(function() {
  'use strict';
  
  // Fun√ß√£o para atualizar estilos dos radio buttons
  function atualizarEstilosReprodutivoModal() {
    const iatfRadio = document.getElementById('reprodutivoIATFModal');
    const montaRadio = document.getElementById('reprodutivoMontaModal');
    const inseminacaoRadio = document.getElementById('reprodutivoInseminacaoModal');
    const iatfLabel = document.getElementById('reprodutivoIATFLabelModal');
    const montaLabel = document.getElementById('reprodutivoMontaLabelModal');
    const inseminacaoLabel = document.getElementById('reprodutivoInseminacaoLabelModal');
    const configIATFExpandido = document.getElementById('configIATFExpandidoModal');
    
    if (!iatfRadio || !montaRadio || !inseminacaoRadio) return;
    
    // Resetar estilos
    [iatfLabel, montaLabel, inseminacaoLabel].forEach(label => {
      if (label) {
        label.style.borderColor = '#e0e0e0';
        label.style.background = '#f8f9fa';
      }
    });
    
    // Aplicar estilo ao selecionado
    if (iatfRadio.checked && iatfLabel) {
      iatfLabel.style.borderColor = '#7b1fa2';
      iatfLabel.style.background = '#f3e5f5';
      if (configIATFExpandido) configIATFExpandido.style.display = 'block';
    } else if (montaRadio.checked && montaLabel) {
      montaLabel.style.borderColor = '#7b1fa2';
      montaLabel.style.background = '#f3e5f5';
      if (configIATFExpandido) configIATFExpandido.style.display = 'none';
    } else if (inseminacaoRadio.checked && inseminacaoLabel) {
      inseminacaoLabel.style.borderColor = '#7b1fa2';
      inseminacaoLabel.style.background = '#f3e5f5';
      if (configIATFExpandido) configIATFExpandido.style.display = 'none';
    } else {
      if (configIATFExpandido) configIATFExpandido.style.display = 'none';
    }
  }
  
  // Configurar eventos quando o modal for aberto
  window.carregarConfigReprodutivoModal = function() {
    const iatfRadio = document.getElementById('reprodutivoIATFModal');
    const montaRadio = document.getElementById('reprodutivoMontaModal');
    const inseminacaoRadio = document.getElementById('reprodutivoInseminacaoModal');
    
    if (!iatfRadio || !montaRadio || !inseminacaoRadio) {
      console.warn('‚ö†Ô∏è Elementos do modal de reprodu√ß√£o n√£o encontrados');
      return;
    }
    
    // Adicionar event listeners
    [iatfRadio, montaRadio, inseminacaoRadio].forEach(radio => {
      radio.removeEventListener('change', atualizarEstilosReprodutivoModal);
      radio.addEventListener('change', atualizarEstilosReprodutivoModal);
    });
    
    // Carregar configura√ß√£o salva
    try {
      const saved = localStorage.getItem('monpecConfigReprodutivoV4');
      if (saved) {
        const config = JSON.parse(saved);
        if (config.tipo) {
          const radio = document.querySelector(`input[name="tipoReprodutivoModal"][value="${config.tipo}"]`);
          if (radio) {
            radio.checked = true;
            atualizarEstilosReprodutivoModal();
            
            // Carregar dados do IATF se existirem
            if (config.tipo === 'iatf' && config.iatfConfig) {
              if (config.iatfConfig.protocolo) {
                const protocoloInput = document.getElementById('protocoloIATFModal');
                if (protocoloInput) protocoloInput.value = config.iatfConfig.protocolo;
              }
              if (config.iatfConfig.dataImplante) {
                const el = document.getElementById('dataImplanteModal');
                if (el) el.value = config.iatfConfig.dataImplante;
              }
              if (config.iatfConfig.responsavelImplante) {
                const el = document.getElementById('responsavelImplanteModal');
                if (el) el.value = config.iatfConfig.responsavelImplante;
              }
              if (config.iatfConfig.aplicarProgesterona !== undefined) {
                const el = document.getElementById('aplicarProgesteronaModal');
                if (el) el.checked = config.iatfConfig.aplicarProgesterona;
              }
              if (config.iatfConfig.aplicarEstradiol !== undefined) {
                const el = document.getElementById('aplicarEstradiolModal');
                if (el) el.checked = config.iatfConfig.aplicarEstradiol;
              }
              if (config.iatfConfig.dataRetirada) {
                const el = document.getElementById('dataRetiradaModal');
                if (el) el.value = config.iatfConfig.dataRetirada;
              }
              if (config.iatfConfig.responsavelRetirada) {
                const el = document.getElementById('responsavelRetiradaModal');
                if (el) el.value = config.iatfConfig.responsavelRetirada;
              }
              if (config.iatfConfig.retirarImplante !== undefined) {
                const el = document.getElementById('retirarImplanteModal');
                if (el) el.checked = config.iatfConfig.retirarImplante;
              }
              if (config.iatfConfig.aplicarProstaglandina !== undefined) {
                const el = document.getElementById('aplicarProstaglandinaModal');
                if (el) el.checked = config.iatfConfig.aplicarProstaglandina;
              }
              if (config.iatfConfig.aplicarCipionato !== undefined) {
                const el = document.getElementById('aplicarCipionatoModal');
                if (el) el.checked = config.iatfConfig.aplicarCipionato;
              }
              if (config.iatfConfig.aplicarGonadotrofina !== undefined) {
                const el = document.getElementById('aplicarGonadotrofinaModal');
                if (el) el.checked = config.iatfConfig.aplicarGonadotrofina;
              }
              if (config.iatfConfig.dataInseminacao) {
                const el = document.getElementById('dataInseminacaoModal');
                if (el) el.value = config.iatfConfig.dataInseminacao;
              }
              if (config.iatfConfig.responsavelInseminacao) {
                const el = document.getElementById('responsavelInseminacaoModal');
                if (el) el.value = config.iatfConfig.responsavelInseminacao;
              }
              if (config.iatfConfig.aplicarGNRH !== undefined) {
                const el = document.getElementById('aplicarGNRHModal');
                if (el) el.checked = config.iatfConfig.aplicarGNRH;
              }
              if (config.iatfConfig.realizarInseminacao !== undefined) {
                const el = document.getElementById('realizarInseminacaoModal');
                if (el) el.checked = config.iatfConfig.realizarInseminacao;
              }
              if (config.iatfConfig.touroSemen) {
                const el = document.getElementById('touroSemenModal');
                if (el) el.value = config.iatfConfig.touroSemen;
              }
              if (config.iatfConfig.observacoes) {
                const el = document.getElementById('observacoesIATFModal');
                if (el) el.value = config.iatfConfig.observacoes;
              }
            }
          }
        }
      }
    } catch (e) {
      console.warn('Erro ao carregar configura√ß√£o:', e);
    }
    
    // Atualizar estilos iniciais
    atualizarEstilosReprodutivoModal();
  };
  
  // Configurar bot√£o de confirmar
  document.addEventListener('DOMContentLoaded', function() {
    const confirmarBtn = document.getElementById('confirmarConfigReprodutivoModal');
    if (confirmarBtn) {
      confirmarBtn.addEventListener('click', function() {
        const tipo = document.querySelector('input[name="tipoReprodutivoModal"]:checked')?.value || '';
        
        if (!tipo) {
          alert('Por favor, selecione um tipo de manejo reprodutivo.');
          return;
        }
        
        let config = {
          tipo: tipo,
          configurado: true,
          dataConfiguracao: new Date().toISOString()
        };
        
        // Se for IATF, salvar configura√ß√µes detalhadas
        if (tipo === 'iatf') {
          const protocolo = document.getElementById('protocoloIATFModal')?.value || '';
          if (!protocolo.trim()) {
            alert('Por favor, informe o nome do protocolo IATF.');
            return;
          }
          
          config.protocolo = protocolo;
          config.iatfConfig = {
            protocolo: protocolo,
            dataImplante: document.getElementById('dataImplanteModal')?.value || '',
            responsavelImplante: document.getElementById('responsavelImplanteModal')?.value || '',
            aplicarProgesterona: document.getElementById('aplicarProgesteronaModal')?.checked || false,
            aplicarEstradiol: document.getElementById('aplicarEstradiolModal')?.checked || false,
            dataRetirada: document.getElementById('dataRetiradaModal')?.value || '',
            responsavelRetirada: document.getElementById('responsavelRetiradaModal')?.value || '',
            retirarImplante: document.getElementById('retirarImplanteModal')?.checked || false,
            aplicarProstaglandina: document.getElementById('aplicarProstaglandinaModal')?.checked || false,
            aplicarCipionato: document.getElementById('aplicarCipionatoModal')?.checked || false,
            aplicarGonadotrofina: document.getElementById('aplicarGonadotrofinaModal')?.checked || false,
            dataInseminacao: document.getElementById('dataInseminacaoModal')?.value || '',
            responsavelInseminacao: document.getElementById('responsavelInseminacaoModal')?.value || '',
            aplicarGNRH: document.getElementById('aplicarGNRHModal')?.checked || false,
            realizarInseminacao: document.getElementById('realizarInseminacaoModal')?.checked || false,
            touroSemen: document.getElementById('touroSemenModal')?.value || '',
            observacoes: document.getElementById('observacoesIATFModal')?.value || ''
          };
        }
        
        try {
          localStorage.setItem('monpecConfigReprodutivoV4', JSON.stringify(config));
          console.log('‚úÖ Configura√ß√£o reprodutiva salva:', config);
          
          // Atualizar card de resumo
          if (typeof window.atualizarCardResumoReprodutivo === 'function') {
            window.atualizarCardResumoReprodutivo();
          }
          
          // Fechar modal
          if (typeof window.fecharModalConfigReprodutivo === 'function') {
            window.fecharModalConfigReprodutivo();
          }
          
          if (typeof mostrarToast === 'function') {
            mostrarToast('Configura√ß√£o reprodutiva salva com sucesso!', 'success');
          } else {
            alert('Configura√ß√£o salva com sucesso!');
          }
        } catch (e) {
          console.error('Erro ao salvar configura√ß√£o:', e);
          alert('Erro ao salvar configura√ß√£o.');
        }
      });
    }
    
    // Fechar modal ao clicar fora
    const modal = document.getElementById('modalConfigReprodutivo');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          if (typeof window.fecharModalConfigReprodutivo === 'function') {
            window.fecharModalConfigReprodutivo();
          }
        }
      });
    }
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('modalConfigReprodutivo');
        if (modal && modal.style.display !== 'none') {
          if (typeof window.fecharModalConfigReprodutivo === 'function') {
            window.fecharModalConfigReprodutivo();
          }
        }
      }
    });
  });
})();

// Garantir que as vari√°veis globais estejam definidas
if (typeof window.simulacaoAtiva === 'undefined') {
  window.simulacaoAtiva = false;
}
console.log('‚úÖ Vari√°veis globais inicializadas');
if (typeof window.intervaloSimulacao === 'undefined') {
  window.intervaloSimulacao = null;
}
if (typeof window.contadorSimulacao === 'undefined') {
  window.contadorSimulacao = 0;
}
if (typeof window.totalRegistrosSimulacao === 'undefined') {
  window.totalRegistrosSimulacao = 139; // Total de registros a processar
}

// Definir fun√ß√£o iniciarSimulacao imediatamente (antes do bot√£o)
// NOTA: window.iniciarSimulacao j√° foi definida anteriormente (linha 3315)
// Esta defini√ß√£o duplicada foi removida para evitar conflitos

// Sistema de notifica√ß√µes toast
function mostrarToast(mensagem, tipo = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  
  const toast = document.createElement('div');
  toast.className = `toast-curral ${tipo}`;
  
  const icone = tipo === 'success' ? '‚úì' : tipo === 'error' ? '‚úï' : tipo === 'warning' ? '‚ö†' : '‚Ñπ';
  toast.innerHTML = `
    <span style="font-size: 1.2rem;">${icone}</span>
    <span style="flex: 1;">${mensagem}</span>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Sistema de loading
function mostrarLoading(mostrar = true) {
  const overlay = document.getElementById('loadingOverlay');
  if (!overlay) return;
  if (mostrar) {
    overlay.classList.add('show');
  } else {
    overlay.classList.remove('show');
  }
}

// ========== SISTEMA DE IDENTIFICA√á√ÉO E PESAGEM - L√ìGICA SIMPLIFICADA ==========
// NOTA: A fun√ß√£o window.buscarBrincoSimples j√° foi definida no in√≠cio do arquivo (extra_css)
// Esta √© uma vers√£o de fallback caso a primeira n√£o tenha sido carregada

// Fun√ß√£o principal para buscar e identificar brinco (vers√£o de fallback)
if (typeof window.buscarBrincoSimples === 'undefined') {
  window.buscarBrincoSimples = async function() {
  try {
    const campo = document.getElementById('brincoInputV2');
    if (!campo) {
      console.error('Campo brincoInputV2 n√£o encontrado');
      return;
    }
    
    const valor = campo.value.trim();
    if (!valor || valor.length < 3) {
      if (typeof mostrarToast === 'function') {
        mostrarToast('Digite pelo menos 3 caracteres para buscar.', 'warning');
      } else {
        alert('Digite pelo menos 3 caracteres para buscar.');
      }
      return;
    }
    
    console.log('üîç buscarBrincoSimples chamado com:', valor);
    console.log('üìç URL atual:', window.location.pathname);
    
    // Se identificarBrinco j√° estiver dispon√≠vel (carregada ap√≥s DOMContentLoaded), usar ela
    if (typeof identificarBrinco === 'function') {
      console.log('‚úÖ Usando fun√ß√£o identificarBrinco existente');
      console.log('üîó identificarUrl:', typeof identificarUrl !== 'undefined' ? identificarUrl : 'n√£o definido');
      identificarBrinco(valor);
      return;
    }
    
    // Caso contr√°rio, fazer busca direta (fallback)
    console.log('‚ö†Ô∏è identificarBrinco n√£o dispon√≠vel, fazendo busca direta...');
    
    // Obter ID da propriedade da URL
    const propriedadeId = window.location.pathname.match(/propriedade\/(\d+)/);
    if (!propriedadeId) {
      console.error('‚ùå N√£o foi poss√≠vel extrair propriedadeId da URL:', window.location.pathname);
      alert('Erro: n√£o foi poss√≠vel determinar a propriedade.');
      return;
    }
    
    console.log('üè¢ Propriedade ID extra√≠da:', propriedadeId[1]);
    
    // Mostrar loading
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.add('show');
    
    // Fazer requisi√ß√£o
    const url = `/propriedade/${propriedadeId[1]}/curral/api/identificar/?codigo=${encodeURIComponent(valor)}`;
    console.log('üåê Fazendo requisi√ß√£o para:', url);
    const response = await fetch(url, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    });
    
    // Tratar erros HTTP antes de tentar parsear JSON
    if (!response.ok) {
      // Se for 404, tentar verificar se √© um erro de endpoint ou brinco n√£o encontrado
      if (response.status === 404) {
        // Tentar parsear a resposta para ver se tem mensagem √∫til
        try {
          const errorData = await response.json();
          if (errorData.status === 'estoque') {
            // Brinco est√° no estoque
            if (loadingOverlay) loadingOverlay.classList.remove('show');
            if (typeof window.abrirCadastroEstoqueV2 === 'function') {
              window.abrirCadastroEstoqueV2(errorData.dados || {}, valor);
            } else if (typeof abrirCadastroEstoqueV2 === 'function') {
              abrirCadastroEstoqueV2(errorData.dados || {}, valor);
            }
            return;
          }
          throw new Error(errorData.mensagem || `Erro ${response.status}`);
        } catch (parseError) {
          throw new Error(`Brinco n√£o encontrado (Erro ${response.status})`);
        }
      }
      throw new Error(`Erro ${response.status}`);
    }
    
    const data = await response.json();
    console.log('üì¶ Resposta recebida:', data);
    console.log('üìä Status da resposta:', data.status);
    console.log('üí¨ Mensagem:', data.mensagem || 'sem mensagem');
    
    // Esconder loading
    if (loadingOverlay) loadingOverlay.classList.remove('show');
    
    // Processar resposta
    if (data.status === 'animal') {
      console.log('‚úÖ Animal encontrado! Dados:', data.dados);
      processarAnimalIdentificado(data.dados);
    } else if (data.status === 'estoque') {
      console.log('üì¶ Brinco encontrado no estoque - abrindo cadastro autom√°tico');
      // Abrir cadastro autom√°tico quando brinco est√° no estoque
      if (typeof abrirCadastroEstoqueV2 === 'function') {
        abrirCadastroEstoqueV2(data.dados || {}, valor);
      } else if (typeof window.abrirCadastroEstoqueV2 === 'function') {
        window.abrirCadastroEstoqueV2(data.dados || {}, valor);
      } else {
        // Fallback: mostrar toast e tentar abrir manualmente
        mostrarToast('Brinco encontrado no estoque. Preencha os dados para cadastrar.', 'info');
        const overlay = document.getElementById('estoqueCadastroOverlayV2');
        if (overlay) {
          overlay.classList.add('show');
        }
      }
    } else if (data.status === 'estoque_multiplos') {
      console.log('üì¶ M√∫ltiplos brincos encontrados - mostrando lista para escolha');
      // Mostrar modal de sele√ß√£o de brinco
      mostrarSelecaoBrincoMultiplo(data.brincos || [], data.codigo_lido || valor);
    } else if (data.status === 'animal_externo') {
      console.log('‚ö†Ô∏è Animal em outra propriedade');
      // Fechar popup se estiver aberto
      if (typeof window.fecharPopupBrinco === 'function') {
        window.fecharPopupBrinco();
      }
      if (typeof mostrarToast === 'function') {
        mostrarToast(data.mensagem || 'Animal pertence a outra propriedade.', 'warning');
      } else {
        alert(data.mensagem || 'Animal pertence a outra propriedade.');
      }
    } else {
      console.log('‚ùå Brinco n√£o encontrado. Status:', data.status);
      // Fechar popup se estiver aberto
      if (typeof window.fecharPopupBrinco === 'function') {
        window.fecharPopupBrinco();
      }
      // Tentar verificar se est√° no estoque antes de mostrar erro
      if (typeof mostrarToast === 'function') {
        mostrarToast(data.mensagem || 'Brinco n√£o encontrado. Verifique se est√° no estoque.', 'warning');
      } else {
        alert(data.mensagem || 'Brinco n√£o encontrado.');
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao buscar brinco:', error);
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.remove('show');
    
    // Fechar popup de confirma√ß√£o se estiver aberto
    if (typeof window.fecharPopupBrinco === 'function') {
      window.fecharPopupBrinco();
    }
    
    // Mostrar erro de forma mais amig√°vel
    const errorMessage = error.message || 'Erro desconhecido';
    if (typeof mostrarToast === 'function') {
      mostrarToast('Erro ao buscar brinco: ' + errorMessage, 'error');
    } else {
      alert('Erro ao buscar brinco: ' + errorMessage);
    }
  }
  } // Fim do if (typeof window.buscarBrincoSimples === 'undefined')

// Fun√ß√£o para atualizar cards de estat√≠sticas
window.atualizarEstatisticasAnimais = function() {
  console.log('üìä [ATUALIZAR ESTAT√çSTICAS] Iniciando atualiza√ß√£o...');
  
  if (!window.estatisticasAnimais) {
    console.error('‚ùå window.estatisticasAnimais n√£o est√° definido!');
    // Inicializar se n√£o existir
    window.estatisticasAnimais = {
      identificados: 0,
      cadastrados: 0,
      processados: 0
    };
  }
  
  const stats = window.estatisticasAnimais;
  console.log('üìä [ATUALIZAR ESTAT√çSTICAS] Estado atual:', stats);
  
  // Calcular total (soma de identificados + cadastrados)
  const total = (stats.identificados || 0) + (stats.cadastrados || 0);
  
  // Atualizar cards
  const totalEl = document.getElementById('statsTotalTrabalhados');
  const identificadosEl = document.getElementById('statsIdentificados');
  const cadastradosEl = document.getElementById('statsCadastrados');
  const processadosEl = document.getElementById('statsProcessados');
  
  console.log('üìä [ATUALIZAR ESTAT√çSTICAS] Elementos encontrados:', {
    totalEl: !!totalEl,
    identificadosEl: !!identificadosEl,
    cadastradosEl: !!cadastradosEl,
    processadosEl: !!processadosEl
  });
  
  if (totalEl) {
    totalEl.textContent = total;
    console.log('‚úÖ Total atualizado:', total);
  } else {
    console.error('‚ùå Elemento statsTotalTrabalhados n√£o encontrado!');
  }
  
  if (identificadosEl) {
    identificadosEl.textContent = stats.identificados || 0;
    console.log('‚úÖ Identificados atualizado:', stats.identificados || 0);
  } else {
    console.error('‚ùå Elemento statsIdentificados n√£o encontrado!');
  }
  
  if (cadastradosEl) {
    cadastradosEl.textContent = stats.cadastrados || 0;
    console.log('‚úÖ Cadastrados atualizado:', stats.cadastrados || 0);
  } else {
    console.error('‚ùå Elemento statsCadastrados n√£o encontrado!');
  }
  
  if (processadosEl) {
    processadosEl.textContent = stats.processados || 0;
    // For√ßar reflow para garantir que a atualiza√ß√£o seja vis√≠vel
    processadosEl.offsetHeight;
    console.log('‚úÖ Processados atualizado:', stats.processados || 0);
  } else {
    console.error('‚ùå Elemento statsProcessados n√£o encontrado!');
    // Tentar encontrar com querySelector como fallback
    const processadosElAlt = document.querySelector('[id*="Processados"], [id*="processados"]');
    if (processadosElAlt) {
      processadosElAlt.textContent = stats.processados || 0;
      console.log('‚úÖ Processados atualizado via fallback');
    }
  }
  
  // Verificar se as atualiza√ß√µes foram aplicadas
  const totalVerificado = totalEl ? parseInt(totalEl.textContent) || 0 : 0;
  const processadosVerificado = processadosEl ? parseInt(processadosEl.textContent) || 0 : 0;
  
  console.log('üìä [ATUALIZAR ESTAT√çSTICAS] Valores verificados:', {
    total: totalVerificado,
    processados: processadosVerificado,
    esperado: { total, processados: stats.processados || 0 }
  });
  
  if (processadosVerificado !== (stats.processados || 0)) {
    console.error('‚ùå ERRO: Valor de Processados n√£o foi atualizado corretamente!');
    console.error('üìä Tentando for√ßar atualiza√ß√£o novamente...');
    // Tentar novamente ap√≥s um pequeno delay
    setTimeout(() => {
      if (processadosEl) {
        processadosEl.textContent = stats.processados || 0;
        processadosEl.offsetHeight;
        console.log('‚úÖ Processados for√ßado para:', stats.processados || 0);
      }
    }, 100);
  }
  
  console.log('‚úÖ [ATUALIZAR ESTAT√çSTICAS] Atualiza√ß√£o conclu√≠da');
};

// Processar animal identificado e atualizar interface (dispon√≠vel globalmente)
window.processarAnimalIdentificado = function(dados) {
  console.log('‚úÖ Animal identificado:', dados);
  
  // Tocar aviso sonoro discreto para identifica√ß√£o
  if (typeof window.tocarAvisoSonoro === 'function') {
    window.tocarAvisoSonoro('identificacao');
  }
  
  // Rastrear estat√≠sticas: verificar se animal j√° existia (tem ID) ou √© novo
  if (window.estatisticasAnimais) {
    if (dados.id) {
      // Animal j√° cadastrado no sistema
      window.estatisticasAnimais.cadastrados++;
    } else {
      // Animal novo identificado
      window.estatisticasAnimais.identificados++;
    }
    // Total √© calculado automaticamente (identificados + cadastrados)
    window.atualizarEstatisticasAnimais();
  }
  
  // Armazenar dados do animal atual
  window.animalAtualV2 = dados;
  
  // Preparar dados no formato esperado pelas fun√ß√µes existentes
  const racaCompletaPopup = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(dados.raca) : (dados.raca || '');
  const dadosPopup = {
    brinco: dados.numero_brinco || dados.codigo_sisbov || '',
    codigo_sisbov: dados.codigo_sisbov || dados.numero_brinco || '',
    numero_manejo: dados.numero_manejo || '',
    situacao_bnd: dados.situacao_bnd || '',
    consta_bnd: dados.consta_bnd || false,
    raca: racaCompletaPopup,
    sexo: dados.sexo || '',
    data_nascimento: dados.data_nascimento || dados.data_nascimento_format || '',
    ultimo_peso: dados.peso_atual || (dados.pesagem_atual && dados.pesagem_atual.peso) || '',
    lote: dados.lote_atual || dados.lote || '',
    status_reprodutivo: dados.status_reprodutivo || ''
  };
  
  // Atualizar campo de brinco
  const brincoInput = document.getElementById('brincoInputV2');
  if (brincoInput && dadosPopup.brinco) {
    brincoInput.value = dadosPopup.brinco;
  }
  
  // Fun√ß√£o para tentar atualizar quando as fun√ß√µes estiverem dispon√≠veis
  function tentarAtualizar() {
    let sucesso = false;
    
    // Usar as fun√ß√µes existentes que j√° est√£o implementadas (agora globais)
    // IMPORTANTE: Passar dados originais (dados), n√£o dadosPopup simplificado
    if (typeof window.atualizarScannerResumoV2 === 'function') {
      console.log('üìù Atualizando resumo do scanner com atualizarScannerResumoV2 (dados originais)');
      window.atualizarScannerResumoV2(dados);
      sucesso = true;
    } else {
      console.log('‚ö†Ô∏è atualizarScannerResumoV2 n√£o encontrada, usando atualizarResumoScanner');
      if (typeof atualizarResumoScanner === 'function') {
        atualizarResumoScanner(dados);
      }
    }
    
    // Atualizar ficha cadastral V4
    if (typeof window.atualizarFichaCadastralV4 === 'function') {
      console.log('üìã Atualizando ficha cadastral V4');
      window.atualizarFichaCadastralV4(dados);
      sucesso = true;
    } else {
      console.warn('‚ö†Ô∏è atualizarFichaCadastralV4 n√£o encontrada');
    }
    
    // Atualizar informa√ß√µes de pesagem individual
    if (typeof window.atualizarResumoPesagemV2 === 'function') {
      console.log('‚öñÔ∏è Atualizando informa√ß√µes de pesagem individual');
      window.atualizarResumoPesagemV2(dados);
    } else if (typeof atualizarInfoPesagem === 'function') {
      atualizarInfoPesagem(dados);
    }
    
    // Abrir popup usando a fun√ß√£o existente (agora global)
    if (typeof window.abrirPopupBrinco === 'function') {
      console.log('üîî Abrindo popup com abrirPopupBrinco');
      window.abrirPopupBrinco(dadosPopup);
      sucesso = true;
    } else {
      console.log('‚ö†Ô∏è abrirPopupBrinco n√£o encontrada, usando abrirPopupConfirmacao');
      abrirPopupConfirmacao(dados);
    }
    
    return sucesso;
  }
  
  // Tentar atualizar imediatamente
  if (!tentarAtualizar()) {
    // Se as fun√ß√µes n√£o estiverem dispon√≠veis, aguardar e tentar novamente
    console.log('‚è≥ Fun√ß√µes n√£o dispon√≠veis, aguardando carregamento...');
    let tentativas = 0;
    const intervalo = setInterval(() => {
      tentativas++;
      if (tentarAtualizar() || tentativas >= 10) {
        clearInterval(intervalo);
        if (tentativas >= 10) {
          console.warn('‚ö†Ô∏è Fun√ß√µes n√£o carregaram ap√≥s 10 tentativas');
        }
      }
    }, 200);
  }
  
  // Atualizar vari√°vel global para compatibilidade
  if (typeof currentAnimalV2 !== 'undefined') {
    currentAnimalV2 = dados;
  }
}

// Atualizar resumo do scanner (card de identifica√ß√£o)
function atualizarResumoScanner(dados) {
  console.log('üìù atualizarResumoScanner chamado com:', dados);
  
  // Formatar peso de forma segura
  let pesoFormatado = '‚Äî';
  if (dados.peso_atual) {
    const peso = typeof dados.peso_atual === 'number' ? dados.peso_atual : parseFloat(dados.peso_atual);
    if (!isNaN(peso) && peso > 0) {
      pesoFormatado = `${peso.toFixed(1).replace('.', ',')} kg`;
    }
  }
  
  // Formatar ra√ßa/sexo
  const raca = dados.raca || '';
  const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(raca) : raca;
  const sexo = dados.sexo || '';
  const racaSexo = [racaCompleta, sexo].filter(Boolean).join(' ¬∑ ') || '‚Äî';
  
  // C√≥digo Eletr√¥nico (usado para leitura por radio frequ√™ncia)
  const codigoEletronico = dados.codigo_eletronico || '';
  const codigoEletronicoFormatado = (codigoEletronico && codigoEletronico !== 'None' && codigoEletronico !== '') ? codigoEletronico : '‚Äî';
  const sisbov = dados.codigo_sisbov || dados.numero_brinco || '‚Äî';
  
  const elementos = {
    scannerCodigoEletronicoV2: codigoEletronicoFormatado,
    scannerSisbovV2: sisbov,
    scannerNumeroManejoV2: dados.numero_manejo || '‚Äî',
    scannerRacaSexoV2: racaSexo,
    scannerDataNascV2: dados.data_nascimento_format || dados.data_nascimento || '‚Äî',
    scannerUltimoPesoV2: pesoFormatado
  };
  
  console.log('üìã Elementos a atualizar:', elementos);
  
  Object.entries(elementos).forEach(([id, valor]) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = valor;
      console.log(`‚úÖ ${id} atualizado para: ${valor}`);
    } else {
      console.warn(`‚ö†Ô∏è Elemento ${id} n√£o encontrado`);
    }
  });
}

// Atualizar informa√ß√µes de pesagem
function atualizarInfoPesagem(dados) {
  console.log('üìä atualizarInfoPesagem chamada com dados:', dados);
  
  const pesagem = dados.pesagem_atual || {};
  const ultimoPeso = pesagem.peso || dados.peso_atual || null;
  const ultimaData = pesagem.data || dados.data_peso_atual || null;
  
  // O backend retorna pesagem_anterior como objeto {peso, data, data_hora}
  const pesagemAnterior = dados.pesagem_anterior;
  const pesoAnterior = pesagemAnterior && pesagemAnterior.peso ? parseFloat(pesagemAnterior.peso) : null;
  // Usar data_hora se dispon√≠vel (tem hora), sen√£o usar data (s√≥ data)
  const dataPesoAnterior = pesagemAnterior && pesagemAnterior.data_hora ? pesagemAnterior.data_hora : (pesagemAnterior && pesagemAnterior.data ? pesagemAnterior.data : null);
  
  console.log('üìä Dados de pesagem:', {
    ultimoPeso: ultimoPeso,
    ultimaData: ultimaData,
    pesoAnterior: pesoAnterior,
    dataPesoAnterior: dataPesoAnterior,
    pesagemAnterior: pesagemAnterior
  });
  
  // √öltimo peso (deve mostrar o peso da pesagem ANTERIOR, n√£o a atual)
  const pesoUltimoValor = document.getElementById('pesoUltimoValorV2');
  if (pesoUltimoValor) {
    // Usar pesoAnterior se dispon√≠vel (pesagem anterior)
    if (pesoAnterior !== null && !isNaN(pesoAnterior)) {
      pesoUltimoValor.textContent = `${pesoAnterior.toFixed(1).replace('.', ',')} kg`;
      console.log('‚úÖ Campo "√öltimo Peso" atualizado com peso anterior:', pesoAnterior);
    } else if (ultimoPeso) {
      // Se n√£o h√° peso anterior, mostrar o peso atual como √∫ltimo
      const peso = typeof ultimoPeso === 'number' ? ultimoPeso : parseFloat(ultimoPeso);
      if (!isNaN(peso) && peso > 0) {
        pesoUltimoValor.textContent = `${peso.toFixed(1).replace('.', ',')} kg`;
        console.log('‚ö†Ô∏è Sem peso anterior, mostrando peso atual como √∫ltimo:', peso);
      } else {
        pesoUltimoValor.textContent = '‚Äî';
      }
    } else {
      pesoUltimoValor.textContent = '‚Äî';
    }
  }
  
  // Peso Atual (mostra o peso atual do animal)
  const pesoAtualValor = document.getElementById('pesoAtualValorV2');
  if (pesoAtualValor) {
    if (ultimoPeso) {
      const peso = typeof ultimoPeso === 'number' ? ultimoPeso : parseFloat(ultimoPeso);
      if (!isNaN(peso) && peso > 0) {
        pesoAtualValor.textContent = `${peso.toFixed(1).replace('.', ',')} kg`;
        console.log('‚úÖ Campo "Peso Atual" atualizado:', peso);
      } else {
        pesoAtualValor.textContent = '‚Äî';
      }
    } else {
      pesoAtualValor.textContent = '‚Äî';
    }
  }
  
  // Per√≠odos em Dias (calcula dias desde a √∫ltima pesagem)
  const periodoDiasValor = document.getElementById('periodoDiasValorV2');
  if (periodoDiasValor) {
    try {
      let dataReferencia = null;
      
      // Priorizar dataPesoAnterior (pesagem anterior)
      if (dataPesoAnterior) {
        if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
          dataReferencia = new Date(dataPesoAnterior);
        } else {
          dataReferencia = new Date(dataPesoAnterior + 'T00:00:00');
        }
      } else if (ultimaData) {
        if (ultimaData.includes('T') || ultimaData.includes(' ')) {
          dataReferencia = new Date(ultimaData);
        } else {
          dataReferencia = new Date(ultimaData + 'T00:00:00');
        }
      }
      
      if (dataReferencia && !isNaN(dataReferencia.getTime())) {
        const dataAtual = new Date();
        const diffMs = dataAtual.getTime() - dataReferencia.getTime();
        const dias = Math.max(0, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
        periodoDiasValor.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
        console.log('‚úÖ Campo "Per√≠odos em Dias" calculado:', dias, 'dias');
      } else {
        periodoDiasValor.textContent = '‚Äî';
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel calcular per√≠odo em dias (data inv√°lida)');
      }
    } catch (e) {
      console.error('‚ùå Erro ao calcular per√≠odo em dias:', e);
      periodoDiasValor.textContent = '‚Äî';
    }
  }
  
  // Data √∫ltima pesagem (deve mostrar a data da pesagem ANTERIOR, n√£o a atual)
  const pesoUltimoData = document.getElementById('pesoUltimoDataV2');
  if (pesoUltimoData) {
    // Usar dataPesoAnterior se dispon√≠vel (pesagem anterior)
    if (dataPesoAnterior) {
      try {
        // Se dataPesoAnterior j√° tem hora (formato ISO completo), usar diretamente
        // Se n√£o, adicionar T00:00:00 para criar um objeto Date v√°lido
        let dataAnteriorObj;
        if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
          // J√° tem hora no formato ISO ou datetime
          dataAnteriorObj = new Date(dataPesoAnterior);
        } else {
          // S√≥ tem data, adicionar hora padr√£o (mas isso n√£o √© ideal)
          dataAnteriorObj = new Date(dataPesoAnterior + 'T00:00:00');
        }
        
        if (!isNaN(dataAnteriorObj.getTime())) {
          pesoUltimoData.textContent = dataAnteriorObj.toLocaleDateString('pt-BR') + ' ' + dataAnteriorObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          console.log('‚úÖ Campo "Data √öltima Pesagem" atualizado com data anterior:', dataPesoAnterior, '‚Üí', pesoUltimoData.textContent);
        } else {
          pesoUltimoData.textContent = dataPesoAnterior;
        }
      } catch (e) {
        console.error('‚ùå Erro ao formatar data anterior:', e);
        pesoUltimoData.textContent = dataPesoAnterior;
      }
    } else if (ultimaData) {
      // Se n√£o h√° data anterior, mostrar a data atual
      try {
        let dataObj;
        if (ultimaData.includes('T') || ultimaData.includes(' ')) {
          dataObj = new Date(ultimaData);
        } else {
          dataObj = new Date(ultimaData + 'T00:00:00');
        }
        
        if (!isNaN(dataObj.getTime())) {
          pesoUltimoData.textContent = dataObj.toLocaleDateString('pt-BR') + ' ' + dataObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          console.log('‚ö†Ô∏è Sem data anterior, mostrando data atual como √∫ltima');
        } else {
          pesoUltimoData.textContent = ultimaData;
        }
      } catch (e) {
        pesoUltimoData.textContent = ultimaData;
      }
    } else {
      pesoUltimoData.textContent = '‚Äî';
    }
  }
  
  // Calcular dias desde √∫ltima pesagem (usar dataPesoAnterior se dispon√≠vel)
  const pesoDias = document.getElementById('pesoDiasV2');
  if (pesoDias) {
    try {
      let dataReferencia = null;
      
      // Priorizar dataPesoAnterior (pesagem anterior)
      if (dataPesoAnterior) {
        if (dataPesoAnterior.includes('T') || dataPesoAnterior.includes(' ')) {
          dataReferencia = new Date(dataPesoAnterior);
        } else {
          dataReferencia = new Date(dataPesoAnterior + 'T00:00:00');
        }
      } else if (ultimaData) {
        if (ultimaData.includes('T') || ultimaData.includes(' ')) {
          dataReferencia = new Date(ultimaData);
        } else {
          dataReferencia = new Date(ultimaData + 'T00:00:00');
        }
      }
      
      if (dataReferencia && !isNaN(dataReferencia.getTime())) {
        const dataAtual = new Date();
        const diffMs = dataAtual.getTime() - dataReferencia.getTime();
        const dias = Math.max(0, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
        pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
        console.log('‚úÖ Campo "Dias desde a √∫ltima" calculado:', dias, 'dias');
      } else {
    pesoDias.textContent = '‚Äî';
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel calcular dias (data inv√°lida)');
      }
    } catch (e) {
      console.error('‚ùå Erro ao calcular dias:', e);
      pesoDias.textContent = '‚Äî';
    }
  }
  
  // Calcular Ganho Total e Ganho Di√°rio M√©dio
  const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
  const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
  
  // O backend retorna pesagem_anterior como objeto {peso, data, data_hora}
  if (pesoGanhoTotal && ultimoPeso && pesoAnterior !== null && !isNaN(pesoAnterior)) {
    const pesoAtual = typeof ultimoPeso === 'number' ? ultimoPeso : parseFloat(ultimoPeso);
    if (!isNaN(pesoAtual) && pesoAtual > 0) {
      const ganhoTotal = pesoAtual - pesoAnterior;
      pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
      console.log('‚úÖ Ganho Total calculado em atualizarInfoPesagem:', ganhoTotal);
    } else {
      pesoGanhoTotal.textContent = '‚Äî';
    }
  } else if (pesoGanhoTotal) {
    pesoGanhoTotal.textContent = '‚Äî';
    console.log('‚ö†Ô∏è N√£o foi poss√≠vel calcular Ganho Total (sem peso anterior ou peso atual)');
  }
  
  if (pesoGanhoDia && ultimoPeso && pesoAnterior !== null && !isNaN(pesoAnterior) && dataPesoAnterior) {
    try {
      const pesoAtual = typeof ultimoPeso === 'number' ? ultimoPeso : parseFloat(ultimoPeso);
      if (!isNaN(pesoAtual) && pesoAtual > 0) {
        const dataAnterior = new Date(dataPesoAnterior + 'T00:00:00'); // Adiciona hora para evitar problemas de timezone
        const dataAtual = ultimaData ? new Date(ultimaData + 'T00:00:00') : new Date();
        const diffMs = dataAtual.getTime() - dataAnterior.getTime();
        const dias = Math.max(1, Math.floor(diffMs / (1000 * 60 * 60 * 24)));
        const ganhoTotal = pesoAtual - pesoAnterior;
        const ganhoDia = ganhoTotal / dias;
        
        pesoGanhoDia.textContent = `${ganhoDia >= 0 ? '+' : ''}${ganhoDia.toFixed(2).replace('.', ',')} kg/dia`;
        console.log('‚úÖ Ganho Di√°rio calculado em atualizarInfoPesagem:', ganhoDia, 'kg/dia em', dias, 'dias');
      } else {
        pesoGanhoDia.textContent = '‚Äî';
      }
    } catch (error) {
      console.error('‚ùå Erro ao calcular ganho di√°rio em atualizarInfoPesagem:', error);
      if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
    }
  } else if (pesoGanhoDia) {
    pesoGanhoDia.textContent = '‚Äî';
    console.log('‚ö†Ô∏è N√£o foi poss√≠vel calcular Ganho Di√°rio (sem dados anteriores)');
  }
  
  // Atualizar gr√°fico de evolu√ß√£o das √∫ltimas 3 pesagens
  console.log('üìä [atualizarInfoPesagem] Chamando atualizarGraficoEvolucaoPeso...');
  console.log('üìä [atualizarInfoPesagem] Dados completos:', dados);
  console.log('üìä [atualizarInfoPesagem] pesagens_historico:', dados.pesagens_historico);
  if (typeof atualizarGraficoEvolucaoPeso === 'function') {
    atualizarGraficoEvolucaoPeso(dados);
  } else {
    console.error('‚ùå [atualizarInfoPesagem] Fun√ß√£o atualizarGraficoEvolucaoPeso n√£o encontrada!');
  }
}

// Fun√ß√£o para atualizar o gr√°fico de evolu√ß√£o das √∫ltimas 3 pesagens
let graficoEvolucaoPeso = null;

function atualizarGraficoEvolucaoPeso(dados) {
  console.log('üìä ========== ATUALIZAR GR√ÅFICO ==========');
  console.log('üìä Dados completos recebidos:', dados);
  
  const container = document.getElementById('pesoGraficoContainerV2');
  const canvas = document.getElementById('pesoGraficoEvolucaoV2');
  
  console.log('üìä Elementos do gr√°fico:', { 
    container: container ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO',
    canvas: canvas ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO',
    containerId: 'pesoGraficoContainerV2',
    canvasId: 'pesoGraficoEvolucaoV2'
  });
  
  if (!container || !canvas) {
    console.error('‚ùå Elementos do gr√°fico n√£o encontrados!', { container: !!container, canvas: !!canvas });
    console.error('‚ùå Tentando encontrar elementos manualmente...');
    const allContainers = document.querySelectorAll('[id*="grafico"], [id*="Grafico"]');
    console.log('üìä Elementos com "grafico" no ID:', allContainers);
    return;
  }
  
  // Buscar hist√≥rico de pesagens
  const pesagensHistorico = dados.pesagens_historico || [];
  
  console.log('üìä Hist√≥rico de pesagens recebido:', pesagensHistorico);
  console.log('üìä Total de pesagens no hist√≥rico:', pesagensHistorico.length);
  console.log('üìä Tipo de pesagensHistorico:', typeof pesagensHistorico, Array.isArray(pesagensHistorico));
  
  // Se n√£o h√° hist√≥rico suficiente, ocultar o gr√°fico
  if (!pesagensHistorico || pesagensHistorico.length < 2) {
    console.warn('‚ö†Ô∏è Hist√≥rico insuficiente para exibir gr√°fico. Necess√°rio: 2+, Recebido:', pesagensHistorico.length);
    console.warn('‚ö†Ô∏è Ocultando container do gr√°fico');
    container.style.display = 'none';
    if (graficoEvolucaoPeso) {
      graficoEvolucaoPeso.destroy();
      graficoEvolucaoPeso = null;
    }
    return;
  }
  
  console.log('‚úÖ Hist√≥rico suficiente! Prosseguindo com cria√ß√£o do gr√°fico...');
  
  // Pegar as √∫ltimas 3 pesagens (ou menos se n√£o houver 3)
  const ultimasPesagens = pesagensHistorico.slice(0, 3).reverse(); // Reverter para ordem cronol√≥gica
  
  console.log('üìä √öltimas pesagens processadas:', ultimasPesagens);
  
  // Preparar dados para o gr√°fico
  const labels = ultimasPesagens.map((p, index) => {
    if (p.data) {
      try {
        const data = new Date(p.data);
        // Formato: DD/MM
        const labelFormatado = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        console.log(`üìä Label ${index + 1}:`, p.data, '‚Üí', labelFormatado);
        return labelFormatado;
      } catch (e) {
        console.warn(`‚ö†Ô∏è Erro ao formatar label ${index + 1}:`, e);
        return `Pesagem ${index + 1}`;
      }
    }
    return `Pesagem ${index + 1}`;
  });
  
  const pesos = ultimasPesagens.map((p, index) => {
    const peso = p.peso || 0;
    const pesoNum = typeof peso === 'number' ? peso : parseFloat(peso) || 0;
    console.log(`üìä Peso ${index + 1}:`, p.peso, '‚Üí', pesoNum);
    return pesoNum;
  });
  
  console.log('üìä Labels finais:', labels);
  console.log('üìä Pesos finais:', pesos);
  
  // Mostrar container
  console.log('üìä Exibindo container do gr√°fico...');
  container.style.display = 'block';
  console.log('üìä Container display ap√≥s set:', container.style.display);
  
  // Destruir gr√°fico anterior se existir
  if (graficoEvolucaoPeso) {
    console.log('üìä Destruindo gr√°fico anterior...');
    graficoEvolucaoPeso.destroy();
    graficoEvolucaoPeso = null;
  }
  
  // Verificar se Chart.js est√° dispon√≠vel
  if (typeof Chart === 'undefined') {
    console.error('‚ùå Chart.js n√£o est√° carregado! Verifique se o CDN est√° inclu√≠do.');
    container.style.display = 'none';
    return;
  }
  
  console.log('üìä Chart.js dispon√≠vel, criando novo gr√°fico...');
  console.log('üìä Canvas dimensions:', { width: canvas.width, height: canvas.height, offsetWidth: canvas.offsetWidth, offsetHeight: canvas.offsetHeight });
  
  // Criar novo gr√°fico
  const ctx = canvas.getContext('2d');
  console.log('üìä Contexto do canvas obtido:', ctx ? 'OK' : 'ERRO');
  
  try {
    graficoEvolucaoPeso = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Peso (kg)',
        data: pesos,
        borderColor: '#4caf50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4, // Suaviza a linha
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: '#4caf50',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverBackgroundColor: '#2e7d32',
        pointHoverBorderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: {
            size: 12,
            weight: 'bold'
          },
          bodyFont: {
            size: 11
          },
          padding: 10,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return `Peso: ${context.parsed.y.toFixed(1).replace('.', ',')} kg`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: Math.max(0, Math.min(...pesos) - 10), // M√≠nimo 10kg abaixo do menor peso
          max: Math.max(...pesos) + 10, // M√°ximo 10kg acima do maior peso
          ticks: {
            font: {
              size: 10
            },
            callback: function(value) {
              return value.toFixed(0) + ' kg';
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 10
            }
          },
          grid: {
            display: false
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
  
  console.log('‚úÖ Gr√°fico criado com sucesso!');
  console.log('üìä Gr√°fico objeto:', graficoEvolucaoPeso);
  } catch (error) {
    console.error('‚ùå Erro ao criar gr√°fico:', error);
    console.error('‚ùå Stack trace:', error.stack);
    container.style.display = 'none';
    return;
  }
  
  console.log('‚úÖ Gr√°fico de evolu√ß√£o atualizado com', ultimasPesagens.length, 'pesagens');
  console.log('üìä Dados do gr√°fico:', { labels, pesos });
  console.log('üìä Container vis√≠vel:', container.style.display === 'block' ? 'SIM' : 'N√ÉO');
  console.log('üìä Container computed style:', window.getComputedStyle(container).display);
  console.log('üìä Container offsetHeight:', container.offsetHeight);
  console.log('üìä Canvas offsetHeight:', canvas.offsetHeight);
  console.log('üìä ========== FIM ATUALIZAR GR√ÅFICO ==========');
}

// ========== FUN√á√ïES PARA EDITAR PESAGEM ==========
let ultimoEventoPesagemId = null; // Armazenar ID do √∫ltimo evento de pesagem

function abrirModalEditarPesagem() {
  console.log('üìù Abrindo modal para editar pesagem...');
  
  const modal = document.getElementById('modalEditarPesagem');
  const pesoAtualExibicao = document.getElementById('pesoAtualExibicao');
  const novoPesoInput = document.getElementById('novoPesoInput');
  const pesoRegistrado = document.getElementById('pesoRegistradoV2');
  
  if (!modal) {
    console.error('‚ùå Modal n√£o encontrado!');
    return;
  }
  
  // Obter peso atual do campo "Peso Registrado"
  const pesoAtualTexto = pesoRegistrado ? pesoRegistrado.textContent : '‚Äî';
  const pesoAtual = pesoAtualTexto.replace(' kg', '').replace(',', '.').trim();
  
  if (pesoAtualExibicao) {
    pesoAtualExibicao.textContent = pesoAtualTexto !== '‚Äî' ? pesoAtualTexto : 'N√£o dispon√≠vel';
  }
  
  if (novoPesoInput) {
    novoPesoInput.value = pesoAtual !== '‚Äî' ? pesoAtual.replace('.', ',') : '';
    novoPesoInput.focus();
    novoPesoInput.select();
  }
  
  modal.style.display = 'flex';
  
  // Buscar ID do √∫ltimo evento de pesagem
  buscarUltimoEventoPesagem();
}

function fecharModalEditarPesagem() {
  const modal = document.getElementById('modalEditarPesagem');
  if (modal) {
    modal.style.display = 'none';
  }
}

async function buscarUltimoEventoPesagem() {
  const animalAtual = window.animalAtualV2;
  if (!animalAtual || !animalAtual.id) {
    console.warn('‚ö†Ô∏è Animal n√£o identificado para buscar evento de pesagem');
    return;
  }
  
  const brincoInput = document.getElementById('brincoInputV2');
  if (!brincoInput || !brincoInput.value) {
    console.warn('‚ö†Ô∏è Brinco n√£o encontrado');
    return;
  }
  
  try {
    const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
    const propriedadeId = urlMatch ? urlMatch[1] : null;
    
    if (!propriedadeId) {
      console.error('‚ùå Propriedade ID n√£o encontrada');
      return;
    }
    
    // Buscar dados do animal para obter hist√≥rico de pesagens
    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
    if (response.ok) {
      const data = await response.json();
      if (data.status === 'animal' && data.dados && data.dados.pesagens_historico) {
        const pesagens = data.dados.pesagens_historico;
        if (pesagens && pesagens.length > 0) {
          // A primeira pesagem do hist√≥rico √© a mais recente
          // Mas precisamos do evento_id, que pode n√£o estar no hist√≥rico
          // Vamos usar uma abordagem diferente: buscar o √∫ltimo evento via API
          console.log('üìä Hist√≥rico de pesagens encontrado:', pesagens.length, 'pesagens');
        }
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao buscar √∫ltimo evento de pesagem:', error);
  }
}

async function salvarEdicaoPesagem() {
  console.log('üíæ Salvando edi√ß√£o de pesagem...');
  
  const novoPesoInput = document.getElementById('novoPesoInput');
  const animalAtual = window.animalAtualV2;
  const brincoInput = document.getElementById('brincoInputV2');
  
  if (!novoPesoInput || !novoPesoInput.value) {
    alert('Informe o novo peso.');
    novoPesoInput.focus();
    return;
  }
  
  if (!animalAtual || !animalAtual.id) {
    alert('Animal n√£o identificado. Identifique o animal primeiro.');
    return;
  }
  
  const novoPesoTexto = novoPesoInput.value.replace(',', '.').trim();
  const novoPeso = parseFloat(novoPesoTexto);
  
  if (isNaN(novoPeso) || novoPeso <= 0) {
    alert('O peso deve ser um n√∫mero maior que zero.');
    novoPesoInput.focus();
    return;
  }
  
  const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
  const propriedadeId = urlMatch ? urlMatch[1] : null;
  
  if (!propriedadeId) {
    alert('Erro: N√£o foi poss√≠vel identificar a propriedade.');
    return;
  }
  
    // Buscar o √∫ltimo evento de pesagem do animal
    try {
      // Primeiro, buscar o √∫ltimo evento via API de hist√≥rico
      const responseHistorico = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/${animalAtual.id}/pesagens/`);
      let eventoId = null;
      
      if (responseHistorico.ok) {
        const dataHistorico = await responseHistorico.json();
        if (dataHistorico.status === 'ok' && dataHistorico.historico && dataHistorico.historico.length > 0) {
          // Pegar o primeiro item do hist√≥rico (mais recente) que seja do tipo 'curral'
          const ultimaPesagem = dataHistorico.historico.find(p => p.fonte === 'curral') || dataHistorico.historico[0];
          eventoId = ultimaPesagem.id;
          console.log('‚úÖ ID do √∫ltimo evento encontrado:', eventoId, 'Fonte:', ultimaPesagem.fonte);
        }
      }
    
    if (!eventoId) {
      alert('Erro: N√£o foi poss√≠vel encontrar a pesagem para editar. Certifique-se de que h√° uma pesagem registrada.');
      return;
    }
    
    // Fazer requisi√ß√£o para editar
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/pesagem/editar/`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        evento_id: eventoId,
        animal_id: animalAtual.id,
        peso: novoPeso
      })
    });
    
    const responseData = await response.json();
    
    if (response.ok) {
      console.log('‚úÖ Pesagem editada com sucesso!', responseData);
      
      // Fechar modal
      fecharModalEditarPesagem();
      
      // Atualizar campos visualmente
      const pesoRegistrado = document.getElementById('pesoRegistradoV2');
      if (pesoRegistrado) {
        const pesoFormatado = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
        pesoRegistrado.textContent = pesoFormatado;
        pesoRegistrado.innerText = pesoFormatado;
      }
      
      // Recarregar dados do animal para atualizar hist√≥rico completo
      setTimeout(async () => {
        if (brincoInput && brincoInput.value) {
          try {
            const responseAnimal = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
            if (responseAnimal.ok) {
              const dataAnimal = await responseAnimal.json();
              if (dataAnimal.status === 'animal' && dataAnimal.dados) {
                window.animalAtualV2 = dataAnimal.dados;
                
                // Atualizar todas as informa√ß√µes
                if (typeof window.atualizarScannerResumoV2 === 'function') {
                  window.atualizarScannerResumoV2(dataAnimal.dados);
                }
                if (typeof atualizarInfoPesagem === 'function') {
                  atualizarInfoPesagem(dataAnimal.dados);
                }
                if (typeof atualizarGraficoEvolucaoPeso === 'function') {
                  atualizarGraficoEvolucaoPeso(dataAnimal.dados);
                }
              }
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao recarregar dados ap√≥s edi√ß√£o:', error);
          }
        }
      }, 500);
      
      // Mostrar notifica√ß√£o
      if (typeof mostrarToast === 'function') {
        mostrarToast('Pesagem editada com sucesso!', 'success');
      } else {
        alert('Pesagem editada com sucesso!');
      }
    } else {
      const mensagemErro = responseData.mensagem || responseData.status || 'Erro desconhecido';
      console.error('‚ùå Erro ao editar pesagem:', responseData);
      alert(`Erro ao editar pesagem: ${mensagemErro}`);
    }
  } catch (error) {
    console.error('‚ùå Erro ao editar pesagem:', error);
    alert('Erro ao conectar com o servidor. Verifique sua conex√£o.');
  }
}

  // Habilitar bot√£o Finalizar quando animal for identificado
  if (typeof atualizarBotaoFinalizarV2 === 'function') {
    atualizarBotaoFinalizarV2();
  }
  
  // Mostrar bot√£o de editar quando houver peso registrado
  function atualizarBotaoEditarPesagem() {
  const pesoRegistrado = document.getElementById('pesoRegistradoV2');
  const btnEditar = document.getElementById('btnEditarPesagemV2');
  
  if (pesoRegistrado && btnEditar) {
    const pesoTexto = pesoRegistrado.textContent || '';
    if (pesoTexto !== '‚Äî' && pesoTexto.trim() !== '') {
      btnEditar.style.display = 'inline-block';
    } else {
      btnEditar.style.display = 'none';
    }
  }
}

// ========== FUN√á√ïES PARA COLETAR E REGISTRAR MANEJOS ==========
let manejosSelecionadosV2 = {
  sanidade: [], // Vacinas e medicamentos
  reprodutivo: [], // Diagn√≥sticos e protocolos
  movimentacao: null // Movimenta√ß√£o selecionada
};

// Coletar manejos selecionados das abas
function coletarManejosSelecionadosV2() {
  console.log('üìã Coletando manejos selecionados...');
  
  manejosSelecionadosV2 = {
    sanidade: [],
    reprodutivo: [],
    movimentacao: null
  };
  
  // Coletar vacinas e medicamentos selecionados
  const vacinasSelecionadas = document.querySelectorAll('.sanidade-rapida-btn-v2.active, .sanidade-item-v2.active');
  vacinasSelecionadas.forEach(btn => {
    const tipo = btn.dataset.tipo || 'vacina';
    const nome = btn.dataset.nome || btn.textContent.trim();
    const id = btn.dataset.id || '';
    
    manejosSelecionadosV2.sanidade.push({
      tipo: tipo,
      nome: nome,
      id: id,
      tipo_evento: tipo === 'vacina' ? 'VACINACAO' : 'TRATAMENTO'
    });
  });
  
  // Coletar diagn√≥sticos reprodutivos selecionados
  const diagnosticosSelecionados = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2.active');
  diagnosticosSelecionados.forEach(btn => {
    const diagnostico = btn.dataset.diagnostico || '';
    if (diagnostico) {
      manejosSelecionadosV2.reprodutivo.push({
        tipo: 'diagnostico',
        diagnostico: diagnostico,
        tipo_evento: 'REPRODUCAO'
      });
    }
  });
  
  // Coletar movimenta√ß√£o selecionada
  const movimentacaoSelecionada = document.querySelector('.movimentacao-tipo-btn-v2.active');
  if (movimentacaoSelecionada) {
    manejosSelecionadosV2.movimentacao = {
      tipo: movimentacaoSelecionada.dataset.tipo || '',
      tipo_evento: 'APARTACAO' // Ou outro tipo conforme necess√°rio
    };
  }
  
  console.log('‚úÖ Manejos coletados:', manejosSelecionadosV2);
  return manejosSelecionadosV2;
}

// Registrar todos os manejos coletados
async function registrarManejosColetadosV2(animalId, brinco, peso) {
  console.log('üíæ Registrando manejos coletados...', { animalId, brinco, peso });
  
  const manejos = coletarManejosSelecionadosV2();
  const manejosParaRegistrar = [];
  
  // Adicionar pesagem se houver peso
  if (peso && peso > 0) {
    manejosParaRegistrar.push({
      tipo_evento: 'PESAGEM',
      peso: peso,
      observacoes: 'Pesagem registrada no curral'
    });
  }
  
  // Adicionar manejos de sanidade
  manejos.sanidade.forEach(manejo => {
    manejosParaRegistrar.push({
      tipo_evento: manejo.tipo_evento,
      observacoes: `${manejo.tipo === 'vacina' ? 'Vacina' : 'Medicamento'}: ${manejo.nome}`
    });
  });
  
  // Adicionar manejos reprodutivos
  manejos.reprodutivo.forEach(manejo => {
    manejosParaRegistrar.push({
      tipo_evento: manejo.tipo_evento,
      prenhez_status: manejo.diagnostico,
      observacoes: `Diagn√≥stico: ${manejo.diagnostico}`
    });
  });
  
  // Adicionar movimenta√ß√£o se houver
  if (manejos.movimentacao) {
    manejosParaRegistrar.push({
      tipo_evento: manejos.movimentacao.tipo_evento,
      observacoes: `Movimenta√ß√£o: ${manejos.movimentacao.tipo}`
    });
  }
  
  // Se n√£o h√° manejos para registrar, mas h√° peso, ainda retornar sucesso
  // (a pesagem j√° foi gravada antes)
  // Se n√£o h√° manejos para registrar, retornar sucesso (pesagem j√° foi gravada antes)
  if (manejosParaRegistrar.length === 0) {
    console.log('‚ÑπÔ∏è Nenhum manejo adicional para registrar (pesagem j√° foi gravada anteriormente)');
    return { sucesso: true, mensagem: 'Registro gravado com sucesso!' };
  }
  
  const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
  const propriedadeId = urlMatch ? urlMatch[1] : null;
  
  if (!propriedadeId) {
    return { sucesso: false, mensagem: 'Propriedade n√£o identificada.' };
  }
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  try {
    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/manejos/registrar/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        animal_id: animalId,
        brinco: brinco,
        manejos: manejosParaRegistrar
      })
    });
    
    const responseData = await response.json();
    
    if (response.ok) {
      console.log('‚úÖ Manejos registrados com sucesso!', responseData);
      return { sucesso: true, mensagem: responseData.mensagem, dados: responseData };
    } else {
      console.error('‚ùå Erro ao registrar manejos:', responseData);
      return { sucesso: false, mensagem: responseData.mensagem || 'Erro ao registrar manejos.' };
    }
  } catch (error) {
    console.error('‚ùå Erro ao conectar com servidor:', error);
    return { sucesso: false, mensagem: 'Erro ao conectar com o servidor.' };
  }
}

// Fun√ß√£o principal: Finalizar e Gravar todos os manejos (vers√£o completa)
// Esta fun√ß√£o completa sobrescreve a vers√£o inicial definida acima
window._finalizarEGravarManejosCompleto = async function() {
  console.log('üéØ ========== FINALIZAR E GRAVAR ==========');
  console.log('üéØ Finalizando e gravando todos os manejos...');
  
  const animalAtual = window.animalAtualV2;
  const brincoInput = document.getElementById('brincoInputV2');
  const pesoValor = document.getElementById('pesoValorV2');
  
  if (!animalAtual || !animalAtual.id) {
    alert('Animal n√£o identificado. Identifique o animal primeiro.');
    return;
  }
  
  // Obter peso se houver
  let peso = null;
  if (pesoValor && pesoValor.value) {
    const pesoTexto = pesoValor.value.replace(',', '.').trim();
    peso = parseFloat(pesoTexto);
    if (isNaN(peso) || peso <= 0) {
      peso = null;
    }
  }
  
  console.log('üéØ Dados para gravar:', { animalId: animalAtual.id, brinco: brincoInput ? brincoInput.value : '', peso });
  
  let resultado = { sucesso: false, mensagem: '' };
  let pesagemGravada = false;
  
  // Se houver peso, gravar pesagem primeiro (mais r√°pido e confi√°vel)
  if (peso && peso > 0) {
    console.log('üíæ Gravando pesagem primeiro...');
    try {
      if (typeof window.gravarPesagemDireto === 'function') {
        await window.gravarPesagemDireto();
        console.log('‚úÖ Pesagem gravada com sucesso!');
        pesagemGravada = true;
        resultado = { sucesso: true, mensagem: 'Pesagem registrada com sucesso!' };
        // Aguardar um pouco para garantir que a pesagem foi salva
        await new Promise(resolve => setTimeout(resolve, 300));
      } else {
        console.warn('‚ö†Ô∏è Fun√ß√£o gravarPesagemDireto n√£o encontrada');
        // Mesmo sem a fun√ß√£o, se o animal foi identificado, considerar sucesso
        resultado = { sucesso: true, mensagem: 'Animal processado (fun√ß√£o de pesagem n√£o dispon√≠vel).' };
      }
    } catch (error) {
      console.error('‚ùå Erro ao gravar pesagem:', error);
      // Mesmo com erro, se o animal foi identificado, considerar sucesso parcial
      resultado = { sucesso: true, mensagem: 'Animal processado (erro ao gravar pesagem, mas animal foi identificado).' };
    }
  } else {
    // Mesmo sem peso, se o animal foi identificado, considerar como sucesso
    console.log('‚ÑπÔ∏è Sem peso para gravar, mas animal identificado - considerando como sucesso');
    resultado = { sucesso: true, mensagem: 'Animal processado com sucesso!' };
  }
  
  // Verificar se h√° manejos adicionais para registrar
  let temManejosAdicionais = false;
  if (typeof coletarManejosSelecionadosV2 === 'function') {
    const manejos = coletarManejosSelecionadosV2();
    temManejosAdicionais = manejos.sanidade.length > 0 || manejos.reprodutivo.length > 0 || manejos.movimentacao !== null;
    
    // Se houver manejos adicionais, registrar tamb√©m
    if (temManejosAdicionais) {
      console.log('üíæ Registrando manejos adicionais...');
      if (typeof registrarManejosColetadosV2 === 'function') {
        const resultadoManejos = await registrarManejosColetadosV2(
          animalAtual.id,
          brincoInput ? brincoInput.value : '',
          null // N√£o incluir peso novamente, j√° foi gravado acima
        );
        
        if (resultadoManejos.sucesso) {
          resultado.mensagem = resultadoManejos.mensagem || 'Registro gravado com sucesso!';
          resultado.sucesso = true; // Garantir sucesso
        } else if (!resultado.sucesso) {
          // Se a pesagem falhou, usar o erro dos manejos
          resultado = resultadoManejos;
        }
      } else {
        console.warn('‚ö†Ô∏è Fun√ß√£o registrarManejosColetadosV2 n√£o encontrada');
      }
    }
  } else {
    console.warn('‚ö†Ô∏è Fun√ß√£o coletarManejosSelecionadosV2 n√£o encontrada');
  }
  
  // IMPORTANTE: Sempre atualizar contadores e tabela se o animal foi identificado
  // Mesmo que n√£o tenha peso ou manejos, o animal foi processado
  if (resultado.sucesso || (animalAtual && animalAtual.id)) {
    console.log('‚úÖ Registro gravado com sucesso!');
    
    // IMPORTANTE: Atualizar contadores de estat√≠sticas (Processados)
    // Adicionar aos animais trabalhados para incrementar contador "Processados"
    if (animalAtual && animalAtual.id) {
      console.log('üìä [FINALIZAR E GRAVAR] Atualizando estat√≠sticas...', {
        animalId: animalAtual.id,
        sisbov: animalAtual.codigo_sisbov || animalAtual.numero_brinco,
        peso: peso
      });
      
      // Garantir que window.estatisticasAnimais est√° inicializado
      if (typeof window.estatisticasAnimais === 'undefined') {
        console.warn('‚ö†Ô∏è window.estatisticasAnimais n√£o est√° definido, inicializando...');
        window.estatisticasAnimais = {
          identificados: 0,
          cadastrados: 0,
          processados: 0
        };
      }
      
      const pesoFormatado = peso ? parseFloat(peso.toString().replace(',', '.')).toFixed(1) : '';
      
      // Adicionar aos animais trabalhados (incrementa Processados)
      if (typeof window.adicionarAnimalTrabalhado === 'function') {
        console.log('üìä Chamando adicionarAnimalTrabalhado...');
        window.adicionarAnimalTrabalhado({
          sisbov: animalAtual.codigo_sisbov || animalAtual.numero_brinco || '',
          brinco: animalAtual.numero_manejo || animalAtual.numero_brinco || '',
          peso: pesoFormatado,
          tipo: peso ? 'pesagem' : 'manejo',
          detalhes: `${animalAtual.raca || ''} ${animalAtual.sexo === 'M' ? 'Macho' : animalAtual.sexo === 'F' ? 'F√™mea' : ''} ${pesoFormatado ? `¬∑ ${pesoFormatado} kg` : ''}`.trim(),
          data: new Date().toLocaleString('pt-BR')
        });
        console.log('‚úÖ Animal adicionado aos trabalhados (contador Processados incrementado)');
      } else {
        console.error('‚ùå Fun√ß√£o window.adicionarAnimalTrabalhado n√£o encontrada!');
      }
      
      // Atualizar estat√≠sticas visuais (com m√∫ltiplas tentativas)
      if (typeof window.atualizarEstatisticasAnimais === 'function') {
        console.log('üìä Chamando atualizarEstatisticasAnimais...');
        window.atualizarEstatisticasAnimais();
        console.log('‚úÖ Estat√≠sticas atualizadas. Estado atual:', window.estatisticasAnimais);
        
        // Tentar novamente ap√≥s um pequeno delay (para garantir que o DOM foi atualizado)
        setTimeout(() => {
          console.log('üìä Tentando atualizar estat√≠sticas novamente (segunda tentativa)...');
          window.atualizarEstatisticasAnimais();
        }, 200);
      } else {
        console.error('‚ùå Fun√ß√£o window.atualizarEstatisticasAnimais n√£o encontrada!');
        // Tentar atualizar manualmente como fallback
        console.log('üîÑ Tentando atualizar manualmente como fallback...');
        if (window.estatisticasAnimais) {
          const stats = window.estatisticasAnimais;
          const total = (stats.identificados || 0) + (stats.cadastrados || 0);
          const totalEl = document.getElementById('statsTotalTrabalhados');
          const identificadosEl = document.getElementById('statsIdentificados');
          const cadastradosEl = document.getElementById('statsCadastrados');
          const processadosEl = document.getElementById('statsProcessados');
          
          if (totalEl) totalEl.textContent = total;
          if (identificadosEl) identificadosEl.textContent = stats.identificados || 0;
          if (cadastradosEl) cadastradosEl.textContent = stats.cadastrados || 0;
          if (processadosEl) processadosEl.textContent = stats.processados || 0;
          
          console.log('‚úÖ Atualiza√ß√£o manual conclu√≠da');
        }
      }
    } else {
      console.error('‚ùå Animal atual n√£o encontrado ou sem ID:', animalAtual);
    }
    
    // Adicionar animal √† tabela de registrados
    if (animalAtual && animalAtual.id) {
      console.log('üìã [FINALIZAR E GRAVAR] Adicionando animal √† tabela...', {
        animalId: animalAtual.id,
        sisbov: animalAtual.codigo_sisbov || animalAtual.numero_brinco
      });
      
      if (typeof window.adicionarAnimalTabelaRegistrados === 'function') {
        window.adicionarAnimalTabelaRegistrados(animalAtual);
        console.log('‚úÖ Animal adicionado √† tabela de registrados');
        
        // Tentar atualizar a tabela novamente ap√≥s um pequeno delay
        setTimeout(() => {
          if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
            console.log('üìã Tentando atualizar tabela novamente (segunda tentativa)...');
            window.atualizarTabelaAnimaisRegistrados();
          }
        }, 200);
      } else {
        console.error('‚ùå Fun√ß√£o window.adicionarAnimalTabelaRegistrados n√£o encontrada!');
      }
    } else {
      console.error('‚ùå Animal atual n√£o encontrado para adicionar √† tabela:', animalAtual);
    }
    
    // Mostrar notifica√ß√£o de sucesso
    if (typeof mostrarToast === 'function') {
      mostrarToast(resultado.mensagem || 'Registro gravado com sucesso!', 'success');
    } else {
      alert(resultado.mensagem || 'Registro gravado com sucesso!');
    }
    
    // Aguardar um momento para o usu√°rio ver a mensagem de sucesso
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // SEMPRE limpar campos e focar no brinco ap√≥s gravar com sucesso
    // (Melhoria: tornar o fluxo mais fluido, independente do checkbox auto-pr√≥ximo)
    console.log('üîÑ Limpando campos e preparando para pr√≥xima leitura...');
    
    // Limpar campos e ir para pr√≥xima leitura
    if (typeof finalizarAnimalV2 === 'function') {
      finalizarAnimalV2();
    } else {
      // Fallback melhorado: limpar manualmente de forma completa
      console.log('üîÑ Usando fallback para limpar campos...');
      
      // Limpar brinco
      if (brincoInput) {
        brincoInput.value = '';
        console.log('‚úÖ Campo brinco limpo');
      }
      
      // Limpar peso
      if (pesoValor) {
        pesoValor.value = '';
        console.log('‚úÖ Campo peso limpo');
      }
      
      // Limpar resumo do animal
      if (typeof window.atualizarScannerResumoV2 === 'function') {
        window.atualizarScannerResumoV2(null);
        console.log('‚úÖ Resumo do animal limpo');
      }
      
      // Limpar campos de pesagem
      const pesoRegistrado = document.getElementById('pesoRegistradoV2');
      const pesoUltimo = document.getElementById('pesoUltimoValorV2');
      const pesoData = document.getElementById('pesoUltimoDataV2');
      const pesoDias = document.getElementById('pesoDiasV2');
      const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
      const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
      
      if (pesoRegistrado) pesoRegistrado.textContent = '‚Äî';
      if (pesoUltimo) pesoUltimo.textContent = '‚Äî';
      if (pesoData) pesoData.textContent = '‚Äî';
      if (pesoDias) pesoDias.textContent = '‚Äî';
      if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
      if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
      
      // Limpar vari√°vel global do animal
      window.animalAtualV2 = null;
      if (typeof currentAnimalV2 !== 'undefined') {
        currentAnimalV2 = null;
      }
      
      // Desabilitar campo de peso
      if (typeof window.desabilitarCampoPesoV2 === 'function') {
        window.desabilitarCampoPesoV2();
      }
      
      // Limpar sele√ß√µes de manejos
      if (typeof window.limparSelecoesManejosV2 === 'function') {
        window.limparSelecoesManejosV2();
      }
      
      // Focar no campo de brinco para pr√≥xima leitura (melhorado: m√∫ltiplas tentativas)
      if (brincoInput) {
        setTimeout(() => {
          brincoInput.focus();
          brincoInput.select(); // Selecionar o conte√∫do tamb√©m
          console.log('‚úÖ Foco retornado para campo de brinco');
          
          // Tentar novamente se o foco n√£o funcionou (alguns navegadores precisam de m√∫ltiplas tentativas)
          setTimeout(() => {
            if (document.activeElement !== brincoInput) {
              brincoInput.focus();
              console.log('üîÑ Tentativa adicional de foco no brinco');
            }
          }, 100);
        }, 300);
      }
      
      console.log('‚úÖ Campos limpos e pronto para pr√≥xima leitura!');
    }
    
    console.log('üéØ ========== FIM FINALIZAR E GRAVAR ==========');
  } else {
    console.error('‚ùå Erro ao registrar manejos:', resultado.mensagem);
    alert(`Erro: ${resultado.mensagem}`);
  }
};

// Sobrescrever a fun√ß√£o inicial com a vers√£o completa
window.finalizarEGravarManejos = window._finalizarEGravarManejosCompleto;
console.log('‚úÖ Fun√ß√£o window.finalizarEGravarManejos atualizada com vers√£o completa!');

// Habilitar/desabilitar bot√£o Finalizar e Gravar
function atualizarBotaoFinalizarV2() {
  const btnFinalizar = document.getElementById('btnFinalizarGravarV2');
  const animalAtual = window.animalAtualV2;
  
  console.log('üîò [atualizarBotaoFinalizarV2] Verificando estado do bot√£o...', { 
    btnFinalizar: !!btnFinalizar, 
    animalAtual: !!animalAtual, 
    animalId: animalAtual ? animalAtual.id : null 
  });
  
  if (btnFinalizar) {
    if (animalAtual && animalAtual.id) {
      btnFinalizar.disabled = false;
      btnFinalizar.style.opacity = '1';
      btnFinalizar.style.cursor = 'pointer';
      console.log('‚úÖ [atualizarBotaoFinalizarV2] Bot√£o HABILITADO');
    } else {
      btnFinalizar.disabled = true;
      btnFinalizar.style.opacity = '0.5';
      btnFinalizar.style.cursor = 'not-allowed';
      console.log('‚ö†Ô∏è [atualizarBotaoFinalizarV2] Bot√£o DESABILITADO (sem animal identificado)');
    }
  } else {
    console.error('‚ùå [atualizarBotaoFinalizarV2] Bot√£o n√£o encontrado!');
  }
}

// Tornar fun√ß√£o global
window.atualizarBotaoFinalizarV2 = atualizarBotaoFinalizarV2;

// Event listeners para bot√µes de manejos (toggle sele√ß√£o)
function inicializarEventListenersManejosV2() {
  console.log('üîÑ Inicializando event listeners de manejos...');
  
  // Bot√µes de sanidade r√°pida
  const botoesSanidade = document.querySelectorAll('.sanidade-rapida-btn-v2, .sanidade-item-v2');
  console.log('üîç Bot√µes de sanidade encontrados:', botoesSanidade.length);
  
  botoesSanidade.forEach(btn => {
    // Remover listeners anteriores para evitar duplica√ß√£o
    const novoBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(novoBtn, btn);
    
    novoBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      this.classList.toggle('active');
      const isActive = this.classList.contains('active');
      const nome = this.dataset.nome || this.textContent.trim();
      
      console.log('‚úÖ Bot√£o de sanidade clicado:', nome, isActive ? 'SELECIONADO ‚úÖ' : 'DESSELECIONADO ‚ùå');
      console.log('üîç Classes do bot√£o:', Array.from(this.classList));
      
      // Atualizar cards de manejos selecionados
      setTimeout(() => {
        if (typeof window.atualizarCardsManejosSelecionados === 'function') {
          console.log('üîÑ Chamando atualizarCardsManejosSelecionados...');
          window.atualizarCardsManejosSelecionados();
        } else {
          console.error('‚ùå Fun√ß√£o atualizarCardsManejosSelecionados n√£o encontrada!');
        }
      }, 100);
    });
  });
  
  // Bot√µes de diagn√≥stico reprodutivo
  const botoesReprodutivo = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2');
  console.log('üîç Bot√µes de reprodutivo encontrados:', botoesReprodutivo.length);
  
  botoesReprodutivo.forEach(btn => {
    // Remover listeners anteriores para evitar duplica√ß√£o
    const novoBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(novoBtn, btn);
    
    novoBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // Desselecionar outros diagn√≥sticos (apenas um por vez)
      document.querySelectorAll('.reprodutivo-diagnostico-btn-v2').forEach(b => {
        if (b !== this) b.classList.remove('active');
      });
      
      this.classList.toggle('active');
      const isActive = this.classList.contains('active');
      const diagnostico = this.dataset.diagnostico || this.textContent.trim();
      
      console.log('‚úÖ Bot√£o de diagn√≥stico clicado:', diagnostico, isActive ? 'SELECIONADO ‚úÖ' : 'DESSELECIONADO ‚ùå');
      console.log('üîç Classes do bot√£o:', Array.from(this.classList));
      
      // Atualizar cards de manejos selecionados
      setTimeout(() => {
        if (typeof window.atualizarCardsManejosSelecionados === 'function') {
          console.log('üîÑ Chamando atualizarCardsManejosSelecionados...');
          window.atualizarCardsManejosSelecionados();
        } else {
          console.error('‚ùå Fun√ß√£o atualizarCardsManejosSelecionados n√£o encontrada!');
        }
      }, 100);
    });
  });
  
  console.log('‚úÖ Event listeners de manejos inicializados!');
}

// Inicializar quando DOM estiver pronto (m√∫ltiplas tentativas)
function tentarInicializarEventListenersManejos() {
  const botoesSanidade = document.querySelectorAll('.sanidade-rapida-btn-v2, .sanidade-item-v2');
  const botoesReprodutivo = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2');
  
  if (botoesSanidade.length > 0 || botoesReprodutivo.length > 0) {
    console.log('‚úÖ Bot√µes encontrados, inicializando listeners...');
    inicializarEventListenersManejosV2();
  } else {
    console.log('‚è≥ Bot√µes ainda n√£o encontrados, tentando novamente...');
    setTimeout(tentarInicializarEventListenersManejos, 500);
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(tentarInicializarEventListenersManejos, 500);
    setTimeout(tentarInicializarEventListenersManejos, 1500);
  });
} else {
  setTimeout(tentarInicializarEventListenersManejos, 500);
  setTimeout(tentarInicializarEventListenersManejos, 1500);
}

// Atalho Enter para finalizar e gravar
document.addEventListener('keydown', function(event) {
  // Enter para finalizar (se n√£o estiver em um input de texto)
  if (event.key === 'Enter' && !event.shiftKey && !event.ctrlKey && !event.altKey) {
    const activeElement = document.activeElement;
    const isInput = activeElement && (
      activeElement.tagName === 'INPUT' ||
      activeElement.tagName === 'TEXTAREA' ||
      activeElement.isContentEditable
    );
    
    // Se estiver no campo de peso e houver animal identificado
    if (activeElement && activeElement.id === 'pesoValorV2' && window.animalAtualV2 && window.animalAtualV2.id) {
      event.preventDefault();
      // Se houver peso, gravar primeiro
      const pesoValor = document.getElementById('pesoValorV2');
      if (pesoValor && pesoValor.value) {
        if (typeof window.finalizarEGravarManejos === 'function') {
          window.finalizarEGravarManejos();
        }
      }
    }
  }
});

// Abrir popup de confirma√ß√£o
function abrirPopupConfirmacao(dados) {
  const overlay = document.getElementById('brincoConfirmOverlay');
  if (!overlay) {
    console.warn('Popup de confirma√ß√£o n√£o encontrado');
    return;
  }
  
  // Preencher campos do popup
  const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(dados.raca) : (dados.raca || '‚Äî');
  const campos = {
    brincoConfirmNumero: dados.numero_brinco || '‚Äî',
    brincoConfirmSisbov: dados.codigo_sisbov || '‚Äî',
    brincoConfirmManejo: dados.numero_manejo || '‚Äî',
    brincoConfirmRaca: racaCompleta,
    brincoConfirmSexo: dados.sexo || '‚Äî',
    brincoConfirmDataNasc: dados.data_nascimento_format || dados.data_nascimento || '‚Äî',
    brincoConfirmUltimoPeso: (() => {
      if (dados.peso_atual) {
        const peso = typeof dados.peso_atual === 'number' ? dados.peso_atual : parseFloat(dados.peso_atual);
        if (!isNaN(peso) && peso > 0) {
          return `${peso.toFixed(1).replace('.', ',')} kg`;
        }
      }
      return '‚Äî';
    })(),
    brincoConfirmLote: dados.lote_atual || dados.lote || '‚Äî',
    brincoConfirmReprodutivo: dados.status_reprodutivo || '‚Äî'
  };
  
  Object.entries(campos).forEach(([id, valor]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = valor;
  });
  
  // Mostrar popup
  overlay.classList.add('show');
  overlay.style.display = 'flex';
  overlay.style.opacity = '1';
  console.log('‚úÖ Popup de confirma√ß√£o aberto');
}

// Atualizar campos do formul√°rio (se existirem)
function atualizarCamposFormulario(dados) {
  // Esta fun√ß√£o pode ser expandida para atualizar outros campos do formul√°rio
  // quando necess√°rio
  console.log('Campos do formul√°rio atualizados');
}

// Vari√°vel global para armazenar animal atual
window.animalAtualV2 = null;

// ========== VARI√ÅVEIS GLOBAIS DE SIMULA√á√ÉO ==========
// IMPORTANTE: N√£o resetar se j√° estiver definido (pode estar em execu√ß√£o)
if (typeof window.simulacaoAtiva === 'undefined') {
  window.simulacaoAtiva = false;
}
if (typeof window.intervaloSimulacao === 'undefined') {
  window.intervaloSimulacao = null;
}
if (typeof window.contadorSimulacao === 'undefined') {
  window.contadorSimulacao = 0;
}
if (typeof window.totalRegistrosSimulacao === 'undefined') {
  window.totalRegistrosSimulacao = 139; // Total de registros a processar
}

// Inicializar lista de animais trabalhados globalmente
if (typeof window.animaisTrabalhados === 'undefined') {
  window.animaisTrabalhados = [];
}

// Inicializar estat√≠sticas globalmente
if (typeof window.estatisticasAnimais === 'undefined') {
  window.estatisticasAnimais = {
    identificados: 0, // Animais novos identificados
    cadastrados: 0,   // Animais que j√° existiam no sistema
    processados: 0    // Animais que foram processados (pesagem, etc)
    // Total √© calculado automaticamente: identificados + cadastrados
  };
}

// ========== SISTEMA DE AVISOS SONOROS ==========
// Fun√ß√£o para tocar aviso sonoro discreto
window.tocarAvisoSonoro = function(tipo = 'sucesso') {
  try {
    // Criar contexto de √°udio
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Par√¢metros do som baseado no tipo
    let frequencia = 800; // Hz
    let duracao = 0.1; // segundos
    let volume = 0.15; // Volume discreto (15%)
    
    if (tipo === 'identificacao') {
      // Som mais agudo e curto para identifica√ß√£o
      frequencia = 600;
      duracao = 0.08;
      volume = 0.12;
    } else if (tipo === 'peso') {
      // Som um pouco mais grave para peso
      frequencia = 500;
      duracao = 0.12;
      volume = 0.15;
    }
    
    // Criar oscilador
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // Configurar oscilador
    oscillator.type = 'sine'; // Onda senoidal (som mais suave)
    oscillator.frequency.value = frequencia;
    
    // Configurar volume (gain) com fade in/out suave
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duracao);
    
    // Conectar n√≥s
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Tocar som
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duracao);
    
    // Limpar contexto ap√≥s o som
    setTimeout(() => {
      audioContext.close().catch(() => {});
    }, duracao * 1000 + 100);
  } catch (error) {
    // Silenciosamente ignorar erros de √°udio (navegador pode n√£o suportar)
    console.log('Aviso sonoro n√£o dispon√≠vel:', error);
  }
};

// ========== SISTEMA DE LOGS DA SIMULA√á√ÉO ==========
// NOTA: As fun√ß√µes window.adicionarLogSimulacao, window.limparLogsSimulacao, 
// window.mostrarPainelLogs e window.togglePainelLogs j√° est√£o definidas 
// no novo sistema profissional (linha 3626-3629)
// Este c√≥digo antigo foi removido para evitar conflitos

// ========== SISTEMA DE APARTA√á√ïES - INICIALIZA√á√ÉO GLOBAL ==========
// Inicializar aparta√ß√µes antes de qualquer uso
window.apartacoes = JSON.parse(localStorage.getItem('curral_apartacoes') || '[]');

// Fun√ß√£o para abrir modal de aparta√ß√µes (dispon√≠vel globalmente desde o in√≠cio)
window.abrirModalApartacao = function() {
  console.log('üîß Tentando abrir modal de aparta√ß√£o...');
  const modal = document.getElementById('modalApartacaoV2');
  if (modal) {
    console.log('‚úÖ Modal encontrado, abrindo...');
    modal.style.display = 'flex';
    setTimeout(() => {
      modal.classList.add('show');
      // Tentar atualizar lista se a fun√ß√£o estiver dispon√≠vel
      if (typeof window.atualizarListaApartacoes === 'function') {
        window.atualizarListaApartacoes();
      } else if (typeof atualizarListaApartacoes === 'function') {
        atualizarListaApartacoes();
      } else {
        console.warn('‚ö†Ô∏è Fun√ß√£o atualizarListaApartacoes n√£o encontrada ainda');
      }
    }, 10);
    console.log('‚úÖ Modal de aparta√ß√£o aberto');
  } else {
    console.error('‚ùå Modal de aparta√ß√£o n√£o encontrado!');
    console.error('Elementos dispon√≠veis:', document.querySelectorAll('[id*="apart"]'));
  }
};

// Fun√ß√£o para fechar modal de aparta√ß√µes (dispon√≠vel globalmente desde o in√≠cio)
window.fecharModalApartacao = function() {
  const modal = document.getElementById('modalApartacaoV2');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
};

// Definir fun√ß√£o de simula√ß√£o globalmente (antes do DOMContentLoaded)
// Fun√ß√£o para verificar e exibir status do sistema
window.verificarStatusSistema = function() {
    let status = {
      online: true,
      metodo: 'navigator.onLine',
      curralSyncDisponivel: typeof curralSync !== 'undefined',
      curralDBDisponivel: typeof curralDB !== 'undefined'
    };
    
    // Verificar usando curralSync se dispon√≠vel
    if (typeof curralSync !== 'undefined' && typeof curralSync.isOnlineStatus === 'function') {
      status.online = curralSync.isOnlineStatus();
      status.metodo = 'curralSync.isOnlineStatus()';
    } else {
      status.online = navigator.onLine !== false;
      status.metodo = 'navigator.onLine';
    }
    
    console.log('üìä STATUS DO SISTEMA:', status);
    
    // Atualizar indicador visual
    const statusEl = document.getElementById('statusConexaoV2');
    const textoEl = document.getElementById('statusConexaoTextoV2');
    if (statusEl && textoEl) {
      statusEl.className = 'status-conexao ' + (status.online ? 'online' : 'offline');
      textoEl.textContent = status.online ? 'Online' : 'Offline';
    }
    
    return status;
  };

// ========== FUN√á√ïES DE SIMULA√á√ÉO (definidas antes do DOMContentLoaded) ==========
// NOTA: window.iniciarSimulacao j√° foi definida anteriormente (linha 3389)
// Garantir que as vari√°veis globais estejam definidas
if (typeof window.simulacaoAtiva === 'undefined') {
  window.simulacaoAtiva = false;
}
if (typeof window.intervaloSimulacao === 'undefined') {
  window.intervaloSimulacao = null;
}

window.gerarSISBOV = function() {
  // Gera um SISBOV de 15 d√≠gitos
  return '105' + Math.floor(Math.random() * 1000000000000).toString().padStart(12, '0');
}

window.gerarPeso = function() {
  // Gera peso entre 200 e 500 kg
  return (Math.random() * 300 + 200).toFixed(1);
};

window.gerarRaca = function() {
  const racas = ['Nelore', 'Angus', 'Brahman', 'Hereford', 'Brangus'];
  return racas[Math.floor(Math.random() * racas.length)];
};

window.gerarSexo = function() {
  return Math.random() > 0.5 ? 'M' : 'F';
};

// Fun√ß√£o para calcular idade em meses a partir da data de nascimento
window.calcularIdadeMeses = function(dataNascimento) {
  if (!dataNascimento) return 0;
  
  try {
    const dataNasc = new Date(dataNascimento);
    const hoje = new Date();
    const diffTime = hoje - dataNasc;
    const diffMeses = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 30.44)); // M√©dia de dias por m√™s
    return diffMeses;
  } catch (error) {
    console.error('Erro ao calcular idade:', error);
    return 0;
  }
};

// Fun√ß√£o para simular digita√ß√£o caractere por caractere (dispon√≠vel globalmente)
window.simularDigitacao = async function(elemento, texto, velocidade = 50) {
  if (!elemento) {
    console.warn('Elemento n√£o encontrado para digita√ß√£o');
    return;
  }
  
  try {
    elemento.focus();
    elemento.value = '';
    
    for (let i = 0; i < texto.length; i++) {
      elemento.value += texto[i];
      elemento.dispatchEvent(new Event('input', { bubbles: true }));
      elemento.dispatchEvent(new KeyboardEvent('keydown', { key: texto[i], bubbles: true }));
      elemento.dispatchEvent(new KeyboardEvent('keypress', { key: texto[i], bubbles: true }));
      elemento.dispatchEvent(new KeyboardEvent('keyup', { key: texto[i], bubbles: true }));
      await new Promise(resolve => setTimeout(resolve, velocidade));
    }
    
    // Disparar evento de mudan√ßa final
    elemento.dispatchEvent(new Event('change', { bubbles: true }));
  } catch (error) {
    console.error('Erro ao simular digita√ß√£o:', error);
    if (typeof window.adicionarLogSimulacao === 'function') {
      window.adicionarLogSimulacao(`‚ùå Erro ao digitar: ${error.message}`, 'error');
    }
  }
};

// DEFINIR FUN√á√ÉO IMEDIATAMENTE - ANTES DE QUALQUER OUTRO C√ìDIGO
console.log('üìù ========== DEFININDO window.simularProcessamentoAnimal AGORA ==========');
console.log('üìù Timestamp:', new Date().toISOString());
console.log('üìù window.simulacaoAtiva:', window.simulacaoAtiva);

try {
  window.simularProcessamentoAnimal = async function() {
    console.log('üé¨ ========== simularProcessamentoAnimal CHAMADA ==========');
    console.log('window.simulacaoAtiva:', window.simulacaoAtiva);
    console.log('window.contadorSimulacao:', window.contadorSimulacao);
    console.log('window.totalRegistrosSimulacao:', window.totalRegistrosSimulacao);
    console.log('Timestamp:', new Date().toISOString());
    
    if (!window.simulacaoAtiva) {
      const msg = '‚ö†Ô∏è Simula√ß√£o n√£o est√° ativa';
      console.warn(msg);
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(msg, 'warning');
      }
      return;
    }
    
    if (window.contadorSimulacao >= window.totalRegistrosSimulacao) {
      const msg = '‚úÖ Limite de registros atingido';
      console.log(msg);
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(msg, 'success');
      }
      return;
    }

    try {
      // Incrementar contador ANTES de processar
      window.contadorSimulacao++;
      console.log(`üìä ========== Processando animal ${window.contadorSimulacao}/${window.totalRegistrosSimulacao} ==========`);
      
      // Atualizar bot√£o imediatamente
      const btn = document.getElementById('btnSimulacaoAuto');
      if (btn && window.simulacaoAtiva) {
        btn.innerHTML = '<i class="fas fa-pause"></i> Parar Simula√ß√£o (' + window.contadorSimulacao + '/' + window.totalRegistrosSimulacao + ')';
      }
      
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`üîÑ Iniciando processamento do animal ${window.contadorSimulacao}...`, 'info');
      } else {
        console.warn('‚ö†Ô∏è adicionarLogSimulacao n√£o dispon√≠vel');
      }
      
      // 1. Gerar brinco/SISBOV
      const sisbov = window.gerarSISBOV();
      const brinco = sisbov.substring(8, 14);
      const peso = window.gerarPeso();
      const pesoFormatado = peso.replace('.', ',');
      const raca = window.gerarRaca();
      const sexo = window.gerarSexo();
      
      // Gerar idade aleat√≥ria (6-60 meses) e calcular data de nascimento
      const idadeMeses = Math.floor(Math.random() * 54) + 6; // 6-60 meses
      const dataNasc = new Date();
      dataNasc.setMonth(dataNasc.getMonth() - idadeMeses);

      console.log(`[SIMULA√á√ÉO ${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] Processando animal: ${sisbov}`);
      
      // Adicionar log
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üìñ Lendo brinco: ${brinco} (SISBOV: ${sisbov})`, 'info');
      }
      
      // Mostrar toast de in√≠cio
      if (typeof mostrarToast === 'function') {
        mostrarToast(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] Lendo brinco ${brinco}...`, 'info');
      }

      // 2. Simular digita√ß√£o do brinco (caractere por caractere) - mais r√°pido para visualiza√ß√£o
      console.log('üîç Procurando campo brincoInputV2...');
      let inputBrinco = document.getElementById('brincoInputV2');
      
      // Se n√£o encontrar, tentar alternativas
      if (!inputBrinco) {
        console.warn('‚ö†Ô∏è brincoInputV2 n√£o encontrado, tentando alternativas...');
        inputBrinco = document.querySelector('input[placeholder*="SISBOV"], input[placeholder*="brinco"]');
      }
      
      if (!inputBrinco) {
        const msg = '‚ùå Campo de brinco n√£o encontrado!';
        console.error(msg);
        const elementosBrinco = Array.from(document.querySelectorAll('[id*="brinco"], [id*="Brinco"]'));
        console.log('üîç Elementos dispon√≠veis:', elementosBrinco.map(el => ({ id: el.id, tag: el.tagName })));
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(msg, 'error');
        }
        throw new Error(msg);
      }
      console.log('‚úÖ Campo de brinco encontrado:', inputBrinco.id || inputBrinco);
      
      // Adicionar log
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚å®Ô∏è Digitando brinco: ${sisbov}...`, 'info');
      }
      
      // Digitar em velocidade realista (80-120ms por caractere)
      const velocidadeDigitacao = 80 + Math.random() * 40;
      if (typeof window.simularDigitacao === 'function') {
        await window.simularDigitacao(inputBrinco, sisbov, velocidadeDigitacao);
      } else {
        // Fallback: preencher diretamente
        inputBrinco.value = sisbov;
        inputBrinco.dispatchEvent(new Event('input', { bubbles: true }));
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚ö†Ô∏è Usando fallback: preenchimento direto`, 'warning');
        }
      }
      
      // Aguardar um pouco antes de buscar (tempo realista)
      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
      
      // 3. Clicar no bot√£o Buscar (simular a√ß√£o do usu√°rio)
      console.log('üîç Procurando bot√£o btnBuscarBrinco...');
      let btnBuscar = document.getElementById('btnBuscarBrinco');
      
      // Se n√£o encontrar, tentar alternativas
      if (!btnBuscar) {
        console.warn('‚ö†Ô∏è btnBuscarBrinco n√£o encontrado, tentando alternativas...');
        btnBuscar = document.querySelector('button[id*="buscar"], button[id*="Buscar"]');
        // Tentar por texto
        if (!btnBuscar) {
          const botoes = Array.from(document.querySelectorAll('button'));
          btnBuscar = botoes.find(btn => btn.textContent.includes('Buscar'));
        }
      }
      
      if (btnBuscar) {
        console.log('‚úÖ Bot√£o Buscar encontrado:', btnBuscar.id || btnBuscar.textContent);
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üîç Clicando em "Buscar"...`, 'info');
        }
        btnBuscar.focus();
        await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 100));
        btnBuscar.click();
      } else {
        // Se n√£o houver bot√£o, simular Enter
        console.log('‚ö†Ô∏è Bot√£o Buscar n√£o encontrado, simulando Enter...');
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚å®Ô∏è Simulando Enter...`, 'info');
        }
        inputBrinco.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', keyCode: 13, bubbles: true }));
        inputBrinco.dispatchEvent(new KeyboardEvent('keyup', { key: 'Enter', keyCode: 13, bubbles: true }));
      }
      
      // Aguardar processamento do animal (tempo realista para busca)
      await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 500));
      
      // Verificar se animal foi identificado ou se precisa cadastrar do estoque
      // Na simula√ß√£o, vamos simular que alguns brincos est√£o no estoque (30% de chance)
      const estaNoEstoque = Math.random() < 0.3; // 30% de chance de estar no estoque
      
      if (estaNoEstoque && !window.animalAtualV2) {
        // Simular que o brinco est√° no estoque - cadastrar automaticamente
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üì¶ Brinco no estoque - cadastrando automaticamente...`, 'info');
        }
        
        // Simular cadastro autom√°tico com dados gerados
        const idadeMeses = Math.floor(Math.random() * 24) + 6; // 6-30 meses
        const dataNasc = new Date();
        dataNasc.setMonth(dataNasc.getMonth() - idadeMeses);
        
        // Criar dados do animal simulado
        const dadosAnimalSimulado = {
          id: null, // Novo animal
          numero_brinco: brinco,
          codigo_sisbov: sisbov,
          raca: raca,
          sexo: sexo,
          data_nascimento: dataNasc.toISOString().split('T')[0],
          peso_atual: null
        };
        
        // Processar como animal identificado (ser√° contado como identificado novo)
        if (typeof window.processarAnimalIdentificado === 'function') {
          window.processarAnimalIdentificado(dadosAnimalSimulado);
        } else if (typeof processarAnimalIdentificado === 'function') {
          processarAnimalIdentificado(dadosAnimalSimulado);
        } else {
          console.error('processarAnimalIdentificado n√£o encontrada!');
        }
        
        // Aguardar um pouco para o cadastro processar
        await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
        
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚úÖ Animal cadastrado automaticamente do estoque`, 'success');
        }
      } else {
        // Animal j√° existe ou n√£o est√° no estoque - simular identifica√ß√£o normal
        if (!window.animalAtualV2) {
          // Criar dados do animal simulado (j√° cadastrado)
          const dadosAnimalSimulado = {
            id: Math.floor(Math.random() * 10000) + 1, // ID simulado
            numero_brinco: brinco,
            codigo_sisbov: sisbov,
            raca: raca,
            sexo: sexo,
            data_nascimento: dataNasc.toISOString().split('T')[0], // Adicionar data de nascimento
            peso_atual: parseFloat(peso)
          };
          if (typeof window.processarAnimalIdentificado === 'function') {
            window.processarAnimalIdentificado(dadosAnimalSimulado);
          } else if (typeof processarAnimalIdentificado === 'function') {
            processarAnimalIdentificado(dadosAnimalSimulado);
          } else {
            console.error('processarAnimalIdentificado n√£o encontrada!');
          }
        }
        
        // Tocar aviso sonoro discreto para identifica√ß√£o
        if (typeof window.tocarAvisoSonoro === 'function') {
          window.tocarAvisoSonoro('identificacao');
        }
        
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚úÖ Animal identificado`, 'success');
        }
      }

      // 4. Simular digita√ß√£o do peso (caractere por caractere) - mais r√°pido
      console.log('üîç Procurando campo pesoValorV2...');
      let inputPeso = document.getElementById('pesoValorV2');
      
      // Se n√£o encontrar, tentar alternativas
      if (!inputPeso) {
        console.warn('‚ö†Ô∏è pesoValorV2 n√£o encontrado, tentando alternativas...');
        inputPeso = document.querySelector('input[placeholder*="0,0"], input[placeholder*="peso"]');
      }
      
      if (!inputPeso) {
        const msg = '‚ùå Campo de peso n√£o encontrado!';
        console.error(msg);
        const elementosPeso = Array.from(document.querySelectorAll('[id*="peso"], [id*="Peso"]'));
        console.log('üîç Elementos dispon√≠veis:', elementosPeso.map(el => ({ id: el.id, tag: el.tagName })));
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(msg, 'error');
        }
        throw new Error(msg);
      }
      console.log('‚úÖ Campo de peso encontrado:', inputPeso.id || inputPeso);
      
      await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 300));
      
      // Adicionar log
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚öñÔ∏è Digitando peso: ${pesoFormatado} kg`, 'info');
      }
      
      // Digitar em velocidade realista (100-150ms por caractere)
      const velocidadePeso = 100 + Math.random() * 50;
      if (typeof window.simularDigitacao === 'function') {
        await window.simularDigitacao(inputPeso, pesoFormatado, velocidadePeso);
      } else {
        // Fallback: preencher diretamente
        inputPeso.value = pesoFormatado;
        inputPeso.dispatchEvent(new Event('input', { bubbles: true }));
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚ö†Ô∏è Usando fallback: preenchimento direto`, 'warning');
        }
      }
      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
      
      // Mostrar toast de pesagem
      if (typeof mostrarToast === 'function') {
        mostrarToast(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] Peso: ${pesoFormatado} kg`, 'info');
      }

      // 5. Clicar no bot√£o Gravar (simular a√ß√£o do usu√°rio)
      console.log('üîç Procurando bot√£o pesoGravarBtnV2...');
      let btnGravar = document.getElementById('pesoGravarBtnV2');
      
      // Se n√£o encontrar, tentar alternativas
      if (!btnGravar) {
        console.warn('‚ö†Ô∏è pesoGravarBtnV2 n√£o encontrado, tentando alternativas...');
        btnGravar = document.querySelector('button[id*="gravar"], button[id*="Gravar"], button:has-text("Gravar")');
      }
      
      if (!btnGravar) {
        const msg = '‚ùå Bot√£o Gravar n√£o encontrado!';
        console.error(msg);
        const botoes = Array.from(document.querySelectorAll('button[id*="gravar"], button[id*="Gravar"]'));
        console.log('üîç Bot√µes dispon√≠veis:', botoes.map(btn => ({ id: btn.id, text: btn.textContent.trim() })));
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(msg, 'error');
        }
        throw new Error(msg);
      }
      console.log('‚úÖ Bot√£o Gravar encontrado:', btnGravar.id || btnGravar.textContent);
      
      if (btnGravar.disabled) {
        if (typeof window.adicionarLogSimulacao === 'function') {
          window.adicionarLogSimulacao(`‚ö†Ô∏è Bot√£o "Gravar" est√° desabilitado`, 'warning');
        }
        return;
      }
      
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üíæ Clicando em "Gravar"...`, 'info');
      }
      
      btnGravar.focus();
      await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 100));
      btnGravar.click();
      
      // Aguardar grava√ß√£o e processamento (tempo realista)
      await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 500));
      
      // Tocar aviso sonoro discreto para peso gravado
      if (typeof window.tocarAvisoSonoro === 'function') {
        window.tocarAvisoSonoro('peso');
      }
      
      // Verificar se √© f√™mea em reprodu√ß√£o (> 18 meses) para diagn√≥stico
      const animalDiagnostico = window.animalAtualV2;
      if (animalDiagnostico && animalDiagnostico.sexo === 'F' && animalDiagnostico.data_nascimento) {
        const idadeMeses = window.calcularIdadeMeses(animalDiagnostico.data_nascimento);
        
        if (idadeMeses >= 18) {
          // F√™mea em reprodu√ß√£o - abrir diagn√≥stico autom√°tico
          if (typeof window.adicionarLogSimulacao === 'function') {
            window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üî¨ F√™mea em reprodu√ß√£o (${idadeMeses} meses) - abrindo diagn√≥stico...`, 'info');
          }
          
          // Aguardar um pouco antes de abrir diagn√≥stico
          await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 300));
          
          // Abrir diagn√≥stico
          if (typeof window.abrirDiagnosticoV2 === 'function') {
            window.abrirDiagnosticoV2();
          } else if (typeof abrirDiagnosticoV2 === 'function') {
            abrirDiagnosticoV2();
          }
          
          // Aguardar um pouco para o modal abrir
          await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
          
          // Selecionar diagn√≥stico aleat√≥rio (PRENHA ou VAZIA)
          const diagnosticos = ['PRENHA', 'VAZIA'];
          const diagnosticoAleatorio = diagnosticos[Math.floor(Math.random() * diagnosticos.length)];
          
          if (typeof window.adicionarLogSimulacao === 'function') {
            window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] üé≤ Diagn√≥stico selecionado: ${diagnosticoAleatorio}`, 'info');
          }
          
          // Selecionar o diagn√≥stico
          if (typeof window.selecionarDiagnosticoV2 === 'function') {
            window.selecionarDiagnosticoV2(diagnosticoAleatorio);
          } else if (typeof selecionarDiagnosticoV2 === 'function') {
            selecionarDiagnosticoV2(diagnosticoAleatorio);
          } else {
            // Fallback: clicar no bot√£o correspondente
            const btnPrenha = document.querySelector('.diagnostico-btn[data-valor="PRENHA"]');
            const btnVazia = document.querySelector('.diagnostico-btn[data-valor="VAZIA"]');
            const btnDiagnostico = diagnosticoAleatorio === 'PRENHA' ? btnPrenha : btnVazia;
            
            if (btnDiagnostico) {
              btnDiagnostico.click();
            }
          }
          
          // Aguardar um pouco antes de confirmar
          await new Promise(resolve => setTimeout(resolve, 400 + Math.random() * 300));
          
          // Confirmar diagn√≥stico
          const diagnosticoOkBtn = document.getElementById('diagnosticoOkBtnV2');
          if (diagnosticoOkBtn) {
            if (typeof window.adicionarLogSimulacao === 'function') {
              window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚úÖ Confirmando diagn√≥stico: ${diagnosticoAleatorio}`, 'success');
            }
            diagnosticoOkBtn.click();
            
            // Aguardar processamento do diagn√≥stico
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
          }
        }
      }
      
      // Adicionar log de sucesso
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚úÖ Registrado com sucesso: ${brinco} - ${pesoFormatado} kg`, 'success');
      }
      
      // Mostrar toast de sucesso
      if (typeof mostrarToast === 'function') {
        mostrarToast(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] Registrado: ${brinco} - ${pesoFormatado} kg`, 'success');
      }

      // 6. Adicionar √† lista de animais trabalhados
      // Usar apenas window.animalAtualV2 (currentAnimalV2 √© uma vari√°vel local dentro do DOMContentLoaded)
      const animalTrabalhado = window.animalAtualV2;
      if (typeof window.adicionarAnimalTrabalhado === 'function') {
        window.adicionarAnimalTrabalhado({
          sisbov: sisbov,
          brinco: brinco,
          peso: peso,
          tipo: 'pesagem',
          detalhes: `${raca} ${sexo === 'M' ? 'Macho' : 'F√™mea'} ¬∑ ${peso} kg`,
          data: new Date().toLocaleString('pt-BR')
        });
      }

      // 7. Limpar campos (sempre limpar para pr√≥ximo registro)
      const autoProximo = document.getElementById('autoProximoV2');
      if (autoProximo && autoProximo.checked) {
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Simular limpeza gradual
        if (inputBrinco) {
          inputBrinco.focus();
          await new Promise(resolve => setTimeout(resolve, 100));
          inputBrinco.value = '';
          inputBrinco.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        if (inputPeso) {
          await new Promise(resolve => setTimeout(resolve, 100));
          inputPeso.value = '';
          inputPeso.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Focar no campo de brinco para pr√≥ximo animal
        if (inputBrinco) {
          await new Promise(resolve => setTimeout(resolve, 200));
          inputBrinco.focus();
        }
      } else {
        // Mesmo sem auto-pr√≥ximo, limpar para pr√≥ximo registro
        await new Promise(resolve => setTimeout(resolve, 300));
        if (inputBrinco) {
          inputBrinco.value = '';
          inputBrinco.focus();
        }
        if (inputPeso) {
          inputPeso.value = '';
        }
      }

      console.log(`[SIMULA√á√ÉO ${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] Animal ${brinco} processado: ${peso} kg`);
      
      // Adicionar log de conclus√£o
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚ú® Animal ${brinco} processado completamente`, 'success');
      }
    } catch (error) {
      console.error('[SIMULA√á√ÉO] ‚ùå ERRO CR√çTICO:', error);
      console.error('[SIMULA√á√ÉO] Stack:', error.stack);
      console.error('[SIMULA√á√ÉO] Mensagem:', error.message);
      
      // Adicionar log de erro
      if (typeof window.adicionarLogSimulacao === 'function') {
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚ùå Erro: ${error.message}`, 'error');
        window.adicionarLogSimulacao(`[${window.contadorSimulacao}/${window.totalRegistrosSimulacao}] ‚ùå Stack: ${error.stack}`, 'error');
      } else {
        console.error('‚ö†Ô∏è adicionarLogSimulacao n√£o dispon√≠vel para registrar erro');
      }
      
      if (typeof mostrarToast === 'function') {
        mostrarToast('Erro na simula√ß√£o: ' + error.message, 'error');
      }
      
      // N√£o parar a simula√ß√£o por causa de um erro, continuar tentando
      console.log('‚ö†Ô∏è Continuando simula√ß√£o apesar do erro...');
      
      // IMPORTANTE: N√£o decrementar o contador em caso de erro
      // O contador j√° foi incrementado no in√≠cio, ent√£o mantemos ele
      // para que o pr√≥ximo animal seja processado corretamente
    }
    
    // Log final sempre executado
    console.log(`[SIMULA√á√ÉO] ‚úÖ Finalizando processamento do animal ${window.contadorSimulacao}`);
    console.log('üé¨ ========== FIM simularProcessamentoAnimal ==========');
  };
  
  console.log('‚úÖ Fun√ß√£o window.simularProcessamentoAnimal definida com sucesso!');
  console.log('‚úÖ Tipo:', typeof window.simularProcessamentoAnimal);
} catch (error) {
  console.error('‚ùå ERRO AO DEFINIR simularProcessamentoAnimal:', error);
  console.error('‚ùå Stack:', error.stack);
  console.error('‚ùå Mensagem:', error.message);
}

// Confirmar que a fun√ß√£o foi definida
console.log('‚úÖ ========== FUN√á√ÉO DEFINIDA COM SUCESSO ==========');
console.log('‚úÖ window.simularProcessamentoAnimal definida:', typeof window.simularProcessamentoAnimal);
console.log('‚úÖ window.simularProcessamentoAnimal === function?', typeof window.simularProcessamentoAnimal === 'function');
console.log('‚úÖ window.simularProcessamentoAnimal existe em window?', 'simularProcessamentoAnimal' in window);
console.log('‚úÖ window.simulacaoAtiva:', window.simulacaoAtiva);

// Disparar evento customizado para notificar que a fun√ß√£o est√° dispon√≠vel
if (typeof window.dispatchEvent === 'function') {
  window.dispatchEvent(new CustomEvent('simularProcessamentoAnimalDefinida', {
    detail: { funcao: window.simularProcessamentoAnimal }
  }));
  console.log('‚úÖ Evento customizado disparado: simularProcessamentoAnimalDefinida');
}

// Se a simula√ß√£o j√° estiver ativa quando a fun√ß√£o for definida, iniciar imediatamente
if (window.simulacaoAtiva && typeof window.iniciarSimulacao === 'function') {
  console.log('üöÄ Simula√ß√£o j√° estava ativa quando simularProcessamentoAnimal foi definida!');
  console.log('üöÄ Chamando verificarEIniciar automaticamente...');
  // Aguardar um pouco para garantir que tudo esteja pronto
  setTimeout(() => {
    if (window.simulacaoAtiva) {
      console.log('üöÄ Iniciando processamento autom√°tico...');
      // Chamar diretamente a fun√ß√£o de processamento se dispon√≠vel
      if (typeof window.simularProcessamentoAnimal === 'function') {
        window.simularProcessamentoAnimal().catch(err => {
          console.error('‚ùå Erro ao processar automaticamente:', err);
        });
      }
    }
  }, 500);
}

// Verifica√ß√£o adicional ap√≥s 3 segundos
setTimeout(() => {
  console.log('üîç Verifica√ß√£o final ap√≥s 3s:');
  console.log('  window.simularProcessamentoAnimal:', typeof window.simularProcessamentoAnimal);
  console.log('  window.iniciarSimulacao:', typeof window.iniciarSimulacao);
  console.log('  window.simulacaoAtiva:', window.simulacaoAtiva);
}, 3000);

// Fun√ß√£o de diagn√≥stico para testar a simula√ß√£o
window.testarSimulacao = function() {
  console.log('üß™ ========== TESTE DE SIMULA√á√ÉO ==========');
  console.log('window.simulacaoAtiva:', window.simulacaoAtiva);
  console.log('window.contadorSimulacao:', window.contadorSimulacao);
  console.log('window.totalRegistrosSimulacao:', window.totalRegistrosSimulacao);
  console.log('window.intervaloSimulacao:', window.intervaloSimulacao);
  console.log('typeof window.simularProcessamentoAnimal:', typeof window.simularProcessamentoAnimal);
  console.log('typeof window.iniciarSimulacao:', typeof window.iniciarSimulacao);
  console.log('typeof window.adicionarLogSimulacao:', typeof window.adicionarLogSimulacao);
  console.log('typeof window.mostrarPainelLogs:', typeof window.mostrarPainelLogs);
  
  // Verificar elementos do DOM
  const brincoInput = document.getElementById('brincoInputV2');
  const pesoInput = document.getElementById('pesoValorV2');
  const btnGravar = document.getElementById('pesoGravarBtnV2');
  const btnBuscar = document.getElementById('btnBuscarBrinco');
  
  console.log('Elementos do DOM:');
  console.log('  brincoInputV2:', !!brincoInput, brincoInput ? brincoInput.id : 'N√ÉO ENCONTRADO');
  console.log('  pesoValorV2:', !!pesoInput, pesoInput ? pesoInput.id : 'N√ÉO ENCONTRADO');
  console.log('  pesoGravarBtnV2:', !!btnGravar, btnGravar ? btnGravar.id : 'N√ÉO ENCONTRADO');
  console.log('  btnBuscarBrinco:', !!btnBuscar, btnBuscar ? btnBuscar.id : 'N√ÉO ENCONTRADO');
  
  // Verificar painel de logs
  const painelLogs = document.getElementById('painelLogsSimulacao');
  console.log('  painelLogsSimulacao:', !!painelLogs, painelLogs ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO');
  if (painelLogs) {
    console.log('  painelLogs.style.display:', painelLogs.style.display);
    console.log('  painelLogs.style.visibility:', painelLogs.style.visibility);
  }
  
  console.log('üß™ ========== FIM DO TESTE ==========');
  
  // Tentar chamar a fun√ß√£o diretamente se poss√≠vel
  if (typeof window.simularProcessamentoAnimal === 'function' && !window.simulacaoAtiva) {
    console.log('üß™ Tentando chamar simularProcessamentoAnimal diretamente...');
    try {
      window.simulacaoAtiva = true;
      window.simularProcessamentoAnimal().then(() => {
        console.log('‚úÖ simularProcessamentoAnimal executada com sucesso!');
      }).catch(err => {
        console.error('‚ùå Erro ao executar simularProcessamentoAnimal:', err);
      });
    } catch (err) {
      console.error('‚ùå Erro s√≠ncrono ao chamar simularProcessamentoAnimal:', err);
    }
  }
};

console.log('‚úÖ Fun√ß√£o de teste dispon√≠vel: window.testarSimulacao()');

// ========== FUN√á√ïES DO MODAL DE CADASTRO DE TRABALHO (DEFINIDAS ANTES DO DOM) ==========
// ========== FUN√á√ïES DE TROCA DE BRINCO ==========
window.abrirModalTrocaBrinco = function() {
  const overlay = document.getElementById('trocaBrincoOverlay');
  const brincoInput = document.getElementById('brincoInputV2');
  const animalAtualEl = document.getElementById('trocaBrincoAnimalAtual');
  const novoBrincoInput = document.getElementById('trocaBrincoNovo');
  const motivoSelect = document.getElementById('trocaBrincoMotivo');
  const observacoesGroup = document.getElementById('trocaBrincoObservacoesGroup');
  const mensagemEl = document.getElementById('trocaBrincoMensagem');
  
  if (!overlay) {
    console.error('‚ùå Modal de troca de brinco n√£o encontrado!');
    return;
  }
  
  // Verificar se h√° animal identificado
  const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
  const codigoAtual = brincoInput ? brincoInput.value.trim() : '';
  
  if (!animalAtual && !codigoAtual) {
    alert('‚ö†Ô∏è Identifique um animal primeiro antes de realizar a troca de brinco.');
    if (brincoInput) brincoInput.focus();
    return;
  }
  
  // Preencher informa√ß√µes do animal atual
  if (animalAtualEl) {
    const brincoAtual = animalAtual?.numero_brinco || animalAtual?.codigo_sisbov || codigoAtual || '‚Äî';
    animalAtualEl.textContent = brincoAtual;
  }
  
  // Limpar campos
  if (novoBrincoInput) {
    novoBrincoInput.value = '';
  }
  if (motivoSelect) {
    motivoSelect.value = '';
  }
  const observacoesInput = document.getElementById('trocaBrincoObservacoes');
  if (observacoesInput) {
    observacoesInput.value = '';
  }
  if (observacoesGroup) {
    observacoesGroup.style.display = 'none';
  }
  if (mensagemEl) {
    mensagemEl.style.display = 'none';
    mensagemEl.textContent = '';
    mensagemEl.className = '';
  }
  
  // Mostrar modal
  overlay.classList.add('show');
  
  // Focar no campo de novo brinco
  setTimeout(() => {
    if (novoBrincoInput) {
      novoBrincoInput.focus();
    }
  }, 100);
  
  // Event listener para mostrar campo de observa√ß√µes quando "Outros" for selecionado
  if (motivoSelect) {
    motivoSelect.onchange = function() {
      if (observacoesGroup) {
        observacoesGroup.style.display = this.value === 'OUTROS' ? 'block' : 'none';
      }
    };
  }
};

window.fecharModalTrocaBrinco = function() {
  const overlay = document.getElementById('trocaBrincoOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
};

window.confirmarTrocaBrinco = async function() {
  const novoBrincoInput = document.getElementById('trocaBrincoNovo');
  const motivoSelect = document.getElementById('trocaBrincoMotivo');
  const observacoesInput = document.getElementById('trocaBrincoObservacoes');
  const mensagemEl = document.getElementById('trocaBrincoMensagem');
  const confirmarBtn = document.getElementById('trocaBrincoConfirmarBtn');
  const brincoInput = document.getElementById('brincoInputV2');
  
  if (!novoBrincoInput || !motivoSelect) {
    alert('Erro: Elementos do formul√°rio n√£o encontrados.');
    return;
  }
  
  const novoBrinco = novoBrincoInput.value.trim();
  const motivo = motivoSelect.value.trim();
  const observacoes = observacoesInput ? observacoesInput.value.trim() : '';
  
  // Valida√ß√µes
  if (!novoBrinco) {
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-warning';
      mensagemEl.textContent = '‚ö†Ô∏è Informe o novo brinco.';
    }
    novoBrincoInput.focus();
    return;
  }
  
  if (!motivo) {
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-warning';
      mensagemEl.textContent = '‚ö†Ô∏è Selecione o motivo da troca.';
    }
    motivoSelect.focus();
    return;
  }
  
  if (motivo === 'OUTROS' && !observacoes) {
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-warning';
      mensagemEl.textContent = '‚ö†Ô∏è Descreva o motivo quando selecionar "Outros".';
    }
    if (observacoesInput) observacoesInput.focus();
    return;
  }
  
  // Obter c√≥digo atual
  const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
  const codigoAtual = animalAtual?.numero_brinco || animalAtual?.codigo_sisbov || (brincoInput ? brincoInput.value.trim() : '');
  
  if (!codigoAtual) {
    alert('Erro: N√£o foi poss√≠vel identificar o animal atual.');
    return;
  }
  
  // Verificar se o novo brinco √© diferente do atual
  if (novoBrinco === codigoAtual) {
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-warning';
      mensagemEl.textContent = '‚ö†Ô∏è O novo brinco deve ser diferente do atual.';
    }
    novoBrincoInput.focus();
    return;
  }
  
  // Obter propriedadeId da URL
  const propriedadeMatch = window.location.pathname.match(/propriedade\/(\d+)/);
  if (!propriedadeMatch) {
    alert('Erro: N√£o foi poss√≠vel determinar a propriedade.');
    return;
  }
  const propriedadeId = propriedadeMatch[1];
  
  // Desabilitar bot√£o durante a requisi√ß√£o
  if (confirmarBtn) {
    confirmarBtn.disabled = true;
    confirmarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
  }
  
  // Limpar mensagem anterior
  if (mensagemEl) {
    mensagemEl.style.display = 'none';
  }
  
  try {
    // Montar payload
    const motivoCompleto = motivo === 'OUTROS' ? observacoes : motivo;
    const payload = {
      tipo_fluxo: 'animal',
      codigo: codigoAtual,
      novo_brinco: novoBrinco,
      motivo_troca: motivoCompleto
    };
    
    console.log('üîÑ Processando troca de brinco:', payload);
    
    // Fazer requisi√ß√£o
    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/registrar/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') || '',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    
    if (!response.ok || data.status !== 'ok') {
      throw new Error(data.mensagem || `Erro ${response.status}: ${response.statusText}`);
    }
    
    // Sucesso
    console.log('‚úÖ Troca de brinco realizada com sucesso:', data);
    
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-success';
      mensagemEl.textContent = '‚úÖ ' + (data.mensagem || 'Troca de brinco realizada com sucesso!');
    }
    
    // Atualizar campo de brinco com o novo c√≥digo se fornecido
    if (data.recarregar_codigo && brincoInput) {
      brincoInput.value = data.recarregar_codigo;
    }
    
    // Recarregar dados do animal ap√≥s 1 segundo
    setTimeout(() => {
      fecharModalTrocaBrinco();
      if (typeof window.buscarBrincoSimples === 'function') {
        const novoCodigo = data.recarregar_codigo || novoBrinco;
        if (brincoInput) {
          brincoInput.value = novoCodigo;
        }
        window.buscarBrincoSimples();
      }
    }, 1500);
    
  } catch (error) {
    console.error('‚ùå Erro ao processar troca de brinco:', error);
    if (mensagemEl) {
      mensagemEl.style.display = 'block';
      mensagemEl.className = 'alert alert-danger';
      mensagemEl.textContent = '‚ùå Erro: ' + error.message;
    }
    
    // Reabilitar bot√£o
    if (confirmarBtn) {
      confirmarBtn.disabled = false;
      confirmarBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Confirmar Troca';
    }
  }
};

// Fun√ß√£o auxiliar para obter cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Tornar fun√ß√£o global para ser acess√≠vel via onclick no HTML
window.abrirModalNovaSessaoV2 = function() {
  console.log('üîòüîòüîò [MODAL] Fun√ß√£o abrirModalNovaSessaoV2 chamada! üîòüîòüîò');
  
  // Aguardar um pouco se o DOM ainda n√£o estiver pronto
  if (document.readyState === 'loading') {
    console.log('‚è≥ DOM ainda carregando, aguardando...');
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => window.abrirModalNovaSessaoV2(), 100);
    });
    return;
  }
  
  const modal = document.getElementById('modalCadastroTrabalhoV2');
  
  if (!modal) {
    console.error('‚ùå [MODAL] Elemento modalCadastroTrabalhoV2 n√£o encontrado!');
    console.error('‚ùå [MODAL] Tentando encontrar modal manualmente...');
    const todosModais = document.querySelectorAll('[id*="modal"], [class*="modal"]');
    console.log('üîç [MODAL] Elementos com "modal" encontrados:', todosModais.length);
    todosModais.forEach((el, idx) => {
      console.log(`  ${idx + 1}. ${el.id || el.className} - tag: ${el.tagName}`);
    });
    alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
    return;
  }
  
  console.log('‚úÖ [MODAL] Modal encontrado!', {
    id: modal.id,
    className: modal.className,
    currentDisplay: modal.style.display,
    computedDisplay: window.getComputedStyle(modal).display
  });
  
  // Preencher data atual automaticamente
  const dataInput = document.getElementById('dataTrabalhoV2');
  if (dataInput) {
    const hoje = new Date();
    const dataFormatada = hoje.toISOString().split('T')[0];
    dataInput.value = dataFormatada;
    console.log('‚úÖ [MODAL] Data preenchida:', dataFormatada);
  } else {
    console.warn('‚ö†Ô∏è [MODAL] Campo dataTrabalhoV2 n√£o encontrado');
  }
  
  // Exibir modal - FOR√áAR exibi√ß√£o
  modal.style.display = 'flex';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  console.log('‚úÖ [MODAL] Modal exibido (display: flex, visibility: visible)');
  console.log('üîç [MODAL] Ap√≥s setar display:', {
    styleDisplay: modal.style.display,
    computedDisplay: window.getComputedStyle(modal).display,
    styleVisibility: modal.style.visibility,
    computedVisibility: window.getComputedStyle(modal).visibility
  });
  
  // Focar no primeiro campo
  const tipoTrabalhoInput = document.getElementById('tipoTrabalhoV2');
  if (tipoTrabalhoInput) {
    setTimeout(() => {
      tipoTrabalhoInput.focus();
      console.log('‚úÖ [MODAL] Foco no campo tipoTrabalhoV2');
    }, 200);
  } else {
    console.warn('‚ö†Ô∏è [MODAL] Campo tipoTrabalhoV2 n√£o encontrado');
  }
  
  // Verificar se o modal est√° realmente vis√≠vel ap√≥s um tempo
  setTimeout(() => {
    const computedStyle = window.getComputedStyle(modal);
    const isVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden';
    console.log('üîç [MODAL] Verifica√ß√£o final de visibilidade:', isVisible ? 'VIS√çVEL ‚úÖ' : 'OCULTO ‚ùå');
    console.log('üîç [MODAL] Detalhes:', {
      display: computedStyle.display,
      visibility: computedStyle.visibility,
      opacity: computedStyle.opacity,
      zIndex: computedStyle.zIndex,
      position: computedStyle.position
    });
    
    if (!isVisible) {
      console.error('‚ùå [MODAL] Modal n√£o est√° vis√≠vel! Tentando for√ßar exibi√ß√£o...');
      // Tentar for√ßar exibi√ß√£o novamente
      modal.style.display = 'flex !important';
      modal.style.visibility = 'visible !important';
      modal.style.opacity = '1 !important';
      modal.setAttribute('style', 'display: flex !important; visibility: visible !important; opacity: 1 !important;');
    }
  }, 300);
};

window.fecharModalCadastroTrabalhoV2 = function() {
  console.log('üîò [MODAL] Fechando modal...');
  const modal = document.getElementById('modalCadastroTrabalhoV2');
  if (modal) {
    modal.style.display = 'none';
    // Limpar formul√°rio
    const form = document.getElementById('formCadastroTrabalhoV2');
    if (form) {
      form.reset();
    }
    console.log('‚úÖ [MODAL] Modal fechado');
  }
};

// Fun√ß√£o para salvar cadastro de trabalho (ser√° definida ap√≥s DOMContentLoaded, mas j√° criar stub)
window.salvarCadastroTrabalhoV2 = async function() {
  console.warn('‚ö†Ô∏è [MODAL] Fun√ß√£o salvarCadastroTrabalhoV2 ainda n√£o foi completamente carregada. Aguarde...');
  alert('Aguarde o carregamento completo da p√°gina e tente novamente.');
};

// Stub inicial para salvarCadastroTrabalhoV2 (ser√° sobrescrito ap√≥s DOMContentLoaded)
window.salvarCadastroTrabalhoV2 = async function() {
  console.warn('‚ö†Ô∏è [MODAL] Fun√ß√£o salvarCadastroTrabalhoV2 ainda n√£o foi completamente carregada. Aguarde...');
  alert('Aguarde o carregamento completo da p√°gina e tente novamente.');
};

console.log('‚úÖ Fun√ß√µes do modal definidas globalmente:', {
  abrirModalNovaSessaoV2: typeof window.abrirModalNovaSessaoV2,
  fecharModalCadastroTrabalhoV2: typeof window.fecharModalCadastroTrabalhoV2,
  salvarCadastroTrabalhoV2: typeof window.salvarCadastroTrabalhoV2
});

// ========== INICIALIZA√á√ÉO AP√ìS DOM CARREGAR ==========
document.addEventListener('DOMContentLoaded', async function () {
  // Atualizar lista de animais trabalhados se houver animais j√° adicionados
  if (window.animaisTrabalhados && window.animaisTrabalhados.length > 0) {
    // Aguardar um pouco para garantir que a fun√ß√£o esteja definida
    setTimeout(() => {
      if (typeof window.atualizarListaAnimaisTrabalhados === 'function') {
        window.atualizarListaAnimaisTrabalhados();
      }
      // Atualizar estat√≠sticas tamb√©m
      if (typeof window.atualizarEstatisticasAnimais === 'function') {
        window.atualizarEstatisticasAnimais();
      }
    }, 100);
  } else {
    // Inicializar estat√≠sticas mesmo sem animais
    if (typeof window.atualizarEstatisticasAnimais === 'function') {
      window.atualizarEstatisticasAnimais();
    }
  }
  
  // ========== INICIALIZAR SISTEMA OFFLINE ==========
  // Verificar se curralSync est√° dispon√≠vel antes de usar
  if (typeof curralSync !== 'undefined') {
    try {
      await curralSync.init();
      atualizarStatusConexao();
      
      // Listener para atualiza√ß√µes da fila de sincroniza√ß√£o
      window.addEventListener('syncQueueUpdated', (event) => {
        atualizarContadorPendentes(event.detail.count);
      });
      
      // Atualizar contador inicial
      if (typeof curralDB !== 'undefined' && typeof curralDB.contarItensPendentes === 'function') {
        const countInicial = await curralDB.contarItensPendentes();
        atualizarContadorPendentes(countInicial);
      }
    } catch (error) {
      console.error('[OFFLINE] Erro ao inicializar sistema offline:', error);
      // Continuar mesmo se houver erro no sistema offline
    }
  } else {
    console.warn('[OFFLINE] curralSync n√£o est√° dispon√≠vel. Sistema funcionar√° apenas online.');
  }

  // ========== FUN√á√ïES DE STATUS OFFLINE ==========
  function atualizarStatusConexao() {
    const statusEl = document.getElementById('statusConexaoV2');
    const textoEl = document.getElementById('statusConexaoTextoV2');
    
    if (!statusEl || !textoEl) return;
    
    // Verificar status online/offline de forma segura
    let isOnline = true;
    if (typeof curralSync !== 'undefined' && typeof curralSync.isOnlineStatus === 'function') {
      isOnline = curralSync.isOnlineStatus();
    } else {
      // Fallback: usar navigator.onLine
      isOnline = navigator.onLine !== false;
    }
    
    statusEl.className = 'status-conexao ' + (isOnline ? 'online' : 'offline');
    textoEl.textContent = isOnline ? 'Online' : 'Offline';
    
    if (typeof curralSync !== 'undefined' && curralSync.syncInProgress) {
      statusEl.className = 'status-conexao sincronizando';
      textoEl.textContent = 'Sincronizando...';
    }
  }
  
  // ========== EVENT LISTENERS DO MODAL DE TROCA DE BRINCO ==========
  const trocaBrincoOverlay = document.getElementById('trocaBrincoOverlay');
  const trocaBrincoCloseBtn = document.getElementById('trocaBrincoCloseBtn');
  const trocaBrincoNovoInput = document.getElementById('trocaBrincoNovo');
  const trocaBrincoMotivoSelect = document.getElementById('trocaBrincoMotivo');
  
  // Fechar ao clicar no overlay (fora do modal)
  if (trocaBrincoOverlay) {
    trocaBrincoOverlay.addEventListener('click', function(e) {
      if (e.target === trocaBrincoOverlay) {
        fecharModalTrocaBrinco();
      }
    });
  }
  
  // Enter no campo de novo brinco move para o motivo
  if (trocaBrincoNovoInput) {
    trocaBrincoNovoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (trocaBrincoMotivoSelect) {
          trocaBrincoMotivoSelect.focus();
        }
      }
    });
  }
  
  // Enter no select de motivo confirma (se ambos campos estiverem preenchidos)
  if (trocaBrincoMotivoSelect) {
    trocaBrincoMotivoSelect.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (trocaBrincoNovoInput && trocaBrincoNovoInput.value.trim() && this.value) {
          confirmarTrocaBrinco();
        }
      }
    });
  }

  function atualizarContadorPendentes(count) {
    const pendentesEl = document.getElementById('syncPendentesV2');
    const countEl = document.getElementById('syncPendentesCountV2');
    
    if (!pendentesEl || !countEl) return;
    
    if (count > 0) {
      countEl.textContent = count;
      pendentesEl.classList.add('show');
    } else {
      pendentesEl.classList.remove('show');
    }
  }

  // Atualizar status periodicamente
  setInterval(atualizarStatusConexao, 1000);

  // ========== GERENCIAMENTO DE SESS√ïES ==========
  const criarSessaoUrl = '{{ criar_sessao_url }}';
  const encerrarSessaoUrl = '{{ encerrar_sessao_url }}';
  const statsSessaoUrl = '{{ stats_sessao_url }}';
  let statsInterval = null;

  // Fun√ß√µes j√° definidas globalmente acima, apenas criar aliases locais se necess√°rio
  function abrirModalNovaSessaoV2() {
    if (typeof window.abrirModalNovaSessaoV2 === 'function') {
      window.abrirModalNovaSessaoV2();
    } else {
      console.error('‚ùå [MODAL] window.abrirModalNovaSessaoV2 n√£o est√° dispon√≠vel!');
      alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
    }
  }

  function fecharModalCadastroTrabalhoV2() {
    if (typeof window.fecharModalCadastroTrabalhoV2 === 'function') {
      window.fecharModalCadastroTrabalhoV2();
    } else {
      const modal = document.getElementById('modalCadastroTrabalhoV2');
      if (modal) {
        modal.style.display = 'none';
      }
    }
  }

  // Sobrescrever stub inicial com fun√ß√£o completa
  window.salvarCadastroTrabalhoV2 = async function() {
    console.log('üíæ [MODAL] Fun√ß√£o salvarCadastroTrabalhoV2 chamada!');
    const tipoTrabalho = document.getElementById('tipoTrabalhoV2')?.value || '';
    const quantidadeEsperada = document.getElementById('quantidadeEsperadaV2')?.value || '';
    const nomeLote = document.getElementById('nomeLoteV2')?.value.trim() || '';
    const dataTrabalho = document.getElementById('dataTrabalhoV2')?.value || '';
    const pastoSelect = document.getElementById('pastoOrigemV2')?.value || '';
    const pastoManual = document.getElementById('pastoOrigemManualV2')?.value.trim() || '';
    const observacoes = document.getElementById('observacoesTrabalhoV2')?.value.trim() || '';
    
    // Valida√ß√µes
    if (!tipoTrabalho) {
      mostrarToast('Por favor, selecione o tipo de trabalho.', 'error');
      document.getElementById('tipoTrabalhoV2')?.focus();
      return;
    }
    
    if (!dataTrabalho) {
      mostrarToast('Por favor, informe a data do trabalho.', 'error');
      document.getElementById('dataTrabalhoV2')?.focus();
      return;
    }
    
    // Usar pasto do select ou do campo manual
    const pastoOrigem = pastoManual || pastoSelect || '';
    
    // Montar nome da sess√£o
    const tipoDisplay = document.getElementById('tipoTrabalhoV2')?.selectedOptions[0]?.text || tipoTrabalho;
    const dataFormatada = new Date(dataTrabalho + 'T00:00:00').toLocaleDateString('pt-BR');
    const nome = `${tipoDisplay} - ${dataFormatada}${nomeLote ? ' - ' + nomeLote : ''}`;
    
    mostrarLoading(true);
    try {
      const resp = await fetch(criarSessaoUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          nome: nome,
          tipo_trabalho: tipoTrabalho,
          quantidade_esperada: quantidadeEsperada ? parseInt(quantidadeEsperada) : null,
          nome_lote: nomeLote || null,
          pasto_origem: pastoOrigem || null,
          descricao: observacoes || null
        })
      });
      
      const data = await resp.json();
      mostrarLoading(false);
      
      if (data.status === 'ok') {
        mostrarToast('Trabalho cadastrado e sess√£o iniciada com sucesso!', 'success');
        fecharModalCadastroTrabalhoV2();
        // Recarrega a p√°gina para atualizar a interface
        setTimeout(() => window.location.reload(), 500);
      } else {
        mostrarToast(data.mensagem || 'Erro ao criar sess√£o.', 'error');
      }
    } catch (e) {
      console.error('Erro ao criar sess√£o:', e);
      mostrarLoading(false);
      mostrarToast('Erro ao comunicar com o servidor.', 'error');
    }
  };
  
  // Alias local para uso interno
  async function salvarCadastroTrabalhoV2() {
    if (typeof window.salvarCadastroTrabalhoV2 === 'function') {
      return await window.salvarCadastroTrabalhoV2();
    } else {
      console.error('‚ùå [MODAL] window.salvarCadastroTrabalhoV2 n√£o est√° dispon√≠vel!');
      alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
    }
  }
  
  // Fechar modal ao clicar fora
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('modalCadastroTrabalhoV2');
    if (event.target === modal) {
      fecharModalCadastroTrabalhoV2();
    }
  });
  
  // Abrir modal automaticamente quando n√£o houver sess√£o ativa
  let modalAutoAberto = false;
  
  function tentarAbrirModalAutomatico() {
    if (modalAutoAberto) {
      console.log('‚ÑπÔ∏è Modal j√° foi aberto automaticamente, ignorando...');
      return;
    }
    
    const modal = document.getElementById('modalCadastroTrabalhoV2');
    if (!modal) {
      console.log('‚è≥ Modal ainda n√£o carregado, tentando novamente em 200ms...');
      setTimeout(tentarAbrirModalAutomatico, 200);
      return;
    }
    
    // Verificar se o modal j√° est√° vis√≠vel
    const modalVisivel = window.getComputedStyle(modal).display !== 'none';
    if (modalVisivel) {
      console.log('‚ÑπÔ∏è Modal j√° est√° vis√≠vel, n√£o abrindo novamente.');
      modalAutoAberto = true;
      return;
    }
    
    // Verificar se h√° sess√£o ativa de m√∫ltiplas formas
    let temSessaoAtiva = false;
    
    // M√©todo 1: Verificar pelo elemento de nome da sess√£o
    const sessaoNomeEl = document.getElementById('sessaoAtivaNomeV2');
    if (sessaoNomeEl) {
      const texto = sessaoNomeEl.textContent || sessaoNomeEl.innerText || '';
      temSessaoAtiva = !texto.includes('Nenhuma sess√£o') && texto.trim() !== '';
      console.log('üîç Verifica√ß√£o 1 - Texto da sess√£o:', texto, '‚Üí Tem sess√£o:', temSessaoAtiva);
    }
    
    // M√©todo 2: Verificar se o bot√£o "Nova" est√° vis√≠vel (se estiver, n√£o h√° sess√£o)
    const btnNova = document.querySelector('.sessao-btn-nova');
    const btnEncerrar = document.querySelector('.sessao-btn-encerrar');
    if (btnNova && window.getComputedStyle(btnNova).display !== 'none') {
      temSessaoAtiva = false;
      console.log('üîç Verifica√ß√£o 2 - Bot√£o "Nova" est√° vis√≠vel ‚Üí N√£o h√° sess√£o ativa');
    } else if (btnEncerrar && window.getComputedStyle(btnEncerrar).display !== 'none') {
      temSessaoAtiva = true;
      console.log('üîç Verifica√ß√£o 2 - Bot√£o "Encerrar" est√° vis√≠vel ‚Üí H√° sess√£o ativa');
    }
    
    // M√©todo 3: Verificar pela se√ß√£o "sessaoAtivaSemSessaoV2"
    const semSessaoEl = document.getElementById('sessaoAtivaSemSessaoV2');
    if (semSessaoEl) {
      const semSessaoVisivel = window.getComputedStyle(semSessaoEl).display !== 'none';
      if (semSessaoVisivel) {
        temSessaoAtiva = false;
        console.log('üîç Verifica√ß√£o 3 - Se√ß√£o "sem sess√£o" est√° vis√≠vel ‚Üí N√£o h√° sess√£o ativa');
      }
    }
    
    console.log('üìä Resultado final da verifica√ß√£o:', temSessaoAtiva ? 'H√Å sess√£o ativa' : 'N√ÉO h√° sess√£o ativa');
    
    // Se n√£o houver sess√£o ativa, abrir modal automaticamente
    if (!temSessaoAtiva) {
      console.log('‚úÖ N√£o h√° sess√£o ativa, abrindo modal de cadastro de trabalho automaticamente...');
      abrirModalNovaSessaoV2();
      modalAutoAberto = true;
    } else {
      console.log('‚ÑπÔ∏è H√° uma sess√£o ativa, modal n√£o ser√° aberto automaticamente.');
      console.log('‚ÑπÔ∏è Para criar uma nova sess√£o, clique no bot√£o "Nova" ou encerre a sess√£o atual.');
      modalAutoAberto = true; // Marcar como processado mesmo sem abrir
    }
  }
  
  // Tentar abrir quando DOM estiver pronto (m√∫ltiplas tentativas para garantir)
  function inicializarModalAuto() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(tentarAbrirModalAutomatico, 500);
        setTimeout(tentarAbrirModalAutomatico, 1000); // Tentar novamente ap√≥s 1s
      });
    } else {
      // DOM j√° est√° pronto
      setTimeout(tentarAbrirModalAutomatico, 500);
      setTimeout(tentarAbrirModalAutomatico, 1000); // Tentar novamente ap√≥s 1s
    }
  }
  
  inicializarModalAuto();

  // Fun√ß√£o global para ver sess√£o (otimizada)
  window.verSessaoV2 = function(btn) {
    const url = btn.getAttribute('data-url');
    if (!url) {
      mostrarToast('URL da sess√£o n√£o encontrada.', 'error');
      return;
    }
    
    // Adicionar indicador de loading
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
    
      // Navegar para a URL
      window.location.href = url;
    };
  }
  
  // Fun√ß√£o global para encerrar sess√£o
  if (typeof window.encerrarSessaoV2 === 'undefined') {
    window.encerrarSessaoV2 = async function() {
      if (!confirm('Deseja realmente encerrar a sess√£o atual?')) {
        return;
      }
      
      const btnEncerrar = document.querySelector('.sessao-btn-encerrar');
    if (btnEncerrar) {
      btnEncerrar.disabled = true;
      btnEncerrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Encerrando...';
    }
    
    try {
      // Obter CSRF token
      let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
      if (!csrfToken) {
        // Tentar obter do cookie
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        csrfToken = match ? match[1] : '';
      }
      
      // Usar a vari√°vel global encerrarSessaoUrl ou obter do template
      let urlEncerrar;
      try {
        // Tentar usar a vari√°vel do escopo superior
        urlEncerrar = typeof encerrarSessaoUrl !== 'undefined' ? encerrarSessaoUrl : 
                     '{{ encerrar_sessao_url|default:"" }}';
        
        // Se ainda estiver vazio, usar fallback
        if (!urlEncerrar || urlEncerrar === '') {
          urlEncerrar = '/curral/encerrar-sessao/';
        }
      } catch (e) {
        urlEncerrar = '{{ encerrar_sessao_url|default:"/curral/encerrar-sessao/" }}';
      }
      
      if (!csrfToken) {
        console.error('‚ùå CSRF token n√£o encontrado!');
        mostrarToast('Erro: Token de seguran√ßa n√£o encontrado. Recarregue a p√°gina.', 'error');
        if (btnEncerrar) {
          btnEncerrar.disabled = false;
          btnEncerrar.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
        }
        return;
      }
      
      console.log('üõë Encerrando sess√£o...', { urlEncerrar, csrfToken: 'OK' });
      
      const resp = await fetch(urlEncerrar, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({})
      });
      
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
      }
      
      const data = await resp.json();
      console.log('üì• Resposta do servidor:', data);
      
      if (data.status === 'ok') {
        const stats = data.estatisticas || {};
        mostrarToast(
          `Sess√£o encerrada! ${stats.total_eventos || 0} eventos registrados, ${stats.animais_processados || 0} animais processados.`,
          'success'
        );
        // Recarrega a p√°gina ap√≥s um breve delay
        setTimeout(() => {
          window.location.reload();
        }, 800);
      } else {
        mostrarToast(data.mensagem || 'Erro ao encerrar sess√£o.', 'error');
        if (btnEncerrar) {
          btnEncerrar.disabled = false;
          btnEncerrar.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
        }
      }
    } catch (e) {
      console.error('‚ùå Erro ao encerrar sess√£o:', e);
      mostrarToast('Erro ao comunicar com o servidor. Tente novamente.', 'error');
      if (btnEncerrar) {
        btnEncerrar.disabled = false;
        btnEncerrar.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
      }
    }
  };

  // Vari√°vel global para controlar o timeout de esconder o card
  let timeoutEsconderCard = null;

  async function atualizarStatsSessaoV2() {
    try {
      const resp = await fetch(statsSessaoUrl, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      
      if (data.status === 'ok' && data.stats) {
        const stats = data.stats;
        const header = document.getElementById('sessaoAtivaHeaderV2');
        const nomeEl = document.getElementById('sessaoAtivaNomeV2');
        const statsEl = document.getElementById('sessaoAtivaStatsV2');
        const semSessaoEl = document.getElementById('sessaoAtivaSemSessaoV2');
        
        if (stats.sessao_ativa) {
          if (header) header.classList.remove('sem-sessao');
          // Atualiza nome da sess√£o com data se dispon√≠vel
          if (nomeEl) {
            const nomeSessao = stats.sessao_nome || stats.nome || 'Sess√£o Ativa';
            const dataSessao = stats.sessao_data || stats.data_inicio || '';
            nomeEl.textContent = dataSessao ? `${nomeSessao} ${dataSessao}` : nomeSessao;
          }
          if (statsEl) statsEl.style.display = 'flex';
          if (semSessaoEl) semSessaoEl.style.display = 'none';
          
          const eventosEl = document.getElementById('sessaoStatEventosV2');
          const animaisEl = document.getElementById('sessaoStatAnimaisV2');
          const pesagensEl = document.getElementById('sessaoStatPesagensV2');
          
          if (eventosEl) eventosEl.textContent = stats.total_eventos || 0;
          if (animaisEl) animaisEl.textContent = stats.animais_processados || 0;
          if (pesagensEl) pesagensEl.textContent = stats.pesagens || 0;
          
          // Mostrar o card novamente quando as estat√≠sticas s√£o atualizadas (se estava escondido)
          if (header) {
            header.classList.remove('escondido');
            // Limpar timeout anterior se existir
            if (timeoutEsconderCard) {
              clearTimeout(timeoutEsconderCard);
            }
            // Esconder novamente ap√≥s 10 segundos (se n√£o estiver com mouse em cima)
            timeoutEsconderCard = setTimeout(function() {
              if (header && !header.matches(':hover')) {
                header.classList.add('escondido');
              }
            }, 10000);
          }
        } else {
          if (header) header.classList.add('sem-sessao');
          if (statsEl) statsEl.style.display = 'none';
          if (semSessaoEl) semSessaoEl.style.display = 'block';
          if (nomeEl) nomeEl.textContent = 'Nenhuma sess√£o ativa';
        }
      }
    } catch (e) {
      console.error('Erro ao atualizar stats da sess√£o:', e);
    }
  }

  // Iniciar atualiza√ß√£o peri√≥dica de estat√≠sticas
  if (statsSessaoUrl) {
    atualizarStatsSessaoV2();
    statsInterval = setInterval(atualizarStatsSessaoV2, 10000); // A cada 10 segundos
  }

  // Esconder card de sess√£o ativa ap√≥s 10 segundos (agora incorporado no header)
  const sessaoAtivaHeader = document.getElementById('sessaoAtivaHeaderV2');
  if (sessaoAtivaHeader) {
    // Esconder o card inicialmente ap√≥s 10 segundos
    timeoutEsconderCard = setTimeout(function() {
      if (sessaoAtivaHeader && !sessaoAtivaHeader.matches(':hover')) {
        sessaoAtivaHeader.classList.add('escondido');
      }
    }, 10000);
    
    // Mostrar o card quando o mouse passar por cima
    sessaoAtivaHeader.addEventListener('mouseenter', function() {
      this.classList.remove('escondido');
      // Limpar timeout quando o mouse entrar
      if (timeoutEsconderCard) {
        clearTimeout(timeoutEsconderCard);
        timeoutEsconderCard = null;
      }
    });
    
    // Esconder o card quando o mouse sair (ap√≥s 10 segundos)
    sessaoAtivaHeader.addEventListener('mouseleave', function() {
      if (timeoutEsconderCard) {
        clearTimeout(timeoutEsconderCard);
      }
      timeoutEsconderCard = setTimeout(function() {
        if (sessaoAtivaHeader && !sessaoAtivaHeader.matches(':hover')) {
          sessaoAtivaHeader.classList.add('escondido');
        }
      }, 10000);
    });
  }

  // Fechar modal ao clicar fora
  document.getElementById('novaSessaoModalV2')?.addEventListener('click', function(e) {
    if (e.target === this) {
      fecharModalNovaSessaoV2();
    }
  });

  const brincoInput = document.getElementById('brincoInputV2');
  const pesoInput = document.getElementById('pesoValorV2');
  const pesoSimularBtn = document.getElementById('pesoSimularBtnV2');
  const pesoLimparBtn = document.getElementById('pesoLimparBtnV2');
  const pesoManualBtn = document.getElementById('pesoManualBtnV2');

  const pesoUltimoValor = document.getElementById('pesoUltimoValorV2');
  const pesoUltimoData = document.getElementById('pesoUltimoDataV2');
  const pesoDias = document.getElementById('pesoDiasV2');
  const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
  const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
  const autoProximoCheckbox = document.getElementById('autoProximoV2');

  // Resumo do animal no card de leitura (vari√°veis mantidas para compatibilidade, mas n√£o usadas diretamente)
  // Os campos s√£o atualizados via atualizarScannerResumoV2()
  const scannerCodigoEletronico = document.getElementById('scannerCodigoEletronicoV2');
  const scannerSisbov = document.getElementById('scannerSisbovV2');
  const scannerNumeroManejo = document.getElementById('scannerNumeroManejoV2');
  const scannerRacaSexo = document.getElementById('scannerRacaSexoV2');
  const scannerDataNasc = document.getElementById('scannerDataNascV2');
  const scannerUltimoPeso = document.getElementById('scannerUltimoPesoV2');
  
  // Verifica√ß√£o inicial
  console.log('=== INICIALIZA√á√ÉO DO CURRAL DASHBOARD V2 ===');
  console.log('brincoInput encontrado:', !!brincoInput);
  if (brincoInput) {
    console.log('brincoInput ID:', brincoInput.id);
    console.log('brincoInput valor atual:', brincoInput.value);
  } else {
    console.error('ERRO: brincoInput n√£o encontrado!');
  }
  
  // Fun√ß√£o para anexar event listeners ao campo de brinco (definida antes de usar)
  function anexarEventListenersBrinco(inputElement) {
    if (!inputElement) {
      console.error('Elemento de input n√£o fornecido para anexar listeners');
      return;
    }
    
    console.log('Anexando event listeners ao elemento:', inputElement.id);
    
    // Event listener para Enter
    inputElement.addEventListener('keydown', function (e) {
      console.log('Tecla pressionada:', e.key, 'keyCode:', e.keyCode, 'Valor do campo:', this.value);
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        e.stopPropagation();
        const valor = this.value.trim();
        console.log('Enter pressionado! Chamando buscarBrincoSimples com:', valor);
        if (valor && valor.length >= 3) {
          // Usar buscarBrincoSimples que unifica a l√≥gica
          if (typeof window.buscarBrincoSimples === 'function') {
            window.buscarBrincoSimples();
          } else if (typeof identificarBrinco === 'function') {
            identificarBrinco(valor);
          } else {
            alert('Sistema ainda n√£o carregou. Aguarde alguns segundos.');
          }
        } else {
          console.warn('Valor muito curto para buscar:', valor);
          if (typeof mostrarToast === 'function') {
            mostrarToast('Digite pelo menos 3 caracteres para buscar.', 'warning');
          } else {
            alert('Digite pelo menos 3 caracteres para buscar.');
          }
        }
        return false;
      }
    });

    // Detec√ß√£o autom√°tica ao terminar de digitar (com debounce)
    let debounceTimer;
    inputElement.addEventListener('input', function (e) {
      const valor = this.value.trim();
      console.log('Input detectado, valor:', valor);
      
      // Limpa o timer anterior
      clearTimeout(debounceTimer);
      
      // Se o campo estiver vazio, n√£o faz nada
      if (!valor || valor.length < 3) {
        console.log('Valor muito curto, aguardando mais digita√ß√£o...');
        return;
      }
      
      // Dispara a identifica√ß√£o ap√≥s 1 segundo sem digita√ß√£o
      console.log('Aguardando 1 segundo para buscar automaticamente...');
      debounceTimer = setTimeout(() => {
        console.log('Debounce disparado! Chamando buscarBrincoSimples');
        // Usar buscarBrincoSimples que unifica a l√≥gica
        if (typeof window.buscarBrincoSimples === 'function') {
          window.buscarBrincoSimples();
        } else if (typeof identificarBrinco === 'function') {
          identificarBrinco(valor);
        }
      }, 1000);
    });

    // Tamb√©m dispara quando o campo perder o foco (se tiver valor suficiente)
    inputElement.addEventListener('blur', function (e) {
      const valor = this.value.trim();
      console.log('Campo perdeu foco, valor:', valor);
      if (valor && valor.length >= 3) {
        clearTimeout(debounceTimer);
        console.log('Chamando buscarBrincoSimples no blur');
        // Usar buscarBrincoSimples que unifica a l√≥gica
        if (typeof window.buscarBrincoSimples === 'function') {
          window.buscarBrincoSimples();
        } else if (typeof identificarBrinco === 'function') {
          identificarBrinco(valor);
        }
      }
    });
    
    // Teste: se o campo j√° tiver valor, tentar identificar imediatamente
    if (inputElement.value && inputElement.value.trim().length >= 3) {
      console.log('Campo j√° tem valor, tentando identificar ap√≥s 500ms...');
      setTimeout(() => {
        if (typeof window.buscarBrincoSimples === 'function') {
          window.buscarBrincoSimples();
        } else if (typeof identificarBrinco === 'function') {
          identificarBrinco(inputElement.value.trim());
        }
      }, 500);
    }
    
    console.log('‚úÖ Event listeners anexados com sucesso ao brincoInput!');
  }

  // Diagn√≥stico r√°pido
  const diagnosticoOverlay = document.getElementById('diagnosticoOverlayV2');
  const diagnosticoBtns = document.querySelectorAll('.diagnostico-btn');
  const diagnosticoOkBtn = document.getElementById('diagnosticoOkBtnV2');
  const diagnosticoCancelarBtn = document.getElementById('diagnosticoCancelarBtnV2');
  const diagnosticoVozBtn = document.getElementById('diagnosticoVozBtnV2');
  const diagnosticoVozStatus = document.getElementById('diagnosticoVozStatusV2');
  let diagnosticoSelecionado = null;
  let diagnosticoRecognition = null;
  let diagnosticoReconhecendo = false;

  // Cadastro r√°pido a partir do estoque
  const estoqueCadastroOverlay = document.getElementById('estoqueCadastroOverlayV2');
  const estoqueCadastroBrincoSpan = document.getElementById('estoqueCadastroBrincoV2');
  const estoqueCadastroRaca = document.getElementById('estoqueCadastroRacaV2');
  const estoqueCadastroSexo = document.getElementById('estoqueCadastroSexoV2');
  const estoqueCadastroIdadeMeses = document.getElementById('estoqueCadastroIdadeMesesV2');
  const estoqueCadastroDataNasc = document.getElementById('estoqueCadastroDataNascV2');
  const estoqueCadastroOkBtn = document.getElementById('estoqueCadastroOkBtnV2');
  const estoqueCadastroCancelarBtn = document.getElementById('estoqueCadastroCancelarBtnV2');
  let estoqueCadastroCodigoAtual = null;
  let estoqueCadastroBrincoId = null; // ID do brinco selecionado quando h√° m√∫ltiplos
  let ultimoCadastroEstoqueV2 = null; // para reaproveitar ra√ßa/sexo/idade entre animais do mesmo lote
  
  // Tornar fun√ß√£o global para acesso na simula√ß√£o
  window.abrirCadastroEstoqueV2 = function(dadosBrinco, codigoOriginal) {
    return abrirCadastroEstoqueV2Local(dadosBrinco, codigoOriginal);
  };

  // Conflito de n√∫mero de manejo
  const conflitoManejoOverlay = document.getElementById('conflitoManejoOverlayV2');
  const conflitoManejoLista = document.getElementById('conflitoManejoListaV2');
  const conflitoManejoCancelarBtn = document.getElementById('conflitoManejoCancelarBtnV2');
  let conflitoManejoDados = null; // guarda os dados do cadastro que estava sendo feito quando houve o conflito

  const brincoConfirmOverlay = document.getElementById('brincoConfirmOverlay');
  const brincoConfirmNumero = document.getElementById('brincoConfirmNumero');
  const brincoConfirmSisbov = document.getElementById('brincoConfirmSisbov');
  const brincoConfirmManejo = document.getElementById('brincoConfirmManejo');
  const brincoConfirmBnd = document.getElementById('brincoConfirmBnd');
  const brincoConfirmRaca = document.getElementById('brincoConfirmRaca');
  const brincoConfirmSexo = document.getElementById('brincoConfirmSexo');
  const brincoConfirmDataNasc = document.getElementById('brincoConfirmDataNasc');
  const brincoConfirmUltimoPeso = document.getElementById('brincoConfirmUltimoPeso');
  const brincoConfirmLote = document.getElementById('brincoConfirmLote');
  const brincoConfirmReprodutivo = document.getElementById('brincoConfirmReprodutivo');
  const brincoConfirmOkBtn = document.getElementById('brincoConfirmOkBtn');
  const brincoConfirmCancelarBtn = document.getElementById('brincoConfirmCancelarBtn');

  const identificarUrl = "{{ identificar_url|escapejs }}";
  const registrarUrl = "{{ registrar_url|escapejs }}";
  const csrfToken = "{{ csrf_token }}";
  
  console.log('identificarUrl:', identificarUrl);
  console.log('registrarUrl:', registrarUrl);
  
  if (!identificarUrl || identificarUrl === '') {
    console.error('ERRO: identificarUrl n√£o est√° definido!');
  }
  
  // A fun√ß√£o buscarBrincoSimples j√° foi definida globalmente acima
  // Aqui apenas atualizamos para usar as fun√ß√µes locais se dispon√≠veis
  
  // Fun√ß√£o de busca direta (fallback local - sobrescreve a global se necess√°rio)
  async function buscarBrincoDireto(codigo) {
    console.log('Fazendo busca direta do brinco:', codigo);
    const limpo = (codigo || '').trim().replace(/\s+/g, '');
    
    if (!limpo || limpo.length < 3) {
      mostrarToast('C√≥digo muito curto.', 'warning');
      return;
    }
    
    const url = identificarUrl + '?codigo=' + encodeURIComponent(limpo);
    console.log('URL da busca:', url);
    
    try {
      mostrarLoading(true);
      const resp = await fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });
      
      console.log('Resposta recebida:', resp.status);
      
      if (!resp.ok) {
        throw new Error(`Erro ${resp.status}`);
      }
      
      const data = await resp.json();
      console.log('Dados recebidos:', data);
      
      mostrarLoading(false);
      
      if (data.status === 'animal') {
        console.log('‚úÖ Animal encontrado! Processando...');
        // Processar resposta diretamente
        processarAnimalEncontrado(data.dados);
      } else if (data.status === 'estoque') {
        console.log('Brinco encontrado no estoque');
        // Tentar abrir o modal de cadastro de estoque
        const tentarAbrirModal = () => {
          // Primeiro, tentar usar a fun√ß√£o se dispon√≠vel
          if (typeof abrirCadastroEstoqueV2 === 'function') {
            console.log('‚úÖ Usando abrirCadastroEstoqueV2');
            abrirCadastroEstoqueV2(data.dados || {}, limpo);
            return true;
          } else if (typeof window.abrirCadastroEstoqueV2 === 'function') {
            console.log('‚úÖ Usando window.abrirCadastroEstoqueV2');
            window.abrirCadastroEstoqueV2(data.dados || {}, limpo);
            return true;
          }
          
          // Se a fun√ß√£o n√£o estiver dispon√≠vel, tentar abrir o modal diretamente via DOM
          const overlay = document.getElementById('estoqueCadastroOverlayV2');
          if (overlay) {
            console.log('‚úÖ Abrindo modal diretamente via DOM');
            // Definir vari√°vel global se existir
            if (typeof estoqueCadastroCodigoAtual !== 'undefined') {
              estoqueCadastroCodigoAtual = limpo;
            } else if (typeof window !== 'undefined') {
              window.estoqueCadastroCodigoAtual = limpo;
            }
            // Preencher dados do brinco se houver elementos
            const brincoSpan = document.getElementById('estoqueCadastroBrincoV2');
            if (brincoSpan && limpo) {
              brincoSpan.textContent = limpo;
            }
            // Garantir que os event listeners estejam ativos
            if (typeof configurarEventListenersEstoque === 'function') {
              configurarEventListenersEstoque();
            } else {
              // Se a fun√ß√£o n√£o estiver dispon√≠vel, configurar diretamente
              setTimeout(() => {
                const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
                const sexoInput = document.getElementById('estoqueCadastroSexoV2');
                const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
                const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
                
                if (idadeInput) {
                  idadeInput.addEventListener('input', function() {
                    const idadeMeses = this.value;
                    // Fun√ß√£o inline para calcular data de nascimento (fallback se a fun√ß√£o global n√£o estiver dispon√≠vel)
                    const calcularData = (meses) => {
                      const mesesNum = parseInt(meses, 10);
                      if (isNaN(mesesNum) || mesesNum < 0) return '';
                      const hoje = new Date();
                      const ano = hoje.getFullYear();
                      const mes = hoje.getMonth();
                      const dia = hoje.getDate();
                      const totalMeses = ano * 12 + mes - mesesNum;
                      const anoNasc = Math.floor(totalMeses / 12);
                      let mesNasc = totalMeses % 12;
                      if (mesNasc < 0) {
                        mesNasc += 12;
                      }
                      const dataNasc = new Date(anoNasc, mesNasc, dia);
                      const yyyy = dataNasc.getFullYear();
                      const mm = String(dataNasc.getMonth() + 1).padStart(2, '0');
                      const dd = String(dataNasc.getDate()).padStart(2, '0');
                      return `${yyyy}-${mm}-${dd}`;
                    };
                    // Tentar usar a fun√ß√£o global primeiro, depois a local, depois a inline
                    let dataCalc = '';
                    if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
                      dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
                    } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
                      dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
                    } else {
                      dataCalc = calcularData(idadeMeses);
                    }
                    if (dataNascInput && dataCalc) {
                      // Input type="date" precisa do formato YYYY-MM-DD
                      dataNascInput.value = dataCalc; // dataCalc j√° est√° no formato YYYY-MM-DD
                    }
                    // Validar e habilitar bot√£o (aceita idade OU data)
                    const sexo = sexoInput ? sexoInput.value.trim() : '';
                    const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
                    const temIdadeOuData = idadeMeses || dataNasc;
                    
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                if (sexoInput) {
                  sexoInput.addEventListener('change', function() {
                    const idade = idadeInput ? idadeInput.value.trim() : '';
                    const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
                    const sexo = this.value.trim();
                    const temIdadeOuData = idade || dataNasc;
                    
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                // Event listener para data de nascimento (calcular idade)
                if (dataNascInput) {
                  dataNascInput.addEventListener('change', function() {
                    const dataNasc = this.value.trim();
                    const idade = idadeInput ? idadeInput.value.trim() : '';
                    const sexo = sexoInput ? sexoInput.value.trim() : '';
                    
                    if (dataNasc && !idade) {
                      // Calcular idade em meses
                      const hoje = new Date();
                      const nasc = new Date(dataNasc);
                      const diffAnos = hoje.getFullYear() - nasc.getFullYear();
                      const diffMeses = hoje.getMonth() - nasc.getMonth();
                      const diffDias = hoje.getDate() - nasc.getDate();
                      let totalMeses = diffAnos * 12 + diffMeses;
                      if (diffDias < 0) {
                        totalMeses--;
                      }
                      if (totalMeses >= 0 && idadeInput) {
                        idadeInput.value = totalMeses.toString();
                        console.log('‚úÖ Idade calculada da data:', totalMeses, 'meses');
                      }
                    }
                    
                    // Validar bot√£o
                    const temIdadeOuData = idade || dataNasc;
                    if (okBtn && temIdadeOuData && sexo) {
                      okBtn.disabled = false;
                      okBtn.removeAttribute('disabled');
                      okBtn.style.opacity = '1';
                      okBtn.style.cursor = 'pointer';
                      okBtn.classList.remove('disabled');
                    } else if (okBtn) {
                      okBtn.disabled = true;
                      okBtn.setAttribute('disabled', 'disabled');
                      okBtn.style.opacity = '0.6';
                      okBtn.style.cursor = 'not-allowed';
                      okBtn.classList.add('disabled');
                    }
                  });
                }
                
                // Garantir que o event listener do bot√£o esteja anexado
                if (okBtn) {
                  const temListener = okBtn.getAttribute('data-listener-anexado');
                  if (!temListener) {
                    console.log('‚úÖ Anexando event listener ao bot√£o de cadastro');
                    okBtn.setAttribute('data-listener-anexado', 'true');
                    okBtn.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log('üñ±Ô∏è Bot√£o de cadastro clicado!');
                      
                      // CHAMAR FUN√á√ÉO DIRETAMENTE - VERS√ÉO SIMPLIFICADA
                      console.log('üîç Verificando fun√ß√£o window.registrarCadastroEstoqueV2...');
                      
                      if (typeof window.registrarCadastroEstoqueV2 === 'function') {
                        const fnStr = window.registrarCadastroEstoqueV2.toString();
                        const isStub = fnStr.indexOf('[STUB]') !== -1 || fnStr.length < 500 || window.registrarCadastroEstoqueV2._isStub === true;
                        
                        console.log('  - Tamanho:', fnStr.length, 'caracteres');
                        console.log('  - Cont√©m [STUB]?', fnStr.indexOf('[STUB]') !== -1);
                        console.log('  - Flag _isStub:', window.registrarCadastroEstoqueV2._isStub);
                        console.log('  - √â stub?', isStub ? 'SIM ‚ùå' : 'N√ÉO ‚úÖ');
                        
                        if (!isStub) {
                          console.log('‚úÖ Chamando window.registrarCadastroEstoqueV2()...');
                          try {
                            window.registrarCadastroEstoqueV2();
                          } catch (err) {
                            console.error('‚ùå Erro ao executar fun√ß√£o:', err);
                            const mensagemErro = err.message || 'Erro desconhecido';
                            if (typeof mostrarToast === 'function') {
                              mostrarToast('Erro ao processar cadastro: ' + mensagemErro, 'error');
                            } else {
                              alert('Erro ao processar cadastro: ' + mensagemErro);
                            }
                          }
                        } else {
                          console.error('‚ùå Fun√ß√£o encontrada mas √© apenas o stub!');
                          const mensagem = 'Erro: fun√ß√£o de registro ainda n√£o foi carregada completamente. Aguarde alguns segundos e tente novamente.';
                          if (typeof mostrarToast === 'function') {
                            mostrarToast(mensagem, 'error');
                          } else {
                            alert(mensagem);
                          }
                        }
                      } else {
                        console.error('‚ùå Fun√ß√£o window.registrarCadastroEstoqueV2 n√£o encontrada!');
                        const mensagem = 'Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina com Ctrl+Shift+R (limpar cache).';
                        if (typeof mostrarToast === 'function') {
                          mostrarToast(mensagem, 'error');
                        } else {
                          alert(mensagem + '\n\nVerifique o console (F12) para mais detalhes.');
                        }
                      }
                    });
                  }
                }
              }, 100);
            }
            // Fun√ß√£o de valida√ß√£o que ser√° chamada ap√≥s os campos serem preenchidos
            const validarAposPreenchimento = () => {
              const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
              const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
              const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
              const sexoInput = document.getElementById('estoqueCadastroSexoV2');
              
              if (!okBtn || !sexoInput) {
                console.log('‚ö†Ô∏è Elementos do modal n√£o encontrados para valida√ß√£o');
                return;
              }
              
              const idade = idadeInput ? idadeInput.value.trim() : '';
              const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
              const sexo = sexoInput.value.trim();
              const temIdadeOuData = idade || dataNasc;
              
              console.log('üîç Valida√ß√£o manual:', { 
                idade, 
                dataNasc, 
                sexo, 
                temIdadeOuData,
                idadeInputExiste: !!idadeInput,
                dataNascInputExiste: !!dataNascInput,
                sexoInputExiste: !!sexoInput
              });
              
              if (temIdadeOuData && sexo) {
                console.log('‚úÖ Habilitando bot√£o manualmente');
                okBtn.disabled = false;
                okBtn.removeAttribute('disabled');
                okBtn.style.opacity = '1';
                okBtn.style.cursor = 'pointer';
                okBtn.classList.remove('disabled');
              } else {
                console.log('‚ùå Desabilitando bot√£o manualmente - faltando:', { idadeOuData: !temIdadeOuData, sexo: !sexo });
                okBtn.disabled = true;
                okBtn.setAttribute('disabled', 'disabled');
                okBtn.style.opacity = '0.6';
                okBtn.style.cursor = 'not-allowed';
                okBtn.classList.add('disabled');
              }
            };
            
            // Habilitar/desabilitar bot√£o baseado nos campos (com delay maior para garantir que campos estejam preenchidos)
            setTimeout(() => {
              if (typeof validarCamposEstoque === 'function') {
                validarCamposEstoque();
              } else {
                validarAposPreenchimento();
              }
              
              // Adicionar event listeners para validar em tempo real
              const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
              const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
              const sexoInput = document.getElementById('estoqueCadastroSexoV2');
              
              if (idadeInput) {
                idadeInput.addEventListener('input', validarAposPreenchimento);
                idadeInput.addEventListener('change', validarAposPreenchimento);
              }
              if (dataNascInput) {
                dataNascInput.addEventListener('input', validarAposPreenchimento);
                dataNascInput.addEventListener('change', validarAposPreenchimento);
              }
              if (sexoInput) {
                sexoInput.addEventListener('change', validarAposPreenchimento);
              }
            }, 300);
            return true;
          }
          
          return false;
        };
        
        // Tentar abrir imediatamente
        if (!tentarAbrirModal()) {
          // Se n√£o conseguiu, tentar novamente ap√≥s delays progressivos
          console.log('‚è≥ Modal n√£o encontrado, tentando novamente...');
          const tentativas = [300, 500, 1000, 2000];
          tentativas.forEach((delay, index) => {
            setTimeout(() => {
              if (tentarAbrirModal()) {
                console.log(`‚úÖ Modal aberto na tentativa ${index + 1}`);
              } else if (index === tentativas.length - 1) {
                // √öltima tentativa falhou
                if (typeof mostrarToast === 'function') {
                  mostrarToast('Brinco encontrado no estoque. Preencha os dados para cadastrar.', 'info');
                } else {
                  alert('Brinco encontrado no estoque. Use o cadastro de animais.');
                }
              }
            }, delay);
          });
        }
      } else {
        console.log('Brinco n√£o encontrado:', data.mensagem);
        mostrarToast(data.mensagem || 'Brinco n√£o encontrado.', 'warning');
      }
    } catch (err) {
      console.error('Erro na busca direta:', err);
      mostrarLoading(false);
      mostrarToast('Erro ao buscar brinco: ' + err.message, 'error');
    }
  }
  
  // Processar animal encontrado (se identificarBrinco n√£o estiver dispon√≠vel)
  function processarAnimalEncontrado(dados) {
    console.log('Processando animal encontrado:', dados);
    currentAnimalV2 = dados;
    
    // Preparar dados no formato esperado pelo popup
    const dadosPopup = {
      brinco: dados.numero_brinco || dados.codigo_sisbov || '',
      codigo_sisbov: dados.codigo_sisbov || dados.numero_brinco || '',
      numero_manejo: dados.numero_manejo || '',
      situacao_bnd: dados.situacao_bnd || '',
      consta_bnd: dados.consta_bnd || false,
      raca: dados.raca || '',
      sexo: dados.sexo || dados.get_sexo_display || '',
      data_nascimento: dados.data_nascimento || dados.data_nascimento_format || '',
      ultimo_peso: dados.peso_atual || (dados.pesagem_atual && dados.pesagem_atual.peso) || '',
      lote: dados.lote_atual || dados.lote || '',
      status_reprodutivo: dados.status_reprodutivo || ''
    };
    
    // Atualizar campos do formul√°rio
    if (dados.numero_brinco && brincoInput) {
      brincoInput.value = dados.numero_brinco;
    }
    
    // Atualizar resumo do scanner - PASSAR DADOS ORIGINAIS
    if (typeof window.atualizarScannerResumoV2 === 'function') {
      console.log('‚úÖ Chamando atualizarScannerResumoV2 com dados originais');
      window.atualizarScannerResumoV2(dados);
    } else if (typeof atualizarScannerResumoV2 === 'function') {
      console.log('‚úÖ Chamando atualizarScannerResumoV2 (sem window) com dados originais');
      atualizarScannerResumoV2(dados);
    }
    
    // Atualizar resumo de pesagem
    if (typeof atualizarResumoPesagemV2 === 'function') {
      atualizarResumoPesagemV2();
    }
    
    // Abrir popup de confirma√ß√£o
    if (typeof abrirPopupBrinco === 'function') {
      console.log('Abrindo popup de confirma√ß√£o...');
      abrirPopupBrinco(dadosPopup);
    } else {
      console.warn('Fun√ß√£o abrirPopupBrinco n√£o encontrada, tentando abrir manualmente...');
      // Tentar abrir popup manualmente
      const overlay = document.getElementById('brincoConfirmOverlay');
      if (overlay) {
        console.log('Preenchendo popup manualmente...');
        
        // Preencher todos os campos do popup manualmente
        const numeroEl = document.getElementById('brincoConfirmNumero');
        if (numeroEl) numeroEl.textContent = dadosPopup.brinco || '‚Äî';
        
        const sisbovEl = document.getElementById('brincoConfirmSisbov');
        if (sisbovEl) sisbovEl.textContent = dadosPopup.codigo_sisbov || '‚Äî';
        
        const manejoEl = document.getElementById('brincoConfirmManejo');
        if (manejoEl) manejoEl.textContent = dadosPopup.numero_manejo || '‚Äî';
        
        const bndEl = document.getElementById('brincoConfirmBnd');
        if (bndEl) {
          if (typeof formatarStatusBnd === 'function') {
            bndEl.innerHTML = formatarStatusBnd(dadosPopup.situacao_bnd, dadosPopup.consta_bnd);
          } else {
            bndEl.innerHTML = `<span>${dadosPopup.consta_bnd ? 'Sim' : 'N√£o'}</span>`;
          }
        }
        
        const racaEl = document.getElementById('brincoConfirmRaca');
        if (racaEl) racaEl.textContent = dadosPopup.raca || '‚Äî';
        
        const sexoEl = document.getElementById('brincoConfirmSexo');
        if (sexoEl) sexoEl.textContent = dadosPopup.sexo || '‚Äî';
        
        const nascEl = document.getElementById('brincoConfirmDataNasc');
        if (nascEl) nascEl.textContent = dadosPopup.data_nascimento || '‚Äî';
        
        const pesoEl = document.getElementById('brincoConfirmUltimoPeso');
        if (pesoEl) {
          const pesoFormatado = dadosPopup.ultimo_peso 
            ? (typeof dadosPopup.ultimo_peso === 'number' 
                ? dadosPopup.ultimo_peso.toFixed(1).replace('.', ',') + ' kg'
                : dadosPopup.ultimo_peso)
            : '‚Äî';
          pesoEl.textContent = pesoFormatado;
        }
        
        const loteEl = document.getElementById('brincoConfirmLote');
        if (loteEl) loteEl.textContent = dadosPopup.lote || '‚Äî';
        
        const reprodEl = document.getElementById('brincoConfirmReprodutivo');
        if (reprodEl) reprodEl.textContent = dadosPopup.status_reprodutivo || '‚Äî';
        
        // Mostrar popup
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        console.log('‚úÖ Popup aberto manualmente com todos os dados!');
      } else {
        console.error('Overlay do popup n√£o encontrado!');
        mostrarToast(`Animal encontrado: ${dados.numero_brinco || dados.codigo_sisbov}`, 'success');
      }
    }
  }
  // Declarar propriedadeId (primeira declara√ß√£o global)
  const propriedadeId = parseInt('{{ propriedade.id|default:"0" }}') || 0;
  let currentAnimalV2 = null;
  
  // Elementos do card de registros
  const cardRegistrosAnimal = document.getElementById('cardRegistrosAnimalV2');
  const registrosAnimalConteudo = document.getElementById('registrosAnimalConteudoV2');
  const btnFichaAnimal = document.getElementById('btnFichaAnimalV2');

  function atualizarPesoV2(valor) {
    if (!pesoInput) return;
    if (valor && valor > 0) {
      // Formata o valor com v√≠rgula como separador decimal
      const valorFormatado = valor.toFixed(1).replace('.', ',');
      pesoInput.value = valorFormatado;
    } else {
      pesoInput.value = '';
    }
  }

  function formatarNumeroBr(val) {
    if (val === null || val === undefined || val === '' || isNaN(val)) return '‚Äî';
    return Number(val).toFixed(1).replace('.', ',') + ' kg';
  }

  // Tornar fun√ß√£o global para uso fora do DOMContentLoaded
  window.atualizarResumoPesagemV2 = function(pesoNovo = null, dataNovaISO = null) {
    console.log('üìä atualizarResumoPesagemV2 chamado com:', { pesoNovo, dataNovaISO });
    
    // Buscar elementos do DOM diretamente (n√£o depender de vari√°veis globais)
    const pesoUltimoValor = document.getElementById('pesoUltimoValorV2');
    const pesoUltimoData = document.getElementById('pesoUltimoDataV2');
    const pesoDias = document.getElementById('pesoDiasV2');
    const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
    const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
    
    console.log('üîç Elementos encontrados:', {
      pesoUltimoValor: !!pesoUltimoValor,
      pesoUltimoData: !!pesoUltimoData,
      pesoDias: !!pesoDias,
      pesoGanhoTotal: !!pesoGanhoTotal,
      pesoGanhoDia: !!pesoGanhoDia
    });
    
    if (!pesoUltimoValor || !pesoUltimoData || !pesoDias || !pesoGanhoTotal || !pesoGanhoDia) {
      console.warn('‚ö†Ô∏è Elementos de resumo de pesagem n√£o encontrados');
      return;
    }
    
    // Usar window.animalAtualV2 como prioridade, com fallback para currentAnimalV2
    const animal = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    
    console.log('üêÑ Animal encontrado:', !!animal, animal ? {
      id: animal.id,
      peso_atual: animal.peso_atual,
      peso_anterior: animal.peso_anterior,
      data_peso_atual: animal.data_peso_atual,
      data_peso_anterior: animal.data_peso_anterior
    } : 'null');
    
    if (!animal) {
      console.warn('‚ö†Ô∏è Animal n√£o encontrado, limpando campos');
      pesoUltimoValor.textContent = '‚Äî';
      pesoUltimoData.textContent = '‚Äî';
      pesoDias.textContent = '‚Äî';
      pesoGanhoTotal.textContent = '‚Äî';
      pesoGanhoDia.textContent = '‚Äî';
      if (pesoAtualValor) pesoAtualValor.textContent = '‚Äî';
      if (periodoDiasValor) periodoDiasValor.textContent = '‚Äî';
      return;
    }

    // Se temos peso novo, atualizar o resumo com o novo peso
    if (pesoNovo) {
      const hojeISO = dataNovaISO || new Date().toISOString().slice(0, 10);
      const hojeFormatado = new Date(hojeISO).toLocaleDateString('pt-BR');
      
      console.log('‚úÖ Atualizando com peso novo:', pesoNovo, 'Data:', hojeFormatado);
      
      // Atualizar √∫ltimo peso e data com o novo peso registrado (SEMPRE atualizar estes campos)
      const pesoFormatado = typeof formatarNumeroBr === 'function' 
        ? formatarNumeroBr(pesoNovo) 
        : `${parseFloat(pesoNovo).toFixed(1).replace('.', ',')} kg`;
      
      pesoUltimoValor.textContent = pesoFormatado;
      pesoUltimoData.textContent = hojeFormatado;
      
      // Atualizar Peso Atual com o novo peso
      if (pesoAtualValor) {
        pesoAtualValor.textContent = pesoFormatado;
        console.log('‚úÖ Campo "Peso Atual" atualizado:', pesoFormatado);
      }
      
      console.log('‚úÖ Campos atualizados:', {
        pesoUltimoValor: pesoFormatado,
        pesoUltimoData: hojeFormatado,
        pesoAtual: pesoFormatado
      });
      
      // Calcular ganho se temos peso anterior (que seja diferente do novo peso)
      const ultimoPeso = animal.peso_anterior || (animal.peso_atual && parseFloat(animal.peso_atual) !== parseFloat(pesoNovo) ? animal.peso_atual : null);
      const dataUltimaISO = animal.data_peso_anterior || (animal.data_peso_atual && parseFloat(animal.peso_atual) !== parseFloat(pesoNovo) ? animal.data_peso_atual : null);
      
      console.log('üìà Dados para c√°lculo de ganho:', {
        ultimoPeso,
        dataUltimaISO,
        pesoNovo
      });
      
      if (ultimoPeso && dataUltimaISO && parseFloat(ultimoPeso) > 0 && parseFloat(ultimoPeso) !== parseFloat(pesoNovo)) {
        const dtUltima = new Date(dataUltimaISO);
        const dtNova = new Date(hojeISO);
        const diffMs = dtNova - dtUltima;
        const dias = Math.max(1, Math.round(diffMs / (1000 * 60 * 60 * 24)));
        const ganhoTotal = parseFloat(pesoNovo) - parseFloat(ultimoPeso);
        const ganhoDia = ganhoTotal / dias;
        
        pesoDias.textContent = `${dias} dias`;
        pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
        pesoGanhoDia.textContent = `${ganhoDia >= 0 ? '+' : ''}${ganhoDia.toFixed(2).replace('.', ',')} kg/dia`;
        
        // Atualizar Per√≠odos em Dias
        if (periodoDiasValor) {
          periodoDiasValor.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
          console.log('‚úÖ Campo "Per√≠odos em Dias" atualizado:', dias, 'dias');
        }
        
        console.log('‚úÖ Ganho calculado:', { dias, ganhoTotal, ganhoDia });
      } else {
        // Se n√£o temos peso anterior, mostrar apenas o novo peso (mas sempre mostrar peso e data)
        pesoDias.textContent = '‚Äî';
        pesoGanhoTotal.textContent = '‚Äî';
        pesoGanhoDia.textContent = '‚Äî';
        if (periodoDiasValor) {
          periodoDiasValor.textContent = '‚Äî';
        }
        console.log('‚ÑπÔ∏è Sem peso anterior para calcular ganho');
      }
      
      // Atualizar o animal em mem√≥ria para pr√≥xima pesagem
      if (window.animalAtualV2) {
        window.animalAtualV2.peso_anterior = ultimoPeso || pesoNovo;
        window.animalAtualV2.data_peso_anterior = dataUltimaISO || hojeISO;
        window.animalAtualV2.peso_atual = pesoNovo;
        window.animalAtualV2.data_peso_atual = hojeISO;
        window.animalAtualV2.pesagem_atual = { peso: pesoNovo, data: hojeISO };
      }
      if (typeof currentAnimalV2 !== 'undefined' && currentAnimalV2) {
        currentAnimalV2.peso_anterior = ultimoPeso || pesoNovo;
        currentAnimalV2.data_peso_anterior = dataUltimaISO || hojeISO;
        currentAnimalV2.peso_atual = pesoNovo;
        currentAnimalV2.data_peso_atual = hojeISO;
      }
    } else {
      // Se n√£o temos peso novo, apenas mostrar o √∫ltimo peso conhecido
      const ultimoPeso = animal.peso_atual;
      const dataUltimaISO = animal.data_peso_atual || animal.data_peso_iso || null;

      if (ultimoPeso && dataUltimaISO) {
        pesoUltimoValor.textContent = typeof formatarNumeroBr === 'function' 
          ? formatarNumeroBr(ultimoPeso) 
          : `${parseFloat(ultimoPeso).toFixed(1).replace('.', ',')} kg`;
        const d = new Date(dataUltimaISO);
        pesoUltimoData.textContent = d.toLocaleDateString('pt-BR');
      } else {
        pesoUltimoValor.textContent = '‚Äî';
        pesoUltimoData.textContent = '‚Äî';
      }
      
      pesoDias.textContent = '‚Äî';
      pesoGanhoTotal.textContent = '‚Äî';
      pesoGanhoDia.textContent = '‚Äî';
    }
  }

  async function carregarRegistrosAnimal(animalId) {
    if (!animalId || !cardRegistrosAnimal || !registrosAnimalConteudo) return;
    
    try {
      const url = `/propriedade/${propriedadeId}/curral/api/animal/${animalId}/registros/`;
      const resp = await fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });
      
      if (!resp.ok) {
        console.error('Erro ao buscar registros do animal');
        return;
      }
      
      const data = await resp.json();
      if (data.status === 'ok' && data.registros) {
        exibirRegistrosAnimal(data.registros, data.resumos);
        if (cardRegistrosAnimal) {
          cardRegistrosAnimal.style.display = 'block';
        }
      }
    } catch (e) {
      console.error('Erro ao carregar registros do animal:', e);
    }
  }

  function exibirRegistrosAnimal(registros, resumos) {
    if (!registrosAnimalConteudo) return;
    
    let html = '';
    
    // Se√ß√£o de Pesagens
    if (registros.pesagens && registros.pesagens.length > 0) {
      html += '<div class="registros-animal-section">';
      html += '<div class="registros-animal-section-title"><i class="fas fa-weight"></i> Pesagens</div>';
      registros.pesagens.forEach(p => {
        const peso = p.peso ? `${p.peso.toFixed(1).replace('.', ',')} kg` : '';
        html += `<div class="registro-item pesagem">
          <span class="registro-data">${p.data}</span>
          <span class="registro-descricao">${p.descricao || 'Pesagem'}</span>
          <span class="registro-valor">${peso}</span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Se√ß√£o de Entradas
    if (registros.entradas && registros.entradas.length > 0) {
      html += '<div class="registros-animal-section">';
      html += '<div class="registros-animal-section-title"><i class="fas fa-sign-in-alt"></i> Entradas</div>';
      registros.entradas.forEach(e => {
        html += `<div class="registro-item entrada">
          <span class="registro-data">${e.data}</span>
          <span class="registro-descricao">${e.tipo}${e.origem ? ' - ' + e.origem : ''}</span>
          <span class="registro-valor"></span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Se√ß√£o de Sa√≠das
    if (registros.saidas && registros.saidas.length > 0) {
      html += '<div class="registros-animal-section">';
      html += '<div class="registros-animal-section-title"><i class="fas fa-sign-out-alt"></i> Sa√≠das</div>';
      registros.saidas.forEach(s => {
        html += `<div class="registro-item saida">
          <span class="registro-data">${s.data}</span>
          <span class="registro-descricao">${s.tipo}${s.destino ? ' - ' + s.destino : ''}</span>
          <span class="registro-valor"></span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Se√ß√£o de Movimenta√ß√µes
    if (registros.movimentacoes && registros.movimentacoes.length > 0) {
      html += '<div class="registros-animal-section">';
      html += '<div class="registros-animal-section-title"><i class="fas fa-exchange-alt"></i> Movimenta√ß√µes</div>';
      registros.movimentacoes.forEach(m => {
        html += `<div class="registro-item movimentacao">
          <span class="registro-data">${m.data}</span>
          <span class="registro-descricao">${m.descricao || m.tipo}</span>
          <span class="registro-valor"></span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Resumo
    if (resumos) {
      html += '<div class="resumo-registros">';
      html += '<div class="registros-animal-section-title">Resumo</div>';
      html += '<div class="resumo-registros-grid">';
      
      // Resumo de Pesagens
      if (resumos.total_pesagens > 0) {
        let detalhesCategoria = '';
        if (resumos.pesagens_por_categoria) {
          const categorias = Object.entries(resumos.pesagens_por_categoria)
            .map(([cat, qtd]) => `${cat}: ${qtd}`)
            .join(', ');
          detalhesCategoria = `<div class="resumo-registros-detalhes">${categorias}</div>`;
        }
        html += `<div class="resumo-registros-item pesagem">
          <div class="resumo-registros-label">Pesagens</div>
          <div class="resumo-registros-total">${resumos.total_pesagens}</div>
          ${detalhesCategoria}
        </div>`;
      }
      
      // Resumo de Entradas
      if (resumos.total_entradas > 0) {
        html += `<div class="resumo-registros-item entrada">
          <div class="resumo-registros-label">Entradas</div>
          <div class="resumo-registros-total">${resumos.total_entradas}</div>
        </div>`;
      }
      
      // Resumo de Sa√≠das
      if (resumos.total_saidas > 0) {
        html += `<div class="resumo-registros-item saida">
          <div class="resumo-registros-label">Sa√≠das</div>
          <div class="resumo-registros-total">${resumos.total_saidas}</div>
        </div>`;
      }
      
      // Resumo de Movimenta√ß√µes
      if (resumos.total_movimentacoes > 0) {
        html += `<div class="resumo-registros-item movimentacao">
          <div class="resumo-registros-label">Movimenta√ß√µes</div>
          <div class="resumo-registros-total">${resumos.total_movimentacoes}</div>
        </div>`;
      }
      
      html += '</div></div>';
    }
    
    if (!html) {
      html = '<div class="text-center text-muted py-4">Nenhum registro encontrado para este animal.</div>';
    }
    
    registrosAnimalConteudo.innerHTML = html;
  }

  // Tornar fun√ß√£o global para uso fora do DOMContentLoaded
  window.atualizarScannerResumoV2 = function(dados) {
    // Buscar elementos dinamicamente para garantir que existem
    const scannerCodigoEletronicoEl = document.getElementById('scannerCodigoEletronicoV2');
    const scannerSisbovEl = document.getElementById('scannerSisbovV2');
    const scannerNumeroManejoEl = document.getElementById('scannerNumeroManejoV2');
    const scannerRacaSexoEl = document.getElementById('scannerRacaSexoV2');
    const scannerDataNascEl = document.getElementById('scannerDataNascV2');
    const scannerUltimoPesoEl = document.getElementById('scannerUltimoPesoV2');
    const scannerCategoriaEl = document.getElementById('scannerCategoriaV2');
    const scannerDiagnosticoEl = document.getElementById('scannerDiagnosticoV2');
    const resumoItemDiagnosticoEl = document.getElementById('resumoItemDiagnosticoV2');
    const scannerPastoLoteEl = document.getElementById('scannerPastoLoteV2');
    const scannerStatusBndEl = document.getElementById('scannerStatusBndV2');
    const btnFichaAnimalEl = document.getElementById('btnFichaAnimalV2');
    const cardRegistrosAnimalEl = document.getElementById('cardRegistrosAnimalV2');
    
    if (!dados) {
      if (scannerCodigoEletronicoEl) scannerCodigoEletronicoEl.textContent = '‚Äî';
      if (scannerSisbovEl) {
        scannerSisbovEl.textContent = '‚Äî';
        scannerSisbovEl.className = 'resumo-value resumo-sisbov';
      }
      if (scannerNumeroManejoEl) {
        scannerNumeroManejoEl.textContent = '‚Äî';
        scannerNumeroManejoEl.className = 'resumo-value resumo-numero-manejo';
      }
      if (scannerRacaSexoEl) scannerRacaSexoEl.textContent = '‚Äî';
      if (scannerDataNascEl) scannerDataNascEl.textContent = '‚Äî';
      if (scannerUltimoPesoEl) scannerUltimoPesoEl.textContent = '‚Äî';
      if (scannerCategoriaEl) scannerCategoriaEl.textContent = '‚Äî';
      if (scannerDiagnosticoEl) scannerDiagnosticoEl.textContent = '‚Äî';
      if (resumoItemDiagnosticoEl) resumoItemDiagnosticoEl.style.display = 'none';
      if (scannerPastoLoteEl) scannerPastoLoteEl.textContent = '‚Äî';
      if (scannerStatusBndEl) {
        scannerStatusBndEl.textContent = '‚Äî';
        scannerStatusBndEl.className = 'resumo-value';
      }
      if (btnFichaAnimalEl) btnFichaAnimalEl.style.display = 'none';
      
      // Desabilitar campo de peso quando n√£o h√° animal
      if (typeof window.desabilitarCampoPesoV2 === 'function') {
        window.desabilitarCampoPesoV2();
      }
      if (cardRegistrosAnimalEl) cardRegistrosAnimalEl.style.display = 'none';
      return;
    }
    
    // C√≥digo Eletr√¥nico (usado para leitura por radio frequ√™ncia)
    const codigoEletronico = dados.codigo_eletronico || '';
    const codigoEletronicoFormatado = (codigoEletronico && codigoEletronico !== 'None' && codigoEletronico !== '') ? codigoEletronico : '‚Äî';
    const sisbov = dados.codigo_sisbov || dados.numero_brinco || '‚Äî';
    
    // Preencher campos com dados
    if (scannerCodigoEletronicoEl) {
      scannerCodigoEletronicoEl.textContent = codigoEletronicoFormatado;
    }
    if (scannerSisbovEl) {
      scannerSisbovEl.textContent = sisbov;
      scannerSisbovEl.className = 'resumo-value resumo-sisbov';
    }
    if (scannerNumeroManejoEl) {
      scannerNumeroManejoEl.textContent = dados.numero_manejo || '‚Äî';
      scannerNumeroManejoEl.className = 'resumo-value resumo-numero-manejo';
    }
    if (scannerRacaSexoEl) {
      const raca = dados.raca || '';
      const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(raca) : raca;
      const sexo = dados.sexo || '';
      const texto = [racaCompleta, sexo].filter(Boolean).join(' ¬∑ ');
      scannerRacaSexoEl.textContent = texto || '‚Äî';
    }
    if (scannerDataNascEl) {
      // Tentar m√∫ltiplas fontes para data de nascimento
      const dataNasc = dados.data_nascimento_format || dados.data_nascimento || '';
      scannerDataNascEl.textContent = dataNasc || '‚Äî';
    }
    if (scannerUltimoPesoEl) {
      // Tentar m√∫ltiplas fontes para o √∫ltimo peso
      const up = dados.ultimo_peso || dados.peso_atual || (dados.pesagem_atual && dados.pesagem_atual.peso);
      scannerUltimoPesoEl.textContent = up ? formatarNumeroBr(up) : '‚Äî';
    }
    
    // Categoria
    if (scannerCategoriaEl) {
      const categoria = dados.categoria || '';
      scannerCategoriaEl.textContent = categoria || '‚Äî';
    }
    
    // Diagn√≥stico (mostrar apenas se houver)
    const statusReprodutivo = dados.status_reprodutivo || '';
    if (statusReprodutivo && resumoItemDiagnosticoEl && scannerDiagnosticoEl) {
      resumoItemDiagnosticoEl.style.display = 'flex';
      scannerDiagnosticoEl.textContent = statusReprodutivo;
    } else if (resumoItemDiagnosticoEl) {
      resumoItemDiagnosticoEl.style.display = 'none';
    }
    
    // Pasto/Lote
    if (scannerPastoLoteEl) {
      const loteAtual = dados.lote_atual || '';
      scannerPastoLoteEl.textContent = loteAtual || '‚Äî';
    }
    
    // Status BND Sisbov
    if (scannerStatusBndEl) {
      const constaBnd = dados.consta_bnd !== undefined ? dados.consta_bnd : true;
      const situacaoBnd = dados.situacao_bnd || '';
      
      // Remover classes anteriores
      scannerStatusBndEl.className = 'resumo-value';
      
      if (situacaoBnd === 'CONFORME' || (constaBnd && !situacaoBnd)) {
        scannerStatusBndEl.textContent = 'Conforme BND';
        scannerStatusBndEl.classList.add('status-bnd-conforme');
      } else if (situacaoBnd === 'NAO_CONFORME' || (!constaBnd && !situacaoBnd)) {
        scannerStatusBndEl.textContent = 'N√£o Conforme';
        scannerStatusBndEl.classList.add('status-bnd-nao-conforme');
      } else if (situacaoBnd === 'ATUALIZAR' || situacaoBnd === 'DIVERGENCIA' || situacaoBnd.includes('DIVERGENCIA') || situacaoBnd.includes('ATUALIZAR')) {
        let divergenciaTexto = 'Diverg√™ncia de Cadastro';
        if (situacaoBnd.includes(':')) {
          divergenciaTexto = situacaoBnd.split(':')[1].trim();
        } else if (situacaoBnd === 'ATUALIZAR') {
          divergenciaTexto = 'C√≥digo existe na BND mas precisa ser atualizado no sistema';
        }
        scannerStatusBndEl.textContent = `Diverg√™ncia de Cadastro: ${divergenciaTexto}`;
        scannerStatusBndEl.classList.add('status-bnd-divergencia');
      } else {
        scannerStatusBndEl.textContent = situacaoBnd || '‚Äî';
      }
    }
    
    // Mostrar bot√£o de ficha e carregar registros se houver ID do animal
    const animalAtual = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    if (animalAtual && animalAtual.id) {
      if (btnFichaAnimalEl) {
        btnFichaAnimalEl.style.display = 'block';
        btnFichaAnimalEl.onclick = () => {
          // Buscar propriedadeId dinamicamente
          const propIdMatch = window.location.pathname.match(/propriedade\/(\d+)/);
          const propId = propIdMatch ? propIdMatch[1] : '0';
          window.location.href = `/propriedade/${propId}/pecuaria/rastreabilidade/animal/${animalAtual.id}/`;
        };
      }
      if (typeof carregarRegistrosAnimal === 'function') {
        carregarRegistrosAnimal(animalAtual.id);
      }
    } else {
      if (btnFichaAnimalEl) btnFichaAnimalEl.style.display = 'none';
      if (cardRegistrosAnimalEl) cardRegistrosAnimalEl.style.display = 'none';
    }
    
    // ========== ATUALIZAR FICHA CADASTRAL V4 ==========
    console.log('üìã [FICHA V4] Atualizando ficha cadastral V4...', dados ? 'Dados recebidos' : 'Sem dados');
    
    // Atualizar campos da nova ficha cadastral
    const fichaCodigoEletronico = document.getElementById('fichaCodigoEletronicoV4');
    const fichaSisbov = document.getElementById('fichaSisbovV4');
    const fichaNumeroManejo = document.getElementById('fichaNumeroManejoV4');
    const fichaRaca = document.getElementById('fichaRacaV4');
    const fichaSexo = document.getElementById('fichaSexoV4');
    const fichaNascimento = document.getElementById('fichaNascimentoV4');
    const fichaCategoria = document.getElementById('fichaCategoriaV4');
    const fichaPastoLote = document.getElementById('fichaPastoLoteV4');
    const fichaStatusBnd = document.getElementById('fichaStatusBndV4');
    const fichaUltimoPeso = document.getElementById('fichaUltimoPesoV4');
    const fichaCotaHilton = document.getElementById('fichaCotaHiltonV4');
    
    console.log('üìã [FICHA V4] Elementos encontrados:', {
      fichaCodigoEletronico: !!fichaCodigoEletronico,
      fichaSisbov: !!fichaSisbov,
      fichaNumeroManejo: !!fichaNumeroManejo,
      fichaRaca: !!fichaRaca,
      fichaSexo: !!fichaSexo,
      fichaNascimento: !!fichaNascimento,
      fichaCategoria: !!fichaCategoria,
      fichaPastoLote: !!fichaPastoLote,
      fichaStatusBnd: !!fichaStatusBnd,
      fichaUltimoPeso: !!fichaUltimoPeso
    });
    
    if (dados) {
      if (fichaCodigoEletronico) {
        fichaCodigoEletronico.textContent = codigoEletronicoFormatado;
        console.log('‚úÖ [FICHA V4] C√≥digo Eletr√¥nico atualizado:', codigoEletronicoFormatado);
      } else {
        console.warn('‚ö†Ô∏è [FICHA V4] Elemento fichaCodigoEletronicoV4 n√£o encontrado!');
      }
      
      if (fichaSisbov) {
        fichaSisbov.textContent = sisbov;
        console.log('‚úÖ [FICHA V4] SISBOV atualizado:', sisbov);
      } else {
        console.warn('‚ö†Ô∏è [FICHA V4] Elemento fichaSisbovV4 n√£o encontrado!');
      }
      
      if (fichaNumeroManejo) {
        fichaNumeroManejo.textContent = dados.numero_manejo || '‚Äî';
        console.log('‚úÖ [FICHA V4] N¬∫ Manejo atualizado:', dados.numero_manejo || '‚Äî');
      } else {
        console.warn('‚ö†Ô∏è [FICHA V4] Elemento fichaNumeroManejoV4 n√£o encontrado!');
      }
      
      if (fichaRaca) {
        const racaCompleta = typeof window.obterNomeCompletoRaca === 'function' ? window.obterNomeCompletoRaca(dados.raca) : (dados.raca || '‚Äî');
        fichaRaca.textContent = racaCompleta;
        console.log('‚úÖ [FICHA V4] Ra√ßa atualizada:', dados.raca, '‚Üí', racaCompleta);
      }
      
      if (fichaSexo) {
        const sexoTexto = dados.sexo === 'F' ? 'F√™mea' : (dados.sexo === 'M' ? 'Macho' : '‚Äî');
        fichaSexo.textContent = sexoTexto;
        console.log('‚úÖ [FICHA V4] Sexo atualizado:', sexoTexto);
      }
      
      if (fichaNascimento) {
        const dataNasc = dados.data_nascimento_format || dados.data_nascimento || '';
        fichaNascimento.textContent = dataNasc || '‚Äî';
        console.log('‚úÖ [FICHA V4] Nascimento atualizado:', dataNasc || '‚Äî');
      }
      
      if (fichaCategoria) {
        fichaCategoria.textContent = dados.categoria || '‚Äî';
        console.log('‚úÖ [FICHA V4] Categoria atualizada:', dados.categoria || '‚Äî');
      }
      
      if (fichaPastoLote) {
        fichaPastoLote.textContent = dados.lote_atual || '‚Äî';
        console.log('‚úÖ [FICHA V4] Pasto/Lote atualizado:', dados.lote_atual || '‚Äî');
      }
      if (fichaStatusBnd) {
        const situacaoBnd = dados.situacao_bnd || '';
        if (situacaoBnd === 'CONFORME' || (!situacaoBnd && dados.consta_bnd !== false)) {
          fichaStatusBnd.textContent = 'Conforme';
        } else {
          fichaStatusBnd.textContent = situacaoBnd || '‚Äî';
        }
      }
      if (fichaUltimoPeso) {
        const up = dados.ultimo_peso || dados.peso_atual || (dados.pesagem_atual && dados.pesagem_atual.peso);
        if (up) {
          // Usar formatarNumeroBr se dispon√≠vel, sen√£o formatar manualmente
          if (typeof formatarNumeroBr === 'function') {
            fichaUltimoPeso.textContent = formatarNumeroBr(up);
          } else {
            const pesoNum = typeof up === 'number' ? up : parseFloat(up);
            fichaUltimoPeso.textContent = !isNaN(pesoNum) && pesoNum > 0 ? `${pesoNum.toFixed(1).replace('.', ',')} kg` : '‚Äî';
          }
        } else {
          fichaUltimoPeso.textContent = '‚Äî';
        }
      }
      
      console.log('‚úÖ Ficha Cadastral V4 atualizada:', {
        codigoEletronico: codigoEletronicoFormatado,
        sisbov: sisbov,
        numeroManejo: dados.numero_manejo || '‚Äî',
        raca: dados.raca || '‚Äî',
        sexo: dados.sexo || '‚Äî'
      });
      
      // Mostrar linha de reprodu√ß√£o se for f√™mea
      const linhaReproducaoCard = document.getElementById('linhaReproducaoCard');
      if (linhaReproducaoCard && dados.sexo === 'F') {
        linhaReproducaoCard.style.display = 'block';
        // Atualizar dados de reprodu√ß√£o se dispon√≠veis
        const linhaDiagnostico = document.getElementById('linhaDiagnosticoV4');
        const linhaDataInseminacao = document.getElementById('linhaDataInseminacaoV4');
        const linhaTouro = document.getElementById('linhaTouroV4');
        const linhaDataIATF = document.getElementById('linhaDataIATFV4');
        
        if (linhaDiagnostico) linhaDiagnostico.textContent = dados.status_reprodutivo || '‚Äî';
        if (linhaDataInseminacao) linhaDataInseminacao.textContent = dados.data_inseminacao || '‚Äî';
        if (linhaTouro) linhaTouro.textContent = dados.touro_nome || '‚Äî';
        if (linhaDataIATF) linhaDataIATF.textContent = dados.data_iatf || '‚Äî';
      } else if (linhaReproducaoCard) {
        linhaReproducaoCard.style.display = 'none';
      }
    } else {
      // Limpar campos quando dados s√£o null
      if (fichaCodigoEletronico) fichaCodigoEletronico.textContent = '‚Äî';
      if (fichaSisbov) fichaSisbov.textContent = '‚Äî';
      if (fichaNumeroManejo) fichaNumeroManejo.textContent = '‚Äî';
      if (fichaRaca) fichaRaca.textContent = '‚Äî';
      if (fichaSexo) fichaSexo.textContent = '‚Äî';
      if (fichaNascimento) fichaNascimento.textContent = '‚Äî';
      if (fichaCategoria) fichaCategoria.textContent = '‚Äî';
      if (fichaPastoLote) fichaPastoLote.textContent = '‚Äî';
      if (fichaStatusBnd) fichaStatusBnd.textContent = '‚Äî';
      if (fichaUltimoPeso) fichaUltimoPeso.textContent = '‚Äî';
      const linhaReproducaoCard = document.getElementById('linhaReproducaoCard');
      if (linhaReproducaoCard) linhaReproducaoCard.style.display = 'none';
    }
    
    // Atualizar vari√°veis globais
    if (typeof window !== 'undefined') {
      window.animalAtualV2 = dados;
      if (typeof currentAnimalV2 !== 'undefined') {
        currentAnimalV2 = dados;
      }
    }
    
    // ========== HABILITAR CAMPO DE PESO AP√ìS IDENTIFICAR ANIMAL ==========
    if (typeof window.habilitarCampoPesoV2 === 'function') {
      setTimeout(() => {
        window.habilitarCampoPesoV2();
      }, 100);
    } else {
      // Fallback se a fun√ß√£o n√£o estiver dispon√≠vel
      const pesoInput = document.getElementById('pesoValorV2');
      const gravarBtn = document.getElementById('pesoGravarBtnV2');
      
      if (pesoInput) {
        pesoInput.disabled = false;
        pesoInput.placeholder = '0,0';
        pesoInput.style.backgroundColor = '';
        pesoInput.style.cursor = 'text';
        pesoInput.focus();
        console.log('‚úÖ Campo de peso HABILITADO (fallback)');
      }
      
      if (gravarBtn) {
        gravarBtn.disabled = false;
        gravarBtn.style.opacity = '';
        gravarBtn.style.cursor = '';
        console.log('‚úÖ Bot√£o Gravar HABILITADO (fallback)');
      }
    }
  }

  function finalizarAnimalV2() {
    // S√≥ faz auto-pr√≥ximo se o usu√°rio marcar a op√ß√£o
    if (!autoProximoCheckbox || !autoProximoCheckbox.checked) {
      return;
    }
    // Limpa estado do animal atual e volta para leitura de brinco
    currentAnimalV2 = null;
    if (typeof window !== 'undefined') {
      window.animalAtualV2 = null;
    }
    brincoInput.value = '';
    atualizarPesoV2(0);
    atualizarResumoPesagemV2();
    atualizarScannerResumoV2(null); // Limpa tamb√©m o card de registros
    
    // Desabilitar campo de peso quando limpar brinco
    if (typeof window.desabilitarCampoPesoV2 === 'function') {
      window.desabilitarCampoPesoV2();
    }
    
    brincoInput.focus();
  }

  function abrirDiagnosticoV2() {
    if (!diagnosticoOverlay) return;
    diagnosticoSelecionado = null;
    diagnosticoBtns.forEach((btn) => btn.classList.remove('active'));
    diagnosticoOverlay.classList.add('show');
  }
  
  // Tornar fun√ß√£o global para uso na simula√ß√£o
  window.abrirDiagnosticoV2 = abrirDiagnosticoV2;

  function fecharDiagnosticoV2() {
    if (diagnosticoOverlay) {
      diagnosticoOverlay.classList.remove('show');
    }
    pararDiagnosticoVozV2();
  }

  function selecionarDiagnosticoV2(valor) {
    diagnosticoSelecionado = valor;
    diagnosticoBtns.forEach((btn) => {
      if (btn.dataset.valor === valor) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
  
  // Tornar fun√ß√£o global para uso na simula√ß√£o
  window.selecionarDiagnosticoV2 = selecionarDiagnosticoV2;

  function iniciarDiagnosticoVozV2() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert('Seu navegador n√£o suporta reconhecimento de voz para diagn√≥stico.');
      return;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    diagnosticoRecognition = new SR();
    diagnosticoRecognition.lang = 'pt-BR';
    diagnosticoRecognition.interimResults = false;
    diagnosticoReconhecendo = true;
    if (diagnosticoVozStatus) {
      diagnosticoVozStatus.textContent = 'Ouvindo... fale o diagn√≥stico e depois "ok" ou "cancelar".';
    }
    diagnosticoRecognition.onresult = (event) => {
      const texto = (event.results[0][0].transcript || '').toLowerCase();
      console.log('Diagn√≥stico voz V2:', texto);
      // Palavras-chave de diagn√≥stico
      if (texto.includes('prenha')) {
        selecionarDiagnosticoV2('PRENHA');
      } else if (texto.includes('vazia')) {
        selecionarDiagnosticoV2('VAZIA');
      } else if (texto.includes('n√£o aval') || texto.includes('nao aval')) {
        selecionarDiagnosticoV2('NAO_AVALIADA');
      } else if (texto.includes('descarte')) {
        selecionarDiagnosticoV2('DESCARTE');
      } else if (texto.includes('repetir') || texto.includes('cio')) {
        selecionarDiagnosticoV2('REPETIR_CIO');
      }

      if (texto.includes('cancelar')) {
        fecharDiagnosticoV2();
        return;
      }

      if (texto.includes('ok') || texto.includes('confirmar')) {
        if (diagnosticoSelecionado) {
          confirmarDiagnosticoV2();
        }
      }
    };
    diagnosticoRecognition.onend = () => {
      diagnosticoReconhecendo = false;
      if (diagnosticoVozStatus) {
        diagnosticoVozStatus.textContent = '';
      }
    };
    diagnosticoRecognition.onerror = () => {
      diagnosticoReconhecendo = false;
      if (diagnosticoVozStatus) {
        diagnosticoVozStatus.textContent = 'Erro no reconhecimento de voz.';
      }
    };
    diagnosticoRecognition.start();
  }

  function pararDiagnosticoVozV2() {
    if (diagnosticoRecognition && diagnosticoReconhecendo) {
      try {
        diagnosticoRecognition.stop();
      } catch (e) {
        console.error(e);
      }
    }
    diagnosticoRecognition = null;
    diagnosticoReconhecendo = false;
    if (diagnosticoVozStatus) {
      diagnosticoVozStatus.textContent = '';
    }
  }

  async function confirmarDiagnosticoV2() {
    // Integra com curral_registrar_manejo para registrar o diagn√≥stico real
    if (!diagnosticoSelecionado) {
      mostrarToast('Selecione ou fale um diagn√≥stico antes de confirmar.', 'warning');
      return;
    }
    if (!currentAnimalV2) {
      mostrarToast('Animal n√£o identificado. Leia o brinco primeiro.', 'warning');
      fecharDiagnosticoV2();
      return;
    }
    
    const codigo = currentAnimalV2.codigo_sisbov || currentAnimalV2.numero_brinco || brincoInput.value;
    const payload = {
      tipo_fluxo: 'animal',
      manejo: 'rep_diagnostico_prenhez',
      codigo: codigo,
      animal_id: currentAnimalV2.id || null,
      dados: {
        prenhez_status: diagnosticoSelecionado,
        data: new Date().toISOString().slice(0, 10),
      }
    };
    
    mostrarLoading(true);
    try {
      const resultado = await curralSync.adicionarParaSincronizacao(
        'diagnostico',
        registrarUrl,
        'POST',
        payload,
        {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      );
      
      mostrarLoading(false);
      
      if (resultado.synced) {
        mostrarToast('Diagn√≥stico registrado e sincronizado com sucesso!', 'success');
      } else if (resultado.queued) {
        mostrarToast('Diagn√≥stico salvo localmente. Ser√° sincronizado quando a conex√£o for restaurada.', 'info');
      }
      
      fecharDiagnosticoV2();
      finalizarAnimalV2();
    } catch (e) {
      console.error('Erro ao registrar diagn√≥stico:', e);
      mostrarLoading(false);
      // Tenta salvar localmente mesmo em caso de erro
      try {
        await curralSync.adicionarParaSincronizacao(
          'diagnostico',
          registrarUrl,
          'POST',
          payload,
          {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        );
        mostrarToast('Diagn√≥stico salvo localmente devido a erro de conex√£o.', 'warning');
        fecharDiagnosticoV2();
        finalizarAnimalV2();
      } catch (err) {
        mostrarToast('Erro ao salvar diagn√≥stico. Tente novamente.', 'error');
      }
    }
  }

  // Cadastro r√°pido a partir do estoque
  function calcularDataNascimentoPorIdadeMeses(idadeMeses) {
    const meses = parseInt(idadeMeses, 10);
    if (isNaN(meses) || meses < 0) return '';
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth(); // 0-11
    const dia = hoje.getDate();
    const totalMeses = ano * 12 + mes - meses;
    const anoNasc = Math.floor(totalMeses / 12);
    let mesNasc = totalMeses % 12;
    if (mesNasc < 0) {
      mesNasc += 12;
    }
    const dataNasc = new Date(anoNasc, mesNasc, dia);
    const yyyy = dataNasc.getFullYear();
    const mm = String(dataNasc.getMonth() + 1).padStart(2, '0');
    const dd = String(dataNasc.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }
  
  // Tornar a fun√ß√£o dispon√≠vel globalmente para uso em qualquer contexto
  if (typeof window !== 'undefined') {
    window.calcularDataNascimentoPorIdadeMeses = calcularDataNascimentoPorIdadeMeses;
  }
  
  // Tornar a fun√ß√£o dispon√≠vel globalmente
  window.calcularDataNascimentoPorIdadeMeses = calcularDataNascimentoPorIdadeMeses;

  // ========== FUN√á√ÉO MODERNA E SIMPLES PARA CADASTRO DE ESTOQUE ==========
  // Vers√£o nova, limpa e funcional - sem complexidade desnecess√°ria
  // FOR√áAR SUBSTITUI√á√ÉO DO STUB PELA FUN√á√ÉO COMPLETA
  // Deletar o stub primeiro para garantir substitui√ß√£o completa
  if (typeof window !== 'undefined') {
    if (window.registrarCadastroEstoqueV2) {
      console.log('üîÑ Removendo stub antigo antes de definir fun√ß√£o completa...');
      const fnStr = window.registrarCadastroEstoqueV2.toString();
      console.log('üìã Stub atual tem', fnStr.length, 'caracteres');
      delete window.registrarCadastroEstoqueV2;
    }
  }
  
  // Definir a fun√ß√£o completa - ESTA √â A FUN√á√ÉO REAL QUE DEVE SER USADA
  window.registrarCadastroEstoqueV2 = async function() {
    console.log('üöÄ Iniciando registro de cadastro de estoque...');
    
    // Buscar c√≥digo do brinco de m√∫ltiplas fontes
    let codigoBrinco = estoqueCadastroCodigoAtual;
    if (!codigoBrinco && typeof window !== 'undefined') {
      codigoBrinco = window.estoqueCadastroCodigoAtual;
    }
    if (!codigoBrinco) {
      const brincoSpan = document.getElementById('estoqueCadastroBrincoV2');
      if (brincoSpan) {
        codigoBrinco = brincoSpan.textContent.trim();
      }
    }
    
    console.log('üîç C√≥digo do brinco encontrado:', codigoBrinco);
    
    if (!codigoBrinco || codigoBrinco === '‚Äî' || codigoBrinco === '') {
      mostrarToast('C√≥digo do brinco em estoque n√£o identificado.', 'warning');
      console.error('‚ùå C√≥digo do brinco n√£o encontrado!');
      return;
    }
    
    // Buscar elementos diretamente
    const sexoInput = document.getElementById('estoqueCadastroSexoV2');
    const racaInput = document.getElementById('estoqueCadastroRacaV2');
    const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
    const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
    
    const sexo = (sexoInput && sexoInput.value) || (estoqueCadastroSexo && estoqueCadastroSexo.value) || '';
    const raca = (racaInput && racaInput.value) || (estoqueCadastroRaca && estoqueCadastroRaca.value) || '';
    const idadeMeses = (idadeInput && idadeInput.value.trim()) || (estoqueCadastroIdadeMeses && estoqueCadastroIdadeMeses.value.trim()) || '';
    const dataNasc = (dataNascInput && dataNascInput.value) || (estoqueCadastroDataNasc && estoqueCadastroDataNasc.value) || '';

    console.log('üìã Dados coletados:', { sexo, raca, idadeMeses, dataNasc });

    if (!sexo) {
      mostrarToast('Selecione o sexo do animal.', 'warning');
      return;
    }
    
    // Calcular idade ou data conforme o que foi preenchido
    let idadeFinal = idadeMeses;
    let dataNascFinal = dataNasc;
    
    if (dataNasc && !idadeMeses) {
      idadeFinal = calcularIdadeMesesDeData(dataNasc);
      console.log('üìÖ Idade calculada da data:', idadeFinal);
      if (idadeInput) idadeInput.value = idadeFinal;
    } else if (idadeMeses && !dataNasc) {
      let dataCalc = '';
      if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
        dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
      } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
        dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
      }
      dataNascFinal = dataCalc;
      console.log('üìÖ Data calculada da idade:', dataNascFinal);
      if (dataNascInput) dataNascInput.value = dataCalc;
    }
    
    if (!idadeFinal || !dataNascFinal) {
      mostrarToast('Informe a idade em meses OU a data de nascimento.', 'warning');
      return;
    }

    const payload = {
      tipo_fluxo: 'estoque',
      manejo: 'CADASTRO_INICIAL',
      codigo: codigoBrinco,
      numero_sisbov: codigoBrinco,
      sexo,
      raca,
      idade: idadeFinal,
      data_nascimento: dataNascFinal,
      origem_cadastro: 'NASCIMENTO',
    };
    
    // Se foi selecionado um brinco espec√≠fico (m√∫ltiplos brincos), incluir o ID
    if (estoqueCadastroBrincoId || (typeof window !== 'undefined' && window.estoqueCadastroBrincoId)) {
      payload.brinco_id = estoqueCadastroBrincoId || window.estoqueCadastroBrincoId;
      console.log('üìå Incluindo brinco_id no payload:', payload.brinco_id);
    }
    
    console.log('üì§ Payload para envio:', payload);
    
    if (typeof estoqueCadastroCodigoAtual !== 'undefined') {
      estoqueCadastroCodigoAtual = codigoBrinco;
    }
    if (typeof window !== 'undefined') {
      window.estoqueCadastroCodigoAtual = codigoBrinco;
    }

    mostrarLoading(true);
    try {
      let urlRegistrar = registrarUrl;
      if (!urlRegistrar && typeof window !== 'undefined') {
        const pathMatch = window.location.pathname.match(/\/propriedade\/(\d+)\/curral/);
        if (pathMatch) {
          urlRegistrar = `/propriedade/${pathMatch[1]}/curral/api/registrar/`;
        }
      }
      
      if (!urlRegistrar) {
        throw new Error('URL de registro n√£o encontrada');
      }
      
      console.log('üåê URL de registro:', urlRegistrar);
      
      let resultado;
      if (typeof curralSync !== 'undefined' && typeof curralSync.adicionarParaSincronizacao === 'function') {
        console.log('üì° Usando sistema de sincroniza√ß√£o offline');
        resultado = await curralSync.adicionarParaSincronizacao(
          'cadastro_estoque',
          urlRegistrar,
          'POST',
          payload,
          {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          }
        );
      } else {
        console.log('üì° Fazendo requisi√ß√£o direta (curralSync n√£o dispon√≠vel)');
        const response = await fetch(urlRegistrar, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ mensagem: `Erro ${response.status}` }));
          throw new Error(errorData.mensagem || `Erro ${response.status}`);
        }
        
        const data = await response.json();
        resultado = {
          synced: true,
          data: data,
          queued: false
        };
        console.log('üì• Resposta recebida:', resultado);
      }
      
      mostrarLoading(false);
      
      if (resultado.synced && resultado.data) {
        const data = resultado.data;
        if (data.status === 'conflito_manejo' && data.conflitos && Array.isArray(data.conflitos)) {
          conflitoManejoDados = {
            codigo: codigoBrinco,
            sexo,
            raca,
            idade: idadeFinal,
            data_nascimento: dataNascFinal,
            origem_cadastro: 'NASCIMENTO'
          };
          abrirConflitoManejoV2(data.conflitos);
          return;
        }
        if (data.status !== 'ok') {
          const msg = data.mensagem || 'N√£o foi poss√≠vel concluir o cadastro a partir do estoque.';
          mostrarToast(msg, 'error');
          if (msg.includes('J√° existe um animal cadastrado com este brinco')) {
            fecharCadastroEstoqueV2();
            identificarBrinco(codigoBrinco);
          }
          return;
        }
        console.log('‚úÖ Animal cadastrado com sucesso!');
        mostrarToast(data.mensagem || 'Animal cadastrado com sucesso a partir do estoque!', 'success');
        ultimoCadastroEstoqueV2 = { raca, sexo, idade: idadeFinal };
        fecharCadastroEstoqueV2();
        identificarBrinco(codigoBrinco);
      } else if (resultado.queued) {
        mostrarToast('Cadastro salvo localmente. Ser√° sincronizado quando a conex√£o for restaurada.', 'info');
        ultimoCadastroEstoqueV2 = { raca, sexo, idade: idadeFinal };
        fecharCadastroEstoqueV2();
      } else {
        mostrarToast('Cadastro salvo localmente.', 'info');
      }
    } catch (e) {
      console.error('‚ùå Erro ao cadastrar animal a partir do estoque:', e);
      mostrarLoading(false);
      const mensagemErro = e.message || 'Erro desconhecido ao cadastrar animal.';
      mostrarToast(`Erro ao cadastrar: ${mensagemErro}`, 'error');
      
      if (typeof curralSync !== 'undefined' && typeof curralSync.adicionarParaSincronizacao === 'function') {
        try {
          let urlRegistrar = registrarUrl;
          if (!urlRegistrar) {
            const pathMatch = window.location.pathname.match(/\/propriedade\/(\d+)\/curral/);
            if (pathMatch) {
              urlRegistrar = `/propriedade/${pathMatch[1]}/curral/api/registrar/`;
            }
          }
          if (urlRegistrar) {
            await curralSync.adicionarParaSincronizacao('cadastro_estoque', urlRegistrar, 'POST', payload, {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            });
            mostrarToast('Cadastro salvo localmente devido a erro de conex√£o.', 'warning');
          }
        } catch (err) {
          console.error('Erro ao salvar localmente:', err);
        }
      }
    }
  };
  
  // ========== FIM DA FUN√á√ÉO registrarCadastroEstoqueV2 ==========
  console.log('‚úÖ Fun√ß√£o registrarCadastroEstoqueV2 definida e dispon√≠vel globalmente');

  // Fun√ß√£o para inicializar event listeners do modal de estoque
  function inicializarModalEstoque() {
    console.log('üîß Inicializando modal de estoque...');
    
    // Buscar elementos
    const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
    const sexoInput = document.getElementById('estoqueCadastroSexoV2');
    const racaInput = document.getElementById('estoqueCadastroRacaV2');
    const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
    const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
    const cancelBtn = document.getElementById('estoqueCadastroCancelarBtnV2');
    
    // Event listener para c√°lculo autom√°tico da data de nascimento
    if (idadeInput) {
      idadeInput.addEventListener('input', function() {
        const idadeMeses = this.value.trim();
        console.log('üìÖ Idade alterada:', idadeMeses);
        
        // Calcular data de nascimento
        let dataCalc = '';
        if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
          dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
        } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
          dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
        }
        
        if (dataNascInput && dataCalc) {
          // Input type="date" precisa do formato YYYY-MM-DD
          dataNascInput.value = dataCalc;
          console.log('‚úÖ Data calculada:', dataCalc);
        }
        
        // Validar e habilitar bot√£o
        validarBotaoEstoque();
      });
    }
    
    // Event listener para calcular idade quando data de nascimento √© alterada
    if (dataNascInput) {
      dataNascInput.addEventListener('change', function() {
        const dataNasc = this.value;
        console.log('üìÖ Data de nascimento alterada:', dataNasc);
        
        if (dataNasc) {
          // Calcular idade em meses a partir da data
          const hoje = new Date();
          const nasc = new Date(dataNasc);
          const diffAnos = hoje.getFullYear() - nasc.getFullYear();
          const diffMeses = hoje.getMonth() - nasc.getMonth();
          const diffDias = hoje.getDate() - nasc.getDate();
          let totalMeses = diffAnos * 12 + diffMeses;
          if (diffDias < 0) {
            totalMeses--;
          }
          
          if (totalMeses >= 0 && idadeInput) {
            idadeInput.value = totalMeses.toString();
            console.log('‚úÖ Idade calculada da data:', totalMeses, 'meses');
          }
        }
        
        // Validar e habilitar bot√£o
        validarBotaoEstoque();
      });
    }
    
    // Event listener para valida√ß√£o quando sexo muda
    if (sexoInput) {
      sexoInput.addEventListener('change', function() {
        console.log('üë§ Sexo alterado:', this.value);
        validarBotaoEstoque();
      });
    }
    
    // Event listener para ra√ßa (opcional, mas valida tamb√©m)
    if (racaInput) {
      racaInput.addEventListener('input', function() {
        validarBotaoEstoque();
      });
    }
    
    // Fun√ß√£o para validar e habilitar/desabilitar bot√£o
    function validarBotaoEstoque() {
      const idade = idadeInput ? idadeInput.value.trim() : '';
      const dataNasc = dataNascInput ? dataNascInput.value.trim() : '';
      const sexo = sexoInput ? sexoInput.value.trim() : '';
      
      // Aceitar idade OU data de nascimento (pelo menos um deve estar preenchido)
      const temIdadeOuData = idade || dataNasc;
      
      console.log('üîç Validando bot√£o:', { idade, dataNasc, sexo, temIdadeOuData });
      
      if (okBtn) {
        if (temIdadeOuData && sexo) {
          console.log('‚úÖ Habilitando bot√£o');
          okBtn.disabled = false;
          okBtn.removeAttribute('disabled');
          okBtn.style.opacity = '1';
          okBtn.style.cursor = 'pointer';
          okBtn.classList.remove('disabled');
        } else {
          console.log('‚ùå Desabilitando bot√£o - faltando:', { idadeOuData: !temIdadeOuData, sexo: !sexo });
          okBtn.disabled = true;
          okBtn.setAttribute('disabled', 'disabled');
          okBtn.style.opacity = '0.6';
          okBtn.style.cursor = 'not-allowed';
          okBtn.classList.add('disabled');
        }
      }
    }
    
    // Event listener para bot√£o Confirmar - VERS√ÉO SIMPLIFICADA
    if (okBtn) {
      okBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (this.disabled) {
          mostrarToast('Preencha todos os campos obrigat√≥rios (idade ou data + sexo)', 'warning');
          return;
        }
        
        console.log('üñ±Ô∏è Bot√£o Confirmar cadastro clicado!');
        
        if (typeof window.registrarCadastroEstoqueV2 === 'function') {
          try {
            await window.registrarCadastroEstoqueV2();
          } catch (err) {
            console.error('‚ùå Erro ao cadastrar:', err);
            mostrarToast('Erro ao cadastrar: ' + (err.message || 'Erro desconhecido'), 'error');
          }
        } else {
          console.error('‚ùå Fun√ß√£o registrarCadastroEstoqueV2 n√£o encontrada!');
          mostrarToast('Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina.', 'error');
        }
      });
    }
    
    // Event listener para bot√£o Cancelar
    if (cancelBtn) {
      // Remover listeners anteriores
      const novoCancelBtn = cancelBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(novoCancelBtn, cancelBtn);
      const cancelBtnAtual = document.getElementById('estoqueCadastroCancelarBtnV2');
      
      if (cancelBtnAtual) {
        cancelBtnAtual.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üñ±Ô∏è Bot√£o Cancelar clicado!');
          fecharCadastroEstoqueV2();
        });
        console.log('‚úÖ Event listener do bot√£o Cancelar anexado');
      }
    }
    
    // Validar bot√£o inicialmente
    validarBotaoEstoque();
  }

  // Fun√ß√£o para mostrar sele√ß√£o de m√∫ltiplos brincos
  function mostrarSelecaoBrincoMultiplo(brincos, codigoLido) {
    console.log('üìã Mostrando sele√ß√£o de m√∫ltiplos brincos:', brincos);
    
    const overlay = document.getElementById('selecaoBrincoMultiploOverlay');
    const lista = document.getElementById('selecaoBrincoMultiploLista');
    const codigoLidoSpan = document.getElementById('selecaoBrincoCodigoLido');
    
    if (!overlay || !lista) {
      console.error('‚ùå Modal de sele√ß√£o de brincos n√£o encontrado!');
      mostrarToast('Erro: modal de sele√ß√£o n√£o encontrado.', 'error');
      return;
    }
    
    // Preencher c√≥digo lido
    if (codigoLidoSpan) {
      codigoLidoSpan.textContent = codigoLido || '‚Äî';
    }
    
    // Limpar lista anterior
    lista.innerHTML = '';
    
    // Criar cards para cada brinco
    brincos.forEach((brinco, index) => {
      const card = document.createElement('div');
      card.style.cssText = 'border: 2px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; background: white;';
      card.onmouseover = function() {
        this.style.borderColor = '#1976d2';
        this.style.boxShadow = '0 2px 8px rgba(25, 118, 210, 0.2)';
        this.style.transform = 'translateY(-2px)';
      };
      card.onmouseout = function() {
        this.style.borderColor = '#e0e0e0';
        this.style.boxShadow = 'none';
        this.style.transform = 'translateY(0)';
      };
      card.onclick = function() {
        selecionarBrincoMultiplo(brinco, codigoLido);
      };
      
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <div>
            <div style="font-size: 1.1rem; font-weight: 700; color: #1976d2; margin-bottom: 4px;">
              <i class="fas fa-tag" style="margin-right: 6px;"></i>${brinco.numero_brinco || '‚Äî'}
            </div>
            <div style="font-size: 0.85rem; color: #757575;">
              <i class="fas fa-barcode" style="margin-right: 4px;"></i>Manejo: ${brinco.numero_manejo || '‚Äî'}
            </div>
          </div>
          <div style="text-align: right;">
            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
              ${brinco.tipo_brinco || 'Visual'}
            </span>
          </div>
        </div>
        ${brinco.codigo_rfid ? `
          <div style="font-size: 0.85rem; color: #757575; margin-top: 8px;">
            <i class="fas fa-wifi" style="margin-right: 4px;"></i>RFID: ${brinco.codigo_rfid}
          </div>
        ` : ''}
        ${brinco.codigo_lote ? `
          <div style="font-size: 0.85rem; color: #757575; margin-top: 4px;">
            <i class="fas fa-box" style="margin-right: 4px;"></i>Lote: ${brinco.codigo_lote}
          </div>
        ` : ''}
        ${brinco.fornecedor ? `
          <div style="font-size: 0.85rem; color: #757575; margin-top: 4px;">
            <i class="fas fa-truck" style="margin-right: 4px;"></i>Fornecedor: ${brinco.fornecedor}
          </div>
        ` : ''}
        ${brinco.data_aquisicao ? `
          <div style="font-size: 0.85rem; color: #757575; margin-top: 4px;">
            <i class="fas fa-calendar" style="margin-right: 4px;"></i>Aquisi√ß√£o: ${brinco.data_aquisicao}
          </div>
        ` : ''}
        <div style="margin-top: 12px; text-align: center;">
          <button type="button" class="btn btn-sm btn-primary btn-selecionar-brinco" 
                  style="min-width: 120px; padding: 8px 16px; border-radius: 6px; font-weight: 600;"
                  data-brinco-id="${brinco.id}"
                  data-brinco-numero="${brinco.numero_brinco || ''}"
                  data-brinco-rfid="${brinco.codigo_rfid || ''}"
                  data-brinco-tipo="${brinco.tipo_brinco || ''}"
                  data-brinco-manejo="${brinco.numero_manejo || ''}"
                  data-brinco-lote="${brinco.codigo_lote || ''}"
                  data-brinco-fornecedor="${brinco.fornecedor || ''}"
                  data-codigo-lido="${codigoLido || ''}">
            <i class="fas fa-check"></i> Selecionar
          </button>
        </div>
      `;
      
      lista.appendChild(card);
    });
    
    // Adicionar event listeners aos bot√µes de sele√ß√£o
    const botoesSelecionar = lista.querySelectorAll('.btn-selecionar-brinco');
    botoesSelecionar.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const brinco = {
          id: parseInt(this.getAttribute('data-brinco-id')),
          numero_brinco: this.getAttribute('data-brinco-numero'),
          codigo_rfid: this.getAttribute('data-brinco-rfid'),
          tipo_brinco: this.getAttribute('data-brinco-tipo'),
          numero_manejo: this.getAttribute('data-brinco-manejo'),
          codigo_lote: this.getAttribute('data-brinco-lote'),
          fornecedor: this.getAttribute('data-brinco-fornecedor'),
        };
        const codigoLido = this.getAttribute('data-codigo-lido');
        selecionarBrincoMultiplo(brinco, codigoLido);
      });
    });
    
    // Mostrar modal
    overlay.style.display = 'flex';
    overlay.classList.add('show');
    
    // Configurar bot√£o de fechar
    const closeBtn = document.getElementById('selecaoBrincoMultiploCloseBtn');
    const cancelarBtn = document.getElementById('selecaoBrincoMultiploCancelarBtn');
    
    if (closeBtn) {
      closeBtn.onclick = function() {
        overlay.style.display = 'none';
        overlay.classList.remove('show');
      };
    }
    
    if (cancelarBtn) {
      cancelarBtn.onclick = function() {
        overlay.style.display = 'none';
        overlay.classList.remove('show');
      };
    }
    
    // Fechar ao clicar fora
    overlay.onclick = function(e) {
      if (e.target === overlay) {
        overlay.style.display = 'none';
        overlay.classList.remove('show');
      }
    };
  }
  
  // Fun√ß√£o para selecionar um brinco da lista
  function selecionarBrincoMultiplo(brinco, codigoLido) {
    console.log('‚úÖ Brinco selecionado:', brinco);
    
    // Armazenar o ID do brinco selecionado
    estoqueCadastroBrincoId = brinco.id;
    if (typeof window !== 'undefined') {
      window.estoqueCadastroBrincoId = brinco.id;
    }
    
    // Fechar modal de sele√ß√£o
    const overlay = document.getElementById('selecaoBrincoMultiploOverlay');
    if (overlay) {
      overlay.style.display = 'none';
      overlay.classList.remove('show');
    }
    
    // Abrir modal de cadastro com o brinco selecionado
    if (typeof abrirCadastroEstoqueV2 === 'function') {
      abrirCadastroEstoqueV2({
        id: brinco.id,
        numero_brinco: brinco.numero_brinco,
        codigo_rfid: brinco.codigo_rfid || '',
        tipo_brinco: brinco.tipo_brinco,
        numero_manejo: brinco.numero_manejo,
        codigo_lote: brinco.codigo_lote || '',
        fornecedor: brinco.fornecedor || '',
      }, codigoLido || brinco.numero_brinco);
    } else if (typeof window.abrirCadastroEstoqueV2 === 'function') {
      window.abrirCadastroEstoqueV2({
        id: brinco.id,
        numero_brinco: brinco.numero_brinco,
        codigo_rfid: brinco.codigo_rfid || '',
        tipo_brinco: brinco.tipo_brinco,
        numero_manejo: brinco.numero_manejo,
        codigo_lote: brinco.codigo_lote || '',
        fornecedor: brinco.fornecedor || '',
      }, codigoLido || brinco.numero_brinco);
    }
  }
  
  // Tornar fun√ß√£o global
  window.mostrarSelecaoBrincoMultiplo = mostrarSelecaoBrincoMultiplo;
  window.selecionarBrincoMultiplo = selecionarBrincoMultiplo;

  function abrirCadastroEstoqueV2Local(dadosBrinco, codigoOriginal) {
    const overlay = document.getElementById('estoqueCadastroOverlayV2');
    if (!overlay) {
      console.error('‚ùå Modal de estoque n√£o encontrado!');
      return;
    }
    
    console.log('üì¶ Abrindo modal de cadastro de estoque');
    console.log('üìã C√≥digo original recebido:', codigoOriginal);
    console.log('üìã Dados do brinco:', dadosBrinco);
    
    // Definir c√≥digo do brinco em m√∫ltiplas vari√°veis para garantir acesso
    const codigoBrinco = (dadosBrinco && (dadosBrinco.brinco_visual || dadosBrinco.numero_brinco)) || codigoOriginal || '';
    estoqueCadastroCodigoAtual = codigoBrinco;
    if (typeof window !== 'undefined') {
      window.estoqueCadastroCodigoAtual = codigoBrinco;
    }
    
    // Se o brinco tem ID (foi selecionado de m√∫ltiplos), armazenar
    if (dadosBrinco && dadosBrinco.id) {
      estoqueCadastroBrincoId = dadosBrinco.id;
      if (typeof window !== 'undefined') {
        window.estoqueCadastroBrincoId = dadosBrinco.id;
      }
    } else {
      // Limpar ID se n√£o foi selecionado de m√∫ltiplos
      estoqueCadastroBrincoId = null;
      if (typeof window !== 'undefined') {
        window.estoqueCadastroBrincoId = null;
      }
    }
    
    console.log('‚úÖ C√≥digo do brinco definido:', codigoBrinco);
    
    // Preencher brinco
    const brincoSpan = document.getElementById('estoqueCadastroBrincoV2');
    if (brincoSpan) {
      brincoSpan.textContent = codigoBrinco || '‚Äî';
    }
    
    // Buscar elementos
    const racaInput = document.getElementById('estoqueCadastroRacaV2');
    const sexoInput = document.getElementById('estoqueCadastroSexoV2');
    const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
    const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
    
    // Se houver um √∫ltimo cadastro, reutiliza como padr√£o
    if (ultimoCadastroEstoqueV2) {
      if (racaInput) racaInput.value = ultimoCadastroEstoqueV2.raca || '';
      if (sexoInput) sexoInput.value = ultimoCadastroEstoqueV2.sexo || '';
      if (idadeInput) idadeInput.value = ultimoCadastroEstoqueV2.idade || '';
      const dataCalc = calcularDataNascimentoPorIdadeMeses(ultimoCadastroEstoqueV2.idade);
      if (dataNascInput && dataCalc) {
        dataNascInput.value = dataCalc; // J√° est√° no formato YYYY-MM-DD
      }
    } else {
      if (racaInput) racaInput.value = '';
      if (sexoInput) sexoInput.value = '';
      if (idadeInput) idadeInput.value = '';
      if (dataNascInput) dataNascInput.value = '';
    }
    
    // Mostrar modal
    overlay.style.display = 'flex';
    overlay.classList.add('show');
    
    // Inicializar modal ap√≥s um pequeno delay
    setTimeout(() => {
      inicializarModalEstoque();
    }, 100);
  }

  function fecharCadastroEstoqueV2() {
    console.log('‚ùå Fechando modal de cadastro de estoque');
    const overlay = document.getElementById('estoqueCadastroOverlayV2');
    if (overlay) {
      overlay.classList.remove('show');
      overlay.style.display = 'none';
    }
    estoqueCadastroCodigoAtual = null;
  }

  function abrirConflitoManejoV2(listaConflitos) {
    if (!conflitoManejoLista || !conflitoManejoOverlay) return;
    conflitoManejoLista.innerHTML = '';
    listaConflitos.forEach((animal, index) => {
      const div = document.createElement('div');
      div.style.cssText = 'padding:10px;margin-bottom:8px;border:1px solid #bdbdbd;border-radius:6px;cursor:pointer;transition:all 0.2s;';
      div.style.backgroundColor = '#f5f5f5';
      div.onmouseover = () => { div.style.backgroundColor = '#e3f2fd'; div.style.borderColor = '#1e88e5'; };
      div.onmouseout = () => { div.style.backgroundColor = '#f5f5f5'; div.style.borderColor = '#bdbdbd'; };
      div.onclick = () => escolherAnimalConflitoV2(animal);
      div.innerHTML = `
        <div style="font-weight:600;color:#1565c0;margin-bottom:4px;">
          <i class="fas fa-cow"></i> SISBOV: <strong>${animal.sisbov_completo || '‚Äî'}</strong>
        </div>
        <div style="font-size:0.85rem;color:#455a64;">
          <span>N√∫mero de manejo: <strong>${animal.numero_manejo || '‚Äî'}</strong></span> | 
          <span>Brinco: <strong>${animal.numero_brinco || '‚Äî'}</strong></span>
        </div>
        <div style="font-size:0.85rem;color:#607d8b;margin-top:4px;">
          ${animal.raca ? `Ra√ßa: ${animal.raca}` : ''} ${animal.sexo ? `¬∑ Sexo: ${animal.sexo}` : ''} ${animal.data_nascimento ? `¬∑ Nascimento: ${animal.data_nascimento}` : ''}
        </div>
      `;
      conflitoManejoLista.appendChild(div);
    });
    conflitoManejoOverlay.classList.add('show');
  }

  function fecharConflitoManejoV2() {
    if (conflitoManejoOverlay) {
      conflitoManejoOverlay.classList.remove('show');
    }
    conflitoManejoDados = null;
  }

  async function escolherAnimalConflitoV2(animalEscolhido) {
    if (!conflitoManejoDados || !animalEscolhido || !animalEscolhido.sisbov_completo) {
      mostrarToast('Erro: dados do animal escolhido inv√°lidos.', 'error');
      return;
    }
    fecharConflitoManejoV2();
    fecharCadastroEstoqueV2();
    // Usa o SISBOV completo do animal escolhido para fazer o cadastro
    const payload = {
      tipo_fluxo: 'estoque',
      manejo: 'CADASTRO_INICIAL',
      codigo: conflitoManejoDados.codigo,
      numero_sisbov: animalEscolhido.sisbov_completo, // SEMPRE usa o SISBOV completo
      sexo: conflitoManejoDados.sexo,
      raca: conflitoManejoDados.raca,
      idade: conflitoManejoDados.idade,
      data_nascimento: conflitoManejoDados.data_nascimento,
      origem_cadastro: conflitoManejoDados.origem_cadastro,
    };
    mostrarLoading(true);
    try {
      const resp = await fetch(registrarUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      mostrarLoading(false);
      if (!resp.ok || data.status !== 'ok') {
        mostrarToast(data.mensagem || 'N√£o foi poss√≠vel concluir o cadastro.', 'error');
        return;
      }
      mostrarToast(data.mensagem || 'Animal cadastrado com sucesso usando o SISBOV completo!', 'success');
      // guarda √∫ltimos valores para o pr√≥ximo cadastro em lote
      ultimoCadastroEstoqueV2 = { raca: conflitoManejoDados.raca, sexo: conflitoManejoDados.sexo, idade: conflitoManejoDados.idade };
      // Ap√≥s cadastrar, recarrega o fluxo de identifica√ß√£o j√° como animal usando o SISBOV completo
      identificarBrinco(animalEscolhido.sisbov_completo);
    } catch (e) {
      console.error('Erro ao cadastrar animal com SISBOV completo:', e);
      mostrarLoading(false);
      mostrarToast('Erro ao comunicar com o servidor ao cadastrar animal.', 'error');
    }
  }

  pesoSimularBtn.addEventListener('click', () => {
    const pesos = [320, 350, 380, 410, 440];
    const p = pesos[Math.floor(Math.random() * pesos.length)];
    atualizarPesoV2(p);
    atualizarResumoPesagemV2(p);
  });

  // Carrega e salva prefer√™ncia de auto-pr√≥ximo em localStorage
  if (autoProximoCheckbox) {
    const salvo = localStorage.getItem('curralV2_autoProximo');
    if (salvo === '1') {
      autoProximoCheckbox.checked = true;
    }
    autoProximoCheckbox.addEventListener('change', () => {
      localStorage.setItem('curralV2_autoProximo', autoProximoCheckbox.checked ? '1' : '0');
    });
  }

  // Configura√ß√£o do trabalho de pesagem: permitir ativar/desativar "Registrar sanidade" e "Diagn√≥stico r√°pido"
  const configCards = document.querySelectorAll('.config-trabalho-card');
  configCards.forEach((card, index) => {
    card.addEventListener('click', () => {
      // Card 0 = "Pesagem" permanece sempre ativo
      if (index === 0) {
        card.classList.add('active');
        return;
      }
      card.classList.toggle('active');
    });
  });

  // Diagn√≥stico r√°pido - eventos
  diagnosticoBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      selecionarDiagnosticoV2(btn.dataset.valor);
    });
  });

  if (diagnosticoOkBtn) {
    diagnosticoOkBtn.addEventListener('click', () => {
      confirmarDiagnosticoV2();
    });
  }

  if (diagnosticoCancelarBtn) {
    diagnosticoCancelarBtn.addEventListener('click', () => {
      fecharDiagnosticoV2();
    });
  }

  if (diagnosticoVozBtn) {
    diagnosticoVozBtn.addEventListener('click', () => {
      if (diagnosticoReconhecendo) {
        pararDiagnosticoVozV2();
      } else {
        iniciarDiagnosticoVozV2();
      }
    });
  }

  // Eventos do cadastro r√°pido de estoque
  // Fun√ß√£o para validar campos e habilitar/desabilitar bot√£o
  function validarCamposEstoque() {
    // Buscar elementos novamente para garantir que est√£o dispon√≠veis
    const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
    const sexoInput = document.getElementById('estoqueCadastroSexoV2');
    const racaInput = document.getElementById('estoqueCadastroRacaV2');
    const okBtn = document.getElementById('estoqueCadastroOkBtnV2');
    
    // Usar elementos buscados diretamente ou os globais como fallback
    const idadeMeses = (idadeInput ? idadeInput.value : (estoqueCadastroIdadeMeses ? estoqueCadastroIdadeMeses.value : '')).trim();
    const sexo = (sexoInput ? sexoInput.value : (estoqueCadastroSexo ? estoqueCadastroSexo.value : '')).trim();
    const raca = (racaInput ? racaInput.value : (estoqueCadastroRaca ? estoqueCadastroRaca.value : '')).trim();
    
    console.log('üîç Validando campos estoque:', { idadeMeses, sexo, raca });
    
    // Habilitar bot√£o se idade e sexo estiverem preenchidos
    const botao = okBtn || estoqueCadastroOkBtn;
    if (botao) {
      if (idadeMeses && sexo) {
        console.log('‚úÖ Habilitando bot√£o de cadastro');
        botao.disabled = false;
        botao.removeAttribute('disabled');
        botao.style.opacity = '1';
        botao.style.cursor = 'pointer';
        botao.classList.remove('disabled');
      } else {
        console.log('‚ùå Desabilitando bot√£o de cadastro - campos faltando:', { idadeMeses: !idadeMeses, sexo: !sexo });
        botao.disabled = true;
        botao.setAttribute('disabled', 'disabled');
        botao.style.opacity = '0.6';
        botao.style.cursor = 'not-allowed';
        botao.classList.add('disabled');
      }
    } else {
      console.error('‚ùå Bot√£o estoqueCadastroOkBtnV2 n√£o encontrado!');
    }
  }
  
  // Tornar fun√ß√£o dispon√≠vel globalmente
  window.validarCamposEstoque = validarCamposEstoque;

  // Fun√ß√£o para configurar event listeners do modal de estoque
  function configurarEventListenersEstoque() {
    // Buscar elementos novamente para garantir que est√£o dispon√≠veis
    const idadeInput = document.getElementById('estoqueCadastroIdadeMesesV2');
    const sexoInput = document.getElementById('estoqueCadastroSexoV2');
    const racaInput = document.getElementById('estoqueCadastroRacaV2');
    const dataNascInput = document.getElementById('estoqueCadastroDataNascV2');
    
    // Event listener para c√°lculo autom√°tico da data de nascimento
    if (idadeInput) {
      // Usar once: false para permitir m√∫ltiplos listeners (n√£o h√° problema)
      idadeInput.addEventListener('input', function() {
        const idadeMeses = this.value;
        console.log('üìÖ Calculando data de nascimento para idade:', idadeMeses);
        // Tentar usar a fun√ß√£o global primeiro, depois a local
        let dataCalc = '';
        if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
          dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
        } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
          dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
        } else {
          // Fallback inline
          const mesesNum = parseInt(idadeMeses, 10);
          if (!isNaN(mesesNum) && mesesNum >= 0) {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = hoje.getMonth();
            const dia = hoje.getDate();
            const totalMeses = ano * 12 + mes - mesesNum;
            const anoNasc = Math.floor(totalMeses / 12);
            let mesNasc = totalMeses % 12;
            if (mesNasc < 0) {
              mesNasc += 12;
            }
            const dataNasc = new Date(anoNasc, mesNasc, dia);
            const yyyy = dataNasc.getFullYear();
            const mm = String(dataNasc.getMonth() + 1).padStart(2, '0');
            const dd = String(dataNasc.getDate()).padStart(2, '0');
            dataCalc = `${yyyy}-${mm}-${dd}`;
          }
        }
        console.log('üìÖ Data calculada:', dataCalc);
        if (dataNascInput && dataCalc) {
          // Input type="date" precisa do formato YYYY-MM-DD
          const dataFormatada = dataCalc; // dataCalc j√° est√° no formato YYYY-MM-DD
          dataNascInput.value = dataFormatada;
          console.log('‚úÖ Data de nascimento preenchida:', dataFormatada);
        }
        // Validar campos ap√≥s altera√ß√£o
        if (typeof validarCamposEstoque === 'function') {
          validarCamposEstoque();
        } else if (typeof window !== 'undefined' && typeof window.validarCamposEstoque === 'function') {
          window.validarCamposEstoque();
        }
      });
      
      idadeInput.addEventListener('change', function() {
        validarCamposEstoque();
      });
    }
    
    // Event listeners para valida√ß√£o em tempo real
    if (sexoInput) {
      sexoInput.addEventListener('change', () => {
        validarCamposEstoque();
      });
    }
    
    if (racaInput) {
      racaInput.addEventListener('input', () => {
        validarCamposEstoque();
      });
    }
  }

  // Configurar event listeners iniciais
  if (estoqueCadastroIdadeMeses) {
    estoqueCadastroIdadeMeses.addEventListener('input', () => {
      const idadeMeses = estoqueCadastroIdadeMeses.value;
      // Tentar usar a fun√ß√£o global primeiro, depois a local
      let dataCalc = '';
      if (typeof window !== 'undefined' && typeof window.calcularDataNascimentoPorIdadeMeses === 'function') {
        dataCalc = window.calcularDataNascimentoPorIdadeMeses(idadeMeses);
      } else if (typeof calcularDataNascimentoPorIdadeMeses === 'function') {
        dataCalc = calcularDataNascimentoPorIdadeMeses(idadeMeses);
      }
      if (estoqueCadastroDataNasc) {
        estoqueCadastroDataNasc.value = dataCalc
          ? dataCalc // dataCalc j√° est√° no formato YYYY-MM-DD para input type="date"
          : '';
      }
      if (typeof validarCamposEstoque === 'function') {
        validarCamposEstoque();
      } else if (typeof window !== 'undefined' && typeof window.validarCamposEstoque === 'function') {
        window.validarCamposEstoque();
      }
    });
    
    estoqueCadastroIdadeMeses.addEventListener('change', () => {
      if (typeof validarCamposEstoque === 'function') {
        validarCamposEstoque();
      } else if (typeof window !== 'undefined' && typeof window.validarCamposEstoque === 'function') {
        window.validarCamposEstoque();
      }
    });
  }
  
  if (estoqueCadastroSexo) {
    estoqueCadastroSexo.addEventListener('change', () => {
      if (typeof validarCamposEstoque === 'function') {
        validarCamposEstoque();
      } else if (typeof window !== 'undefined' && typeof window.validarCamposEstoque === 'function') {
        window.validarCamposEstoque();
      }
    });
  }
  
  if (estoqueCadastroRaca) {
    estoqueCadastroRaca.addEventListener('input', () => {
      if (typeof validarCamposEstoque === 'function') {
        validarCamposEstoque();
      } else if (typeof window !== 'undefined' && typeof window.validarCamposEstoque === 'function') {
        window.validarCamposEstoque();
      }
    });
  }
  
  // Validar campos inicialmente
  validarCamposEstoque();

  if (estoqueCadastroOkBtn) {
    estoqueCadastroOkBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('üñ±Ô∏è Bot√£o de cadastro clicado (event listener inicial)!');
      
      // Fun√ß√£o auxiliar para verificar se √© a vers√£o completa (n√£o stub)
      function isFuncaoCompleta(fn) {
        if (!fn || typeof fn !== 'function') return false;
        if (fn._isStub) return false;
        const fnStr = fn.toString();
        if (fnStr.indexOf('[STUB]') !== -1) return false;
        if (fnStr.length < 500) return false;
        if (fnStr.indexOf('Iniciando registro de cadastro de estoque') !== -1) return true;
        if (fnStr.indexOf('C√≥digo do brinco encontrado') !== -1) return true;
        if (fnStr.indexOf('adicionarParaSincronizacao') !== -1) return true;
        return fnStr.length > 1000;
      }
      
      // Fun√ß√£o auxiliar para encontrar e chamar registrarCadastroEstoqueV2
      function chamarRegistrarCadastro() {
        let funcaoRegistrar = null;
        
        // 1. Tentar no escopo local
        if (typeof registrarCadastroEstoqueV2 === 'function' && isFuncaoCompleta(registrarCadastroEstoqueV2)) {
          funcaoRegistrar = registrarCadastroEstoqueV2;
          console.log('‚úÖ Fun√ß√£o encontrada no escopo local (vers√£o completa)');
        }
        // 2. Tentar no window
        else if (typeof window !== 'undefined' && typeof window.registrarCadastroEstoqueV2 === 'function') {
          if (isFuncaoCompleta(window.registrarCadastroEstoqueV2)) {
            funcaoRegistrar = window.registrarCadastroEstoqueV2;
            console.log('‚úÖ Fun√ß√£o encontrada em window (vers√£o completa)');
          } else {
            console.log('‚ö†Ô∏è Fun√ß√£o encontrada em window mas √© apenas o stub, aguardando vers√£o completa...');
          }
        }
        
        if (funcaoRegistrar && typeof funcaoRegistrar === 'function') {
          console.log('‚úÖ Chamando fun√ß√£o registrarCadastroEstoqueV2 (vers√£o completa)...');
          try {
            funcaoRegistrar();
            return true;
          } catch (err) {
            console.error('‚ùå Erro ao executar fun√ß√£o:', err);
            const mensagemErro = err.message || 'Erro desconhecido';
            if (typeof mostrarToast === 'function') {
              mostrarToast('Erro ao processar cadastro: ' + mensagemErro, 'error');
            } else {
              alert('Erro ao processar cadastro: ' + mensagemErro);
            }
            return false;
          }
        }
        
        return false;
      }
      
      // Tentar chamar imediatamente
      if (chamarRegistrarCadastro()) {
        return;
      }
      
      // Se n√£o encontrou, tentar ap√≥s pequenos delays
      console.log('‚è≥ Fun√ß√£o completa n√£o encontrada imediatamente, aguardando carregamento...');
      let tentativas = 0;
      const maxTentativas = 10;
      const intervalos = [50, 100, 150, 200, 300, 400, 500, 750, 1000, 1500];
      
      function tentarNovamente() {
        tentativas++;
        
        if (chamarRegistrarCadastro()) {
          console.log('‚úÖ Fun√ß√£o completa encontrada e chamada com sucesso!');
          return;
        }
        
        if (tentativas > maxTentativas) {
          console.error('‚ùå Fun√ß√£o registrarCadastroEstoqueV2 (vers√£o completa) n√£o encontrada ap√≥s', maxTentativas, 'tentativas!');
          console.error('Fun√ß√µes dispon√≠veis com "registrar":', Object.keys(window).filter(k => k.toLowerCase().includes('registrar')));
          console.error('Fun√ß√µes dispon√≠veis com "estoque":', Object.keys(window).filter(k => k.toLowerCase().includes('estoque')));
          console.error('Verificando se √© stub:', window.registrarCadastroEstoqueV2?._isStub);
          console.error('Conte√∫do da fun√ß√£o:', window.registrarCadastroEstoqueV2?.toString().substring(0, 200));
          const mensagem = 'Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina com Ctrl+Shift+R (limpar cache).';
          if (typeof mostrarToast === 'function') {
            mostrarToast(mensagem, 'error');
          } else {
            alert(mensagem + '\n\nVerifique o console (F12) para mais detalhes.');
          }
          return;
        }
        
        const delay = intervalos[Math.min(tentativas - 1, intervalos.length - 1)];
        console.log(`‚è≥ Tentativa ${tentativas}/${maxTentativas} - Aguardando ${delay}ms...`);
        setTimeout(tentarNovamente, delay);
      }
      
      setTimeout(tentarNovamente, 50);
    });
  }
  
  // Tornar fun√ß√µes dispon√≠veis globalmente
  if (typeof window !== 'undefined') {
    // NOTA: registrarCadastroEstoqueV2 ser√° atribu√≠da ao window ap√≥s sua defini√ß√£o (linha ~9624)
    if (typeof inicializarModalEstoque !== 'undefined') {
      window.inicializarModalEstoque = inicializarModalEstoque;
    }
    if (typeof abrirCadastroEstoqueV2Local !== 'undefined') {
      window.abrirCadastroEstoqueV2Local = abrirCadastroEstoqueV2Local;
    }
    if (typeof fecharCadastroEstoqueV2 !== 'undefined') {
      window.fecharCadastroEstoqueV2 = fecharCadastroEstoqueV2;
    }
    window.inicializarModalEstoque = inicializarModalEstoque;
    window.abrirCadastroEstoqueV2Local = abrirCadastroEstoqueV2Local;
    window.fecharCadastroEstoqueV2 = fecharCadastroEstoqueV2;
  }

  if (estoqueCadastroCancelarBtn) {
    estoqueCadastroCancelarBtn.addEventListener('click', () => {
      fecharCadastroEstoqueV2();
    });
  }

  if (conflitoManejoCancelarBtn) {
    conflitoManejoCancelarBtn.addEventListener('click', () => {
      fecharConflitoManejoV2();
      fecharCadastroEstoqueV2();
    });
  }

  // Fun√ß√£o para configurar bot√µes de pesagem (com retry)
  function configurarBotoesPesagem() {
    // Bot√£o Limpar
    const pesoLimparBtnEl = document.getElementById('pesoLimparBtnV2');
    console.log('üîç Configurando bot√£o Limpar...', { pesoLimparBtnEl: !!pesoLimparBtnEl });
    if (pesoLimparBtnEl) {
      // Remover event listeners anteriores se existirem
      const novoLimparBtn = pesoLimparBtnEl.cloneNode(true);
      pesoLimparBtnEl.parentNode.replaceChild(novoLimparBtn, pesoLimparBtnEl);
      
      novoLimparBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Bot√£o Limpar clicado!');
        const pesoInputEl = document.getElementById('pesoValorV2');
        if (pesoInputEl) {
          pesoInputEl.value = '';
          pesoInputEl.focus();
        }
        if (typeof atualizarPesoV2 === 'function') {
          atualizarPesoV2(0);
        } else if (typeof window.atualizarPesoV2 === 'function') {
          window.atualizarPesoV2(0);
        }
      });
      console.log('‚úÖ Event listener do bot√£o Limpar anexado');
    } else {
      console.warn('‚ö†Ô∏è Bot√£o Limpar n√£o encontrado ainda');
    }

    // Bot√£o Gravar
    const pesoGravarBtnEl = document.getElementById('pesoGravarBtnV2');
    console.log('üîç Configurando bot√£o Gravar...', { pesoGravarBtnEl: !!pesoGravarBtnEl });
    if (pesoGravarBtnEl) {
      // Remover event listeners anteriores se existirem
      const novoGravarBtn = pesoGravarBtnEl.cloneNode(true);
      pesoGravarBtnEl.parentNode.replaceChild(novoGravarBtn, pesoGravarBtnEl);
      
      novoGravarBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Bot√£o Gravar clicado!');
        const pesoInputEl = document.getElementById('pesoValorV2');
        if (!pesoInputEl) {
          console.error('‚ùå Campo de peso n√£o encontrado!');
          if (typeof mostrarToast === 'function') {
            mostrarToast('Erro: campo de peso n√£o encontrado.', 'error');
          } else {
            alert('Erro: campo de peso n√£o encontrado.');
          }
          return;
        }
        const valorTexto = pesoInputEl.value.replace(',', '.').trim();
        console.log('üìä Valor do peso:', valorTexto);
        const peso = parseFloat(valorTexto);
        console.log('üìä Peso parseado:', peso);
        if (!isNaN(peso) && peso > 0) {
          console.log('‚úÖ Peso v√°lido, chamando registrarPesagemV2...');
          if (typeof window.registrarPesagemV2 === 'function') {
            window.registrarPesagemV2(peso);
          } else if (typeof registrarPesagemV2 === 'function') {
            registrarPesagemV2(peso);
          } else {
            console.error('‚ùå Fun√ß√£o registrarPesagemV2 n√£o encontrada!');
            if (typeof mostrarToast === 'function') {
              mostrarToast('Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina.', 'error');
            } else {
              alert('Erro: fun√ß√£o de registro n√£o encontrada. Recarregue a p√°gina.');
            }
          }
        } else {
          console.warn('‚ö†Ô∏è Peso inv√°lido:', peso);
          if (typeof mostrarToast === 'function') {
            mostrarToast('Digite um peso v√°lido antes de gravar.', 'error');
          } else {
            alert('Digite um peso v√°lido antes de gravar.');
          }
          if (pesoInputEl) pesoInputEl.focus();
        }
      });
      console.log('‚úÖ Event listener do bot√£o Gravar anexado');
    } else {
      console.warn('‚ö†Ô∏è Bot√£o Gravar n√£o encontrado ainda');
    }
  }
  
  // Tentar configurar imediatamente
  configurarBotoesPesagem();
  
  // Tentar novamente ap√≥s um pequeno delay (caso os elementos ainda n√£o existam)
  setTimeout(configurarBotoesPesagem, 500);
  setTimeout(configurarBotoesPesagem, 1000);

  // Permitir Enter no input de peso para gravar
  if (pesoInput) {
    pesoInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        e.stopPropagation();
        if (pesoGravarBtn) {
          pesoGravarBtn.click();
        }
      }
    });
  }

  function formatarStatusBnd(situacao, constaBnd) {
    if (!situacao) {
      return '<span style="font-size: 0.9rem; font-weight: 500; color: #757575;">N√£o verificado</span>';
    }
    
    const situacaoUpper = (situacao || '').toUpperCase();
    let texto = '';
    let cor = '';
    let bgColor = '';
    
    if (situacaoUpper === 'CONFORME') {
      texto = 'Conforme';
      cor = '#2e7d32';
      bgColor = '#e8f5e9';
    } else if (situacaoUpper === 'ATUALIZAR') {
      texto = 'Atualizar';
      cor = '#f57c00';
      bgColor = '#fff3e0';
    } else if (situacaoUpper === 'NAO_CONFORME') {
      texto = 'N√£o conforme';
      cor = '#c62828';
      bgColor = '#ffebee';
    } else {
      texto = situacao;
      cor = '#757575';
      bgColor = '#f5f5f5';
    }
    
    return `<span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; color: ${cor}; background-color: ${bgColor};">
      ${texto}
    </span>`;
  }

  // Tornar fun√ß√£o global para uso fora do DOMContentLoaded
  window.abrirPopupBrinco = function(dados) {
    console.log('abrirPopupBrinco chamado com dados:', dados);
    console.log('brincoConfirmOverlay:', brincoConfirmOverlay);
    
    if (!brincoConfirmOverlay) {
      console.error('brincoConfirmOverlay n√£o encontrado!');
      return;
    }
    
    if (!dados) {
      console.error('Dados n√£o fornecidos para abrirPopupBrinco');
      return;
    }
    
    try {
      if (brincoConfirmNumero) {
        brincoConfirmNumero.textContent = dados.brinco || '‚Äî';
      }
      
      // SISBOV
      if (brincoConfirmSisbov) {
        brincoConfirmSisbov.textContent = dados.codigo_sisbov || dados.sisbov || dados.brinco || '‚Äî';
      }
      
      // N√∫mero de Manejo
      if (brincoConfirmManejo) {
        brincoConfirmManejo.textContent = dados.numero_manejo || '‚Äî';
      }
      
      // Status BND
      if (brincoConfirmBnd) {
        brincoConfirmBnd.innerHTML = formatarStatusBnd(dados.situacao_bnd, dados.consta_bnd);
      }
      
      if (brincoConfirmRaca) {
        brincoConfirmRaca.textContent = dados.raca || '‚Äî';
      }
      
      if (brincoConfirmSexo) {
        brincoConfirmSexo.textContent = dados.sexo || '‚Äî';
      }
      
      if (brincoConfirmDataNasc) {
        brincoConfirmDataNasc.textContent = dados.data_nascimento || '‚Äî';
      }
      
      // Formatar peso
      const pesoFormatado = dados.ultimo_peso 
        ? (typeof dados.ultimo_peso === 'number' 
            ? dados.ultimo_peso.toFixed(1).replace('.', ',') + ' kg'
            : dados.ultimo_peso)
        : '‚Äî';
      
      if (brincoConfirmUltimoPeso) {
        brincoConfirmUltimoPeso.textContent = pesoFormatado;
      }
      
      if (brincoConfirmLote) {
        brincoConfirmLote.textContent = dados.lote || '‚Äî';
      }
      
      if (brincoConfirmReprodutivo) {
        brincoConfirmReprodutivo.textContent = dados.status_reprodutivo || '‚Äî';
      }
      
      // Adicionar classe show para exibir o modal
      console.log('Adicionando classe show ao overlay');
      brincoConfirmOverlay.style.display = 'flex';
      brincoConfirmOverlay.classList.add('show');
      
      // For√ßar exibi√ß√£o caso o CSS n√£o esteja funcionando
      setTimeout(() => {
        if (!brincoConfirmOverlay.classList.contains('show')) {
          brincoConfirmOverlay.classList.add('show');
        }
        brincoConfirmOverlay.style.display = 'flex';
        brincoConfirmOverlay.style.opacity = '1';
        
        const temShow = brincoConfirmOverlay.classList.contains('show');
        const display = window.getComputedStyle(brincoConfirmOverlay).display;
        const opacity = window.getComputedStyle(brincoConfirmOverlay).opacity;
        console.log('Modal ap√≥s adicionar show:', {
          temShow: temShow,
          display: display,
          opacity: opacity,
          classes: brincoConfirmOverlay.className,
          styleDisplay: brincoConfirmOverlay.style.display
        });
      }, 50);
      
    } catch (error) {
      console.error('Erro ao abrir popup de brinco:', error);
      mostrarToast('Erro ao exibir dados do animal. Verifique o console.', 'error');
    }
  }

  // Tornar fun√ß√£o global para uso fora do DOMContentLoaded
  window.fecharPopupBrinco = function() {
    console.log('üîí fecharPopupBrinco chamado');
    const overlay = document.getElementById('brincoConfirmOverlay');
    if (overlay) {
      console.log('‚úÖ Fechando popup brinco');
      overlay.classList.remove('show');
      overlay.style.display = 'none';
      overlay.style.opacity = '0';
    } else {
      console.error('‚ùå brincoConfirmOverlay n√£o encontrado para fechar');
    }
  }
  
  // Fechar modal ao clicar fora dele
  if (brincoConfirmOverlay) {
    brincoConfirmOverlay.addEventListener('click', function(e) {
      if (e.target === brincoConfirmOverlay) {
        if (typeof window.fecharPopupBrinco === 'function') {
          window.fecharPopupBrinco();
        } else if (typeof fecharPopupBrinco === 'function') {
          fecharPopupBrinco();
        }
      }
    });
    
    // Suporte para tecla Enter no popup
    document.addEventListener('keydown', function(e) {
      // Verificar se o popup est√° vis√≠vel
      const overlay = document.getElementById('brincoConfirmOverlay');
      const okBtn = document.getElementById('brincoConfirmOkBtn');
      
      if (overlay && overlay.style.display !== 'none' && overlay.classList.contains('show')) {
        // Verificar z-index para permitir intera√ß√£o mesmo com modal de erro
        const overlayZIndex = parseInt(window.getComputedStyle(overlay).zIndex) || 0;
        
        if (e.key === 'Enter' || e.keyCode === 13) {
          // Se o popup tem z-index alto, permitir Enter mesmo com modal de erro
          if (overlayZIndex >= 10000) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            console.log('‚úÖ Enter pressionado no popup (z-index alto), confirmando...');
            if (okBtn) {
              okBtn.click();
            }
          } else {
            // Verificar se n√£o h√° modal de erro bloqueando
            const errorModal = document.querySelector('.modal.show, .alert.show');
            if (!errorModal) {
              e.preventDefault();
              e.stopPropagation();
              console.log('‚úÖ Enter pressionado no popup, confirmando...');
              if (okBtn) {
                okBtn.click();
              }
            }
          }
        } else if (e.key === 'Escape' || e.keyCode === 27) {
          e.preventDefault();
          e.stopPropagation();
          console.log('‚úÖ Escape pressionado no popup, cancelando...');
          if (brincoConfirmCancelarBtn) {
            brincoConfirmCancelarBtn.click();
          }
        }
      }
    });
  }
  
  // Event listener de ESC foi integrado acima no listener de Enter/Escape

  function abrirManejoReprodutivo(manejoId, titulo) {
    if (manejoId === 'rep_programar_iatf') {
      mostrarToast('Abrindo formul√°rio de IATF...', 'info');
      // Aqui pode abrir um modal ou redirecionar para formul√°rio de IATF
      // Por enquanto, apenas mostra mensagem
      setTimeout(() => {
        mostrarToast('Funcionalidade de IATF ser√° implementada em breve', 'info');
      }, 500);
    } else {
      mostrarToast(`Abrindo ${titulo}...`, 'info');
    }
  }

  async function identificarBrinco(codigo) {
    console.log('=== identificarBrinco CHAMADO ===');
    console.log('C√≥digo recebido:', codigo);
    console.log('Tipo:', typeof codigo);
    
    // Normaliza o c√≥digo removendo espa√ßos e caracteres especiais
    const limpo = (codigo || '').trim().replace(/\s+/g, '');
    console.log('C√≥digo limpo:', limpo, 'Tamanho:', limpo.length);
    
    if (!limpo || limpo.length < 3) {
      console.warn('C√≥digo muito curto!');
      mostrarToast('C√≥digo muito curto. Digite pelo menos 3 caracteres.', 'warning');
      if (brincoInput) {
        brincoInput.focus();
      }
      return;
    }
    
    // Limpa o estado anterior
    currentAnimalV2 = null;
    atualizarScannerResumoV2(null);
    
    console.log('Verificando status online...');
    // Se offline, busca no cache local primeiro
    let isOffline = false;
    if (typeof curralSync !== 'undefined' && typeof curralSync.isOnlineStatus === 'function') {
      isOffline = !curralSync.isOnlineStatus();
    } else {
      isOffline = !navigator.onLine;
    }
    
    if (isOffline && typeof curralDB !== 'undefined' && typeof curralDB.buscarAnimalCache === 'function') {
      console.log('Modo offline detectado');
      const animalCache = await curralDB.buscarAnimalCache(limpo);
      if (animalCache) {
        mostrarToast('Animal encontrado no cache local (modo offline)', 'info');
        mostrarLoading(false);
        const a = animalCache;
        currentAnimalV2 = a;
        const dadosPopup = {
          brinco: a.numero_brinco || a.brinco_visual || limpo,
          codigo_sisbov: a.codigo_sisbov || a.numero_brinco || limpo,
          numero_manejo: a.numero_manejo || '',
          situacao_bnd: a.situacao_bnd || '',
          consta_bnd: a.consta_bnd || false,
          raca: a.raca || '',
          sexo: a.sexo || '',
          data_nascimento: a.data_nascimento || a.data_nascimento_format || '',
          ultimo_peso: a.peso_atual || (a.pesagem_atual && a.pesagem_atual.peso) || '',
          lote: a.lote_atual || '',
          status_reprodutivo: a.status_reprodutivo || ''
        };
        if (brincoInput) {
          brincoInput.value = dadosPopup.brinco || limpo;
        }
        atualizarResumoPesagemV2();
        // Passar dados originais do animal, n√£o o dadosPopup simplificado
        if (typeof window.atualizarScannerResumoV2 === 'function') {
          window.atualizarScannerResumoV2(a);
        } else if (typeof atualizarScannerResumoV2 === 'function') {
          atualizarScannerResumoV2(a);
        }
        abrirPopupBrinco(dadosPopup);
        return;
      } else {
        mostrarToast('Animal n√£o encontrado no cache. Aguarde conex√£o para buscar no servidor.', 'warning');
        mostrarLoading(false);
        if (brincoInput) {
          brincoInput.focus();
        }
        return;
      }
    }
    
    mostrarLoading(true);
    try {
      // Verificar se est√° em modo de simula√ß√£o
      const modoSimulacao = typeof SimulacaoSistema !== 'undefined' && SimulacaoSistema.config && SimulacaoSistema.config.ativa;
      
      let url = identificarUrl + '?codigo=' + encodeURIComponent(limpo);
      if (modoSimulacao) {
        url += '&simulacao=true';
      }
      console.log('Fazendo requisi√ß√£o para:', url);
      console.log('identificarUrl base:', identificarUrl);
      
      const headers = { 
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      };
      if (modoSimulacao) {
        headers['X-Simulacao'] = 'true';
      }
      
      const resp = await fetch(url, { headers });
      
      console.log('Resposta recebida:', resp.status, resp.statusText);
      console.log('Headers:', resp.headers);
      
      // Verifica se a resposta √© v√°lida
      if (!resp.ok) {
        console.error('Resposta n√£o OK:', resp.status);
        // Tenta ler a resposta JSON mesmo em caso de erro
        let errorData = null;
        try {
          errorData = await resp.json();
        } catch (e) {
          // Se n√£o conseguir ler JSON, usa mensagem padr√£o
        }
        
        mostrarLoading(false);
        const mensagem = errorData?.mensagem || `Erro ao buscar brinco (${resp.status}). Verifique a conex√£o.`;
        mostrarToast(mensagem, 'error');
        if (brincoInput) {
          brincoInput.focus();
        }
        return;
      }
      
      const data = await resp.json();
      console.log('Dados JSON recebidos:', data);
      console.log('Status da resposta:', data.status);
      
      // Salvar no cache se encontrou animal
      if (data.status === 'animal' && data.dados) {
        console.log('Salvando animal no cache...');
        await curralDB.salvarAnimalCache({
          ...data.dados,
          codigo: limpo
        });
      }
      
      console.log('Resposta curral_identificar_codigo V2:', data);
      
      if (data.status === 'animal') {
        console.log('‚úÖ Animal encontrado! Dados:', data.dados);
        mostrarLoading(false);
        const a = data.dados || {};
        currentAnimalV2 = a;
        window.animalAtualV2 = a; // Garantir que est√° na vari√°vel global
        // Atualiza informa√ß√µes de √∫ltima pesagem no card
        const dadosPopup = {
          brinco: a.numero_brinco || a.brinco_visual || limpo,
          codigo_sisbov: a.codigo_sisbov || a.numero_brinco || limpo,
          numero_manejo: a.numero_manejo || '',
          situacao_bnd: a.situacao_bnd || '',
          consta_bnd: a.consta_bnd || false,
          raca: a.raca || '',
          sexo: a.sexo || '',
          data_nascimento: a.data_nascimento || a.data_nascimento_format || '',
          ultimo_peso: a.peso_atual || (a.pesagem_atual && a.pesagem_atual.peso) || '',
          lote: a.lote_atual || '',
          status_reprodutivo: a.status_reprodutivo || ''
        };
        // Garante que o campo de leitura j√° venha preenchido com o brinco identificado
        if (brincoInput) {
          brincoInput.value = dadosPopup.brinco || limpo;
        }
        atualizarResumoPesagemV2();
        // IMPORTANTE: Passar dados originais do animal (a), n√£o dadosPopup simplificado
        if (typeof window.atualizarScannerResumoV2 === 'function') {
          console.log('‚úÖ Chamando atualizarScannerResumoV2 com dados originais do animal');
          window.atualizarScannerResumoV2(a);
        } else if (typeof atualizarScannerResumoV2 === 'function') {
          console.log('‚úÖ Chamando atualizarScannerResumoV2 (sem window) com dados originais');
          atualizarScannerResumoV2(a);
        } else {
          console.warn('‚ö†Ô∏è atualizarScannerResumoV2 n√£o encontrada!');
        }
        abrirPopupBrinco(dadosPopup);
        return;
      }

      if (data.status === 'estoque') {
        mostrarLoading(false);
        // Brinco est√° no estoque: abre fluxo de cadastro r√°pido de animal
        abrirCadastroEstoqueV2(data.dados || {}, limpo);
        return;
      }

      if (data.status === 'animal_externo') {
        mostrarLoading(false);
        mostrarToast(data.mensagem || 'Animal pertence a outra fazenda no sistema.', 'warning');
        if (brincoInput) {
          brincoInput.focus();
        }
        return;
      }

      // Trata status 'nao_encontrado' ou qualquer outro status n√£o tratado
      mostrarLoading(false);
      const mensagem = data.mensagem || 'Brinco n√£o encontrado ou n√£o vinculado a animal ativo.';
      mostrarToast(mensagem, 'warning');
      if (brincoInput) {
        brincoInput.focus();
        brincoInput.select(); // Seleciona o texto para facilitar nova digita√ß√£o
      }
    } catch (err) {
      console.error('Erro ao identificar brinco:', err);
      mostrarLoading(false);
      mostrarToast('N√£o foi poss√≠vel consultar o brinco. Verifique a conex√£o e tente novamente.', 'error');
      if (brincoInput) {
        brincoInput.focus();
      }
    }
  }

  // Garantir que o Enter funcione em todos os navegadores
  if (!brincoInput) {
    console.error('ERRO CR√çTICO: brincoInput n√£o encontrado! N√£o √© poss√≠vel anexar event listeners.');
    // Tentar encontrar novamente ap√≥s um delay
    setTimeout(() => {
      const brincoInputRetry = document.getElementById('brincoInputV2');
      if (brincoInputRetry) {
        console.log('brincoInput encontrado no retry!');
        anexarEventListenersBrinco(brincoInputRetry);
      } else {
        console.error('brincoInput ainda n√£o encontrado ap√≥s retry');
      }
    }, 1000);
  } else {
    console.log('brincoInput encontrado, anexando listeners...');
    anexarEventListenersBrinco(brincoInput);
  }
  

  // Event listeners para bot√µes do popup de confirma√ß√£o
  if (brincoConfirmOkBtn) {
    console.log('‚úÖ Bot√£o Confirmar encontrado, anexando event listener');
    brincoConfirmOkBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      console.log('‚úÖ Bot√£o Confirmar clicado - evento capturado');
      
      // Confirma o animal e segue para pesagem (V2)
      // Garante que o brinco fique vis√≠vel/gravado no campo de scanner
      if (brincoConfirmNumero && brincoInput) {
        const numero = (brincoConfirmNumero.textContent || '').trim();
        if (numero) {
          brincoInput.value = numero;
        }
      }
      
      // Fechar popup usando fun√ß√£o global
      if (typeof window.fecharPopupBrinco === 'function') {
        window.fecharPopupBrinco();
      } else if (typeof fecharPopupBrinco === 'function') {
        fecharPopupBrinco();
      } else {
        const overlay = document.getElementById('brincoConfirmOverlay');
        if (overlay) {
          overlay.style.display = 'none';
          overlay.classList.remove('show');
        }
      }
      
      // Aqui poderemos acionar o modo de pesagem por voz; por enquanto focamos no bot√£o manual.
      if (pesoManualBtn) {
        pesoManualBtn.focus();
      }
      
      // Adiciona bot√£o de hist√≥rico se n√£o existir (ap√≥s confirma√ß√£o)
      setTimeout(() => {
        const animal = window.animalAtualV2 || currentAnimalV2;
        if (animal && !document.getElementById('btnHistoricoAnimalV2')) {
          const btnHistorico = document.createElement('button');
          btnHistorico.id = 'btnHistoricoAnimalV2';
          btnHistorico.className = 'btn btn-sm btn-outline-info';
          btnHistorico.innerHTML = '<i class="fas fa-chart-line"></i> Ver Hist√≥rico';
          btnHistorico.style.marginTop = '8px';
          btnHistorico.onclick = () => abrirHistoricoAnimal(animal);
          const pesoDisplay = document.querySelector('.peso-display-v2-buttons');
          if (pesoDisplay) {
            pesoDisplay.appendChild(btnHistorico);
          }
        }
      }, 100);
    });
  } else {
    console.error('‚ùå brincoConfirmOkBtn n√£o encontrado!');
  }

  if (brincoConfirmCancelarBtn) {
    console.log('‚úÖ Bot√£o Cancelar encontrado, anexando event listener');
    brincoConfirmCancelarBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('‚úÖ Bot√£o Cancelar clicado');
      
      // Fechar popup usando fun√ß√£o global
      if (typeof window.fecharPopupBrinco === 'function') {
        window.fecharPopupBrinco();
      } else if (typeof fecharPopupBrinco === 'function') {
        fecharPopupBrinco();
      } else {
        const overlay = document.getElementById('brincoConfirmOverlay');
        if (overlay) {
          overlay.style.display = 'none';
          overlay.classList.remove('show');
        }
      }
      
      if (brincoInput) {
        brincoInput.focus();
      }
    });
  } else {
    console.error('‚ùå brincoConfirmCancelarBtn n√£o encontrado!');
  }

  async function registrarPesagemV2(peso) {
    console.log('üíæ registrarPesagemV2 chamado com peso:', peso);
    
    // Usar animalAtualV2 (nova l√≥gica) ou currentAnimalV2 (l√≥gica antiga) como fallback
    const animal = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
    
    console.log('üêÑ Animal encontrado para pesagem:', !!animal, animal ? {
      id: animal.id,
      numero_brinco: animal.numero_brinco,
      peso_atual: animal.peso_atual,
      peso_anterior: animal.peso_anterior
    } : 'null');
    
    if (!animal) {
      console.error('‚ùå Animal n√£o encontrado! Verifique se o brinco foi identificado.');
      mostrarToast('Leia e confirme um brinco antes de registrar a pesagem.', 'warning');
      return;
    }
    if (!peso || peso <= 0) {
      console.error('‚ùå Peso inv√°lido:', peso);
      mostrarToast('Informe um peso v√°lido antes de registrar.', 'warning');
      return;
    }
    
    // Verificar tipo de pesagem selecionado
    const pesagemRotina = document.getElementById('pesagemRotinaV2');
    const pesagemAparte = document.getElementById('pesagemAparteV2');
    const tipoPesagem = pesagemRotina && pesagemRotina.checked ? 'rotina' : 
                       pesagemAparte && pesagemAparte.checked ? 'aparte' : 'rotina';
    
    const brincoInput = document.getElementById('brincoInputV2');
    const codigo = animal.codigo_sisbov || animal.numero_brinco || (brincoInput ? brincoInput.value : '');
    const hoje = new Date();
    const dataStr = hoje.toISOString().slice(0, 10); // YYYY-MM-DD
    const horaStr = hoje.toTimeString().slice(0, 5); // HH:MM

    // Definir manejo baseado no tipo de pesagem
    const manejo = tipoPesagem === 'rotina' ? 'PESAGEM_ROTINA' : 'PESAGEM_APARTACAO';
    const salvarHistorico = tipoPesagem === 'rotina';

    const payload = {
      tipo_fluxo: 'animal',
      manejo: manejo,
      codigo: codigo,
      animal_id: animal.id || null,
      dados: {
        peso: peso,
        data: dataStr,
        hora: horaStr,
        observacoes: tipoPesagem === 'aparte' ? 'Pesagem para aparta√ß√£o/loteamento' : '',
        local: 'CURRAL_V2',
        salvar_historico: salvarHistorico,
        tipo_pesagem: tipoPesagem
      }
    };

    // Usar sistema de sincroniza√ß√£o offline
    mostrarLoading(true);
    try {
      const resultado = await curralSync.adicionarParaSincronizacao(
        'pesagem',
        registrarUrl,
        'POST',
        payload,
        {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      );
      
      mostrarLoading(false);
      
      // Adicionar √† lista de animais trabalhados (sempre que a pesagem for registrada)
      const animal = window.animalAtualV2 || currentAnimalV2;
      if (animal) {
        const pesoFormatado = parseFloat(peso.toString().replace(',', '.')).toFixed(1);
        const tipoLabel = tipoPesagem === 'rotina' ? 'Rotina' : 'Aparta√ß√£o';
        if (typeof window.adicionarAnimalTrabalhado === 'function') {
          window.adicionarAnimalTrabalhado({
            sisbov: animal.codigo_sisbov || animal.numero_brinco || '',
            brinco: animal.numero_manejo || animal.numero_brinco || '',
            peso: pesoFormatado,
            tipo: tipoPesagem === 'rotina' ? 'pesagem' : 'aparte',
            detalhes: `${tipoLabel} ¬∑ ${animal.raca || ''} ${animal.sexo === 'M' ? 'Macho' : animal.sexo === 'F' ? 'F√™mea' : ''} ¬∑ ${pesoFormatado} kg`,
            data: new Date().toLocaleString('pt-BR')
          });
        }
      }
      
      // Se for pesagem para aparta√ß√£o, verificar e mostrar popup
      if (tipoPesagem === 'aparte') {
        const pesoNum = parseFloat(peso.toString().replace(',', '.'));
        const apartacao = window.encontrarApartacao(pesoNum);
        
        if (apartacao) {
          // Mostrar popup de indica√ß√£o de aparta√ß√£o
          window.mostrarPopupApartacao(apartacao.nome, apartacao.cor);
        } else {
          mostrarToast('Peso n√£o se encaixa em nenhuma aparta√ß√£o configurada', 'warning');
        }
      }
      
      const mensagem = tipoPesagem === 'rotina' 
        ? 'Pesagem de rotina registrada e sincronizada com sucesso!'
        : 'Pesagem para aparta√ß√£o registrada com sucesso!';
      
      // Tocar aviso sonoro discreto para peso gravado
      if (typeof window.tocarAvisoSonoro === 'function') {
        window.tocarAvisoSonoro('peso');
      }
      
      if (resultado.synced) {
        if (tipoPesagem === 'rotina') {
          mostrarToast(mensagem, 'success');
        }
        // Para aparta√ß√£o, o popup j√° foi mostrado acima
      } else if (resultado.queued) {
        mostrarToast('Pesagem salva localmente. Ser√° sincronizada quando a conex√£o for restaurada.', 'info');
      } else {
        mostrarToast('Pesagem salva localmente.', 'info');
      }

      // Atualiza o "√∫ltimo peso" do animal em mem√≥ria APENAS se for pesagem de rotina
      if (tipoPesagem === 'rotina') {
        const hoje = new Date();
        const dataStr = hoje.toISOString().slice(0, 10);
        
        // Salvar peso anterior antes de atualizar (para c√°lculo de ganho)
        const animal = window.animalAtualV2 || (typeof currentAnimalV2 !== 'undefined' ? currentAnimalV2 : null);
        if (animal) {
          // Salvar peso anterior se ainda n√£o foi salvo
          if (!animal.peso_anterior && animal.peso_atual) {
            animal.peso_anterior = animal.peso_atual;
            animal.data_peso_anterior = animal.data_peso_atual || animal.data_peso_iso;
          }
        }
        
        // Atualizar ambas as vari√°veis para compatibilidade
        if (window.animalAtualV2) {
          // Manter peso anterior se j√° existir
          if (!window.animalAtualV2.peso_anterior && window.animalAtualV2.peso_atual) {
            window.animalAtualV2.peso_anterior = window.animalAtualV2.peso_atual;
            window.animalAtualV2.data_peso_anterior = window.animalAtualV2.data_peso_atual;
          }
          window.animalAtualV2.peso_atual = peso;
          window.animalAtualV2.data_peso_atual = dataStr;
          window.animalAtualV2.pesagem_atual = { peso: peso, data: dataStr };
        }
        if (typeof currentAnimalV2 !== 'undefined' && currentAnimalV2) {
          if (!currentAnimalV2.peso_anterior && currentAnimalV2.peso_atual) {
            currentAnimalV2.peso_anterior = currentAnimalV2.peso_atual;
            currentAnimalV2.data_peso_anterior = currentAnimalV2.data_peso_atual;
          }
          currentAnimalV2.peso_atual = peso;
          currentAnimalV2.data_peso_atual = dataStr;
        }
        
        // Atualizar interface
        console.log('üîÑ Atualizando interface ap√≥s registrar pesagem...');
        if (typeof atualizarInfoPesagem === 'function') {
          atualizarInfoPesagem(window.animalAtualV2 || currentAnimalV2);
        }
        
        // Sempre tentar atualizar o resumo de pesagem
        console.log('üìä Chamando atualizarResumoPesagemV2 com:', { peso, dataStr });
        if (typeof window.atualizarResumoPesagemV2 === 'function') {
          window.atualizarResumoPesagemV2(peso, dataStr);
        } else if (typeof atualizarResumoPesagemV2 === 'function') {
          atualizarResumoPesagemV2(peso, dataStr);
        } else {
          console.error('‚ùå Fun√ß√£o atualizarResumoPesagemV2 n√£o encontrada!');
        }
      } else {
        // Para pesagem de aparta√ß√£o, o popup j√° foi mostrado acima
        // N√£o mostrar toast adicional para n√£o poluir a interface
      }
      
      // Depois da pesagem, se o modo "Diagn√≥stico r√°pido" estiver ativo, abre o popup;
      // caso contr√°rio, finaliza o animal (respeitando auto-pr√≥ximo).
      const diagCard = document.querySelector('.config-trabalho-card:nth-child(2)');
      const diagAtivo = diagCard && diagCard.classList.contains('active');
      if (diagAtivo) {
        abrirDiagnosticoV2();
      } else {
        finalizarAnimalV2();
      }
    } catch (e) {
      console.error('Erro ao registrar pesagem V2:', e);
      mostrarLoading(false);
      // Mesmo em caso de erro, tenta salvar localmente
      try {
        await curralSync.adicionarParaSincronizacao(
          'pesagem',
          registrarUrl,
          'POST',
          payload,
          {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        );
        mostrarToast('Pesagem salva localmente devido a erro de conex√£o.', 'warning');
      } catch (err) {
        mostrarToast('Erro ao salvar pesagem. Tente novamente.', 'error');
      }
    }
  }

  // Melhorar tratamento de erros em outras fun√ß√µes
  // Fun√ß√£o ser√° definida abaixo e atribu√≠da ao window ap√≥s sua defini√ß√£o
  
  // Fun√ß√£o para calcular idade em meses a partir da data de nascimento
  function calcularIdadeMesesDeData(dataNasc) {
    if (!dataNasc) return '';
    const hoje = new Date();
    const nasc = new Date(dataNasc);
    const diffAnos = hoje.getFullYear() - nasc.getFullYear();
    const diffMeses = hoje.getMonth() - nasc.getMonth();
    const diffDias = hoje.getDate() - nasc.getDate();
    let totalMeses = diffAnos * 12 + diffMeses;
    if (diffDias < 0) {
      totalMeses--;
    }
    return totalMeses >= 0 ? totalMeses.toString() : '';
  }

  // Fun√ß√£o duplicada removida - a fun√ß√£o correta est√° na linha 11204

  // Substituir alert por toast em outras fun√ß√µes
  const originalAlert = window.alert;
  window.alert = function(msg) {
    mostrarToast(msg, 'info');
  };

  // ========== MODAL IATF ==========
  const iatfModal = document.getElementById('iatfModalOverlayV2');
  const iatfCancelarBtn = document.getElementById('iatfCancelarBtnV2');
  const iatfConfirmarBtn = document.getElementById('iatfConfirmarBtnV2');
  const iatfProtocoloSelect = document.getElementById('iatfProtocoloSelectV2');
  const iatfDataInicio = document.getElementById('iatfDataInicioV2');
  let iatfAnimalAtual = null;
  let pesoChartV2 = null;

  function abrirModalIATF(animal) {
    if (!animal || !iatfModal) return;
    iatfAnimalAtual = animal;
    document.getElementById('iatfAnimalBrincoV2').textContent = animal.numero_brinco || animal.codigo_sisbov || '‚Äî';
    document.getElementById('iatfAnimalCategoriaV2').textContent = animal.categoria || '‚Äî';
    iatfModal.classList.add('show');
  }

  function fecharModalIATF() {
    if (iatfModal) {
      iatfModal.classList.remove('show');
      iatfAnimalAtual = null;
    }
  }

  if (iatfCancelarBtn) {
    iatfCancelarBtn.addEventListener('click', fecharModalIATF);
  }

  if (iatfConfirmarBtn) {
    iatfConfirmarBtn.addEventListener('click', async () => {
      if (!iatfAnimalAtual) {
        mostrarToast('Animal n√£o identificado.', 'warning');
        return;
      }
      const protocoloId = iatfProtocoloSelect.value;
      const protocoloNome = iatfProtocoloSelect.options[iatfProtocoloSelect.selectedIndex]?.text || '';
      const dataInicio = iatfDataInicio.value;
      const touroId = document.getElementById('iatfTouroSelectV2').value;
      const inseminadorId = document.getElementById('iatfInseminadorSelectV2').value;
      const loteExistenteId = document.getElementById('iatfLoteSelectV2').value;
      const loteNovo = document.getElementById('iatfLoteNovoV2').value.trim();
      const observacoes = document.getElementById('iatfObservacoesV2').value.trim();

      if (!protocoloId || !dataInicio) {
        mostrarToast('Preencha protocolo e data de in√≠cio.', 'warning');
        return;
      }

      const protocoloDuracao = iatfProtocoloSelect.options[iatfProtocoloSelect.selectedIndex]?.dataset.duracao || 10;
      const dataIATF = new Date(dataInicio);
      dataIATF.setDate(dataIATF.getDate() + parseInt(protocoloDuracao));

      const payload = {
        tipo_fluxo: 'animal',
        manejo: 'rep_programar_iatf',
        codigo: iatfAnimalAtual.codigo_sisbov || iatfAnimalAtual.numero_brinco,
        animal_id: iatfAnimalAtual.id,
        dados: {
          protocolo_id: parseInt(protocoloId),
          protocolo_nome: protocoloNome,
          protocolo_duracao: parseInt(protocoloDuracao),
          data_inicio: dataInicio,
          data_iatf: dataIATF.toISOString().slice(0, 10),
          touro_id: touroId ? parseInt(touroId) : null,
          lote_inseminador_id: inseminadorId ? parseInt(inseminadorId) : null,
          lote_existente_id: loteExistenteId ? parseInt(loteExistenteId) : null,
          lote_nome: loteNovo || null,
          observacoes: observacoes,
        }
      };

      mostrarLoading(true);
      try {
        const resp = await fetch(registrarUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        mostrarLoading(false);
        if (!resp.ok || data.status !== 'ok') {
          mostrarToast(data.mensagem || 'N√£o foi poss√≠vel registrar o protocolo IATF.', 'error');
          return;
        }
        mostrarToast(data.mensagem || 'Protocolo IATF registrado com sucesso!', 'success');
        fecharModalIATF();
      } catch (e) {
        console.error('Erro ao registrar IATF:', e);
        mostrarLoading(false);
        mostrarToast('Erro ao comunicar com o servidor.', 'error');
      }
    });
  }

  // Atualizar fun√ß√£o abrirManejoReprodutivo
  window.abrirManejoReprodutivo = function(manejoId, titulo) {
    if (manejoId === 'rep_programar_iatf') {
      if (currentAnimalV2) {
        abrirModalIATF(currentAnimalV2);
      } else {
        mostrarToast('Leia o brinco do animal primeiro.', 'warning');
      }
    } else {
      mostrarToast(`Abrindo ${titulo}...`, 'info');
    }
  };

  // ========== HIST√ìRICO E GR√ÅFICOS ==========
  const historicoModal = document.getElementById('historicoModalOverlayV2');
  const historicoFecharBtn = document.getElementById('historicoFecharBtnV2');
  // propriedadeId j√° foi declarado acima, usar a vari√°vel existente
  // const propriedadeId = {{ propriedade.id|default:0 }};

  window.mostrarHistoricoTab = function(tab) {
    const pesoTab = document.getElementById('historicoTabPesoV2');
    const manejosTab = document.getElementById('historicoTabManejosV2');
    const pesoConteudo = document.getElementById('historicoConteudoPesoV2');
    const manejosConteudo = document.getElementById('historicoConteudoManejosV2');

    if (tab === 'peso') {
      pesoTab.classList.add('active');
      manejosTab.classList.remove('active');
      pesoConteudo.style.display = 'block';
      manejosConteudo.style.display = 'none';
    } else {
      pesoTab.classList.remove('active');
      manejosTab.classList.add('active');
      pesoConteudo.style.display = 'none';
      manejosConteudo.style.display = 'block';
    }
  };

  async function abrirHistoricoAnimal(animal) {
    if (!animal || !animal.id) {
      mostrarToast('Animal n√£o identificado.', 'warning');
      return;
    }
    if (!historicoModal) return;

    historicoModal.classList.add('show');
    mostrarLoading(true);

    try {
      // Carregar hist√≥rico de pesagens
      const respPesagens = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/${animal.id}/pesagens/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const dataPesagens = await respPesagens.json();

      // Carregar hist√≥rico de manejos
      const respManejos = await fetch(`/propriedade/${propriedadeId}/curral/api/animal/${animal.id}/manejos/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const dataManejos = await respManejos.json();

      mostrarLoading(false);

      // Renderizar gr√°fico de peso
      if (dataPesagens.status === 'ok' && dataPesagens.historico.length > 0) {
        renderizarGraficoPeso(dataPesagens.historico);
        renderizarListaPesagens(dataPesagens.historico);
      } else {
        document.getElementById('pesoChartV2').parentElement.innerHTML = '<p style="text-align:center;color:#999;">Nenhuma pesagem registrada</p>';
      }

      // Renderizar hist√≥rico de manejos
      if (dataManejos.status === 'ok') {
        renderizarListaManejos(dataManejos.historico);
      }
    } catch (e) {
      console.error('Erro ao carregar hist√≥rico:', e);
      mostrarLoading(false);
      mostrarToast('Erro ao carregar hist√≥rico do animal.', 'error');
    }
  }

  function renderizarGraficoPeso(historico) {
    const ctx = document.getElementById('pesoChartV2');
    if (!ctx) return;

    // Ordena por data
    const ordenado = [...historico].sort((a, b) => new Date(a.data) - new Date(b.data));
    const labels = ordenado.map(h => {
      const d = new Date(h.data);
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    });
    const pesos = ordenado.map(h => h.peso);

    if (pesoChartV2) {
      pesoChartV2.destroy();
    }

    pesoChartV2 = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Peso (kg)',
          data: pesos,
          borderColor: '#1e88e5',
          backgroundColor: 'rgba(30, 136, 229, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Peso: ${context.parsed.y.toFixed(1)} kg`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            title: { display: true, text: 'Peso (kg)' }
          }
        }
      }
    });
  }

  function renderizarListaPesagens(historico) {
    const container = document.getElementById('pesoHistoricoListaV2');
    if (!container) return;

    if (historico.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#999;">Nenhuma pesagem registrada</p>';
      return;
    }

    container.innerHTML = historico.map(h => `
      <div style="padding: 8px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between;">
        <div>
          <strong>${h.data_formatada}</strong>
          ${h.observacoes ? `<div style="font-size: 0.8rem; color: #607d8b;">${h.observacoes}</div>` : ''}
        </div>
        <div style="font-weight: 600; color: var(--monpec-primary-dark);">
          ${h.peso ? h.peso.toFixed(1) + ' kg' : '‚Äî'}
        </div>
      </div>
    `).join('');
  }

  function renderizarListaManejos(historico) {
    const container = document.getElementById('manejosHistoricoListaV2');
    if (!container) return;

    if (historico.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#999;">Nenhum manejo registrado</p>';
      return;
    }

    container.innerHTML = historico.map(h => `
      <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; margin-bottom: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
          <div>
            <strong style="color: var(--monpec-primary-dark);">${h.titulo || h.tipo_manejo}</strong>
            <div style="font-size: 0.8rem; color: #607d8b; margin-top: 2px;">
              ${h.data_formatada || ''} ${h.responsavel ? '¬∑ ' + h.responsavel : ''}
            </div>
          </div>
          <span style="font-size: 0.75rem; padding: 2px 8px; background: #e3f2fd; border-radius: 12px; color: var(--monpec-primary-dark);">
            ${h.status}
          </span>
        </div>
        ${h.observacoes ? `<div style="font-size: 0.85rem; color: #455a64; margin-top: 4px;">${h.observacoes}</div>` : ''}
        ${h.peso ? `<div style="font-size: 0.85rem; color: #607d8b; margin-top: 4px;">Peso: ${h.peso.toFixed(1)} kg</div>` : ''}
        ${h.sessao ? `<div style="font-size: 0.8rem; color: #78909c; margin-top: 2px;">Sess√£o: ${h.sessao}</div>` : ''}
      </div>
    `).join('');
  }

  if (historicoFecharBtn) {
    historicoFecharBtn.addEventListener('click', () => {
      if (historicoModal) historicoModal.classList.remove('show');
    });
  }

  // Adicionar bot√£o de hist√≥rico ap√≥s confirma√ß√£o (integrado no event listener principal)
  // A funcionalidade de hist√≥rico foi integrada no event listener principal do bot√£o Confirmar

  // ========== INTEGRA√á√ÉO COM BALAN√áA ELETR√îNICA ==========
  let balancaInterval = null;
  let ultimoPesoBalan√ßa = null;

  function iniciarLeituraBalan√ßa() {
    if (balancaInterval) return; // J√° est√° rodando
    
    mostrarToast('Iniciando leitura autom√°tica da balan√ßa...', 'info');
    balancaInterval = setInterval(async () => {
      try {
        // Simula leitura da balan√ßa (em produ√ß√£o, isso viria de WebSocket ou Serial)
        // Por enquanto, apenas verifica se h√° peso novo via API
        const resp = await fetch(`/propriedade/${propriedadeId}/curral/api/balanca/peso/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            peso: null, // Em produ√ß√£o, aqui viria o peso real da balan√ßa
            codigo_animal: currentAnimalV2 ? (currentAnimalV2.codigo_sisbov || currentAnimalV2.numero_brinco) : null,
            timestamp: new Date().toISOString()
          })
        });
        // Nota: Esta √© uma simula√ß√£o. Em produ√ß√£o, a balan√ßa enviaria o peso via WebSocket ou Serial
      } catch (e) {
        console.error('Erro na leitura da balan√ßa:', e);
      }
    }, 2000); // Verifica a cada 2 segundos
  }

  function pararLeituraBalan√ßa() {
    if (balancaInterval) {
      clearInterval(balancaInterval);
      balancaInterval = null;
      mostrarToast('Leitura da balan√ßa interrompida.', 'info');
    }
  }

  // Fun√ß√£o para receber peso da balan√ßa (chamada externamente ou via WebSocket)
  window.receberPesoBalan√ßa = function(peso, codigoAnimal) {
    if (!peso || peso <= 0) return;
    
    ultimoPesoBalan√ßa = peso;
    atualizarPesoV2(peso);
    
    // Se houver animal identificado, pode registrar automaticamente
    if (currentAnimalV2 && codigoAnimal) {
      const codigoLimpo = codigoAnimal.replace(/\D/g, '');
      const animalCodigo = (currentAnimalV2.codigo_sisbov || currentAnimalV2.numero_brinco || '').replace(/\D/g, '');
      if (codigoLimpo === animalCodigo) {
        // Auto-registra se o c√≥digo corresponder
        setTimeout(() => {
          registrarPesagemV2(peso);
        }, 500);
      }
    }
  };

  // Adicionar bot√£o para iniciar/parar leitura da balan√ßa
  const pesoDisplayButtons = document.querySelector('.peso-display-v2-buttons');
  if (pesoDisplayButtons) {
    const btnBalan√ßa = document.createElement('button');
    btnBalan√ßa.type = 'button';
    btnBalan√ßa.className = 'btn btn-sm btn-outline-light';
    btnBalan√ßa.id = 'btnBalan√ßaV2';
    btnBalan√ßa.innerHTML = '<i class="fas fa-plug"></i> Conectar Balan√ßa';
    btnBalan√ßa.onclick = () => {
      if (balancaInterval) {
        pararLeituraBalan√ßa();
        btnBalan√ßa.innerHTML = '<i class="fas fa-plug"></i> Conectar Balan√ßa';
      } else {
        iniciarLeituraBalan√ßa();
        btnBalan√ßa.innerHTML = '<i class="fas fa-stop"></i> Desconectar';
      }
    };
    pesoDisplayButtons.appendChild(btnBalan√ßa);
  }

  // Adiciona classe no body para esconder sidebar (p√°gina fullscreen)
  document.body.classList.add('no-sidebar');

  // ==================== FUN√á√ïES PARA ABA SANIDADE ====================
  
  window.adicionarVacinaV2 = function() {
    const nome = prompt('Nome da vacina:');
    if (!nome) return;
    
    const lista = document.getElementById('listaVacinasV2');
    const item = document.createElement('div');
    item.className = 'sanidade-item';
    item.innerHTML = `
      <div class="sanidade-item-info">
        <div class="sanidade-item-nome">${nome}</div>
        <div class="sanidade-item-detalhes">Aplicar em todos os animais</div>
      </div>
      <div class="sanidade-item-acoes">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerVacinaV2(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    lista.appendChild(item);
    mostrarToast('Vacina adicionada ao plano', 'success');
  };

  window.removerVacinaV2 = function(btn) {
    if (confirm('Remover esta vacina do plano?')) {
      btn.closest('.sanidade-item').remove();
      mostrarToast('Vacina removida', 'info');
    }
  };

  window.adicionarMedicamentoV2 = function() {
    const nome = prompt('Nome do medicamento/tratamento:');
    if (!nome) return;
    
    const lista = document.getElementById('listaMedicamentosV2');
    const item = document.createElement('div');
    item.className = 'sanidade-item';
    item.innerHTML = `
      <div class="sanidade-item-info">
        <div class="sanidade-item-nome">${nome}</div>
        <div class="sanidade-item-detalhes">Aplicar conforme protocolo</div>
      </div>
      <div class="sanidade-item-acoes">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMedicamentoV2(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    lista.appendChild(item);
    mostrarToast('Medicamento adicionado ao plano', 'success');
  };

  window.removerMedicamentoV2 = function(btn) {
    if (confirm('Remover este medicamento do plano?')) {
      btn.closest('.sanidade-item').remove();
      mostrarToast('Medicamento removido', 'info');
    }
  };

  window.aplicarVacinaRapidaV2 = function(tipo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    const vacinas = {
      'aftosa': 'Vacina Aftosa',
      'brucelose': 'Vacina Brucelose'
    };
    
    registrarEventoSanidadeV2('VACINACAO', vacinas[tipo] || tipo);
  };

  window.aplicarMedicamentoRapidoV2 = function(tipo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    const medicamentos = {
      'vermifugo': 'Verm√≠fugo',
      'antibiotico': 'Antibi√≥tico'
    };
    
    registrarEventoSanidadeV2('TRATAMENTO', medicamentos[tipo] || tipo);
  };

  async function registrarEventoSanidadeV2(tipoEvento, descricao) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    try {
      const url = registrarUrl;
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          animal_id: currentAnimalV2.id,
          tipo_evento: tipoEvento,
          observacoes: descricao
        })
      });
      
      if (resp.ok) {
        mostrarToast(`${descricao} registrado com sucesso`, 'success');
      } else {
        mostrarToast('Erro ao registrar evento', 'error');
      }
    } catch (e) {
      console.error('Erro ao registrar evento de sanidade:', e);
      mostrarToast('Erro ao registrar evento', 'error');
    }
  }

  // ==================== FUN√á√ïES PARA ABA REPRODUTIVO ====================
  
  window.adicionarProtocoloIATFV2 = function() {
    mostrarToast('Configure protocolos IATF em Pecu√°ria > Reprodutivo', 'info');
  };

  window.aplicarProtocoloIATFV2 = function(protocoloId) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    if (confirm('Aplicar este protocolo IATF ao animal identificado?')) {
      mostrarToast('Protocolo IATF aplicado', 'success');
    }
  };

  window.registrarDiagnosticoV2 = function(tipo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    const diagnosticos = {
      'prenha': 'Prenha',
      'vazia': 'Vazia',
      'aborto': 'Aborto',
      'repeticao': 'Repeti√ß√£o'
    };
    
    if (confirm(`Registrar diagn√≥stico: ${diagnosticos[tipo]}?`)) {
      mostrarToast(`Diagn√≥stico ${diagnosticos[tipo]} registrado`, 'success');
    }
  };

  window.abrirManejoReprodutivoV2 = function(manejoId, titulo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    mostrarToast(`Abrindo manejo: ${titulo}`, 'info');
  };

  // ==================== FUN√á√ïES PARA ABA MOVIMENTA√á√ÉO ====================
  
  window.aplicarMovimentacaoV2 = function() {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    const loteOrigem = document.getElementById('loteOrigemV2')?.value || '';
    const loteDestino = document.getElementById('loteDestinoV2')?.value || '';
    const motivo = document.getElementById('motivoMovimentacaoV2')?.value || '';
    
    if (!loteDestino) {
      mostrarToast('Selecione um lote de destino', 'warning');
      return;
    }
    
    if (confirm('Aplicar esta movimenta√ß√£o ao animal identificado?')) {
      registrarMovimentacaoV2(loteOrigem, loteDestino, motivo);
    }
  };

  async function registrarMovimentacaoV2(loteOrigem, loteDestino, motivo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    try {
      const url = registrarUrl;
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          animal_id: currentAnimalV2.id,
          tipo_evento: 'APARTACAO',
          lote_origem_id: loteOrigem || null,
          lote_destino_id: loteDestino,
          observacoes: motivo || 'Movimenta√ß√£o autom√°tica'
        })
      });
      
      if (resp.ok) {
        mostrarToast('Movimenta√ß√£o registrada com sucesso', 'success');
        adicionarMovimentacaoHistoricoV2(loteDestino, motivo);
        const origemEl = document.getElementById('loteOrigemV2');
        const destinoEl = document.getElementById('loteDestinoV2');
        const motivoEl = document.getElementById('motivoMovimentacaoV2');
        if (origemEl) origemEl.value = '';
        if (destinoEl) destinoEl.value = '';
        if (motivoEl) motivoEl.value = '';
      } else {
        mostrarToast('Erro ao registrar movimenta√ß√£o', 'error');
      }
    } catch (e) {
      console.error('Erro ao registrar movimenta√ß√£o:', e);
      mostrarToast('Erro ao registrar movimenta√ß√£o', 'error');
    }
  }

  window.movimentacaoRapidaV2 = function(tipo) {
    if (!currentAnimalV2 || !currentAnimalV2.id) {
      mostrarToast('Identifique um animal primeiro', 'warning');
      return;
    }
    
    const tipos = {
      'apartar': 'Aparta√ß√£o',
      'loteamento': 'Loteamento',
      'pasto': 'Mudan√ßa de Pasto',
      'curral': 'Para o Curral'
    };
    
    if (confirm(`Aplicar ${tipos[tipo]} ao animal identificado?`)) {
      mostrarToast(`${tipos[tipo]} aplicado`, 'success');
    }
  };

  function adicionarMovimentacaoHistoricoV2(loteDestino, motivo) {
    const historico = document.getElementById('historicoMovimentacoesV2');
    if (!historico) return;
    
    if (historico.querySelector('.text-center')) {
      historico.innerHTML = '';
    }
    
    const item = document.createElement('div');
    item.className = 'movimentacao-historico-item';
    const agora = new Date();
    const dataFormatada = agora.toLocaleString('pt-BR', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    item.innerHTML = `
      <div class="movimentacao-historico-info">
        <div class="movimentacao-historico-data">${dataFormatada}</div>
        <div class="movimentacao-historico-desc">Movimentado para lote ${loteDestino}${motivo ? ' - ' + motivo : ''}</div>
      </div>
    `;
    
    historico.insertBefore(item, historico.firstChild);
  }

  // ========== GERENCIAMENTO DE ANIMAIS TRABALHADOS ==========
  // Tornar vari√°vel global para acesso de qualquer lugar
  if (typeof window.animaisTrabalhados === 'undefined') {
    window.animaisTrabalhados = [];
  }
  let animaisTrabalhados = window.animaisTrabalhados;

  // Tornar fun√ß√£o global para acesso antes do DOMContentLoaded
  window.adicionarAnimalTrabalhado = function(dados) {
    if (!window.animaisTrabalhados) {
      window.animaisTrabalhados = [];
    }
    window.animaisTrabalhados.unshift(dados);
    animaisTrabalhados = window.animaisTrabalhados;
    
    // Atualizar estat√≠sticas: incrementar processados
    if (window.estatisticasAnimais) {
      window.estatisticasAnimais.processados++;
      window.atualizarEstatisticasAnimais();
    }
    
    // Atualizar lista se o DOM estiver pronto
    if (document.readyState === 'loading') {
      // Se ainda estiver carregando, aguardar DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof window.atualizarListaAnimaisTrabalhados === 'function') {
          window.atualizarListaAnimaisTrabalhados();
        }
      });
    } else {
      // DOM j√° est√° pronto, atualizar imediatamente
      if (typeof window.atualizarListaAnimaisTrabalhados === 'function') {
        window.atualizarListaAnimaisTrabalhados();
      }
    }
  };

  // Tornar fun√ß√£o global para acesso antes do DOMContentLoaded
  window.atualizarListaAnimaisTrabalhados = function() {
    // Usar a vari√°vel global
    if (!window.animaisTrabalhados) {
      window.animaisTrabalhados = [];
    }
    animaisTrabalhados = window.animaisTrabalhados;
    const lista = document.getElementById('animaisTrabalhadosLista');
    if (!lista) return;

    if (!animaisTrabalhados || animaisTrabalhados.length === 0) {
      lista.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="fas fa-cow" style="font-size: 2rem; opacity: 0.3;"></i>
          <p class="mt-2 mb-0">Nenhum animal trabalhado ainda</p>
          <small>Os animais processados aparecer√£o aqui</small>
        </div>
      `;
      return;
    }

    // Ordenar em ordem reversa (√∫ltimo primeiro) e limitar a 50 itens
    const animaisOrdenados = [...animaisTrabalhados].reverse().slice(0, 50);
    
    let html = '';
    animaisOrdenados.forEach((animal, index) => {
      const tipoIcon = animal.tipo === 'pesagem' ? 'fa-weight' : 
                      animal.tipo === 'sanidade' ? 'fa-syringe' : 
                      animal.tipo === 'reprodutivo' ? 'fa-baby-carriage' : 
                      animal.tipo === 'aparte' ? 'fa-layer-group' : 'fa-cow';
      const tipoClass = animal.tipo || 'pesagem';
      
      // Escapar caracteres especiais para evitar problemas no onclick
      const brincoEscapado = (animal.sisbov || animal.brinco || 'N/A').replace(/'/g, "\\'");
      
      html += `
        <div class="animal-trabalhado-item">
          <div class="animal-trabalhado-icon ${tipoClass}">
            <i class="fas ${tipoIcon}"></i>
          </div>
          <div class="animal-trabalhado-info">
            <div class="animal-trabalhado-brinco">${animal.brinco || animal.sisbov || 'N/A'}</div>
            <div class="animal-trabalhado-detalhes">${animal.detalhes || ''}</div>
            ${animal.data ? `<div class="animal-trabalhado-data" style="font-size: 0.7rem; color: #666; margin-top: 2px;">${animal.data}</div>` : ''}
          </div>
          ${animal.peso ? `<div class="animal-trabalhado-peso">${animal.peso} kg</div>` : ''}
          <div class="animal-trabalhado-acoes">
            <button class="btn-animal-trabalhado" onclick="buscarAnimalTrabalhado('${brincoEscapado}')" title="Ver detalhes">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      `;
    });

    lista.innerHTML = html;
    
    // Atualizar estat√≠sticas de animais trabalhados
    const totalEl = document.getElementById('totalAnimaisTrabalhados');
    const quantidadeEl = document.getElementById('quantidadeAnimaisTrabalhados');
    
    if (totalEl) {
      totalEl.textContent = animaisTrabalhados.length;
    }
    if (quantidadeEl) {
      quantidadeEl.textContent = animaisTrabalhados.length;
    }
  }

  // ========== GERENCIAMENTO DE MANEJOS SELECIONADOS ==========
  // Armazenar manejos selecionados
  window.manejosSelecionadosCards = window.manejosSelecionadosCards || [];
  
  // Restaurar manejos do localStorage ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const manejosSalvos = localStorage.getItem('monpecManejosTrabalho');
      if (manejosSalvos) {
        const manejosDetalhados = JSON.parse(manejosSalvos);
        console.log('üìã Restaurando manejos detalhados do localStorage:', manejosDetalhados);
        
        // Aguardar um pouco para garantir que as fun√ß√µes estejam dispon√≠veis
        setTimeout(() => {
          manejosDetalhados.forEach(manejo => {
            if (manejo.categoria && manejo.tipo) {
              // Usar categoria_tipo como identificador √∫nico
              const cardId = `${manejo.categoria}_${manejo.tipo}`;
              const titulo = manejo.nome || manejo.titulo || manejo.tipo;
              const descricao = manejo.descricao || '';
              
              if (typeof window.adicionarCardManejoSelecionado === 'function') {
                window.adicionarCardManejoSelecionado(cardId, titulo, descricao);
              }
            }
          });
          
          // Limpar localStorage ap√≥s restaurar
          localStorage.removeItem('monpecManejosTrabalho');
        }, 500);
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao restaurar manejos do localStorage:', e);
    }
  });
  
  // Adicionar card de manejo selecionado (agrupado por categoria)
  window.adicionarCardManejoSelecionado = function(tipo, titulo, descricao) {
    console.log('üìã Adicionando card de manejo:', { tipo, titulo, descricao });
    
    const listaContainer = document.getElementById('listaManejosSelecionados');
    const emptyState = document.getElementById('emptyStateManejosSelecionados');
    
    if (!listaContainer) {
      console.error('‚ùå Container listaManejosSelecionados n√£o encontrado!');
      return;
    }
    
    // Determinar categoria baseado no tipo
    let categoria = 'pesagem';
    let categoriaNome = 'Pesagem';
    let iconClass = 'fas fa-weight';
    
    if (tipo.includes('VACINACAO') || tipo.includes('sanidade') || tipo.includes('SANIDADE')) {
      categoria = 'sanidade';
      categoriaNome = 'Sanidade';
      iconClass = 'fas fa-syringe';
    } else if (tipo.includes('REPRODUCAO') || tipo.includes('reprodutivo') || tipo.includes('IATF') || tipo.includes('DIAGNOSTICO') || tipo.includes('REPRODUTIVO')) {
      categoria = 'reprodutivo';
      categoriaNome = 'Reprodutivo';
      iconClass = 'fas fa-baby-carriage';
    } else if (tipo.includes('MOVIMENTACAO') || tipo.includes('movimentacao') || tipo.includes('ENTRADA') || tipo.includes('SAIDA') || tipo.includes('APARTACAO')) {
      categoria = 'movimentacao';
      categoriaNome = 'Movimenta√ß√£o';
      iconClass = 'fas fa-exchange-alt';
    } else if (tipo.includes('PESAGEM') || tipo.includes('pesagem')) {
      categoria = 'pesagem';
      categoriaNome = 'Pesagem';
      iconClass = 'fas fa-weight';
    }
    
    // Esconder empty state
    if (emptyState) {
      emptyState.style.display = 'none';
    }
    
    // Verificar se j√° existe card de categoria
    const categoriaCardId = `manejo-categoria-${categoria}`;
    let categoriaCard = document.getElementById(categoriaCardId);
    
    if (!categoriaCard) {
      // Criar card de categoria
      categoriaCard = document.createElement('div');
      categoriaCard.id = categoriaCardId;
      categoriaCard.className = `manejo-categoria-card ${categoria}`;
      
      categoriaCard.innerHTML = `
        <div class="manejo-categoria-header" onclick="event.stopPropagation(); toggleCategoriaCard('${categoria}')">
          <div class="manejo-categoria-icon ${categoria}">
            <i class="${iconClass}"></i>
          </div>
          <div class="manejo-categoria-title">${categoriaNome}</div>
          <div class="manejo-categoria-count" id="count-${categoria}">0</div>
          <i class="fas fa-chevron-down ms-auto" style="font-size: 0.8rem; color: #78909c;"></i>
        </div>
        <div class="manejo-categoria-body" id="body-${categoria}">
          <!-- Tipos espec√≠ficos ser√£o adicionados aqui -->
        </div>
      `;
      
      // Adicionar ao container ANTES do empty state
      if (emptyState && emptyState.parentNode === listaContainer && emptyState.style.display !== 'none') {
        listaContainer.insertBefore(categoriaCard, emptyState);
      } else {
        listaContainer.appendChild(categoriaCard);
      }
      
      // Expandir automaticamente
      categoriaCard.classList.add('expandido');
    }
    
    // Verificar se o tipo espec√≠fico j√° existe dentro da categoria
    const tipoItemId = `manejo-tipo-${categoria}-${tipo.replace(/[^a-zA-Z0-9]/g, '-')}`;
    const tipoItemExistente = document.getElementById(tipoItemId);
    
    if (tipoItemExistente) {
      console.log('‚ÑπÔ∏è Tipo j√° existe na categoria, atualizando...');
      const nomeEl = tipoItemExistente.querySelector('.manejo-tipo-item-nome');
      if (nomeEl) nomeEl.textContent = titulo;
      return;
    }
    
    // Criar item de tipo espec√≠fico
    const tipoItem = document.createElement('div');
    tipoItem.id = tipoItemId;
    tipoItem.className = 'manejo-tipo-item';
    tipoItem.setAttribute('data-categoria', categoria);
    tipoItem.setAttribute('data-tipo', tipo);
    
    tipoItem.innerHTML = `
      <div class="manejo-tipo-item-nome">${titulo}</div>
      <div class="manejo-tipo-item-acoes">
        <button type="button" class="manejo-tipo-item-btn" onclick="event.stopPropagation(); abrirModalConfiguracaoManejo('${categoria}', '${tipo}', '${titulo}')" title="Configurar">
          <i class="fas fa-cog"></i>
        </button>
        <button type="button" class="manejo-tipo-item-remover" onclick="event.stopPropagation(); removerTipoManejo('${categoria}', '${tipo}')" title="Remover">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    
    // Adicionar evento de clique para abrir configura√ß√£o
    tipoItem.addEventListener('click', function(e) {
      if (!e.target.closest('.manejo-tipo-item-acoes')) {
        abrirModalConfiguracaoManejo(categoria, tipo, titulo);
      }
    });
    
    // Adicionar ao body da categoria
    const categoriaBody = categoriaCard.querySelector(`#body-${categoria}`);
    if (categoriaBody) {
      categoriaBody.appendChild(tipoItem);
    }
    
    // Atualizar contador
    const countEl = categoriaCard.querySelector(`#count-${categoria}`);
    if (countEl) {
      const tipos = categoriaBody.querySelectorAll('.manejo-tipo-item').length;
      countEl.textContent = tipos;
    }
    
    // Adicionar ao array de controle
    if (!window.manejosSelecionadosCards) {
      window.manejosSelecionadosCards = [];
    }
    
    // Verificar se j√° existe no array
    const existente = window.manejosSelecionadosCards.find(c => c.cardId === tipoItemId);
    if (!existente) {
      window.manejosSelecionadosCards.push({
        categoria: categoria,
        tipo: tipo,
        titulo: titulo,
        descricao: descricao,
        cardId: tipoItemId,
        categoriaCardId: categoriaCardId
      });
    }
    
    console.log('‚úÖ Tipo de manejo adicionado √† categoria:', { categoria, tipo, titulo });
  };
  
  // Toggle expandir/colapsar card de categoria
  window.toggleCategoriaCard = function(categoria) {
    const categoriaCard = document.getElementById(`manejo-categoria-${categoria}`);
    if (categoriaCard) {
      categoriaCard.classList.toggle('expandido');
      const chevron = categoriaCard.querySelector('.fa-chevron-down, .fa-chevron-up');
      if (chevron) {
        chevron.classList.toggle('fa-chevron-down');
        chevron.classList.toggle('fa-chevron-up');
      }
    }
  };
  
  // Remover tipo espec√≠fico de manejo
  window.removerTipoManejo = function(categoria, tipo) {
    if (!confirm(`Remover "${tipo}" da categoria ${categoria}?`)) {
      return;
    }
    
    const tipoItemId = `manejo-tipo-${categoria}-${tipo.replace(/[^a-zA-Z0-9]/g, '-')}`;
    const tipoItem = document.getElementById(tipoItemId);
    
    if (tipoItem) {
      tipoItem.remove();
      
      // Atualizar contador
      const categoriaCard = document.getElementById(`manejo-categoria-${categoria}`);
      if (categoriaCard) {
        const categoriaBody = categoriaCard.querySelector(`#body-${categoria}`);
        const countEl = categoriaCard.querySelector(`#count-${categoria}`);
        
        if (categoriaBody && countEl) {
          const tipos = categoriaBody.querySelectorAll('.manejo-tipo-item').length;
          countEl.textContent = tipos;
          
          // Se n√£o houver mais tipos, remover card de categoria
          if (tipos === 0) {
            categoriaCard.remove();
          }
        }
      }
      
      // Remover do array
      window.manejosSelecionadosCards = window.manejosSelecionadosCards.filter(c => c.cardId !== tipoItemId);
      
      console.log('‚úÖ Tipo de manejo removido:', { categoria, tipo });
    }
  };
  
  // Abrir modal de configura√ß√£o de manejo espec√≠fico
  window.abrirModalConfiguracaoManejo = function(categoria, tipo, titulo) {
    console.log('‚öôÔ∏è Abrindo configura√ß√£o de manejo:', { categoria, tipo, titulo });
    // TODO: Implementar modal de configura√ß√£o
    mostrarToast(`Configura√ß√£o de ${titulo} - Em desenvolvimento`, 'info');
  };
  
  // Remover card de manejo selecionado (compatibilidade com c√≥digo antigo)
  window.removerCardManejoSelecionado = function(tipo) {
    console.log('üóëÔ∏è Removendo card de manejo:', tipo);
    
    // Determinar categoria
    let categoria = 'pesagem';
    if (tipo.includes('VACINACAO') || tipo.includes('sanidade') || tipo.includes('SANIDADE')) {
      categoria = 'sanidade';
    } else if (tipo.includes('REPRODUCAO') || tipo.includes('reprodutivo') || tipo.includes('IATF') || tipo.includes('DIAGNOSTICO') || tipo.includes('REPRODUTIVO')) {
      categoria = 'reprodutivo';
    } else if (tipo.includes('MOVIMENTACAO') || tipo.includes('movimentacao') || tipo.includes('ENTRADA') || tipo.includes('SAIDA') || tipo.includes('APARTACAO')) {
      categoria = 'movimentacao';
    }
    
    // Remover tipo espec√≠fico
    removerTipoManejo(categoria, tipo);
    
    console.log('‚úÖ Card de manejo removido:', tipo);
  };
  
  // Limpar todos os cards de manejos selecionados
  window.limparManejosSelecionados = function() {
    if (confirm('Limpar todos os manejos selecionados?')) {
      console.log('üßπ Limpando todos os cards de manejos...');
      
      const listaContainer = document.getElementById('listaManejosSelecionados');
      const emptyState = document.getElementById('emptyStateManejosSelecionados');
      
      if (listaContainer) {
        // Remover todos os cards de categoria
        const categoriaCards = listaContainer.querySelectorAll('.manejo-categoria-card');
        categoriaCards.forEach(card => card.remove());
        
        if (emptyState) {
          emptyState.style.display = 'block';
        }
      }
      
      window.manejosSelecionadosCards = [];
      localStorage.removeItem('monpecManejosTrabalho');
      console.log('‚úÖ Todos os cards de manejos foram limpos');
    }
  };
  
  // Aplicar manejo para o animal atual
  window.aplicarManejoParaAnimal = function(tipoManejo, tituloManejo) {
    console.log('üéØ Aplicando manejo para animal atual:', { tipoManejo, tituloManejo });
    
    // Verificar se h√° um animal atual identificado
    if (!window.animalAtualV2 || !window.animalAtualV2.id) {
      alert('Por favor, identifique um animal primeiro antes de aplicar o manejo.');
      return;
    }
    
    const animalId = window.animalAtualV2.id;
    const animalBrinco = window.animalAtualV2.numero_brinco || 'N/A';
    
    // Confirmar a√ß√£o
    if (!confirm(`Aplicar "${tituloManejo}" para o animal ${animalBrinco}?`)) {
      return;
    }
    
    // Determinar qual aba/tab ativar baseado no tipo de manejo
    let tabParaAtivar = null;
    if (tipoManejo.includes('PESAGEM') || tipoManejo.includes('pesagem')) {
      tabParaAtivar = 'pesagem';
    } else if (tipoManejo.includes('VACINACAO') || tipoManejo.includes('sanidade')) {
      tabParaAtivar = 'sanidade';
    } else if (tipoManejo.includes('REPRODUCAO') || tipoManejo.includes('reprodutivo') || tipoManejo.includes('IATF') || tipoManejo.includes('DIAGNOSTICO')) {
      tabParaAtivar = 'reprodutivo';
    } else if (tipoManejo.includes('MOVIMENTACAO') || tipoManejo.includes('movimentacao')) {
      tabParaAtivar = 'movimentacao';
    }
    
    // Ativar a aba correspondente
    if (tabParaAtivar) {
      const tabButton = document.querySelector(`button[data-bs-target="#${tabParaAtivar}"]`);
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
        console.log(`‚úÖ Aba ${tabParaAtivar} ativada`);
      }
    }
    
    // Mostrar mensagem de sucesso
    alert(`Manejo "${tituloManejo}" ser√° aplicado para o animal ${animalBrinco}.\n\nConfigure os detalhes na aba correspondente e grave o registro.`);
  };
  
  // Configurar manejo espec√≠fico
  window.configurarManejoEspecifico = function(tipoManejo, tituloManejo) {
    console.log('‚öôÔ∏è Configurando manejo espec√≠fico:', { tipoManejo, tituloManejo });
    
    // Criar modal de configura√ß√£o
    const modalHtml = `
      <div class="modal fade" id="modalConfigurarManejo" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">
                <i class="fas fa-cog"></i> Configurar: ${tituloManejo}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Aplicar para:</label>
                <select class="form-select" id="configAplicarPara">
                  <option value="animal_atual">Animal Atual (${window.animalAtualV2?.numero_brinco || 'Nenhum identificado'})</option>
                  <option value="todos_animais">Todos os animais do trabalho</option>
                  <option value="lote_especifico">Lote espec√≠fico</option>
                  <option value="categoria_especifica">Categoria espec√≠fica</option>
                </select>
              </div>
              <div class="mb-3" id="configLoteContainer" style="display: none;">
                <label class="form-label">Selecione o lote:</label>
                <select class="form-select" id="configLote">
                  <option value="">Selecione um lote...</option>
                </select>
              </div>
              <div class="mb-3" id="configCategoriaContainer" style="display: none;">
                <label class="form-label">Selecione a categoria:</label>
                <select class="form-select" id="configCategoria">
                  <option value="">Selecione uma categoria...</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Observa√ß√µes:</label>
                <textarea class="form-control" id="configObservacoes" rows="3" placeholder="Observa√ß√µes adicionais para este manejo..."></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="salvarConfiguracaoManejo('${tipoManejo}', '${tituloManejo}')">
                <i class="fas fa-save"></i> Salvar Configura√ß√£o
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remover modal anterior se existir
    const modalAnterior = document.getElementById('modalConfigurarManejo');
    if (modalAnterior) {
      modalAnterior.remove();
    }
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalConfigurarManejo'));
    modal.show();
    
    // Gerenciar campos din√¢micos
    const aplicarParaSelect = document.getElementById('configAplicarPara');
    if (aplicarParaSelect) {
      aplicarParaSelect.addEventListener('change', function() {
        const loteContainer = document.getElementById('configLoteContainer');
        const categoriaContainer = document.getElementById('configCategoriaContainer');
        
        if (loteContainer) loteContainer.style.display = this.value === 'lote_especifico' ? 'block' : 'none';
        if (categoriaContainer) categoriaContainer.style.display = this.value === 'categoria_especifica' ? 'block' : 'none';
      });
    }
  };
  
  // Salvar configura√ß√£o do manejo
  window.salvarConfiguracaoManejo = function(tipoManejo, tituloManejo) {
    const aplicarPara = document.getElementById('configAplicarPara')?.value;
    const observacoes = document.getElementById('configObservacoes')?.value || '';
    
    console.log('üíæ Salvando configura√ß√£o:', { tipoManejo, tituloManejo, aplicarPara, observacoes });
    
    // Aqui voc√™ pode salvar a configura√ß√£o no localStorage ou enviar para o backend
    const configuracao = {
      tipoManejo: tipoManejo,
      tituloManejo: tituloManejo,
      aplicarPara: aplicarPara,
      observacoes: observacoes,
      lote: document.getElementById('configLote')?.value || null,
      categoria: document.getElementById('configCategoria')?.value || null
    };
    
    // Salvar no localStorage
    try {
      const configs = JSON.parse(localStorage.getItem('monpecConfigManejos') || '{}');
      configs[tipoManejo] = configuracao;
      localStorage.setItem('monpecConfigManejos', JSON.stringify(configs));
    } catch (e) {
      console.error('Erro ao salvar configura√ß√£o:', e);
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfigurarManejo'));
    if (modal) {
      modal.hide();
    }
    
    alert('Configura√ß√£o salva com sucesso!');
  };
  
  // Atualizar cards de manejos baseado nas configura√ß√µes (compatibilidade com c√≥digo antigo)
  window.atualizarCardsManejosSelecionados = function() {
    console.log('üîÑ Atualizando cards de manejos selecionados...');
    
    // Esta fun√ß√£o agora √© principalmente para compatibilidade
    // Os cards s√£o criados atrav√©s do formul√°rio de cadastro de trabalho
    // Mas ainda podemos verificar configura√ß√µes antigas se necess√°rio
    
    // Verificar tipo de pesagem selecionado
    const pesagemRotina = document.getElementById('pesagemRotinaV2');
    const pesagemAparte = document.getElementById('pesagemAparteV2');
    
    if (pesagemRotina && pesagemRotina.checked) {
      window.adicionarCardManejoSelecionado('PESAGEM_ROTINA', 'Pesagem de Rotina', 'Registra no hist√≥rico do animal');
    } else if (pesagemAparte && pesagemAparte.checked) {
      window.adicionarCardManejoSelecionado('PESAGEM_APARTACAO', 'Pesagem para Aparta√ß√£o', 'Apenas para loteamento/aparta√ß√£o');
    }
    
    // Verificar sanidade selecionada
    const vacinasSelecionadas = document.querySelectorAll('.sanidade-rapida-btn-v2.active, .sanidade-item-v2.active');
    vacinasSelecionadas.forEach(btn => {
      const nome = btn.dataset.nome || btn.textContent.trim();
      const tipo = btn.dataset.id || nome.toUpperCase().replace(/\s+/g, '_');
      window.adicionarCardManejoSelecionado(`VACINACAO_${tipo}`, nome, 'Aplica√ß√£o de vacina');
    });
    
    // Verificar reprodutivo selecionado
    const diagnosticosSelecionados = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2.active');
    diagnosticosSelecionados.forEach(btn => {
      const diagnostico = btn.dataset.diagnostico || btn.textContent.trim();
      window.adicionarCardManejoSelecionado(`REPRODUCAO_${diagnostico}`, diagnostico, 'Manejo reprodutivo');
    });
    
    console.log('‚úÖ Cards de manejos atualizados');
  };
  
  // ========== FUN√á√ïES PARA ACCORDION (ABAS EXPANS√çVEIS) ==========
  // Fun√ß√£o para alternar entre abas
  window.switchTab = function(tabId) {
    console.log('üîÑ Alternando para aba:', tabId);
    
    // Esconder todas as abas
    const allPanes = document.querySelectorAll('.curral-tab-pane');
    allPanes.forEach(pane => {
      pane.classList.remove('active');
      pane.style.display = 'none';
    });
    
    // Remover classe active de todos os bot√µes
    const allButtons = document.querySelectorAll('.curral-tab-btn');
    allButtons.forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Mostrar a aba selecionada
    const selectedPane = document.getElementById(tabId);
    const selectedButton = document.querySelector(`.curral-tab-btn[data-tab="${tabId}"]`);
    
    if (selectedPane) {
      selectedPane.classList.add('active');
      selectedPane.style.display = 'block';
    }
    
    if (selectedButton) {
      selectedButton.classList.add('active');
    }
  };
  
  // ========== FUN√á√ïES PARA TABELA DE ANIMAIS REGISTRADOS ==========
  window.animaisRegistradosTabela = window.animaisRegistradosTabela || [];
  
  // Adicionar animal √† tabela
  window.adicionarAnimalTabelaRegistrados = function(dadosAnimal) {
    console.log('üìã Adicionando animal √† tabela:', dadosAnimal);
    
    if (!dadosAnimal) {
      console.error('‚ùå Dados do animal inv√°lidos:', dadosAnimal);
      return;
    }
    
    // Garantir que o animal tenha um ID v√°lido
    if (!dadosAnimal.id) {
      // Gerar ID √∫nico se n√£o existir
      dadosAnimal.id = dadosAnimal.codigo_sisbov || dadosAnimal.numero_manejo || Date.now() + Math.random() * 1000;
      console.log('‚ö†Ô∏è Animal sem ID, gerando ID √∫nico:', dadosAnimal.id);
    }
    
    // Verificar se o animal j√° est√° na tabela
    const animalExistente = window.animaisRegistradosTabela.find(a => a.id === dadosAnimal.id);
    if (animalExistente) {
      console.log('‚ÑπÔ∏è Animal j√° est√° na tabela, atualizando...');
      // Atualizar dados existentes
      const index = window.animaisRegistradosTabela.indexOf(animalExistente);
      window.animaisRegistradosTabela[index] = { ...animalExistente, ...dadosAnimal };
      if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
        window.atualizarTabelaAnimaisRegistrados();
      } else {
        console.error('‚ùå Fun√ß√£o atualizarTabelaAnimaisRegistrados n√£o encontrada ao atualizar animal existente!');
      }
      return;
    }
    
    // Adicionar novo animal
    window.animaisRegistradosTabela.push({
      id: dadosAnimal.id,
      codigo_eletronico: dadosAnimal.codigo_eletronico || '‚Äî',
      codigo_sisbov: dadosAnimal.codigo_sisbov || dadosAnimal.numero_brinco || '‚Äî',
      numero_manejo: dadosAnimal.numero_manejo || '‚Äî',
      raca: dadosAnimal.raca || '‚Äî',
      sexo: dadosAnimal.sexo || '‚Äî',
      data_nascimento: dadosAnimal.data_nascimento || dadosAnimal.data_nascimento_format || '‚Äî',
      categoria: dadosAnimal.categoria || '‚Äî',
      lote_atual: dadosAnimal.lote_atual || '‚Äî',
      situacao_bnd: dadosAnimal.situacao_bnd || 'NAO_CONFORME',
      data_registro: new Date().toLocaleString('pt-BR')
    });
    
    // Garantir que o array existe
    if (!window.animaisRegistradosTabela) {
      window.animaisRegistradosTabela = [];
      console.log('üìã Array animaisRegistradosTabela inicializado');
    }
    
    // Atualizar tabela visualmente
    if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
      window.atualizarTabelaAnimaisRegistrados();
      console.log('‚úÖ Tabela atualizada. Total de animais na tabela:', window.animaisRegistradosTabela.length);
    } else {
      console.error('‚ùå Fun√ß√£o atualizarTabelaAnimaisRegistrados n√£o encontrada!');
      // Tentar atualizar manualmente como fallback
      const tbody = document.getElementById('tabelaAnimaisRegistradosBody');
      if (tbody && window.animaisRegistradosTabela.length > 0) {
        console.log('üîÑ Tentando atualizar tabela manualmente (fallback)...');
        // Atualiza√ß√£o manual simples
        function calcularIdadeFallback(dataNascimento) {
          if (!dataNascimento || dataNascimento === '‚Äî') return '‚Äî';
          try {
            let dataNasc;
            if (typeof dataNascimento === 'string' && dataNascimento.includes('/')) {
              const partes = dataNascimento.split('/');
              if (partes.length === 3) {
                dataNasc = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
              }
            } else {
              dataNasc = new Date(dataNascimento);
            }
            if (isNaN(dataNasc.getTime())) return '‚Äî';
            const hoje = new Date();
            let anos = hoje.getFullYear() - dataNasc.getFullYear();
            let meses = hoje.getMonth() - dataNasc.getMonth();
            if (meses < 0 || (meses === 0 && hoje.getDate() < dataNasc.getDate())) {
              anos--;
              meses += 12;
            }
            if (anos > 0) return anos + ' ano' + (anos > 1 ? 's' : '');
            if (meses > 0) return meses + ' m√™s' + (meses > 1 ? 'es' : '');
            const dias = Math.floor((hoje - dataNasc) / (1000 * 60 * 60 * 24));
            return dias + ' dia' + (dias > 1 ? 's' : '');
          } catch (e) {
            return '‚Äî';
          }
        }
        
        let html = '';
        window.animaisRegistradosTabela.forEach(animal => {
          const idade = calcularIdadeFallback(animal.data_nascimento);
          html += `
            <tr style="font-size: 0.85rem;">
              <td>${animal.codigo_eletronico || '‚Äî'}</td>
              <td style="color: #2196F3; font-weight: 500;">${animal.codigo_sisbov || '‚Äî'}</td>
              <td style="font-weight: 700;">${animal.numero_manejo || '‚Äî'}</td>
              <td>${animal.raca || '‚Äî'}</td>
              <td>${animal.sexo || '‚Äî'}</td>
              <td>${idade}</td>
              <td style="text-align: center;">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarAnimalRegistrado(${animal.id})" title="Editar" style="margin-right: 4px; padding: 4px 8px;">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirAnimalRegistrado(${animal.id})" title="Excluir" style="padding: 4px 8px;">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        tbody.innerHTML = html;
        console.log('‚úÖ Tabela atualizada manualmente (fallback)');
      }
    }
    
    // Garantir que as estat√≠sticas sejam atualizadas
    if (window.estatisticasAnimais) {
      if (typeof window.atualizarEstatisticasAnimais === 'function') {
        window.atualizarEstatisticasAnimais();
        console.log('‚úÖ Estat√≠sticas atualizadas ap√≥s adicionar √† tabela');
      } else {
        console.error('‚ùå Fun√ß√£o atualizarEstatisticasAnimais n√£o encontrada para atualizar estat√≠sticas!');
        // Atualizar manualmente como fallback
        const stats = window.estatisticasAnimais;
        const total = (stats.identificados || 0) + (stats.cadastrados || 0);
        const totalEl = document.getElementById('statsTotalTrabalhados');
        const identificadosEl = document.getElementById('statsIdentificados');
        const cadastradosEl = document.getElementById('statsCadastrados');
        const processadosEl = document.getElementById('statsProcessados');
        
        if (totalEl) totalEl.textContent = total;
        if (identificadosEl) identificadosEl.textContent = stats.identificados || 0;
        if (cadastradosEl) cadastradosEl.textContent = stats.cadastrados || 0;
        if (processadosEl) processadosEl.textContent = stats.processados || 0;
        
        console.log('‚úÖ Estat√≠sticas atualizadas manualmente (fallback)');
      }
    }
    
    console.log('‚úÖ Animal adicionado √† tabela. Total:', window.animaisRegistradosTabela.length);
    
    // Atualizar progresso da sess√£o
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
  };
  
  // ========== ATUALIZAR PROGRESSO DA SESS√ÉO ==========
  window.atualizarProgressoSessao = function() {
    try {
      // Obter quantidade planejada da sess√£o
      const quantidadePlanejada = {% if sessao_ativa and sessao_ativa.quantidade_esperada %}{{ sessao_ativa.quantidade_esperada }}{% else %}null{% endif %};
      
      // Contar animais trabalhados da tabela
      const animaisTrabalhados = window.animaisRegistradosTabela ? window.animaisRegistradosTabela.length : 0;
      
      // Atualizar valores principais
      const planejadosEl = document.getElementById('progressoPlanejados');
      const trabalhadosEl = document.getElementById('progressoTrabalhados');
      const restantesEl = document.getElementById('progressoRestantes');
      const percentualEl = document.getElementById('progressoPercentual');
      const barFillEl = document.getElementById('progressoBarFill');
      
      if (planejadosEl) {
        planejadosEl.textContent = quantidadePlanejada !== null ? quantidadePlanejada : '‚Äî';
      }
      
      if (trabalhadosEl) {
        trabalhadosEl.textContent = animaisTrabalhados;
      }
      
      if (restantesEl && quantidadePlanejada !== null) {
        const restantes = Math.max(0, quantidadePlanejada - animaisTrabalhados);
        restantesEl.textContent = restantes;
      } else if (restantesEl) {
        restantesEl.textContent = '‚Äî';
      }
      
      // Calcular e atualizar percentual
      let percentual = 0;
      if (quantidadePlanejada !== null && quantidadePlanejada > 0) {
        percentual = Math.min(100, Math.round((animaisTrabalhados / quantidadePlanejada) * 100));
      }
      
      if (percentualEl) {
        percentualEl.textContent = percentual + '%';
      }
      
      if (barFillEl) {
        barFillEl.style.width = percentual + '%';
        if (percentual > 0) {
          barFillEl.textContent = percentual + '%';
        } else {
          barFillEl.textContent = '';
        }
      }
      
      // Calcular estat√≠sticas por sexo
      const sexoMacho = window.animaisRegistradosTabela ? 
        window.animaisRegistradosTabela.filter(a => a.sexo && (a.sexo.toUpperCase().includes('M') || a.sexo.toUpperCase().includes('MACHO'))).length : 0;
      const sexoFemea = window.animaisRegistradosTabela ? 
        window.animaisRegistradosTabela.filter(a => a.sexo && (a.sexo.toUpperCase().includes('F') || a.sexo.toUpperCase().includes('F√äMEA') || a.sexo.toUpperCase().includes('FEMEA'))).length : 0;
      
      const sexoMachoEl = document.getElementById('progressoSexoMacho');
      const sexoFemeaEl = document.getElementById('progressoSexoFemea');
      
      if (sexoMachoEl) sexoMachoEl.textContent = sexoMacho;
      if (sexoFemeaEl) sexoFemeaEl.textContent = sexoFemea;
      
      // Calcular estat√≠sticas por ra√ßa
      const racas = {};
      if (window.animaisRegistradosTabela) {
        window.animaisRegistradosTabela.forEach(animal => {
          const raca = animal.raca || 'N√£o informado';
          racas[raca] = (racas[raca] || 0) + 1;
        });
      }
      
      const racaListaEl = document.getElementById('progressoRacaLista');
      if (racaListaEl) {
        if (Object.keys(racas).length > 0) {
          let html = '';
          Object.entries(racas).sort((a, b) => b[1] - a[1]).forEach(([raca, quantidade]) => {
            html += `<div style="margin-bottom: 4px;"><strong>${raca}:</strong> ${quantidade}</div>`;
          });
          racaListaEl.innerHTML = html;
        } else {
          racaListaEl.textContent = '‚Äî';
        }
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao atualizar progresso da sess√£o:', error);
    }
  };
  
  // Inicializar visibilidade do card de apresenta√ß√£o ao carregar a p√°gina
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        if (typeof window.atualizarProgressoSessao === 'function') {
          window.atualizarProgressoSessao();
        }
      }, 100);
    });
  } else {
    setTimeout(function() {
      if (typeof window.atualizarProgressoSessao === 'function') {
        window.atualizarProgressoSessao();
      }
    }, 100);
  }
  
  // ========== ATUALIZAR TEMPO E ESTIMATIVA ==========
  window.atualizarTempoProgresso = function() {
    try {
      const sessaoInicio = {% if sessao_ativa %}'{{ sessao_ativa.data_inicio|date:"Y-m-d\TH:i:s" }}'{% else %}null{% endif %};
      
      if (!sessaoInicio) {
        const tempoEl = document.getElementById('progressoTempoDecorrido');
        const estimativaEl = document.getElementById('progressoEstimativaTermino');
        const tempoMedioEl = document.getElementById('progressoTempoMedio');
        
        if (tempoEl) tempoEl.textContent = '‚Äî';
        if (estimativaEl) estimativaEl.textContent = '‚Äî';
        if (tempoMedioEl) tempoMedioEl.textContent = '‚Äî';
        return;
      }
      
      const inicio = new Date(sessaoInicio);
      const agora = new Date();
      const diffMs = agora - inicio;
      const diffSegundos = Math.floor(diffMs / 1000);
      const diffMinutos = Math.floor(diffSegundos / 60);
      const horas = Math.floor(diffMinutos / 60);
      const minutos = diffMinutos % 60;
      const segundos = diffSegundos % 60;
      
      // Atualizar tempo decorrido
      const tempoEl = document.getElementById('progressoTempoDecorrido');
      if (tempoEl) {
        tempoEl.textContent = String(horas).padStart(2, '0') + ':' + 
                             String(minutos).padStart(2, '0') + ':' + 
                             String(segundos).padStart(2, '0');
      }
      
      // Calcular tempo m√©dio por animal
      const animaisTrabalhados = window.animaisRegistradosTabela ? window.animaisRegistradosTabela.length : 0;
      const tempoMedioEl = document.getElementById('progressoTempoMedio');
      if (tempoMedioEl) {
        if (animaisTrabalhados > 0) {
          const tempoMedioMinutos = Math.round(diffMinutos / animaisTrabalhados);
          const tempoMedioHoras = Math.floor(tempoMedioMinutos / 60);
          const tempoMedioMin = tempoMedioMinutos % 60;
          if (tempoMedioHoras > 0) {
            tempoMedioEl.textContent = tempoMedioHoras + 'h ' + tempoMedioMin + 'min';
          } else {
            tempoMedioEl.textContent = tempoMedioMinutos + 'min';
          }
        } else {
          tempoMedioEl.textContent = '‚Äî';
        }
      }
      
      // Calcular estimativa de t√©rmino
      const quantidadePlanejada = {% if sessao_ativa and sessao_ativa.quantidade_esperada %}{{ sessao_ativa.quantidade_esperada }}{% else %}null{% endif %};
      const estimativaEl = document.getElementById('progressoEstimativaTermino');
      
      if (estimativaEl && quantidadePlanejada !== null && animaisTrabalhados > 0 && animaisTrabalhados < quantidadePlanejada) {
        const tempoMedioMinutos = diffMinutos / animaisTrabalhados;
        const animaisRestantes = quantidadePlanejada - animaisTrabalhados;
        const minutosRestantes = Math.round(tempoMedioMinutos * animaisRestantes);
        const estimativa = new Date(agora.getTime() + minutosRestantes * 60000);
        
        const estimativaHoras = estimativa.getHours().toString().padStart(2, '0');
        const estimativaMinutos = estimativa.getMinutes().toString().padStart(2, '0');
        estimativaEl.textContent = estimativaHoras + ':' + estimativaMinutos;
      } else if (estimativaEl) {
        if (animaisTrabalhados >= quantidadePlanejada) {
          estimativaEl.textContent = 'Conclu√≠do';
        } else {
          estimativaEl.textContent = '‚Äî';
        }
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao atualizar tempo do progresso:', error);
    }
  };
  
  // Iniciar atualiza√ß√£o de tempo a cada segundo
  if (typeof window.intervalProgressoTempo === 'undefined') {
    window.intervalProgressoTempo = setInterval(function() {
      if (typeof window.atualizarTempoProgresso === 'function') {
        window.atualizarTempoProgresso();
      }
    }, 1000);
  }
  
  // Atualizar progresso quando a p√°gina carregar
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
    if (typeof window.atualizarTempoProgresso === 'function') {
      window.atualizarTempoProgresso();
    }
    // Inicializar estat√≠sticas de pesagem
    if (typeof window.atualizarEstatisticasPesagem === 'function') {
      window.atualizarEstatisticasPesagem();
    }
  });
  
  // ========== FUN√á√ÉO DE TESTE PARA DEBUG ==========
  // Esta fun√ß√£o pode ser chamada manualmente no console para testar
  window.testarAtualizacaoContadores = function() {
    console.log('üß™ ========== TESTE DE ATUALIZA√á√ÉO ==========');
    
    // Verificar se window.estatisticasAnimais existe
    if (!window.estatisticasAnimais) {
      console.error('‚ùå window.estatisticasAnimais n√£o existe!');
      window.estatisticasAnimais = { identificados: 0, cadastrados: 0, processados: 0 };
      console.log('‚úÖ Inicializado window.estatisticasAnimais');
    }
    
    // Incrementar processados para teste
    window.estatisticasAnimais.processados = (window.estatisticasAnimais.processados || 0) + 1;
    console.log('üìä Processados incrementado para:', window.estatisticasAnimais.processados);
    
    // Verificar elementos DOM
    const totalEl = document.getElementById('statsTotalTrabalhados');
    const identificadosEl = document.getElementById('statsIdentificados');
    const cadastradosEl = document.getElementById('statsCadastrados');
    const processadosEl = document.getElementById('statsProcessados');
    
    console.log('üîç Elementos encontrados:', {
      totalEl: !!totalEl,
      identificadosEl: !!identificadosEl,
      cadastradosEl: !!cadastradosEl,
      processadosEl: !!processadosEl
    });
    
    // Tentar atualizar
    if (typeof window.atualizarEstatisticasAnimais === 'function') {
      window.atualizarEstatisticasAnimais();
      console.log('‚úÖ Fun√ß√£o atualizarEstatisticasAnimais chamada');
    } else {
      console.error('‚ùå Fun√ß√£o atualizarEstatisticasAnimais n√£o encontrada!');
    }
    
    // Verificar tabela
    const tbody = document.getElementById('tabelaAnimaisRegistradosBody');
    console.log('üîç Tabela encontrada:', !!tbody);
    console.log('üìã Animais na tabela:', window.animaisRegistradosTabela ? window.animaisRegistradosTabela.length : 0);
    
    if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
      window.atualizarTabelaAnimaisRegistrados();
      console.log('‚úÖ Fun√ß√£o atualizarTabelaAnimaisRegistrados chamada');
    } else {
      console.error('‚ùå Fun√ß√£o atualizarTabelaAnimaisRegistrados n√£o encontrada!');
    }
    
    console.log('üß™ ========== FIM DO TESTE ==========');
  };
  
  // Atualizar tabela visualmente (tornar global)
  window.atualizarTabelaAnimaisRegistrados = function() {
    console.log('üìã [ATUALIZAR TABELA] Iniciando atualiza√ß√£o da tabela...');
    console.log('üìã [ATUALIZAR TABELA] Total de animais na tabela:', window.animaisRegistradosTabela ? window.animaisRegistradosTabela.length : 0);
    
    const tbody = document.getElementById('tabelaAnimaisRegistradosBody');
    if (!tbody) {
      console.error('‚ùå Tbody da tabela (tabelaAnimaisRegistradosBody) n√£o encontrado!');
      console.error('üîç Tentando encontrar elementos similares...');
      const elementosSimilares = document.querySelectorAll('[id*="tabela"], [id*="Tabela"], [id*="animais"], [id*="Animais"]');
      console.log('üìã Elementos encontrados:', Array.from(elementosSimilares).map(el => el.id));
      return;
    }
    
    console.log('‚úÖ Tbody encontrado, atualizando tabela...');
    
    if (window.animaisRegistradosTabela.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            <i class="fas fa-cow" style="font-size: 1.5rem; opacity: 0.3; margin-bottom: 8px;"></i>
            <p style="margin: 0; font-size: 0.85rem;">Nenhum animal registrado ainda</p>
            <small style="color: #78909c;">Os animais processados aparecer√£o aqui</small>
          </td>
        </tr>
      `;
      return;
    }
    
    // Fun√ß√£o para calcular idade
    function calcularIdade(dataNascimento) {
      if (!dataNascimento || dataNascimento === '‚Äî') return '‚Äî';
      
      try {
        // Tentar diferentes formatos de data
        let dataNasc;
        if (typeof dataNascimento === 'string') {
          // Formato brasileiro DD/MM/YYYY
          if (dataNascimento.includes('/')) {
            const partes = dataNascimento.split('/');
            if (partes.length === 3) {
              dataNasc = new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
            }
          } else {
            dataNasc = new Date(dataNascimento);
          }
        } else {
          dataNasc = new Date(dataNascimento);
        }
        
        if (isNaN(dataNasc.getTime())) return '‚Äî';
        
        const hoje = new Date();
        let anos = hoje.getFullYear() - dataNasc.getFullYear();
        let meses = hoje.getMonth() - dataNasc.getMonth();
        
        if (meses < 0 || (meses === 0 && hoje.getDate() < dataNasc.getDate())) {
          anos--;
          meses += 12;
        }
        
        if (anos > 0) {
          return anos + ' ano' + (anos > 1 ? 's' : '');
        } else if (meses > 0) {
          return meses + ' m√™s' + (meses > 1 ? 'es' : '');
        } else {
          const dias = Math.floor((hoje - dataNasc) / (1000 * 60 * 60 * 24));
          return dias + ' dia' + (dias > 1 ? 's' : '');
        }
      } catch (e) {
        return '‚Äî';
      }
    }
    
    let html = '';
    window.animaisRegistradosTabela.forEach((animal, index) => {
      const idade = calcularIdade(animal.data_nascimento);
      
      html += `
        <tr style="font-size: 0.85rem;">
          <td>${animal.codigo_eletronico || '‚Äî'}</td>
          <td style="color: #2196F3; font-weight: 500;">${animal.codigo_sisbov || '‚Äî'}</td>
          <td style="font-weight: 700;">${animal.numero_manejo || '‚Äî'}</td>
          <td>${animal.raca || '‚Äî'}</td>
          <td>${animal.sexo || '‚Äî'}</td>
          <td>${idade}</td>
          <td style="text-align: center;">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarAnimalRegistrado(${animal.id})" title="Editar" style="margin-right: 4px; padding: 4px 8px;">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirAnimalRegistrado(${animal.id})" title="Excluir" style="padding: 4px 8px;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
    console.log('‚úÖ Tabela atualizada com', window.animaisRegistradosTabela.length, 'animais');
  }
  
  // ========== CARREGAR ANIMAIS DA SESS√ÉO AO INICIALIZAR ==========
  window.carregarAnimaisSessao = async function() {
    try {
      // Obter ID da propriedade da URL
      const propriedadeMatch = window.location.pathname.match(/propriedade\/(\d+)/);
      if (!propriedadeMatch) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel identificar a propriedade');
        return;
      }
      const propriedadeId = propriedadeMatch[1];
      
      // Buscar animais da sess√£o ativa
      const url = `/propriedade/${propriedadeId}/curral/api/sessao/animais/`;
      console.log('üìã Carregando animais da sess√£o de:', url);
      
      const response = await fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        console.warn('‚ö†Ô∏è Erro ao carregar animais da sess√£o:', response.status);
        return;
      }
      
      const data = await response.json();
      console.log('üìã Resposta da API de animais da sess√£o:', data);
      
      if (data.status === 'ok' && data.animais && Array.isArray(data.animais)) {
        // Inicializar array se n√£o existir
        if (!window.animaisRegistradosTabela) {
          window.animaisRegistradosTabela = [];
        }
        
        // Adicionar animais da sess√£o (evitar duplicatas)
        const idsExistentes = new Set(window.animaisRegistradosTabela.map(a => a.id));
        let adicionados = 0;
        
        data.animais.forEach(animal => {
          if (!idsExistentes.has(animal.id)) {
            window.animaisRegistradosTabela.push(animal);
            adicionados++;
          }
        });
        
        console.log(`‚úÖ ${adicionados} animais carregados da sess√£o. Total na tabela: ${window.animaisRegistradosTabela.length}`);
        
        // Atualizar tabela visualmente
        if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
          window.atualizarTabelaAnimaisRegistrados();
        }
      } else if (!data.sessao_ativa) {
        console.log('‚ÑπÔ∏è Nenhuma sess√£o ativa encontrada');
      }
    } catch (error) {
      console.error('‚ùå Erro ao carregar animais da sess√£o:', error);
    }
  };
  
  // Carregar animais ao inicializar a p√°gina (com verifica√ß√£o mais robusta)
  function inicializarCarregamentoAnimais() {
    // Verificar se as fun√ß√µes necess√°rias est√£o dispon√≠veis
    if (typeof window.carregarAnimaisSessao !== 'function') {
      console.warn('‚ö†Ô∏è carregarAnimaisSessao n√£o est√° dispon√≠vel ainda, tentando novamente...');
      setTimeout(inicializarCarregamentoAnimais, 500);
      return;
    }
    
    if (!window.animaisRegistradosTabela) {
      window.animaisRegistradosTabela = [];
    }
    
    if (typeof window.atualizarTabelaAnimaisRegistrados !== 'function') {
      console.warn('‚ö†Ô∏è atualizarTabelaAnimaisRegistrados n√£o est√° dispon√≠vel ainda, tentando novamente...');
      setTimeout(inicializarCarregamentoAnimais, 500);
      return;
    }
    
    // Tudo pronto, carregar animais
    window.carregarAnimaisSessao();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(inicializarCarregamentoAnimais, 1500);
    });
  } else {
    // DOM j√° est√° pronto
    setTimeout(inicializarCarregamentoAnimais, 1500);
  }
  
  // ========== FUN√á√ïES DE EDITAR E EXCLUIR ANIMAIS ==========
  window.editarAnimalRegistrado = function(animalId) {
    const animal = window.animaisRegistradosTabela.find(a => a.id === animalId);
    if (!animal) {
      alert('Animal n√£o encontrado!');
      return;
    }
    
    // Preencher o formul√°rio de identifica√ß√£o com os dados do animal
    const brincoInput = document.getElementById('brincoInputV2');
    if (brincoInput) {
      brincoInput.value = animal.codigo_sisbov || animal.codigo_eletronico || '';
      brincoInput.focus();
      
      // Disparar evento de busca
      if (typeof window.buscarBrincoSimples === 'function') {
        setTimeout(() => {
          window.buscarBrincoSimples();
        }, 100);
      }
    }
    
    // Remover o animal da tabela (ser√° readicionado ap√≥s edi√ß√£o)
    window.animaisRegistradosTabela = window.animaisRegistradosTabela.filter(a => a.id !== animalId);
    if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
      window.atualizarTabelaAnimaisRegistrados();
    }
    
    // Atualizar progresso
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
    
    console.log('‚úÖ Animal carregado para edi√ß√£o:', animal);
  };
  
  window.excluirAnimalRegistrado = function(animalId) {
    const animal = window.animaisRegistradosTabela.find(a => a.id === animalId);
    if (!animal) {
      alert('Animal n√£o encontrado!');
      return;
    }
    
    const confirmacao = confirm(`Deseja realmente excluir o animal ${animal.codigo_sisbov || animal.codigo_eletronico || 'ID: ' + animalId} da lista?`);
    if (!confirmacao) {
      return;
    }
    
    // Remover o animal da tabela
    window.animaisRegistradosTabela = window.animaisRegistradosTabela.filter(a => a.id !== animalId);
    
    // Remover pesagens do animal das estat√≠sticas
    if (window.pesagensRegistradas) {
      window.pesagensRegistradas = window.pesagensRegistradas.filter(p => p.animal_id !== animalId);
      // Atualizar estat√≠sticas de pesagem
      if (typeof window.atualizarEstatisticasPesagem === 'function') {
        window.atualizarEstatisticasPesagem();
      }
    }
    
    // Atualizar tabela visualmente
    if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
      window.atualizarTabelaAnimaisRegistrados();
    }
    
    // Atualizar progresso
    if (typeof window.atualizarProgressoSessao === 'function') {
      window.atualizarProgressoSessao();
    }
    
    console.log('‚úÖ Animal exclu√≠do da tabela:', animal);
  };
  
  // Limpar tabela de animais registrados
  window.limparTabelaAnimaisRegistrados = function() {
    if (confirm('Limpar tabela de animais registrados?')) {
      window.animaisRegistradosTabela = [];
      atualizarTabelaAnimaisRegistrados();
      console.log('‚úÖ Tabela de animais registrados limpa');
    }
  };

  window.limparAnimaisTrabalhados = function() {
    if (confirm('Limpar lista de animais trabalhados?')) {
      window.animaisTrabalhados = [];
      animaisTrabalhados = [];
      
      // Limpar estat√≠sticas tamb√©m
      if (window.estatisticasAnimais) {
        window.estatisticasAnimais.identificados = 0;
        window.estatisticasAnimais.cadastrados = 0;
        window.estatisticasAnimais.processados = 0;
        window.atualizarEstatisticasAnimais();
      }
      
      atualizarListaAnimaisTrabalhados();
    }
  };

  function buscarAnimalTrabalhado(codigo) {
    const input = document.getElementById('brincoInputV2');
    if (input) {
      input.value = codigo;
      window.buscarBrincoSimples();
    }
  }

  // ========== SISTEMA DE APARTA√á√ïES ==========
  // Nota: window.apartacoes, window.abrirModalApartacao e window.fecharModalApartacao
  // j√° foram definidos globalmente antes do DOMContentLoaded
  
  // Fun√ß√£o para salvar aparta√ß√µes
  function salvarApartacoes() {
    localStorage.setItem('curral_apartacoes', JSON.stringify(window.apartacoes));
  }
  
  // Adicionar nova aparta√ß√£o
  window.adicionarApartacao = function() {
    const nome = document.getElementById('novaApartacaoNome')?.value.trim();
    const min = parseFloat(document.getElementById('novaApartacaoMin')?.value);
    const max = parseFloat(document.getElementById('novaApartacaoMax')?.value);
    
    if (!nome) {
      mostrarToast('Informe o nome da aparta√ß√£o', 'warning');
      return;
    }
    
    if (isNaN(min) || isNaN(max)) {
      mostrarToast('Informe peso m√≠nimo e m√°ximo v√°lidos', 'warning');
      return;
    }
    
    if (min >= max) {
      mostrarToast('Peso m√°ximo deve ser maior que o m√≠nimo', 'warning');
      return;
    }
    
    const novaApartacao = {
      id: Date.now(),
      nome: nome,
      pesoMin: min,
      pesoMax: max,
      cor: (window.apartacoes.length % 6) + 1 // Cores de 1 a 6
    };
    
    window.apartacoes.push(novaApartacao);
    salvarApartacoes();
    atualizarListaApartacoes();
    
    // Limpar campos
    document.getElementById('novaApartacaoNome').value = '';
    document.getElementById('novaApartacaoMin').value = '';
    document.getElementById('novaApartacaoMax').value = '';
    
    mostrarToast(`Aparta√ß√£o "${nome}" adicionada`, 'success');
  };
  
  // Remover aparta√ß√£o
  window.removerApartacao = function(id) {
    if (confirm('Deseja remover esta aparta√ß√£o?')) {
      window.apartacoes = window.apartacoes.filter(a => a.id !== id);
      salvarApartacoes();
      atualizarListaApartacoes();
      mostrarToast('Aparta√ß√£o removida', 'info');
    }
  };
  
  // Atualizar lista de aparta√ß√µes no modal (dispon√≠vel globalmente)
  window.atualizarListaApartacoes = function() {
    const lista = document.getElementById('listaApartacoesV2');
    if (!lista) return;
    
    if (window.apartacoes.length === 0) {
      lista.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--monpec-text-light);"><i class="fas fa-info-circle"></i> Nenhuma aparta√ß√£o configurada</div>';
      return;
    }
    
    // Ordenar por peso m√≠nimo
    const apartacoesOrdenadas = [...window.apartacoes].sort((a, b) => a.pesoMin - b.pesoMin);
    
    lista.innerHTML = apartacoesOrdenadas.map(ap => `
      <div class="apartacao-item">
        <div class="apartacao-item-info">
          <div class="apartacao-item-nome">${ap.nome}</div>
          <div class="apartacao-item-faixa">${ap.pesoMin} kg - ${ap.pesoMax} kg</div>
        </div>
        <div class="apartacao-item-acoes">
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerApartacao(${ap.id})" title="Remover">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
  };
  
  // Encontrar aparta√ß√£o pelo peso
  window.encontrarApartacao = function(peso) {
    if (!window.apartacoes || window.apartacoes.length === 0) {
      return null;
    }
    
    // Ordenar por peso m√≠nimo (ordem crescente)
    const apartacoesOrdenadas = [...window.apartacoes].sort((a, b) => a.pesoMin - b.pesoMin);
    
    // Encontrar a primeira aparta√ß√£o onde o peso se encaixa
    for (const ap of apartacoesOrdenadas) {
      if (peso >= ap.pesoMin && peso <= ap.pesoMax) {
        return ap;
      }
    }
    
    return null;
  };
  
  // Mostrar popup de indica√ß√£o de aparta√ß√£o
  window.mostrarPopupApartacao = function(nomeApartacao, cor) {
    const popup = document.getElementById('popupApartacaoV2');
    const nomeEl = document.getElementById('popupApartacaoNomeV2');
    
    if (!popup || !nomeEl) return;
    
    // Remover classes de cor anteriores
    popup.className = 'popup-apartacao';
    popup.classList.add(`cor-${cor || 1}`);
    
    nomeEl.textContent = nomeApartacao;
    
    // Mostrar popup
    popup.style.display = 'block';
    setTimeout(() => popup.classList.add('show'), 10);
    
    // Fechar automaticamente ap√≥s 4 segundos e continuar para pr√≥xima rotina
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        
        // Verificar se auto-pr√≥ximo est√° ativo e limpar campos
        const autoProximo = document.getElementById('autoProximoV2');
        if (autoProximo && autoProximo.checked) {
          const brincoInput = document.getElementById('brincoInputV2');
          const pesoInput = document.getElementById('pesoValorV2');
          
          if (brincoInput) {
            brincoInput.value = '';
            brincoInput.focus();
          }
          if (pesoInput) {
            pesoInput.value = '';
          }
          
          // Limpar resumo do animal
          if (typeof atualizarScannerResumoV2 === 'function') {
            atualizarScannerResumoV2({
              brinco: '‚Äî',
              sisbov: '‚Äî',
              numero_manejo: '‚Äî',
              raca_sexo: '‚Äî',
              nascimento: '‚Äî',
              ultimo_peso: '‚Äî'
            });
          }
        }
      }, 300);
    }, 4000);
  };
  
  // ========== FUN√á√ïES PARA CARDS INDICADORES DE MANEJO ==========
  
  // Criar cards indicadores de manejo (dispon√≠vel globalmente)
  window.criarCardsIndicadoresManejo = function() {
    const container = document.getElementById('manejoIndicadoresContainer');
    if (!container) return;

    const indicadores = [
      {
        id: 'indicador-pesagem-rotina',
        tipo: 'rotina',
        icon: 'fas fa-history',
        texto: 'Pesagem de Rotina',
        descricao: 'Criando hist√≥rico'
      },
      {
        id: 'indicador-pesagem-aparte',
        tipo: 'aparte',
        icon: 'fas fa-layer-group',
        texto: 'Pesagem para Aparta√ß√£o',
        descricao: 'Apenas loteamento'
      },
      {
        id: 'indicador-sanidade',
        tipo: 'sanidade',
        icon: 'fas fa-syringe',
        texto: 'Sanidade',
        descricao: 'Vacinas/Medicamentos'
      },
      {
        id: 'indicador-reprodutivo',
        tipo: 'reprodutivo',
        icon: 'fas fa-baby-carriage',
        texto: 'Reprodutivo',
        descricao: 'Insemina√ß√£o/Cobri√ß√£o'
      },
      {
        id: 'indicador-movimentacao',
        tipo: 'movimentacao',
        icon: 'fas fa-exchange-alt',
        texto: 'Movimenta√ß√£o',
        descricao: 'Entrada/Sa√≠da'
      }
    ];

    container.innerHTML = '';
    
    indicadores.forEach(ind => {
      const card = document.createElement('div');
      card.id = ind.id;
      card.className = `manejo-indicador-card ${ind.tipo}`;
      card.innerHTML = `
        <i class="${ind.icon}"></i>
        <span>${ind.texto}</span>
        <small style="opacity: 0.7; margin-left: 4px;">${ind.descricao}</small>
      `;
      container.appendChild(card);
    });
  }

  // Atualizar card indicador de pesagem (dispon√≠vel globalmente)
  window.atualizarIndicadorPesagem = function(tipo) {
    const indicadorRotina = document.getElementById('indicador-pesagem-rotina');
    const indicadorAparte = document.getElementById('indicador-pesagem-aparte');
    
    if (tipo === 'rotina') {
      if (indicadorRotina) indicadorRotina.classList.add('ativo');
      if (indicadorAparte) indicadorAparte.classList.remove('ativo');
    } else if (tipo === 'aparte') {
      if (indicadorAparte) indicadorAparte.classList.add('ativo');
      if (indicadorRotina) indicadorRotina.classList.remove('ativo');
    }
  }

  // Atualizar indicador de sanidade (dispon√≠vel globalmente)
  window.atualizarIndicadorSanidade = function(ativo) {
    const indicador = document.getElementById('indicador-sanidade');
    if (indicador) {
      if (ativo) {
        indicador.classList.add('ativo');
      } else {
        indicador.classList.remove('ativo');
      }
    }
  }

  // Atualizar indicador reprodutivo (dispon√≠vel globalmente)
  window.atualizarIndicadorReprodutivo = function(ativo) {
    const indicador = document.getElementById('indicador-reprodutivo');
    if (indicador) {
      if (ativo) {
        indicador.classList.add('ativo');
      } else {
        indicador.classList.remove('ativo');
      }
    }
  }

  // Atualizar indicador de movimenta√ß√£o (dispon√≠vel globalmente)
  window.atualizarIndicadorMovimentacao = function(ativo) {
    const indicador = document.getElementById('indicador-movimentacao');
    if (indicador) {
      if (ativo) {
        indicador.classList.add('ativo');
      } else {
        indicador.classList.remove('ativo');
      }
    }
  }

  // Fun√ß√£o para atualizar estilo dos radio buttons de tipo de pesagem
  // ========== CONFIGURA√á√ÉO DE PESAGEM - FUNCIONALIDADES ==========
  
  // Estado da configura√ß√£o
  const configPesagemState = {
    tipoPesagem: 'rotina', // 'rotina' ou 'aparte'
    autoProximo: false,
    configurado: false // Indica se a configura√ß√£o foi confirmada
  };

  // Carregar configura√ß√£o salva
  function carregarConfigPesagem() {
    try {
      const saved = localStorage.getItem('monpecConfigPesagem');
      if (saved) {
        const config = JSON.parse(saved);
        if (config.tipoPesagem) configPesagemState.tipoPesagem = config.tipoPesagem;
        if (typeof config.autoProximo === 'boolean') configPesagemState.autoProximo = config.autoProximo;
        if (typeof config.configurado === 'boolean') configPesagemState.configurado = config.configurado;
      }
    } catch (e) {
      console.warn('Erro ao carregar configura√ß√£o de pesagem:', e);
    }
    aplicarConfigPesagem();
  }

  // Salvar configura√ß√£o
  function salvarConfigPesagem() {
    try {
      localStorage.setItem('monpecConfigPesagem', JSON.stringify(configPesagemState));
    } catch (e) {
      console.warn('Erro ao salvar configura√ß√£o de pesagem:', e);
    }
  }

  // Aplicar configura√ß√£o na interface
  function aplicarConfigPesagem() {
    // Tipo de pesagem
    const radioRotina = document.getElementById('pesagemRotinaV2');
    const radioAparte = document.getElementById('pesagemAparteV2');
    if (configPesagemState.tipoPesagem === 'rotina' && radioRotina) {
      radioRotina.checked = true;
      atualizarEstiloTipoPesagem('rotina');
    } else if (configPesagemState.tipoPesagem === 'aparte' && radioAparte) {
      radioAparte.checked = true;
      atualizarEstiloTipoPesagem('aparte');
    }

    // Auto-pr√≥ximo
    const autoProximo = document.getElementById('autoProximoV2');
    if (autoProximo) {
      autoProximo.checked = configPesagemState.autoProximo;
    }

    // Atualizar visibilidade do formul√°rio/resumo
    atualizarVisibilidadeConfigPesagem();
  }

  // Atualizar resumo das tarefas configuradas
  function atualizarResumoConfigPesagem() {
    const resumoTarefas = document.getElementById('configPesagemResumoTarefas');
    if (!resumoTarefas) return;

    const tarefas = [];
    
    // Tipo de pesagem
    const tipoPesagemText = configPesagemState.tipoPesagem === 'rotina' 
      ? 'Pesagem de Rotina' 
      : 'Pesagem para Aparta√ß√£o';
    tarefas.push({
      icon: configPesagemState.tipoPesagem === 'rotina' ? 'fa-history' : 'fa-layer-group',
      text: tipoPesagemText
    });

    // Auto-pr√≥ximo
    if (configPesagemState.autoProximo) {
      tarefas.push({ icon: 'fa-forward', text: 'Auto-pr√≥ximo' });
    }

    // Renderizar tarefas
    if (tarefas.length > 0) {
      resumoTarefas.innerHTML = tarefas.map(tarefa => `
        <div class="config-pesagem-resumo-tarefa">
          <i class="fas ${tarefa.icon}"></i>
          <span>${tarefa.text}</span>
        </div>
      `).join('');
    } else {
      resumoTarefas.innerHTML = '<div style="color: var(--monpec-text-light); font-size: 0.85rem;">Apenas pesagem configurada</div>';
    }
  }

  // Atualizar visibilidade do formul√°rio/resumo
  function atualizarVisibilidadeConfigPesagem() {
    const form = document.getElementById('configPesagemForm');
    const resumo = document.getElementById('configPesagemResumo');
    const editBtn = document.getElementById('configPesagemEditBtn');

    if (!form || !resumo || !editBtn) return;

    if (configPesagemState.configurado) {
      // Mostrar resumo, esconder formul√°rio
      form.style.display = 'none';
      resumo.style.display = 'block';
      editBtn.style.display = 'flex';
      atualizarResumoConfigPesagem();
    } else {
      // Mostrar formul√°rio, esconder resumo
      form.style.display = 'block';
      resumo.style.display = 'none';
      editBtn.style.display = 'none';
    }
  }

  // Confirmar configura√ß√£o
  function confirmarConfigPesagem() {
    console.log('‚úÖ [CONFIRMAR CONFIGURA√á√ÉO] Iniciando...');
    configPesagemState.configurado = true;
    salvarConfigPesagem();
    atualizarVisibilidadeConfigPesagem();
    
    console.log('‚úÖ [CONFIRMAR CONFIGURA√á√ÉO] Estado atualizado:', configPesagemState);
    
    // Atualizar cards de manejos selecionados (com pequeno delay para garantir que o estado est√° atualizado)
    setTimeout(() => {
      if (typeof window.atualizarCardsManejosSelecionados === 'function') {
        console.log('üîÑ [CONFIRMAR CONFIGURA√á√ÉO] Chamando atualizarCardsManejosSelecionados...');
        window.atualizarCardsManejosSelecionados();
      } else {
        console.error('‚ùå [CONFIRMAR CONFIGURA√á√ÉO] Fun√ß√£o atualizarCardsManejosSelecionados n√£o encontrada!');
      }
    }, 100);
    
    // Mostrar mensagem de sucesso
    if (typeof mostrarToast === 'function') {
      mostrarToast('Configura√ß√£o confirmada! As tarefas ser√£o aplicadas automaticamente.', 'success');
    }
  }

  // Editar configura√ß√£o
  function editarConfigPesagem() {
    configPesagemState.configurado = false;
    salvarConfigPesagem();
    atualizarVisibilidadeConfigPesagem();
  }

  // Atualizar estilo do tipo de pesagem
  function atualizarEstiloTipoPesagem(tipo) {
    const labelRotina = document.getElementById('labelPesagemRotina');
    const labelAparte = document.getElementById('labelPesagemAparte');
    
    if (tipo === 'rotina') {
      if (labelRotina) {
        labelRotina.style.borderColor = 'var(--monpec-success)';
        labelRotina.style.background = 'rgba(39, 174, 96, 0.08)';
        labelRotina.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';
      }
      if (labelAparte) {
        labelAparte.style.borderColor = 'var(--monpec-border)';
        labelAparte.style.background = 'var(--monpec-bg)';
        labelAparte.style.boxShadow = 'none';
      }
      configPesagemState.tipoPesagem = 'rotina';
    } else if (tipo === 'aparte') {
      if (labelRotina) {
        labelRotina.style.borderColor = 'var(--monpec-border)';
        labelRotina.style.background = 'var(--monpec-bg)';
        labelRotina.style.boxShadow = 'none';
      }
      if (labelAparte) {
        labelAparte.style.borderColor = 'var(--monpec-warning)';
        labelAparte.style.background = 'rgba(243, 156, 18, 0.08)';
        labelAparte.style.boxShadow = '0 0 0 3px rgba(243, 156, 18, 0.1)';
      }
      configPesagemState.tipoPesagem = 'aparte';
      
      // Se aparta√ß√µes n√£o estiverem configuradas, abrir modal
      if (typeof window.abrirModalApartacao === 'function' && (!window.apartacoes || window.apartacoes.length === 0)) {
        setTimeout(() => {
          window.abrirModalApartacao();
        }, 300);
      }
    }
    salvarConfigPesagem();
  }

  // Inicializar event listeners
  function inicializarConfigPesagem() {
    // Tipo de pesagem - radio buttons
    const radioRotina = document.getElementById('pesagemRotinaV2');
    const radioAparte = document.getElementById('pesagemAparteV2');
    
    if (radioRotina) {
      radioRotina.addEventListener('change', function() {
        if (this.checked) {
          atualizarEstiloTipoPesagem('rotina');
          // Adicionar card de manejo imediatamente quando selecionar Pesagem de Rotina
          if (typeof window.adicionarCardManejoSelecionado === 'function') {
            window.adicionarCardManejoSelecionado('pesagem', 'Pesagem de Rotina', 'Registra no hist√≥rico do animal');
            console.log('‚úÖ Card de Pesagem de Rotina adicionado imediatamente');
          }
          // Atualizar cards de manejos apenas se a configura√ß√£o j√° estiver confirmada
          if (configPesagemState.configurado && typeof window.atualizarCardsManejosSelecionados === 'function') {
            window.atualizarCardsManejosSelecionados();
          }
        }
      });
    }
    
    if (radioAparte) {
      radioAparte.addEventListener('change', function() {
        if (this.checked) {
          atualizarEstiloTipoPesagem('aparte');
          // Adicionar card de manejo imediatamente quando selecionar Pesagem para Aparta√ß√£o
          if (typeof window.adicionarCardManejoSelecionado === 'function') {
            window.adicionarCardManejoSelecionado('pesagem', 'Pesagem para Aparta√ß√£o', 'Apenas para loteamento/aparta√ß√£o');
            console.log('‚úÖ Card de Pesagem para Aparta√ß√£o adicionado imediatamente');
          }
          // Atualizar cards de manejos apenas se a configura√ß√£o j√° estiver confirmada
          if (configPesagemState.configurado && typeof window.atualizarCardsManejosSelecionados === 'function') {
            window.atualizarCardsManejosSelecionados();
          }
        }
      });
    }

    // Auto-pr√≥ximo
    const autoProximo = document.getElementById('autoProximoV2');
    if (autoProximo) {
      autoProximo.addEventListener('change', function() {
        configPesagemState.autoProximo = this.checked;
        salvarConfigPesagem();
      });
    }

    // Bot√£o confirmar
    const confirmBtn = document.getElementById('configPesagemConfirmBtn');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', confirmarConfigPesagem);
    }

    // Bot√£o editar
    const editBtn = document.getElementById('configPesagemEditBtn');
    if (editBtn) {
      editBtn.addEventListener('click', editarConfigPesagem);
    }

    // Carregar configura√ß√£o salva
    carregarConfigPesagem();
    
    // Verificar se "Pesagem de Rotina" j√° est√° selecionada e adicionar card imediatamente
    setTimeout(() => {
      if (radioRotina && radioRotina.checked) {
        if (typeof window.adicionarCardManejoSelecionado === 'function') {
          window.adicionarCardManejoSelecionado('pesagem', 'Pesagem de Rotina', 'Registra no hist√≥rico do animal');
          console.log('‚úÖ Card de Pesagem de Rotina adicionado ao carregar p√°gina (j√° estava selecionado)');
        }
      } else if (radioAparte && radioAparte.checked) {
        if (typeof window.adicionarCardManejoSelecionado === 'function') {
          window.adicionarCardManejoSelecionado('pesagem', 'Pesagem para Aparta√ß√£o', 'Apenas para loteamento/aparta√ß√£o');
          console.log('‚úÖ Card de Pesagem para Aparta√ß√£o adicionado ao carregar p√°gina (j√° estava selecionado)');
        }
      }
      
      // Atualizar cards de manejos ap√≥s carregar configura√ß√£o (se estiver confirmada)
      if (configPesagemState.configurado && typeof window.atualizarCardsManejosSelecionados === 'function') {
        window.atualizarCardsManejosSelecionados();
      }
    }, 500);
  }

  // Tornar fun√ß√µes globais
  window.atualizarEstiloTipoPesagem = atualizarEstiloTipoPesagem;
  window.configPesagemState = configPesagemState;
  // N√£o sobrescrever confirmarConfigPesagem se j√° existir (fun√ß√£o do modal tem prioridade)
  if (!window.confirmarConfigPesagem || typeof window.confirmarConfigPesagem !== 'function') {
    window.confirmarConfigPesagem = confirmarConfigPesagem;
  }
  // Criar fun√ß√£o alternativa para o sistema de configura√ß√£o interno
  window.confirmarConfigPesagemInterno = confirmarConfigPesagem;
  window.editarConfigPesagem = editarConfigPesagem;

  // Inicializar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarConfigPesagem);
  } else {
    inicializarConfigPesagem();
  }

  // ========== SANIDADE - FUNCIONALIDADES COMPLETAS ==========
  
  const sanidadeState = {
    vacinas: [],
    medicamentos: []
  };

  // Carregar estado salvo
  function carregarSanidadeState() {
    try {
      const saved = localStorage.getItem('monpecSanidadeState');
      if (saved) {
        const state = JSON.parse(saved);
        if (state.vacinas) sanidadeState.vacinas = state.vacinas;
        if (state.medicamentos) sanidadeState.medicamentos = state.medicamentos;
      }
    } catch (e) {
      console.warn('Erro ao carregar estado de sanidade:', e);
    }
    atualizarListasSanidade();
  }

  // Salvar estado
  function salvarSanidadeState() {
    try {
      localStorage.setItem('monpecSanidadeState', JSON.stringify(sanidadeState));
    } catch (e) {
      console.warn('Erro ao salvar estado de sanidade:', e);
    }
  }

  // Atualizar listas na interface
  function atualizarListasSanidade() {
    const listaVacinas = document.getElementById('listaVacinasV2');
    const listaMedicamentos = document.getElementById('listaMedicamentosV2');

    // Vacinas
    if (listaVacinas) {
      if (sanidadeState.vacinas.length === 0) {
        listaVacinas.innerHTML = `
          <div class="sanidade-empty-state">
            <i class="fas fa-syringe"></i>
            <p>Nenhuma vacina configurada</p>
            <small>Clique em "Adicionar Vacina" para come√ßar</small>
          </div>
        `;
      } else {
        listaVacinas.innerHTML = sanidadeState.vacinas.map((vacina, index) => `
          <div class="sanidade-item-v2">
            <div class="sanidade-item-info-v2">
              <div class="sanidade-item-nome-v2">${vacina.nome}</div>
              <div class="sanidade-item-detalhes-v2">${vacina.detalhes || 'Aplicar em todos os animais'}</div>
            </div>
            <div class="sanidade-item-acoes-v2">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerVacinaV2(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }
    }

    // Medicamentos
    if (listaMedicamentos) {
      if (sanidadeState.medicamentos.length === 0) {
        listaMedicamentos.innerHTML = `
          <div class="sanidade-empty-state">
            <i class="fas fa-pills"></i>
            <p>Nenhum medicamento configurado</p>
            <small>Clique em "Adicionar Medicamento" para come√ßar</small>
          </div>
        `;
      } else {
        listaMedicamentos.innerHTML = sanidadeState.medicamentos.map((med, index) => `
          <div class="sanidade-item-v2">
            <div class="sanidade-item-info-v2">
              <div class="sanidade-item-nome-v2">${med.nome}</div>
              <div class="sanidade-item-detalhes-v2">${med.detalhes || 'Aplicar conforme protocolo'}</div>
            </div>
            <div class="sanidade-item-acoes-v2">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerMedicamentoV2(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }
    }
  }

  // Adicionar vacina
  function adicionarVacinaV2() {
    const nome = prompt('Nome da vacina:');
    if (!nome) return;
    const detalhes = prompt('Detalhes (opcional):') || '';
    
    sanidadeState.vacinas.push({ nome, detalhes });
    salvarSanidadeState();
    atualizarListasSanidade();
    
    if (typeof mostrarToast === 'function') {
      mostrarToast(`Vacina "${nome}" adicionada`, 'success');
    }
  }

  // Remover vacina
  function removerVacinaV2(index) {
    if (confirm('Deseja remover esta vacina?')) {
      sanidadeState.vacinas.splice(index, 1);
      salvarSanidadeState();
      atualizarListasSanidade();
    }
  }

  // Adicionar medicamento
  function adicionarMedicamentoV2() {
    const nome = prompt('Nome do medicamento:');
    if (!nome) return;
    const detalhes = prompt('Detalhes (opcional):') || '';
    
    sanidadeState.medicamentos.push({ nome, detalhes });
    salvarSanidadeState();
    atualizarListasSanidade();
    
    if (typeof mostrarToast === 'function') {
      mostrarToast(`Medicamento "${nome}" adicionado`, 'success');
    }
  }

  // Remover medicamento
  function removerMedicamentoV2(index) {
    if (confirm('Deseja remover este medicamento?')) {
      sanidadeState.medicamentos.splice(index, 1);
      salvarSanidadeState();
      atualizarListasSanidade();
    }
  }

  // Aplica√ß√£o r√°pida
  function aplicarRapidaSanidadeV2(tipo, nome, id) {
    const item = { nome, detalhes: 'Aplica√ß√£o r√°pida', id };
    
    if (tipo === 'vacina') {
      if (!sanidadeState.vacinas.find(v => v.id === id)) {
        sanidadeState.vacinas.push(item);
        salvarSanidadeState();
        atualizarListasSanidade();
        if (typeof mostrarToast === 'function') {
          mostrarToast(`Vacina "${nome}" adicionada`, 'success');
        }
      } else {
        if (typeof mostrarToast === 'function') {
          mostrarToast(`Vacina "${nome}" j√° est√° configurada`, 'info');
        }
      }
    } else if (tipo === 'medicamento') {
      if (!sanidadeState.medicamentos.find(m => m.id === id)) {
        sanidadeState.medicamentos.push(item);
        salvarSanidadeState();
        atualizarListasSanidade();
        if (typeof mostrarToast === 'function') {
          mostrarToast(`Medicamento "${nome}" adicionado`, 'success');
        }
      } else {
        if (typeof mostrarToast === 'function') {
          mostrarToast(`Medicamento "${nome}" j√° est√° configurado`, 'info');
        }
      }
    }
  }

  // Inicializar Sanidade
  function inicializarSanidadeV2() {
    const btnAdicionarVacina = document.getElementById('btnAdicionarVacinaV2');
    const btnAdicionarMedicamento = document.getElementById('btnAdicionarMedicamentoV2');
    const botoesRapidos = document.querySelectorAll('.sanidade-rapida-btn-v2');

    if (btnAdicionarVacina) {
      btnAdicionarVacina.addEventListener('click', adicionarVacinaV2);
    }

    if (btnAdicionarMedicamento) {
      btnAdicionarMedicamento.addEventListener('click', adicionarMedicamentoV2);
    }

    botoesRapidos.forEach(btn => {
      btn.addEventListener('click', function() {
        const tipo = this.dataset.tipo;
        const nome = this.dataset.nome;
        const id = this.dataset.id;
        aplicarRapidaSanidadeV2(tipo, nome, id);
      });
    });

    carregarSanidadeState();
  }

  // ========== REPRODUTIVO - FUNCIONALIDADES COMPLETAS ==========
  
  const reprodutivoState = {
    protocolos: [],
    diagnosticoAtual: null
  };

  // Registrar diagn√≥stico
  function registrarDiagnosticoReprodutivoV2(diagnostico) {
    reprodutivoState.diagnosticoAtual = diagnostico;
    
    if (typeof window.currentAnimalV2 !== 'undefined' && window.currentAnimalV2) {
      // Aplicar diagn√≥stico ao animal atual
      if (typeof window.selecionarDiagnosticoV2 === 'function') {
        window.selecionarDiagnosticoV2(diagnostico);
      }
    }
    
    if (typeof mostrarToast === 'function') {
      const labels = {
        'PRENHA': 'Prenha',
        'VAZIA': 'Vazia',
        'ABORTO': 'Aborto',
        'REPETIR_CIO': 'Repetir Cio'
      };
      mostrarToast(`Diagn√≥stico "${labels[diagnostico] || diagnostico}" registrado`, 'success');
    }
  }

  // Aplicar manejo reprodutivo
  function aplicarManejoReprodutivoV2(manejo) {
    if (typeof mostrarToast === 'function') {
      const labels = {
        'diagnostico-prenhez': 'Diagn√≥stico de prenhez',
        'programar-iatf': 'Programar IATF',
        'registrar-nascimento': 'Registrar nascimento',
        'registrar-parto': 'Registrar parto'
      };
      mostrarToast(`Manejo "${labels[manejo] || manejo}" aplicado`, 'success');
    }
  }

  // Inicializar Reprodutivo
  function inicializarReprodutivoV2() {
    const botoesDiagnostico = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2');
    const cardsManejo = document.querySelectorAll('.reprodutivo-manejo-card-v2');

    botoesDiagnostico.forEach(btn => {
      btn.addEventListener('click', function() {
        const diagnostico = this.dataset.diagnostico;
        registrarDiagnosticoReprodutivoV2(diagnostico);
      });
    });

    cardsManejo.forEach(card => {
      card.addEventListener('click', function() {
        const manejo = this.dataset.manejo;
        aplicarManejoReprodutivoV2(manejo);
      });
    });
  }

  // ========== MOVIMENTA√á√ÉO - FUNCIONALIDADES COMPLETAS ==========
  
  const movimentacaoState = {
    historico: []
  };

  // Trocar tipo de movimenta√ß√£o
  function trocarTipoMovimentacaoV2(tipo) {
    // Esconder todos os formul√°rios
    document.querySelectorAll('.movimentacao-form-tipo').forEach(form => {
      form.style.display = 'none';
    });

    // Mostrar formul√°rio selecionado
    const formId = `form${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
    const form = document.getElementById(formId);
    if (form) {
      form.style.display = 'block';
    }

    // Atualizar tabs
    document.querySelectorAll('.movimentacao-tipo-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    const tabAtiva = document.querySelector(`.movimentacao-tipo-tab[data-tipo="${tipo}"]`);
    if (tabAtiva) {
      tabAtiva.classList.add('active');
    }
  }

  // Aplicar entrada (compra)
  function aplicarEntradaV2() {
    const fornecedor = document.getElementById('fornecedorEntradaV2');
    const data = document.getElementById('dataCompraV2');
    const lote = document.getElementById('loteDestinoEntradaV2');
    const quantidade = document.getElementById('quantidadeEntradaV2');
    const obs = document.getElementById('obsEntradaV2');

    if (!fornecedor || !fornecedor.value) {
      alert('Selecione o fornecedor');
      return;
    }

    const fornecedorNome = fornecedor.options[fornecedor.selectedIndex].text;
    const loteNome = lote && lote.value ? lote.options[lote.selectedIndex].text : 'Sem lote';
    const quantidadeVal = quantidade ? quantidade.value : 'N/A';

    const movimentacao = {
      tipo: 'ENTRADA',
      subtipo: 'COMPRA',
      fornecedor: fornecedorNome,
      lote: loteNome,
      quantidade: quantidadeVal,
      data: data ? data.value : new Date().toISOString().split('T')[0],
      observacoes: obs ? obs.value : '',
      timestamp: new Date().toLocaleString('pt-BR')
    };

    movimentacaoState.historico.unshift(movimentacao);
    atualizarHistoricoMovimentacao();

    // Limpar formul√°rio
    if (fornecedor) fornecedor.value = '';
    if (lote) lote.value = '';
    if (quantidade) quantidade.value = '';
    if (obs) obs.value = '';

    if (typeof mostrarToast === 'function') {
      mostrarToast(`Entrada (Compra) de ${quantidadeVal} animais registrada`, 'success');
    }
  }

  // Aplicar sa√≠da (venda/leil√£o)
  function aplicarSaidaV2() {
    const tipoSaida = document.getElementById('tipoSaidaV2');
    const cliente = document.getElementById('clienteSaidaV2');
    const frigorifico = document.getElementById('frigorificoSaidaV2');
    const data = document.getElementById('dataVendaV2');
    const lote = document.getElementById('loteOrigemSaidaV2');
    const quantidade = document.getElementById('quantidadeSaidaV2');
    const valor = document.getElementById('valorVendaV2');
    const obs = document.getElementById('obsSaidaV2');

    if (!tipoSaida || !tipoSaida.value) {
      alert('Selecione o tipo de sa√≠da');
      return;
    }

    const tipoSaidaVal = tipoSaida.value;
    let destinatario = '';

    if (tipoSaidaVal === 'venda_abate') {
      if (!frigorifico || !frigorifico.value) {
        alert('Selecione o frigor√≠fico');
        return;
      }
      destinatario = frigorifico.options[frigorifico.selectedIndex].text;
    } else if (tipoSaidaVal === 'venda_terceiros') {
      if (!cliente || !cliente.value) {
        alert('Selecione o cliente');
        return;
      }
      destinatario = cliente.options[cliente.selectedIndex].text;
    } else if (tipoSaidaVal === 'leilao') {
      destinatario = 'Leil√£o';
    }

    const loteNome = lote && lote.value ? lote.options[lote.selectedIndex].text : 'Sem lote';
    const quantidadeVal = quantidade ? quantidade.value : 'N/A';
    const valorVal = valor ? parseFloat(valor.value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'N/A';

    const movimentacao = {
      tipo: 'SAIDA',
      subtipo: tipoSaidaVal === 'venda_abate' ? 'VENDA_ABATE' : tipoSaidaVal === 'venda_terceiros' ? 'VENDA_TERCEIROS' : 'LEILAO',
      destinatario: destinatario,
      lote: loteNome,
      quantidade: quantidadeVal,
      valor: valorVal,
      data: data ? data.value : new Date().toISOString().split('T')[0],
      observacoes: obs ? obs.value : '',
      timestamp: new Date().toLocaleString('pt-BR')
    };

    movimentacaoState.historico.unshift(movimentacao);
    atualizarHistoricoMovimentacao();

    // Limpar formul√°rio
    if (tipoSaida) tipoSaida.value = '';
    if (cliente) cliente.value = '';
    if (frigorifico) frigorifico.value = '';
    if (lote) lote.value = '';
    if (quantidade) quantidade.value = '';
    if (valor) valor.value = '';
    if (obs) obs.value = '';
    trocarTipoMovimentacaoV2('saida'); // Resetar visibilidade dos campos

    if (typeof mostrarToast === 'function') {
      mostrarToast(`Sa√≠da (${destinatario}) de ${quantidadeVal} animais registrada`, 'success');
    }
  }

  // Aplicar transfer√™ncia
  function aplicarTransferenciaV2() {
    const origem = document.getElementById('propriedadeOrigemV2');
    const destino = document.getElementById('propriedadeDestinoV2');
    const data = document.getElementById('dataTransferenciaV2');
    const quantidade = document.getElementById('quantidadeTransferenciaV2');
    const motivo = document.getElementById('motivoTransferenciaV2');

    if (!origem || !origem.value) {
      alert('Selecione a propriedade de origem');
      return;
    }

    if (!destino || !destino.value) {
      alert('Selecione a propriedade de destino');
      return;
    }

    if (origem.value === destino.value) {
      alert('A propriedade de origem e destino n√£o podem ser a mesma');
      return;
    }

    const origemNome = origem.options[origem.selectedIndex].text;
    const destinoNome = destino.options[destino.selectedIndex].text;
    const quantidadeVal = quantidade ? quantidade.value : 'N/A';

    const movimentacao = {
      tipo: 'TRANSFERENCIA',
      origem: origemNome,
      destino: destinoNome,
      quantidade: quantidadeVal,
      data: data ? data.value : new Date().toISOString().split('T')[0],
      motivo: motivo ? motivo.value : '',
      timestamp: new Date().toLocaleString('pt-BR')
    };

    movimentacaoState.historico.unshift(movimentacao);
    atualizarHistoricoMovimentacao();

    // Limpar formul√°rio
    if (origem) origem.value = '';
    if (destino) destino.value = '';
    if (quantidade) quantidade.value = '';
    if (motivo) motivo.value = '';

    if (typeof mostrarToast === 'function') {
      mostrarToast(`Transfer√™ncia de ${quantidadeVal} animais de "${origemNome}" para "${destinoNome}" registrada`, 'success');
    }
  }

  // Aplicar movimenta√ß√£o interna
  function aplicarInternaV2() {
    const loteOrigem = document.getElementById('loteOrigemInternaV2');
    const loteDestino = document.getElementById('loteDestinoInternaV2');
    const motivo = document.getElementById('motivoInternaV2');

    if (!loteOrigem || !loteDestino) return;

    const origemId = loteOrigem.value;
    const destinoId = loteDestino.value;
    const motivoText = motivo ? motivo.value : '';

    if (!origemId || !destinoId) {
      alert('Selecione o lote de origem e destino');
      return;
    }

    const origemNome = loteOrigem.options[loteOrigem.selectedIndex].text;
    const destinoNome = loteDestino.options[loteDestino.selectedIndex].text;

    const movimentacao = {
      tipo: 'INTERNA',
      origem: origemNome,
      destino: destinoNome,
      motivo: motivoText,
      timestamp: new Date().toLocaleString('pt-BR')
    };

    movimentacaoState.historico.unshift(movimentacao);
    atualizarHistoricoMovimentacao();

    // Limpar formul√°rio
    loteOrigem.value = '';
    loteDestino.value = '';
    if (motivo) motivo.value = '';

    if (typeof mostrarToast === 'function') {
      mostrarToast(`Movimenta√ß√£o interna de "${origemNome}" para "${destinoNome}" registrada`, 'success');
    }
  }

  // Movimenta√ß√£o r√°pida
  function movimentacaoRapidaV2(tipo) {
    const tipos = {
      'apartar': 'Aparta√ß√£o',
      'loteamento': 'Loteamento',
      'pasto': 'Mudan√ßa de Pasto',
      'curral': 'Para o Curral'
    };

    if (typeof mostrarToast === 'function') {
      mostrarToast(`Movimenta√ß√£o r√°pida "${tipos[tipo] || tipo}" aplicada`, 'success');
    }
  }

  // Atualizar hist√≥rico
  function atualizarHistoricoMovimentacao() {
    const historico = document.getElementById('historicoMovimentacoesV2');
    if (!historico) return;

    if (movimentacaoState.historico.length === 0) {
      historico.innerHTML = `
        <div class="sanidade-empty-state">
          <i class="fas fa-history"></i>
          <p>Nenhuma movimenta√ß√£o registrada</p>
          <small>As movimenta√ß√µes aparecer√£o aqui</small>
        </div>
      `;
    } else {
      historico.innerHTML = movimentacaoState.historico.slice(0, 15).map(mov => {
        let desc = '';
        let icon = 'fas fa-exchange-alt';
        let cor = 'var(--monpec-text)';

        if (mov.tipo === 'ENTRADA') {
          desc = `Compra: ${mov.fornecedor || 'N/A'} ‚Üí ${mov.lote || 'N/A'} (${mov.quantidade || 'N/A'} animais)`;
          icon = 'fas fa-arrow-down';
          cor = 'var(--monpec-success)';
        } else if (mov.tipo === 'SAIDA') {
          const subtipoLabel = mov.subtipo === 'VENDA_ABATE' ? 'Venda Abate' : 
                               mov.subtipo === 'VENDA_TERCEIROS' ? 'Venda Terceiros' : 'Leil√£o';
          desc = `${subtipoLabel}: ${mov.destinatario || 'N/A'} ‚Üê ${mov.lote || 'N/A'} (${mov.quantidade || 'N/A'} animais)`;
          if (mov.valor && mov.valor !== 'N/A') desc += ` - ${mov.valor}`;
          icon = 'fas fa-arrow-up';
          cor = 'var(--monpec-danger)';
        } else if (mov.tipo === 'TRANSFERENCIA') {
          desc = `Transfer√™ncia: ${mov.origem || 'N/A'} ‚Üí ${mov.destino || 'N/A'} (${mov.quantidade || 'N/A'} animais)`;
          icon = 'fas fa-exchange-alt';
          cor = 'var(--monpec-accent)';
        } else {
          desc = `${mov.origem || 'N/A'} ‚Üí ${mov.destino || 'N/A'}`;
        }

        return `
          <div class="movimentacao-item-v2">
            <div class="movimentacao-item-info-v2">
              <div class="movimentacao-item-desc-v2" style="color: ${cor};">
                <i class="${icon}" style="margin-right: 6px;"></i>
                ${desc}
              </div>
              <div class="movimentacao-item-data-v2">
                ${mov.timestamp || mov.data || 'N/A'}${mov.motivo ? ' ¬∑ ' + mov.motivo : ''}${mov.observacoes ? ' ¬∑ ' + mov.observacoes : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  // Controlar visibilidade de campos de sa√≠da
  function atualizarCamposSaidaV2() {
    const tipoSaida = document.getElementById('tipoSaidaV2');
    const clienteContainer = document.getElementById('clienteSaidaContainer');
    const frigorificoContainer = document.getElementById('frigorificoSaidaContainer');

    if (!tipoSaida || !clienteContainer || !frigorificoContainer) return;

    const tipo = tipoSaida.value;

    if (tipo === 'venda_abate') {
      clienteContainer.style.display = 'none';
      frigorificoContainer.style.display = 'block';
      const cliente = document.getElementById('clienteSaidaV2');
      if (cliente) cliente.value = '';
    } else if (tipo === 'venda_terceiros') {
      clienteContainer.style.display = 'block';
      frigorificoContainer.style.display = 'none';
      const frigorifico = document.getElementById('frigorificoSaidaV2');
      if (frigorifico) frigorifico.value = '';
    } else if (tipo === 'leilao') {
      clienteContainer.style.display = 'none';
      frigorificoContainer.style.display = 'none';
      const cliente = document.getElementById('clienteSaidaV2');
      const frigorifico = document.getElementById('frigorificoSaidaV2');
      if (cliente) cliente.value = '';
      if (frigorifico) frigorifico.value = '';
    } else {
      clienteContainer.style.display = 'none';
      frigorificoContainer.style.display = 'none';
    }
  }

  // Inicializar Movimenta√ß√£o
  function inicializarMovimentacaoV2() {
    // Tabs de tipo
    const tabs = document.querySelectorAll('.movimentacao-tipo-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tipo = this.dataset.tipo;
        trocarTipoMovimentacaoV2(tipo);
      });
    });

    // Bot√µes de a√ß√£o
    const btnEntrada = document.getElementById('btnAplicarEntradaV2');
    const btnSaida = document.getElementById('btnAplicarSaidaV2');
    const btnTransferencia = document.getElementById('btnAplicarTransferenciaV2');
    const btnInterna = document.getElementById('btnAplicarInternaV2');
    const tipoSaida = document.getElementById('tipoSaidaV2');
    const botoesRapidos = document.querySelectorAll('.movimentacao-rapida-btn-v2');

    if (btnEntrada) {
      btnEntrada.addEventListener('click', aplicarEntradaV2);
    }

    if (btnSaida) {
      btnSaida.addEventListener('click', aplicarSaidaV2);
    }

    if (btnTransferencia) {
      btnTransferencia.addEventListener('click', aplicarTransferenciaV2);
    }

    if (btnInterna) {
      btnInterna.addEventListener('click', aplicarInternaV2);
    }

    if (tipoSaida) {
      tipoSaida.addEventListener('change', atualizarCamposSaidaV2);
    }

    botoesRapidos.forEach(btn => {
      btn.addEventListener('click', function() {
        const tipo = this.dataset.tipo;
        movimentacaoRapidaV2(tipo);
      });
    });

    // Inicializar com entrada
    trocarTipoMovimentacaoV2('entrada');
    atualizarHistoricoMovimentacao();
  }

  // Fun√ß√µes auxiliares para modais (placeholder)
  function abrirModalNovoFornecedor() {
    alert('Funcionalidade de cadastro de fornecedor ser√° implementada');
  }

  function abrirModalNovoCliente() {
    alert('Funcionalidade de cadastro de cliente ser√° implementada');
  }

  function abrirModalNovoFrigorifico() {
    alert('Funcionalidade de cadastro de frigor√≠fico ser√° implementada');
  }

  window.abrirModalNovoFornecedor = abrirModalNovoFornecedor;
  window.abrirModalNovoCliente = abrirModalNovoCliente;
  window.abrirModalNovoFrigorifico = abrirModalNovoFrigorifico;

  // Tornar fun√ß√µes globais
  window.adicionarVacinaV2 = adicionarVacinaV2;
  window.removerVacinaV2 = removerVacinaV2;
  window.adicionarMedicamentoV2 = adicionarMedicamentoV2;
  window.removerMedicamentoV2 = removerMedicamentoV2;
  window.registrarDiagnosticoV2 = registrarDiagnosticoReprodutivoV2;
  window.aplicarMovimentacaoV2 = aplicarInternaV2; // Compatibilidade - usa movimenta√ß√£o interna
  window.movimentacaoRapidaV2 = movimentacaoRapidaV2;
  window.aplicarEntradaV2 = aplicarEntradaV2;
  window.aplicarSaidaV2 = aplicarSaidaV2;
  window.aplicarTransferenciaV2 = aplicarTransferenciaV2;
  window.trocarTipoMovimentacaoV2 = trocarTipoMovimentacaoV2;

  // ========== FUN√á√ÉO PARA GRAVAR PESAGEM ==========
  window.salvarPesagemBackendV2 = async function() {
    console.log('üíæ Fun√ß√£o salvarPesagemBackendV2 chamada');
    
    const pesoInput = document.getElementById('pesoValorV2');
    const brincoInput = document.getElementById('brincoInputV2');
    const animalAtual = window.animalAtualV2 || window.currentAnimalV2;
    
    // Captura o peso do input (campo que mostra "358 kg")
    let pesoParaSalvar = 0;
    if (pesoInput) {
      // Tenta ler do value primeiro (se foi digitado)
      if (pesoInput.value) {
        const pesoTexto = pesoInput.value.replace(',', '.').trim();
        pesoParaSalvar = parseFloat(pesoTexto);
      }
      
      // Se n√£o tem valor no input, tenta ler do textContent (se foi atualizado por outra fun√ß√£o)
      if ((!pesoParaSalvar || pesoParaSalvar <= 0) && pesoInput.textContent) {
        const pesoTexto = pesoInput.textContent.replace(/kg/gi, '').replace(/\s/g, '').replace(',', '.').trim();
        pesoParaSalvar = parseFloat(pesoTexto);
      }
      
      // Se ainda n√£o tem, tenta ler do innerText
      if ((!pesoParaSalvar || pesoParaSalvar <= 0) && pesoInput.innerText) {
        const pesoTexto = pesoInput.innerText.replace(/kg/gi, '').replace(/\s/g, '').replace(',', '.').trim();
        pesoParaSalvar = parseFloat(pesoTexto);
      }
    }
    
    console.log('üìä Peso capturado do campo:', {
      value: pesoInput ? pesoInput.value : 'N/A',
      textContent: pesoInput ? pesoInput.textContent : 'N/A',
      innerText: pesoInput ? pesoInput.innerText : 'N/A',
      pesoParaSalvar: pesoParaSalvar
    });
    
    console.log('üìä Estado atual:', {
      brinco: brincoInput ? brincoInput.value : 'N/A',
      pesoParaSalvar: pesoParaSalvar,
      pesoInputValue: pesoInput ? pesoInput.value : 'N/A',
      pesoInputTextContent: pesoInput ? pesoInput.textContent : 'N/A',
      animalId: animalAtual ? animalAtual.id : 'N/A'
    });
    
    // Valida√ß√µes
    if (!brincoInput || !brincoInput.value) {
      alert('Identifique um animal primeiro.');
      return false;
    }
    
    if (!pesoParaSalvar || pesoParaSalvar <= 0) {
      alert('Informe o peso do animal.');
      return false;
    }
    
    // Obt√©m propriedade_id da URL
    const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
    const propriedadeId = urlMatch ? urlMatch[1] : null;
    
    if (!propriedadeId) {
      alert('Erro: N√£o foi poss√≠vel identificar a propriedade.');
      return false;
    }
    
    // Obt√©m animal_id
    let animalId = animalAtual ? animalAtual.id : null;
    
    // Se n√£o tem animal_id, tenta buscar pelo brinco
    if (!animalId && brincoInput.value) {
      try {
        const response = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.status === 'animal' && data.dados) {
            animalId = data.dados.id;
            window.animalAtualV2 = data.dados;
          }
        }
      } catch (error) {
        console.error('Erro ao buscar animal:', error);
      }
    }
    
    if (!animalId) {
      alert('Erro: Animal n√£o encontrado. Verifique o brinco.');
      return false;
    }
    
    // Prepara dados da pesagem
    const pesagem = {
      animal_id: animalId,
      brinco: brincoInput.value,
      peso: pesoParaSalvar
    };
    
    // Salva no backend
    try {
      const response = await fetch(`/propriedade/${propriedadeId}/curral/api/pesagem/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(pesagem)
      });
      
      const responseData = await response.json();
      
      if (response.ok) {
        const novoPeso = parseFloat(responseData.novo_peso || responseData.peso || pesoParaSalvar);
        const dataAtual = new Date();
        const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' ' + dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const dataISO = dataAtual.toISOString().slice(0, 10); // YYYY-MM-DD
        
        console.log('‚úÖ Pesagem salva! Atualizando campos com:', {
          novoPeso,
          dataFormatada,
          dataISO
        });
        
        // ========== ATUALIZA√á√ÉO VISUAL FOR√áADA ==========
        console.log('üé® ========== INICIANDO ATUALIZA√á√ÉO VISUAL ==========');
        
        // Fun√ß√£o auxiliar para atualizar campo com for√ßa
        function atualizarCampoVisual(id, valor, logNome) {
          const elemento = document.getElementById(id);
          if (elemento) {
            // Tenta m√∫ltiplas formas de atualiza√ß√£o
            elemento.textContent = valor;
            elemento.innerText = valor;
            if (elemento.innerHTML !== undefined) {
              elemento.innerHTML = valor;
            }
            // For√ßa reflow do navegador
            elemento.offsetHeight;
            console.log(`‚úÖ ${logNome} atualizado: "${valor}"`);
            return true;
          } else {
            console.error(`‚ùå ${logNome} (${id}) N√ÉO ENCONTRADO no DOM!`);
            return false;
          }
        }
        
        // 1. Atualiza o campo "PESO REGISTRADO" (em verde)
        const pesoRegistrado = document.getElementById('pesoRegistradoV2');
        if (pesoRegistrado) {
          const valorPesoRegistrado = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
          pesoRegistrado.textContent = valorPesoRegistrado;
          pesoRegistrado.innerText = valorPesoRegistrado;
          pesoRegistrado.style.color = '#4caf50';
          pesoRegistrado.style.fontWeight = '600';
          pesoRegistrado.style.display = 'inline'; // Garante que est√° vis√≠vel
          pesoRegistrado.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Peso Registrado" atualizado visualmente:', valorPesoRegistrado);
          console.log('üîç Verifica√ß√£o:', {
            textContent: pesoRegistrado.textContent,
            innerText: pesoRegistrado.innerText,
            style: pesoRegistrado.style.color
          });
        } else {
          console.error('‚ùå ERRO: Campo pesoRegistradoV2 N√ÉO ENCONTRADO no DOM!');
          console.error('üîç Tentando encontrar elementos similares...');
          const elementosSimilares = document.querySelectorAll('[id*="peso"], [id*="Peso"], [id*="PESO"]');
          console.log('üìã Elementos encontrados:', Array.from(elementosSimilares).map(el => el.id));
        }
        
        // 2. Atualiza TODOS os campos de hist√≥rico IMEDIATAMENTE
        const pesoUltimo = document.getElementById('pesoUltimoValorV2');
        const pesoData = document.getElementById('pesoUltimoDataV2');
        const pesoDias = document.getElementById('pesoDiasV2');
        const pesoGanhoTotal = document.getElementById('pesoGanhoTotalV2');
        const pesoGanhoDia = document.getElementById('pesoGanhoDiaV2');
        const scannerUltimoPeso = document.getElementById('scannerUltimoPesoV2');
        
        if (pesoUltimo) {
          const valorPesoUltimo = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
          pesoUltimo.textContent = valorPesoUltimo;
          pesoUltimo.innerText = valorPesoUltimo;
          pesoUltimo.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "√öltimo peso" atualizado visualmente:', valorPesoUltimo);
        } else {
          console.error('‚ùå Campo pesoUltimoValorV2 N√ÉO ENCONTRADO!');
        }
        
        if (pesoData) {
          pesoData.textContent = dataFormatada;
          pesoData.innerText = dataFormatada;
          pesoData.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Data √∫ltima pesagem" atualizado visualmente:', dataFormatada);
        } else {
          console.error('‚ùå Campo pesoUltimoDataV2 N√ÉO ENCONTRADO!');
        }
        
        if (pesoDias) {
          pesoDias.textContent = '0 dias';
          pesoDias.innerText = '0 dias';
          pesoDias.offsetHeight; // For√ßa reflow
          console.log('‚úÖ Campo "Dias desde a √∫ltima" atualizado visualmente: 0 dias');
        } else {
          console.error('‚ùå Campo pesoDiasV2 N√ÉO ENCONTRADO!');
        }
        
        if (scannerUltimoPeso) {
          scannerUltimoPeso.textContent = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
          scannerUltimoPeso.innerText = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
        }
        
        console.log('üé® ========== ATUALIZA√á√ÉO VISUAL CONCLU√çDA ==========');
        
        // 3. Atualiza ganhos se temos peso anterior no animal atual
        const animalAtual = window.animalAtualV2 || window.currentAnimalV2;
        if (animalAtual && animalAtual.peso_anterior) {
          const pesoAnterior = parseFloat(animalAtual.peso_anterior);
          const dataAnterior = animalAtual.data_peso_anterior ? new Date(animalAtual.data_peso_anterior) : null;
          
          if (pesoAnterior > 0 && pesoAnterior !== novoPeso && dataAnterior && !isNaN(dataAnterior.getTime())) {
            const dias = Math.max(1, Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24)));
            const ganhoTotal = novoPeso - pesoAnterior;
            const ganhoDia = ganhoTotal / dias;
            
            if (pesoGanhoTotal) {
              pesoGanhoTotal.textContent = `${ganhoTotal >= 0 ? '+' : ''}${ganhoTotal.toFixed(1).replace('.', ',')} kg`;
              console.log('‚úÖ Campo "Ganho total" atualizado:', ganhoTotal);
            }
            
            if (pesoGanhoDia) {
              pesoGanhoDia.textContent = `${ganhoDia >= 0 ? '+' : ''}${ganhoDia.toFixed(2).replace('.', ',')} kg/dia`;
              console.log('‚úÖ Campo "Ganho di√°rio m√©dio" atualizado:', ganhoDia);
            }
            
            if (pesoDias) {
              pesoDias.textContent = `${dias} ${dias === 1 ? 'dia' : 'dias'}`;
            }
          } else {
            // Sem peso anterior, limpar ganhos
            if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
            if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
          }
        } else {
          // Sem animal atual, limpar ganhos
          if (pesoGanhoTotal) pesoGanhoTotal.textContent = '‚Äî';
          if (pesoGanhoDia) pesoGanhoDia.textContent = '‚Äî';
        }
        
        // 4. Chama fun√ß√£o de atualiza√ß√£o de resumo com os novos dados
        if (typeof window.atualizarResumoPesagemV2 === 'function') {
          console.log('üìä Chamando atualizarResumoPesagemV2 com peso novo:', novoPeso, 'e data:', dataISO);
          window.atualizarResumoPesagemV2(novoPeso, dataISO);
        } else if (typeof atualizarResumoPesagemV2 === 'function') {
          atualizarResumoPesagemV2(novoPeso, dataISO);
        }
        
        // 5. Feedback visual
        const gravarBtn = document.getElementById('pesoGravarBtnV2');
        if (gravarBtn) {
          const originalText = gravarBtn.innerHTML;
          gravarBtn.innerHTML = '<i class="fas fa-check-circle"></i> Gravado!';
          gravarBtn.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
          setTimeout(() => {
            gravarBtn.innerHTML = originalText;
            gravarBtn.style.background = '';
          }, 3000);
        }
        
        // 6. Mostra notifica√ß√£o
        if (typeof mostrarToast === 'function') {
          mostrarToast('Pesagem gravada com sucesso!', 'success');
        } else {
          alert('Pesagem gravada com sucesso!');
        }
        
        // 6.5. Registrar eventos configurados automaticamente
        if (animalId) {
          setTimeout(() => {
            if (typeof window.registrarEventosConfigurados === 'function') {
              window.registrarEventosConfigurados(animalId);
            }
          }, 1000);
        }
        
        // 7. Recarrega dados do animal ap√≥s 500ms para atualizar hist√≥rico completo (opcional, mas recomendado)
        setTimeout(async () => {
          if (brincoInput && brincoInput.value) {
            try {
              console.log('üîÑ Recarregando dados do animal para atualizar hist√≥rico completo...');
              const responseAnimal = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
              if (responseAnimal.ok) {
                const dataAnimal = await responseAnimal.json();
                if (dataAnimal.status === 'animal' && dataAnimal.dados) {
                  // Atualiza resumo do scanner
                  if (typeof window.atualizarScannerResumoV2 === 'function') {
                    window.atualizarScannerResumoV2(dataAnimal.dados);
                  } else if (typeof atualizarResumoScanner === 'function') {
                    atualizarResumoScanner(dataAnimal.dados);
                  }
                  
                  // Atualiza informa√ß√µes de pesagem com dados completos do backend
                  if (typeof atualizarInfoPesagem === 'function') {
                    atualizarInfoPesagem(dataAnimal.dados);
                  } else if (typeof window.atualizarResumoPesagemV2 === 'function') {
                    // Se temos dados de pesagem do backend, usar eles
                    if (dataAnimal.dados.peso_atual) {
                      window.atualizarResumoPesagemV2(
                        parseFloat(dataAnimal.dados.peso_atual),
                        dataAnimal.dados.data_peso_atual || dataISO
                      );
                    }
                  }
                  
                  window.animalAtualV2 = dataAnimal.dados;
                  console.log('‚úÖ Dados do animal recarregados e campos atualizados!');
                }
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è Erro ao recarregar dados do animal (n√£o cr√≠tico):', error);
            }
          }
        }, 500);
        
        // ========== ATUALIZAR TABELA E PROGRESSO DA SESS√ÉO ==========
        console.log('üìã [SALVAR PESAGEM] Atualizando tabela e progresso da sess√£o...');
        
        // Atualizar progresso da sess√£o ap√≥s salvar pesagem
        if (typeof window.atualizarProgressoSessao === 'function') {
          setTimeout(() => {
            window.atualizarProgressoSessao();
          }, 800);
        }
        
        // Adicionar animal √† tabela de registrados
        if (window.animalAtualV2 && window.animalAtualV2.id) {
          if (typeof window.adicionarAnimalTabelaRegistrados === 'function') {
            console.log('üìã Chamando adicionarAnimalTabelaRegistrados...');
            window.adicionarAnimalTabelaRegistrados(window.animalAtualV2);
            console.log('‚úÖ Animal adicionado √† tabela de registrados');
          } else {
            console.error('‚ùå Fun√ß√£o adicionarAnimalTabelaRegistrados n√£o encontrada!');
          }
        }
        
        // Atualizar progresso da sess√£o
        if (typeof window.atualizarProgressoSessao === 'function') {
          console.log('üìä Chamando atualizarProgressoSessao...');
          window.atualizarProgressoSessao();
          console.log('‚úÖ Progresso da sess√£o atualizado');
        } else {
          console.error('‚ùå Fun√ß√£o atualizarProgressoSessao n√£o encontrada!');
        }
        
        // Atualizar tabela de animais registrados
        if (typeof window.atualizarTabelaAnimaisRegistrados === 'function') {
          console.log('üìã Chamando atualizarTabelaAnimaisRegistrados...');
          setTimeout(() => {
            window.atualizarTabelaAnimaisRegistrados();
            console.log('‚úÖ Tabela de animais registrados atualizada');
          }, 300);
        } else {
          console.error('‚ùå Fun√ß√£o atualizarTabelaAnimaisRegistrados n√£o encontrada!');
        }
        
        console.log('‚úÖ Pesagem salva com sucesso e TODOS os campos atualizados!');
        return true;
      } else {
        const mensagemErro = responseData.mensagem || responseData.status || 'Erro desconhecido';
        console.error('‚ùå Erro ao salvar pesagem:', responseData);
        alert(`Erro ao salvar pesagem: ${mensagemErro}`);
        return false;
      }
    } catch (error) {
      console.error('‚ùå Erro ao salvar pesagem:', error);
      alert('Erro ao conectar com o servidor. Verifique sua conex√£o.');
      return false;
    }
  };
  
  // Fun√ß√£o auxiliar para obter CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Listener para o bot√£o Gravar - VERS√ÉO ROBUSTA
  function inicializarBotaoGravarPesagem() {
    console.log('üîß ========== INICIALIZANDO BOT√ïES DE PESAGEM ==========');
    
    const gravarBtn = document.getElementById('pesoGravarBtnV2');
    const limparBtn = document.getElementById('pesoLimparBtnV2');
    const pesoInput = document.getElementById('pesoValorV2');
    const brincoInput = document.getElementById('brincoInputV2');
    
    console.log('üîç Elementos encontrados:', {
      gravarBtn: !!gravarBtn,
      limparBtn: !!limparBtn,
      pesoInput: !!pesoInput,
      brincoInput: !!brincoInput,
      salvarPesagemBackendV2: typeof window.salvarPesagemBackendV2 === 'function'
    });
    
    if (!gravarBtn) {
      console.error('‚ùå ERRO CR√çTICO: Bot√£o pesoGravarBtnV2 n√£o encontrado no DOM!');
      console.error('üîç Tentando encontrar bot√µes alternativos...');
      const botoesGravar = document.querySelectorAll('button[id*="gravar"], button[id*="Gravar"], .btn-gravar');
      console.log('üìã Bot√µes encontrados:', Array.from(botoesGravar).map(b => ({ id: b.id, text: b.textContent.trim() })));
      return;
    }
    
    if (!pesoInput) {
      console.error('‚ùå ERRO CR√çTICO: Campo pesoValorV2 n√£o encontrado no DOM!');
      return;
    }
    
    // ========== LISTENERS NO CAMPO DE PESO ==========
    console.log('üîß Adicionando listeners no campo de peso...');
    
    // Remove listeners anteriores se existirem
    const novoPesoInput = pesoInput.cloneNode(true);
    pesoInput.parentNode.replaceChild(novoPesoInput, pesoInput);
    const pesoInputAtual = document.getElementById('pesoValorV2');
    
    // Listener para detectar digita√ß√£o
    pesoInputAtual.addEventListener('input', function(e) {
      const valor = e.target.value;
      console.log('‚å®Ô∏è PESO DIGITADO:', valor);
      console.log('üìä Tipo do valor:', typeof valor, 'Tamanho:', valor.length);
    });
    
    // Listener para detectar quando o campo recebe foco
    pesoInputAtual.addEventListener('focus', function(e) {
      console.log('üëÅÔ∏è Campo de peso recebeu foco');
    });
    
    // Listener para detectar quando o campo perde foco
    pesoInputAtual.addEventListener('blur', function(e) {
      const valor = e.target.value;
      console.log('üëÅÔ∏è Campo de peso perdeu foco. Valor final:', valor);
    });
    
    // Listener para Enter (gravar diretamente)
    pesoInputAtual.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        console.log('‚å®Ô∏è Enter pressionado no campo de peso!');
        e.preventDefault();
        if (gravarBtn && typeof window.salvarPesagemBackendV2 === 'function') {
          console.log('üíæ Disparando salvamento via Enter...');
          gravarBtn.click();
        }
      }
    });
    
    console.log('‚úÖ Listeners do campo de peso adicionados com sucesso!');
    
    // Remove TODOS os listeners anteriores do bot√£o Gravar
    const novoGravarBtn = gravarBtn.cloneNode(true);
    gravarBtn.parentNode.replaceChild(novoGravarBtn, gravarBtn);
    const gravarBtnAtual = document.getElementById('pesoGravarBtnV2');
    
    // Adiciona novo listener
    gravarBtnAtual.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üîò ========== BOT√ÉO GRAVAR CLICADO ==========');
      
      // Diagn√≥stico completo antes de salvar
      const pesoInputEl = document.getElementById('pesoValorV2');
      const brincoInputEl = document.getElementById('brincoInputV2');
      
      console.log('üìä Estado completo antes de salvar:', {
        pesoInput: {
          existe: !!pesoInputEl,
          value: pesoInputEl?.value || 'VAZIO',
          textContent: pesoInputEl?.textContent || 'VAZIO',
          innerText: pesoInputEl?.innerText || 'VAZIO'
        },
        brincoInput: {
          existe: !!brincoInputEl,
          value: brincoInputEl?.value || 'VAZIO'
        },
        animalAtual: {
          existe: !!(window.animalAtualV2 || window.currentAnimalV2),
          id: (window.animalAtualV2 || window.currentAnimalV2)?.id || 'N/A'
        },
        funcaoSalvar: typeof window.salvarPesagemBackendV2 === 'function'
      });
      
      if (!pesoInputEl) {
        console.error('‚ùå Campo de peso n√£o encontrado!');
        alert('Erro: Campo de peso n√£o encontrado. Recarregue a p√°gina.');
        return;
      }
      
      if (!brincoInputEl || !brincoInputEl.value) {
        console.error('‚ùå Brinco n√£o identificado!');
        alert('Identifique um animal primeiro.');
        return;
      }
      
      if (typeof window.salvarPesagemBackendV2 !== 'function') {
        console.error('‚ùå Fun√ß√£o salvarPesagemBackendV2 n√£o est√° dispon√≠vel!');
        console.error('üîç Fun√ß√µes dispon√≠veis em window:', Object.keys(window).filter(k => k.includes('salvar') || k.includes('pesagem')));
        alert('Erro: Fun√ß√£o de salvamento n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
        return;
      }
      
      try {
        console.log('üíæ Chamando fun√ß√£o salvarPesagemBackendV2...');
        const sucesso = await window.salvarPesagemBackendV2();
        
        if (sucesso) {
          console.log('‚úÖ Pesagem gravada com sucesso!');
          
          // Verifica se os campos foram atualizados
          setTimeout(() => {
            const pesoRegistrado = document.getElementById('pesoRegistradoV2');
            const pesoUltimo = document.getElementById('pesoUltimoValorV2');
            const pesoData = document.getElementById('pesoUltimoDataV2');
            
            console.log('üîç Verifica√ß√£o p√≥s-salvamento:', {
              pesoRegistrado: pesoRegistrado?.textContent || 'N√ÉO ATUALIZADO',
              pesoUltimo: pesoUltimo?.textContent || 'N√ÉO ATUALIZADO',
              pesoData: pesoData?.textContent || 'N√ÉO ATUALIZADO'
            });
            
            if (pesoRegistrado && pesoRegistrado.textContent === '‚Äî') {
              console.error('‚ö†Ô∏è ATEN√á√ÉO: Campo "Peso Registrado" n√£o foi atualizado!');
            }
          }, 1000);
        } else {
          console.error('‚ùå Erro ao gravar pesagem (retornou false)');
        }
      } catch (error) {
        console.error('‚ùå ERRO ao executar salvarPesagemBackendV2:', error);
        alert('Erro ao salvar pesagem: ' + error.message);
      }
    });
    
    console.log('‚úÖ Listener do bot√£o Gravar anexado com sucesso!');
    
    // Bot√£o Limpar
    if (limparBtn) {
      const novoLimparBtn = limparBtn.cloneNode(true);
      limparBtn.parentNode.replaceChild(novoLimparBtn, limparBtn);
      const limparBtnAtual = document.getElementById('pesoLimparBtnV2');
      
      limparBtnAtual.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîò Bot√£o Limpar clicado');
        const pesoInputEl = document.getElementById('pesoValorV2');
        if (pesoInputEl) {
          pesoInputEl.value = '';
          console.log('‚úÖ Campo de peso limpo');
        }
      });
      console.log('‚úÖ Listener do bot√£o Limpar anexado com sucesso!');
    } else {
      console.warn('‚ö†Ô∏è Bot√£o pesoLimparBtnV2 n√£o encontrado!');
    }
    
    console.log('‚úÖ ========== INICIALIZA√á√ÉO DE BOT√ïES CONCLU√çDA ==========');
  }

  // Inicializar todas as abas quando DOM estiver pronto
  function inicializarTudo() {
    console.log('üöÄ Iniciando todas as inicializa√ß√µes...');
    
      inicializarSanidadeV2();
      inicializarReprodutivoV2();
      inicializarMovimentacaoV2();
    
    // IMPORTANTE: Inicializar bot√µes de pesagem POR √öLTIMO para garantir que tudo est√° pronto
    console.log('‚öñÔ∏è Inicializando sistema de pesagem...');
    inicializarBotaoGravarPesagem();
    
    // Diagn√≥stico ap√≥s inicializa√ß√£o
    setTimeout(() => {
      console.log('üîç ========== DIAGN√ìSTICO P√ìS-INICIALIZA√á√ÉO ==========');
      
      const pesoInput = document.getElementById('pesoValorV2');
      const gravarBtn = document.getElementById('pesoGravarBtnV2');
      const brincoInput = document.getElementById('brincoInputV2');
      
      console.log('üìã Elementos:', {
        pesoValorV2: {
          existe: !!pesoInput,
          valor: pesoInput?.value || 'VAZIO',
          tipo: pesoInput?.type || 'N/A',
          placeholder: pesoInput?.placeholder || 'N/A'
        },
        pesoGravarBtnV2: {
          existe: !!gravarBtn,
          texto: gravarBtn?.textContent?.trim() || 'N/A',
          disabled: gravarBtn?.disabled || false
        },
        brincoInputV2: {
          existe: !!brincoInput,
          valor: brincoInput?.value || 'VAZIO'
        },
        salvarPesagemBackendV2: typeof window.salvarPesagemBackendV2 === 'function'
      });
      
      // Teste: Verificar se o campo de peso responde a eventos
      if (pesoInput) {
        console.log('üß™ Testando campo de peso...');
        pesoInput.focus();
        setTimeout(() => {
          pesoInput.blur();
          console.log('‚úÖ Campo de peso responde a focus/blur');
        }, 100);
      }
      
      // Teste: Verificar se o bot√£o Gravar tem listeners
      if (gravarBtn) {
        console.log('üß™ Verificando listeners do bot√£o Gravar...');
        // N√£o podemos verificar listeners diretamente, mas podemos testar se o bot√£o est√° clic√°vel
        console.log('‚úÖ Bot√£o Gravar encontrado e pronto para uso');
      }
      
      console.log('‚úÖ ========== FIM DO DIAGN√ìSTICO ==========');
    }, 1000);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarTudo);
  } else {
    // Se o DOM j√° est√° pronto, aguarda um pouco para garantir que todos os elementos est√£o carregados
    setTimeout(inicializarTudo, 100);
  }
} // Adicionar chave faltante

// ========== SIMULADOR COMPLETO DE REGISTRO DE ANIMAIS ==========
(function() {
  'use strict';
  
  // Dados simulados de animais
  const animaisSimulados = [];
  const racas = ['NELORE', 'ANGUS', 'BRANGUS', 'HEREFORD', 'BRAFORD', 'CANCHIM', 'TABAPU√É'];
  const sexos = ['Macho', 'F√™mea'];
  const categorias = ['Bezerro(a) 0-12 M', 'Novilho(a) 12-24 M', 'Touro', 'Vaca', 'Novilha'];
  const situacoesBND = ['CONFORME', 'NAO_CONFORME', 'ATUALIZAR'];
  const vacinas = ['Vacina Aftosa', 'Vacina Brucelose', 'Vacina Raiva', 'Vacina Clostridiose'];
  const diagnosticos = ['Prenhez Positiva', 'Prenhez Negativa', 'Vazia'];
  
  // Gerar 50 animais simulados
  for (let i = 1; i <= 50; i++) {
    const raca = racas[Math.floor(Math.random() * racas.length)];
    const sexo = sexos[Math.floor(Math.random() * sexos.length)];
    const categoria = categorias[Math.floor(Math.random() * categorias.length)];
    const dataNasc = new Date(2023 + Math.floor(Math.random() * 3), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
    const pesoBase = 200 + Math.floor(Math.random() * 400); // Peso entre 200-600 kg
    const pesoVariacao = Math.floor(Math.random() * 50) - 25; // Varia√ß√£o de ¬±25kg
    const peso = pesoBase + pesoVariacao;
    
    animaisSimulados.push({
      id: 1000 + i,
      numero_brinco: `105500376195${String(100 + i).padStart(3, '0')}`,
      codigo_sisbov: `105500376195${String(100 + i).padStart(3, '0')}`,
      codigo_eletronico: `ELE${String(i).padStart(4, '0')}`,
      numero_manejo: String(619500 + i),
      raca: raca,
      sexo: sexo,
      categoria: categoria,
      data_nascimento: dataNasc.toLocaleDateString('pt-BR'),
      data_nascimento_format: dataNasc.toISOString().split('T')[0],
      peso_atual: peso,
      lote_atual: `Lote ${Math.floor(Math.random() * 5) + 1}`,
      situacao_bnd: situacoesBND[Math.floor(Math.random() * situacoesBND.length)],
      consta_bnd: Math.random() > 0.3,
      status_reprodutivo: sexo === 'F√™mea' ? diagnosticos[Math.floor(Math.random() * diagnosticos.length)] : 'Vazia'
    });
  }
  
  let simuladorAtivo = false;
  let simuladorPausado = false;
  let registroAtual = 0;
  let logsSimulador = [];
  
  // Fun√ß√£o para adicionar log
  function adicionarLog(mensagem, tipo = 'info') {
    const timestamp = new Date().toLocaleTimeString('pt-BR');
    const log = `[${timestamp}] ${mensagem}`;
    logsSimulador.push({ timestamp, mensagem, tipo });
    console.log(`üìã [SIMULADOR] ${log}`);
    
    // Atualizar status visual
    const statusText = document.getElementById('simuladorStatusText');
    if (statusText) {
      statusText.textContent = mensagem;
      statusText.style.color = tipo === 'erro' ? '#d32f2f' : tipo === 'sucesso' ? '#388e3c' : '#666';
    }
  }
  
  // Fun√ß√£o para aguardar (com pausa opcional)
  function aguardar(ms) {
    return new Promise(resolve => {
      if (simuladorPausado) {
        const checkPause = setInterval(() => {
          if (!simuladorPausado) {
            clearInterval(checkPause);
            setTimeout(resolve, ms);
          }
        }, 100);
      } else {
        setTimeout(resolve, ms);
      }
    });
  }
  
  // Fun√ß√£o para simular digita√ß√£o
  async function simularDigitacao(elemento, texto, velocidade = 50) {
    if (!elemento) return;
    
    elemento.focus();
    elemento.value = '';
    
    for (let i = 0; i < texto.length; i++) {
      if (simuladorPausado) await aguardar(100);
      elemento.value += texto[i];
      elemento.dispatchEvent(new Event('input', { bubbles: true }));
      await aguardar(velocidade);
    }
    
    elemento.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  // Fun√ß√£o para capturar screenshot (usando html2canvas se dispon√≠vel)
  async function capturarScreenshot(nome) {
    try {
      if (typeof html2canvas !== 'undefined') {
        const canvas = await html2canvas(document.body, {
          logging: false,
          useCORS: true,
          scale: 0.5
        });
        const dataUrl = canvas.toDataURL('image/png');
        
        // Criar link de download
        const link = document.createElement('a');
        link.download = `simulador_${nome}_${Date.now()}.png`;
        link.href = dataUrl;
        link.click();
        
        adicionarLog(`Screenshot capturado: ${nome}`, 'sucesso');
      } else {
        adicionarLog('html2canvas n√£o dispon√≠vel. Instale: https://html2canvas.hertzen.com/', 'erro');
      }
    } catch (error) {
      adicionarLog(`Erro ao capturar screenshot: ${error.message}`, 'erro');
    }
  }
  
  // Fun√ß√£o principal do simulador (sobrescreve o stub inicial)
  const executarSimuladorCompleto = async function() {
    console.log('üöÄ [EXECUTAR SIMULADOR] Fun√ß√£o chamada!');
    console.log('üîç [EXECUTAR SIMULADOR] simuladorAtivo:', simuladorAtivo);
    
    if (simuladorAtivo) {
      console.warn('‚ö†Ô∏è [EXECUTAR SIMULADOR] Simulador j√° est√° em execu√ß√£o!');
      adicionarLog('Simulador j√° est√° em execu√ß√£o!', 'erro');
      return;
    }
    
    simuladorAtivo = true;
    simuladorPausado = false;
    registroAtual = 0;
    logsSimulador = [];
    
    const btnSimulador = document.getElementById('btnSimuladorCompleto');
    const statusDiv = document.getElementById('simuladorStatus');
    const progressBar = document.getElementById('simuladorProgress');
    
    if (btnSimulador) {
      btnSimulador.disabled = true;
      btnSimulador.innerHTML = '<i class="fas fa-stop-circle"></i> <span>Simulador em Execu√ß√£o...</span>';
    }
    
    if (statusDiv) statusDiv.style.display = 'block';
    
    adicionarLog('üöÄ Simulador iniciado! Processando 50 registros...', 'info');
    
    // Capturar screenshot inicial
    await capturarScreenshot('inicio');
    await aguardar(1000);
    
    try {
      for (let i = 0; i < animaisSimulados.length; i++) {
        if (!simuladorAtivo) break;
        
        registroAtual = i + 1;
        const animal = animaisSimulados[i];
        
        adicionarLog(`üìã Registro ${registroAtual}/50: Processando animal ${animal.numero_brinco}`, 'info');
        
        // Atualizar progresso
        if (progressBar) {
          progressBar.style.width = `${(registroAtual / 50) * 100}%`;
          progressBar.textContent = `${registroAtual}/50`;
        }
        
        // 1. Limpar campos anteriores
        const brincoInput = document.getElementById('brincoInputV2');
        const pesoInput = document.getElementById('pesoValorV2');
        
        if (brincoInput) brincoInput.value = '';
        if (pesoInput) pesoInput.value = '';
        
        await aguardar(500);
        
        // 2. Simular leitura do brinco
        adicionarLog(`üîç Lendo brinco: ${animal.numero_brinco}`, 'info');
        await simularDigitacao(brincoInput, animal.numero_brinco, 80);
        await aguardar(800);
        
        // 3. Clicar no bot√£o buscar ou chamar fun√ß√£o diretamente
        adicionarLog('üîç Buscando animal no sistema...', 'info');
        if (typeof window.buscarBrincoSimples === 'function') {
          await window.buscarBrincoSimples();
        } else {
          const btnBuscar = document.getElementById('btnBuscarBrinco');
          if (btnBuscar) {
            btnBuscar.click();
          }
        }
        
        // 4. Aguardar carregamento dos dados do animal (verificar m√∫ltiplas vezes)
        let animalCarregado = false;
        for (let tentativa = 0; tentativa < 10; tentativa++) {
          await aguardar(500);
          const animalResumo = document.getElementById('scannerAnimalResumoV2');
          const sisbovValue = document.getElementById('scannerSisbovV2');
          
          if (animalResumo && sisbovValue && sisbovValue.textContent !== '‚Äî' && sisbovValue.textContent.trim() !== '') {
            animalCarregado = true;
            break;
          }
        }
        
        if (!animalCarregado) {
          adicionarLog(`‚ö†Ô∏è Animal ${animal.numero_brinco} n√£o encontrado ou n√£o carregou, pulando...`, 'erro');
          await aguardar(1000);
          continue;
        }
        
        adicionarLog(`‚úÖ Animal encontrado: ${animal.raca} ${animal.sexo}`, 'sucesso');
        await aguardar(1500);
        
        // 5. Aguardar campo de peso estar habilitado
        let pesoHabilitado = false;
        for (let tentativa = 0; tentativa < 10; tentativa++) {
          await aguardar(300);
          if (pesoInput && !pesoInput.disabled) {
            pesoHabilitado = true;
            break;
          }
        }
        
        if (!pesoHabilitado) {
          adicionarLog('‚ö†Ô∏è Campo de peso n√£o foi habilitado, tentando continuar...', 'erro');
        }
        
        // 6. Preencher peso
        const pesoAleatorio = animal.peso_atual + Math.floor(Math.random() * 20) - 10;
        adicionarLog(`‚öñÔ∏è Registrando peso: ${pesoAleatorio} kg`, 'info');
        if (pesoInput) {
          pesoInput.focus();
          await aguardar(300);
          await simularDigitacao(pesoInput, String(pesoAleatorio), 60);
          pesoInput.dispatchEvent(new Event('input', { bubbles: true }));
          await aguardar(1000);
        }
        
        // 7. Selecionar manejos aleat√≥rios (30% de chance)
        if (Math.random() > 0.7) {
          // Selecionar vacina
          const vacinasBtns = document.querySelectorAll('.sanidade-rapida-btn-v2');
          if (vacinasBtns.length > 0) {
            const vacinaAleatoria = vacinasBtns[Math.floor(Math.random() * Math.min(vacinasBtns.length, 3))];
            if (vacinaAleatoria) {
              vacinaAleatoria.click();
              adicionarLog(`üíâ Vacina selecionada: ${vacinaAleatoria.textContent.trim()}`, 'info');
              await aguardar(800);
            }
          }
        }
        
        if (Math.random() > 0.7 && animal.sexo === 'F√™mea') {
          // Selecionar diagn√≥stico reprodutivo
          const diagnosticosBtns = document.querySelectorAll('.reprodutivo-diagnostico-btn-v2');
          if (diagnosticosBtns.length > 0) {
            const diagnosticoAleatorio = diagnosticosBtns[Math.floor(Math.random() * diagnosticosBtns.length)];
            if (diagnosticoAleatorio) {
              diagnosticoAleatorio.click();
              adicionarLog(`üî¨ Diagn√≥stico selecionado: ${diagnosticoAleatorio.textContent.trim()}`, 'info');
              await aguardar(800);
            }
          }
        }
        
        await aguardar(1000);
        
        // 8. Aguardar bot√£o Finalizar e Gravar estar habilitado
        let btnFinalizarHabilitado = false;
        for (let tentativa = 0; tentativa < 10; tentativa++) {
          await aguardar(300);
          const btnFinalizar = document.getElementById('btnFinalizarGravarV2');
          if (btnFinalizar && !btnFinalizar.disabled) {
            btnFinalizarHabilitado = true;
            break;
          }
        }
        
        // 9. Clicar em "Finalizar e Gravar"
        adicionarLog('üíæ Gravando registro...', 'info');
        const btnFinalizar = document.getElementById('btnFinalizarGravarV2');
        if (btnFinalizar && !btnFinalizar.disabled) {
          if (typeof window.finalizarEGravarManejos === 'function') {
            await window.finalizarEGravarManejos();
          } else {
            btnFinalizar.click();
          }
          await aguardar(3000); // Aguardar grava√ß√£o completa
          adicionarLog(`‚úÖ Registro ${registroAtual} gravado com sucesso!`, 'sucesso');
        } else {
          adicionarLog('‚ö†Ô∏è Bot√£o Finalizar e Gravar n√£o dispon√≠vel, tentando gravar apenas peso...', 'erro');
          // Tentar gravar apenas o peso
          const btnGravar = document.getElementById('pesoGravarBtnV2');
          if (btnGravar && !btnGravar.disabled) {
            if (typeof window.gravarPesagemDireto === 'function') {
              await window.gravarPesagemDireto();
              await aguardar(2000);
            } else {
              btnGravar.click();
              await aguardar(2000);
            }
            adicionarLog(`‚úÖ Peso gravado para registro ${registroAtual}`, 'sucesso');
          }
        }
        
        // 10. Capturar screenshot a cada 10 registros
        if (registroAtual % 10 === 0) {
          await capturarScreenshot(`registro_${registroAtual}`);
          await aguardar(500);
        }
        
        // 11. Pausa entre registros (mais tempo para visualiza√ß√£o)
        await aguardar(2000);
      }
      
      // Capturar screenshot final
      await capturarScreenshot('final');
      
      adicionarLog('üéâ Simulador conclu√≠do! 50 registros processados.', 'sucesso');
      
      // Gerar relat√≥rio de logs
      const relatorio = logsSimulador.map(log => `${log.timestamp} - ${log.mensagem}`).join('\n');
      console.log('üìä RELAT√ìRIO COMPLETO DO SIMULADOR:\n' + relatorio);
      
      // Criar arquivo de log para download
      const blob = new Blob([relatorio], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = `simulador_logs_${Date.now()}.txt`;
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      
    } catch (error) {
      adicionarLog(`‚ùå Erro no simulador: ${error.message}`, 'erro');
      console.error('Erro no simulador:', error);
    } finally {
      simuladorAtivo = false;
      
      if (btnSimulador) {
        btnSimulador.disabled = false;
        btnSimulador.innerHTML = '<i class="fas fa-play-circle"></i> <span>Iniciar Simulador Completo (50 Registros)</span>';
      }
    }
  }
  
  // Inicializar bot√£o do simulador
  function inicializarSimulador() {
    console.log('üîß Tentando inicializar simulador...');
    const btnSimulador = document.getElementById('btnSimuladorCompleto');
    if (btnSimulador) {
      // Remover listeners anteriores
      const novoBtn = btnSimulador.cloneNode(true);
      btnSimulador.parentNode.replaceChild(novoBtn, btnSimulador);
      const btnAtual = document.getElementById('btnSimuladorCompleto');
      
      // Adicionar listener
      btnAtual.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîò Bot√£o do simulador clicado!');
        
        if (simuladorAtivo) {
          alert('Simulador j√° est√° em execu√ß√£o!');
          return;
        }
        
        if (confirm('Deseja iniciar o simulador completo? Ele processar√° 50 registros de animais automaticamente.\n\n‚ö†Ô∏è ATEN√á√ÉO: O simulador ir√°:\n- Processar 50 animais\n- Gravar registros reais no sistema\n- Capturar screenshots\n- Gerar logs detalhados')) {
          console.log('‚úÖ Iniciando simulador...');
          if (typeof window.executarSimulador === 'function') {
            window.executarSimulador();
          } else {
            alert('Erro: Fun√ß√£o do simulador n√£o dispon√≠vel. Recarregue a p√°gina.');
            console.error('Fun√ß√£o executarSimulador n√£o encontrada!');
          }
        }
      });
      
      // Tamb√©m adicionar onclick direto como fallback
      btnAtual.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîò Bot√£o do simulador clicado (onclick)!');
        
        if (simuladorAtivo) {
          alert('Simulador j√° est√° em execu√ß√£o!');
          return;
        }
        
        if (confirm('Deseja iniciar o simulador completo? Ele processar√° 50 registros de animais automaticamente.\n\n‚ö†Ô∏è ATEN√á√ÉO: O simulador ir√°:\n- Processar 50 animais\n- Gravar registros reais no sistema\n- Capturar screenshots\n- Gerar logs detalhados')) {
          console.log('‚úÖ Iniciando simulador...');
          if (typeof window.executarSimulador === 'function') {
            window.executarSimulador();
          } else {
            alert('Erro: Fun√ß√£o do simulador n√£o dispon√≠vel. Recarregue a p√°gina.');
            console.error('Fun√ß√£o executarSimulador n√£o encontrada!');
          }
        }
      };
      
      console.log('‚úÖ Simulador completo inicializado! Bot√£o encontrado e configurado.');
    } else {
      console.error('‚ùå Bot√£o btnSimuladorCompleto n√£o encontrado!');
      // Tentar novamente ap√≥s um tempo
      setTimeout(inicializarSimulador, 1000);
    }
  }
  
  // Carregar html2canvas via CDN se n√£o estiver dispon√≠vel
  if (typeof html2canvas === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = function() {
      console.log('‚úÖ html2canvas carregado para captura de screenshots');
    };
    script.onerror = function() {
      console.warn('‚ö†Ô∏è Erro ao carregar html2canvas. Screenshots podem n√£o funcionar.');
    };
    document.head.appendChild(script);
  }
  
  // Inicializar quando DOM estiver pronto (m√∫ltiplas tentativas)
  function tentarInicializar() {
    const btnSimulador = document.getElementById('btnSimuladorCompleto');
    if (btnSimulador) {
      inicializarSimulador();
    } else {
      console.log('‚è≥ Bot√£o ainda n√£o encontrado, tentando novamente...');
      setTimeout(tentarInicializar, 500);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(tentarInicializar, 500);
    });
  } else {
    setTimeout(tentarInicializar, 500);
    setTimeout(tentarInicializar, 1500);
    setTimeout(tentarInicializar, 3000);
  }
  
  // Tornar fun√ß√µes globais (executarSimulador j√° foi atribu√≠do acima)
  window.pararSimulador = function() {
    simuladorAtivo = false;
    if (typeof adicionarLog === 'function') {
      adicionarLog('‚èπÔ∏è Simulador interrompido pelo usu√°rio', 'info');
    } else {
      console.log('‚èπÔ∏è Simulador interrompido pelo usu√°rio');
    }
  };
  window.inicializarSimulador = inicializarSimulador;
  
  console.log('‚úÖ M√≥dulo do simulador carregado! Fun√ß√£o executarSimulador dispon√≠vel globalmente.');
  console.log('üîç Verifica√ß√£o final:', typeof window.executarSimulador, window.executarSimulador ? 'FUN√á√ÉO OK ‚úÖ' : 'ERRO ‚ùå');
  
  // Teste final para garantir que est√° funcionando
  setTimeout(() => {
    if (typeof window.executarSimulador === 'function') {
      console.log('‚úÖ TESTE FINAL: window.executarSimulador est√° dispon√≠vel e funcionando!');
    } else {
      console.error('‚ùå TESTE FINAL: window.executarSimulador N√ÉO est√° dispon√≠vel!');
    }
  }, 1000);
  
})();

// ========== FUN√á√ÉO GLOBAL PARA TESTE MANUAL ==========
// Execute no console: window.testarPesagem()
window.testarPesagem = function() {
  console.log('üß™ ========== TESTE MANUAL DE PESAGEM ==========');
  
  const elementos = {
    pesoValorV2: document.getElementById('pesoValorV2'),
    pesoGravarBtnV2: document.getElementById('pesoGravarBtnV2'),
    pesoRegistradoV2: document.getElementById('pesoRegistradoV2'),
    pesoUltimoValorV2: document.getElementById('pesoUltimoValorV2'),
    pesoUltimoDataV2: document.getElementById('pesoUltimoDataV2'),
    pesoDiasV2: document.getElementById('pesoDiasV2'),
    pesoGanhoTotalV2: document.getElementById('pesoGanhoTotalV2'),
    pesoGanhoDiaV2: document.getElementById('pesoGanhoDiaV2'),
    brincoInputV2: document.getElementById('brincoInputV2')
  };
  
  console.log('üìã Status dos elementos:', Object.keys(elementos).map(key => ({
    id: key,
    existe: !!elementos[key],
    valor: elementos[key] ? (elementos[key].value || elementos[key].textContent || elementos[key].innerText || 'VAZIO') : 'N√ÉO EXISTE',
    visivel: elementos[key] ? (elementos[key].offsetParent !== null) : false
  })));
  
  // Teste de atualiza√ß√£o visual
  if (elementos.pesoRegistradoV2) {
    console.log('üß™ Testando atualiza√ß√£o visual do campo "Peso Registrado"...');
    const valorTeste = 'TESTE 999,0 kg';
    elementos.pesoRegistradoV2.textContent = valorTeste;
    elementos.pesoRegistradoV2.innerText = valorTeste;
    elementos.pesoRegistradoV2.style.color = '#4caf50';
    elementos.pesoRegistradoV2.offsetHeight; // For√ßa reflow
    
    setTimeout(() => {
      const valorAtual = elementos.pesoRegistradoV2.textContent;
      if (valorAtual === valorTeste) {
        console.log('‚úÖ Campo "Peso Registrado" est√° sendo atualizado corretamente!');
      } else {
        console.error('‚ùå Campo "Peso Registrado" N√ÉO est√° sendo atualizado! Valor esperado:', valorTeste, 'Valor atual:', valorAtual);
      }
    }, 100);
  }
  
  console.log('‚úÖ ========== FIM DO TESTE ==========');
  return elementos;
};

// ========== LISTENER DIRETO NO BOT√ÉO GRAVAR (FALLBACK) ==========
// Este c√≥digo executa IMEDIATAMENTE, mesmo se houver erros em outros scripts
(function() {
  'use strict';
  
  function inicializarBotaoGravarDireto() {
    // Aguarda o DOM estar pronto
    function tentarInicializar() {
      const gravarBtn = document.getElementById('pesoGravarBtnV2');
      const pesoInput = document.getElementById('pesoValorV2');
      
      if (gravarBtn && pesoInput) {
        console.log('üîß [FALLBACK] Inicializando bot√£o Gravar diretamente...');
        
        // Remove listeners anteriores
        const novoBtn = gravarBtn.cloneNode(true);
        gravarBtn.parentNode.replaceChild(novoBtn, gravarBtn);
        const btnAtual = document.getElementById('pesoGravarBtnV2');
        
        // Adiciona listener direto
        btnAtual.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('üîò [FALLBACK] Bot√£o Gravar clicado!');
          
          const peso = document.getElementById('pesoValorV2')?.value;
          const brinco = document.getElementById('brincoInputV2')?.value;
          
          console.log('üìä [FALLBACK] Dados:', { peso, brinco });
          
          if (!peso || !brinco) {
            alert('Preencha o brinco e o peso antes de gravar.');
            return;
          }
          
          // Chama fun√ß√£o de salvar se existir
          if (typeof window.salvarPesagemBackendV2 === 'function') {
            console.log('üíæ [FALLBACK] Chamando salvarPesagemBackendV2...');
            try {
              const sucesso = await window.salvarPesagemBackendV2();
              if (sucesso) {
                console.log('‚úÖ [FALLBACK] Pesagem salva com sucesso!');
              }
            } catch (error) {
              console.error('‚ùå [FALLBACK] Erro ao salvar:', error);
              alert('Erro ao salvar pesagem: ' + error.message);
            }
          } else {
            console.error('‚ùå [FALLBACK] Fun√ß√£o salvarPesagemBackendV2 n√£o encontrada!');
            alert('Erro: Fun√ß√£o de salvamento n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
          }
        });
        
        console.log('‚úÖ [FALLBACK] Bot√£o Gravar inicializado com sucesso!');
        return true;
      }
      return false;
    }
    
    // Tenta inicializar imediatamente
    if (tentarInicializar()) {
      return;
    }
    
    // Se n√£o conseguiu, tenta quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(tentarInicializar, 100);
      });
    } else {
      setTimeout(tentarInicializar, 100);
    }
    
    // Tenta novamente ap√≥s 1 segundo (fallback)
    setTimeout(function() {
      if (!document.getElementById('pesoGravarBtnV2')?.onclick) {
        tentarInicializar();
      }
    }, 1000);
  }
  
  // Executa imediatamente
  inicializarBotaoGravarDireto();
})();

// ========== SOLU√á√ÉO √öNICA E DEFINITIVA PARA OS BOT√ïES ==========
// Remove TODOS os listeners anteriores e anexa apenas UM listener funcional
(function() {
  'use strict';
  
  console.log('üîß ========== INICIALIZA√á√ÉO √öNICA DOS BOT√ïES ==========');
  
  let botaoGravarInicializado = false;
  let botaoLimparInicializado = false;
  
  function inicializarBotoesDefinitivo() {
    // ========== BOT√ÉO GRAVAR ==========
    const btnGravar = document.getElementById('pesoGravarBtnV2');
    if (btnGravar && !botaoGravarInicializado) {
      console.log('‚úÖ Bot√£o Gravar encontrado! Inicializando...');
      
      // Remove TODOS os listeners anteriores de forma definitiva
      const novoBtnGravar = btnGravar.cloneNode(true);
      btnGravar.parentNode.replaceChild(novoBtnGravar, btnGravar);
      const btnGravarAtual = document.getElementById('pesoGravarBtnV2');
      
      // Remove qualquer onclick anterior
      btnGravarAtual.onclick = null;
      btnGravarAtual.removeAttribute('onclick');
      
      // Listener √öNICO e DEFINITIVO
      btnGravarAtual.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation(); // Impede outros listeners
        
        console.log('üîòüîòüîò BOT√ÉO GRAVAR CLICADO! üîòüîòüîò');
        
        const pesoInput = document.getElementById('pesoValorV2');
        const brincoInput = document.getElementById('brincoInputV2');
        
        if (!pesoInput || !brincoInput) {
          console.error('‚ùå Campos n√£o encontrados!');
          alert('Erro: Campos n√£o encontrados. Recarregue a p√°gina.');
          return;
        }
        
        // Captura o peso de m√∫ltiplas formas para garantir
        let peso = '';
        if (pesoInput) {
          // Tenta ler do value primeiro
          peso = pesoInput.value || pesoInput.textContent || pesoInput.innerText || '';
          peso = peso.toString().trim();
          
          // Remove "kg" se estiver presente
          peso = peso.replace(/kg/gi, '').replace(/\s/g, '').trim();
          
          console.log('üìä Peso capturado (raw):', {
            value: pesoInput.value,
            textContent: pesoInput.textContent,
            innerText: pesoInput.innerText,
            pesoFinal: peso
          });
        }
        
        const brinco = brincoInput ? brincoInput.value.trim() : '';
        
        console.log('üìä Dados capturados:', { peso, brinco });
        
        // Valida peso
        if (!peso || peso === '' || peso === '0') {
          alert('Informe um peso v√°lido antes de gravar.');
          if (pesoInput) pesoInput.focus();
          return;
        }
        
        // Converte para n√∫mero
        const pesoNumero = parseFloat(peso.replace(',', '.'));
        if (isNaN(pesoNumero) || pesoNumero <= 0) {
          alert('O peso deve ser um n√∫mero maior que zero.');
          if (pesoInput) pesoInput.focus();
          return;
        }
        
        console.log('‚úÖ Peso validado:', pesoNumero);
        
        if (!brinco) {
          alert('Identifique um animal primeiro.');
          brincoInput.focus();
          return;
        }
        
        // Chama fun√ß√£o de salvar
        if (typeof window.salvarPesagemBackendV2 === 'function') {
          console.log('üíæ Chamando salvarPesagemBackendV2...');
          try {
            const resultado = await window.salvarPesagemBackendV2();
            if (resultado) {
              console.log('‚úÖ Pesagem salva com sucesso!');
            } else {
              console.error('‚ùå Falha ao salvar pesagem');
            }
          } catch (error) {
            console.error('‚ùå Erro ao salvar:', error);
            alert('Erro ao salvar pesagem: ' + (error.message || 'Erro desconhecido'));
          }
        } else {
          console.error('‚ùå Fun√ß√£o salvarPesagemBackendV2 n√£o encontrada!');
          alert('Erro: Fun√ß√£o de salvamento n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
        }
      }, { once: false, capture: true });
      
      botaoGravarInicializado = true;
      console.log('‚úÖ‚úÖ‚úÖ Bot√£o Gravar inicializado com SUCESSO! ‚úÖ‚úÖ‚úÖ');
    }
    
    // ========== BOT√ÉO LIMPAR ==========
    const btnLimpar = document.getElementById('pesoLimparBtnV2');
    if (btnLimpar && !botaoLimparInicializado) {
      console.log('‚úÖ Bot√£o Limpar encontrado! Inicializando...');
      
      // Remove TODOS os listeners anteriores
      const novoBtnLimpar = btnLimpar.cloneNode(true);
      btnLimpar.parentNode.replaceChild(novoBtnLimpar, btnLimpar);
      const btnLimparAtual = document.getElementById('pesoLimparBtnV2');
      
      // Remove qualquer onclick anterior
      btnLimparAtual.onclick = null;
      btnLimparAtual.removeAttribute('onclick');
      
      // Listener √öNICO e DEFINITIVO
      btnLimparAtual.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        console.log('üîò Bot√£o Limpar clicado!');
        
        const pesoInput = document.getElementById('pesoValorV2');
        if (pesoInput) {
          pesoInput.value = '';
          pesoInput.focus();
          console.log('‚úÖ Campo de peso limpo');
        }
      }, { once: false, capture: true });
      
      botaoLimparInicializado = true;
      console.log('‚úÖ‚úÖ‚úÖ Bot√£o Limpar inicializado com SUCESSO! ‚úÖ‚úÖ‚úÖ');
    }
    
    if (botaoGravarInicializado && botaoLimparInicializado) {
      console.log('‚úÖ‚úÖ‚úÖ AMBOS OS BOT√ïES INICIALIZADOS COM SUCESSO! ‚úÖ‚úÖ‚úÖ');
    }
  }
  
  // Tenta inicializar imediatamente
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      inicializarBotoesDefinitivo();
      setTimeout(inicializarBotoesDefinitivo, 500);
      setTimeout(inicializarBotoesDefinitivo, 1000);
    });
  } else {
    inicializarBotoesDefinitivo();
    setTimeout(inicializarBotoesDefinitivo, 500);
    setTimeout(inicializarBotoesDefinitivo, 1000);
  }
  
  console.log('üîß ========== FIM DA INICIALIZA√á√ÉO DOS BOT√ïES ==========');
})();

// Fun√ß√£o j√° definida no in√≠cio do script - n√£o duplicar

// ========== SCRIPT DE DIAGN√ìSTICO GLOBAL (executa imediatamente) ==========
(function() {
  'use strict';
  
  console.log('üîç ========== DIAGN√ìSTICO INICIAL DO SISTEMA ==========');
  
  // Verifica se elementos existem
  function verificarElementos() {
    const elementos = {
      pesoGravarBtnV2: document.getElementById('pesoGravarBtnV2'),
      pesoLimparBtnV2: document.getElementById('pesoLimparBtnV2'),
      pesoValorV2: document.getElementById('pesoValorV2'),
      brincoInputV2: document.getElementById('brincoInputV2'),
      pesoRegistradoV2: document.getElementById('pesoRegistradoV2'),
      pesoUltimoValorV2: document.getElementById('pesoUltimoValorV2'),
      pesoUltimoDataV2: document.getElementById('pesoUltimoDataV2'),
      pesoDiasV2: document.getElementById('pesoDiasV2'),
      pesoGanhoTotalV2: document.getElementById('pesoGanhoTotalV2'),
      pesoGanhoDiaV2: document.getElementById('pesoGanhoDiaV2')
    };
    
    console.log('üìã Status dos elementos:', Object.keys(elementos).map(key => ({
      id: key,
      existe: !!elementos[key],
      valor: elementos[key] ? (elementos[key].value || elementos[key].textContent || 'N/A') : 'N√ÉO EXISTE'
    })));
    
    return elementos;
  }
  
  // Verifica fun√ß√£o de salvar
  function verificarFuncoes() {
    console.log('üîß Fun√ß√µes dispon√≠veis:', {
      salvarPesagemBackendV2: typeof window.salvarPesagemBackendV2 === 'function',
      atualizarResumoPesagemV2: typeof window.atualizarResumoPesagemV2 === 'function',
      atualizarScannerResumoV2: typeof window.atualizarScannerResumoV2 === 'function',
      atualizarInfoPesagem: typeof atualizarInfoPesagem === 'function'
    });
  }
  
  // Executa verifica√ß√£o imediata
  if (document.readyState === 'complete') {
    verificarElementos();
    verificarFuncoes();
  } else {
    window.addEventListener('load', function() {
      setTimeout(() => {
        verificarElementos();
        verificarFuncoes();
      }, 500);
    });
  }
  
  // Tamb√©m verifica quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        verificarElementos();
        verificarFuncoes();
      }, 500);
    });
  } else {
    setTimeout(() => {
      verificarElementos();
      verificarFuncoes();
    }, 500);
  }
  
  console.log('‚úÖ ========== DIAGN√ìSTICO INICIAL CONCLU√çDO ==========');
})();
</script>

<!-- Modal de Cadastro de Trabalho no Curral - Lazy Loading -->
<div class="modal fade" id="modalCadastroTrabalho" tabindex="-1" aria-labelledby="modalCadastroTrabalhoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" data-sessao-ativa="{% if stats_sessao.sessao_ativa %}true{% else %}false{% endif %}" loading="lazy">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalCadastroTrabalhoLabel">
          <i class="bi bi-clipboard-plus"></i> Cadastrar Trabalho no Curral
        </h5>
      </div>
      <form id="formCadastroTrabalho">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="trabalhoData" class="form-label">
                <i class="bi bi-calendar"></i> Data <span class="text-danger">*</span>
              </label>
              <input type="date" class="form-control" id="trabalhoData" required>
            </div>
            
            <div class="col-md-6">
              <label for="trabalhoId" class="form-label">
                <i class="bi bi-hash"></i> ID
              </label>
              <input type="text" class="form-control" id="trabalhoId" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
              <small class="text-muted">ID gerado automaticamente</small>
            </div>
            
            <div class="col-12">
              <label for="trabalhoDescricao" class="form-label">
                <i class="bi bi-card-text"></i> Descri√ß√£o <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" id="trabalhoDescricao" placeholder="Ex: Pesagem de Rotina" required>
            </div>
            
            <div class="col-md-6">
              <label for="trabalhoQuantidade" class="form-label">
                <i class="bi bi-123"></i> Quantidade de Animais
              </label>
              <input type="number" class="form-control" id="trabalhoQuantidade" placeholder="Quantidade esperada (opcional)" min="1">
            </div>
            
            <div class="col-12">
              <label for="trabalhoObservacoes" class="form-label">
                <i class="bi bi-pencil"></i> Observa√ß√µes
              </label>
              <textarea class="form-control" id="trabalhoObservacoes" rows="3" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelarTrabalho">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="btnSalvarTrabalho">
            <i class="bi bi-check-circle"></i> Criar Trabalho
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
#modalCadastroTrabalho .modal-content {
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

#modalCadastroTrabalho .modal-header {
  border-radius: 12px 12px 0 0;
  border-bottom: none;
}

#modalCadastroTrabalho .form-label {
  font-weight: 500;
  color: #2c3e50;
  margin-bottom: 0.5rem;
}

#modalCadastroTrabalho .form-control,
#modalCadastroTrabalho .form-select {
  border-radius: 8px;
  border: 1px solid #ddd;
  padding: 0.75rem;
}

#modalCadastroTrabalho .form-control:focus,
#modalCadastroTrabalho .form-select:focus {
  border-color: #1e3a5f;
  box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
}

#modalCadastroTrabalho .btn-primary {
  background: #1e3a5f;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
}

#modalCadastroTrabalho .btn-primary:hover {
  background: #2d5082;
}

#modalCadastroTrabalho .form-check-card {
  transition: all 0.2s ease;
  cursor: pointer;
}

#modalCadastroTrabalho .form-check-card:hover {
  background-color: #f8f9fa;
  border-color: #1e3a5f !important;
}

#modalCadastroTrabalho .form-check-card .form-check-input:checked ~ .form-check-label {
  color: #1e3a5f;
}

#modalCadastroTrabalho .form-check-card .form-check-input {
  margin-top: 0.5rem;
  cursor: pointer;
}

#modalCadastroTrabalho .form-check-card .form-check-input:checked {
  background-color: #1e3a5f;
  border-color: #1e3a5f;
}
</style>

<script>
// Otimiza√ß√£o: Modal lazy loading - carrega apenas quando necess√°rio
(function() {
  'use strict';
  
  // Fun√ß√£o otimizada para mostrar modal
  function mostrarModalCadastro() {
    const modalElement = document.getElementById('modalCadastroTrabalho');
    if (!modalElement) return;
    
    // Usar requestIdleCallback para n√£o bloquear renderiza√ß√£o
    const showModal = () => {
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
      
      // Preencher data atual
      const dataInput = document.getElementById('trabalhoData');
      if (dataInput) {
        dataInput.value = new Date().toISOString().split('T')[0];
      }
      
      // Focar no campo nome ap√≥s anima√ß√£o
      requestAnimationFrame(() => {
        const descricaoInput = document.getElementById('trabalhoDescricao');
        if (descricaoInput) descricaoInput.focus();
      });
    };
    
    if ('requestIdleCallback' in window) {
      requestIdleCallback(showModal, { timeout: 300 });
    } else {
      setTimeout(showModal, 100);
    }
  }
  
  // Verificar se h√° sess√£o ativa
  const modalElement = document.getElementById('modalCadastroTrabalho');
  const sessaoAtiva = modalElement ? modalElement.getAttribute('data-sessao-ativa') === 'true' : false;
  
  // Se n√£o houver sess√£o ativa, mostrar modal
  if (!sessaoAtiva && modalElement) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', mostrarModalCadastro, { once: true });
    } else {
      // DOM j√° est√° pronto - usar requestIdleCallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(mostrarModalCadastro, { timeout: 200 });
      } else {
        setTimeout(mostrarModalCadastro, 50);
      }
    }
  }
  
  // Adicionar interatividade aos cards de checkbox
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modalCadastroTrabalho');
    if (modal) {
      // Adicionar evento de clique nos cards para melhor UX
      modal.querySelectorAll('.form-check-card').forEach(card => {
        card.addEventListener('click', function(e) {
          // N√£o disparar se clicar diretamente no checkbox
          if (e.target.type === 'checkbox') return;
          
          const checkbox = this.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });
      });
      
      // Gerenciar exibi√ß√£o dos campos de tipo quando checkboxes s√£o marcados
      const pesagemCheck = document.getElementById('trabalhoManejoPesagemCheck');
      const vacinaCheck = document.getElementById('trabalhoManejoVacinaCheck');
      const reproducaoCheck = document.getElementById('trabalhoManejoReproducaoCheck');
      const movimentacaoCheck = document.getElementById('trabalhoManejoMovimentacaoCheck');
      
      const pesagemContainer = document.getElementById('trabalhoTipoPesagemContainer');
      const vacinaContainer = document.getElementById('trabalhoTipoVacinaContainer');
      const reproducaoContainer = document.getElementById('trabalhoTipoReproducaoContainer');
      const movimentacaoContainer = document.getElementById('trabalhoTipoMovimentacaoContainer');
      
      if (pesagemCheck && pesagemContainer) {
        pesagemCheck.addEventListener('change', function() {
          if (this.checked) {
            pesagemContainer.style.display = 'block';
          } else {
            pesagemContainer.style.display = 'none';
            // Limpar sele√ß√£o
            const select = document.getElementById('trabalhoTipoPesagem');
            if (select) {
              Array.from(select.options).forEach(option => option.selected = false);
            }
          }
        });
      }
      
      if (vacinaCheck && vacinaContainer) {
        vacinaCheck.addEventListener('change', function() {
          if (this.checked) {
            vacinaContainer.style.display = 'block';
          } else {
            vacinaContainer.style.display = 'none';
            // Limpar sele√ß√£o
            const select = document.getElementById('trabalhoTipoVacina');
            if (select) {
              Array.from(select.options).forEach(option => option.selected = false);
            }
          }
        });
      }
      
      if (reproducaoCheck && reproducaoContainer) {
        reproducaoCheck.addEventListener('change', function() {
          if (this.checked) {
            reproducaoContainer.style.display = 'block';
          } else {
            reproducaoContainer.style.display = 'none';
            // Limpar sele√ß√£o
            const select = document.getElementById('trabalhoTipoReproducao');
            if (select) {
              Array.from(select.options).forEach(option => option.selected = false);
            }
          }
        });
      }
      
      if (movimentacaoCheck && movimentacaoContainer) {
        movimentacaoCheck.addEventListener('change', function() {
          if (this.checked) {
            movimentacaoContainer.style.display = 'block';
          } else {
            movimentacaoContainer.style.display = 'none';
            // Limpar sele√ß√£o
            const select = document.getElementById('trabalhoTipoMovimentacao');
            if (select) {
              Array.from(select.options).forEach(option => option.selected = false);
            }
          }
        });
      }
    }
  });
  
  // Submeter formul√°rio
  const formCadastro = document.getElementById('formCadastroTrabalho');
  if (formCadastro) {
    formCadastro.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const btnSalvar = document.getElementById('btnSalvarTrabalho');
      const btnCancelar = document.getElementById('btnCancelarTrabalho');
      
      // Desabilitar bot√µes
      if (btnSalvar) {
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando...';
      }
      if (btnCancelar) {
        btnCancelar.disabled = true;
      }
      
      // Coletar dados
      const data = document.getElementById('trabalhoData').value;
      const id = document.getElementById('trabalhoId').value.trim();
      const descricao = document.getElementById('trabalhoDescricao').value.trim();
      const quantidade = document.getElementById('trabalhoQuantidade').value;
      const observacoes = document.getElementById('trabalhoObservacoes').value.trim();
      
      // Validar campos obrigat√≥rios
      if (!data) {
        alert('Por favor, informe a data do trabalho.');
        if (btnSalvar) btnSalvar.disabled = false;
        if (btnCancelar) btnCancelar.disabled = false;
        return;
      }
      
      if (!descricao) {
        alert('Por favor, informe a descri√ß√£o do trabalho.');
        if (btnSalvar) btnSalvar.disabled = false;
        if (btnCancelar) btnCancelar.disabled = false;
        return;
      }
      
      // Obter CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // Preparar payload
      const propriedadeId = window.location.pathname.match(/propriedade\/(\d+)/);
      if (!propriedadeId) {
        alert('Erro: N√£o foi poss√≠vel identificar a propriedade.');
        if (btnSalvar) btnSalvar.disabled = false;
        if (btnCancelar) btnCancelar.disabled = false;
        return;
      }
      
      const payload = {
        id: id,
        data: data || null,
        descricao: descricao || null,
        quantidade_esperada: quantidade ? parseInt(quantidade) : null,
        observacoes: observacoes || null
      };
      
      console.log('üì§ Enviando payload:', payload);
      
      // Fun√ß√£o auxiliar para reabilitar bot√µes
      const reabilitarBotoes = () => {
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = '<i class="bi bi-check-circle"></i> Criar Trabalho';
        }
        if (btnCancelar) {
          btnCancelar.disabled = false;
        }
      };
      
      let timeoutId = null;
      try {
        // Adicionar timeout para evitar requisi√ß√µes infinitas
        const controller = new AbortController();
        timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos
        
        const response = await fetch(`/propriedade/${propriedadeId[1]}/curral/api/sessao/criar/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        
        if (timeoutId) clearTimeout(timeoutId);
        
        // Verificar se a resposta √© JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          // Se n√£o for JSON, provavelmente √© uma p√°gina de erro HTML
          const textResponse = await response.text();
          console.error('‚ùå Resposta n√£o √© JSON:', textResponse.substring(0, 500));
          alert('Erro ao criar trabalho: O servidor retornou uma resposta inv√°lida. Verifique se voc√™ est√° autenticado e tente novamente.');
          reabilitarBotoes();
          return;
        }
        
        const responseData = await response.json();
        console.log('üì• Resposta recebida:', responseData);
        
        if (response.ok && responseData.status === 'ok') {
          // Sucesso
          console.log('‚úÖ Trabalho criado com sucesso!');
          
          if (typeof mostrarToast === 'function') {
            mostrarToast('Trabalho criado com sucesso!', 'success');
          } else {
            alert('Trabalho criado com sucesso!');
          }
          
          // Fechar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalCadastroTrabalho'));
          if (modal) {
            modal.hide();
          }
          
          // Recarregar p√°gina para atualizar a interface
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          // Erro
          const mensagemErro = responseData.mensagem || responseData.message || responseData.error || 'Erro desconhecido';
          console.error('‚ùå Erro ao criar trabalho:', mensagemErro);
          alert('Erro ao criar trabalho: ' + mensagemErro);
          reabilitarBotoes();
        }
      } catch (error) {
        if (timeoutId) clearTimeout(timeoutId);
        console.error('‚ùå Erro ao criar trabalho:', error);
        
        let errorMessage = 'Erro ao criar trabalho: ';
        if (error.name === 'AbortError') {
          errorMessage += 'A requisi√ß√£o demorou muito tempo. Verifique sua conex√£o e tente novamente.';
        } else if (error.message.includes('JSON') || error.message.includes('<!DOCTYPE')) {
          errorMessage += 'O servidor retornou uma resposta inv√°lida. Verifique se voc√™ est√° autenticado e tente novamente.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage += 'Erro de conex√£o. Verifique sua internet e tente novamente.';
        } else {
          errorMessage += error.message || 'Erro desconhecido';
        }
        
        alert(errorMessage);
        reabilitarBotoes();
      }
    });
  }
})();
</script>

<!-- Otimiza√ß√µes de Performance -->
<script>
// Otimiza√ß√£o: Defer scripts pesados e lazy loading
(function() {
  'use strict';
  
  // Desabilitar console.log em produ√ß√£o (melhora performance)
  if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
    const noop = () => {};
    const originalLog = console.log;
    const originalWarn = console.warn;
    console.log = noop;
    console.warn = noop;
    // Manter console.error para debug em produ√ß√£o
  }
  
  // Otimiza√ß√£o: Preload cr√≠tico apenas
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      // Inicializar componentes n√£o cr√≠ticos apenas quando ocioso
      const lazyElements = document.querySelectorAll('[data-lazy]');
      lazyElements.forEach(el => {
        if (el.dataset.lazy === 'true') {
          el.style.display = '';
        }
      });
    }, { timeout: 2000 });
  }
  
  // Otimiza√ß√£o: Debounce para eventos frequentes
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Otimiza√ß√£o: Throttle para scroll/resize
  function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }
  
  // Aplicar otimiza√ß√µes em eventos de scroll/resize
  window.addEventListener('scroll', throttle(() => {
    // Lazy load de imagens/elementos vis√≠veis
  }, 100));
  
  window.addEventListener('resize', debounce(() => {
    // Recalcular layouts apenas ap√≥s resize completo
  }, 250));
  
  // ========== FUNCIONALIDADE DE MENU LATERAL EM TELA CHEIA ==========
  (function() {
    'use strict';
    
    const sidebar = document.querySelector('.sidebar');
    const fullscreenModal = document.getElementById('menuLateralFullscreen');
    const windowElement = document.getElementById('menuLateralWindow');
    const windowContent = document.getElementById('menuLateralWindowContent');
    const minimizeBtn = document.getElementById('menuLateralMinimize');
    const maximizeBtn = document.getElementById('menuLateralMaximize');
    const closeBtn = document.getElementById('menuLateralClose');
    const windowHeader = document.getElementById('menuLateralWindowHeader');
    
    let isMinimized = false;
    let isMaximized = true;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    
    // Fun√ß√£o para abrir o menu em tela cheia
    function abrirMenuLateralFullscreen() {
      if (!sidebar || !fullscreenModal || !windowContent) return;
      
      // Copiar conte√∫do do sidebar para a janela
      const sidebarClone = sidebar.cloneNode(true);
      sidebarClone.style.position = 'relative';
      sidebarClone.style.width = '100%';
      sidebarClone.style.height = '100%';
      sidebarClone.style.transform = 'none';
      sidebarClone.style.boxShadow = 'none';
      
      // Limpar conte√∫do anterior
      windowContent.innerHTML = '';
      windowContent.appendChild(sidebarClone);
      
      // Mostrar modal
      fullscreenModal.classList.add('show');
      isMaximized = true;
      isMinimized = false;
      windowElement.classList.remove('minimized');
      windowElement.classList.add('maximized');
      
      // Atualizar √≠cone do bot√£o maximizar
      if (maximizeBtn) {
        maximizeBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
        maximizeBtn.title = 'Restaurar';
      }
    }
    
    // Fun√ß√£o para fechar
    function fecharMenuLateralFullscreen() {
      if (fullscreenModal) {
        fullscreenModal.classList.remove('show');
        isMinimized = false;
        isMaximized = false;
        windowElement.classList.remove('minimized', 'maximized');
      }
    }
    
    // Fun√ß√£o para minimizar
    function minimizarMenuLateral() {
      if (isMinimized) {
        // Restaurar
        windowElement.classList.remove('minimized');
        windowElement.classList.add('maximized');
        isMinimized = false;
        isMaximized = true;
        if (maximizeBtn) {
          maximizeBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
          maximizeBtn.title = 'Restaurar';
        }
      } else {
        // Minimizar
        windowElement.classList.remove('maximized');
        windowElement.classList.add('minimized');
        isMinimized = true;
        isMaximized = false;
        if (maximizeBtn) {
          maximizeBtn.innerHTML = '<i class="bi bi-square"></i>';
          maximizeBtn.title = 'Maximizar';
        }
      }
    }
    
    // Fun√ß√£o para maximizar/restaurar
    function toggleMaximizarMenuLateral() {
      if (isMaximized) {
        // Restaurar (tamanho m√©dio)
        windowElement.classList.remove('maximized');
        windowElement.classList.add('minimized');
        isMaximized = false;
        isMinimized = true;
        if (maximizeBtn) {
          maximizeBtn.innerHTML = '<i class="bi bi-square"></i>';
          maximizeBtn.title = 'Maximizar';
        }
      } else {
        // Maximizar
        windowElement.classList.remove('minimized');
        windowElement.classList.add('maximized');
        isMaximized = true;
        isMinimized = false;
        if (maximizeBtn) {
          maximizeBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
          maximizeBtn.title = 'Restaurar';
        }
      }
    }
    
    // Event listeners
    if (minimizeBtn) {
      minimizeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        minimizarMenuLateral();
      });
    }
    
    if (maximizeBtn) {
      maximizeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleMaximizarMenuLateral();
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fecharMenuLateralFullscreen();
      });
    }
    
    // Fechar ao clicar fora da janela
    if (fullscreenModal) {
      fullscreenModal.addEventListener('click', function(e) {
        if (e.target === fullscreenModal) {
          fecharMenuLateralFullscreen();
        }
      });
    }
    
    // Arrastar janela (quando minimizada)
    if (windowHeader && windowElement) {
      windowHeader.addEventListener('mousedown', function(e) {
        if (isMinimized) {
          isDragging = true;
          const rect = windowElement.getBoundingClientRect();
          dragOffset.x = e.clientX - rect.left;
          dragOffset.y = e.clientY - rect.top;
          windowElement.style.cursor = 'grabbing';
        }
      });
      
      document.addEventListener('mousemove', function(e) {
        if (isDragging && isMinimized) {
          windowElement.style.left = (e.clientX - dragOffset.x) + 'px';
          windowElement.style.top = (e.clientY - dragOffset.y) + 'px';
          windowElement.style.transform = 'none';
        }
      });
      
      document.addEventListener('mouseup', function() {
        if (isDragging) {
          isDragging = false;
          windowElement.style.cursor = 'default';
        }
      });
    }
    
    // Adicionar evento de clique no sidebar para abrir em tela cheia
    if (sidebar) {
      // Criar um bot√£o ou √°rea clic√°vel no sidebar
      const sidebarHeader = sidebar.querySelector('.sidebar-header');
      if (sidebarHeader) {
        sidebarHeader.style.cursor = 'pointer';
        sidebarHeader.style.position = 'relative';
        sidebarHeader.addEventListener('click', function(e) {
          // N√£o abrir se clicar em um link dentro
          if (e.target.tagName === 'A' || e.target.closest('a')) {
            return;
          }
          abrirMenuLateralFullscreen();
        });
        
        // Adicionar √≠cone de fullscreen
        const fullscreenIcon = document.createElement('i');
        fullscreenIcon.className = 'bi bi-arrows-fullscreen';
        fullscreenIcon.style.cssText = 'position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; opacity: 0.7; cursor: pointer;';
        fullscreenIcon.title = 'Abrir em tela cheia';
        fullscreenIcon.addEventListener('click', function(e) {
          e.stopPropagation();
          abrirMenuLateralFullscreen();
        });
        sidebarHeader.appendChild(fullscreenIcon);
      }
    }
    
    // Tornar fun√ß√£o global
    window.abrirMenuLateralFullscreen = abrirMenuLateralFullscreen;
    window.fecharMenuLateralFullscreen = fecharMenuLateralFullscreen;
  })();
  
  // Otimiza√ß√£o: Preconnect para recursos externos
  const preconnect = document.createElement('link');
  preconnect.rel = 'preconnect';
  preconnect.href = window.location.origin;
  document.head.appendChild(preconnect);
})();
</script>

<!-- Otimiza√ß√£o: CSS cr√≠tico inline, resto defer -->
<style>
/* Otimiza√ß√£o: Estilos cr√≠ticos do modal inline para renderiza√ß√£o imediata */
#modalCadastroTrabalho {
  display: none;
}
#modalCadastroTrabalho.show {
  display: block;
}
</style>

<!-- Fallback: Garantir que fun√ß√µes de sess√£o estejam dispon√≠veis -->
<script>
// Garantir que as fun√ß√µes estejam dispon√≠veis mesmo se houver problemas de escopo
(function() {
  'use strict';
  
  // Verificar e criar fun√ß√£o verSessaoV2 se n√£o existir
  if (typeof window.verSessaoV2 === 'undefined') {
    window.verSessaoV2 = function(btn) {
      if (!btn) {
        console.error('‚ùå Bot√£o n√£o fornecido');
        return;
      }
      const url = btn.getAttribute('data-url');
      if (url) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
        window.location.href = url;
      }
    };
    console.log('‚úÖ window.verSessaoV2 criada via fallback');
  }
  
  // Verificar e criar fun√ß√£o encerrarSessaoV2 se n√£o existir
  if (typeof window.encerrarSessaoV2 === 'undefined') {
    window.encerrarSessaoV2 = async function() {
      if (!confirm('Deseja realmente encerrar a sess√£o atual?')) {
        return;
      }
      
      const btn = document.querySelector('.sessao-btn-encerrar');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Encerrando...';
      }
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        
        const url = '{{ encerrar_sessao_url|default:"/curral/encerrar-sessao/" }}';
        
        if (!csrfToken) {
          alert('Erro: Token de seguran√ßa n√£o encontrado. Recarregue a p√°gina.');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
          }
          return;
        }
        
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({})
        });
        
        const data = await resp.json();
        
        if (data.status === 'ok') {
          alert('Sess√£o encerrada com sucesso!');
          setTimeout(() => window.location.reload(), 500);
        } else {
          alert(data.mensagem || 'Erro ao encerrar sess√£o.');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
          }
        }
      } catch (e) {
        console.error('Erro:', e);
        alert('Erro ao comunicar com o servidor.');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-stop"></i> Encerrar';
        }
      }
    };
    console.log('‚úÖ window.encerrarSessaoV2 criada via fallback');
  }
  
  console.log('‚úÖ Verifica√ß√£o final de fun√ß√µes:', {
    verSessaoV2: typeof window.verSessaoV2,
    encerrarSessaoV2: typeof window.encerrarSessaoV2
  });
})();

// ========== CONTROLE DE MODAIS DE CONFIGURA√á√ÉO (SANIT√ÅRIO E MOVIMENTA√á√ÉO) ==========

// Controlar exibi√ß√£o de campos do modal Sanit√°rio
(function() {
  const vacinaRadio = document.getElementById('sanitarioVacina');
  const tratamentoRadio = document.getElementById('sanitarioTratamento');
  const camposVacina = document.getElementById('camposVacina');
  const camposTratamento = document.getElementById('camposTratamento');
  const vacinaLabel = document.getElementById('sanitarioVacinaLabel');
  const tratamentoLabel = document.getElementById('sanitarioTratamentoLabel');

  function atualizarCamposSanitario() {
    if (vacinaRadio && tratamentoRadio && camposVacina && camposTratamento) {
      if (vacinaRadio.checked) {
        camposVacina.style.display = 'block';
        camposTratamento.style.display = 'none';
        if (vacinaLabel) {
          vacinaLabel.style.borderColor = '#d32f2f';
          vacinaLabel.style.background = '#ffebee';
        }
        if (tratamentoLabel) {
          tratamentoLabel.style.borderColor = '#e0e0e0';
          tratamentoLabel.style.background = '#f8f9fa';
        }
      } else if (tratamentoRadio.checked) {
        camposVacina.style.display = 'none';
        camposTratamento.style.display = 'block';
        if (tratamentoLabel) {
          tratamentoLabel.style.borderColor = '#d32f2f';
          tratamentoLabel.style.background = '#ffebee';
        }
        if (vacinaLabel) {
          vacinaLabel.style.borderColor = '#e0e0e0';
          vacinaLabel.style.background = '#f8f9fa';
        }
      } else {
        camposVacina.style.display = 'none';
        camposTratamento.style.display = 'none';
      }
    }
  }

  if (vacinaRadio) vacinaRadio.addEventListener('change', atualizarCamposSanitario);
  if (tratamentoRadio) tratamentoRadio.addEventListener('change', atualizarCamposSanitario);
})();

// Controlar exibi√ß√£o de campos do modal Movimenta√ß√£o
(function() {
  const entradaRadio = document.getElementById('movimentacaoEntrada');
  const saidaRadio = document.getElementById('movimentacaoSaida');
  const apartacaoRadio = document.getElementById('movimentacaoApartacao');
  const camposMovimentacao = document.getElementById('camposMovimentacao');
  const entradaLabel = document.getElementById('movimentacaoEntradaLabel');
  const saidaLabel = document.getElementById('movimentacaoSaidaLabel');
  const apartacaoLabel = document.getElementById('movimentacaoApartacaoLabel');

  function atualizarCamposMovimentacao() {
    if (camposMovimentacao) {
      if (entradaRadio && entradaRadio.checked) {
        camposMovimentacao.style.display = 'block';
        if (entradaLabel) {
          entradaLabel.style.borderColor = '#f57c00';
          entradaLabel.style.background = '#fff3e0';
        }
        if (saidaLabel) {
          saidaLabel.style.borderColor = '#e0e0e0';
          saidaLabel.style.background = '#f8f9fa';
        }
        if (apartacaoLabel) {
          apartacaoLabel.style.borderColor = '#e0e0e0';
          apartacaoLabel.style.background = '#f8f9fa';
        }
      } else if (saidaRadio && saidaRadio.checked) {
        camposMovimentacao.style.display = 'block';
        if (saidaLabel) {
          saidaLabel.style.borderColor = '#f57c00';
          saidaLabel.style.background = '#fff3e0';
        }
        if (entradaLabel) {
          entradaLabel.style.borderColor = '#e0e0e0';
          entradaLabel.style.background = '#f8f9fa';
        }
        if (apartacaoLabel) {
          apartacaoLabel.style.borderColor = '#e0e0e0';
          apartacaoLabel.style.background = '#f8f9fa';
        }
      } else if (apartacaoRadio && apartacaoRadio.checked) {
        camposMovimentacao.style.display = 'block';
        if (apartacaoLabel) {
          apartacaoLabel.style.borderColor = '#f57c00';
          apartacaoLabel.style.background = '#fff3e0';
        }
        if (entradaLabel) {
          entradaLabel.style.borderColor = '#e0e0e0';
          entradaLabel.style.background = '#f8f9fa';
        }
        if (saidaLabel) {
          saidaLabel.style.borderColor = '#e0e0e0';
          saidaLabel.style.background = '#f8f9fa';
        }
      } else {
        camposMovimentacao.style.display = 'none';
      }
    }
  }

  if (entradaRadio) entradaRadio.addEventListener('change', atualizarCamposMovimentacao);
  if (saidaRadio) saidaRadio.addEventListener('change', atualizarCamposMovimentacao);
  if (apartacaoRadio) apartacaoRadio.addEventListener('change', atualizarCamposMovimentacao);
})();

// ========== FUN√á√ïES PARA SALVAR CONFIGURA√á√ïES ==========

// Salvar configura√ß√£o sanit√°ria
window.salvarConfigSanitario = async function() {
  const tipoSanitario = document.querySelector('input[name="tipoSanitario"]:checked');
  if (!tipoSanitario) {
    alert('Selecione o tipo de manejo sanit√°rio (Vacina√ß√£o ou Tratamento)');
    return;
  }

  const tipo = tipoSanitario.value;
  let dados = {
    tipo_evento: tipo,
    observacoes: ''
  };

  if (tipo === 'VACINACAO') {
    const nome = document.getElementById('vacinaNome')?.value;
    if (!nome) {
      alert('Informe o nome da vacina');
      return;
    }
    dados.nome = nome;
    dados.lote = document.getElementById('vacinaLote')?.value || '';
    dados.validade = document.getElementById('vacinaValidade')?.value || '';
    dados.responsavel = document.getElementById('vacinaResponsavel')?.value || '';
    dados.observacoes = document.getElementById('vacinaObservacoes')?.value || '';
  } else if (tipo === 'TRATAMENTO') {
    const nome = document.getElementById('tratamentoNome')?.value;
    if (!nome) {
      alert('Informe o nome do medicamento/tratamento');
      return;
    }
    dados.nome = nome;
    dados.dosagem = document.getElementById('tratamentoDosagem')?.value || '';
    dados.carencia = document.getElementById('tratamentoCarencia')?.value || '';
    dados.responsavel = document.getElementById('tratamentoResponsavel')?.value || '';
    dados.observacoes = document.getElementById('tratamentoObservacoes')?.value || '';
  }

  // Salvar no localStorage para uso na sess√£o
  window.configSanitarioSalva = dados;
  localStorage.setItem('monpecConfigSanitarioSalva', JSON.stringify(dados));

  // Atualizar card de resumo
  const cardOriginal = document.getElementById('cardConfigSanitarioOriginal');
  const cardResumo = document.getElementById('cardResumoConfigSanitario');
  const resumoContent = document.getElementById('resumoConfigSanitario');

  if (cardOriginal && cardResumo && resumoContent) {
    cardOriginal.style.display = 'none';
    cardResumo.style.display = 'block';
    resumoContent.innerHTML = `
      <div style="color: #666; font-size: 0.85rem;">
        <strong style="color: #333;">${tipo === 'VACINACAO' ? 'Vacina√ß√£o' : 'Tratamento'}</strong>: ${dados.nome || 'N√£o configurado'}
      </div>
    `;
  }

  // Fechar modal
  if (typeof fecharModalConfigPesagem === 'function') {
    fecharModalConfigPesagem();
  }

  if (typeof mostrarToast === 'function') {
    mostrarToast('Configura√ß√£o sanit√°ria salva com sucesso!', 'success');
  } else {
    alert('Configura√ß√£o sanit√°ria salva com sucesso!');
  }
};

// Salvar configura√ß√£o de movimenta√ß√£o
window.salvarConfigMovimentacao = async function() {
  const tipoMovimentacao = document.querySelector('input[name="tipoMovimentacao"]:checked');
  if (!tipoMovimentacao) {
    alert('Selecione o tipo de movimenta√ß√£o');
    return;
  }

  const tipo = tipoMovimentacao.value;
  const dados = {
    tipo_evento: tipo,
    origem: document.getElementById('movimentacaoOrigem')?.value || '',
    destino: document.getElementById('movimentacaoDestino')?.value || '',
    motivo: document.getElementById('movimentacaoMotivo')?.value || '',
    responsavel: document.getElementById('movimentacaoResponsavel')?.value || '',
    observacoes: document.getElementById('movimentacaoObservacoes')?.value || ''
  };

  // Salvar no localStorage
  window.configMovimentacaoSalva = dados;
  localStorage.setItem('monpecConfigMovimentacaoSalva', JSON.stringify(dados));

  // Atualizar card de resumo
  const cardOriginal = document.getElementById('cardConfigMovimentacaoOriginal');
  const cardResumo = document.getElementById('cardResumoConfigMovimentacao');
  const resumoContent = document.getElementById('resumoConfigMovimentacao');

  if (cardOriginal && cardResumo && resumoContent) {
    cardOriginal.style.display = 'none';
    cardResumo.style.display = 'block';
    const tipoNome = tipo === 'ENTRADA' ? 'Entrada' : (tipo === 'SAIDA' ? 'Sa√≠da' : 'Aparta√ß√£o');
    resumoContent.innerHTML = `
      <div style="margin-bottom: 8px;">
        <strong style="color: #f57c00;">${tipoNome}</strong>
      </div>
      <div style="font-size: 0.85rem; color: #666;">
        ${dados.origem ? `De: ${dados.origem}` : ''} ${dados.destino ? `Para: ${dados.destino}` : ''}
      </div>
    `;
  }

  // Fechar modal
  if (typeof fecharModalConfigPesagem === 'function') {
    fecharModalConfigPesagem();
  }

  if (typeof mostrarToast === 'function') {
    mostrarToast('Configura√ß√£o de movimenta√ß√£o salva com sucesso!', 'success');
  } else {
    alert('Configura√ß√£o de movimenta√ß√£o salva com sucesso!');
  }
};

// Carregar configura√ß√µes salvas ao abrir modais
window.carregarConfigSanitario = function() {
  try {
    const saved = localStorage.getItem('monpecConfigSanitarioSalva');
    if (saved) {
      const config = JSON.parse(saved);
      if (config.tipo_evento === 'VACINACAO') {
        const radio = document.getElementById('sanitarioVacina');
        if (radio) {
          radio.checked = true;
          const event = new Event('change');
          radio.dispatchEvent(event);
        }
        if (config.nome) document.getElementById('vacinaNome').value = config.nome;
        if (config.lote) document.getElementById('vacinaLote').value = config.lote;
        if (config.validade) document.getElementById('vacinaValidade').value = config.validade;
        if (config.responsavel) document.getElementById('vacinaResponsavel').value = config.responsavel;
        if (config.observacoes) document.getElementById('vacinaObservacoes').value = config.observacoes;
      } else if (config.tipo_evento === 'TRATAMENTO') {
        const radio = document.getElementById('sanitarioTratamento');
        if (radio) {
          radio.checked = true;
          const event = new Event('change');
          radio.dispatchEvent(event);
        }
        if (config.nome) document.getElementById('tratamentoNome').value = config.nome;
        if (config.dosagem) document.getElementById('tratamentoDosagem').value = config.dosagem;
        if (config.carencia) document.getElementById('tratamentoCarencia').value = config.carencia;
        if (config.responsavel) document.getElementById('tratamentoResponsavel').value = config.responsavel;
        if (config.observacoes) document.getElementById('tratamentoObservacoes').value = config.observacoes;
      }
    }
  } catch (e) {
    console.error('Erro ao carregar configura√ß√£o sanit√°ria:', e);
  }
};

window.carregarConfigMovimentacao = function() {
  try {
    const saved = localStorage.getItem('monpecConfigMovimentacaoSalva');
    if (saved) {
      const config = JSON.parse(saved);
      const radio = document.querySelector(`input[name="tipoMovimentacao"][value="${config.tipo_evento}"]`);
      if (radio) {
        radio.checked = true;
        const event = new Event('change');
        radio.dispatchEvent(event);
      }
      if (config.origem) document.getElementById('movimentacaoOrigem').value = config.origem;
      if (config.destino) document.getElementById('movimentacaoDestino').value = config.destino;
      if (config.motivo) document.getElementById('movimentacaoMotivo').value = config.motivo;
      if (config.responsavel) document.getElementById('movimentacaoResponsavel').value = config.responsavel;
      if (config.observacoes) document.getElementById('movimentacaoObservacoes').value = config.observacoes;
    }
  } catch (e) {
    console.error('Erro ao carregar configura√ß√£o de movimenta√ß√£o:', e);
  }
};

// Atualizar fun√ß√£o abrirModalConfigSessao para carregar configura√ß√µes
const abrirModalConfigSessaoOriginal = window.abrirModalConfigSessao;
window.abrirModalConfigSessao = function(tipo) {
  if (abrirModalConfigSessaoOriginal) {
    abrirModalConfigSessaoOriginal(tipo);
  }
  
  // Carregar configura√ß√µes salvas ap√≥s abrir o modal
  setTimeout(() => {
    if (tipo === 'sanitario' && typeof window.carregarConfigSanitario === 'function') {
      window.carregarConfigSanitario();
    } else if (tipo === 'movimentacao' && typeof window.carregarConfigMovimentacao === 'function') {
      window.carregarConfigMovimentacao();
    }
  }, 200);
};

console.log('‚úÖ Fun√ß√µes de modais de configura√ß√£o (Sanit√°rio e Movimenta√ß√£o) definidas!');

// ========== INICIALIZAR CARDS QUANDO DOM ESTIVER PRONTO ==========
(function() {
  function inicializarCardsModais() {
    console.log('üîç Inicializando cards de modal...');
    
    // Card PESAGEM
    const cardPesagem = document.getElementById('cardConfigPesagem');
    if (cardPesagem) {
      cardPesagem.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üîµ [PESAGEM] Card clicado');
        if (typeof window.abrirModalConfigPesagem === 'function') {
          window.abrirModalConfigPesagem();
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigPesagem n√£o encontrada');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      }, true); // Use capture phase
      console.log('‚úÖ Card PESAGEM inicializado');
    }
    
    // Card SANIT√ÅRIO
    const cardSanitario = document.getElementById('cardConfigSanitarioOriginal');
    if (cardSanitario) {
      cardSanitario.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üî¥ [SANIT√ÅRIO] Card clicado');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('sanitario');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o encontrada');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      }, true);
      console.log('‚úÖ Card SANIT√ÅRIO inicializado');
    }
    
    // Card REPRODU√á√ÉO
    const cardReprodutivo = document.getElementById('cardConfigReprodutivoOriginal');
    if (cardReprodutivo) {
      cardReprodutivo.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üü£ [REPRODU√á√ÉO] Card clicado');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('reprodutivo');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o encontrada');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      }, true);
      console.log('‚úÖ Card REPRODU√á√ÉO inicializado');
    }
    
    // Card MOVIMENTA√á√ÉO
    const cardMovimentacao = document.getElementById('cardConfigMovimentacaoOriginal');
    if (cardMovimentacao) {
      cardMovimentacao.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üü† [MOVIMENTA√á√ÉO] Card clicado');
        if (typeof window.abrirModalConfigSessao === 'function') {
          window.abrirModalConfigSessao('movimentacao');
        } else {
          console.error('‚ùå Fun√ß√£o abrirModalConfigSessao n√£o encontrada');
          alert('Erro: Fun√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
      }, true);
      console.log('‚úÖ Card MOVIMENTA√á√ÉO inicializado');
    }
  }
  
  // Executar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(inicializarCardsModais, 100);
      setTimeout(inicializarCardsModais, 500);
      setTimeout(inicializarCardsModais, 1000);
    });
  } else {
    setTimeout(inicializarCardsModais, 100);
    setTimeout(inicializarCardsModais, 500);
    setTimeout(inicializarCardsModais, 1000);
  }
})();

// ========== FUN√á√ÉO PARA REGISTRAR EVENTOS CONFIGURADOS AUTOMATICAMENTE ==========
window.registrarEventosConfigurados = async function(animalId) {
  if (!animalId) {
    console.warn('‚ö†Ô∏è Sem animal ID para registrar eventos');
    return;
  }

  try {
    const propriedadeMatch = window.location.pathname.match(/propriedade\/(\d+)/);
    if (!propriedadeMatch) {
      console.warn('‚ö†Ô∏è N√£o foi poss√≠vel identificar a propriedade');
      return;
    }
    const propriedadeId = propriedadeMatch[1];

    const manejos = [];

    // Verificar configura√ß√£o sanit√°ria
    try {
      const configSanitario = localStorage.getItem('monpecConfigSanitarioSalva');
      if (configSanitario) {
        const config = JSON.parse(configSanitario);
        if (config.tipo_evento && config.nome) {
          let observacoes = config.observacoes || '';
          if (config.tipo_evento === 'VACINACAO') {
            if (config.lote) observacoes += ` Lote: ${config.lote}`;
            if (config.validade) observacoes += ` Validade: ${config.validade}`;
            if (config.responsavel) observacoes += ` Respons√°vel: ${config.responsavel}`;
          } else if (config.tipo_evento === 'TRATAMENTO') {
            if (config.dosagem) observacoes += ` Dosagem: ${config.dosagem}`;
            if (config.carencia) observacoes += ` Car√™ncia: ${config.carencia} dias`;
            if (config.responsavel) observacoes += ` Respons√°vel: ${config.responsavel}`;
          }
          
          manejos.push({
            tipo_evento: config.tipo_evento,
            observacoes: `${config.nome}. ${observacoes}`.trim(),
            dados_adicionais: {
              nome: config.nome,
              lote: config.lote || '',
              validade: config.validade || '',
              dosagem: config.dosagem || '',
              carencia: config.carencia || '',
              responsavel: config.responsavel || ''
            }
          });
        }
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao processar configura√ß√£o sanit√°ria:', e);
    }

    // Verificar configura√ß√£o de movimenta√ß√£o
    try {
      const configMovimentacao = localStorage.getItem('monpecConfigMovimentacaoSalva');
      if (configMovimentacao) {
        const config = JSON.parse(configMovimentacao);
        if (config.tipo_evento) {
          let observacoes = config.observacoes || '';
          if (config.origem) observacoes += ` Origem: ${config.origem}`;
          if (config.destino) observacoes += ` Destino: ${config.destino}`;
          if (config.motivo) observacoes += ` Motivo: ${config.motivo}`;
          if (config.responsavel) observacoes += ` Respons√°vel: ${config.responsavel}`;
          
          manejos.push({
            tipo_evento: config.tipo_evento,
            observacoes: observacoes.trim() || 'Movimenta√ß√£o registrada',
            dados_adicionais: {
              origem: config.origem || '',
              destino: config.destino || '',
              motivo: config.motivo || '',
              responsavel: config.responsavel || ''
            }
          });
        }
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao processar configura√ß√£o de movimenta√ß√£o:', e);
    }

    // Verificar configura√ß√£o reprodutiva
    try {
      const configReprodutivo = localStorage.getItem('monpecConfigReprodutivoV4');
      if (configReprodutivo) {
        const config = JSON.parse(configReprodutivo);
        if (config.tipo && config.tipo !== '') {
          let observacoes = '';
          if (config.tipo === 'iatf' && config.iatfConfig) {
            const iatf = config.iatfConfig;
            observacoes = `Protocolo IATF: ${iatf.protocolo || 'N√£o especificado'}`;
            if (iatf.dataImplante) observacoes += ` | Implante: ${iatf.dataImplante}`;
            if (iatf.dataInseminacao) observacoes += ` | Insemina√ß√£o: ${iatf.dataInseminacao}`;
            if (iatf.touroSemen) observacoes += ` | Touro/S√™men: ${iatf.touroSemen}`;
            if (iatf.observacoes) observacoes += ` | ${iatf.observacoes}`;
          } else if (config.tipo === 'monta') {
            observacoes = 'Monta Natural';
            if (config.montaConfig && config.montaConfig.touro) {
              observacoes += ` | Touro: ${config.montaConfig.touro}`;
            }
          } else if (config.tipo === 'inseminacao') {
            observacoes = 'Insemina√ß√£o Artificial';
            if (config.inseminacaoConfig) {
              const ins = config.inseminacaoConfig;
              if (ins.data) observacoes += ` | Data: ${ins.data}`;
              if (ins.touroSemen) observacoes += ` | Touro/S√™men: ${ins.touroSemen}`;
            }
          }
          
          manejos.push({
            tipo_evento: 'REPRODUCAO',
            observacoes: observacoes || 'Manejo reprodutivo registrado',
            dados_adicionais: config
          });
        }
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao processar configura√ß√£o reprodutiva:', e);
    }

    // Se houver manejos para registrar, chamar a API
    if (manejos.length > 0) {
      console.log('üìã Registrando', manejos.length, 'evento(s) configurado(s)...', manejos);
      
      const url = `/propriedade/${propriedadeId}/curral/api/manejos/registrar/`;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          animal_id: animalId,
          manejos: manejos
        })
      });

      if (response.ok) {
        const data = await response.json();
        console.log('‚úÖ Eventos registrados com sucesso:', data);
        if (typeof mostrarToast === 'function') {
          mostrarToast(`${manejos.length} evento(s) registrado(s) automaticamente!`, 'success');
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('‚ùå Erro ao registrar eventos:', errorData);
      }
    } else {
      console.log('‚ÑπÔ∏è Nenhum evento configurado para registrar automaticamente');
    }
  } catch (error) {
    console.error('‚ùå Erro ao registrar eventos configurados:', error);
  }
};

console.log('‚úÖ Fun√ß√£o registrarEventosConfigurados definida!');

// ========== GARANTIR QUE FUN√á√ïES ESTEJAM DISPON√çVEIS E CARDS FUNCIONEM ==========
(function() {
  function verificarEInicializarCards() {
    console.log('üîç Verificando disponibilidade de fun√ß√µes e inicializando cards...');
    
    // Verificar fun√ß√µes
    const funcoes = {
      abrirModalConfigPesagem: typeof window.abrirModalConfigPesagem,
      abrirModalConfigSessao: typeof window.abrirModalConfigSessao,
      fecharModalConfigPesagem: typeof window.fecharModalConfigPesagem,
      fecharModalConfigReprodutivo: typeof window.fecharModalConfigReprodutivo
    };
    
    console.log('üìã Status das fun√ß√µes:', funcoes);
    
    // Verificar modais no DOM
    const modais = {
      modalConfigPesagem: !!document.getElementById('modalConfigPesagem'),
      modalConfigReprodutivo: !!document.getElementById('modalConfigReprodutivo')
    };
    
    console.log('üìã Status dos modais:', modais);
    
    // Verificar cards
    const cards = {
      cardConfigPesagem: !!document.getElementById('cardConfigPesagem'),
      cardConfigSanitarioOriginal: !!document.getElementById('cardConfigSanitarioOriginal'),
      cardConfigReprodutivoOriginal: !!document.getElementById('cardConfigReprodutivoOriginal'),
      cardConfigMovimentacaoOriginal: !!document.getElementById('cardConfigMovimentacaoOriginal')
    };
    
    console.log('üìã Status dos cards:', cards);
    
    // Se todas as fun√ß√µes e elementos existem, est√° tudo OK
    if (funcoes.abrirModalConfigPesagem === 'function' && 
        funcoes.abrirModalConfigSessao === 'function' &&
        modais.modalConfigPesagem && 
        modais.modalConfigReprodutivo &&
        cards.cardConfigPesagem &&
        cards.cardConfigSanitarioOriginal &&
        cards.cardConfigReprodutivoOriginal &&
        cards.cardConfigMovimentacaoOriginal) {
      console.log('‚úÖ Todos os elementos e fun√ß√µes est√£o dispon√≠veis!');
    } else {
      console.warn('‚ö†Ô∏è Alguns elementos ou fun√ß√µes n√£o est√£o dispon√≠veis. Tentando novamente...');
      setTimeout(verificarEInicializarCards, 1000);
    }
  }
  
  // Executar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(verificarEInicializarCards, 500);
    });
  } else {
    setTimeout(verificarEInicializarCards, 500);
  }
})();

// ========== ATUALIZAR VISUAL DO SWITCH AUTO PR√ìXIMO ==========
(function() {
  function atualizarSwitchAutoProximo() {
    const checkbox = document.getElementById('autoProximoModal');
    const slider = checkbox?.nextElementSibling;
    const circle = slider?.querySelector('span');
    
    if (checkbox && slider && circle) {
      if (checkbox.checked) {
        slider.style.backgroundColor = '#4caf50';
        circle.style.transform = 'translateX(24px)';
      } else {
        slider.style.backgroundColor = '#ccc';
        circle.style.transform = 'translateX(0)';
      }
    }
  }

  // Adicionar event listener quando o checkbox for criado
  function configurarSwitchAutoProximo() {
    const checkbox = document.getElementById('autoProximoModal');
    if (checkbox) {
      checkbox.addEventListener('change', atualizarSwitchAutoProximo);
      atualizarSwitchAutoProximo(); // Atualizar estado inicial
    } else {
      setTimeout(configurarSwitchAutoProximo, 500);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', configurarSwitchAutoProximo);
  } else {
    configurarSwitchAutoProximo();
  }
})();

</script>
{% endblock %}
