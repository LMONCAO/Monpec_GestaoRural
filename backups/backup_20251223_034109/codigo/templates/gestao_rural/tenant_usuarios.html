{% extends "base_modulos_unificado.html" %}

{% block title %}Usuários do Sistema{% endblock %}

{% block content %}
<style>
    .usuarios-page {
        padding: 2rem 0;
        background: #f8f9fa;
        min-height: calc(100vh - 60px);
    }
    
    .page-title-section {
        margin-bottom: 2rem;
    }
    
    .page-title-section h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.5rem 0;
    }
    
    .page-title-section p {
        color: #64748b;
        margin: 0;
        font-size: 1rem;
    }
    
    .stats-card-simple {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .stats-info h6 {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .content-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .card-header-simple {
        background: #f8f9fa;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .card-header-simple h5 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .card-body-simple {
        padding: 1.5rem;
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .users-table thead {
        background: #f8f9fa;
    }
    
    .users-table thead th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .users-table tbody tr {
        border-bottom: 1px solid #e2e8f0;
    }
    
    .users-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .users-table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    .user-name {
        font-weight: 600;
        color: #1e293b;
    }
    
    .user-email {
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .badge-admin {
        background: #8b5cf6;
        color: white;
    }
    
    .badge-operador {
        background: #3b82f6;
        color: white;
    }
    
    .badge-visualizador {
        background: #6366f1;
        color: white;
    }
    
    .badge-modulo {
        background: #e0e7ff;
        color: #4338ca;
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        margin: 0.125rem 0.25rem 0.125rem 0;
        display: inline-block;
    }
    
    .badge-status-ativo {
        background: #10b981;
        color: white;
    }
    
    .badge-status-inativo {
        background: #6b7280;
        color: white;
    }
    
    .btn-sm-custom {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .btn-edit-custom {
        background: #3b82f6;
        color: white;
    }
    
    .btn-edit-custom:hover {
        background: #2563eb;
        color: white;
    }
    
    .btn-modules-custom {
        background: #8b5cf6;
        color: white;
    }
    
    .btn-modules-custom:hover {
        background: #7c3aed;
        color: white;
    }
    
    .form-label {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-control, .form-select {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 0.625rem 0.875rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-text {
        font-size: 0.8rem;
        color: #64748b;
        margin-top: 0.375rem;
    }
    
    .modules-checkboxes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
    }
    
    .form-check-custom {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .form-check-custom:hover {
        background: #f1f5f9;
        border-color: #3b82f6;
    }
    
    .form-check-input {
        margin-right: 0.75rem;
        cursor: pointer;
    }
    
    .form-check-label {
        cursor: pointer;
        font-size: 0.875rem;
        color: #475569;
        font-weight: 500;
        margin: 0;
    }
    
    .btn-primary-custom {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary-custom:hover {
        background: #2563eb;
        color: white;
    }
    
    .alert-info-custom {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
        color: #1e40af;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #94a3b8;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }
</style>

<div class="usuarios-page">
    <div class="container-fluid">
        <!-- Título -->
        <div class="page-title-section">
            <h1>
                <i class="bi bi-people-fill"></i>
                Gestão de Usuários
            </h1>
            <p>Gerencie usuários e permissões do sistema</p>
        </div>
        
        <!-- Estatísticas -->
        <div class="stats-card-simple">
            <div class="stats-info">
                <h6>Usuários do Plano</h6>
                <p class="stats-number">{{ total_utilizado }} / {{ limite_total|default:"∞" }}</p>
            </div>
            <a href="{% url 'assinaturas_dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-gear"></i> Gerenciar Plano
            </a>
        </div>
        
        <div class="row">
            <!-- Lista de Usuários -->
            <div class="col-lg-8 mb-4">
                <div class="content-card">
                    <div class="card-header-simple">
                        <h5>
                            <i class="bi bi-list-ul"></i>
                            Usuários Cadastrados
                        </h5>
                    </div>
                    <div class="card-body-simple" style="padding: 0;">
                        {% if usuarios %}
                        <div style="overflow-x: auto;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>E-mail</th>
                                        <th>Perfil</th>
                                        <th>Módulos</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usuario in usuarios %}
                                    <tr>
                                        <td>
                                            <div class="user-name">{{ usuario.nome_exibicao }}</div>
                                        </td>
                                        <td>
                                            <div class="user-email">{{ usuario.email }}</div>
                                        </td>
                                        <td>
                                            {% if usuario.perfil == "ADMIN" %}
                                                <span class="badge badge-admin">
                                                    <i class="bi bi-shield-fill"></i> Admin
                                                </span>
                                            {% elif usuario.perfil == "OPERADOR" %}
                                                <span class="badge badge-operador">
                                                    <i class="bi bi-person-gear"></i> Operador
                                                </span>
                                            {% else %}
                                                <span class="badge badge-visualizador">
                                                    <i class="bi bi-eye"></i> Visualizador
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if usuario.perfil == "ADMIN" %}
                                                <span class="badge badge-modulo" style="background: #8b5cf6; color: white;">
                                                    <i class="bi bi-check-circle-fill"></i> Todos
                                                </span>
                                            {% else %}
                                                {% for modulo in usuario.modulos_autorizados %}
                                                    <span class="badge-modulo">{{ modulo|title }}</span>
                                                {% empty %}
                                                    <span style="color: #94a3b8; font-size: 0.8rem;">Nenhum</span>
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if usuario.ativo %}
                                                <span class="badge badge-status-ativo">
                                                    <i class="bi bi-check-circle-fill"></i> Ativo
                                                </span>
                                            {% else %}
                                                <span class="badge badge-status-inativo">
                                                    <i class="bi bi-x-circle-fill"></i> Inativo
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td style="text-align: right;">
                                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                                <a href="{% url 'tenant_usuario_editar' usuario.id %}" class="btn-sm-custom btn-edit-custom">
                                                    <i class="bi bi-pencil"></i> Editar
                                                </a>
                                                <a href="{% url 'tenant_usuario_configurar_modulos' usuario.id %}" class="btn-sm-custom btn-modules-custom">
                                                    <i class="bi bi-gear"></i> Módulos
                                                </a>
                                                {% if usuario.ativo %}
                                                    <form method="post" action="{% url 'tenant_usuario_toggle' usuario.id 'desativar' %}" style="display: inline;" onsubmit="return confirm('Tem certeza?');">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-x-circle"></i>
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <form method="post" action="{% url 'tenant_usuario_toggle' usuario.id 'reativar' %}" style="display: inline;">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-check-circle"></i>
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-people"></i>
                            <p style="font-size: 1.1rem; margin: 0.5rem 0;">Nenhum usuário cadastrado</p>
                            <p style="margin: 0;">Comece adicionando um novo usuário</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Formulário -->
            <div class="col-lg-4">
                <div class="content-card">
                    <div class="card-header-simple">
                        <h5>
                            <i class="bi bi-person-plus"></i>
                            Novo Usuário
                        </h5>
                    </div>
                    <div class="card-body-simple">
                        <div class="alert-info-custom">
                            <strong><i class="bi bi-info-circle"></i> Informação</strong>
                            <p style="margin: 0.5rem 0 0 0;">Preencha os dados do usuário. Você poderá editar as permissões após a criação.</p>
                        </div>
                        
                        <form method="post">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.nome.label }}</label>
                                {{ form.nome }}
                                {% if form.nome.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.nome.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.username.label }}</label>
                                {{ form.username }}
                                {% if form.username.help_text %}
                                    <span class="form-text">{{ form.username.help_text }}</span>
                                {% endif %}
                                {% if form.username.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.username.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.email.label }}</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.email.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.senha.label }}</label>
                                {{ form.senha }}
                                {% if form.senha.help_text %}
                                    <span class="form-text">{{ form.senha.help_text }}</span>
                                {% endif %}
                                {% if form.senha.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.senha.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">{{ form.perfil.label }}</label>
                                {{ form.perfil }}
                                {% if form.perfil.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.perfil.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">{{ form.modulos.label }}</label>
                                <div class="modules-checkboxes">
                                    {% for choice in form.modulos %}
                                    <div class="form-check-custom">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if form.modulos.errors %}
                                    <div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem;">{{ form.modulos.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            
                            <button type="submit" class="btn-primary-custom">
                                <i class="bi bi-check-circle"></i>
                                Salvar Usuário
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
