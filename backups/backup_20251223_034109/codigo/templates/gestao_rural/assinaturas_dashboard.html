{% extends "base.html" %}

{% block title %}Planos e Assinaturas{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Planos e Assinaturas</h1>
            <p class="text-muted mb-0">Selecione um plano para habilitar seu ambiente exclusivo e iniciar a integração SISBOV/PNIB.</p>
        </div>
        {% if assinatura %}
            <span class="badge bg-primary fs-6">
                Status atual: {{ assinatura.get_status_display }}
            </span>
        {% endif %}
    </div>

    {% if assinatura and assinatura.ativa %}
        <div class="alert alert-secondary">
            Precisa ajustar quem acessa o MONPEC? Utilize o painel de <a href="{% url 'tenant_usuarios_dashboard' %}" class="alert-link">gestão de usuários</a> para definir permissões por módulo.
        </div>
    {% endif %}

    {% if workspace %}
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Ambiente dedicado:</strong> {{ workspace.alias }}<br>
                    Status do provisionamento: {{ workspace.get_status_display }}{% if workspace.ultimo_erro %} <br><small class="text-danger">Último erro: {{ workspace.ultimo_erro }}</small>{% endif %}
                </div>
                {% if workspace.provisionado_em %}
                    <span class="text-muted small">Provisionado em {{ workspace.provisionado_em|date:"d/m/Y H:i" }}</span>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% if not publishable_key %}
        <div class="alert alert-warning">
            <strong>Atenção:</strong> defina as variáveis <code>STRIPE_PUBLISHABLE_KEY</code> e <code>STRIPE_SECRET_KEY</code> para habilitar os pagamentos.
        </div>
    {% endif %}

    <div class="row g-4">
        {% for plano in planos %}
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <h2 class="h5">{{ plano.nome }}</h2>
                        <p class="text-muted flex-grow-1">{{ plano.descricao|default:"Plano ideal para quem está começando a digitalizar o rebanho." }}</p>
                        {% if plano.preco_mensal_referencia %}
                            <div class="fs-4 fw-bold mb-3">
                                R$ {{ plano.preco_mensal_referencia|floatformat:2 }} <small class="text-muted fs-6">/ mês</small>
                            </div>
                        {% else %}
                            <div class="fs-6 text-muted mb-3">Valor definido conforme tabela Stripe</div>
                        {% endif %}

                        {% if assinatura and assinatura.plano_id == plano.id and assinatura.ativa %}
                            <button class="btn btn-outline-success" disabled>
                                Plano ativo
                            </button>
                        {% else %}
                            <button
                                class="btn btn-primary iniciar-checkout"
                                data-plano="{{ plano.slug }}"
                                {% if not publishable_key %}disabled{% endif %}
                            >
                                Assinar agora
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-info">
                    Nenhum plano cadastrado até o momento. Cadastre planos no painel administrativo.
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    (function () {
        const buttons = document.querySelectorAll('.iniciar-checkout');
        if (!buttons.length) {
            return;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return null;
        }

        const csrftoken = getCookie('csrftoken');

        buttons.forEach((btn) => {
            btn.addEventListener('click', async () => {
                const planoSlug = btn.dataset.plano;
                btn.disabled = true;
                btn.innerText = 'Redirecionando...';

                try {
                    const response = await fetch(`/assinaturas/plano/${planoSlug}/checkout/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken || ''
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Erro ao iniciar pagamento.' }));
                        throw new Error(errorData.detail || 'Erro desconhecido.');
                    }

                    const data = await response.json();
                    if (data.checkout_url) {
                        window.location.href = data.checkout_url;
                    } else {
                        throw new Error('Resposta inesperada da Stripe.');
                    }
                } catch (error) {
                    alert(error.message);
                    btn.disabled = false;
                    btn.innerText = 'Assinar agora';
                }
            });
        });
    })();
</script>
{% endblock %}

