{% extends "base_modulos_unificado.html" %}
{% load humanize %}

{% block title %}Curral Inteligente · {{ propriedade.nome_propriedade }}{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'gestao_rural/css/curral_enhanced.css' %}">
<style>
:root {
        --primary-color: #2e7d32;
        --secondary-color: #4caf50;
        --accent-color: #8bc34a;
        --dark-color: #1b5e20;
        --light-color: #e8f5e9;
}

body.curral-fullscreen {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        color: #333;
        font-size: 14px;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    /* Esconde header/sidebars padrão para imersão na tela de curral */
body.curral-fullscreen .header-fixo,
body.curral-fullscreen .breadcrumb-inteligente,
body.curral-fullscreen .sidebar,
body.curral-fullscreen .sidebar-overlay {
    display: none !important;
}

body.curral-fullscreen .main-content {
    margin-left: 0 !important;
    margin-top: 0 !important;
    min-height: 100vh !important;
    height: 100vh !important;
    background: transparent !important;
    padding: 0 !important;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

body.curral-fullscreen .main-content .content-area {
    padding: 0 !important;
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

    /* Barra de controles da janela */
    .curral-window-controls {
        background: linear-gradient(to right, #2e7d32, #4caf50);
        color: white;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        flex-shrink: 0;
        user-select: none;
        -webkit-app-region: drag;
    }

    .curral-window-title {
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .curral-window-title i {
        font-size: 1rem;
    }

    .curral-window-buttons {
        display: flex;
        gap: 4px;
        -webkit-app-region: no-drag;
    }

    .curral-window-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .curral-window-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .curral-window-btn.close:hover {
        background: #f44336;
    }

    .curral-window-btn.minimize:hover {
        background: #ff9800;
    }

    .curral-window-btn.maximize:hover {
        background: #2196f3;
    }

    /* Container principal com scroll */
    .curral-content-wrapper {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        display: flex;
        flex-direction: column;
        -webkit-overflow-scrolling: touch; /* Melhora scroll em mobile */
    }

    /* Scrollbar personalizada */
    .curral-content-wrapper::-webkit-scrollbar {
        width: 8px;
    }

    .curral-content-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .curral-content-wrapper::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .curral-content-wrapper::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Main Content */
    .main-content-curral {
        padding: 0;
        max-width: 100%;
        width: 100%;
        margin: 0;
        flex: 1;
    }

    .work-form-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
        margin-bottom: 20px;
    }

    .form-header {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 15px 20px;
    }

    .form-title {
        font-size: 1.3rem;
    font-weight: 600;
    display: flex;
        align-items: center;
        margin: 0;
    }

    .form-title i {
        margin-right: 10px;
    }

    .form-body {
        padding: 20px;
    }

    /* Card Identificação & Pesagem */
    .identification-card {
        background: linear-gradient(135deg, #2c3e50, #4a6572);
        border-radius: 10px;
        padding: 0;
        color: white;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .identification-card .card-header {
    display: flex;
    align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .identification-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
    align-items: center;
    }

    .identification-card .card-title i {
        margin-right: 8px;
        color: var(--accent-color);
    }

    .card-status {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 10px;
        border-radius: 15px;
    }

    .card-status.connected {
        color: #4caf50;
    }

    .card-status.disconnected {
        color: #f44336;
    }

    .identification-card .card-body {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 0;
    }

    .card-column {
        padding: 15px;
    display: flex;
        flex-direction: column;
    }

    .card-column:first-child {
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .column-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
    display: flex;
    align-items: center;
        color: var(--accent-color);
    }

    .column-title i {
        margin-right: 6px;
    }

    .scanner-section {
        text-align: center;
    flex: 1;
        display: flex;
        flex-direction: column;
    }

    .scanner-icon {
        font-size: 2rem;
        margin-bottom: 8px;
        color: var(--accent-color);
    }

    .scanner-text {
        font-size: 0.9rem;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .scanner-hint {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-bottom: 10px;
    }

    .brinco-input {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 10px 12px;
        color: white;
        font-size: 0.9rem;
        width: 100%;
        text-align: center;
        transition: all 0.3s;
        margin-bottom: 10px;
    }

    .brinco-input:focus {
        outline: none;
        border-color: var(--accent-color);
        background: rgba(255, 255, 255, 0.15);
    }

    .peso-section {
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .peso-display {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 10px;
        transition: all 0.3s;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .peso-display.active {
        border-color: var(--accent-color);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 15px rgba(139, 195, 74, 0.3);
    }

    .peso-display.pending {
        border-color: #ff9800;
        background: rgba(255, 152, 0, 0.1);
        box-shadow: 0 0 15px rgba(255, 152, 0, 0.3);
    }

    .peso-value {
        font-size: 2.8rem;
        font-weight: bold;
        color: white;
        margin: 0;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .peso-unit {
        font-size: 1.2rem;
        opacity: 0.8;
        margin-left: 5px;
    }

    .peso-pending-indicator {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ff9800;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
    display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        animation: pulse 1.5s infinite;
    }

    .peso-controls {
    display: flex;
        gap: 8px;
    }

    .peso-btn {
        flex: 1;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 6px;
        padding: 8px;
        color: white;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
    display: flex;
    align-items: center;
        justify-content: center;
    }

    .peso-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .peso-btn i {
        margin-right: 5px;
    }

    .animal-info {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        border-left: 4px solid var(--accent-color);
        display: none;
    }

    .animal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .animal-id {
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
    }

    .animal-status {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .animal-details {
    display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
    }

    .animal-detail {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
    }

    .animal-detail span {
        font-weight: 500;
        color: white;
    }

    /* Configuração de trabalho */
    .work-config {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid var(--primary-color);
    }

    .config-title {
        font-size: 1.1rem;
        color: var(--dark-color);
        margin-bottom: 12px;
    display: flex;
        align-items: center;
    }

    .config-title i {
        margin-right: 8px;
        color: var(--primary-color);
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }

    .config-card {
        background: white;
        border-radius: 6px;
        padding: 12px 8px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
        cursor: pointer;
    }

    .config-card.active {
        border-color: var(--primary-color);
        background: var(--light-color);
    }

    .config-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .config-icon {
        font-size: 1.4rem;
        color: var(--primary-color);
        margin-bottom: 6px;
        text-align: center;
    }

    .config-text {
    font-weight: 600;
        text-align: center;
        font-size: 0.8rem;
    }

    /* Tabs */
    .tabs-container {
        margin-bottom: 15px;
    }

    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
    }

    .nav-tabs .nav-link {
        color: #495057;
        background: none;
        border: none;
        border-radius: 0;
        padding: 10px 15px;
    white-space: nowrap;
        border-bottom: 2px solid transparent;
    font-size: 0.8rem;
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background: none;
        border-bottom: 2px solid var(--primary-color);
    font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
        border-bottom: 2px solid var(--accent-color);
    }

    .tab-content {
        padding: 0;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .section {
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 1.1rem;
        color: var(--dark-color);
        margin-bottom: 12px;
    display: flex;
        align-items: center;
        padding-bottom: 6px;
        border-bottom: 2px solid var(--light-color);
    }

    .section-title i {
        margin-right: 8px;
        color: var(--primary-color);
    }

    .sub-section {
        background: #f8f9fa;
        border-radius: 6px;
    padding: 12px;
        margin-bottom: 12px;
    }

    .sub-section-title {
        font-size: 1rem;
        color: var(--dark-color);
        margin-bottom: 10px;
    display: flex;
        align-items: center;
    }

    .sub-section-title i {
        margin-right: 6px;
        color: var(--primary-color);
    }

    .form-row-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .form-label {
    font-weight: 600;
        margin-bottom: 5px;
        color: #555;
        font-size: 0.85rem;
    }

    .performance-section {
        background: #e8f5e9;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }

    .performance-item {
        background: white;
        border-radius: 6px;
        padding: 12px;
        text-align: center;
        border: 1px solid #e0e0e0;
    }

    .performance-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 4px;
    }

    .performance-label {
        font-size: 0.8rem;
        color: #666;
    }

    .aparte-indicator {
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        color: white;
        margin-top: 8px;
        transition: all 0.3s;
        font-size: 0.9rem;
        background: #6c757d;
    }

    .aparte-refugo { background: #f44336; }
    .aparte-meio { background: #ff9800; }
    .aparte-cabeca { background: #2196f3; }
    .aparte-boiada { background: #4caf50; }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 15px;
    }

    .btn-action {
        padding: 10px;
        border-radius: 6px;
    font-weight: 600;
        font-size: 0.9rem;
        border: none;
    cursor: pointer;
        transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    }

    .btn-action i {
        margin-right: 6px;
    }

    .btn-save {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(46, 125, 50, 0.3);
    }

    .btn-next {
        background: #6c757d;
        color: white;
    }

    .btn-next:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    /* Popup Aparte */
    .aparte-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
    border-radius: 12px;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        z-index: 2000;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        text-align: center;
        opacity: 0;
        transition: opacity 0.5s;
        max-width: 90%;
    }

    .aparte-popup.show {
        opacity: 1;
    }

    .aparte-popup.refugo { background: #f44336; }
    .aparte-popup.meio { background: #ff9800; }
    .aparte-popup.cabeca { background: #2196f3; }
    .aparte-popup.boiada { background: #4caf50; }

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
        opacity: 0;
        transition: opacity 0.5s;
    pointer-events: none;
}

    .popup-overlay.show {
        opacity: 1;
        pointer-events: all;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .peso-manual-input {
        display: none;
        margin-top: 10px;
    }

    .peso-manual-input.active {
        display: block;
    }

    .manual-input-container {
    display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    .manual-peso-input {
        flex: 1;
        background: rgba(0, 0, 0, 0.25);
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 6px;
        padding: 8px 10px;
        color: #fff;
    font-size: 1rem;
        text-align: center;
    }

    .manual-peso-input:focus {
        outline: none;
        border-color: var(--accent-color);
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
    }

    #voiceBtn.recording {
        background: rgba(244, 67, 54, 0.7);
    }

    /* Popup Diagnóstico Reprodutivo */
    .diagnostico-overlay {
    position: fixed;
    inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
    align-items: center;
    justify-content: center;
        z-index: 2100;
    }

    .diagnostico-overlay.show {
    display: flex;
    }

    .diagnostico-popup {
        background: #ffffff;
    border-radius: 12px;
        max-width: 520px;
        width: 100%;
        padding: 20px 22px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .diagnostico-title {
    font-size: 1.1rem;
    font-weight: 600;
        margin-bottom: 12px;
    display: flex;
    align-items: center;
        color: var(--dark-color);
    }

    .diagnostico-title i {
        margin-right: 8px;
        color: var(--primary-color);
    }

    .diagnostico-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .diagnostico-option {
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        padding: 10px 8px;
        text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafafa;
    }

    .diagnostico-option.prenha { border-color: #4caf50; color: #1b5e20; }
    .diagnostico-option.vazia { border-color: #f44336; color: #b71c1c; }
    .diagnostico-option.nao-avaliada { border-color: #9e9e9e; color: #424242; }
    .diagnostico-option.descarte { border-color: #ff9800; color: #e65100; }
    .diagnostico-option.repetir-cio { border-color: #2196f3; color: #0d47a1; }

    .diagnostico-option:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }

    .diagnostico-option.active {
        background: var(--light-color);
        box-shadow: 0 4px 10px rgba(0,0,0,0.16);
    }

    .diagnostico-footer {
    display: flex;
        justify-content: flex-end;
    gap: 8px;
        margin-top: 5px;
    }

    .diagnostico-footer .btn {
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 6px;
    }

    /* Pílulas de diagnóstico no resumo / tabela */
    .diagnostico-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
    font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
    }

    .diagnostico-pill.prenha { background: #4caf50; }
    .diagnostico-pill.vazia { background: #f44336; }
    .diagnostico-pill.nao-avaliada { background: #9e9e9e; }
    .diagnostico-pill.descarte { background: #ff9800; }
    .diagnostico-pill.repetir-cio { background: #2196f3; }

    /* Estados da janela */
    body.curral-minimized .curral-content-wrapper {
        display: none;
    }

    body.curral-minimized .curral-window-controls {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .curral-window-controls {
            padding: 6px 8px;
        }

        .curral-window-title {
            font-size: 0.8rem;
        }

        .curral-window-title span {
            display: none;
        }

        .curral-window-btn {
            width: 28px;
            height: 28px;
            font-size: 0.75rem;
        }

        .curral-content-wrapper {
            padding: 10px;
        }

        .identification-card .card-body {
            grid-template-columns: 1fr;
        }

        .card-column:first-child {
            border-right: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content-curral {
            padding: 0;
        }

        .form-body {
            padding: 12px;
        }

        .form-row-grid {
            grid-template-columns: 1fr;
        }

        .animal-details {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            grid-template-columns: 1fr;
        }

        .performance-grid {
            grid-template-columns: 1fr;
        }

        .peso-value {
            font-size: 2rem;
        }

        .work-config {
            padding: 12px;
        }

        .config-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .curral-content-wrapper {
            padding: 8px;
        }

        .form-body {
            padding: 10px;
        }

        .peso-value {
            font-size: 1.8rem;
        }

        .config-grid {
            grid-template-columns: 1fr;
        }

        .nav-tabs {
            font-size: 0.75rem;
        }

        .nav-tabs .nav-link {
            padding: 8px 10px;
        }
    }

    @media (min-width: 1400px) {
        .main-content-curral {
            max-width: 1600px;
            margin: 0 auto;
        }
    }

    @media (min-width: 1920px) {
        .main-content-curral {
            max-width: 1800px;
        }
    }
</style>
{% endblock %}

{% block body_attrs %} class="curral-fullscreen"{% endblock %}

{% block content %}
<!-- Barra de controles da janela -->
<div class="curral-window-controls">
    <div class="curral-window-title">
        <i class="bi bi-cpu"></i>
        <span>Curral Inteligente - {{ propriedade.nome_propriedade }}</span>
    </div>
    <div class="curral-window-buttons">
        <button class="curral-window-btn minimize" id="curralMinimizeBtn" title="Minimizar">
            <i class="bi bi-dash"></i>
        </button>
        <button class="curral-window-btn maximize" id="curralMaximizeBtn" title="Maximizar/Restaurar">
            <i class="bi bi-arrows-fullscreen" id="curralMaximizeIcon"></i>
        </button>
        <button class="curral-window-btn close" id="curralCloseBtn" title="Fechar">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
</div>

<!-- Container com scroll -->
<div class="curral-content-wrapper">
    <div class="main-content-curral">
    <div class="work-form-container">
        <div class="form-header">
            <h1 class="form-title">
                <i class="fas fa-qrcode"></i>
                Trabalho Sequencial no Curral · {{ propriedade.nome_propriedade }}
            </h1>
        </div>

        <div class="form-body">
            <!-- Card Identificação & Pesagem -->
            <div class="identification-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-id-card"></i> Identificação e Pesagem
        </div>
                    <div class="card-status connected" id="pesoStatus">
                        <i class="fas fa-plug"></i> Balança conectada (simulação)
                    </div>
                </div>

                <div class="card-body">
                    <!-- Coluna Esquerda -->
                    <div class="card-column">
                        <div class="column-title">
                            <i class="fas fa-camera"></i> Identificação do animal
        </div>
                        <div class="scanner-section">
                            <i class="fas fa-qrcode scanner-icon"></i>
                            <div class="scanner-text">Scanner de brinco</div>
                            <div class="scanner-hint">Aproxime o brinco do leitor ou digite o código SISBOV / brinco</div>
                            <input type="text" class="brinco-input" placeholder="Digite o número do brinco..." id="brincoInput">
                            <div class="mt-2 d-flex justify-content-center gap-2">
                                <button type="button" class="btn btn-sm btn-outline-light" id="scanBrincoBtn">
                                    <i class="fas fa-camera"></i> Ler brinco com câmera
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-light" id="brincoVoiceBtn">
                                    <i class="fas fa-microphone"></i> Ler brinco por voz
                                </button>
        </div>

                            <div class="animal-info" id="animalInfo">
                                <div class="animal-header">
                                    <div class="animal-id">Brinco: <span id="animalBrinco">—</span></div>
                                    <span class="animal-status" id="animalStatus">Ativo</span>
        </div>
                                <div class="animal-details">
                                    <div class="animal-detail"><span>Raça:</span> <span id="animalRaca">—</span></div>
                                    <div class="animal-detail"><span>Idade:</span> <span id="animalIdade">—</span></div>
                                    <div class="animal-detail"><span>Sexo:</span> <span id="animalSexo">—</span></div>
                                    <div class="animal-detail"><span>Última pesagem:</span> <span id="animalUltimoPeso">—</span></div>
                                    <div class="animal-detail"><span>Data Nasc.:</span> <span id="animalNascimento">—</span></div>
                                    <div class="animal-detail"><span>Lote:</span> <span id="animalLote">—</span></div>
        </div>
        </div>
                        </div>
                    </div>

                    <!-- Coluna Direita -->
                    <div class="card-column">
                        <div class="column-title">
                            <i class="fas fa-weight"></i> Registro de pesagem
            </div>

                        <div class="peso-section">
                            <div class="peso-display" id="pesoDisplay">
                                <p class="peso-value" id="pesoValue">0<span class="peso-unit">kg</span></p>
                                <div class="peso-pending-indicator" id="pesoPendingIndicator" style="display: none;">
                                    <i class="fas fa-microphone"></i>
            </div>
                            </div>

                            <div class="peso-controls">
                                <button class="peso-btn" type="button" id="simularPesoBtn">
                                    <i class="fas fa-bolt"></i> Simular
                                </button>
                                <button class="peso-btn" type="button" id="limparPesoBtn">
                                    <i class="fas fa-eraser"></i> Limpar
                                </button>
                                <button class="peso-btn" type="button" id="toggleManualBtn">
                                    <i class="fas fa-keyboard"></i> Manual
                                </button>
                    </div>

                            <div class="peso-manual-input" id="pesoManualInput">
                                <div class="manual-input-container">
                                    <input type="number" class="manual-peso-input" id="manualPesoInput" placeholder="Digite o peso" min="0" step="0.1">
                                    <button class="peso-btn" type="button" id="voiceBtn">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="peso-btn" type="button" id="confirmarPesoBtn" style="flex: 1;">
                                        <i class="fas fa-check"></i> Confirmar peso
                                    </button>
                                    <button class="peso-btn" type="button" id="confirmarEGravarBtn" style="flex: 1; background: rgba(76, 175, 80, 0.8);">
                                        <i class="fas fa-save"></i> Confirmar e Gravar
                                    </button>
                                </div>
                                <div class="voice-instructions" id="voiceInstructions" style="display:none; font-size:0.8rem; margin-top:6px;">
                                    Diga "OK" para gravar o peso ou "CANCELAR" para descartar.
                        </div>
                    </div>

                            <div class="peso-date" style="margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.8);">
                                <i class="fas fa-calendar-alt"></i> <span id="pesoDate">--/--/---- --:--</span>
                    </div>
                            
                            <!-- Histórico de Pesagem -->
                            <div class="peso-historico" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Peso Registrado:</span>
                                    <span id="pesoRegistrado" style="color: rgba(255,255,255,1); font-weight: 600;">—</span>
                                </div>
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Último peso:</span>
                                    <span id="historicoUltimoPeso" style="color: rgba(255,255,255,1);">—</span>
                                </div>
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Data última pesagem:</span>
                                    <span id="historicoDataUltima" style="color: rgba(255,255,255,1);">—</span>
                                </div>
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Dias desde a última:</span>
                                    <span id="historicoDiasUltima" style="color: rgba(255,255,255,1);">—</span>
                                </div>
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Ganho total:</span>
                                    <span id="historicoGanhoTotal" style="color: rgba(255,255,255,1);">—</span>
                                </div>
                                <div class="historico-item" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                                    <span style="color: rgba(255,255,255,0.9);">Ganho diário médio:</span>
                                    <span id="historicoGanhoDiario" style="color: rgba(255,255,255,1);">—</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div>

            <!-- Configuração de trabalho -->
            <div class="work-config">
                <h2 class="config-title">
                    <i class="fas fa-cog"></i> Configuração do trabalho
                </h2>
                <p class="mb-3 text-muted" style="font-size: 0.85rem;">
                    Configure as tarefas que serão aplicadas a todos os animais desta sessão. As seleções ficam memorizadas no navegador.
                </p>

                <div class="config-grid">
                    <div class="config-card active" data-task="pesagem">
                        <div class="config-icon">
                            <i class="fas fa-weight"></i>
        </div>
                        <div class="config-text">Pesagem</div>
        </div>
                    <div class="config-card" data-task="vacina">
                        <div class="config-icon">
                            <i class="fas fa-syringe"></i>
        </div>
                        <div class="config-text">Vacinação</div>
        </div>
                    <div class="config-card" data-task="vermifugo">
                        <div class="config-icon">
                            <i class="fas fa-pills"></i>
        </div>
                        <div class="config-text">Vermifugação</div>
        </div>
                    <div class="config-card" data-task="iatf">
                        <div class="config-icon">
                            <i class="fas fa-baby-carriage"></i>
        </div>
                        <div class="config-text">IATF</div>
            </div>
                    <div class="config-card" data-task="diagnostico">
                        <div class="config-icon">
                            <i class="fas fa-stethoscope"></i>
            </div>
                        <div class="config-text">Diagnóstico</div>
                        </div>
                    <div class="config-card" data-task="andrologia">
                        <div class="config-icon">
                            <i class="fas fa-bull"></i>
                    </div>
                        <div class="config-text">Andrologia</div>
                        </div>
                    <div class="config-card" data-task="movimentacao">
                        <div class="config-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="config-text">Movimentação</div>
                        </div>
                        </div>

                <div class="row mt-3 g-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoNextToggle">
                            <label class="form-check-label" for="autoNextToggle" style="font-size:0.85rem;">
                                Ir automaticamente para o próximo animal após salvar
                            </label>
                    </div>
                </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="voicePromptsToggle">
                            <label class="form-check-label" for="voicePromptsToggle" style="font-size:0.85rem;">
                                Habilitar mensagens de voz (instruções)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <ul class="nav nav-tabs" id="workTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pesagem-tab" data-bs-toggle="tab" data-bs-target="#pesagem" type="button" role="tab">
                            <i class="fas fa-weight"></i> Pesagem
                            </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sanidade-tab" data-bs-toggle="tab" data-bs-target="#sanidade" type="button" role="tab">
                            <i class="fas fa-heartbeat"></i> Sanidade
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reprodutivo-tab" data-bs-toggle="tab" data-bs-target="#reprodutivo" type="button" role="tab">
                            <i class="fas fa-baby-carriage"></i> Reprodutivo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="movimentacao-tab" data-bs-toggle="tab" data-bs-target="#movimentacao" type="button" role="tab">
                            <i class="fas fa-exchange-alt"></i> Movimentação
                        </button>
                    </li>
                </ul>
                        </div>

            <div class="tab-content" id="workTabsContent">
                <!-- Pesagem -->
                <div class="tab-pane fade show active" id="pesagem" role="tabpanel">
                    <div class="section">
                        <div class="performance-section">
                            <h3 class="sub-section-title">
                                <i class="fas fa-chart-line"></i> Desempenho do animal
                            </h3>
                            <div class="performance-grid">
                                <div class="performance-item">
                                    <div class="performance-value" id="ganhoUltimaPesagem">0 kg</div>
                                    <div class="performance-label">Ganho da última pesagem</div>
                    </div>
                                <div class="performance-item">
                                    <div class="performance-value" id="ganhoTotal">0 kg</div>
                                    <div class="performance-label">Ganho total</div>
                    </div>
                                <div class="performance-item">
                                    <div class="performance-value" id="ganhoDiario">0 kg/dia</div>
                                    <div class="performance-label">Ganho diário</div>
                        </div>
                                <div class="performance-item">
                                    <div class="performance-value" id="ganhoPrimeira">0 kg</div>
                                    <div class="performance-label">Ganho desde a 1ª pesagem</div>
                    </div>
                    </div>
                            <div class="aparte-indicator" id="aparteIndicator">
                                Classificação: <span id="aparteText">Não definido</span>
                    </div>
                        </div>
                    </div>

                    <!-- Resumo da sessão -->
                    <div class="section mt-3">
                        <h2 class="section-title">
                            <i class="fas fa-list"></i> Resumo da sessão atual
                        </h2>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="sub-section">
                                    <h3 class="sub-section-title">
                                        <i class="fas fa-cow"></i> Animal atual
                                    </h3>
                                    <p style="font-size:0.85rem;">
                                        <strong>Brinco:</strong> <span id="resumoBrincoAtual">—</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Raça:</strong> <span id="resumoRacaAtual">—</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Sexo:</strong> <span id="resumoSexoAtual">—</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Data nasc.:</strong> <span id="resumoDataNascAtual">—</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Peso:</strong> <span id="resumoPesoAtual">0,0 kg</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Ganho total:</strong> <span id="resumoGanhoAtual">0 kg</span>
                                    </p>
                                    <p style="font-size:0.85rem;">
                                        <strong>Diagnóstico:</strong>
                                        <span id="resumoDiagnosticoAtual" class="diagnostico-pill nao-avaliada">Não avaliado</span>
                                    </p>
                    </div>
                </div>
                            <div class="col-md-8">
                                <div class="sub-section">
                                    <h3 class="sub-section-title">
                                        <i class="fas fa-clipboard-list"></i> Animais desta sessão
                                    </h3>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped mb-0" id="tabelaSessao">
                                            <thead>
                                                <tr>
                                                    <th>Brinco</th>
                                                    <th>Peso (kg)</th>
                                                    <th>Ganho</th>
                                                    <th>Diagnóstico</th>
                                                    <th>Data/hora</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                        </div>
                        </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Sanidade -->
                <div class="tab-pane fade" id="sanidade" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title">
                            <i class="fas fa-heartbeat"></i> Controle sanitário
                        </h2>
                        <div class="form-row-grid">
                        <div class="form-group">
                                <label class="form-label">Data da aplicação</label>
                                <input type="date" class="form-control" id="dataSanidade">
                        </div>
                        <div class="form-group">
                                <label class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="responsavelSanidade" placeholder="Nome do responsável">
                        </div>
                        </div>

                        <div class="sub-section">
                            <h3 class="sub-section-title">
                                <i class="fas fa-syringe"></i> Vacinação
                            </h3>
                            <div class="form-row-grid">
                        <div class="form-group">
                                    <label class="form-label">Vacina</label>
                                    <select class="form-control" id="vacinaSelect">
                                        <option value="">Selecione a vacina</option>
                                        <option value="aftosa">Febre Aftosa</option>
                                        <option value="brucelose">Brucelose</option>
                                        <option value="raiva">Raiva</option>
                                        <option value="clostridiose">Clostridiose</option>
                                        <option value="ibr">IBR</option>
                                        <option value="bvd">BVD</option>
                            </select>
                        </div>
                        <div class="form-group">
                                    <label class="form-label">Dose (ml)</label>
                                    <input type="number" class="form-control" id="doseVacina" placeholder="0,0" step="0.1">
                        </div>
                        </div>
                        <div class="form-group">
                                <label class="form-label">Lote da vacina</label>
                                <input type="text" class="form-control" id="loteVacina" placeholder="Número do lote">
                        </div>
                        </div>

                        <div class="sub-section">
                            <h3 class="sub-section-title">
                                <i class="fas fa-pills"></i> Vermifugação
                            </h3>
                            <div class="form-row-grid">
                        <div class="form-group">
                                    <label class="form-label">Vermífugo</label>
                                    <select class="form-control" id="vermifugoSelect">
                                        <option value="">Selecione o vermífugo</option>
                                        <option value="ivermectina">Ivermectina</option>
                                        <option value="albendazol">Albendazol</option>
                                        <option value="levamisol">Levamisol</option>
                                        <option value="closantel">Closantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                                    <label class="form-label">Dose (ml)</label>
                                    <input type="number" class="form-control" id="doseVermifugo" placeholder="0,0" step="0.1">
                        </div>
                    </div>
                    </div>

                    <div class="form-group">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" rows="3" id="obsSanidade" placeholder="Observações sobre o tratamento sanitário"></textarea>
                    </div>
                    </div>
                </div>

                <!-- Reprodutivo -->
                <div class="tab-pane fade" id="reprodutivo" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title">
                            <i class="fas fa-baby-carriage"></i> Controle reprodutivo
                        </h2>
                        <div class="form-row-grid">
                    <div class="form-group">
                                <label class="form-label">Data do procedimento</label>
                                <input type="date" class="form-control" id="dataReprodutivo">
                    </div>
                    <div class="form-group">
                                <label class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="responsavelReprodutivo" placeholder="Nome do responsável">
                    </div>
                        </div>

                        <div class="sub-section">
                            <h3 class="sub-section-title">
                                <i class="fas fa-syringe"></i> IATF - Inseminação Artificial
                            </h3>
                            <div class="form-row-grid">
                    <div class="form-group">
                                    <label class="form-label">Data da IATF</label>
                                    <input type="datetime-local" class="form-control" id="dataIATF">
                    </div>
                    <div class="form-group">
                                    <label class="form-label">Touro (sêmen)</label>
                                    <input type="text" class="form-control" id="touroIATF" placeholder="Identificação do touro">
                    </div>
                    </div>
                            <div class="form-row-grid">
                    <div class="form-group">
                                    <label class="form-label">Protocolo</label>
                                    <select class="form-control" id="protocoloIATF">
                                        <option value="">Selecione o protocolo</option>
                                        <option value="protocolo1">Protocolo 1 - CIDR</option>
                                        <option value="protocolo2">Protocolo 2 - Ovsynch</option>
                                        <option value="protocolo3">Protocolo 3 - J-Synch</option>
                            </select>
                        </div>
                        <div class="form-group">
                                    <label class="form-label">Número da palheta</label>
                                    <input type="text" class="form-control" id="palhetaIATF" placeholder="Número da palheta">
                        </div>
                        </div>
                        </div>
                        </div>
                </div>

                <!-- Movimentação -->
                <div class="tab-pane fade" id="movimentacao" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title">
                            <i class="fas fa-exchange-alt"></i> Controle de movimentação
                        </h2>
                        <div class="form-row-grid">
                        <div class="form-group">
                                <label class="form-label">Data da movimentação</label>
                                <input type="datetime-local" class="form-control" id="dataMovimentacao">
                        </div>
                        <div class="form-group">
                                <label class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="responsavelMovimentacao" placeholder="Nome do responsável">
                        </div>
                    </div>

                        <div class="sub-section">
                            <h3 class="sub-section-title">
                                <i class="fas fa-map-marker-alt"></i> Origem e destino
                            </h3>
                            <div class="form-row-grid">
                        <div class="form-group">
                                    <label class="form-label">Lote de origem</label>
                                    <select class="form-control" id="loteOrigem">
                                        <option value="">Selecione o lote de origem</option>
                                        {% for lote in animal_lotes %}
                                        <option value="{{ lote.id }}">{{ lote.nome }}{% if lote.sessao %} · {{ lote.sessao }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                                    <label class="form-label">Lote de destino</label>
                                    <select class="form-control" id="loteDestino">
                                        <option value="">Selecione o lote de destino</option>
                                {% for lote in animal_lotes %}
                                    <option value="{{ lote.id }}">{{ lote.nome }}{% if lote.sessao %} · {{ lote.sessao }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        </div>
                            <div class="form-row-grid">
                        <div class="form-group">
                                    <label class="form-label">Pasto de origem</label>
                                    <input type="text" class="form-control" id="pastoOrigem" placeholder="Identificação do pasto">
                        </div>
                        <div class="form-group">
                                    <label class="form-label">Pasto de destino</label>
                                    <input type="text" class="form-control" id="pastoDestino" placeholder="Identificação do pasto">
                        </div>
                        </div>
                    </div>
                        </div>
                        </div>
                        </div>

            <!-- Ações -->
            <div class="action-buttons">
                <button class="btn-action btn-next" type="button" id="nextAnimalBtn">
                    <i class="fas fa-arrow-right"></i> Próximo animal
                </button>
                <button class="btn-action btn-save" type="button" id="saveBtn">
                    <i class="fas fa-save"></i> Gravar Pesagem
            </button>
                        </div>
                        </div>
                </div>

    <!-- Popup de Aparte -->
    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="aparte-popup" id="apartePopup">
        <div id="apartePopupText">Aparte: Refugo</div>
                </div>

    <!-- Popup Diagnóstico Reprodutivo -->
    <div class="diagnostico-overlay" id="diagnosticoOverlay">
        <div class="diagnostico-popup">
            <div class="diagnostico-title">
                <i class="fas fa-stethoscope"></i> Diagnóstico reprodutivo do animal
                </div>
            <p class="mb-2" style="font-size:0.85rem;">
                Escolha o diagnóstico ou fale <strong>“prenha”</strong>, <strong>“vazia”</strong>, <strong>“não avaliada”</strong>, <strong>“descarte”</strong> ou <strong>“repetir cio”</strong>.
            </p>
            <div class="diagnostico-options">
                <div class="diagnostico-option prenha" data-value="PRENHA">
                    <span>Prenha</span>
            </div>
                <div class="diagnostico-option vazia" data-value="VAZIA">
                    <span>Vazia</span>
        </div>
                <div class="diagnostico-option nao-avaliada" data-value="NAO_AVALIADA">
                    <span>Não avaliada</span>
            </div>
                <div class="diagnostico-option descarte" data-value="DESCARTE">
                    <span>Descarte</span>
            </div>
                <div class="diagnostico-option repetir-cio" data-value="REPETIR_CIO">
                    <span>Repetir cio</span>
            </div>
            </div>
            <div class="diagnostico-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="diagnosticoCancelarBtn">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success btn-sm" id="diagnosticoConfirmarBtn">
                    Confirmar diagnóstico
                </button>
        </div>
    </div>
</div>

    <!-- Leitura de brinco com câmera -->
    <div id="scanBrincoContainer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2200; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:12px; padding:12px; max-width:480px; width:100%; text-align:center;">
            <p style="margin-bottom:8px; font-size:0.9rem;">Aponte a câmera para o código de barras do brinco</p>
            <video id="scanBrincoVideo" style="width:100%; border-radius:8px; background:#000;" autoplay muted playsinline></video>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="scanBrincoFecharBtn">
                Fechar
            </button>
        </div>
            </div>
                </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'gestao_rural/js/curral_super_tela_enhanced.js' %}"></script>
<script>
    // Estado (somente front-end por enquanto)
    const workState = {
        activeTasks: ['pesagem'],
        aparteConfig: {
            refugo: { min: 1, max: 200 },
            meio: { min: 201, max: 250 },
            cabeca: { min: 251, max: 300 },
            boiada: { min: 301, max: 380 }
        },
        autoNext: false,
        voicePrompts: false,
        pesoAtual: 0,
        animalId: null,
        animalAtual: null
    };

    const brincoInput = document.getElementById('brincoInput');
    const animalInfo = document.getElementById('animalInfo');
    const animalBrinco = document.getElementById('animalBrinco');
    const animalUltimoPeso = document.getElementById('animalUltimoPeso');
    const animalRaca = document.getElementById('animalRaca');
    const animalSexo = document.getElementById('animalSexo');
    const animalNascimento = document.getElementById('animalNascimento');
    
    // Campos de histórico de pesagem
    const pesoRegistrado = document.getElementById('pesoRegistrado');
    const historicoUltimoPeso = document.getElementById('historicoUltimoPeso');
    const historicoDataUltima = document.getElementById('historicoDataUltima');
    const historicoDiasUltima = document.getElementById('historicoDiasUltima');
    const historicoGanhoTotal = document.getElementById('historicoGanhoTotal');
    const historicoGanhoDiario = document.getElementById('historicoGanhoDiario');

    const pesoValue = document.getElementById('pesoValue');
    const pesoDisplay = document.getElementById('pesoDisplay');
    const pesoPendingIndicator = document.getElementById('pesoPendingIndicator');
    const simularPesoBtn = document.getElementById('simularPesoBtn');
    const limparPesoBtn = document.getElementById('limparPesoBtn');
    const toggleManualBtn = document.getElementById('toggleManualBtn');
    const pesoManualInput = document.getElementById('pesoManualInput');
    const manualPesoInput = document.getElementById('manualPesoInput');
    const confirmarPesoBtn = document.getElementById('confirmarPesoBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const pesoDate = document.getElementById('pesoDate');
    const voiceInstructions = document.getElementById('voiceInstructions');

    const ganhoUltimaEl = document.getElementById('ganhoUltimaPesagem');
    const ganhoTotalEl = document.getElementById('ganhoTotal');
    const ganhoDiarioEl = document.getElementById('ganhoDiario');
    const ganhoPrimeiraEl = document.getElementById('ganhoPrimeira');
    const aparteIndicator = document.getElementById('aparteIndicator');
    const aparteText = document.getElementById('aparteText');

    // elementos do resumo da sessão
    const resumoBrincoAtual = document.getElementById('resumoBrincoAtual');
    const resumoRacaAtual = document.getElementById('resumoRacaAtual');
    const resumoSexoAtual = document.getElementById('resumoSexoAtual');
    const resumoDataNascAtual = document.getElementById('resumoDataNascAtual');
    const resumoPesoAtual = document.getElementById('resumoPesoAtual');
    const resumoGanhoAtual = document.getElementById('resumoGanhoAtual');
    const resumoDiagnosticoAtual = document.getElementById('resumoDiagnosticoAtual');
    const tabelaSessaoBody = document.querySelector('#tabelaSessao tbody');

    const configCards = document.querySelectorAll('.config-card');
    const autoNextToggle = document.getElementById('autoNextToggle');
    const voicePromptsToggle = document.getElementById('voicePromptsToggle');
    const scanBrincoBtn = document.getElementById('scanBrincoBtn');
    const brincoVoiceBtn = document.getElementById('brincoVoiceBtn');
    const scanBrincoContainer = document.getElementById('scanBrincoContainer');
    const scanBrincoVideo = document.getElementById('scanBrincoVideo');
    const scanBrincoFecharBtn = document.getElementById('scanBrincoFecharBtn');
    const diagnosticoOverlay = document.getElementById('diagnosticoOverlay');
    const diagnosticoOptions = document.querySelectorAll('.diagnostico-option');
    const diagnosticoCancelarBtn = document.getElementById('diagnosticoCancelarBtn');
    const diagnosticoConfirmarBtn = document.getElementById('diagnosticoConfirmarBtn');

    let manualMode = false;
    let recognition = null;
    let pesoDetectadoPorVoz = null;
    let aguardandoConfirmacao = false; // confirmação de peso
    let diagnosticoEmAberto = false;
    let diagnosticoSelecionado = null;
    let scanStream = null;
    let barcodeDetector = 'BarcodeDetector' in window ? new BarcodeDetector({ formats: ['code_128','ean_13','code_39'] }) : null;
    let ouvindoBrinco = false;
    let registrosSessao = [];

    const historicoPesagens = {
        // Exemplo estático – depois pode vir via JSON do backend
        'BR-2023-0456': [
            { data: '2023-01-15T10:00', peso: 280 },
            { data: '2023-03-20T10:00', peso: 320 },
            { data: '2023-05-25T10:00', peso: 350 }
        ]
    };

    function atualizarPeso(peso, pendente = false) {
        console.log('⚖️ atualizarPeso chamado:', { peso, pendente, animalId: workState.animalId, brinco: brincoInput.value });
        workState.pesoAtual = peso;
        pesoValue.innerHTML = peso.toFixed(1) + '<span class="peso-unit">kg</span>';

        if (peso > 0) {
            if (pendente) {
                pesoDisplay.classList.remove('active');
                pesoDisplay.classList.add('pending');
                pesoPendingIndicator.style.display = 'flex';
            } else {
                pesoDisplay.classList.remove('pending');
                pesoDisplay.classList.add('active');
                pesoPendingIndicator.style.display = 'none';
                aguardandoConfirmacao = false;
                calcularAparteEGanhos(peso);
                atualizarDataPesagem();
            }
        } else {
            pesoDisplay.classList.remove('active', 'pending');
            pesoPendingIndicator.style.display = 'none';
            aguardandoConfirmacao = false;
            limparCamposDesempenho();
        }
    }

    function atualizarDataPesagem() {
        const now = new Date();
        const dateString = now.toLocaleDateString('pt-BR') + ' ' +
            now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        pesoDate.textContent = dateString;
    }

    function simularPeso() {
        const pesos = [185, 220, 275, 320, 195, 240, 285, 335];
        const pesoAleatorio = pesos[Math.floor(Math.random() * pesos.length)];
        atualizarPeso(pesoAleatorio);
    }

    function toggleManualMode() {
        manualMode = !manualMode;
        if (manualMode) {
            pesoManualInput.classList.add('active');
            toggleManualBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
            toggleManualBtn.style.background = 'rgba(244, 67, 54, 0.5)';
            manualPesoInput.focus();
            aguardandoConfirmacao = false;
            atualizarPeso(0);
        } else {
            pesoManualInput.classList.remove('active');
            toggleManualBtn.innerHTML = '<i class="fas fa-keyboard"></i> Manual';
            toggleManualBtn.style.background = 'rgba(255,255,255,0.2)';
            manualPesoInput.value = '';
            aguardandoConfirmacao = false;
            atualizarPeso(0);
        }
    }

    function confirmarPesoManual() {
        const peso = parseFloat(manualPesoInput.value);
        if (!isNaN(peso) && peso > 0) {
            console.log('✅ Peso confirmado manualmente:', peso);
            
            // Atualiza o peso no display (fica VERDE - ativo)
            atualizarPeso(peso);
            
            // Fecha o modo manual
            toggleManualMode();
            
            // Feedback visual - destaca o botão Gravar
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.style.animation = 'pulse 2s infinite';
                saveBtn.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.6)';
                setTimeout(() => {
                    saveBtn.style.animation = '';
                    saveBtn.style.boxShadow = '';
                }, 3000);
            }
            
            // Verifica se há animal identificado
            if (!workState.animalId) {
                console.warn('⚠️ Animal não identificado. Identifique um animal primeiro.');
                alert('Por favor, identifique um animal (digite o brinco) antes de gravar a pesagem.');
                return;
            }
            
            // Após confirmar peso, se diagnóstico estiver ativo abre popup
            if (workState.activeTasks.includes('diagnostico')) {
                abrirPopupDiagnostico();
            } else if (workState.autoNext) {
                // Se auto-próximo estiver ativo, salva automaticamente e vai para próximo
                console.log('🔄 Auto-próximo ativado, salvando automaticamente...');
                if (window.salvarPesagemBackend) {
                    window.salvarPesagemBackend().then(sucesso => {
                        if (sucesso) {
                            irParaProximoAnimal();
                        }
                    });
                } else {
                    console.error('❌ Função salvarPesagemBackend não disponível');
                }
            } else {
                // Se não tem auto-próximo, mostra mensagem para o usuário gravar
                console.log('💡 Peso confirmado. Clique em "Gravar Pesagem" para salvar.');
                // Não mostra alerta para não interromper o fluxo, apenas destaca o botão
            }
        } else {
            alert('Por favor, insira um peso válido.');
        }
    }

    function inicializarReconhecimentoVoz() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert('Seu navegador não suporta reconhecimento de voz. Use Chrome ou Edge.');
                return;
            }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'pt-BR';

        recognition.onstart = function () {
            voiceBtn.classList.add('recording');
        };

        recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript.toLowerCase();

            // modo leitura de brinco por voz
            if (ouvindoBrinco) {
                const numerosBrinco = transcript.match(/\d+/g);
                if (numerosBrinco && numerosBrinco.length > 0) {
                    const brincoFalado = numerosBrinco.join('');
                    if (brincoFalado.length >= 6) {
                        brincoInput.value = brincoFalado;
                        atualizarEstadoBrinco();
                        ouvindoBrinco = false;
                return;
            }
                }
                // se não conseguiu entender, apenas continua aguardando nova fala
                return;
            }

            // se popup de diagnóstico está aberto, comandos controlam o diagnóstico
            if (diagnosticoEmAberto) {
                // "ok" confirma o diagnóstico já selecionado
                if (transcript.includes('ok') || transcript.includes('tá bom') || transcript.includes('ta bom') || transcript.includes('confirmar')) {
                    if (diagnosticoSelecionado) {
                        diagnosticoConfirmarBtn.click();
                    }
                return;
            }
                // "cancelar" fecha o popup
                if (transcript.includes('cancelar') || transcript.includes('não') || transcript.includes('nao')) {
                    diagnosticoCancelarBtn.click();
                return;
            }
                // palavras que escolhem o diagnóstico
                if (transcript.includes('prenha')) selecionarDiagnosticoPorValor('PRENHA');
                else if (transcript.includes('vazia')) selecionarDiagnosticoPorValor('VAZIA');
                else if (transcript.includes('não avaliada') || transcript.includes('nao avaliada')) selecionarDiagnosticoPorValor('NAO_AVALIADA');
                else if (transcript.includes('descarte')) selecionarDiagnosticoPorValor('DESCARTE');
                else if (transcript.includes('repetir') || transcript.includes('cio')) selecionarDiagnosticoPorValor('REPETIR_CIO');
                return;
            }

            // se já temos um peso pendente, interpretar comandos de voz para confirmar/cancelar
            if (aguardandoConfirmacao) {
                if (transcript.includes('ok') || transcript.includes('tá bom') || transcript.includes('ta bom') || transcript.includes('confirmar')) {
                    // confirma o peso que já está no campo manual
                    confirmarPesoManual();
                    voiceInstructions.style.display = 'none';
                    aguardandoConfirmacao = false;
                    return;
                }
                if (transcript.includes('cancelar') || transcript.includes('não') || transcript.includes('nao')) {
                    // cancela o peso pendente
                    manualPesoInput.value = '';
                    atualizarPeso(0);
                    voiceInstructions.style.display = 'none';
                    aguardandoConfirmacao = false;
                return;
            }
                // não entendeu comando, continua aguardando
                return;
            }

            // primeira etapa: reconhecer o número do peso
            const numeros = transcript.match(/\d+(\,\d+|\.\d+)?/g);
            if (numeros && numeros.length > 0) {
                const normalizado = numeros[0].replace(',', '.');
                pesoDetectadoPorVoz = parseFloat(normalizado);
                if (!isNaN(pesoDetectadoPorVoz) && pesoDetectadoPorVoz > 0) {
                    manualPesoInput.value = pesoDetectadoPorVoz.toFixed(1);
                    atualizarPeso(pesoDetectadoPorVoz, true);
                    voiceInstructions.style.display = 'block';
                    aguardandoConfirmacao = true;
                    return;
                }
            }
            alert('Não consegui entender o peso. Tente novamente aproximando mais do microfone.');
        };

        recognition.onend = function () {
            // se o botão ainda está em modo "gravando", continua ouvindo até o usuário parar
            if (voiceBtn.classList.contains('recording')) {
                recognition.start();
            }
        };

        recognition.onerror = function (event) {
            console.error('Erro reconhecimento de voz:', event.error);
            voiceBtn.classList.remove('recording');
        };
    }

    function determinarAparte(peso) {
        const c = workState.aparteConfig;
        if (peso >= c.refugo.min && peso <= c.refugo.max) return { nome: 'Refugo', cor: 'refugo' };
        if (peso >= c.meio.min && peso <= c.meio.max) return { nome: 'Meio', cor: 'meio' };
        if (peso >= c.cabeca.min && peso <= c.cabeca.max) return { nome: 'Cabeceira', cor: 'cabeca' };
        if (peso >= c.boiada.min && peso <= c.boiada.max) return { nome: 'Boiada', cor: 'boiada' };
        return { nome: 'Fora da faixa', cor: '' };
    }

    function calcularGanhos(pesoAtual, historico) {
        if (!historico || historico.length === 0) {
            return { ganhoUltima: 0, ganhoTotal: 0, ganhoDiario: 0, ganhoPrimeira: 0 };
        }
        const primeira = historico[0];
        const ultima = historico[historico.length - 1];
        const ganhoUltima = pesoAtual - ultima.peso;
        const ganhoTotal = pesoAtual - primeira.peso;
        const ganhoPrimeira = ganhoTotal;
        const dataPrimeira = new Date(primeira.data);
        const diffDias = (new Date().getTime() - dataPrimeira.getTime()) / (1000 * 3600 * 24);
        const ganhoDiario = diffDias > 0 ? (ganhoTotal / diffDias).toFixed(2) : 0;
        return { ganhoUltima, ganhoTotal, ganhoDiario, ganhoPrimeira };
    }

    function atualizarDesempenho(ganhos, aparte) {
        ganhoUltimaEl.textContent = `${ganhos.ganhoUltima > 0 ? '+' : ''}${ganhos.ganhoUltima.toFixed(1)} kg`;
        ganhoTotalEl.textContent = `${ganhos.ganhoTotal > 0 ? '+' : ''}${ganhos.ganhoTotal.toFixed(1)} kg`;
        ganhoDiarioEl.textContent = `${ganhos.ganhoDiario > 0 ? '+' : ''}${ganhos.ganhoDiario} kg/dia`;
        ganhoPrimeiraEl.textContent = `${ganhos.ganhoPrimeira > 0 ? '+' : ''}${ganhos.ganhoPrimeira.toFixed(1)} kg`;

        aparteText.textContent = aparte.nome;
        aparteIndicator.classList.remove('aparte-refugo', 'aparte-meio', 'aparte-cabeca', 'aparte-boiada');
        if (aparte.cor) aparteIndicator.classList.add(`aparte-${aparte.cor}`);
    }

    function exibirPopupAparte(aparte) {
        const popup = document.getElementById('apartePopup');
        const overlay = document.getElementById('popupOverlay');
        const popupText = document.getElementById('apartePopupText');
        popupText.textContent = `Aparte: ${aparte.nome}`;
        popup.classList.remove('refugo', 'meio', 'cabeca', 'boiada');
        if (aparte.cor) popup.classList.add(aparte.cor);
        popup.classList.add('show');
        overlay.classList.add('show');
        setTimeout(() => {
            popup.classList.remove('show');
            overlay.classList.remove('show');
        }, 2000);
    }

    function limparCamposDesempenho() {
        ganhoUltimaEl.textContent = '0 kg';
        ganhoTotalEl.textContent = '0 kg';
        ganhoDiarioEl.textContent = '0 kg/dia';
        ganhoPrimeiraEl.textContent = '0 kg';
        aparteText.textContent = 'Não definido';
        aparteIndicator.classList.remove('aparte-refugo', 'aparte-meio', 'aparte-cabeca', 'aparte-boiada');
    }

    function abrirPopupDiagnostico() {
        diagnosticoEmAberto = true;
        diagnosticoSelecionado = null;
        diagnosticoOptions.forEach(opt => opt.classList.remove('active'));
        diagnosticoOverlay.classList.add('show');
        if (workState.voicePrompts) {
            falarMensagem('Informar diagnóstico');
        }
    }

    function fecharPopupDiagnostico() {
        diagnosticoEmAberto = false;
        diagnosticoOverlay.classList.remove('show');
    }

    function selecionarDiagnosticoPorValor(valor) {
        diagnosticoSelecionado = valor;
        diagnosticoOptions.forEach(opt => {
            if (opt.getAttribute('data-value') === valor) opt.classList.add('active');
            else opt.classList.remove('active');
        });
    }

    function calcularAparteEGanhos(pesoAtual) {
        const brinco = brincoInput.value || 'BR-2023-0456';
        const historico = historicoPesagens[brinco] || historicoPesagens['BR-2023-0456'] || [];
        const aparte = determinarAparte(pesoAtual);
        const ganhos = calcularGanhos(pesoAtual, historico);
        atualizarDesempenho(ganhos, aparte);
        exibirPopupAparte(aparte);
    }

    function irParaProximoAnimal() {
        brincoInput.value = '';
        animalInfo.style.display = 'none';
        atualizarPeso(0);
        limparCamposDesempenho();
        brincoInput.focus();
    }

    function falarMensagem(texto) {
        if (!('speechSynthesis' in window)) return;
        try {
            const utter = new SpeechSynthesisUtterance(texto);
            utter.lang = 'pt-BR';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        } catch (e) {
            console.warn('Falha ao falar mensagem:', e);
        }
    }

    function registrarAnimalNaSessao(diagnosticoValor) {
        const registro = {
            brinco: brincoInput.value || '—',
            raca: (animalRaca && animalRaca.textContent.trim()) || '—',
            sexo: (animalSexo && animalSexo.textContent.trim()) || '—',
            dataNasc: (animalNascimento && animalNascimento.textContent.trim()) || '—',
            peso: workState.pesoAtual || 0,
            ganho: ganhoTotalEl.textContent || '0 kg',
            diagnostico: diagnosticoValor || 'NAO_AVALIADA',
            dataHora: new Date()
        };
        registrosSessao.unshift(registro);
        atualizarResumoSessao();
        
        // Integração com sistema enhanced
        if (window.curralEnhanced) {
            const startTime = registro.startTime || new Date();
            const processingTime = (new Date() - startTime) / 1000; // segundos
            window.curralEnhanced.recordAnimalProcessed(processingTime);
            
            // Verifica alertas inteligentes
            const animalData = {
                ultimoPeso: parseFloat(animalUltimoPeso.textContent) || null,
                diasDesdeUltima: 30, // TODO: calcular do backend
                vacinaPendente: null // TODO: buscar do backend
            };
            window.curralEnhanced.checkIntelligentAlerts(animalData, workState.pesoAtual);
        }
    }

    function atualizarResumoSessao() {
        if (registrosSessao.length === 0) {
            resumoBrincoAtual.textContent = '—';
            resumoRacaAtual.textContent = '—';
            resumoSexoAtual.textContent = '—';
            resumoDataNascAtual.textContent = '—';
            resumoPesoAtual.textContent = '0,0 kg';
            resumoGanhoAtual.textContent = '0 kg';
            resumoDiagnosticoAtual.textContent = 'Não avaliado';
            resumoDiagnosticoAtual.className = 'diagnostico-pill nao-avaliada';
            tabelaSessaoBody.innerHTML = '';
            return;
        }

        const atual = registrosSessao[0];
        resumoBrincoAtual.textContent = atual.brinco;
        resumoRacaAtual.textContent = atual.raca;
        resumoSexoAtual.textContent = atual.sexo;
        resumoDataNascAtual.textContent = atual.dataNasc;
        resumoPesoAtual.textContent = `${atual.peso.toFixed ? atual.peso.toFixed(1) : atual.peso} kg`;
        resumoGanhoAtual.textContent = atual.ganho;

        const diagClass = mapearClasseDiagnostico(atual.diagnostico);
        const diagLabel = mapearLabelDiagnostico(atual.diagnostico);
        resumoDiagnosticoAtual.textContent = diagLabel;
        resumoDiagnosticoAtual.className = `diagnostico-pill ${diagClass}`;

        tabelaSessaoBody.innerHTML = registrosSessao
            .slice(0, 30)
            .map(reg => {
                const cls = mapearClasseDiagnostico(reg.diagnostico);
                const lbl = mapearLabelDiagnostico(reg.diagnostico);
                const dataStr = reg.dataHora.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                const pesoStr = `${reg.peso.toFixed ? reg.peso.toFixed(1) : reg.peso}`;
                return `
                    <tr>
                        <td>${reg.brinco}</td>
                        <td>${pesoStr}</td>
                        <td>${reg.ganho}</td>
                        <td><span class="diagnostico-pill ${cls}">${lbl}</span></td>
                        <td>${dataStr}</td>
                    </tr>
                `;
            })
            .join('');
    }

    function mapearClasseDiagnostico(valor) {
        switch ((valor || '').toUpperCase()) {
            case 'PRENHA': return 'prenha';
            case 'VAZIA': return 'vazia';
            case 'DESCARTE': return 'descarte';
            case 'REPETIR_CIO': return 'repetir-cio';
            case 'NAO_AVALIADA':
            default: return 'nao-avaliada';
        }
    }

    function mapearLabelDiagnostico(valor) {
        switch ((valor || '').toUpperCase()) {
            case 'PRENHA': return 'Prenha';
            case 'VAZIA': return 'Vazia';
            case 'DESCARTE': return 'Descarte';
            case 'REPETIR_CIO': return 'Repetir cio';
            case 'NAO_AVALIADA':
            default: return 'Não avaliada';
        }
    }

    function saveWorkState() {
        try {
            localStorage.setItem('monpecCurralWorkState', JSON.stringify(workState));
        } catch (e) {
            console.warn('Não foi possível salvar o estado no localStorage', e);
        }
    }

    function loadWorkState() {
        try {
            const saved = localStorage.getItem('monpecCurralWorkState');
            if (!saved) return;
            const state = JSON.parse(saved);
            if (Array.isArray(state.activeTasks)) {
                workState.activeTasks = state.activeTasks;
                configCards.forEach(card => {
                    const task = card.getAttribute('data-task');
                    if (workState.activeTasks.includes(task)) {
                        card.classList.add('active');
                    } else {
                        card.classList.remove('active');
                    }
                });
            }
            if (state.aparteConfig) {
                workState.aparteConfig = state.aparteConfig;
            }
            if (typeof state.autoNext === 'boolean') {
                workState.autoNext = state.autoNext;
                autoNextToggle.checked = workState.autoNext;
            }
            if (typeof state.voicePrompts === 'boolean') {
                workState.voicePrompts = state.voicePrompts;
                voicePromptsToggle.checked = workState.voicePrompts;
            }
        } catch (e) {
            console.warn('Não foi possível carregar o estado do localStorage', e);
        }
    }

    // Controles de janela
    let isMinimized = false;
    let isMaximized = false;
    let previousState = null;

    function toggleMinimize() {
        isMinimized = !isMinimized;
        if (isMinimized) {
            document.body.classList.add('curral-minimized');
            // Salva o estado anterior se não estava minimizado
            if (!previousState) {
                previousState = {
                    scrollTop: document.querySelector('.curral-content-wrapper').scrollTop
                };
            }
        } else {
            document.body.classList.remove('curral-minimized');
            // Restaura scroll se havia estado anterior
            if (previousState && previousState.scrollTop) {
                setTimeout(() => {
                    document.querySelector('.curral-content-wrapper').scrollTop = previousState.scrollTop;
                }, 100);
            }
        }
    }

    function toggleMaximize() {
        isMaximized = !isMaximized;
        const icon = document.getElementById('curralMaximizeIcon');
        
        if (isMaximized) {
            // Entra em modo fullscreen do navegador se suportado
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Erro ao entrar em fullscreen:', err);
                });
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            }
            icon.classList.remove('bi-arrows-fullscreen');
            icon.classList.add('bi-arrows-angle-contract');
        } else {
            // Sai do modo fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {
                    console.log('Erro ao sair do fullscreen:', err);
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            icon.classList.remove('bi-arrows-angle-contract');
            icon.classList.add('bi-arrows-fullscreen');
        }
    }

    function closeWindow() {
        if (confirm('Deseja realmente fechar o Curral Inteligente?')) {
            // Volta para a página anterior ou para os módulos
            window.location.href = '{% url "propriedade_modulos" propriedade.id %}';
        }
    }

    // Detecta mudanças no fullscreen do navegador
    document.addEventListener('fullscreenchange', function() {
        const icon = document.getElementById('curralMaximizeIcon');
        if (document.fullscreenElement) {
            isMaximized = true;
            icon.classList.remove('bi-arrows-fullscreen');
            icon.classList.add('bi-arrows-angle-contract');
        } else {
            isMaximized = false;
            icon.classList.remove('bi-arrows-angle-contract');
            icon.classList.add('bi-arrows-fullscreen');
        }
    });

    document.addEventListener('webkitfullscreenchange', function() {
        const icon = document.getElementById('curralMaximizeIcon');
        if (document.webkitFullscreenElement) {
            isMaximized = true;
            icon.classList.remove('bi-arrows-fullscreen');
            icon.classList.add('bi-arrows-angle-contract');
        } else {
            isMaximized = false;
            icon.classList.remove('bi-arrows-angle-contract');
            icon.classList.add('bi-arrows-fullscreen');
        }
    });

    document.addEventListener('msfullscreenchange', function() {
        const icon = document.getElementById('curralMaximizeIcon');
        if (document.msFullscreenElement) {
            isMaximized = true;
            icon.classList.remove('bi-arrows-fullscreen');
            icon.classList.add('bi-arrows-angle-contract');
        } else {
            isMaximized = false;
            icon.classList.remove('bi-arrows-angle-contract');
            icon.classList.add('bi-arrows-fullscreen');
        }
    });

    // Script de inicialização imediata (antes do DOMContentLoaded)
    (function() {
        console.log('🚀 Script de salvamento de pesagem carregado');
        console.log('📅 Timestamp:', new Date().toISOString());
        
        // Função global para salvar pesagem (disponível imediatamente)
        window.salvarPesagemGlobal = async function() {
            console.log('💾 Função salvarPesagemGlobal chamada');
            // Esta função será sobrescrita quando o DOMContentLoaded executar
            if (window.salvarPesagemBackend) {
                return await window.salvarPesagemBackend();
            } else {
                console.warn('⚠️ Função salvarPesagemBackend ainda não está disponível');
                return false;
            }
        };
    })();

    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 DOMContentLoaded - Inicializando curral dashboard...');
        console.log('📅 Timestamp:', new Date().toISOString());
        
        document.body.classList.add('curral-fullscreen');
        loadWorkState();
        brincoInput.focus();
        atualizarDataPesagem();
        
        // Log de inicialização
        const saveBtnExists = !!document.getElementById('saveBtn');
        console.log('📋 Elementos encontrados:', {
            saveBtn: saveBtnExists,
            brincoInput: !!brincoInput,
            animalInfo: !!animalInfo,
            pesoValue: !!pesoValue
        });
        
        // Lista todos os botões com "Gravar" no texto
        const allButtons = document.querySelectorAll('button');
        const gravarButtons = Array.from(allButtons).filter(btn => 
            btn.textContent.includes('Gravar') || 
            btn.textContent.includes('gravar') ||
            btn.id.includes('gravar')
        );
        console.log('🔍 Botões "Gravar" encontrados:', gravarButtons.map(btn => ({
            id: btn.id,
            text: btn.textContent.trim(),
            class: btn.className
        })));

        // Event listeners para os botões de janela
        document.getElementById('curralMinimizeBtn').addEventListener('click', toggleMinimize);
        document.getElementById('curralMaximizeBtn').addEventListener('click', toggleMaximize);
        document.getElementById('curralCloseBtn').addEventListener('click', closeWindow);

        // controle de leitura de brinco / habilitação da pesagem
        async function atualizarEstadoBrinco() {
            const temBrinco = brincoInput.value && brincoInput.value.length > 3;
            const controles = [simularPesoBtn, limparPesoBtn, toggleManualBtn];
            controles.forEach(btn => btn.disabled = !temBrinco);
            manualPesoInput.disabled = !temBrinco;

            if (temBrinco) {
                // Busca o animal no backend
                const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
                const propriedadeId = urlMatch ? urlMatch[1] : null;
                
                if (propriedadeId) {
                    try {
                        const response = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value.trim())}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'animal' && data.dados) {
                                // Armazena o ID do animal no workState
                                workState.animalId = data.dados.id;
                                workState.animalAtual = data.dados;
                                
                                // Atualiza informações do animal na interface
                                animalInfo.style.display = 'block';
                                animalBrinco.textContent = data.dados.numero_brinco || brincoInput.value;
                                if (animalRaca) animalRaca.textContent = data.dados.raca || '—';
                                if (animalSexo) animalSexo.textContent = data.dados.sexo || '—';
                                if (animalNascimento) animalNascimento.textContent = data.dados.data_nascimento || '—';
                                
                                // Atualiza último peso
                                const ultimoPeso = data.dados.peso_atual || data.dados.ultimo_peso || data.dados.pesagem_atual?.peso;
                                if (ultimoPeso) {
                                    const pesoFormatado = `${parseFloat(ultimoPeso).toFixed(1).replace('.', ',')} kg`;
                                    if (animalUltimoPeso) {
                                        animalUltimoPeso.textContent = pesoFormatado;
                                    }
                                    if (historicoUltimoPeso) {
                                        historicoUltimoPeso.textContent = pesoFormatado;
                                    }
                                    
                                    // Atualiza data da última pesagem se disponível
                                    if (data.dados.data_ultima_pesagem && historicoDataUltima) {
                                        const dataUltima = new Date(data.dados.data_ultima_pesagem);
                                        historicoDataUltima.textContent = dataUltima.toLocaleDateString('pt-BR') + ' ' + dataUltima.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                        
                                        // Calcula dias desde a última pesagem
                                        if (historicoDiasUltima) {
                                            const diasDiff = Math.floor((new Date() - dataUltima) / (1000 * 60 * 60 * 24));
                                            historicoDiasUltima.textContent = `${diasDiff} ${diasDiff === 1 ? 'dia' : 'dias'}`;
                                        }
                                    } else {
                                        if (historicoDataUltima) historicoDataUltima.textContent = '—';
                                        if (historicoDiasUltima) historicoDiasUltima.textContent = '—';
                                    }
                                    
                                    // Atualiza ganhos se disponível
                                    if (data.dados.ganho_total !== undefined && historicoGanhoTotal) {
                                        const ganho = parseFloat(data.dados.ganho_total);
                                        historicoGanhoTotal.textContent = `${ganho >= 0 ? '+' : ''}${ganho.toFixed(1).replace('.', ',')} kg`;
                                    } else if (historicoGanhoTotal) {
                                        historicoGanhoTotal.textContent = '—';
                                    }
                                    if (data.dados.ganho_diario !== undefined && historicoGanhoDiario) {
                                        const ganhoDiario = parseFloat(data.dados.ganho_diario);
                                        historicoGanhoDiario.textContent = `${ganhoDiario >= 0 ? '+' : ''}${ganhoDiario.toFixed(2).replace('.', ',')} kg/dia`;
                                    } else if (historicoGanhoDiario) {
                                        historicoGanhoDiario.textContent = '—';
                                    }
                                } else {
                                    if (animalUltimoPeso) animalUltimoPeso.textContent = '—';
                                    if (historicoUltimoPeso) historicoUltimoPeso.textContent = '—';
                                    if (historicoDataUltima) historicoDataUltima.textContent = '—';
                                    if (historicoDiasUltima) historicoDiasUltima.textContent = '—';
                                    if (historicoGanhoTotal) historicoGanhoTotal.textContent = '—';
                                    if (historicoGanhoDiario) historicoGanhoDiario.textContent = '—';
                                }
                                
                                if (workState.voicePrompts) {
                                    falarMensagem('Informar pesagem');
                                }
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao buscar animal:', error);
                    }
                }
                
                // Fallback: mostra informações básicas mesmo sem buscar no backend
                animalInfo.style.display = 'block';
                animalBrinco.textContent = brincoInput.value;
                animalUltimoPeso.textContent = '—';
                if (workState.voicePrompts) {
                    falarMensagem('Informar pesagem');
                }
            } else {
                animalInfo.style.display = 'none';
                atualizarPeso(0);
                workState.animalId = null;
                workState.animalAtual = null;
            }
        }

        brincoInput.addEventListener('input', atualizarEstadoBrinco);

        simularPesoBtn.addEventListener('click', simularPeso);
        limparPesoBtn.addEventListener('click', () => atualizarPeso(0));
        toggleManualBtn.addEventListener('click', toggleManualMode);
        confirmarPesoBtn.addEventListener('click', confirmarPesoManual);
        
        // Botão Confirmar e Gravar (novo - salva automaticamente)
        const confirmarEGravarBtn = document.getElementById('confirmarEGravarBtn');
        if (confirmarEGravarBtn) {
            confirmarEGravarBtn.addEventListener('click', async function() {
                const peso = parseFloat(manualPesoInput.value);
                if (!isNaN(peso) && peso > 0) {
                    console.log('✅ Confirmando peso e gravando automaticamente:', peso);
                    
                    // Confirma o peso (atualiza display)
                    atualizarPeso(peso);
                    toggleManualMode();
                    
                    // Verifica se há animal identificado
                    if (!workState.animalId) {
                        alert('Por favor, identifique um animal (digite o brinco) antes de gravar a pesagem.');
                        return;
                    }
                    
                    // Salva imediatamente no backend
                    if (window.salvarPesagemBackend) {
                        const sucesso = await window.salvarPesagemBackend();
                        if (sucesso) {
                            console.log('✅ Peso confirmado e gravado com sucesso!');
                            // Se auto-próximo estiver ativo, vai para próximo animal
                            if (workState.autoNext) {
                                irParaProximoAnimal();
                            }
                        } else {
                            console.error('❌ Erro ao gravar pesagem');
                        }
                    } else {
                        alert('Erro: Função de salvamento não está disponível. Recarregue a página.');
                    }
                } else {
                    alert('Por favor, insira um peso válido.');
                }
            });
        }
        
        // Enter no input: Enter = Confirmar, Shift+Enter = Confirmar e Gravar
        manualPesoInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                // Shift+Enter = Confirmar e Gravar
                if (e.shiftKey && confirmarEGravarBtn) {
                    confirmarEGravarBtn.click();
                } else {
                    // Enter normal = Apenas Confirmar
                    confirmarPesoManual();
                }
            }
        });
        
        // Permite digitar peso diretamente no display principal também
        pesoValue.addEventListener('click', function() {
            // Se clicar no display de peso, abre o modo manual
            if (!manualMode) {
                toggleManualMode();
            }
        });
        
        // Listener para quando o peso é digitado - atualiza em tempo real
        manualPesoInput.addEventListener('input', function(e) {
            const pesoDigitado = parseFloat(e.target.value);
            if (!isNaN(pesoDigitado) && pesoDigitado > 0) {
                // Atualiza o display em tempo real enquanto digita (mas não confirma)
                pesoValue.innerHTML = pesoDigitado.toFixed(1) + '<span class="peso-unit">kg</span>';
                // Não aplica estado visual ainda (fica cinza até confirmar)
            } else if (e.target.value === '') {
                // Se limpar, volta para 0
                pesoValue.innerHTML = '0<span class="peso-unit">kg</span>';
            }
        });
        
        // Listener para detectar quando o peso é digitado manualmente
        manualPesoInput.addEventListener('input', function(e) {
            const pesoDigitado = parseFloat(e.target.value);
            if (!isNaN(pesoDigitado) && pesoDigitado > 0) {
                console.log('📝 Peso digitado manualmente:', pesoDigitado);
                console.log('📊 Estado atual:', {
                    pesoAtual: workState.pesoAtual,
                    animalId: workState.animalId,
                    brinco: brincoInput.value
                });
            }
        });
        
        // Listener direto no botão "Gravar" - funciona mesmo se outros listeners falharem
        function anexarListenerGravarDireto() {
            const gravarBtn = document.getElementById('saveBtn');
            if (gravarBtn) {
                console.log('✅ Botão Gravar encontrado, adicionando listener direto...');
                
                // Remove listeners anteriores
                const novoBtn = gravarBtn.cloneNode(true);
                gravarBtn.parentNode.replaceChild(novoBtn, gravarBtn);
                
                document.getElementById('saveBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🔘 BOTÃO GRAVAR CLICADO!');
                    console.log('📊 Estado no momento do clique:', {
                        pesoAtual: typeof workState !== 'undefined' ? workState.pesoAtual : 'workState não definido',
                        animalId: typeof workState !== 'undefined' ? workState.animalId : 'workState não definido',
                        animalAtual: typeof workState !== 'undefined' ? workState.animalAtual : 'workState não definido',
                        brinco: brincoInput ? brincoInput.value : 'brincoInput não definido',
                        pesoDisplay: pesoValue ? pesoValue.textContent : 'pesoValue não definido'
                    });
                    
                    // Validações básicas
                    if (!brincoInput || !brincoInput.value) {
                        alert('Identifique um animal primeiro.');
                        return;
                    }
                    
                    // IMPORTANTE: Captura o peso de múltiplas fontes (prioridade: input manual > workState > display)
                    let pesoParaUsar = typeof workState !== 'undefined' ? workState.pesoAtual : 0;
                    
                    // PRIORIDADE 1: Tenta ler do input manual (se o usuário digitou mas não confirmou)
                    if (!pesoParaUsar || pesoParaUsar <= 0) {
                        const manualInputEl = document.getElementById('manualPesoInput');
                        if (manualInputEl && manualInputEl.value) {
                            const pesoDoInput = parseFloat(manualInputEl.value);
                            if (!isNaN(pesoDoInput) && pesoDoInput > 0) {
                                console.log('📊 Peso capturado do input manual:', pesoDoInput);
                                pesoParaUsar = pesoDoInput;
                                if (typeof workState !== 'undefined') {
                                    workState.pesoAtual = pesoDoInput;
                                }
                                // Atualiza o display também
                                const pesoDisplayEl = document.getElementById('pesoValue');
                                if (pesoDisplayEl) {
                                    pesoDisplayEl.innerHTML = pesoDoInput.toFixed(1) + '<span class="peso-unit">kg</span>';
                                }
                            }
                        }
                    }
                    
                    // PRIORIDADE 2: Se ainda não tem peso, tenta ler do display
                    if (!pesoParaUsar || pesoParaUsar <= 0) {
                        const pesoDisplayEl = document.getElementById('pesoValue');
                        if (pesoDisplayEl) {
                            const pesoTexto = pesoDisplayEl.textContent || pesoDisplayEl.innerText || '';
                            const pesoLimpo = pesoTexto.replace(/kg/gi, '').replace(/\s/g, '').replace(',', '.').trim();
                            const pesoDoDisplay = parseFloat(pesoLimpo);
                            if (!isNaN(pesoDoDisplay) && pesoDoDisplay > 0) {
                                console.log('📊 Peso capturado do display:', pesoDoDisplay);
                                pesoParaUsar = pesoDoDisplay;
                                if (typeof workState !== 'undefined') {
                                    workState.pesoAtual = pesoDoDisplay;
                                }
                            }
                        }
                    }
                    
                    if (!pesoParaUsar || pesoParaUsar <= 0) {
                        alert('Informe o peso do animal.');
                        return;
                    }
                    
                    // Tenta chamar a função de salvamento se estiver disponível
                    if (typeof window !== 'undefined' && window.salvarPesagemBackend) {
                        console.log('✅ Função salvarPesagemBackend disponível, chamando...');
                        window.salvarPesagemBackend().then(sucesso => {
                            if (sucesso) {
                                console.log('✅ Pesagem salva com sucesso!');
                            } else {
                                console.error('❌ Erro ao salvar pesagem');
                            }
                        }).catch(err => {
                            console.error('❌ Erro ao salvar pesagem:', err);
                            alert('Erro ao salvar pesagem. Verifique o console para mais detalhes.');
                        });
                    } else {
                        console.error('❌ Função salvarPesagemBackend não está disponível!');
                        alert('Erro: Função de salvamento não está disponível. Recarregue a página.');
                    }
                }, true); // Use capture phase
                return true;
            }
            return false;
        }
        
        // Tenta anexar o listener imediatamente e depois com delays
        if (!anexarListenerGravarDireto()) {
            [500, 1000, 2000, 3000].forEach(delay => {
                setTimeout(() => {
                    if (!anexarListenerGravarDireto()) {
                        console.warn(`⚠️ Botão Gravar não encontrado após ${delay}ms`);
                    }
                }, delay);
            });
        }
        
        // Listener global para qualquer botão com texto "Gravar" (backup)
        document.addEventListener('click', function(e) {
            const target = e.target;
            const button = target.closest('button');
            
            if (button && (button.textContent.includes('Gravar') || button.textContent.includes('gravar'))) {
                console.log('🔘 Botão "Gravar" detectado globalmente:', {
                    id: button.id,
                    text: button.textContent.trim(),
                    pesoAtual: typeof workState !== 'undefined' ? workState.pesoAtual : 'N/A',
                    animalId: typeof workState !== 'undefined' ? workState.animalId : 'N/A'
                });
            }
        }, true);
        voiceBtn.addEventListener('click', function () {
            // alterna entre ligar e desligar a escuta por voz
            if (!recognition) inicializarReconhecimentoVoz();
            if (!recognition) return;

            if (voiceBtn.classList.contains('recording')) {
                // desliga
                voiceBtn.classList.remove('recording');
                aguardandoConfirmacao = false;
                voiceInstructions.style.display = 'none';
                recognition.stop();
            } else {
                // liga
                aguardandoConfirmacao = false;
                voiceInstructions.style.display = 'none';
                recognition.start();
            }
        });

        configCards.forEach(card => {
            card.addEventListener('click', function () {
                const task = this.getAttribute('data-task');
                if (workState.activeTasks.includes(task)) {
                    workState.activeTasks = workState.activeTasks.filter(t => t !== task);
                    this.classList.remove('active');
            } else {
                    workState.activeTasks.push(task);
                    this.classList.add('active');
                }
                saveWorkState();
            });
        });

        autoNextToggle.addEventListener('change', function () {
            workState.autoNext = this.checked;
            saveWorkState();
        });

        voicePromptsToggle.addEventListener('change', function () {
            workState.voicePrompts = this.checked;
            saveWorkState();
        });

        diagnosticoOptions.forEach(opt => {
            opt.addEventListener('click', function () {
                selecionarDiagnosticoPorValor(this.getAttribute('data-value'));
            });
        });

        diagnosticoCancelarBtn.addEventListener('click', function () {
            fecharPopupDiagnostico();
            if (workState.autoNext) {
                irParaProximoAnimal();
            }
        });

        diagnosticoConfirmarBtn.addEventListener('click', function () {
            if (!diagnosticoSelecionado) {
                alert('Selecione um diagnóstico antes de confirmar.');
                return;
            }
            // registra o animal desta sessão (apenas front-end, por enquanto)
            registrarAnimalNaSessao(diagnosticoSelecionado);
            fecharPopupDiagnostico();
            if (workState.autoNext) {
                irParaProximoAnimal();
            }
        });

        document.getElementById('nextAnimalBtn').addEventListener('click', function () {
            irParaProximoAnimal();
        });

        // leitura de brinco com câmera (apenas navegadores compatíveis)
        async function iniciarLeituraBrinco() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Seu navegador não suporta acesso à câmera nesta página.');
            return;
        }
            try {
                scanBrincoContainer.style.display = 'flex';
                scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                scanBrincoVideo.srcObject = scanStream;
                if (!barcodeDetector) {
                    alert('Leitura de código de barras não é suportada neste navegador.');
            return;
        }
                lerFrameBrinco();
            } catch (e) {
                console.error('Erro ao iniciar câmera:', e);
                alert('Não foi possível acessar a câmera. Verifique permissões no navegador.');
                scanBrincoContainer.style.display = 'none';
            }
        }

        function pararLeituraBrinco() {
            if (scanStream) {
                scanStream.getTracks().forEach(t => t.stop());
                scanStream = null;
            }
            scanBrincoContainer.style.display = 'none';
        }

        async function lerFrameBrinco() {
            if (!barcodeDetector || !scanStream) return;
            try {
                const detections = await barcodeDetector.detect(scanBrincoVideo);
                if (detections && detections.length > 0) {
                    const valor = (detections[0].rawValue || '').trim();
                    if (valor) {
                        brincoInput.value = valor;
                        atualizarEstadoBrinco();
                        pararLeituraBrinco();
                        return;
                    }
                }
            } catch (e) {
                console.warn('Erro na leitura do código de barras:', e);
            }
            if (scanStream) requestAnimationFrame(lerFrameBrinco);
        }

        scanBrincoBtn.addEventListener('click', iniciarLeituraBrinco);
        scanBrincoFecharBtn.addEventListener('click', pararLeituraBrinco);

        // leitura de brinco por voz
        brincoVoiceBtn.addEventListener('click', function () {
            if (!recognition) inicializarReconhecimentoVoz();
            if (!recognition) return;

            if (ouvindoBrinco) {
                ouvindoBrinco = false;
                recognition.stop();
            } else {
                ouvindoBrinco = true;
                recognition.start();
            }
        });

        // Função para mostrar notificação de sucesso
        function mostrarNotificacaoSucesso(mensagem) {
            // Remove notificação anterior se existir
            const notifAnterior = document.getElementById('notificacaoSucesso');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            // Cria nova notificação
            const notificacao = document.createElement('div');
            notificacao.id = 'notificacaoSucesso';
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50, #2e7d32);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            notificacao.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 1.2em;"></i>
                <span>${mensagem}</span>
            `;
            
            // Adiciona animação CSS se não existir
            if (!document.getElementById('notificacaoStyle')) {
                const style = document.createElement('style');
                style.id = 'notificacaoStyle';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notificacao);
            
            // Remove após 3 segundos
            setTimeout(() => {
                notificacao.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Função para salvar pesagem no backend (torna global também)
        window.salvarPesagemBackend = async function salvarPesagemBackend() {
            console.log('💾 Função salvarPesagemBackend chamada');
            
            // IMPORTANTE: Captura o peso de múltiplas fontes (prioridade: input manual > workState > display)
            let pesoParaSalvar = workState.pesoAtual;
            
            // PRIORIDADE 1: Tenta ler do input manual (se o usuário digitou mas não confirmou)
            if (!pesoParaSalvar || pesoParaSalvar <= 0) {
                const manualInputEl = document.getElementById('manualPesoInput');
                if (manualInputEl && manualInputEl.value) {
                    const pesoDoInput = parseFloat(manualInputEl.value);
                    if (!isNaN(pesoDoInput) && pesoDoInput > 0) {
                        console.log('📊 Peso capturado do input manual:', pesoDoInput);
                        pesoParaSalvar = pesoDoInput;
                        workState.pesoAtual = pesoDoInput; // Atualiza workState também
                        // Atualiza o display também
                        const pesoDisplayEl = document.getElementById('pesoValue');
                        if (pesoDisplayEl) {
                            pesoDisplayEl.innerHTML = pesoDoInput.toFixed(1) + '<span class="peso-unit">kg</span>';
                        }
                    }
                }
            }
            
            // PRIORIDADE 2: Se ainda não tem peso, tenta ler do display visual
            if (!pesoParaSalvar || pesoParaSalvar <= 0) {
                const pesoDisplayEl = document.getElementById('pesoValue');
                if (pesoDisplayEl) {
                    const pesoTexto = pesoDisplayEl.textContent || pesoDisplayEl.innerText || '';
                    // Remove "kg" e espaços, converte vírgula para ponto
                    const pesoLimpo = pesoTexto.replace(/kg/gi, '').replace(/\s/g, '').replace(',', '.').trim();
                    const pesoDoDisplay = parseFloat(pesoLimpo);
                    if (!isNaN(pesoDoDisplay) && pesoDoDisplay > 0) {
                        console.log('📊 Peso capturado do display:', pesoDoDisplay);
                        pesoParaSalvar = pesoDoDisplay;
                        workState.pesoAtual = pesoDoDisplay; // Atualiza workState também
                    }
                }
            }
            
            console.log('📊 Estado atual:', {
                brinco: brincoInput.value,
                pesoAtual: workState.pesoAtual,
                pesoParaSalvar: pesoParaSalvar,
                animalId: workState.animalId,
                animalAtual: workState.animalAtual
            });
            
            // Valida se há animal e peso
            if (!brincoInput.value) {
                alert('Identifique um animal primeiro.');
                return false;
            }
            
            if (!pesoParaSalvar || pesoParaSalvar <= 0) {
                alert('Informe o peso do animal.');
                return false;
            }
            
            // Obtém propriedade_id da URL
            const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
            const propriedadeId = urlMatch ? urlMatch[1] : null;
            
            if (!propriedadeId) {
                alert('Erro: Não foi possível identificar a propriedade.');
                return false;
            }
            
            // Obtém animal_id do workState ou busca pelo brinco
            let animalId = workState.animalAtual?.id || workState.animalId;
            
            // Se não tem animal_id, tenta buscar pelo brinco
            if (!animalId && brincoInput.value) {
                try {
                    const response = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'animal' && data.dados) {
                            animalId = data.dados.id;
                            // Atualiza workState com os dados do animal
                            workState.animalId = animalId;
                            workState.animalAtual = data.dados;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar animal:', error);
                }
            }
            
            if (!animalId) {
                alert('Erro: Animal não encontrado. Verifique o brinco.');
                return false;
            }
            
            // Prepara dados da pesagem (usa pesoParaSalvar que foi capturado)
            const pesagem = {
                animal_id: animalId,
                brinco: brincoInput.value,
                peso: pesoParaSalvar // Usa o peso capturado (do workState ou do display)
            };
            
            // Salva no backend
            try {
                const response = await fetch(`/propriedade/${propriedadeId}/curral/api/pesagem/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(pesagem)
                });
                
                const responseData = await response.json();
                
                if (response.ok) {
                    // Salva registro na sessão local também
                    registrarAnimalNaSessao(diagnosticoSelecionado || 'NAO_AVALIADA');
                    
                    const novoPeso = parseFloat(responseData.novo_peso || responseData.peso || pesoParaSalvar);
                    const dataAtual = new Date();
                    const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' ' + dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    // Atualiza o campo "PESO REGISTRADO" (peso que acabou de ser inserido)
                    if (pesoRegistrado) {
                        pesoRegistrado.textContent = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
                        pesoRegistrado.style.color = '#4caf50'; // Verde para destacar
                    }
                    
                    // Atualiza o último peso exibido no card do animal
                    if (animalUltimoPeso) {
                        animalUltimoPeso.textContent = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
                        // Atualiza workState também
                        workState.pesoAtual = novoPeso;
                    }
                    
                    // Atualiza os campos de histórico
                    if (historicoUltimoPeso) {
                        historicoUltimoPeso.textContent = `${novoPeso.toFixed(1).replace('.', ',')} kg`;
                    }
                    if (historicoDataUltima) {
                        historicoDataUltima.textContent = dataFormatada;
                    }
                    if (historicoDiasUltima) {
                        historicoDiasUltima.textContent = '0 dias';
                    }
                    
                    // Atualiza os campos de histórico recarregando os dados do animal
                    if (brincoInput.value) {
                        try {
                            const urlMatch = window.location.pathname.match(/propriedade\/(\d+)/);
                            const propriedadeId = urlMatch ? urlMatch[1] : null;
                            if (propriedadeId) {
                                // Aguarda um pouco para garantir que o backend processou
                                setTimeout(async () => {
                                    const responseAnimal = await fetch(`/propriedade/${propriedadeId}/curral/api/identificar/?codigo=${encodeURIComponent(brincoInput.value)}`);
                                    if (responseAnimal.ok) {
                                        const dataAnimal = await responseAnimal.json();
                                        if (dataAnimal.status === 'animal' && dataAnimal.dados) {
                                            // Atualiza todos os campos de histórico
                                            await atualizarEstadoBrinco();
                                            
                                            // Recalcula ganhos e aparte com o novo peso
                                            if (typeof calcularAparteEGanhos === 'function') {
                                                calcularAparteEGanhos(novoPeso);
                                            }
                                            
                                            console.log('✅ Campos de histórico atualizados!');
                                        }
                                    }
                                }, 500); // Aguarda 500ms para o backend processar
                            }
                        } catch (error) {
                            console.warn('Erro ao atualizar histórico:', error);
                        }
                    }
                    
                    // Se auto-próximo estiver ativo, vai para o próximo animal
                    const autoProximo = document.getElementById('autoNextToggle');
                    if (autoProximo && autoProximo.checked) {
                        irParaProximoAnimal();
                    }
                    
                    // Feedback visual MELHORADO - mostra confirmação clara
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) {
                        const originalText = saveBtn.innerHTML;
                        const originalBg = saveBtn.style.background;
                        const originalColor = saveBtn.style.color;
                        
                        // Muda para verde com check
                        saveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Gravado com sucesso!';
                        saveBtn.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
                        saveBtn.style.color = '#fff';
                        saveBtn.style.transform = 'scale(1.05)';
                        saveBtn.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.8)';
                        
                        // Mostra notificação visual também
                        mostrarNotificacaoSucesso('Pesagem gravada com sucesso!');
                        
                        setTimeout(() => {
                            saveBtn.innerHTML = originalText;
                            saveBtn.style.background = originalBg;
                            saveBtn.style.color = originalColor;
                            saveBtn.style.transform = '';
                            saveBtn.style.boxShadow = '';
                        }, 3000);
                    }
                    
                    console.log('✅ Pesagem salva com sucesso!', {
                        novoPeso: novoPeso,
                        animalId: responseData.animal_id,
                        eventoId: responseData.evento_id
                    });
                    return true;
                } else {
                    const mensagemErro = responseData.mensagem || responseData.status || 'Erro desconhecido';
                    console.error('❌ Erro ao salvar pesagem:', responseData);
                    alert(`Erro ao salvar pesagem: ${mensagemErro}`);
                    return false;
                }
            } catch (error) {
                console.error('❌ Erro ao salvar pesagem:', error);
                alert('Erro ao conectar com o servidor. Verifique sua conexão.');
                return false;
            }
        }
        
        // Listener para o botão saveBtn - com verificação de existência e múltiplas tentativas
        function anexarListenerSaveBtn() {
            const saveBtnElement = document.getElementById('saveBtn');
            if (saveBtnElement) {
                console.log('✅ Botão saveBtn encontrado, adicionando listener...');
                // Remove listeners anteriores para evitar duplicação
                const novoBtn = saveBtnElement.cloneNode(true);
                saveBtnElement.parentNode.replaceChild(novoBtn, saveBtnElement);
                
                document.getElementById('saveBtn').addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔘 Botão saveBtn clicado');
                    if (window.salvarPesagemBackend) {
                        await window.salvarPesagemBackend();
                    } else {
                        console.error('❌ Função salvarPesagemBackend não está disponível!');
                        alert('Erro: Função de salvamento não está disponível. Recarregue a página.');
                    }
                });
                return true;
            }
            return false;
        }
        
        // Tenta anexar o listener imediatamente
        if (!anexarListenerSaveBtn()) {
            console.warn('⚠️ Botão saveBtn não encontrado! Tentando novamente...');
            // Tenta novamente após 500ms, 1s, 2s
            [500, 1000, 2000].forEach(delay => {
                setTimeout(() => {
                    if (!anexarListenerSaveBtn()) {
                        console.warn(`⚠️ Botão saveBtn ainda não encontrado após ${delay}ms`);
                    }
                }, delay);
            });
        }
        
        // Listener genérico para qualquer botão com texto "Gravar" ou id contendo "gravar"
        // Usa capture phase para pegar antes de outros listeners
        // Este listener funciona mesmo se o botão for criado dinamicamente
        console.log('📌 Adicionando listener genérico para botões "Gravar"');
        document.addEventListener('click', async function(event) {
            const target = event.target;
            let button = null;
            
            // Verifica se o target é um botão
            if (target.tagName === 'BUTTON') {
                button = target;
            } else if (target.closest('button')) {
                button = target.closest('button');
            } else if (target.tagName === 'I' && target.closest('button')) {
                // Se clicou no ícone dentro do botão
                button = target.closest('button');
            }
            
            if (button) {
                const buttonText = button.textContent.trim() || button.innerText.trim() || '';
                const buttonId = button.id || '';
                const buttonClass = button.className || '';
                
                const isGravarButton = (
                    buttonText.includes('Gravar') || 
                    buttonText.includes('gravar') ||
                    buttonId.includes('gravar') ||
                    buttonId.includes('Gravar') ||
                    buttonClass.includes('btn-gravar') ||
                    buttonClass.includes('gravar')
                );
                
                if (isGravarButton) {
                    console.log('🔘 Botão Gravar detectado:', {
                        id: buttonId,
                        text: buttonText,
                        class: buttonClass,
                        brinco: brincoInput.value,
                        peso: workState.pesoAtual
                    });
                    
                    // Valida antes de processar
                    if (!brincoInput.value) {
                        console.warn('⚠️ Brinco não informado');
                        alert('Identifique um animal primeiro.');
                        event.preventDefault();
                        event.stopPropagation();
                        return;
                    }
                    
                    if (!workState.pesoAtual || workState.pesoAtual <= 0) {
                        console.warn('⚠️ Peso não informado');
                        alert('Informe o peso do animal.');
                        event.preventDefault();
                        event.stopPropagation();
                        return;
                    }
                    
                    console.log('✅ Condições atendidas, salvando pesagem...');
                    event.preventDefault();
                    event.stopPropagation();
                    if (window.salvarPesagemBackend) {
                        await window.salvarPesagemBackend();
                    } else {
                        console.error('❌ Função salvarPesagemBackend não está disponível!');
                        alert('Erro: Função de salvamento não está disponível. Recarregue a página.');
                    }
                }
            }
        }, true); // true = capture phase (executa antes de outros listeners)
        
        // Função auxiliar para obter CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Inicializa sistema enhanced após carregamento
        if (window.curralEnhanced) {
            // Habilita reconhecimento de voz contínuo se configurado
            if (workState.voicePrompts) {
                window.curralEnhanced.startVoiceRecognition();
            }
        }
        
        // Verificação final de inicialização
        console.log('✅ Curral dashboard inicializado completamente');
        console.log('📊 Estado inicial:', {
            pesoAtual: workState.pesoAtual,
            animalId: workState.animalId,
            animalAtual: workState.animalAtual,
            saveBtnExiste: !!document.getElementById('saveBtn')
        });
    });
</script>
{% endblock %}

 
