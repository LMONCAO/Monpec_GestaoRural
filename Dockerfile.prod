# Dockerfile para produ√ß√£o - Google Cloud Run
# Otimizado para Django 4.2.7

FROM python:3.11-slim

# Vari√°veis de ambiente
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PORT=8080

# Instalar depend√™ncias do sistema
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-client \
    build-essential \
    libpq-dev \
    libjpeg-dev \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# Criar diret√≥rio de trabalho
WORKDIR /app

# Copiar requirements primeiro (para cache de layers)
COPY requirements_producao.txt requirements.txt ./

# Instalar depend√™ncias Python
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements_producao.txt && \
    pip list | head -20

# Copiar c√≥digo da aplica√ß√£o
COPY . .

# Criar diret√≥rios necess√°rios
RUN mkdir -p /app/staticfiles /app/media /app/logs && \
    chmod -R 755 /app/staticfiles /app/media /app/logs

# Executar collectstatic durante o build (sem precisar de DB)
# IMPORTANTE: Coletar TODOS os arquivos est√°ticos incluindo imagens, v√≠deos, etc.
# Usar --link para criar links simb√≥licos (mais r√°pido) ou copiar arquivos
RUN echo "üîç Verificando arquivos est√°ticos antes do collectstatic..." && \
    ls -la /app/static/site/ 2>/dev/null || echo "‚ö†Ô∏è Pasta static/site/ n√£o encontrada ainda" && \
    DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp \
    STATIC_ROOT=/app/staticfiles \
    python manage.py collectstatic --noinput --clear --verbosity 2 --link || \
    (echo "‚ö†Ô∏è AVISO: collectstatic com --link falhou, tentando sem --link..." && \
     DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp \
     STATIC_ROOT=/app/staticfiles \
     python manage.py collectstatic --noinput --clear --verbosity 2 || \
     (echo "‚ùå ERRO: collectstatic falhou completamente!" && \
      echo "Criando diret√≥rio manualmente..." && \
      mkdir -p /app/staticfiles && chmod -R 755 /app/staticfiles))

# Verificar se arquivos est√°ticos foram coletados (imagens, CSS, JS)
RUN if [ -d "/app/staticfiles" ]; then \
        echo "‚úÖ Arquivos est√°ticos coletados:" && \
        ls -la /app/staticfiles/ | head -20 && \
        echo "Verificando imagens em staticfiles/site/:" && \
        ls -la /app/staticfiles/site/ 2>/dev/null || echo "‚ö†Ô∏è Pasta staticfiles/site/ n√£o encontrada" && \
        find /app/staticfiles -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.gif" \) | head -20 && \
        echo "Verificando especificamente foto1.jpeg at√© foto6.jpeg:" && \
        for i in 1 2 3 4 5 6; do \
            if [ -f "/app/staticfiles/site/foto${i}.jpeg" ]; then \
                echo "‚úÖ foto${i}.jpeg encontrado"; \
            else \
                echo "‚ùå foto${i}.jpeg N√ÉO encontrado!"; \
            fi; \
        done && \
        echo "Total de arquivos est√°ticos: $(find /app/staticfiles -type f | wc -l)"; \
    fi

# Verificar instala√ß√£o cr√≠tica
RUN python -c "import django; import openpyxl; import psycopg2; print('‚úÖ Depend√™ncias cr√≠ticas instaladas')" || \
    (echo "‚ùå ERRO: Depend√™ncias cr√≠ticas n√£o instaladas!" && exit 1)

# Expor porta
EXPOSE 8080

# Configurar settings para produ√ß√£o
ENV DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp

# Comando de inicializa√ß√£o
# Executa migra√ß√µes e inicia servidor
# IMPORTANTE: Porta deve usar ${PORT} (sem aspas) para Cloud Run
CMD gunicorn --bind 0.0.0.0:${PORT:-8080} \
    --workers 2 \
    --threads 4 \
    --timeout 300 \
    --access-logfile - \
    --error-logfile - \
    --log-level info \
    sistema_rural.wsgi:application
