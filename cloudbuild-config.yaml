# Cloud Build Configuration para MONPEC
# Projeto: monpec-sistema-rural
# Serviço: monpec (Cloud Run)

steps:
  # Build da imagem Docker
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${_PROJECT_ID}/monpec:${_COMMIT_SHA}'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/monpec:latest'
      - '-f'
      - 'Dockerfile.prod'
      - '.'
    timeout: '600s'

  # Push da imagem para Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/${_PROJECT_ID}/monpec:${_COMMIT_SHA}'
    timeout: '300s'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/${PROJECT_ID}/monpec:latest'
    timeout: '300s'

# Opções de build
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  substitution_option: 'ALLOW_LOOSE'

# Timeout total do build (10 minutos)
timeout: '600s'

# Imagens a serem criadas
images:
      - 'gcr.io/${_PROJECT_ID}/monpec:${_COMMIT_SHA}'
      - 'gcr.io/${_PROJECT_ID}/monpec:latest'

# Nota: O deploy no Cloud Run deve ser feito separadamente usando:
# gcloud run deploy monpec --image gcr.io/${PROJECT_ID}/monpec:latest --region us-central1
# 
# Isso permite configurar variáveis de ambiente e recursos corretamente
# através dos scripts INSTALAR_DO_ZERO.sh ou INSTALAR_DO_ZERO.ps1
