{% extends 'gestao_rural/base.html' %}

{% block title %}Proprietários - Monpec Projetista{% endblock %}

{% block extra_css %}
<style>
    .search-form { margin-bottom: 2rem; }
    .form-group { display: flex; gap: 1rem; align-items: end; }
    .form-control { padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
    .form-control:focus { outline: none; border-color: #004a99; }
    .proprietarios-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .proprietario-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1.5rem; transition: transform 0.3s; }
    .proprietario-card:hover { transform: translateY(-5px); }
    .proprietario-header { border-bottom: 1px solid #e9ecef; padding-bottom: 1rem; margin-bottom: 1rem; }
    .proprietario-name { font-size: 1.25rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
    .proprietario-cpf { color: #666; font-size: 0.9rem; }
    .proprietario-info { margin-bottom: 1rem; }
    .info-item { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .info-label { color: #666; font-weight: 500; }
    .info-value { color: #333; }
    .empty-state { text-align: center; padding: 3rem; color: #666; }
    .empty-state h3 { font-size: 1.5rem; margin-bottom: 1rem; color: #999; }
    
    /* POPUP STYLES */
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
    .popup-overlay.active { display: flex; align-items: center; justify-content: center; }
    .popup { background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .popup-title { font-size: 1.5rem; font-weight: 700; color: #333; }
    .popup-close { background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; }
    .popup-close:hover { color: #333; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
    .form-control { width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
    .form-control:focus { outline: none; border-color: #004a99; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .btn-group { display: flex; gap: 1rem; margin-top: 2rem; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 500; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .loading { display: none; text-align: center; padding: 1rem; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #004a99; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .proprietarios-grid { grid-template-columns: 1fr; } .form-group { flex-direction: column; } .form-row { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Proprietários</h1>
    <p>Gerencie todos os proprietários rurais cadastrados</p>
</div>

<div class="card">
    <h2 style="margin-bottom: 1rem;">Ações</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="abrirPopup()" class="btn btn-primary">Novo Proprietário</button>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Voltar ao Dashboard</a>
    </div>
</div>

<div class="card search-form">
    <h3 style="margin-bottom: 1rem;">Buscar Proprietários</h3>
    <form method="get">
        <div class="form-group">
            <input type="text" name="search" placeholder="Nome, CPF ou cidade..." class="form-control" value="{{ search }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </div>
    </form>
</div>

<div id="proprietarios-container">
    {% if proprietarios %}
        <div class="proprietarios-grid">
            {% for proprietario in proprietarios %}
            <div class="proprietario-card">
                <div class="proprietario-header">
                    <div class="proprietario-name">{{ proprietario.nome }}</div>
                    <div class="proprietario-cpf">CPF: {{ proprietario.cpf }}</div>
                </div>
                
                <div class="proprietario-info">
                    {% if proprietario.telefone %}
                    <div class="info-item">
                        <span class="info-label">Telefone:</span>
                        <span class="info-value">{{ proprietario.telefone }}</span>
                    </div>
                    {% endif %}
                    
                    {% if proprietario.email %}
                    <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value">{{ proprietario.email }}</span>
                    </div>
                    {% endif %}
                    
                    {% if proprietario.cidade %}
                    <div class="info-item">
                        <span class="info-label">Cidade:</span>
                        <span class="info-value">{{ proprietario.cidade }}, {{ proprietario.estado }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="info-item">
                        <span class="info-label">Propriedades:</span>
                        <span class="info-value">{{ proprietario.propriedades.count }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>Nenhum proprietário encontrado</h3>
            <p>Comece cadastrando seu primeiro proprietário</p>
            <button onclick="abrirPopup()" class="btn btn-primary" style="margin-top: 1rem;">Cadastrar Primeiro Proprietário</button>
        </div>
    {% endif %}
</div>

<!-- POPUP DE CADASTRO -->
<div id="popup-overlay" class="popup-overlay">
    <div class="popup">
        <div class="popup-header">
            <h2 class="popup-title">Novo Proprietário</h2>
            <button class="popup-close" onclick="fecharPopup()">&times;</button>
        </div>
        
        <div id="alert-container"></div>
        
        <form id="form-proprietario">
            <div class="form-row">
                <div class="form-group">
                    <label for="nome">Nome Completo *</label>
                    <input type="text" id="nome" name="nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="cpf">CPF *</label>
                    <input type="text" id="cpf" name="cpf" class="form-control" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="text" id="telefone" name="telefone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label for="endereco">Endereço</label>
                <input type="text" id="endereco" name="endereco" class="form-control">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cidade">Cidade</label>
                    <input type="text" id="cidade" name="cidade" class="form-control">
                </div>
                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado" name="estado" class="form-control">
                        <option value="">Selecione</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="GO">Goiás</option>
                        <option value="SP">São Paulo</option>
                        <option value="PR">Paraná</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="BA">Bahia</option>
                        <option value="DF">Distrito Federal</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="observacoes">Observações</label>
                <textarea id="observacoes" name="observacoes" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="btn-group">
                <button type="submit" class="btn btn-success">Salvar Proprietário</button>
                <button type="button" class="btn btn-secondary" onclick="fecharPopup()">Cancelar</button>
            </div>
        </form>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Salvando proprietário...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function abrirPopup() {
        document.getElementById('popup-overlay').classList.add('active');
        document.getElementById('form-proprietario').reset();
        document.getElementById('alert-container').innerHTML = '';
    }
    
    function fecharPopup() {
        document.getElementById('popup-overlay').classList.remove('active');
    }
    
    document.getElementById('form-proprietario').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Mostrar loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('form-proprietario').style.display = 'none';
        
        fetch('{% url "proprietario_novo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('form-proprietario').style.display = 'block';
            
            if (data.success) {
                // Mostrar sucesso
                document.getElementById('alert-container').innerHTML = 
                    '<div class="alert alert-success">' + data.message + '</div>';
                
                // Fechar popup após 2 segundos
                setTimeout(() => {
                    fecharPopup();
                    location.reload(); // Recarregar página para mostrar novo proprietário
                }, 2000);
            } else {
                // Mostrar erro
                document.getElementById('alert-container').innerHTML = 
                    '<div class="alert alert-error">' + data.message + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('form-proprietario').style.display = 'block';
            document.getElementById('alert-container').innerHTML = 
                '<div class="alert alert-error">Erro ao salvar proprietário. Tente novamente.</div>';
        });
    });
    
    // Fechar popup ao clicar fora
    document.getElementById('popup-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            fecharPopup();
        }
    });
</script>
{% endblock %}
