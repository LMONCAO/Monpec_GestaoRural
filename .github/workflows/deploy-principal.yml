name: ðŸš€ Deploy Principal - Google Cloud Run

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_ID: monpec-sistema-rural
  SERVICE_NAME: monpec
  REGION: us-central1
  DB_INSTANCE: monpec-db

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Timeout de 60 minutos para o job completo
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ” Autenticar no Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Configurar Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ðŸ”¨ Build da imagem Docker
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          IMAGE_NAME="gcr.io/${PROJECT_ID}/monpec"
          IMAGE_TAG="${IMAGE_NAME}:${GITHUB_SHA}"
          IMAGE_LATEST="${IMAGE_NAME}:latest"
          
          echo "ðŸ”¨ Building image: $IMAGE_TAG"
          
          # Executar build de forma assÃ­ncrona para evitar problemas com stream de logs
          echo "Iniciando build assÃ­ncrono..."
          BUILD_OUTPUT=$(gcloud builds submit \
            --tag $IMAGE_TAG \
            --tag $IMAGE_LATEST \
            --timeout=1800s \
            --machine-type=E2_HIGHCPU_8 \
            --async \
            . 2>&1)
          
          # Extrair BUILD_ID do output
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oP 'builds/\K[^/\s]+' | head -1)
          
          if [ -z "$BUILD_ID" ]; then
            echo "âŒ NÃ£o foi possÃ­vel obter o ID do build"
            echo "Output: $BUILD_OUTPUT"
            exit 1
          fi
          
          echo "Build iniciado com ID: $BUILD_ID"
          echo "Aguardando conclusÃ£o do build..."
          echo "VocÃª pode acompanhar em: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
          
          # Aguardar build completar (atÃ© 35 minutos, jÃ¡ que o build tem timeout de 1800s = 30min)
          MAX_WAIT=2100
          ELAPSED=0
          LAST_STATUS=""
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            
            # Log apenas quando status mudar
            if [ "$STATUS" != "$LAST_STATUS" ]; then
              echo "Status do build: $STATUS (${ELAPSED}s)"
              LAST_STATUS=$STATUS
            fi
            
            case "$STATUS" in
              "SUCCESS")
                echo "âœ… Build concluÃ­do com sucesso!"
                break
                ;;
              "FAILURE"|"CANCELLED"|"EXPIRED"|"TIMEOUT")
                echo "âŒ Build falhou com status: $STATUS"
                echo "ðŸ” Obtendo informaÃ§Ãµes do build..."
                gcloud builds describe $BUILD_ID --format="yaml" 2>/dev/null | head -50 || true
                echo ""
                echo "Verifique os logs completos em: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
                exit 1
                ;;
              "WORKING"|"QUEUED")
                # Build ainda em progresso
                if [ $((ELAPSED % 60)) -eq 0 ]; then
                  echo "â³ Build ainda em progresso... (${ELAPSED}s)"
                fi
                ;;
              "UNKNOWN")
                echo "âš ï¸ Status desconhecido, tentando novamente..."
                ;;
            esac
            
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          # Verificar status final
          FINAL_STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "UNKNOWN")
          if [ "$FINAL_STATUS" != "SUCCESS" ]; then
            echo "âŒ Timeout ou falha aguardando build completar"
            echo "Status final: $FINAL_STATUS"
            echo "Tempo decorrido: ${ELAPSED}s"
            echo "Verifique os logs em: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
            exit 1
          fi
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV

      - name: ðŸ” Verificar Secrets
        run: |
          echo "Verificando secrets necessarios..."
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ ERRO: GCP_SA_KEY nao configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.SECRET_KEY }}" ]; then
            echo "âŒ ERRO: SECRET_KEY nao configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.DB_NAME }}" ]; then
            echo "âŒ ERRO: DB_NAME nao configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.DB_USER }}" ]; then
            echo "âŒ ERRO: DB_USER nao configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "âŒ ERRO: DB_PASSWORD nao configurado!"
            exit 1
          fi
          if [ -z "${{ secrets.DJANGO_SUPERUSER_PASSWORD }}" ]; then
            echo "âŒ ERRO: DJANGO_SUPERUSER_PASSWORD nao configurado!"
            exit 1
          fi
          echo "âœ… Todos os secrets estao configurados"

      - name: ðŸš€ Deploy no Cloud Run
        run: |
          echo "ðŸš€ Iniciando deploy no Cloud Run..."
          CLOUD_SQL_CONN="${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.DB_INSTANCE }}"
          echo "Cloud SQL Connection: $CLOUD_SQL_CONN"
          echo "Imagem: ${{ env.IMAGE_TAG }}"
          
          # Verificar se a imagem existe antes de fazer deploy
          echo "Verificando se a imagem existe..."
          if ! gcloud container images describe ${{ env.IMAGE_TAG }} &>/dev/null; then
            echo "âŒ ERRO: Imagem ${{ env.IMAGE_TAG }} nÃ£o encontrada!"
            echo "O build pode ter falhado. Verifique os builds anteriores."
            exit 1
          fi
          echo "âœ… Imagem encontrada"
          
          echo "Fazendo deploy..."
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=$CLOUD_SQL_CONN \
            --set-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False,SECRET_KEY=${{ secrets.SECRET_KEY }},CLOUD_SQL_CONNECTION_NAME=$CLOUD_SQL_CONN,DB_NAME=${{ secrets.DB_NAME }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }},GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},DEMO_USER_PASSWORD=monpec" \
            --memory=2Gi \
            --cpu=2 \
            --timeout=600 \
            --max-instances=10 \
            --min-instances=0 \
            --quiet
          
          if [ $? -eq 0 ]; then
            echo "âœ… Deploy concluido com sucesso!"
          else
            echo "âŒ ERRO: Falha no deploy!"
            echo "Verifique os logs acima para mais detalhes"
            exit 1
          fi

      - name: ðŸ“‹ Obter URL do serviÃ§o
        id: get-url
        run: |
          echo "ðŸ“‹ Obtendo URL do servico..."
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(status.url)" 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            echo "URL=https://monpec-xxxxx-uc.a.run.app" >> $GITHUB_OUTPUT
            echo "âš ï¸ Nao foi possivel obter URL automaticamente"
            echo "Verifique manualmente: gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }}"
          else
            echo "URL=$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "âœ… Deploy concluido! URL: $SERVICE_URL"
          fi

      - name: ðŸ” Verificar Status do Servico
        if: always()
        run: |
          echo "ðŸ” Verificando status do servico..."
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="table(status.conditions[0].type,status.conditions[0].status,status.url)" || true
          
          echo ""
          echo "ðŸ“‹ Verificando logs recentes (ultimas 10 linhas)..."
          gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --limit=10 \
            --format="table(timestamp,severity,textPayload)" \
            --project=${{ env.PROJECT_ID }} || true
          
          echo ""
          echo "ðŸ”´ Verificando erros..."
          ERRORS=$(gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }} AND severity>=ERROR" \
            --limit=5 \
            --format="value(textPayload)" \
            --project=${{ env.PROJECT_ID }} || echo "")
          
          if [ -z "$ERRORS" ]; then
            echo "âœ… Nenhum erro encontrado nos logs recentes!"
          else
            echo "âš ï¸ Erros encontrados:"
            echo "$ERRORS"
          fi

      - name: ðŸ“ Resumo do deploy
        run: |
          echo "## ðŸš€ Deploy ConcluÃ­do!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ServiÃ§o:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**RegiÃ£o:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.get-url.outputs.URL }}" >> $GITHUB_STEP_SUMMARY


