name: ğŸš€ Deploy AutomÃ¡tico para Google Cloud Run

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  PROJECT_ID: monpec-sistema-rural
  SERVICE_NAME: monpec
  REGION: us-central1
  DB_INSTANCE: monpec-db

jobs:
  deploy:
    name: ğŸš€ Build e Deploy para Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” AutenticaÃ§Ã£o no Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: ğŸ³ Configurar Docker para GCR
        run: |
          gcloud auth configure-docker --quiet

      - name: ğŸ“¦ Configurar projeto GCP
        run: |
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud config set run/region ${{ env.REGION }}

      - name: ğŸ³ Build da imagem Docker usando Cloud Build
        id: build
        run: |
          echo "ğŸ”¨ Iniciando build da imagem Docker..."
          echo "ğŸ“„ Usando cloudbuild-config.yaml existente..."
          echo "ğŸ“¦ Projeto: ${{ env.PROJECT_ID }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"
          
          # Verificar se os arquivos necessÃ¡rios existem
          if [ ! -f Dockerfile.prod ]; then
            echo "âŒ ERRO: Dockerfile.prod nÃ£o encontrado!"
            exit 1
          fi
          
          if [ ! -f cloudbuild-config.yaml ]; then
            echo "âŒ ERRO: cloudbuild-config.yaml nÃ£o encontrado!"
            exit 1
          fi
          
          # Usar o arquivo cloudbuild-config.yaml com substituiÃ§Ãµes do gcloud
          # IMPORTANTE: SubstituiÃ§Ãµes devem comeÃ§ar com _ (underscore)
          echo "ğŸš€ Iniciando Cloud Build com substituiÃ§Ãµes..."
          gcloud builds submit \
            --config=cloudbuild-config.yaml \
            --substitutions=_PROJECT_ID=${{ env.PROJECT_ID }},_COMMIT_SHA=${{ github.sha }} \
            --timeout=1200s
          
          echo "âœ… Build concluÃ­do!"
          echo "ğŸ“¦ Imagem: gcr.io/${{ env.PROJECT_ID }}/monpec:${{ github.sha }}"
          echo "ğŸ“¦ Imagem latest: gcr.io/${{ env.PROJECT_ID }}/monpec:latest"

      - name: ğŸš€ Deploy para Cloud Run
        id: deploy
        run: |
          echo "ğŸš€ Iniciando deploy no Cloud Run..."

          # Deploy com Cloud SQL + variÃ¡veis de ambiente (via GitHub Secrets)
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image gcr.io/${{ env.PROJECT_ID }}/monpec:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.DB_INSTANCE }} \
            --set-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False,SECRET_KEY=${{ secrets.SECRET_KEY }},CLOUD_SQL_CONNECTION_NAME=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.DB_INSTANCE }},DB_NAME=${{ secrets.DB_NAME }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }},GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" \
            --memory=1Gi \
            --cpu=2 \
            --timeout=300 \
            --max-instances=10 \
            --min-instances=1 \
            --quiet
          
          # Obter URL do serviÃ§o
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format="value(status.url)")
          
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸŒ URL: $SERVICE_URL"
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Aplicar migraÃ§Ãµes (opcional)
        if: success()
        continue-on-error: true
        run: |
          echo "ğŸ”„ Aplicando migraÃ§Ãµes do banco de dados..."
          
          # Criar job de migraÃ§Ã£o (ou atualizar se jÃ¡ existir)
          gcloud run jobs create migrate-db \
            --image gcr.io/${{ env.PROJECT_ID }}/monpec:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --update-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,SECRET_KEY=${{ secrets.SECRET_KEY }},CLOUD_SQL_CONNECTION_NAME=${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.DB_INSTANCE }},DB_NAME=${{ secrets.DB_NAME }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" \
            --command "python" \
            --args "manage.py,migrate,--noinput" \
            --max-retries=3 \
            --memory=512Mi \
            --cpu=1 \
            --task-timeout=600s \
            --quiet 2>&1 | grep -v "already exists" || true
          
          # Executar migraÃ§Ãµes
          echo "â³ Executando migraÃ§Ãµes..."
          gcloud run jobs execute migrate-db \
            --region ${{ env.REGION }} \
            --wait || echo "âš ï¸ Aviso: MigraÃ§Ãµes podem ter falhado ou jÃ¡ estarem atualizadas"

      - name: ğŸ“Š Coletar arquivos estÃ¡ticos (opcional)
        if: success()
        continue-on-error: true
        run: |
          echo "ğŸ“Š Coletando arquivos estÃ¡ticos..."
          
          # Criar job de collectstatic (ou atualizar se jÃ¡ existir)
          gcloud run jobs create collectstatic \
            --image gcr.io/${{ env.PROJECT_ID }}/monpec:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --update-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp" \
            --command "python" \
            --args "manage.py,collectstatic,--noinput" \
            --max-retries=3 \
            --memory=512Mi \
            --cpu=1 \
            --task-timeout=300s \
            --quiet 2>&1 | grep -v "already exists" || true
          
          # Executar collectstatic
          echo "â³ Executando collectstatic..."
          gcloud run jobs execute collectstatic \
            --region ${{ env.REGION }} \
            --wait || echo "âš ï¸ Aviso: Collectstatic pode ter falhado"

      - name: âœ… Verificar status do deploy
        if: always()
        run: |
          echo "âœ… Verificando status do serviÃ§o..."
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format="table(status.url,status.latestReadyRevisionName,status.conditions[0].status)"
          
          echo ""
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          echo "ğŸ“ Nota: VariÃ¡veis de ambiente e secrets devem ser configurados separadamente no Cloud Run"
          echo "ğŸ”— Acesse o console: https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}"