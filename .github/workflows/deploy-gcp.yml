name: ğŸš€ Deploy AutomÃ¡tico para Google Cloud Run

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  PROJECT_ID: monpec-sistema-rural
  SERVICE_NAME: monpec
  REGION: us-central1
  IMAGE_NAME: gcr.io/${{ env.PROJECT_ID }}/monpec

jobs:
  deploy:
    name: ğŸš€ Build e Deploy para Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” AutenticaÃ§Ã£o no Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ“¦ Configurar projeto GCP
        run: |
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud config set run/region ${{ env.REGION }}

      - name: ğŸ”¨ Habilitar APIs necessÃ¡rias
        run: |
          gcloud services enable cloudbuild.googleapis.com --quiet || true
          gcloud services enable run.googleapis.com --quiet || true
          gcloud services enable sqladmin.googleapis.com --quiet || true
          gcloud services enable containerregistry.googleapis.com --quiet || true

      - name: ğŸ³ Build da imagem Docker
        id: build
        run: |
          echo "ğŸ”¨ Iniciando build da imagem Docker..."
          echo "ğŸ“„ Usando Dockerfile.prod..."
          
          gcloud builds submit \
            --tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile.prod \
            --timeout=600s \
            --quiet
          
          echo "âœ… Build concluÃ­do com sucesso!"
          echo "ğŸ“¦ Imagem: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "ğŸ“¦ Imagem latest: ${{ env.IMAGE_NAME }}:latest"

      - name: ğŸš€ Deploy para Cloud Run
        id: deploy
        run: |
          echo "ğŸš€ Iniciando deploy no Cloud Run..."
          
          # Verificar se o serviÃ§o jÃ¡ existe para decidir se usa --update-env-vars ou --set-env-vars
          if gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --quiet &>/dev/null; then
            echo "ğŸ“ ServiÃ§o existente encontrado. Atualizando..."
            UPDATE_FLAG="--update-env-vars"
          else
            echo "ğŸ†• Criando novo serviÃ§o..."
            UPDATE_FLAG="--set-env-vars"
          fi
          
          # Deploy com variÃ¡veis de ambiente bÃ¡sicas
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            $UPDATE_FLAG "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False" \
            --memory=1Gi \
            --cpu=2 \
            --timeout=300 \
            --max-instances=10 \
            --min-instances=1 \
            --quiet
          
          # Obter URL do serviÃ§o
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format="value(status.url)")
          
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸŒ URL: $SERVICE_URL"
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Aplicar migraÃ§Ãµes (opcional)
        if: success()
        continue-on-error: true
        run: |
          echo "ğŸ”„ Aplicando migraÃ§Ãµes do banco de dados..."
          
          # Criar job de migraÃ§Ã£o (ou atualizar se jÃ¡ existir)
          gcloud run jobs create migrate-db \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --update-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp" \
            --command "python" \
            --args "manage.py,migrate,--noinput" \
            --max-retries=3 \
            --memory=512Mi \
            --cpu=1 \
            --task-timeout=600s \
            --quiet 2>&1 | grep -v "already exists" || true
          
          # Executar migraÃ§Ãµes
          echo "â³ Executando migraÃ§Ãµes..."
          gcloud run jobs execute migrate-db \
            --region ${{ env.REGION }} \
            --wait || echo "âš ï¸ Aviso: MigraÃ§Ãµes podem ter falhado ou jÃ¡ estarem atualizadas"

      - name: ğŸ“Š Coletar arquivos estÃ¡ticos (opcional)
        if: success()
        continue-on-error: true
        run: |
          echo "ğŸ“Š Coletando arquivos estÃ¡ticos..."
          
          # Criar job de collectstatic (ou atualizar se jÃ¡ existir)
          gcloud run jobs create collectstatic \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --update-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp" \
            --command "python" \
            --args "manage.py,collectstatic,--noinput" \
            --max-retries=3 \
            --memory=512Mi \
            --cpu=1 \
            --task-timeout=300s \
            --quiet 2>&1 | grep -v "already exists" || true
          
          # Executar collectstatic
          echo "â³ Executando collectstatic..."
          gcloud run jobs execute collectstatic \
            --region ${{ env.REGION }} \
            --wait || echo "âš ï¸ Aviso: Collectstatic pode ter falhado"

      - name: âœ… Verificar status do deploy
        if: always()
        run: |
          echo "âœ… Verificando status do serviÃ§o..."
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format="table(status.url,status.latestReadyRevisionName,status.conditions[0].status)"
          
          echo ""
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          echo "ğŸ“ Nota: VariÃ¡veis de ambiente e secrets devem ser configurados separadamente no Cloud Run"
          echo "ğŸ”— Acesse o console: https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}"