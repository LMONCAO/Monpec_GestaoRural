name: ğŸš€ Deploy MONPEC para Google Cloud

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_type:
        description: 'Tipo de deploy'
        required: true
        default: 'cloud-run'
        type: choice
        options:
        - cloud-run
        - app-engine

env:
  GCP_PROJECT_ID: monpec-sistema-rural
  GCP_REGION: us-central1
  SERVICE_NAME: monpec-app
  IMAGE_NAME: gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}

jobs:
  # Job 1: Testes e validaÃ§Ãµes
  test:
    name: ğŸ§ª Testes e ValidaÃ§Ãµes
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_gcp.txt

    - name: ğŸ”§ Configurar Django
      run: |
        python manage.py collectstatic --noinput --settings=sistema_rural.settings_gcp_deploy
        python manage.py check --settings=sistema_rural.settings_gcp_deploy

    - name: âœ… Executar correÃ§Ãµes GCP
      run: |
        python corrigir_exportacao_gcp.py
        python corrigir_migracoes_gcp.py

    - name: ğŸ§ª Testes bÃ¡sicos
      run: |
        python -c "import django; django.setup(); print('âœ… Django OK')"
        python -c "from gestao_rural.utils.export_utils import exportar_excel_seguro; print('âœ… Export utils OK')"

  # Job 2: Build da imagem Docker
  build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Autenticar no Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸ—ï¸ Configurar Docker
      run: gcloud auth configure-docker --quiet

    - name: ğŸ³ Build da imagem
      run: |
        docker build -f Dockerfile.gcp -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -f Dockerfile.gcp -t ${{ env.IMAGE_NAME }}:latest .

    - name: ğŸ“¤ Push da imagem
      run: |
        docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.IMAGE_NAME }}:latest

  # Job 3: Deploy para Cloud Run
  deploy-cloud-run:
    name: â˜ï¸ Deploy Cloud Run
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.deploy_type == 'cloud-run' || github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Autenticar no Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸš€ Deploy para Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \\
          --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \\
          --platform managed \\
          --region ${{ env.GCP_REGION }} \\
          --allow-unauthenticated \\
          --port 8080 \\
          --memory 2Gi \\
          --cpu 1 \\
          --max-instances 10 \\
          --min-instances 1 \\
          --set-env-vars="DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp_deploy" \\
          --set-env-vars="SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" \\
          --set-env-vars="MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}" \\
          --set-env-vars="EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" \\
          --set-env-vars="CONSULTOR_TELEFONE=${{ secrets.CONSULTOR_TELEFONE }}" \\
          --set-secrets="GOOGLE_CREDENTIALS_JSON=monpec-gcp-credentials:latest" \\
          --add-cloudsql-instances ${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:monpec-db

    - name: ğŸ“ Obter URL do serviÃ§o
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.GCP_REGION }} --format="value(status.url)")
        echo "ğŸŒ URL do serviÃ§o: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

    - name: ğŸ§ª Testar deploy
      run: |
        sleep 30  # Aguardar serviÃ§o ficar pronto
        if curl -f --max-time 30 ${{ env.SERVICE_URL }}/health/; then
          echo "âœ… Deploy bem-sucedido!"
        else
          echo "âŒ Falha no teste do deploy"
          exit 1
        fi

    - name: ğŸ“¢ Notificar deploy
      if: success()
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ“± WhatsApp: ${{ secrets.CONSULTOR_TELEFONE }}"
        echo "ğŸŒ URL: ${{ env.SERVICE_URL }}"

  # Job 4: Deploy alternativo para App Engine
  deploy-app-engine:
    name: ğŸŒ Deploy App Engine
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.deploy_type == 'app-engine'

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Autenticar no Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸš€ Deploy para App Engine
      run: |
        gcloud app deploy app.yaml --quiet \\
          --version ${{ github.sha }} \\
          --no-promote

    - name: ğŸ§ª Testar deploy App Engine
      run: |
        if curl -f --max-time 30 https://monpec-sistema-rural.uc.r.appspot.com/health/; then
          echo "âœ… Deploy App Engine bem-sucedido!"
        else
          echo "âŒ Falha no teste do deploy App Engine"
          exit 1
        fi

  # Job 5: PÃ³s-deploy (executar migraÃ§Ãµes remotas)
  post-deploy:
    name: ğŸ”§ PÃ³s-deploy
    runs-on: ubuntu-latest
    needs: [deploy-cloud-run, deploy-app-engine]
    if: success()

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Autenticar no Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸ—„ï¸ Executar migraÃ§Ãµes remotas
      run: |
        # Cloud Run - executar migraÃ§Ãµes via Cloud Run job ou SSH
        echo "ğŸ”„ Executando migraÃ§Ãµes remotas..."
        # TODO: Implementar execuÃ§Ã£o remota de migraÃ§Ãµes

    - name: ğŸ“§ Notificar conclusÃ£o
      run: |
        echo "ğŸ‰ DEPLOY MONPEC CONCLUÃDO COM SUCESSO!"
        echo "ğŸ“± WhatsApp configurado: ${{ secrets.CONSULTOR_TELEFONE }}"
        echo "ğŸ“§ Email: l.moncaosilva@gmail.com"
        echo "ğŸŒ Ambiente: ${{ github.event.inputs.environment || 'production' }}"