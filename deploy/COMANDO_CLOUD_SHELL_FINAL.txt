# COMANDO FINAL PARA CLOUD SHELL
# Copie e cole TUDO no Cloud Shell do Google Cloud

PROJECT_ID="monpec-sistema-rural" && SERVICE_NAME="monpec" && REGION="us-central1" && DB_PASSWORD="L6171r12@@jjms" && SECRET_KEY="django-insecure-monpec-sistema-rural-2025-producao-segura-L6171r12@@-YrJOs823th_HB2BP6Uz9A0NVvzL0Fif-t-Rfub5BXgVtE0LxXIWEPQIFqYvI8UNiZKE" && echo "========================================" && echo "DEPLOY COMPLETO MONPEC" && echo "========================================" && echo "" && echo "1. Configurando projeto..." && gcloud config set project $PROJECT_ID && echo "2. Corrigindo senha do banco..." && gcloud sql users set-password monpec_user --instance=monpec-db --password="$DB_PASSWORD" 2>/dev/null || echo "Aviso: Não foi possível atualizar senha" && echo "3. Verificando requirements..." && (grep -q "^openpyxl" requirements_producao.txt || echo "openpyxl>=3.1.5" >> requirements_producao.txt) && echo "4. Buildando imagem (5-10 min)..." && TIMESTAMP=$(date +%Y%m%d%H%M%S) && gcloud builds submit --tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$TIMESTAMP --timeout=20m && echo "5. Deployando (2-5 min)..." && gcloud run deploy $SERVICE_NAME --image gcr.io/$PROJECT_ID/$SERVICE_NAME:$TIMESTAMP --region=$REGION --platform managed --allow-unauthenticated --add-cloudsql-instances=$PROJECT_ID:$REGION:monpec-db --set-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False,SECRET_KEY=$SECRET_KEY,CLOUD_SQL_CONNECTION_NAME=$PROJECT_ID:$REGION:monpec-db,DB_NAME=monpec_db,DB_USER=monpec_user,DB_PASSWORD=$DB_PASSWORD" --memory=2Gi --cpu=2 --timeout=600 && echo "" && echo "========================================" && echo "DEPLOY CONCLUIDO!" && echo "========================================" && SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)") && echo "URL: $SERVICE_URL" && echo "Login: admin / L6171r12@@"


