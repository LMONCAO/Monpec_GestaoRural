========================================
GUIA COMPLETO: DEPLOY NO GOOGLE CLOUD
========================================

Este guia vai te ajudar a fazer o deploy completo do sistema no Google Cloud Run.

========================================
PRÃ‰-REQUISITOS
========================================

1. Conta Google Cloud ativa
2. Projeto criado no Google Cloud Console
3. Billing habilitado
4. Google Cloud SDK instalado (gcloud CLI)
5. APIs habilitadas:
   - Cloud Run API
   - Cloud SQL Admin API
   - Cloud Build API

========================================
PASSO 1: INSTALAR GOOGLE CLOUD SDK
========================================

Windows:
   Baixe e instale: https://cloud.google.com/sdk/docs/install

Linux/Mac:
   curl https://sdk.cloud.google.com | bash
   exec -l $SHELL

Verificar instalaÃ§Ã£o:
   gcloud --version

========================================
PASSO 2: AUTENTICAR NO GOOGLE CLOUD
========================================

Execute:
   gcloud auth login

Isso vai abrir o navegador para vocÃª fazer login.

========================================
PASSO 3: CONFIGURAR PROJETO
========================================

1. Criar projeto (se ainda nÃ£o tiver):
   gcloud projects create monpec-sistema-rural --name="Monpec Sistema Rural"

2. Definir projeto como padrÃ£o:
   gcloud config set project monpec-sistema-rural

   (Substitua "monpec-sistema-rural" pelo ID do seu projeto)

3. Verificar projeto atual:
   gcloud config get-value project

========================================
PASSO 4: HABILITAR APIS NECESSÃRIAS
========================================

Execute:
   gcloud services enable run.googleapis.com
   gcloud services enable sqladmin.googleapis.com
   gcloud services enable cloudbuild.googleapis.com

========================================
PASSO 5: CRIAR INSTÃ‚NCIA CLOUD SQL
========================================

1. Criar instÃ¢ncia PostgreSQL:
   gcloud sql instances create monpec-db \
     --database-version=POSTGRES_15 \
     --tier=db-f1-micro \
     --region=us-central1

   (Ajuste o tier conforme necessÃ¡rio: db-f1-micro Ã© o mais barato)

2. Criar banco de dados:
   gcloud sql databases create sistema_rural --instance=monpec-db

3. Criar usuÃ¡rio:
   gcloud sql users create monpec \
     --instance=monpec-db \
     --password=L6171r12@@jjms

4. Obter connection name:
   gcloud sql instances describe monpec-db --format="value(connectionName)"
   
   Formato esperado: PROJECT:REGION:INSTANCE
   Exemplo: monpec-sistema-rural:us-central1:monpec-db

========================================
PASSO 6: TRANSFERIR DADOS EXISTENTES (OPCIONAL)
========================================

Se vocÃª jÃ¡ tem dados no banco local e quer transferir:

1. Fazer backup do banco local:
   pg_dump -h localhost -U monpec -d sistema_rural > backup_local.sql

2. Conectar ao Cloud SQL via proxy:
   cloud-sql-proxy monpec-sistema-rural:us-central1:monpec-db

3. Em outro terminal, restaurar backup:
   psql -h 127.0.0.1 -p 5432 -U monpec -d sistema_rural < backup_local.sql

OU usar o script enviar_dados.bat (Windows) que jÃ¡ estÃ¡ configurado.

========================================
PASSO 7: FAZER DEPLOY
========================================

OPÃ‡ÃƒO A: Script Automatizado (RECOMENDADO)
-------------------------------------------

Windows:
   deploy_gcp.bat

Linux/Mac:
   bash deploy_gcp.sh

OPÃ‡ÃƒO B: Comando Manual
------------------------

gcloud run deploy monpec \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --port 8080 \
  --memory 2Gi \
  --cpu 2 \
  --timeout 600 \
  --max-instances 10 \
  --min-instances 0 \
  --set-env-vars "DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp"

========================================
PASSO 8: CONFIGURAR VARIÃVEIS DE AMBIENTE
========================================

ApÃ³s o deploy, configure as variÃ¡veis de ambiente no Cloud Run Console:

1. Acesse: https://console.cloud.google.com/run
2. Clique no serviÃ§o "monpec"
3. VÃ¡ em "Edit & Deploy New Revision"
4. VÃ¡ na aba "Variables & Secrets"
5. Adicione as seguintes variÃ¡veis:

   OBRIGATÃ“RIAS:
   - CLOUD_SQL_CONNECTION_NAME = monpec-sistema-rural:us-central1:monpec-db
   - DB_NAME = sistema_rural
   - DB_USER = monpec
   - DB_PASSWORD = L6171r12@@jjms
   - SECRET_KEY = (sua chave secreta do Django)
   - DJANGO_SETTINGS_MODULE = sistema_rural.settings_gcp

   OPCIONAIS:
   - DEBUG = False
   - GOOGLE_CLOUD_PROJECT = monpec-sistema-rural
   - USE_CLOUD_STORAGE = False (ou True se usar Cloud Storage)

6. Clique em "Deploy"

========================================
PASSO 9: CONFIGURAR CONEXÃƒO CLOUD SQL
========================================

1. No Cloud Run Console, vÃ¡ em "Connections"
2. Clique em "Add Connection"
3. Selecione a instÃ¢ncia Cloud SQL: monpec-db
4. Salve

Isso permite que o Cloud Run se conecte ao Cloud SQL via Unix Socket.

========================================
PASSO 10: VERIFICAR DEPLOY
========================================

1. Obter URL do serviÃ§o:
   gcloud run services describe monpec --region=us-central1 --format="value(status.url)"

2. Acessar a URL no navegador

3. Verificar:
   [ ] Sistema carrega
   [ ] Login funciona
   [ ] Imagens aparecem
   [ ] Dados estÃ£o presentes

4. Ver logs em caso de erro:
   gcloud run services logs read monpec --region=us-central1 --limit=50

========================================
ARQUIVOS CRIADOS PARA O DEPLOY
========================================

âœ… Dockerfile - ConfiguraÃ§Ã£o do container
âœ… entrypoint.sh - Script de inicializaÃ§Ã£o (jÃ¡ existia)
âœ… .gcloudignore - Arquivos ignorados no deploy
âœ… deploy_gcp.sh - Script de deploy (Linux/Mac)
âœ… deploy_gcp.bat - Script de deploy (Windows)

========================================
ESTRUTURA DO DEPLOY
========================================

1. Dockerfile cria a imagem:
   - Instala Python 3.11
   - Instala dependÃªncias do sistema
   - Instala dependÃªncias Python (requirements_producao.txt)
   - Copia cÃ³digo do projeto
   - Configura variÃ¡veis de ambiente

2. entrypoint.sh executa na inicializaÃ§Ã£o:
   - Coleta arquivos estÃ¡ticos (collectstatic)
   - Executa migraÃ§Ãµes (migrate)
   - Inicia servidor Gunicorn

3. Cloud Run:
   - Recebe requisiÃ§Ãµes HTTP
   - Conecta ao Cloud SQL
   - Serve a aplicaÃ§Ã£o Django

========================================
VARIÃVEIS DE AMBIENTE IMPORTANTES
========================================

CLOUD_SQL_CONNECTION_NAME:
   Formato: PROJECT:REGION:INSTANCE
   Exemplo: monpec-sistema-rural:us-central1:monpec-db
   
   Esta variÃ¡vel Ã© CRÃTICA para conexÃ£o com o banco!

DB_NAME, DB_USER, DB_PASSWORD:
   Credenciais do banco de dados Cloud SQL

SECRET_KEY:
   Chave secreta do Django (use uma chave forte!)

DJANGO_SETTINGS_MODULE:
   Deve ser: sistema_rural.settings_gcp

========================================
TROUBLESHOOTING
========================================

PROBLEMA: Erro de conexÃ£o com banco
SOLUÃ‡ÃƒO: 
   - Verificar CLOUD_SQL_CONNECTION_NAME estÃ¡ correto
   - Verificar se Cloud SQL estÃ¡ conectado no Cloud Run
   - Verificar credenciais do banco

PROBLEMA: Imagens nÃ£o aparecem
SOLUÃ‡ÃƒO:
   - Verificar se collectstatic foi executado (entrypoint.sh faz isso)
   - Verificar logs do Cloud Run
   - Verificar se WhiteNoise estÃ¡ configurado (jÃ¡ estÃ¡ em settings_gcp.py)

PROBLEMA: Erro 500
SOLUÃ‡ÃƒO:
   - Verificar logs: gcloud run services logs read monpec --region=us-central1
   - Verificar variÃ¡veis de ambiente
   - Verificar migraÃ§Ãµes foram executadas

PROBLEMA: Timeout
SOLUÃ‡ÃƒO:
   - Aumentar timeout no Cloud Run (jÃ¡ configurado para 600s)
   - Verificar se banco estÃ¡ respondendo

========================================
CUSTOS ESTIMADOS
========================================

Cloud Run:
   - Primeiros 2 milhÃµes de requisiÃ§Ãµes: GRÃTIS
   - Depois: ~$0.40 por milhÃ£o de requisiÃ§Ãµes
   - CPU/MemÃ³ria: cobrado apenas quando em uso

Cloud SQL (db-f1-micro):
   - ~$7-10/mÃªs (depende da regiÃ£o)

Total estimado: ~$10-15/mÃªs para uso moderado

========================================
COMANDOS ÃšTEIS
========================================

Ver serviÃ§os Cloud Run:
   gcloud run services list

Ver logs em tempo real:
   gcloud run services logs tail monpec --region=us-central1

Atualizar serviÃ§o:
   gcloud run deploy monpec --source . --region=us-central1

Ver variÃ¡veis de ambiente:
   gcloud run services describe monpec --region=us-central1 --format="value(spec.template.spec.containers[0].env)"

========================================
CHECKLIST FINAL
========================================

ANTES DO DEPLOY:
[ ] Google Cloud SDK instalado
[ ] Autenticado no gcloud
[ ] Projeto criado e configurado
[ ] APIs habilitadas
[ ] Cloud SQL criado
[ ] Banco de dados criado
[ ] UsuÃ¡rio do banco criado
[ ] Connection name anotado

DURANTE O DEPLOY:
[ ] Dockerfile presente
[ ] entrypoint.sh presente e executÃ¡vel
[ ] Deploy executado com sucesso
[ ] VariÃ¡veis de ambiente configuradas
[ ] Cloud SQL conectado ao Cloud Run

APÃ“S O DEPLOY:
[ ] URL do serviÃ§o obtida
[ ] Sistema acessÃ­vel
[ ] Login funciona
[ ] Imagens aparecem
[ ] Dados preservados
[ ] Sem erros nos logs

========================================
âœ… TUDO PRONTO PARA DEPLOY!
========================================

Execute o script de deploy e siga as instruÃ§Ãµes acima.

Boa sorte! ðŸš€

========================================







