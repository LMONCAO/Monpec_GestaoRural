========================================
üöÄ INSTRU√á√ïES DE DEPLOY - GOOGLE CLOUD
========================================

Projeto: monpec-sistema-rural
Email: l.moncaosilva@gmail.com

========================================
PASSO 1: VERIFICAR DOCKERFILE
========================================

O Dockerfile deve existir na raiz do projeto. Se n√£o existir, crie com o seguinte conte√∫do:

---
# Use a imagem oficial do Python
FROM python:3.11-slim

# Definir diret√≥rio de trabalho
WORKDIR /app

# Instalar depend√™ncias do sistema
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Copiar requirements e instalar depend√™ncias Python
COPY requirements_producao.txt .
RUN pip install --no-cache-dir -r requirements_producao.txt

# Copiar c√≥digo do projeto
COPY . .

# Executar collectstatic (pode falhar sem vari√°veis, mas OK)
RUN python manage.py collectstatic --noinput --settings=sistema_rural.settings_gcp || echo "‚ö†Ô∏è collectstatic ser√° executado no entrypoint..."

# Expor porta
EXPOSE 8080

# Usar entrypoint.sh
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]
---

========================================
PASSO 2: INSTALAR GOOGLE CLOUD SDK
========================================

Se ainda n√£o tiver instalado:
Windows: https://cloud.google.com/sdk/docs/install
Ou via PowerShell:
(New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:Temp\GoogleCloudSDKInstaller.exe"); & $env:Temp\GoogleCloudSDKInstaller.exe

========================================
PASSO 3: AUTENTICAR E CONFIGURAR
========================================

Abra o PowerShell e execute:

# Autenticar
gcloud auth login

# Configurar projeto
gcloud config set project monpec-sistema-rural

# Verificar configura√ß√£o
gcloud config list

========================================
PASSO 4: HABILITAR APIS NECESS√ÅRIAS
========================================

gcloud services enable run.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable storage-api.googleapis.com

========================================
PASSO 5: CRIAR CLOUD SQL (se n√£o existir)
========================================

# Verificar se j√° existe
gcloud sql instances describe monpec-db

# Se n√£o existir, criar:
gcloud sql instances create monpec-db `
    --database-version=POSTGRES_15 `
    --tier=db-f1-micro `
    --region=us-central1 `
    --root-password=L6171r12@@jjms

# Criar banco de dados
gcloud sql databases create sistema_rural --instance=monpec-db

# Criar usu√°rio
gcloud sql users create monpec --instance=monpec-db --password=L6171r12@@jjms

# Obter connection name (anote este valor!)
gcloud sql instances describe monpec-db --format="value(connectionName)"

O connection name ter√° formato: monpec-sistema-rural:us-central1:monpec-db

========================================
PASSO 6: GERAR SECRET_KEY DO DJANGO
========================================

Execute no PowerShell para gerar uma SECRET_KEY:

python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

OU use este comando PowerShell:

-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 50 | ForEach-Object {[char]$_})

Anote a SECRET_KEY gerada!

========================================
PASSO 7: FAZER DEPLOY
========================================

Execute o comando abaixo (substitua CONNECTION_NAME e SECRET_KEY pelos valores obtidos):

gcloud run deploy monpec `
    --source . `
    --platform managed `
    --region us-central1 `
    --allow-unauthenticated `
    --port 8080 `
    --memory 2Gi `
    --cpu 2 `
    --timeout 600 `
    --add-cloudsql-instances=CONNECTION_NAME `
    --set-env-vars="CLOUD_SQL_CONNECTION_NAME=CONNECTION_NAME,DB_NAME=sistema_rural,DB_USER=monpec,DB_PASSWORD=L6171r12@@jjms,SECRET_KEY=SUA_SECRET_KEY,DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False" `
    --max-instances=10 `
    --min-instances=0

EXEMPLO COMPLETO (substitua os valores):
gcloud run deploy monpec `
    --source . `
    --platform managed `
    --region us-central1 `
    --allow-unauthenticated `
    --port 8080 `
    --memory 2Gi `
    --cpu 2 `
    --timeout 600 `
    --add-cloudsql-instances=monpec-sistema-rural:us-central1:monpec-db `
    --set-env-vars="CLOUD_SQL_CONNECTION_NAME=monpec-sistema-rural:us-central1:monpec-db,DB_NAME=sistema_rural,DB_USER=monpec,DB_PASSWORD=L6171r12@@jjms,SECRET_KEY=django-insecure-abc123...,DJANGO_SETTINGS_MODULE=sistema_rural.settings_gcp,DEBUG=False" `
    --max-instances=10 `
    --min-instances=0

========================================
PASSO 8: VERIFICAR DEPLOY
========================================

# Obter URL do servi√ßo
gcloud run services describe monpec --region=us-central1 --format="value(status.url)"

# Ver logs
gcloud run services logs read monpec --region=us-central1 --limit=50

# Verificar vari√°veis de ambiente
gcloud run services describe monpec --region=us-central1 --format="value(spec.template.spec.containers[0].env)"

========================================
PASSO 9: CONFIGURAR VARI√ÅVEIS (se necess√°rio)
========================================

Se precisar alterar vari√°veis de ambiente ap√≥s o deploy:

1. Acesse: https://console.cloud.google.com/run
2. Clique no servi√ßo "monpec"
3. Clique em "Edit & Deploy New Revision"
4. V√° na aba "Variables & Secrets"
5. Adicione/edite as vari√°veis:
   - CLOUD_SQL_CONNECTION_NAME = monpec-sistema-rural:us-central1:monpec-db
   - DB_NAME = sistema_rural
   - DB_USER = monpec
   - DB_PASSWORD = L6171r12@@jjms
   - SECRET_KEY = (sua SECRET_KEY)
   - DJANGO_SETTINGS_MODULE = sistema_rural.settings_gcp
   - DEBUG = False
6. Clique em "Deploy"

========================================
PASSO 10: VERIFICAR CONEX√ÉO CLOUD SQL
========================================

No Cloud Run Console:
1. Aba "Connections"
2. Verifique se "monpec-db" est√° listado
3. Se n√£o estiver, clique em "Add Connection" e selecione "monpec-db"

========================================
TROUBLESHOOTING
========================================

Erro: "CLOUD_SQL_CONNECTION_NAME n√£o definido"
   ‚Üí Verifique se a vari√°vel est√° configurada no Cloud Run

Erro: "Connection refused" ao conectar no banco
   ‚Üí Verifique se Cloud SQL est√° conectado no Cloud Run (aba Connections)
   ‚Üí Verifique se o connection name est√° correto

Erro: "Static files not found"
   ‚Üí Verifique os logs: gcloud run services logs read monpec --region=us-central1
   ‚Üí O collectstatic deve ter executado no entrypoint.sh

Erro: "Module not found"
   ‚Üí Verifique se todas as depend√™ncias est√£o em requirements_producao.txt
   ‚Üí Verifique os logs do build

Para ver logs em tempo real:
gcloud run services logs tail monpec --region=us-central1

========================================
COMANDOS √öTEIS
========================================

# Listar servi√ßos Cloud Run
gcloud run services list --region=us-central1

# Descrever servi√ßo
gcloud run services describe monpec --region=us-central1

# Ver logs
gcloud run services logs read monpec --region=us-central1

# Ver logs em tempo real
gcloud run services logs tail monpec --region=us-central1

# Deletar servi√ßo (se necess√°rio)
gcloud run services delete monpec --region=us-central1

# Listar inst√¢ncias Cloud SQL
gcloud sql instances list

# Conectar ao Cloud SQL via proxy (para migra√ß√µes manuais)
gcloud sql connect monpec-db --user=monpec

========================================
‚úÖ TUDO PRONTO!
========================================

Siga os passos acima e seu sistema estar√° rodando no Google Cloud Run!

Boa sorte! üöÄ

========================================







